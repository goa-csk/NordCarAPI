using NordCar.WebAPI.Messages;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Web.Http;
using NordCar.Carla.Data.Repository;
using AutoMapper;
using NordCar.WebAPI.BootStrapper;
using NordCar.WebAPI.Models;
using System.Web.Http.Cors;
using System.Web;
using NordCar.WebAPI.Filter;
using System.Web.Http.Description;
using System.Net.Http.Headers;
using System.Reflection;
using System.Collections.Specialized;
using NordCar.WebAPI.Models.EC;



namespace NordCar.WebAPI.Controllers
{
    /// <summary>
    /// 
    /// </summary>
    public class ECController : BaseAPIController
    {

        /// <summary>
        /// Initialise a variable of IContactsManagerRepository from data layer
        /// </summary>
        protected readonly IECAPIManagerRepository ECAPIManagerRepository;
        /// <summary>
        /// Inject repository
        /// </summary>
        /// <param name="_repository">IPSAPIManagerRepository</param>
        public ECController(IECAPIManagerRepository _repository)
        {
            if (_repository == null)
            {
                throw new ArgumentNullException("WebAPIManager Repository exception");
            }

            this.ECAPIManagerRepository = _repository;

            var bs = new Bootstrapper();
            bs.Initialize();

            Log.Info("ECController Created");
        }

        private static void PickDropInfoTrace(NordCar.WebAPI.Models.EC.PickDropInfo input)
        {
            Log.Info(string.Format("PickDropInfo.CountryId={0} \n", input.CountryId));
            Log.Info(string.Format("PickDropInfo.CarTypeId={0} \n", input.CarTypeId));
            Log.Info(string.Format("PickDropInfo.CarGroupId={0} \n", input.CarGroupId));

            Log.Info(string.Format("PickDropInfo.PickUp.LocationId={0}", input.PickUp.LocationId));
            Log.Info(string.Format("PickDropInfo.PickUp.LocationName={0}", input.PickUp.LocationName));
            Log.Info(string.Format("PickDropInfo.PickUp.Date={0}", input.PickUp.Date));
            Log.Info(string.Format("PickDropInfo.PickUp.Time={0}", input.PickUp.Time));

            Log.Info(string.Format("PickDropInfo.DropOff.LocationId={0}", input.DropOff.LocationId));
            Log.Info(string.Format("PickDropInfo.DropOff.LocationName={0}", input.DropOff.LocationName));
            Log.Info(string.Format("PickDropInfo.DropOff.Date={0}", input.DropOff.Date));
            Log.Info(string.Format("PickDropInfo.DropOff.Time={0}", input.DropOff.Time));

            if (input.Basic != null)
            {
                Trace_Basic(input.Basic);
            }
            else
            {
                Log.Info("PickDropInfo.Basic not initiated");
            }

        }

        private static void Trace_Basic(NordCar.WebAPI.Models.BasicStructure1 input)
        {
            Log.Info(string.Format("Basic.Language={0}", input.Language));
            Log.Info(string.Format("Basic.BookTypes={0}", input.BookTypes));
            Log.Info(string.Format("Basic.IPAddress={0}", input.IPAddress));
            Log.Info(string.Format("Basic.CompanyDealId={0}", input.CompanyDealId));
            Log.Info(string.Format("Basic.CustomerId={0}", input.CustomerId));
            Log.Info(string.Format("Basic.ExtraId={0}", input.ExtraId));
            Log.Info(string.Format("Basic.VoucherCode={0}", input.VoucherCode));
            Log.Info(string.Format("Basic.OrgBookNr={0}", input.OrgBookNr));
            Log.Info(string.Format("Basic.StepNr={0}", input.StepNr));
        }

        private static void TracePricePart(NordCar.WebAPI.Models.EC.PricePart pricepart)
        {
            
            PickDropInfoTrace(pricepart.PickDropInfo);

            Log.Info(string.Format("ProductId={0}",pricepart.ProductId));

            TraceExtra(pricepart.Extra);
         
        }

        private static void TraceExtra(NordCar.WebAPI.Models.EC.SelectedExtras extra)
        {
            Log.Info("RecommendedExtras");
            foreach (NordCar.WebAPI.Models.EC.SelectedBase sb in extra.RecommendedExtras)
            {
                Log.Info(string.Format("Id={0}", sb.Id));
                Log.Info(string.Format("NumbUnit={0}", sb.NumbUnit));
            }

            Log.Info("Insurance");
            foreach (NordCar.WebAPI.Models.EC.SelectedBase sb in extra.Insurance)
            {
                Log.Info(string.Format("Id={0}", sb.Id));
                Log.Info(string.Format("NumbUnit={0}", sb.NumbUnit));
            }

            Log.Info("Mileage");
            foreach (NordCar.WebAPI.Models.EC.SelectedBase sb in extra.Mileage)
            {
                Log.Info(string.Format("Id={0}", sb.Id));
                Log.Info(string.Format("NumbUnit={0}", sb.NumbUnit));
            }
        
        
        }

        private static void TraceReservation(NordCar.WebAPI.Models.EC.Reservation reservation)
        { 
            Log.Info(string.Format("Title={0}",reservation.Title));
            Log.Info(string.Format("Gender={0}",reservation.Gender));
            Log.Info(string.Format("FirstName={0}",reservation.FirstName));
            Log.Info(string.Format("LastName={0}",reservation.LastName));
            Log.Info(string.Format("BirthDay={0}",reservation.BirthDay));
            Log.Info(string.Format("Address={0}",reservation.Address));
            Log.Info(string.Format("Address2={0}",reservation.Address2));
            Log.Info(string.Format("Address3={0}",reservation.Address3));
            Log.Info(string.Format("City={0}",reservation.City));
            Log.Info(string.Format("PostCode={0}",reservation.PostCode));
            Log.Info(string.Format("Country={0}",reservation.Country));
            Log.Info(string.Format("Email={0}",reservation.Email));
            Log.Info(string.Format("CustomerNo={0}",reservation.CustomerNo));
            Log.Info(string.Format("PaymentType={0}",reservation.paymentType));
            Log.Info(string.Format("ProductId={0}",reservation.ProductId));
            Log.Info(string.Format("BookStatus={0}", reservation.BookStatus));

            PickDropInfoTrace(reservation.PickDropInfo);

            TraceExtra(reservation.Extra);
        
        }

        private static void TraceAccount(NordCar.WebAPI.Models.EC.Person account)
        {
            Log.Info(string.Format("CustomerNo={0}", account.CustomerNo));
            Log.Info(string.Format("AccountType={0}",account.AccountType));
            Log.Info(string.Format("Title={0}",account.Title));
            Log.Info(string.Format("Gender={0}",account.Gender));
            Log.Info(string.Format("FirstName={0}",account.FirstName));
            Log.Info(string.Format("LastName={0}",account.LastName));
            Log.Info(string.Format("Address={0}",account.Address));
            Log.Info(string.Format("Address2={0}",account.Address2));
            Log.Info(string.Format("Address3={0}",account.Address3));
            Log.Info(string.Format("City={0}",account.City));
            Log.Info(string.Format("PostCode={0}",account.PostCode));
            Log.Info(string.Format("Country={0}",account.Country));
            Log.Info(string.Format("Email={0}",account.Email));
            Log.Info(string.Format("Phone={0}",account.Phone));
            Log.Info(string.Format("Password={0}",account.Password));
            Log.Info(string.Format("SecretQuestionId={0}",account.SecretQuestionId));
            Log.Info(string.Format("SecretQuestionAnswer={0}",account.SecretQuestionAnswer));

            Log.Info(string.Format("Driver.LicenseNumber={0}",account.Driver.LicenseNumber));
            Log.Info(string.Format("Driver.BirthDay={0}", account.Driver.BirthDay));
            Log.Info(string.Format("Driver.BirthCity={0}", account.Driver.BirthCity));
            Log.Info(string.Format("Driver.BirthCountry={0}", account.Driver.BirthCountry));
            Log.Info(string.Format("Driver.IssueDate={0}", account.Driver.IssueDate));
            Log.Info(string.Format("Driver.ExpiryDate={0}", account.Driver.ExpiryDate));
            Log.Info(string.Format("Driver.IssueCountry={0}", account.Driver.IssueCountry));

            Log.Info(string.Format("Identification.IdentityNumber={0}",account.Identification.IdentityNumber));
            Log.Info(string.Format("Identification.PassPortNumber={0}",account.Identification.PassPortNumber));
            Log.Info(string.Format("Identification.IssueDate={0}",account.Identification.IssueDate));
            Log.Info(string.Format("Identification.ExpiryDate={0}",account.Identification.ExpiryDate));
            Log.Info(string.Format("Identification.IssueCountry={0}", account.Identification.IssueCountry));

        }

        #region Version
        /// <summary>
        /// GetLocations
        /// </summary>
        /// <returns></returns>
        [HttpGet]
        //[HttpPost]
        [ResponseType(typeof(NordCar.WebAPI.Models.EC.Version))]
        //public IHttpActionResult GetVersion(BasicStructure1 bStruct)
        public IHttpActionResult GetVersion()
        {
            
            var bs1 = fillbasics(FunctionList.Hello, BookTypes.ECBOOK);
            //var bs1 = fillbasics(FunctionList.Hello, bStruct);
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);
            var data = this.ECAPIManagerRepository.GetVersion(bs);

            if (data.Item1.Succes)
            {
                Type t = typeof(NordCar.WebAPI.Controllers.ECController);
                Assembly assemFromType = t.Assembly;

                Type t2 = typeof(NordCar.Carla.Data.Repository.IECAPIManagerRepository);
                Assembly assemFromType2 = t2.Assembly;


                var vers = new NordCar.WebAPI.Models.EC.Version() { CarlaProgram = data.Item2, Data = assemFromType2.FullName, WebApi = assemFromType.FullName };
                var result = new
                {
                    VersionInfo = vers,
                    Status = "OK"
                };

                return Ok(result);
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }

        }

        #endregion

        #region GetBookTypes
        
      
        public IHttpActionResult GetBookTypes()
        {
            try
            {

                var result = new
                {
                    booktypes = NordCar.Carla.Data.Entities.Helper.GetBookTypes()
                };


                return Ok(result);
            }
            catch (System.Exception ex)
            {
                return Error(new Models.APIMethodControl() { ErrorCode = "", ErrorMessage = ex.Message, Succes = false, Message = "GetBookTypes() + could not load data" }, HttpStatusCode.InternalServerError);
            }
        }
        #endregion

        #region GetLocations
        /// <summary>
        /// GetLocations
        /// </summary>
        /// <param name="bookType">ex. ECBOOK or DAT</param>
        /// <returns></returns>
        [HttpGet]
        [ResponseType(typeof(NordCar.WebAPI.Models.EC.Location))]
        public IHttpActionResult GetLocations(string bookType, string countryId = "", string carGroupId = "")
        {

            BookTypes booktype = NordCar.WebAPI.Models.Helper.ParseEnum(bookType);

            if (booktype == 0)
            {
                 return BookTypeNotFound(bookType);
            }

            var bs1 = fillbasics(FunctionList.GetLocations, booktype);
            
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);

            var data = this.ECAPIManagerRepository.GetLocations(bs, countryId, carGroupId);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    Locations = Mapper.Map<List<NordCar.Carla.Data.Entities.EC.Location>, List<NordCar.WebAPI.Models.EC.Location>>(data.Item2),
                    Status = "OK"
                };

                return Ok(result);
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }

        }

        #endregion

        #region GetLocationDetails
        /// <summary>
        /// GetLocationDetails
        /// </summary>
        /// <param name="bookType">ex. ECBOOK or DAT</param>
        /// <param name="id">Location id</param>
        /// <returns></returns>
        [HttpGet]
        [ResponseType(typeof(NordCar.WebAPI.Models.EC.LocationDetail))]
        public IHttpActionResult GetLocationDetails(string bookType,string id)
        {

            Log.Info(string.Format("ID={0}", id));

            BookTypes booktype = NordCar.WebAPI.Models.Helper.ParseEnum(bookType);

            if (booktype == 0)
            {
                return BookTypeNotFound(bookType);
            }

            var bs1 = fillbasics(FunctionList.GetLocationDetails, booktype);
            
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);
            
            var data = this.ECAPIManagerRepository.GetLocationDetails(bs, id, System.DateTime.Today, 120);

            if (data.Item1.Succes)
            {

                var result = new
                {
                    Location = Mapper.Map<NordCar.Carla.Data.Entities.EC.LocationDetail, NordCar.WebAPI.Models.EC.LocationDetail>(data.Item2),
                    Status = "OK"
                };

                return Ok(result);
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }

        }
        #endregion

        #region GetCountries
        /// <summary>
        /// GetCountries
        /// </summary>
        /// <returns></returns>
        [HttpGet]
        //[HttpPost]
        [ResponseType(typeof(NordCar.WebAPI.Models.EC.Country))]
        //public IHttpActionResult GetCountries(BasicStructure1 bStruct)
        public IHttpActionResult GetCountries()
        {
            var bs1 = fillbasics(FunctionList.GetCountries, BookTypes.ECBOOK);
            //var bs1 = fillbasics(FunctionList.GetCountries, bStruct);
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);
            var data = this.ECAPIManagerRepository.GetCountries(bs);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    Locations = Mapper.Map<List<NordCar.Carla.Data.Entities.EC.Country>, List<NordCar.WebAPI.Models.EC.Country>>(data.Item2),
                    Status = "OK"
                };

                return Ok(result);
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }

        }

        #endregion

        #region GetAvailableCars

        /// <summary>
        /// GetAvailableCars
        /// </summary>
        /// <param name="input"></param>
        /// <param name="age"></param>
        /// <returns></returns>
        [HttpPost]
        [ResponseType(typeof(NordCar.WebAPI.Models.EC.CarDetail))]
        public IHttpActionResult GetAvailableCars(NordCar.WebAPI.Models.EC.PickDropInfo input, string age)
        {

            PickDropInfoTrace(input);
            Log.Info(string.Format("Age={0}",age));

            if (input.Basic == null)
                return BasicNotSet();

            BookTypes booktype = NordCar.WebAPI.Models.Helper.ParseEnum(input.Basic.BookTypes);

            if (booktype == 0)
            {
                return BookTypeNotFound(input.Basic.BookTypes);
            }

            var bs1 = fillbasics(FunctionList.GetAvailableCars, input.Basic);

            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);
           
            var input1 = Mapper.Map<NordCar.WebAPI.Models.EC.PickDropInfo, NordCar.Carla.Data.Entities.EC.PickDropInfo>(input);

            var data = this.ECAPIManagerRepository.GetAvailableCars(bs, input1, age);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    ListCars = Mapper.Map<List<NordCar.Carla.Data.Entities.EC.CarDetail>, List<NordCar.WebAPI.Models.EC.CarDetail>>(data.Item2),
                    Status = "OK"
                };

                return Ok(result);
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }

        }

       
        #endregion

        #region GetCarExtras

        /// <summary>
        /// GetCarExtras
        /// </summary>
        /// <param name="input"></param>
        /// <param name="productId">hovedprodukt</param>
        /// <param name="age">alder</param>
        /// <returns></returns>
        [HttpPost]
        [ResponseType(typeof(NordCar.WebAPI.Models.EC.CarExtra))]
        public IHttpActionResult GetCarExtras(NordCar.WebAPI.Models.EC.PickDropInfo input, string productId, string age = "")
        {

            PickDropInfoTrace(input);
            Log.Info(string.Format("productId", productId));

            if (input.Basic == null)
                return BasicNotSet();

            BookTypes booktype = NordCar.WebAPI.Models.Helper.ParseEnum(input.Basic.BookTypes);

            if (booktype == 0)
            {
                return BookTypeNotFound(input.Basic.BookTypes);
            }
          
            var bs1 = fillbasics(FunctionList.GetCarExtras, input.Basic);
            
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);
            
            var input1 = Mapper.Map<NordCar.WebAPI.Models.EC.PickDropInfo, NordCar.Carla.Data.Entities.EC.PickDropInfo>(input);

            var data = this.ECAPIManagerRepository.GetCarExtras(bs, input1, productId, age);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    Extras = Mapper.Map<NordCar.Carla.Data.Entities.EC.CarExtra, NordCar.WebAPI.Models.EC.CarExtra>(data.Item2),
                    Status = "OK"
                };

                return Ok(result);
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }

        }
        #endregion

        #region UpdatePrice
        /// <summary>
        /// UpdatePrice
        /// </summary>
        /// <param name="input"></param>
        /// <param name="age"></param>
        /// <returns></returns>
        [HttpPost]
        [ResponseType(typeof(NordCar.WebAPI.Models.EC.PriceCalculated))]
        public IHttpActionResult UpdatePrice(NordCar.WebAPI.Models.EC.PricePart input, string age = "")
        {

            TracePricePart(input);

            if (input.PickDropInfo.Basic == null)
                return BasicNotSet();

            BookTypes booktype = NordCar.WebAPI.Models.Helper.ParseEnum(input.PickDropInfo.Basic.BookTypes);

            if (booktype == 0)
            {
                return BookTypeNotFound(input.PickDropInfo.Basic.BookTypes);
            }

            var bs1 = fillbasics(FunctionList.UpdatePrices, input.PickDropInfo.Basic);
           
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);
            
            var input1 = Mapper.Map<NordCar.WebAPI.Models.EC.PricePart, NordCar.Carla.Data.Entities.EC.PricePart>(input);

            var data = this.ECAPIManagerRepository.UpdatePrice(bs, input1, age);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    Prize = Mapper.Map<NordCar.Carla.Data.Entities.EC.PriceCalculated, NordCar.WebAPI.Models.EC.PriceCalculated>(data.Item2),
                    Status = "OK"
                };

                return Ok(result);
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }

        }
        #endregion

        #region GetCarTypes
        /// <summary>
        /// GetCarTypes
        /// </summary>
        /// <returns></returns>
        [HttpGet]
        //[HttpPost]
        [ResponseType(typeof(NordCar.WebAPI.Models.EC.CarType))]
        //public IHttpActionResult GetCarTypes(BasicStructure1 bStruct)
        public IHttpActionResult GetCarTypes()
        {

            var bs1 = fillbasics(FunctionList.GetCarTypes, BookTypes.ECBOOK);
            //var bs1 = fillbasics(FunctionList.GetCarTypes, bStruct);
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);
            var data = this.ECAPIManagerRepository.GetCarTypes(bs);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    Types = Mapper.Map<List<NordCar.Carla.Data.Entities.EC.CarType>, List<NordCar.WebAPI.Models.EC.CarType>>(data.Item2),
                    Status = "OK"
                };

                return Ok(result);
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }

        }
        #endregion

        #region MakeReservation
        /// <summary>
        /// MakeReservation
        /// </summary>
        /// <param name="input"></param>
        /// <returns></returns>
        [HttpPost]
        [ResponseType(typeof(NordCar.WebAPI.Models.RentalInfo))]
        public IHttpActionResult MakeReservation(NordCar.WebAPI.Models.EC.Reservation input)
        {

            if (input.PickDropInfo.Basic == null)
                return BasicNotSet();

            BookTypes booktype = NordCar.WebAPI.Models.Helper.ParseEnum(input.PickDropInfo.Basic.BookTypes);

            if (booktype == 0)
            {
                return BookTypeNotFound(input.PickDropInfo.Basic.BookTypes);
            }


            var bs1 = fillbasics(FunctionList.MakeReservation, input.PickDropInfo.Basic);
            bs1.CustomerId = input.CustomerNo;

            TraceReservation(input);

            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);
            var input1 = Mapper.Map<NordCar.WebAPI.Models.EC.Reservation, NordCar.Carla.Data.Entities.EC.Reservation>(input);

            var data = this.ECAPIManagerRepository.MakeReservation(bs, input1);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    RentalInfo = Mapper.Map<NordCar.Carla.Data.Entities.RentalInfo, NordCar.WebAPI.Models.RentalInfo>(data.Item2),
                    Status = "OK"
                };

                return Ok(result);
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }

        }
        #endregion

        #region SearchBooking
        /// <summary>
        /// SearchBooking
        /// </summary>
        /// <param name="reservationNo"></param>
        /// <param name="email"></param>
        /// <param name="lastName"></param>
        /// <param name="date"></param>
        /// <returns></returns>
        [HttpGet]
        //[HttpPost]
        [ResponseType(typeof(NordCar.WebAPI.Models.Booking))]
        //public IHttpActionResult SearchBooking(string reservationNo, string email, string lastName, string date, BasicStructure1 bStruct)
        public IHttpActionResult SearchBooking(string reservationNo, string email, string lastName, string date)
        {

            Log.Info(string.Format("Reservation={0}", reservationNo));
            Log.Info(string.Format("Email={0}", email));
            Log.Info(string.Format("LastName={0}", lastName));
            Log.Info(string.Format("Date={0}", date));

            var bs1 = fillbasics(FunctionList.SearchBooking, BookTypes.ECBOOK);
            //var bs1 = fillbasics(FunctionList.SearchBooking, bStruct);
            bs1.CustomerId = "";

            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);

            var data = this.ECAPIManagerRepository.SearchBooking(bs, reservationNo, email, date, lastName);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    Bookings = Mapper.Map<List<NordCar.Carla.Data.Entities.EC.Booking>, List<NordCar.WebAPI.Models.EC.Booking>>(data.Item2),
                    Status = "OK"
                };

                return Ok(result);
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }

        }
        #endregion

        #region CancelBooking
        /// <summary>
        /// CancelBooking
        /// Cancelling the reservation.
        /// </summary>
        /// <param name="reservationNo"></param>
        /// <returns></returns>
        [HttpGet]
        public IHttpActionResult CancelBooking(string reservationNo)
        {

            Log.Info(string.Format("Reservation={0}", reservationNo));
          
            var bs1 = fillbasics(FunctionList.CancelBooking, BookTypes.ECBOOK);
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);

            var data = this.ECAPIManagerRepository.CancelBooking(bs, reservationNo);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    Cancelled = data.Item2.ToString(),
                    Status = "OK"
                };
                return Ok(result);

            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }


        }
        #endregion

        #region GetPdfBooking
        /// <summary>
        /// GetPdfBooking
        /// Returnning reservation as pdf
        /// </summary>
        /// <param name="reservationNo"></param>
        /// <returns>PDF Document</returns>
        [HttpGet]
        public IHttpActionResult GetPdfBooking(string reservationNo = "")
        {

            Log.Info(string.Format("Reservation={0}", reservationNo));
          
            var bs1 = fillbasics(FunctionList.GetPdfBooking, BookTypes.ECBOOK);
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);
            //bs.OrgBookNr = resNo;

            var data = this.ECAPIManagerRepository.GetPdfBooking(bs, 0, reservationNo, "");

            if (data.Item1.Succes)
            {
                IHttpActionResult response;
                HttpResponseMessage result = new HttpResponseMessage(HttpStatusCode.OK);
                result.Content = new ByteArrayContent(data.Item2);
                result.Content.Headers.ContentType =
                    new MediaTypeHeaderValue("application/octet-stream");
                response = ResponseMessage(result);
                return response;
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }
        }
        #endregion

        #region LoginType
        /// <summary>
        /// Login typer
        /// </summary>
        /// <param name="input"></param>
        /// <returns></returns>
        [HttpGet]
        public IHttpActionResult LoginTypes()
        {
            var enumVals = new List<object>();

            foreach (var item in Enum.GetValues(typeof(LoginType)))
            {
        
                enumVals.Add(new
                {
                    id = (int)item,
                    name = item.ToString()
                });
            }

            return Ok(enumVals);
        }

        #endregion

        #region CreateAccount
        // Create new personal account
        /// </summary>
        /// <param name="input"></param>
        /// <returns></returns>
        [HttpPost]
        [ResponseType(typeof(NordCar.WebAPI.Models.EC.Account))]
        public IHttpActionResult CreateAccount(NordCar.WebAPI.Models.EC.PersonalAccount input)
        {

            TraceAccount(input.person);

            //client error checks
            if (!ModelState.IsValid)
            {
                return BadRequest();
            }
            //Adding default program
            if (input.person.FrequentTravelerProgram == null)
            {
                input.person.FrequentTravelerProgram = new Models.EC.FrequentTravelerProgram() { Id = "0", CardNumber = "", ExpiryDate = "" };
            }

            var bs1 = fillbasics(FunctionList.CreateAccount, input.basic);
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);
            var input1 = Mapper.Map<NordCar.WebAPI.Models.EC.Person, NordCar.Carla.Data.Entities.EC.Person>(input.person);

            var data = this.ECAPIManagerRepository.CreateAccount(bs, input1);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    CustomerAccount = Mapper.Map<NordCar.Carla.Data.Entities.EC.Account, NordCar.WebAPI.Models.EC.Account>(data.Item2),

                    Status = "OK"
                };
                return Ok(result);

            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }


        }
        #endregion

        #region Login
        /// <summary>
        /// Login
        /// </summary>
        /// <param name="login"></param>
        /// <returns></returns>
      
        [HttpPost]
        [ResponseType(typeof(NordCar.WebAPI.Models.EC.Account))]
        public IHttpActionResult Login(NordCar.WebAPI.Models.EC.LoginInfo login)
        {

            var bs1 = fillbasics(FunctionList.ECLogin, login.Basic);
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);
           
            var data = this.ECAPIManagerRepository.Login(bs, ((int)login.LoginType).ToString(), login.UserName, login.Password);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    CustomerAccount = Mapper.Map<NordCar.Carla.Data.Entities.EC.Account, NordCar.WebAPI.Models.EC.Account>(data.Item2),

                    Status = "OK"
                };
                return Ok(result);
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }
        }
        #endregion

        #region ForgotPassword
        /// <summary>
        /// ForgotPassword
        /// </summary>
        /// <param name="email">Email Address</param>
        /// <returns>Password</returns>
        [HttpGet]
        public IHttpActionResult ForgotPassword(string email)
        {

            var bs1 = fillbasics(FunctionList.ForgotPassword, BookTypes.ECBOOK);
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);

            var data = this.ECAPIManagerRepository.ForgotPassword(bs, "1", email);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    Password = data.Item2.ToString(),
                    Status = "OK"
                };
                return Ok(result);

            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }


        }
        #endregion

        #region ModifyAccount
        /// <summary>
        /// ModifyAccount
        /// </summary>
        /// <param name="input"></param>
        /// <returns></returns>
        [HttpPost]
        [ResponseType(typeof(NordCar.WebAPI.Models.EC.Account))]
        public IHttpActionResult ModifyAccount(NordCar.WebAPI.Models.EC.PersonalAccount input)
        {

            TraceAccount(input.person);
            Log.Info(string.Format("CustomerNo={0}", input.person.CustomerNo));

            //var bs1 = fillbasics(FunctionList.ModifyAccount, BookTypes.ECBOOK);
            var bs1 = fillbasics(FunctionList.ModifyAccount, input.basic);
            bs1.CustomerId = input.person.CustomerNo;
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);
            var input1 = Mapper.Map<NordCar.WebAPI.Models.EC.Person, NordCar.Carla.Data.Entities.EC.Person>(input.person);

            var data = this.ECAPIManagerRepository.ModifyAccount(bs, input1);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    CustomerAccount = Mapper.Map<NordCar.Carla.Data.Entities.EC.Account, NordCar.WebAPI.Models.EC.Account>(data.Item2),

                    Status = "OK"
                };
                return Ok(result);

            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }


        }
        #endregion

        #region SecretQuestions
        /// <summary>
        /// SecretQuestions
        /// </summary>
        /// <returns></returns>
        [HttpGet]
        public IHttpActionResult GetSecretQuestions()
        {

            var bs1 = fillbasics(FunctionList.SecretQuestions, BookTypes.ECBOOK);
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);

            var data = this.ECAPIManagerRepository.DropDownLists(bs);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    Lists = Mapper.Map<List<NordCar.Carla.Data.Entities.EC.DropDownListItem>, List<NordCar.WebAPI.Models.EC.DropDownListItem>>(data.Item2),
                    Status = "OK"
                };
                return Ok(result);

            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }


        }
        #endregion

        #region GetPaymentCardTypes
        /// <summary>
        /// PaymentCardTypes
        /// </summary>
        /// <returns></returns>
        [HttpGet]
        public IHttpActionResult GetPaymentCardTypes()
        {

            var bs1 = fillbasics(FunctionList.PaymentCardTypes, BookTypes.ECBOOK);
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);

            var data = this.ECAPIManagerRepository.DropDownLists(bs);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    Lists = Mapper.Map<List<NordCar.Carla.Data.Entities.EC.DropDownListItem>, List<NordCar.WebAPI.Models.EC.DropDownListItem>>(data.Item2),
                    Status = "OK"
                };
                return Ok(result);

            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }


        }
        #endregion

        #region GetFrequentTravelerPrograms
        /// <summary>
        /// GetFrequentTravelerPrograms
        /// </summary>
        /// <returns></returns>
        [HttpGet]
        public IHttpActionResult GetFrequentTravelerPrograms()
        {

            var bs1 = fillbasics(FunctionList.FrequentTravelerPrograms, BookTypes.ECBOOK);
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);

            var data = this.ECAPIManagerRepository.DropDownLists(bs);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    Lists = Mapper.Map<List<NordCar.Carla.Data.Entities.EC.DropDownListItem>, List<NordCar.WebAPI.Models.EC.DropDownListItem>>(data.Item2),
                    Status = "OK"
                };
                return Ok(result);

            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }


        }
        #endregion

        #region GetCarSpecifications
        /// <summary>
        /// GetCarSpecifications
        /// </summary>
        /// <param name="bookType"></param>
        /// <param name="countryId"></param>
        /// <param name="carType"></param>
        /// <param name="carGroup"></param>
        /// <returns></returns>
        [HttpGet]
        public IHttpActionResult GetCarSpecifications(string bookType, string countryId, string carType, string carGroup, string age)
        {

            Log.Info(string.Format("countryId={0}", countryId));
            Log.Info(string.Format("carType={0}", carType));
            Log.Info(string.Format("carGroup={0}", carGroup));
            Log.Info(string.Format("bookType={0}", bookType));

            BookTypes booktype = NordCar.WebAPI.Models.Helper.ParseEnum(bookType);

            if (booktype == 0)
            {
                return BookTypeNotFound(bookType);
            }

            var bs1 = fillbasics(FunctionList.GetCarSpecifications, booktype);
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);

            var data = this.ECAPIManagerRepository.GetCarSpecifications(bs, countryId, carType, carGroup, age);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    CarSpec = Mapper.Map<List<NordCar.Carla.Data.Entities.EC.CarSpec>, List<NordCar.WebAPI.Models.EC.CarSpec>>(data.Item2),
                    Status = "OK"
                };
                return Ok(result);

            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }


        }
        #endregion

        #region GetFleet
        /// <summary>
        /// GetFleet
        /// </summary>
        /// <param name="bookType"></param>
        /// <param name="countryId"></param>
        /// <returns></returns>
        [HttpGet]
        [ResponseType(typeof(NordCar.WebAPI.Models.EC.CarSpec))]
        public IHttpActionResult GetFleet(string bookType, string countryId, string age)
        {

            Log.Info(string.Format("countryId={0}", countryId));

            BookTypes booktype = NordCar.WebAPI.Models.Helper.ParseEnum(bookType);

            if (booktype == 0)
            {
                return BookTypeNotFound(bookType);
            }
         
            var bs1 = fillbasics(FunctionList.GetCarSpecifications, booktype);
            
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);

            var data = this.ECAPIManagerRepository.GetCarSpecifications(bs, countryId, "", "", age);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    CarSpec = Mapper.Map<List<NordCar.Carla.Data.Entities.EC.CarSpec>, List<NordCar.WebAPI.Models.EC.CarSpec>>(data.Item2),
                    Status = "OK"
                };
                return Ok(result);

            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }


        }
        #endregion

        #region GetBookings
        /// <summary>
        /// GetBookings
        /// </summary>
        /// <param name="customerNo"></param>
        [HttpGet]
        [ResponseType(typeof(NordCar.WebAPI.Models.Booking))]
        public IHttpActionResult GetBookings(string customerNo)
        {

            Log.Info(string.Format("customerNo={0}", customerNo));
         

            var bs1 = fillbasics(FunctionList.SearchBooking, BookTypes.ECBOOK);
            bs1.CustomerId = customerNo;
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);

            var data = this.ECAPIManagerRepository.SearchBooking(bs, "", "", "", "");

            if (data.Item1.Succes)
            {
                var result = new
                {
                    Bookings = Mapper.Map<List<NordCar.Carla.Data.Entities.EC.Booking>, List<NordCar.WebAPI.Models.EC.Booking>>(data.Item2),
                    Status = "OK"
                };

                return Ok(result);
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }

        }
        #endregion

        #region DibsResult
        /// <summary>
        /// DibsResult
        /// </summary>
        /// <param name="bookingId">Booking returned from MakeReservation function</param>
        /// <param name="paymentFlag">[statuscode]</param>
        /// <param name="paymentType">[paymentType]</param>
        /// <param name="paymentCode">transact (1st DIBS reply)</param>
        /// <param name="paymentAmount">TotalPrice [from MakeReservation]</param>
        /// <param name="depositPaymentCode">transact (2nd DIBS reply)</param>
        /// <param name="depositPaymentAmount">DepositOnline(DKK) [from MakeReservation]</param>
        /// <returns></returns>
        [HttpGet]
        [ResponseType(typeof(DibsResultItem))]
        public IHttpActionResult DibsResult(int bookingId, int paymentFlag, int paymentType, int paymentCode, int paymentAmount, int depositPaymentCode, int depositPaymentAmount)
        {

            Log.Info(string.Format("bookingId={0}", bookingId));
            Log.Info(string.Format("paymentFlag={0}", paymentFlag));
            Log.Info(string.Format("paymentType={0}", paymentType));
            Log.Info(string.Format("paymentCode={0}", paymentCode));
            Log.Info(string.Format("paymentAmount={0}", paymentAmount));
            Log.Info(string.Format("depositPaymentCode={0}", depositPaymentCode));
            Log.Info(string.Format("depositPaymentAmount={0}", depositPaymentAmount));
      
      
            var bs1 = fillbasics(FunctionList.ECDibsResult, BookTypes.ECBOOK);
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);
            var data = this.ECAPIManagerRepository.DibsResult(bs, bookingId, paymentFlag, paymentType, paymentCode, paymentAmount, depositPaymentCode, depositPaymentAmount);

            if (data.Item1.Succes)
            {
                return Ok(Mapper.Map<NordCar.Carla.Data.Entities.DibsResultItem, DibsResultItem>(data.Item2));
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }
        }

        #endregion

        #region CheckPromotionCode
        /// <summary>
        /// CheckPromotionCode
        /// </summary>
        /// <param name="bookType"></param>
        /// <param name="promotionCode"></param>
        /// <returns></returns>
        [HttpGet]
        public IHttpActionResult CheckPromotionCode(BasicStructure1 basic)
        {

            Log.Info(string.Format("promotionCode={0}", basic.VoucherCode));

            BookTypes booktype = NordCar.WebAPI.Models.Helper.ParseEnum(basic.BookTypes);

            if (booktype == 0)
            {
                return BookTypeNotFound(basic.BookTypes);
            }

            var bs1 = fillbasics(FunctionList.CheckPromotionCode, booktype);
            bs1.VoucherCode = basic.VoucherCode;
            
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);

            var data = this.ECAPIManagerRepository.CheckPromotionCode(bs);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    PromotionResult = data.Item2,
                    Status = "OK"
                };

                return Ok(result);
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }

        }
        #endregion

        #region GetCarTypesByLocation
       /// <summary>
        /// GetCarTypesByLocation
       /// </summary>
        /// <param name="bookType"></param>
       /// <param name="locationId"></param>
       /// <param name="country"></param>
       /// <returns></returns>
        [HttpGet]
        [ResponseType(typeof(NordCar.WebAPI.Models.EC.CarTypeLocationDetails))]
        public IHttpActionResult GetCarTypesByLocationDetails(string bookType, string locationId, string country)
        {

            BookTypes booktype = NordCar.WebAPI.Models.Helper.ParseEnum(bookType);

            if (booktype == 0)
            {
                return BookTypeNotFound(bookType);
            }
            
            var bs1 = fillbasics(FunctionList.GetCarTypesByLocation, booktype);
            
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);
            
            var data = this.ECAPIManagerRepository.GetCarTypesByLocation(bs,locationId,country);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    Types = Mapper.Map<List<NordCar.Carla.Data.Entities.EC.CarTypeLocationDetails>, List<NordCar.WebAPI.Models.EC.CarTypeLocationDetails>>(data.Item2),
                    Status = "OK"
                };

                return Ok(result);
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }

        }
        #endregion

        #region GetReservationText
        /// <summary>
        /// GetReservationText
        /// </summary>
        /// <param name="reservationNumber"></param>
        /// <returns></returns>
        [HttpGet]
        [ResponseType(typeof(NordCar.WebAPI.Models.EC.ReservationText))]
        public IHttpActionResult GetReservationText(string reservationNumber)
        {

            Log.Info(string.Format("reservationNumber={0}", reservationNumber));

           
            var bs1 = fillbasics(FunctionList.GetReservationText, BookTypes.ECBOOK);
           
            var bs = Mapper.Map<BasicStructure, NordCar.Carla.Data.Entities.BasicStructure>(bs1);

            var data = this.ECAPIManagerRepository.GetReservationText(bs,reservationNumber);

            if (data.Item1.Succes)
            {
                var result = new
                {
                    texts = Mapper.Map<NordCar.Carla.Data.Entities.EC.ReservationText,NordCar.WebAPI.Models.EC.ReservationText>(data.Item2),
                    Status = "OK"
                };

                return Ok(result);
            }
            else
            {
                return Error(Mapper.Map<NordCar.Carla.Data.Entities.APIMethodControl, APIMethodControl>(data.Item1), HttpStatusCode.NotFound);
            }

        }
        #endregion

        private NotFoundJSONActionResult BookTypeNotFound(string bookType)
        { 
            return Error(new APIMethodControl() { Succes=false, ErrorMessage=string.Format("Booktype {0} not found",bookType)}, HttpStatusCode.NotFound);
        }

        private NotFoundJSONActionResult BasicNotSet()
        {
            return Error(new APIMethodControl() { Succes = false, ErrorMessage = "Basic not set" }, HttpStatusCode.NotFound);
        }
    }
}