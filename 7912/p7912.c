#define NOLOG
#include "egedef.h"
/* ******************************************** */
/* p7912.c DON webkommunikation             	*/
/* ******************************************** */
/* ******************************************************************** */
/* 120503 2.05.01	TXPAI	4161					*/
/* 120704 2.05.02	GENPRISLISTE funktion2				*/
/* 120705 2.05.03	DON2SNYD					*/
/* 120817 2.05.04	OrgBookNr 					*/
/* 120829 2.05.05	ws_inputfunktion ws_snydflag			*/
/* 120830 2.05.06	udpak_testinput 				*/
/* 120831 2.05.07	funktion 10-14	 				*/
/* 120903 2.05.08	funktion 3 realtime 				*/
/* 120905 2.05.09	funktion 4 realtime 				*/
/* 120906 2.05.10	funktion 5 realtime 				*/
/* 120907 2.05.11	funktion 6 7 realtime 				*/
/* 120911 2.05.12	funktion 8 realtime 				*/
/* 120912 2.05.14	funktion 10 realtime 				*/
/* 120919 2.05.15	DefaultProductSelection 			*/
/* 120920 2.05.16	GetFrontpageDefault	 			*/
/* 120920 2.05.17	GetCompanyDrivers	 			*/
/* 120921 2.05.18	GetBookList		 			*/
/* 120921 2.05.19	EditRental		 			*/
/* 120926 2.05.20	GetInvalidPickupDates	 			*/
/* 120926 2.05.21	GetInvalidReturnDates	 			*/
/* 120926 2.05.22	GetOpenHours	 				*/
/* 121001 2.05.23	UpdateCompanyDrivers Subfuction 2		*/
/* 121005 2.05.24	ReturnCompanyCustomerId				*/
/* 121009 2.05.25	KAPACITETOFF					*/
/* 121011 2.05.26	DONSTxxON					*/
/* 121012 2.05.27	GetBookingList aktivflag			*/
/* 121015 2.05.28	PRISKOMMA prisliste				*/
/* 121015 2.05.29	BOOKLISTNAVNE					*/
/* 121017 2.05.30	10 8 9 just					*/
/* 121018 2.05.31	10 5 udpak_extratab nyopret_reserv dondafolo	*/
/* 121022 2.05.32	4 default PAI 35				*/
/* 121101 2.05.33	7 8 mobil sms 					*/
/* 121105 2.05.34	SUBMITEXTRAKOMPENSATION				*/
/* 121106 2.05.35	INKLKM						*/
/* 121108 2.05.36	MBIDRAGOK					*/
/* 121121 2.05.37	PROMOTION					*/
/* 121129 2.05.38	PAIPRDAG BSTOLPRDAG				*/
/* 121203 2.05.39	DON2PRISLST					*/
/* 121204 2.05.40	COMPANYDRIVERSMAX10				*/
/* 121210 2.05.41	SubmitRental - Renter x 5 fjernes		*/
/* 121211 2.05.42	ReturnProductDefs				*/
/* 121219 2.05.43	LEJEPRISUDENEXTRA				*/
/* 121219 2.05.44	PRISLISTEEXTRAOPL				*/
/* 130104 2.05.45	FYRAFTENEXTRA					*/
/* 130110 2.05.46	PRODUKTPNG					*/
/* 130112 2.05.47	DON2VINTERANH					*/
/* 130115 2.05.48	CHECKKKNR					*/
/* 130118 2.05.49	PRODUKTAFHAFL TESTTID				*/
/* 130121 2.05.50	SMSKVIT						*/
/* 130121 2.05.51	WEEKENDCHECK					*/
/* 130122 2.05.52	FIRMAAFTALEOFF					*/
/* 130122 2.05.53	CHECKFNVNCVR					*/
/* 130123 2.05.54	BOOKLISTANNULL					*/
/* 130124 2.05.55	KONTROLGODK					*/
/* 130225 2.05.56	PRISLISTEMBIDRAG				*/
/* 130227 2.05.57	DIBSSTYR					*/
/* 130304 2.05.58	NEXTOKTID					*/
/* 130304 2.05.59	FLYTTEKASSEX10					*/
/* 130304 2.05.60	TUSINDEKOMMA					*/
/* 130304 2.05.61	WEEKENDVARETID1600				*/
/* 130306 2.05.62	DATOAFTBLOK					*/
/* 130311 2.05.63	KONV8859LOGIN					*/
/* 130319 2.05.64	NEXTOKTID2					*/
/* 130319 2.05.65	ERHVERVSPRIS					*/
/* 130319 2.05.66	KOMMADECI					*/
/* 130321 2.05.67	FIRMALEJERMEDL					*/
/* 130321 2.05.68	KONV8859DRIVER					*/
/* 130321 2.05.69	TVUNGENMAANED					*/
/* 130321 2.05.70	ERHVERVPNG					*/
/* 130322 2.05.71	KONV8859MEDL					*/
/* 130405 2.05.72	DKKKR						*/
/* 130410 2.05.73	KORRLUKKETID					*/
/* 130416 2.05.74	CHECK21ALDER					*/
/* 130422 2.05.75	CHECKDIBSRETURKODE				*/
/* 130508 2.05.76	UDSOLGT						*/
/* 130521 2.05.77	DEFAULTFIRMAAFTALE				*/
/* 130521 2.05.78	PDF						*/
/* 130523 2.05.79	KAMPAGNELINK					*/
/* 130524 2.05.80	OBSDON2KAMPAGNE					*/
/* 130528 2.05.81	KMPUNKTUM					*/
/* 130530 2.05.82	BOOKNOMATCH					*/
/* 130603 2.05.83	UDSOLGTDIVSTYLE					*/
/* 130604 2.05.84	UDSOLGTKOMMA					*/
/* 130614 2.05.85	LOGSUBMITRENTAL					*/
/* 130617 2.05.86	SUBMITCANCELORG					*/
/* 130624 2.05.87	NOSHOW						*/
/* 130626 2.05.88	FRI7DAGE					*/
/* 130701 2.05.89	WEBOPRETLOG					*/
/* 130828 2.05.90	BETALINGSKORTLISTE				*/
/* 130920 2.05.91	DOBBELBOOKCHECK					*/
/* 130923 2.05.92	FRI1DAG						*/
/* 131103 2.05.93	EFTERAAR					*/
/* 131103 2.05.94	MAANEDKAMPAGNE					*/
/* 131004 2.05.95	MAANEDKAMPAGNE grafik				*/
/* 131104 2.05.96	AKTIVERET DEPOSITUM 16523 16524 16525		*/
/* 131114 2.05.97	STATUS19					*/
/* 131114 2.05.98	DOBBELFIRMAOPRET				*/
/* 131120 2.05.99	PSSTATION					*/
/* 131125 2.06.00	GEMOPRKOMMANDO					*/
/* 131128 2.06.01	PSCARLIST					*/
/* 131202 2.06.02	GPS don2gpsok					*/
/* 131210 2.06.03	GPSWEEKEND					*/
/* 131211 2.06.04	PSVARIGHED					*/
/* 131212 2.06.05	PSTYPESPEC					*/
/* 131218 2.06.06	DEPTXT						*/
/* 131223 2.06.07	CHECKFPLUKKET					*/
/* 140130 2.06.08	STEP3LOGIN					*/
/* 140207 2.06.09	PAASKE2014					*/
/* 140218 2.06.10	XLSPRIS						*/
/* 140305 2.06.11	CO996EJGRATIS					*/
/* 140305 2.06.12	YOUNG997EXTRA					*/
/* 140305 2.06.14	GENPRISJUST					*/
/* 140306 2.06.15	PSPRODUKTINKL					*/
/* 140306 2.06.16	CO996MAX180					*/
/* 140306 2.06.17	PROMOSTYR					*/
/* 140307 2.06.18	PROMOSTYR2					*/
/* 140307 2.06.19	PROMOSTYR3					*/
/* 140307 2.06.20	CO996FIRMANUL					*/
/* 140310 2.06.21	XLSPRIS2					*/
/* 140312 2.06.22	VINTERDÆKPRISFEJL ANHÆNGERTRÆK			*/
/* 140312 2.06.23	DRVFDATOMIN21					*/
/* 140313 2.06.24	ANHÆNGERTRÆK					*/
/* 140317 2.06.25	PAASKE2014 grafik				*/
/* 140321 2.06.26	DROPDOWNEXTRA					*/
/* 140325 2.06.27	DONGASPEDAL					*/
/* 140327 2.06.28	PSMAXVARIGHED29					*/
/* 140401 2.06.29	PSREQUEST ws_requestflag ws_psbookstatus	*/
/* 140402 2.06.30	FINDXLSPAIPRISPRDAG				*/
/* 140404 2.06.31	NYPSPRISLISTE					*/
/* 140408 2.06.32	PSKUNDENRNUL					*/
/* 140409 2.06.33	PSKUNDEOPLSUBMIT				*/
/* 140409 2.06.34	NYPSPRISLISTE nypsprislisteok			*/
/* 140411 2.06.35	PLIGTTEKSTFUNK_5_21				*/
/* 140411 2.06.36	PROMOPRISJUST					*/
/* 140416 2.06.37	PSREQUEST KON					*/
/* 140422 2.06.38	TILVALGSORTERING				*/
/* 140422 2.06.39	PROMOPRISJUSTBEM				*/
/* 140423 2.06.40	ALDERBLOK					*/
/* 140423 2.06.41	XLSPRODMATCH					*/
/* 140424 2.06.42	KMPAKKEXLS					*/
/* 140424 2.06.43	BILGRUPPEFILREF nypslistejpgok			*/
/* 140425 2.06.44	WEEKENDKONTRADAG				*/
/* 140425 2.06.45	XLSMAINCHECK					*/
/* 140428 2.06.46	SRNXLS						*/
/* 140428 2.06.47	PSPROMOSUBMIT					*/
/* 140430 2.06.48	DROPDOWNEXTRAPRIS				*/
/* 140430 2.06.49	PLIGTOPLOPDAT					*/
/* 140504 2.06.50	SUBMITPSLEJEROPL				*/
/* 140505 2.06.51	UNDERCONTRUCTION				*/
/* 140506 2.06.52	BARNESTOLLM					*/
/* 140507 2.06.53	BARNESTOLANTAL					*/
/* 140508 2.06.54	DONHLGTLF					*/
/* 140508 2.06.55	PSPAICHECKBOX					*/
/* 140509 2.06.56	PSPAIUDREGNLM					*/
/* 140509 2.06.57	PSSELVRISIKOUDV					*/
/* 140509 2.06.58	SUBMITPSDEPOSITUMOPL				*/
/* 140512 2.06.59	DEFAULTTID					*/
/* 140512 2.06.60	PSLANGTIDTLF					*/
/* 140513 2.06.61	ANHTRÆK						*/
/* 140513 2.06.62	PSSENEREAFLTID	live ps ver 1			*/
/* 140514 2.06.63	DONSPECTEKSTER					*/
/* 140519 2.06.64	REQUESTSTYRWEEKEND				*/
/* 140526 2.06.65	PSAFLTID					*/
/* 140618 2.06.66	FRI5DAGE					*/
/* 140618 2.06.67	XLSF165SLETMARK					*/
/* 140618 2.06.68	KMPAKKE500					*/
/* 140627 2.06.69	KONVDKTGN					*/
/* 140709 2.06.70	PSDAGEKMANTAL					*/
/* 140723 2.06.71	PSNOTEASER					*/
/* 140723 2.06.72	PSFPDEFAULTTID					*/
/* 140724 2.06.73	PSWEEKENDMATCH psweekaltok			*/
/* 140819 2.06.74	PSUPDATEPRODNAVN				*/
/* 140822 2.06.75	FLYTTEKASSERXLS psflyttekok			*/
/* 140825 2.06.76	PSPROMOPCT 8198/15605				*/
/* 140828 2.06.77	FLYTTEKASSEX10RETTELSE				*/
/* 140904 2.06.78	KMPKSPECNR					*/
/* 140904 2.06.79	PSVDAEK						*/
/* 140905 2.06.80	PSMBIDRAGPRODUKTINKL PSMBIDRAGPRISLISTE		*/
/* 140909 2.06.81	PSFLYTTEKASSER10_50				*/
/* 140910 2.06.82	PSFLKTOTALPRIS					*/
/* 140915 2.06.83	KOLONNEMANGLER					*/
/* 140918 2.06.84	ERRKODEITEST					*/
/* 140929 2.06.85	PSWEEKENDPRISFEJL				*/
/* 141007 2.06.86	PRODIKKERELEVANT TEST EFTERAAR 644		*/
/* 141007 2.06.87	PSVDAEKPROD psvdaekprodok			*/
/* 141007 2.06.88	DONFLYTTEKASSE					*/
/* 141010 2.06.89	PSWEEKENDVARIGHEDSNYD				*/
/* 141015 2.06.90	DONSTEP3BOOKPRBL				*/
/* 141017 2.06.91	641MAANED1000 don641online			*/
/* 141021 2.06.92	641MAANED1000PRISLISTE				*/
/* 141021 2.06.93	PSWEEKENDVARIGHEDJUSTERING			*/
/* 141028 2.06.94	PRODUKTVALGLUKKET				*/
/* 141029 2.06.95	PSKMPK840					*/
/* 141113 2.06.96	DONMILJOMAERKE					*/
/* 141114 2.06.97	PSGLNYKATALOG					*/
/* 141117 2.06.98	PSGLNYKATALOG genprisliste			*/
/* 141118 2.06.99	DONJUL2014					*/
/* 141119 2.07.00	PSCODRIVERCHECKBOX				*/
/* 141203 2.07.01	PSGLNYKATALOG GlT				*/
/* 141209 2.07.02	PSGLNYKATALOGVL					*/
/* 141217 2.07.03	PSADMDIVFLAG905906907				*/
/* 150106 2.07.04	PSKORRLUKKETID					*/
/* 150108 2.07.05	DONSYSTEMFEJL					*/
/* 150108 2.07.06	MAANEDKONTAKT					*/
/* 150109 2.07.07	MAANEDPRISOFF					*/
/* 150109 2.07.08	FRI30DAGE					*/
/* 150109 2.07.09	DOBBELBOOKCHECKJUST				*/
/* 150203 2.07.10	FRI1DAG fejl varevogn				*/
/* 150216 2.07.11	PSPAASKE FREDAGWEEKENDAABEN			*/
/* 150223 2.07.12	DONANHFEJL					*/
/* 150227 2.07.14	NYTPRODUKT683					*/
/* 150304 2.07.15	DONGPSGRP3					*/
/* 150306 2.07.16	BLACKOUTJUSTERING				*/
/* 150324 2.07.17	WEBAPI						*/
/* 150505 2.07.18	ACRISSKODE					*/
/* 150507 2.07.19	DIVJUST01					*/
/* 150511 2.07.20	ECNYWEBPRSNYD					*/
/* 150513 2.07.21	OPTIONID					*/
/* 150518 2.07.22	EMAILLOWER UDVRATE				*/
/* 150519 2.07.23	PSSÆSONPRISER uddato				*/
/* 150520 2.07.24	WEBAPIFEJLKODE					*/
/* 150602 2.07.25	BOOKFLOWJUST1					*/
/* 150604 2.07.26	ACCOUNTNYDATA					*/
/* 150615 2.07.27	WEBAPI27 LOKATIONUDNAVN LOKATIONINDNAVN		*/
/* 150623 2.07.28	UDLANDUNDTAGELSER				*/
/* 150623 2.07.29	KUNDENRMATCHBOOKING				*/
/* 150624 2.07.30	ECEXTUDSTYR					*/
/* 150626 2.07.31	ECEXTUDSTYRECW31				*/
/* 150703 2.07.32	WEBAPI31JUST1					*/
/* 150706 2.07.33	ECWBOOKSTATUS					*/
/* 150710 2.07.34	WEBAPI31JUST2					*/
/* 280710 2.07.35	WEBAPI36_CUSTOMERTYPE		    */
/* ******************************************************************** */ 
#define		WEBVER		"2.07.35"
/* ******************************************************************** */
/* ******************************************************************** */
#include <signal.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/timeb.h>
#include <sys/time.h>
#include <dirent.h>
DIR * dirp;
struct dirent * dp;

#include "f183.h"
extern F183  * f183;
#include "r183.h"
extern R183 * r183;
static R183   w183;

#include "f197.h"
extern F197  * f197;
#include "r197.h"
extern R197 * r197;

#include "f198.h"
extern F198  * f198;
#include "r198.h"
extern R198 * r198;
static R198   q198;
static R198   x198;
static R198   z198;

#include "f166.h"
extern F166  * f166;
#include "r166.h"
extern R166 * r166;

#include "f167.h"
extern F167  * f167;
#include "r167.h"
extern R167 * r167;
static R167   q167;
static R167   x167;

#include "f178.h"
extern F178  * f178;
#include "r178.h"
extern R178 * r178;
static R178   q178;

#include "f174.h"
extern F174  * f174;
#include "r174.h"
extern R174 * r174;

#include "f165.h"
extern F165  * f165;
#include "r165.h"
extern R165 * r165;
static R165   w165;

#include "f159.h"
extern F159  * f159;
#include "r159.h"
extern R159 * r159;
static R159   q159;
#define r163	r159
#define r164	r159

#include "f359.h"
extern F359  * f359;
#include "r359.h"
extern R359 * r359;
static R359   q359;
static R359   z359;

#include "f155.h"
extern F155  * f155;
#include "r155.h"
extern R155 * r155;

#include "f145.h"
extern F145  * f145;
#include "r145.h"
extern R145 * r145;

#include "f168.h"
extern F168  * f168;
#include "r168.h"
extern R168 * r168;

#include "f169.h"
extern F169 * f169;
#include "r169.h"
extern R169 * r169;

#include "f171.h"
extern F171 * f171;
#include "r171.h"
extern R171 * r171;

#include "f172.h"
extern F172 * f172;
#include "r172.h"
extern R172 * r172;

#include "f29.h"
extern F29 * f29;
#include "r29.h"
extern R29 * r29;

#include "f03.h"
extern F03 * f03;
#include "r03.h"
extern R03 * r03;

#include "f07.h"
extern F07 * f07;
#include "r07.h"
extern R07 * r07;

#include "f10.h"
extern F10 * f10;
#include "r10.h"
extern R10 * r10;

#include "f30.h"
extern F30 * f30;
#include "r30.h"
extern R30 * r30;

#include "ecarbss.h"
	BSS * bss;
#include "40p7502ls.h"
         P7502LS  * p7502ls;
#include "40xlspris.h"
	XLSPRISMAIN * xlsprismain;
	XLSPRISSUB * xlsprissub;
	XLSPRISMATCH * xlsprismatch;
/* NYT 150418 UDVRATE */
#include "40udvrate.h"
	UDVRATE * udvrate;

#include "m002.h"
extern  M002    * m002;

#include "e_lande.h"

FILE * tmpfil;

FILE * logfil;
FILE * listeptr;
int 		nuv;
unsigned char 	str[5000];
char   		* strptr;
short int 	log_flag;
char 		logfil_navn[50];
char 		dum_str[200];

/* BASE64 */
#define TRUE 1
#define FALSE 0
#define LINELEN 76
#define MAXINLINE 256
static FILE*fi;
static FILE*fo;
typedef unsigned char byte;
static byte iobuf[MAXINLINE];
static int iolen= 0;
static int iocp= MAXINLINE;
static int ateof= FALSE;
static byte dtable[256];
static int linelength= 0;
static char eol[3]= "\n";
static int errcheck= TRUE;

static int		kaldfunk_check_bssaaben = 0;

static short int 	ws_sommerwebfejl = 0;
static short int 	ws_testkreds = 0;
static short int 	ws_pgflag = 0;
static short int 	ws_udldkjul = 0;
static short int 	ws_udldkflag = 0;
static short int 	ws_udldkfrgspg = -1;
static char		ws_udldkland[41] = "";
static char		ws_udldkmedlfor[41] = "";
static char		ws_udldkmedleft[41] = "";
static short int 	ws_donextraidx = 0;
static short int 	ws_udldkextraidx = 0;
static short int 	ws_prodlisteantal = 0;
static short int 	ws_prodsortflag = 0;
static short int 	ws_prodsortidx = 0;
static short int 	ws_brandtype = 0;
static short int 	ws_alert_flag = 0;
static char		ws_alert_txt[201] = "";
static char		ws_differrormess[201] = "";
static char		ws_kommandostr[1001] = "";

static long int 	ws_don2errno = 0;
static char		ws_ipadr[101] = "";
static char		ws_browserid[5][301] = {"","","","",""};
static short int 	ws_don2flag = 0;
static short int 	ws_firmaloginflag = -1;
/* NYT 120817 */
static long int 	ws_orgbooknr = 0;
static short int 	ws_don2stepnr = 0;
static short int 	ws_kundenrtype = 0;
static short int 	ws_inputstation = -1;
static short int 	ws_dkflag = 0;
static long int 	ws_inpaa = 0;
static long int 	ws_inpmm = 0;
static long int 	ws_lejerknr = 0;
static long int 	ws_medlknr = 0;
static char		ws_lejerfornavn[41] = "";
static char		ws_lejereftnavn[41] = "";
static char		ws_lejerkkortnr[41] = "";
static char		ws_lejerfdato[41] = "";
static char		ws_medlfornavn[81] = "";
static char		ws_medleftnavn[81] = "";
static char		ws_medlkkortnr[81] = "";
static char		ws_medlfdato[81] = "";

static long int		ws_kampagneid = -1;
static short int	ws_funkparaantal = 0;
static short int	ws_minimumparaantal = 0;
static short int 	ws_parameterantal = 0;
static short int 	ws_opdaterfunk = 0;
static long int 	ws_opdaterknr = 0;
static short int 	ws_kundetype = 0;
static short int 	ws_logintype = 0;
static char		ws_loginid1[41] = "";
static char		ws_loginid2[41] = "";
static short int 	ws_testsktgn = 43;
static short int 	ws_testudpak = 0;
static short int 	ws_snydflag = 0;
static short int 	ws_feltantal = 0;
static short int 	ws_inputfunktion = 0;
static short int 	ws_funktion = 0;
static short int 	ws_subfunktion = 0;
static short int 	ws_winflag = 0;
static short int 	ws_station = 0;
static short int 	ws_tilstation = 0;
static short int 	ws_maxspcperiode = 0;
static short int 	ws_inputspecnr = 0;
static short int 	ws_specnr = 0;
static short int 	ws_paiflag = 0;
static double 		ws_paidag = 0;
static short int	ws_betalingsflag = 0;
static short int	ws_kontantflag = 0;
static short int	ws_dponflag = 0;
static short int	ws_dgnprisflag = 0;
static short int	ws_pdftype = -1;
static int		ws_sendretur = 0;
static int		ws_funkretur = 0;
static int		ws_funkretur2 = 0;
static int		ws_funkretur3 = 0;
static int		ws_inpfunk = 0;
static short int	ws_dgvarighed = 0;
static long int 	ws_aftalenr = 0;
static long int 	ws_resnr = 0;
static long int 	ws_amd = 0;
static long int 	ws_foedselsdato = 0;
static long int 	ws_kundenr = 0;
static long int 	ws_fradato = 0;
static long int 	ws_tildato = 0;
static long int 	ws_kundedtfra = 0;
static long int 	ws_kundedttil = 0;
static long int 	ws_fratid = 0;
static long int 	ws_tiltid = 0;
static long int 	ws_kundetdfra = 0;
static long int 	ws_kundetdtil = 0;
static long int 	ws_nyopret_varigh = 0;
/* NYT 061128 JUL06 */
static long int 	ws_altperiode = 0;
static long int 	ws_altfradato = 0;
static long int 	ws_altfratid = 0;
static long int 	ws_alttildato = 0;
static long int 	ws_alttiltid = 0;
static short int 	ws_altcdipaiflag = 0;
static char 		ws_hlgtilbud[21] = "";
/* NYT 111020 */
static char 		ws_sttlfnr[21] = "";
/* NYT 121121 */
static char 		ws_rekvnr[41] = "";
/* NYT 130121 */
static char 		ws_hostnavn[41] = "";
static int		ws_smskvitflag = 0;
/* NYT 130524 */
static int		ws_stepnr = 0;
/* NYT 130920 DOBBELBOOKCEHCK */
static long int		ws_dobbelresnr = 0;
static short int	ws_dobbelfrgspg = 0;
static char		ws_dobbelbooksvar[101];
static char		ws_dobbelnavnopl[201] = "";

static double		ws_betalingsbeloeb = 0;
static double		ws_betdepbeloeb = 0;
static double		ws_lufthavnsgebyr = 0;
static double		ws_onewaygebyr = 0;
static double		ws_nyopret_depos = 0;
static double		ws_mbidrag = 0;
static char		ws_mbidragtxt[41] = "";
static char		ws_grp[11] = "";
static char		ws_inpgrp[11] = "";
static char		ws_evtextra[21] = "";
static char		ws_promokode[21] = "";
static char		ws_promotxt[81] = "";
static double		ws_promobeloeb = 0;
static int		ws_promotype = 0;
static double		ws_promotabel[20] =
			{0,150,200,300,300,300,300,300,300,300,
			300,300,300,300,300,300,300,300,300,300};
static int		ws_donpromotype = 0;
static int		ws_donpromofunk = 0;
static long int		ws_donpromomaxvarighed = 0;
static double		ws_donpromojustering = 0;
static char		ws_donpromoretur[81] = "";
/* NYT 140825 PSPROMOPCT */
static double		ws_donpromodagbeloeb = 0;
static double		ws_donpromototalbeloeb = 0;
static char		ws_donpromobiltype[41] = "";
static char		ws_donpromobilgrp[41] = "";

static char		ws_booktype[21] = "";
static char		ws_bookstep[21] = "";
static char		ws_extraid[21] = "";
static char		ws_extspcstr[21] = "";
static char		ws_donspcstr[41] = "";
static char		ws_udldkspcstr[41] = "";
static char		ws_donrekvstr[41] = "";
static char		ws_donaltprisdata[41] = "";
static char 		ws_donidtab[10][81] = {"","","","","","","","","",""};
static char		ws_dondatatab[10][81] = {"","","","","","","","","",""};
static double		ws_dondatapris[10] = {0,0,0,0,0,0,0,0,0,0};


static char		ws_udldkaltprisdata[41] ="";
static char 		ws_udldkidtab[10][81] =
			{"","","","","","","","","",""};
static char		ws_udldkdatatab[10][201] =
			{"","","","","","","","","",""};
static double		ws_udldkdatapris[10] =
			{0,0,0,0,0,0,0,0,0,0};

static char		ws_udldkbemtab[20][201] =
			{"","","","","","","","","","",
			"","","","","","","","","",""};

static char		ws_landekode[21] = "";
static char		ws_doncoforn[51] = "";
static char		ws_doncoeftn[51] = "";
static long int 	ws_doncofdato = 0;
static char		ws_doncokkort[51] = "";
static char		ws_donorderid[51] = "";
static char		ws_biltype[16] = "";
static char		ws_langstr[21] = "";
static char		ws_emailadr[81] = "";
static char		ws_password[51] = "";
static char		ws_gl_password[51] = "";
static char		ws_navn[81] = "";
static char		ws_tlfnr[41] = "";
static char		ws_kkortnr[41] = "";
static char		ws_betalingstype[81] = "";
static char		ws_betalingskode[81] = "";
static char		ws_betdepkode[81] = "";
static char		ws_altprisfelt[81] = "";
static char		ws_flynr[81] = "";
static char		ws_tmpstr[301] = "";
static char		ws_tmppara[81] = "";
static char		ws_bruger[21] = "";
static char		ws_kreds[81] = "";
static char		ws_menuid[21] = "";
static int		ws_maxparatab = -1;
static int		ws_maxwebapiparatab = -1;
#define	MAX_PARATAB	50
static char		ws_paratab[MAX_PARATAB][81];
static char		ws_webapi_paratab[MAX_PARATAB][81];
#define	MAX_TMPTAB	100
static char		ws_tmptab[MAX_TMPTAB][81];
#define	MAX_DDTAB	8
static char		ws_ddtab[MAX_DDTAB][21] = {
			"",
			"mandag",
			"tirsdag",
			"onsdag",
			"torsdag",
			"fredag",
			"lørdag",
			"søndag"
			};
#define	MAX_MMTAB	13
static char		ws_mmtab[MAX_MMTAB][21] = {
			"",
			"januar",
			"februar",
			"marts",
			"april",
			"maj",
			"juni",
			"juli",
			"august",
			"september",
			"oktober",
			"november",
			"december"
			};
#define	MAX_HEADERTAB	2
static char		ws_headertab[MAX_HEADERTAB][101] = {
			"",
			"Det er ikke muligt at booke enkelte dage henover påsken. Book istedet vores WebPåske-tilbud."
			};
static short int	ws_headeridx = 0;
#define	MAX_UDLGRPTAB	100
static char		ws_udldkgrptab[MAX_UDLGRPTAB][31];
static short int	ws_udldkgrpidx = 0;
#define	MAX_UDLEXTTAB	10

static short		ws_udldkexttab[MAX_UDLEXTTAB] = {
			-1,905,905,905,924,996,997,910,-2,0
			};
static char		ws_udldkextgrp[MAX_UDLEXTTAB][11] = {
			"NOTAT","ALLE","ALLE","ALLE","GPS","ALLE","ALLE","ALLE","PAI",""
			};
static short		ws_udldkextant[MAX_UDLEXTTAB] = {
			0,3,3,3,1,5,5,1,1,0
			};
static char		ws_udldkexttxt[MAX_UDLEXTTAB][41] = {
			"Eventuelle ønsker:",
			"Barnestol 0-9 mdr",
			"Barnestol 9 mdr-4 år",
			"Barnepude 4 år - op",
			"GPS",
			"Ekstra chauffør",
			"Ung chauffør",
			"Vinterdæk",
			"Person-<br>ulykkes-<br>forsikring (PAI)",
			""
			};

#define	MAX_EXTRAPRODTAB	20
typedef struct  {
char		id[11];
char		beskrivelse[81];
char		enhedtxt[41];
char		valgtype[41];
char		rategruppe[11];
char		dropdownextra[11];
short int	ratespecnr;
short int	ratestatnr;
int		nuvantal;
int		minantal;
int		maxantal;
double		enhedpris;
double		totalpris;
}	EXTRAPTAB;
static  EXTRAPTAB  extraptab[MAX_EXTRAPRODTAB];
static short int	ws_extrapidx = 0;
static short int	ws_maxextratab = -1;
static char 		ws_extratab[MAX_EXTRAPRODTAB][81] =
			{"","","","","","","","","","",
			"","","","","","","","","",""};
static char		ws_donextraprio[MAX_EXTRAPRODTAB][21] = {
			"SPC932",
			"SPC933",
			"SPC934",
			"",
			"",
			"",
			"PAI",
			"SPC996",
			"",
			"",
			"",
			"",
			"",
			"",
			"",
			"",
			"",
			"",
			"",
			""
			};
static char		ws_drivertab[20][21] = {
			"","","","","","","","","","",
			"","","","","","","","","",""
			};
/* NYT 131203 PSBILGRPTYPE */
#define MAXGRPTAB	500
static short int	ws_grpidx = 0;
static char		ws_grptab[MAXGRPTAB][21];
static char		ws_grpxtab[MAXGRPTAB][81];
static char		ws_grpaldertab[MAXGRPTAB][21];

/* RETTET 110107 VINTERUDL */
#ifdef egetest
static short		ws_udldkexttab[MAX_UDLEXTTAB] = {
			-1,905,905,905,924,996,997,-2,0,0
			};
static char		ws_udldkextgrp[MAX_UDLEXTTAB][5] = {
			"NOTAT","ALLE","ALLE","ALLE","GPS","ALLE","ALLE","PAI","",""
			};
static short		ws_udldkextant[MAX_UDLEXTTAB] = {
			0,3,3,3,1,5,5,1,0,0
			};
static char		ws_udldkexttxt[MAX_UDLEXTTAB][41] = {
			"Eventuelle ønsker:",
			"Barnestol 0-9 mdr",
			"Barnestol 9 mdr-4 år",
			"Barnepude 4 år - op",
			"GPS",
			"Ekstra chauffør",
			"Ung chauffør",
			"Person-<br>ulykkes-<br>forsikring (PAI)",
			"",
			""
			};
#endif

static char		ws_udldkspectxt[31] = "";
static int		ws_udldkvinter = 0;

static long int 	ws_systemdato = 0;
static long int 	ws_systemtid = 0;
static unsigned long int 	ws_startsek = 0;
static unsigned long int 	ws_slutsek = 0;
static short int	ws_statresmin = 2;
static short int 	ws_donsaesonflag = 0;
static short int 	ws_fatallog = 0;

/* NYT 130515 0=PERSON 1=VARE	*/
static short int 	ws_biltp = -1;
static char 		ws_bilnavn[11] = "";
static int		ws_udsolgtdage = 0;
static char 		ws_udsolgtstr[201] = "";
/* NYT 130603 UDSOLGTDIVSTYLE */
static char 		ws_udsolgtdivst[81] = "<div style='font-size: 20px;'>";
static char 		ws_udsolgtdivsl[81] = "</div>";
/* NYT 131204 PSALDER */
static char 		ws_alderstr[21] = "";
/* NYT 131205 PGAABEN */
static char 		ws_pgaabenfilsti[81] = "";
/* NYT 140218 XLSPRIS */
static char 		ws_prisfilid[81] = "";
static char 		ws_xlspris_sti[81] = "";
/* NYT 140401 PSREQUEST */
static int		ws_requestflag = 0;
static int		ws_psbookstatus = 0;
/* NYT 140409 PSKUNDEOPLSUBMIT */
static char 		ws_pslejeropl[10][81] = {"","","","","","","","","",""};
/* NYT 140411 PSMEDLOPLSUBMIT */
static char 		ws_psmedl1opl[2][81] = {"",""};
/* NYT 140423 ALDERBLOK */
static int		ws_alderblok = 0;
/* NYT 140513 PSSENEREAFLTID */
static int		ws_psextradag = 0;
static long int		ws_maxindtid = 0;
/* NYT 150625 WEBAPI */
static short int	ws_ecwebapiflag = 0;
/* NYT 150703 WEBAPI31JUST1 */
static double		ws_extratotal = 0;
static double		ws_lejetotal = 0;
/* NYT 150706 ECWBOOKSTATUS */
static short int	ws_ecbookstatus = 0;

#define MAXXLSPRODMATCH	20
/* NYT 150216 PSPAASKE */
static int		ws_xlsprodmatchsorting[MAXXLSPRODMATCH] = {
				100,100,100,100,100,100,100,100,100,100,
				100,100,100,100,100,100,100,100,100,100};

static int		ws_xlsprodmatchtabel[MAXXLSPRODMATCH] = {
				0,0,0,0,0,0,0,0,0,0,
				0,0,0,0,0,0,0,0,0,0};
static int		ws_xlsprodmatchindtidtabel[MAXXLSPRODMATCH] = {
				0,0,0,0,0,0,0,0,0,0,
				0,0,0,0,0,0,0,0,0,0};
/* NYT 140724 PSWEEKENDMATCH */
static char		ws_xlsprodmatchtidopl[MAXXLSPRODMATCH][41] = {
				"","","","","","","","","","",
				"","","","","","","","","",""};
static int		ws_xlsprodmatchidx = -1;
/* NYT 150624 ECEXTUDSTYR */
#define MAXUDSTYRXTRA 20
/* niveau,ID,min,max,valgtype(CHECK DROPDOWN DROPDOWNEXTRA RADIO) */
static char		ws_udstyrxtratabel[MAXUDSTYRXTRA][81] = {
			"0;905;0;3;0;DROPDOWN;Barnestol 0-13 kg;0",
			"0;906;0;3;0;DROPDOWN;Barnesæde 9-18 kg;0",
			"0;907;0;3;0;DROPDOWN;Barnesæde 15-30 kg;0",
			"0;908;0;3;0;DROPDOWN;Barnepude 135 cm;0",
			"0;910;0;1;0;CHECKBOX;Vinterdæk;201",
			"0;924;0;1;0;CHECKBOX;GPS;201",
			"0;980;0;10;0;DROPDOWN;Flyttekasse;0",
			"0;983;0;3;0;DROPDOWN;Flyttehund;0",
			"0;996;0;3;0;DROPDOWN;Co-driver;0",
			"0;997;0;3;0;DROPDOWN;Young-driver;0",
			"1;PAI;0;1;0;CHECKBOX;Personforsikring;201",
			"2;KMP;0;0;0;DROPDOWN;Kilometer(ikke muligt);-1",
			"","","","","","","",""};

#define MAXGRPLISTE 100
static char		ws_grpliste[MAXGRPLISTE][21];
static int		ws_maxidxgrpliste = -1;
static char		ws_typegrpliste[MAXGRPLISTE][21];
static int		ws_maxidxtypegrpliste = -1;
/* NYT 150414 ECKUNDEOPL WEBAPI31 */
static char		ws_lejertitle[41] = "";
static char		ws_lejergender[41] = "";
static char 		ws_eclejeropl[10][81] = {"","","","","","","","","",""};
static char 		ws_ecbookingmail[81] = "";
static short int	ws_findmoenster = 0;
static long int		ws_findresnr = 0;
static char 		ws_findmail[81] = "";
static long int		ws_finduddato = 0;
static char 		ws_findeftnavn[81] = "";


#define		UDSOLGTDGPRE	0
#define		UDSOLGTDGPOST	0
#define		UDSOLGTMAX	3

#define		PRODSORTTP	"sort"
#define		DEFKNDGRP	"SY"
#define		CHKRESFUNK	2
#define		CHKRESMINIMUM	ws_statresmin
#define		AFHLUKSLIP	30
#define		UDLDKMAXFRGSPG	60
#define		UDLDKIATA	26
#define		UDLDKIATAFAROER	31
#define		UDLDKIATAGRLAND	32
#define		UDLDKNAVN	"UDL.DK ONLINE"
#define		UDLTXIATA	36
#define		UDLTXNAVN	"TAXFREE ONLINE"
#define		UDLBCIATA	33
#define		UDLBCNAVN	"BOOKCAR ONLINE"

#define		ONEWAYSPCNR	920
#define		DONMBIDRAG	944
#define		ECMBIDRAG	944
#define		DONVDKFLAG	1
#define		DONVDKFRA	20111101
#define		DONVDKTIL	20120331

#define		DONST56ON	0
#define		DONST57ON	0
#define		DONST58ON	1
#define		DONST66ON	1
#define		DONDKONLY	1
#define		DONWANLOGFILTER	1

#define		MAXWANLOGFILTER	10
static char			ws_wanlog[MAXWANLOGFILTER][21] = {
				"",
				"",
				"",
				"",
				"",
				"",
				"",
				"",
				"",
				""
				};

#define		MAXDON2FUNK	40
static char			ws_don2funknavn[MAXDON2FUNK][41] = {
				"Hello",
				"GetCarsList",
				"GetPriceList",
				"GetAvailabilityList",
				"SelectProduct",
				"UpdatePrice",
				"GetLocationList",
				"Login",
				"",
				"",
				"SubmitRental",
				"",
				"",
				"",
				"",
				"GetFrontpageDefaults",
				"",
				"DibsResult",
				"GetInvalidPickupDates",
				"GetInvalidReturnDates",
				"GetOpenHours",
				"PromotionUpdate",
				"ReturnProductDefs",
				"GetOrMailPdf",
				"",
				"",
				"",
				"",
				"",
				"GetCarExtras",
				"PriceUpdate",
				"MakeReservation",
				"",
				"",
				"",
				"",
				"",
				"",
				"",
				""
				};

/* DON2HERTIL DON2ERROR */
#define		DON2SRVFEJL	1000001	/* serverfejl */
#define		DON2SRVOFFL	1000002	/* booking ikke mulig i øjeblikket */
#define		DON2SRVSYS	1000003	/* serversysfejl */
#define		DON2SRVDTTM	1000004	/* datotidfejl */
#define		DON2SRVTMOUT	1000005	/* websessiontimeout */

#define		DON2CARLOC	10001	/* location ikke ok */

#define		DON2PRDLOC	20001	/* location ikke ok */
#define		DON2PRDCAT	20002	/* category ikke ok */

#define		DON2UDSOLGT	30100	/* ingen ledige biler */
#define		DON2XUDSOLGT	30101	/* ingen ledige biler */
#define		DON2PRODUK	30102	/* ingen produkter fundet */
#define		DON2TESTFEJL1	30103	/* udlejning lastbiler ikke muligt */
#define		DON2TPGRPUK	30104	/* type/grp ikke fundet */
#define		DON2ALDERMGL	30105	/* alder ikke valgt */
#define		DON2STP3LOGIN	30106	/* login step3 mangler */
#define		DON2STP4LOGIN	30107	/* login step4 mangler */
#define		DON2MAXVAR29	30108	/* maxvar overskredet */
#define		DON2UDINDDT	30109	/* uddato > inddato */
#define		DON2UDINDTID	30110	/* udtid > indtid */
#define		DON2PRODALDER	30111	/* ingen produkter fundet pga. alder */
#define		DON2PSUC	30112	/* PS under contruction */
#define		DON2LANGST52	30113	/* maxvar st52 overskredet */
#define		DON2LANGST53	30114	/* maxvar st53 overskredet */
#define		DON2LANGST61	30115	/* maxvar st61 overskredet */
#define		DON2PRODUKTID	30116	/* ingen produkter fundet afl.tid */
#define		DON2PSLUKKET	30117	/* PS ud.dato/tid lukket */
#define		DON2BOOKPRBL	30118	/* problemer med booking */
#define		DON2MDKONTKT66	30119	/* månedspriser ikke på web st66 */
#define		DON2MDKONTKT58	30120	/* månedspriser ikke på web st58 */

#define		DON2FUNK4FEJL	40100	/* fejl i funktionskald/systemfejl */

#define		DON2UPGRPUK	50001	/* gruppe ukendt */
#define		DON2STP5LOGIN	50002	/* login step5 mangler */
#define		DON2STP5PRODUK	50003	/* produkt ukendt step5 */
#define		DON2STP5PRISUK	50100	/* produkt prisfejl step5 */

#define		DON2LOGUK	70001	/* kunde ukendt */

#define		DON2ACCALR	80001	/* kunde findes allerede */
#define		DON2ACCNRM	80002	/* kundenr mangler */
#define		DON2ACCMM	80003	/* opdfunk nr fejl */
#define		DON2ACCMGL	80004	/* data mangler */
#define		DON2ACCDAU2	80005	/* dau fundet 2 */
#define		DON2ACCDAU3	80006	/* dau fundet 3 */
#define		DON2ACCDAU4	80007	/* dau fundet 4 */
#define		DON2ACCNRF	80010	/* kundenr-fejl */
#define		DON2ACCDTF	80011	/* datoformat-fejl */
#define		DON2ACCFUK	80012	/* funktion ukendt */
/* NYT 130121 */
#define		DON2ACCMFJL	80013	/* mobilnrfejl */
#define		DON2ACCTFJL	80014	/* tlfnrfejl */
/* NYT 130122 */
#define		DON2ACCFNVN	80015	/* firmanavn forskelligt */
#define		DON2ACCCVR	80016	/* cvr forskelligt */
/* NYT 130416 */
#define		DON2ACCALDER	80017	/* alder ikke ok min 21 */

#define		DON2COMMGL	90001	/* data mangler */
#define		DON2COMUK	90002	/* kunde ukendt */
#define		DON2COMEMGL	90003	/* firmaemail mangler */
#define		DON2COMANSV	90004	/* kontakt ansvarlig */

#define		DON2SUBTID	100001	/* datotid ud/ind fejl */
#define		DON2SUBKNR	100002	/* kundenr mangler */
#define		DON2SUBACC2	100003	/* account status 2 problemer */
#define		DON2SUBACC3	100004	/* account status 3 problemer */
#define		DON2SUBACC4	100005	/* account status 4 problemer */
#define		DON2SUBRES	100006	/* ingen ledige biler */
#define		DON2SUBTID2	100008	/* udtidspunkt ikke ok */
#define		DON2SUBOPR	100009	/* book opret ikke ok */

#define		DON2BLSTYP	110001	/* type mangler */
#define		DON2BLSKNR	110002	/* kundenr mangler */
#define		DON2BLNOM	110003	/* no match */

#define		DON2CNCBNR	120001	/* booknr mangler */
#define		DON2CNCCNC	120002	/* booknr allerede ann. */
#define		DON2CNCKNV	120003	/* booknr allerede konv. */
#define		DON2CNCBUK	120004	/* booknr ukendt */
#define		DON2CNC48T	120005	/* booknr indenfor 48 timer */

#define		DON2EDTBNR	130001	/* booknr mangler */
#define		DON2EDTCNC	130002	/* booknr allerede ann. */
#define		DON2EDTKNV	130003	/* booknr allerede konv. */

#define		DON2FPDLOC	150001	/* Location mangler */

#define		DON2DRVNRM	160001	/* CompanyId mangler */
#define		DON2DRVNOT	160002	/* CompanyId ikke fundet */
#define		DON2DRVIDM	160003	/* DriverId mangler */
#define		DON2DRVIDN	160004	/* DriverId ikke fundet */
#define		DON2DRVFLD1	160005	/* Driver-data-felt-1 mangler */
#define		DON2DRVFLD2	160006	/* Driver-data-felt-2 mangler */
#define		DON2DRVFLD3	160007	/* Driver-data-felt-3 mangler */
#define		DON2DRVFLD4	160008	/* Driver-data-felt-4 mangler */
#define		DON2DRVDTF	160009	/* Driver fejl datoformat */
#define		DON2DRVALR	160010	/* kunde findes allerede */
#define		DON2DRVROPD	160011	/* fejl reference */
#define		DON2DRVALDER	160012	/* Driver alder ikke ok */

#define		DON2DBSERR	170001	/* dibs fejl */

#define		DON2PCKNOT	180000	/* ingen inv. dage */
#define		DON2PCKLOC	180001	/* Location mangler */
#define		DON2PCKAA	180002	/* aa mangler */
#define		DON2PCKMM	180003	/* mm mangler */

#define		DON2RETNOT	190000	/* ingen inv. dage */
#define		DON2RETLOC	190001	/* Location mangler */
#define		DON2RETAA	190002	/* aa mangler */
#define		DON2RETMM	190003	/* mm mangler */
#define		DON2RETPCK	190004	/* pickup dato mangler */

#define		DON2ABNLOC	200001	/* Location mangler */
#define		DON2ABNDAT	200002	/* dato mangler */

#define		DON2PRONOT	210001	/* Promotion ukendt */
#define		DON2PROTOM	210002	/* Promotion mangler */

#define		DON2DEFST	220001	/* station mangler */
#define		DON2DEFGRP	220002	/* grp mangler */
#define		DON2DEFSPC	220003	/* produkt mangler */
#define		DON2DEFUK	220004	/* produkt ukendt */
#define		DON2DEFPF	220005	/* produktprisfejl */

#define		DON2PDFTP	230001	/* type mangler */
#define		DON2PDFNR	230002	/* nr mangler */
#define		DON2PDFUK	230003	/* nr ukendt */

#define		WEBAPI31INP	310001	/* felter mangler */
#define		WEBAPI31REQ	310002	/* request fundet */

#define		WEBAPI32INP	320001	/* felter mangler */
#define		WEBAPI32UK	320002	/* ikke fundet */

#define		WEBAPI33INP	330001	/* felter mangler */
#define		WEBAPI33UK	330002	/* ikke fundet */

#define		WEBAPI34INP	340001	/* felter mangler */
#define		WEBAPI34UK	340002	/* ikke fundet */

#define		WEBAPI35ALR	350001	/* kunde findes allerede */
#define		WEBAPI35NRM	350002	/* kundenr mangler */
#define		WEBAPI35MM	350003	/* opdfunk nr fejl */
#define		WEBAPI35MGL	350004	/* data mangler */
#define		WEBAPI35DAU2	350005	/* dau fundet 2 */
#define		WEBAPI35DAU3	350006	/* dau fundet 3 */
#define		WEBAPI35DAU4	350007	/* dau fundet 4 */
#define		WEBAPI35NRF	350010	/* kundenr-fejl */
#define		WEBAPI35DTF	350011	/* datoformat-fejl */
#define		WEBAPI35FUK	350012	/* funktion ukendt */
#define		WEBAPI35MFJL	350013	/* mobilnrfejl */
#define		WEBAPI35TFJL	350014	/* tlfnrfejl */
#define		WEBAPI35FNVN	350015	/* firmanavn forskelligt */
#define		WEBAPI35CVR	350016	/* cvr forskelligt */
#define		WEBAPI35ALDER	350017	/* alder ikke ok min 21 */
#define		WEBAPI35NDTF	350018	/* fødselsdato mangler */

#define		WEBAPI36UK	360001	/* kunde ukendt */

#define		WEBAPI37UK	370001	/* kunde ukendt */


/* NYT 130920 DOBBELBOOKCHECK */
/* RETTET 150109 DOBBELBOOKCHECKJUST 2 -> 20 */
#define		DOBBELSEKANTAL  20

void trap();
extern int unlink();

#include "40def.h"

/* WEBAPI */
static int send_webapi_stationer(int inpfunk);
static int add_webapi_aabentid(int inpfunk,int inpstation);
static int find_gwkode(int inpfunk,int inpstnr,char *returstr);
static int find_gwgpskoor(int inpfunk,int inpstnr,char *inpgwkode,char *returstr);
static int send_webapi_lande(int inpfunk);
static int send_ecmatch_prodliste(short funk,char *langstr,short station,long kundenr,long fradt,long tildt);
static int retur_ecw_bookstatus(int inpfunk,char *inplandekode,int inpstnr,char *inpgrp,long inpdatoud,long inpvar,char *returstr);
static int send_webapi_biler(int inpfunk);
static int find_acriss_kode(char *inpgrp,char* returstr);
static int add_webapi_biloptionliste(int inpfunk,char *inpgrp);
static int opbyg_grptab(char *inptype);
static int dan_webapi_typegrpliste(int inpfunk,char *inplandekode);
static int dan_ecwebapi_grpliste(int inpfunk,char *inplandekode,char *inptype);
static int check_ecw_udl_undtagelse(int inpfunk,char *inptype,char *inpgrp);
static int check_ecwebapi_reqstgrp(int inpfunk,int inpstnr,char *inpgrp);
static int check_ecwebapi_stgrp(int inpfunk,int inpstnr,char *inpgrp);
static int dan_webapi_grpliste(int inpfunk,char *inplandekode);
static int retur_grp_grpliste(char *inpgrp);
static int findes_grp_liste(char *inpgrp,char *inpgrpliste);
static void sort_form_felt(short funk,char *str,int sz);
static int send_webapi_cartypes(int inpfunk);
static int send_webapi_bilextra(int inpfunk);
static int check_ecw_extraudstyr(int inpfunk,int inpspecnr,char *inpgrp,char *inpid,int inpstation,char *returnavn);
static int check_extfundet(int inpfunk,int inpstnr,char *inpgrp,char *inpliste);
static int opretsend_webapi_resnr(int inpfunk);
static int send_webapi_resliste(int inpfunk);
static int cancel_webapi_resnr(int inpfunk);
static int styr_webapi_kunde(int inpfunk);
static int webapi_check_dau(short keynr,char *nrstr,char *navnstr);
static int webapi_check_kundefindes(int inpfunk,char *inpid1,char *inpid2);
static int styr_webapi_login(int inpfunk);
static int styr_webapi_pw(int inpfunk);
static int send_webapi_bilspecs(int inpfunk);
static int send_webapi_kundevalg(int inpfunk);
static int send_webapi_st_aabenhlg(int inpfunk);
static int udpak_webapi_paratab(int inpfunk,short feltantal,short startindex);
static int retur_ecwebapi_data(int inpfunk,char *inpid,char *returstr);

static int add_webopretlog(char *inpipadr,long int inpnr);
static int check_dobbelcheck();
static int opdat_dobbelcheck();
static long int check_don_wgk(int inpfunk);
static int opdat_don_wgk(int inpfunk,long inpresnr);
static int check_wanlogfilter();
static int log_stopur(int inpfunk);
static void init_reg();
static void close_reg();
/* DON2FUNK */
static int styr_don2_pdf();
static int send_don2_proddefs();
static int send_ps_fp_default();
static int send_don2_fp_default();
static int frankly_err(int inpfunk,char *inptxt,long inpkode);
static void check_firmaloginflag();
static int check_promotion();
static int udpak_testinput();
static int udpak_minimum_para(int inpfunk);
static int udpak_paratab(int inpfunk,short feltantal,short startindex);
static int udpak_extratab(short feltantal);
static int udpak_webapi_extratab(short feltantal);
static int send_don2_lukketdage();
static int dan_pgaaben(int inpfunk,int inpstation,char *returfilsti);
static int send_don2_aabentid();
static int send_don2_drivers();
static int opret_don2_driver();
static int slet_don2_driver();
static int check_lejer_firmaref(long inplejerknr,long inpfirmaknr);
static int opdat_lejer_firmaref(long inplejerknr,long inpfirmaknr);
static int send_don2_booklist();
static int pak_extraptab(int inpfunk);
static int send_don2_editrental();
static int send_psgenprisliste(int inpfunk);
static int add_psprislinier(int inpfunk,short inpstation,char *inptype,char *inpgrp);
static int send_genprisliste(int inpfunk);
static int send_genextprisliste(int inpfunk);
static int don2snyd(char * inppara);
static int send_don2snyd_linie(char *inpstr,int sktgn);

static void konv_f159_f198();
static int find_statresmin(short stnr);
static int check_ressourcer();
static long int find_ledigdato();
static int find_dato_udsolgt();

static void send_dato_tider();
static int check_donmaaned();
static int check_donweboffline(short funk);
static int check_ecweboffline(short funk);
static int ecweb_booktype_liste();
static int ecweb_aftalecheck();
static int ecweb_check_bilgrp(char *grp,char *type);
static int ecweb_check_biltype(short stnr,char *grp,char *type,short uddgnr,short varighed,char * returstr,char *ret2str,char *ret3str);
static void send_hallo();
static int send_stationliste(short funk,short ecflag,char *langstr);
static void send_station_afh_afl(short funktion,char *langstr,short statnr,short donflag);
static void check_stationdata();
static void send_stationdetail();
static void send_stationaaben();
static int send_udind_aabentid(short funk,short donflag);
static int check_bssaaben();
static int dan_aabentid_ny();
static long int dan_aabentid();
static void dan_datotxt();
static void dan_dagtxt();
static void send_stationfelt();
static void rel_firma_email();
static int don2_check_dau(short keynr,char *nrstr,char *navnstr);
static int don2_check_kundefindes(int inpfunk,char *inpid1,char *inpid2);
static int don2_check_firmafindes(int inpfunk,char *inpid1,char *inpid2,char *inpid3);
static int don2_kontrol_fref(int inpfunk,long inpknr,char *checkfelt);
static int don2_firma_kundenr();
static int don2_login();
static int konv_asciiog(char *inpstr);
static void check_kundelogon();
static long int find_evt_bssnr();
static void add_donlogin_log();
static void chksend_vagtmail(short stnr,long sysdt,long systd,long uddt,long udtd);
static void send_station_mail(short stnr);
static int send_password();
static int send_annullering();
static int send_reservation();
static void send_kundeemail();
static void send_kundedata(short funk,char *langstr,long kundenr);
static int don2_account();
static int check_emailfindes(char *emailadr,char *kgrp);
static int check_sy_kkortfindes();
static int check_sy_kundenr(long kundenr);
static int check_ps_kundenr(long kundenr);
static int check_ec_kundenr(long kundenr);
static int check_udldk_kundenr(long kundenr);
static int check_udldk_altiata();
static void send_prisforslag();
static int check_pris_data();
static long int udvdatofunk();
static int check_pris_extramulige();
static int check_tilbud();
static void ecweb_grpliste(short funk,char *langstr,short station,short donflag);
static int ecweb_grpliste2(short funk,char *langstr,short station,short donflag);
static int ecweb_grpliste3(short funk,char *langstr,short station,short donflag);
static int check_grpspcst_findes(char *grp,char *type,short stnr);
static int send_don2grpliste();
static int find_pstypegruppe();
static int dan_psgrptab(int inpfunk,char *langstr,short inpstation);
static int send_psgrpliste(short funk,char *langstr,short station);
static int add_pstypespec(int inpfunk,char *inpgrptype);
static int send_grpliste(short funk,char *langstr,short station);
static int check_webspecnr(short specnr,short st,char * grp);
static void send_paipriser();
static void web_errormess(short funk,char *langstr,char *parastr);
static int error_extra_check(char *langstr,int webkode,char *returstr);
static int check_hlgdg_info(int funk,long fradato,long tildato,char *returstr);
static int ecweb_deleteres(short funk,char * langstr,long resnr);
static int ecweb_checklogin(short funk,char * langstr);
static long int find_reskundenr(short funk,long resnr,char * returtlf);
static void ecweb_checkkunde(short funk,char * langstr,long fdato,short id,char * datafelt);
static void donweb_online(short funk,char * langstr);
static void ecweb_online(short funk,char * langstr);
/* ECUDLBOOK */
static int udldk_udregn_pai(int antdg,double *paiprdag);
static int udldk_checkfrgspg(short funk,char *kat,char *grp,long var,long dato,long tid);
static int retur_udldkvinter();
static int udldk_perfrgspg(short inpstatnr,char *inpgrp,long inpdato,long inptid);
static int find_8198aabentid(short inpstnr,short inpdagnr);
static int udldk_checkkunde(short funk);
static void udldk_opdaterpris(short funk);
static void udldk_extraliste(short funk,char * langstr,short stnr,long knr,long fradt,long tildt,char * grp);
static int ecweb_udldkgrptab(short inpspcnr,long inpudt,long inpvar);
static int check_udldk_st_undt(short inpstatnr,char *inpbilkatgrp);
static int udldk_prisliste(short prisfunk);
static int udldk_checkjul(long uddt,long inddt,short wflag,long var);
static int send_udldk_prod(short idx,long uddato,long udtid,long inddato,long indtid,long varighed,short spcnr,short wflag);


static void ecweb_bsspris(short prisfunk);
int adm_mbidrag(short funk,short specnr,long var,double *returpris);
static void ecweb_prisliste(short prisfunk);
static void dan_kredkort_liste(int ecflag,double total,char *grp,char *returstr);
static int check_perprisjust(short spcnr,short stnr,char *grp,long fradato,long antdg);
static int check_minsalg(short funk,long oplkode,short station,char *grp,long fradato,long tildato);
static int check_ecdon_aflblok(short funk,short station,char *grp,long fradato,long tildato,char *returstr);
static int check_owblok(short funk,short station,char *grp,long fradato,long tildato);
static int check_stopsalg(short funk,short station,char *grp,long fradato,long tildato);
static int check_grpinaktiv(short funk,short station,char *grp,long fradato,long tildato);
static int udregn_depositum(int antdg,double *depositum);
static int find_f198prisjust(short inpspec,char *grp,short st,long dtud,int antdg,double *pris,short *enhed,long *antal,double *cdi,double *pai,double *extkm,long *inclkm);
static int find_f198hlgpris(short spec,char *grp,short st,long dtud,long dtind,char *navn,double *pris,short *enhed,long *antal,double *cdi,double *pai,double *extkm,long *inclkm,short *paiflag);
static int find_f198perpris(short spec,char *grp,short st,long dtud,long dtind,char *navn,double *pris,short *enhed,long *antal,double *cdi,double *pai,double *extkm,long *inclkm,short *paiflag);
static void send_prisliste();
static void send_extraliste(short funk,char * langstr,short stnr,long knr,long fradt,long tildt,char * grp);
static void don_sendorderid();
static void don_extraliste();
static int ecw_opdaterpris(int inpfunk);
static int don2_opdaterpris(int inpfunk);
static int add_divpligtopl(int inpfunk,char *inpgrp);
static int check_requestflag(int inpfunk,long inpvarighed);
static int check_requeststyr(int inpfunk,int inpstnr,char *inptype,char *inpgrp,long inpdatoud);
static int retur_ptabmatch(char *inpidstr);
static int nulstil_psextraprio();
static int add_donextraprio(int inpspcnr);
static int init_extraptab(int inpfunk);
static int find_psxlspris(int inpfunk, char * inpbrand, int inpstation, int inpspecnr, char * inpgrp, int inpvarighed, char * returstr);
static int juster_extraptab(int inpfunk,int inpindex,long inpvarighed);
static int beregn_extraptab(int inpindex,long inpvarighed);
static int send_extraptab(int inpfunk,long inpvarighed);
static int add_xlskmpk(int inpfunk,short inpstation,short inpspec,char * inpgrp,long inpvarighed);
static int add_xlssrn(int inpfunk,short inpstation,short inpspec,char * inpgrp,long inpvarighed);
static int add_xls980(int inpfunk,short inpstation,short inpspec,char * inpgrp,long inpvarighed);
static int send_match_prodliste();
static int send_psmatch_prodliste();
static void opbyg_teasertekst(int inpnuvxlsidx,char *returstr);
static void opbyg_psproduktnavn(int inpgrpidx,char *inpprodkode,char *returstr);
static int dan_ecxlsprodmatchtabel(int inpfunk,long inpvarighed);
static int dan_xlsprodmatchtabel(int inpfunk,long inpvarighed);
static int check_ecxlsmainprodukt_grptab();
static int check_xlsmainprodukt_bilgrp();
static int add_psbetalinginfo(int inpfunk,char *inpprodkode,long prodvar);
static int check_don2_weekendok(short inpspec,long inpfradt,long inptildt,short inpafhfra,short inpdgvar,char *inpdgstr,char *returdtstr);
static int tilbud_paa_vej(short stnr,long fradt,long tildt,long antaldg);
static int check_alfa_str(short funk,char *listestr,char *chkstr,short sktgn);
static int check_stdgstr();
static int find_tillaeg_antal();
static int chksend_prod();
static int retur_pligttekst(char * returstr);
static int sortsend_prod(char *langstr);
static int find_prod_str(short idx,FILE *filptr);
static int send_aabentider();
static void send_book_extrapriser();
static void send_pristyper();
static int  check_timepriser();
static void send_extrapristyper();
static void send_amdtabel();
static int check_don_specblok(short funk,short spcnr,short stnr,char *grp,long fra,long til);
static int  check_f198_dato();
static int  check_f198_datointerval();
static int check_don_tilbud(long varigh,short stnr,short spcnr,char *grp,short enh,long fra,long til,char *returstr);
static int check_f198_per(short funk,short varighed,short stnr,char *grp,long fra,long til,char *returstr);
static int check_f198_hlgtilbud(short funk,char *hlgnavn,long varigh,short stnr,char *grp,long fra,long til,char *returstr);
static int check_f198_hlghit(short funk,long varigh,short stnr,char *grp,long fra,long til,char *hlgnavn);
static int check_f198_hlg(short funk,short spcnr,short stnr,char *grp,long fra,long til);
static int check_f198_hlgblok(short funk,short spcnr,short stnr,char *grp);
static int check_f198_udvhlg(short funk,short spcnr,short stnr,char *grp,long fra,long til,char *returstr);
static int check_f198_spcstgrpblok(short funk,short spcnr,short stnr,char *grp,long fra,long til);
static int check_f198_spcafhtid(short funk,short spcnr,short stnr,char *grp);
static void check_amdspec();
static int weekend_komp(short st,char *grp,short spc,char *extspc);
static int  beregn_varighed();
static int  beregn_timeantal();
static int find_tid_fra_til(short st,char * grp,short spc,char * extspc,long * ftid,long * ttid);
static void send_lastmedl();
static void check_betaling();
static int nyopret_reservation(short funk,short sendflag,short ecflag);
static int check_promoextdage();
static int check_promokode(char *inpid);
static int styr_promokode(short inpextidx);
static int styr_lejermedlopl(int inpfunk);
static int check_bonus(short funk,short inpspecnr,char *inpspctxt,long inpuddato);
static int check_grp_firmaaft_blok(int funk,long fradato,long tildato,char *grp);
static int check_hlg_firmaaft_blok(int funk,long fradato,long tildato);
static int styr_resprint(short inpstud);
static void opdater_udldkresdata();
static int add_extra_f183(long konnr,short type,long lbnr);
static int add_noter_f183(long konnr,short type,long lbnr,char *inpstr,char *infostr);
static void opdat_r183();
static void opdat_f359_alfa(short oplkode,char *inpstr,long konnr);
static void send_billiste();
static void send_biltype();
static int add_tekstdata();
static void opdat_biltypedata();
static void opdat_stationdata();
static void opdat_password();
static void opret_nyhed();
static void opret_nyhedsmodtager();
static void slet_nyhedsmodtager();
static long int check_nyhedsmodtager(long oplkode,short station,char *email);
static int add_prislinie();
static int styr_gaspedal(int inpfunk,short inpst,short inpspc,char *inpgrp,long inpuddt,long inpresdt,long inpvar,double * returpris);
static long int find_f198_niveau();
static int find_f198_nivpriser(long niveau,short st,short spec,double * pris,double * cdi,double * pai,double * km);
static int find_f198_firmaaftale(short st,short spec,char * grp,double * pris,double * cdi,double * pai,double * km,long int * inclkm);
static int check_udvstslip(short stnr,long uddato,long udtid);
static int retur_slipmin(long frad,long frat,long tildgnr,long tilt);
static int retur_minantal(long inptid);
static void slet_reservation();
static int nyslet_reservation();
static int cancel_reservation(long resnr,long kundenr,short slet198);
static void send_f159liste();
static void nysend_f159liste();
static void don_f159liste();
static void opdat_kredit_betaling();
static int checksend_sms(int inptype,long inpresnr,char *inptlfnr);

/* DATA FUNK */
static int f198_tekst();
static int trans_tekst();
static int trans_tekst_lbnr();
static int find_r178();
static void opdat_r178();

/* P8198 TEST */
static void p8198_init();
static void p8198_funk();
static void p8198_opl();
static int find_feltdata();
static int find_opldata();
static void add_funk_linie();
static int dan_r198_match();
static void p8198_opdater();

/* EXTRA FUNKTIONER */
static void dan_password();
static void alfa_password();
static void udregn_cdipai_beloeb();
static void udregn_mbidrag_beloeb(short antal,char *inpgrp,double *doubprdag,double *doubmax);
static int get_alfa_tgn();
static int bit_check();
static int bit_toggle();
static int slet_blanke(unsigned char * inpstr);
static int check_numtgn(unsigned char * inpstr);

static int base64_encode();
static void base64_en_init();
static void base64_decode();
static void base64_de_init();
static int inbuf(void);
static int inchar(void);
static int insig(void);
static void ochar(int c);

/* NYT 150518 UDVRATE TOM */
int hent_spec_nr_data(short inpspecnr,char *grp,short inptype);

/* cbtxtknv.h */
static char *   xls_char();
static char *   scan_xls_char();
static char *   pktkomma_xls_char();
static void rens_datotidstr();
static void stednavn_form();
static int retur_numalfa_data();

/* 40tgnkonv.h */
static void bss_konv_txt(short konv_funk,char *felt);
static void kkortrens(char *inpfelt);

/* 40flaade.h */
static int check_f168kap(short detail,short inpst,long fradato,long tildato,char * fragrp,char * tilgrp,long * blok,long * kon,long * res);
static int dan_pg_f168data(short inpstnr,char *inpfgrp,char *inptgrp);
static int get_pgdata_tgn(char *txt_felt,short nr,char *txt_ptr,char tegn);
static int check_f168leas(short station,char *regnr,long fradato,long tildato,char * fragrp,char * tilgrp);
static int check_f159blokobs(char *regnr,long fradato,long tildato);
static int check_f159leas(char *regnr,long konnr,long fradato,long tildato);
static int check_f197type(short detail,short leasflg,short type,short st,char *regnr,char *grp,long fradato,long tildato,char *buffer);
static int check_f197tid();
static int find_next_fri(short st,long fradt,long ftid,long ttid,short var,char * grp,long * dato,long * tid);
static int check_flaadekap(short inpst,long fradato,long tildato,char * fragrp,char * tilgrp,long * returdato,long * returtid);
static int process_f197type();
static int sort_r197type();

/*40bss198.h */
int check_f198_def(char *liniestr,char *keystr);
int retur_f198_def(long opl,char *liniestr,char *returstr);

/*40lukaaben.h */
static int check_vagtsms(int inpfunk,short inpstat,long uddt,long udtm,char *returtlf,char *returcc);
static int retur_lukaaben_min(short stnr,long uddt,long udtm,int *returlm,int *returaam);
static int check_stationaaben(short udind,short station,long dato,long tid,char *returstr);
static int send_vagtsmsmail(int inpfunk,int inpstat,char *tlf,char *madr,char *ccadr);

/* ******************************************************************** */
void trap() {

	logfil_put("fejlkode=3");
	if ((char*)f198) {
		egeclose(f198);
	}
	if ((char*)f166) {
		egeclose(f166);
	}
	if ((char*)f167) {
		egeclose(f167);
	}
	if ((char*)f178) {
		egeclose(f178);
	}
	if ((char*)f174) {
		egeclose(f174);
	}
	if ((char*)f165) {
		egeclose(f165);
	}
	if ((char*)f159) {
		egeclose(f159);
	}
	if ((char*)f145) {
		egeclose(f145);
	}
	if ( (char*)f168) {
		egeclose(f168);
	}
	if ( (char*)f169) {
		egeclose(f169);
	}
	if ( (char*)f171) {
		egeclose(f171);
	}
	if ( (char*)f172) {
		egeclose(f172);
	}
	if ( (char*)f10) {
		egeclose(f10);
	}
	if ( (char*)f30) {
		egeclose(f30);
	}
	if ( (char*)f03) {
		egeclose(f03);
	}
	if ( (char*)f29) {
		egeclose(f29);
	}
	if ( (char*)f07) {
		egeclose(f07);
	}
	fclose(logfil);
	send_kode(7);
	exit(0);
}

/* ******************************************************************** */
ege_2000()

	listeptr = (FILE*)0;
	(void) signal(SIGALRM, trap);
	alarm(50);
	p7502ls = (P7502LS*) malloc(sizeof(P7502LS));
	reclow(p7502ls, P7502LS);
/* NYT 140218 XLSPRIS */
	xlsprismain = (XLSPRISMAIN*) malloc(sizeof(XLSPRISMAIN));
	reclow(xlsprismain, XLSPRISMAIN);
	xlsprissub = (XLSPRISSUB*) malloc(sizeof(XLSPRISSUB));
	reclow(xlsprissub, XLSPRISSUB);
	xlsprismatch = (XLSPRISMATCH*) malloc(sizeof(XLSPRISMATCH));
	reclow(xlsprismatch, XLSPRISMATCH);
/* NYT 150518 UDVRATE */
	udvrate = (UDVRATE*) malloc(sizeof(UDVRATE));

	m002_1;
	m036_funktion(0,0);
	if (strcmp(ege_optstring[0], "win=1") == 0 ||
		strcmp(ege_optstring[1], "win=1") == 0) {
		ws_winflag = 1;
	}
/* NYT 130121 */
	(void)gethostname(ws_hostnavn,40);
	strcpy(ws_tmppara,egeenv("DBTYPE"));
	if (strcmp(ws_tmppara,"pg")==0) {
		ws_pgflag = 1;
	}
	strcpy(ws_menuid, egeenv("MENUID"));
	if (strcmp(ws_menuid,"zt")==0) {
		ws_testkreds = 1;
		sprintf(logfil_navn,"/tmp/log%5.5hd7912t",ege_pid);
	} else {
		sprintf(logfil_navn,"/tmp/log%5.5hd7912",ege_pid);
	}
	logfil = fopen(logfil_navn,"w");
	if (logfil) {
		log_flag = 1;
	} else {
		logfil = (FILE*)0;
	}
/* NYT 140903 XLSPRISSTI */
	sprintf(ws_xlspris_sti,"%s%s","/export/home/","xlspriser");
	(void)xlspris_retur_sti(ws_testkreds,ws_xlspris_sti);
	strcpy(xlsprismatch->xlsprissti,ws_xlspris_sti);
	xlsprismatch->resdato = m036_funktion(5,0);

	(void)log_stopur(99);
	ws_startsek = (ULI)time(0);
	strcpy(ws_tmppara,egeenv("ENV"));
	if (logfil) {
		fprintf(logfil, "startsek=%lu\n", ws_startsek);
		fprintf(logfil, "\tWEBVER=%s ws_pgflag=%hd\n",
			WEBVER,
			ws_pgflag);
		fprintf(logfil,"\tENV=%s\n",ws_tmppara);
		fprintf(logfil,"\tws_hostnavn=%s\n",ws_hostnavn);
		fprintf(logfil,"\tege_user=%s\n",ege_user);
	}
	sprintf(str,"");
	send_linie();
/* OBS PAUSE 7811<->7912 */
	if (strcmp(ws_hostnavn,"goa-linux")==0) { sleep(1); }
	alfalow(str);
/* ingen checksum */
	ws_funkretur = modtag_linie(0);
	if (logfil) {
		fprintf(logfil,"\tMODTAGLINIE ws_funkretur=%d\n",ws_funkretur);
		fflush(logfil);
	}
	if (ws_funkretur==0) {
		logfil_put("fejlkode=2");
		fclose(logfil);
		goto styr_99;
	}
/* RETTET 150324 WEBAPI
	if (modtag_linie(0) == 0) {
		logfil_put("fejlkode=2");
		fclose(logfil);
		goto styr_99;
	}
*/
/* NYT 131125 GEMOPRKOMMANDO */
	strcpy(ws_kommandostr, str);

	ws_systemdato = ege_date();
	ws_systemtid = ege_time()/10000;
	strcpy(ws_kreds, egeenv("KREDS"));
	ws_feltantal = get_feltantal();
/* TEST */
	if (logfil) {
		fprintf(logfil,
			"\tws_kreds=%s\n",
			ws_kreds);
		fprintf(logfil,
			"\tws_feltantal=%hd,ws_systemdato=%ld,ws_systemtid=%ld\n",
			ws_feltantal,
			ws_systemdato,
			ws_systemtid);
		fprintf(logfil,
			"\tws_testkreds=%hd\n",
			ws_testkreds);
		fflush(logfil);
	}
	nuv = 0;
	get_short(&ws_funktion);
	ws_dponflag = check_dpon(ws_kreds);
	if (str[0]=='0' && strlen(str)<=2) {
		ws_funktion = 0;
	}
/* FUSK 131126 */
	if (str[0]==30 && strlen(str)<=2) {
		ws_funktion = 0;
	}
/* NYT 150625 */
	if (ws_funktion>=24 && ws_funktion<=50) {
		ws_ecwebapiflag = 1;
	}
startfunk:
	if (logfil && ws_funktion>=0 && ws_funktion<=MAXDON2FUNK) {
		fprintf(logfil,
			"\t%s\n",ws_don2funknavn[ws_funktion]);
	}
	if (logfil) {
		fprintf(logfil,
		"\tws_funktion=%hd,ws_dponflag=%hd,ws_ecwebapiflag=%hd\n",
			ws_funktion,
			ws_dponflag,
			ws_ecwebapiflag);
		fprintf(logfil,
			"\tws_inputfunktion=%hd\n",
			ws_inputfunktion);
		fprintf(logfil, "\tstr=<%s>\n", str);
		fprintf(logfil, "\tws_kommandostr=<%s>\n", ws_kommandostr);
		fflush(logfil);
	}
	switch(ws_funktion) {
//	case 3 :
//	case 4 :
//	case 5 :
//	case 6 :
//	case 7 :
//	case 8 :
//	case 9 :
//	case 10 :
//	case 11 :
//	case 12 :
//	case 13 :
	case 14 :
//	case 15 :
//	case 16 :
//	case 17 :
//	case 18 :
//	case 19 :
//	case 20 :
		ws_snydflag = 1;
		break;
	default :
		break;
	}
	if (logfil) {
		fprintf(logfil,
			"\tws_snydflag=%hd\n", ws_snydflag);
		fflush(logfil);
	}
	if (ws_snydflag>0 && ws_inputfunktion>0 && ws_testudpak<=0) {
		ws_station = 66;
		strcpy(ws_grp,"3");
	}
	switch(ws_funktion) {
	case 0 :
/* HALLO */
		send_hallo();
		break;
	case 1 :
/* GetCarsList */
/* GLFUNK211 */
/* DON2FUNK1 GRPLISTE */
/* INPUT GP+station */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_short(&ws_station);
		}
		if ((ws_brandtype==3||ws_brandtype==4) &&
			check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
		ws_funkretur = 1;
		if (ws_funkretur==1 && ws_station==0) {
			ws_inputstation = 0;
		}
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK1 ws_station=%hd\n",
                                ws_station);
		}
		ws_funkretur3 = 0;
		if (ws_funkretur>0 && ws_brandtype==3 && ws_station==66) {
			ws_funkretur3++;
		}
		if (ws_funkretur>0 && ws_brandtype==3 && ws_station==56) {
			ws_funkretur3++;
		}
		if (ws_funkretur>0 && ws_brandtype==3 && ws_station==57) {
			ws_funkretur3++;
		}
		if (ws_funkretur>0 && ws_brandtype==3 && ws_station==58) {
			ws_funkretur3++;
		}
		if (ws_funkretur>0 && ws_brandtype==3 && ws_station>0 &&
			ws_funkretur3<=0) {
			ws_don2errno = DON2CARLOC;
		}
		if (ws_funkretur>0 && ws_brandtype==4 && ws_station==52) {
			ws_funkretur3++;
		}
		if (ws_funkretur>0 && ws_brandtype==4 && ws_station==53) {
			ws_funkretur3++;
		}
		if (ws_funkretur>0 && ws_brandtype==4 && ws_station==61) {
			ws_funkretur3++;
		}
		if (ws_funkretur>0 && ws_brandtype==4 && ws_station>0 &&
			ws_funkretur3<=0) {
			ws_don2errno = DON2CARLOC;
		}
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK1 ws_funkretur3=%d\n",
                                ws_funkretur3);
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		if (ws_funkretur>0 && ws_brandtype==3 && ws_station>0) {
			ws_funkretur2 = send_grpliste(3,ws_langstr,ws_station);
		}
/* NYT 131128 PSCAR */
		if (ws_funkretur>0 && ws_brandtype==4 && ws_station>0) {
			ws_funkretur2=send_psgrpliste(3,ws_langstr,ws_station);
		}
		if (ws_funkretur>0 && ws_brandtype==4 && ws_station==0) {
			ws_funkretur2=send_psgrpliste(3,ws_langstr,52);
			ws_funkretur2+=send_psgrpliste(3,ws_langstr,53);
			ws_funkretur2+=send_psgrpliste(3,ws_langstr,61);
		}
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK1 ws_funkretur2=%d\n",
                                ws_funkretur2);
		}
		if (ws_funkretur>0 && ws_brandtype==3 &&
			ws_inputstation==0 && DONST66ON) {
			ws_station = 66;
			ws_funkretur2 = send_don2grpliste();
		}
		if (ws_funkretur>0 && ws_brandtype==3 &&
			ws_inputstation==0 && DONST58ON) {
			ws_station = 58;
			ws_funkretur2 += send_don2grpliste();
		}
		if (ws_funkretur>0 && ws_brandtype==3 &&
			ws_inputstation==0 && DONST57ON) {
			ws_station = 57;
			ws_funkretur2 += send_don2grpliste();
		}
		if (ws_funkretur>0 && ws_brandtype==3 &&
			ws_inputstation==0 && DONST56ON) {
			ws_station = 56;
			ws_funkretur2 += send_don2grpliste();
		}
		if (ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;

	case 2 :
/* GetPriceList */
/* NYT 120704 GENPRISLISTE */
/* DON2FUNK2 PRISLISTE */
/* INPUT GP+station+grp+evtextra */
		alarm(40);
/* RETTET 1411117
		alarm(20);
*/
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_short(&ws_station);
			get_alfa(ws_grp);
			ege_toupper((unsigned char *)ws_grp);
			get_alfa(ws_evtextra);
			ege_toupper((unsigned char *)ws_evtextra);
		}
/* NYT 131129 PSPRISER */
		if (strcmp(ws_grp,"0")==0) {
			strcpy(ws_grp,"");
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
		if (ws_funkretur>0 &&
			ws_station==0) {
			ws_inputstation = 0;
		}
		ws_funkretur3 = 0;
		if (ws_funkretur>0 && ws_brandtype==3 && ws_station==66) {
			ws_funkretur3++;
		}
		if (ws_funkretur>0 && ws_brandtype==3 && ws_station==56) {
			ws_funkretur3++;
		}
		if (ws_funkretur>0 && ws_brandtype==3 && ws_station==57) {
			ws_funkretur3++;
		}
		if (ws_funkretur>0 && ws_brandtype==3 && ws_station==58) {
			ws_funkretur3++;
		}
		if (ws_funkretur>0 && ws_brandtype==3 && ws_station>0 &&
			ws_funkretur3<=0) {
			ws_don2errno = DON2PRDLOC;
		}
/* NYT 131129 PSPRISER */
		if (ws_funkretur>0 && ws_brandtype==4 && ws_station==52) {
			ws_funkretur3++;
		}
		if (ws_funkretur>0 && ws_brandtype==4 && ws_station==53) {
			ws_funkretur3++;
		}
		if (ws_funkretur>0 && ws_brandtype==4 && ws_station==61) {
			ws_funkretur3++;
		}
		if (ws_funkretur>0 && ws_brandtype==4 && ws_station>0 &&
			ws_funkretur3<=0) {
			ws_don2errno = DON2PRDLOC;
		}
		if (ws_funkretur>0 && ws_brandtype==4 && ws_station==0) {
			ws_don2errno = DON2PRDLOC;
		}
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK2 ws_funkretur3=%d\n",
                                ws_funkretur3);
			fprintf(logfil,
				"main:DON2FUNK2 ws_biltype=%s\n",
                                ws_biltype);
			fprintf(logfil,
				"main:DON2FUNK2 ws_grp=%s\n",
                                ws_grp);
			fprintf(logfil,
				"main:DON2FUNK2 ws_evtextra=%s\n",
                                ws_evtextra);
			fprintf(logfil,
				"main:DON2FUNK2 ws_station=%hd\n",
                                ws_station);
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		ws_funkretur3 = 0;
		if (ws_funkretur>0 && ws_brandtype==3 &&
			strcmp(ws_grp,"A")==0) {
			ws_funkretur3++;
		}
		if (ws_funkretur>0 && ws_brandtype==3 &&
			strcmp(ws_grp,"3")==0) {
			ws_funkretur3++;
		}
/* check for 0  returner begge prislister check for prisaftaler */
		if (ws_funkretur>0 && ws_brandtype==3 &&
			!strlen(ws_grp)) {
			ws_funkretur3 = -1;
		}
		if (ws_funkretur>0 && ws_brandtype==3 && strlen(ws_grp) &&
			ws_funkretur3==0) {
			ws_don2errno = DON2PRDCAT;
		}
/* NYT 131129 PSPRISER */
		if (ws_funkretur>0 && ws_brandtype==4 &&
			strlen(ws_evtextra) && strcmp(ws_evtextra,"EXTRA")==0) {
			close_reg();
			break;
		}
		if (ws_funkretur>0 && ws_brandtype==4&&!strlen(ws_grp)) {
			ws_funkretur3 = -1;
		}
		if (ws_funkretur>0 && ws_brandtype==4&&strcmp(ws_grp,"*")==0) {
			strcpy(ws_grp,"");
			ws_funkretur3 = -1;
		}
		if (ws_funkretur>0 && ws_brandtype==4 && strlen(ws_grp)) {
			ws_funkretur3 = find_pstypegruppe();
		}
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK2 ws_grp=%s\n",
                                ws_grp);
			fprintf(logfil,
				"main:DON2FUNK2 ws_biltype=%s\n",
                                ws_biltype);
			fprintf(logfil,
				"main:DON2FUNK2 ws_funkretur3=%d\n",
                                ws_funkretur3);
		}
		if (ws_funkretur>0 && ws_brandtype==4 && ws_funkretur3==0 &&
			!strlen(ws_biltype) && !strlen(ws_grp)) {
			ws_don2errno = DON2PRDCAT;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		if (ws_funkretur>0 && ws_brandtype==4 && ws_station>0) {
			ws_sendretur = send_psgenprisliste(3);
		}

		if (ws_funkretur>0 && ws_brandtype==3 && ws_station>0 &&
			!strlen(ws_evtextra) && strlen(ws_grp)) {
			ws_sendretur = send_genprisliste(3);
		}
		if (ws_funkretur>0 && ws_brandtype==3 && ws_station>0 &&
			!strlen(ws_evtextra) && !strlen(ws_grp)) {
			strcpy(ws_grp,"A");
			ws_sendretur = send_genprisliste(3);
			strcpy(ws_grp,"3");
			ws_sendretur += send_genprisliste(3);
		}
		if (ws_funkretur>0 && ws_brandtype==3 && ws_station>0 &&
			strlen(ws_evtextra)) {
			ws_sendretur = send_genextprisliste(3);
		}
/* NYT 120817 */
		if (ws_funkretur>0 && ws_brandtype==3 &&
			ws_inputstation==0 && DONST66ON &&
			!strlen(ws_evtextra) && strlen(ws_grp)) {
			ws_station = 66;
			ws_sendretur += send_genprisliste(3);
		}
		if (ws_funkretur>0 && ws_brandtype==3 &&
			ws_inputstation==0 && DONST58ON &&
			!strlen(ws_evtextra) && strlen(ws_grp)) {
			ws_station = 58;
			ws_sendretur += send_genprisliste(3);
		}
		if (ws_funkretur>0 && ws_brandtype==3 &&
			ws_inputstation==0 && DONST57ON &&
			!strlen(ws_evtextra) && strlen(ws_grp)) {
			ws_station = 57;
			ws_sendretur += send_genprisliste(3);
		}
		if (ws_funkretur>0 && ws_brandtype==3 &&
			ws_inputstation==0 && DONST56ON &&
			!strlen(ws_evtextra) && strlen(ws_grp)) {
			ws_station = 56;
			ws_sendretur += send_genprisliste(3);
		}
/* NYT 120928 */
		if (ws_funkretur>0 && ws_brandtype==3 &&
			ws_inputstation==0 && DONST66ON &&
			!strlen(ws_evtextra) && !strlen(ws_grp)) {
			ws_station = 66;
			strcpy(ws_grp,"A");
			ws_sendretur += send_genprisliste(3);
			ws_station = 66;
			strcpy(ws_grp,"3");
			ws_sendretur += send_genprisliste(3);
			strcpy(ws_grp,"");
		}
		if (ws_funkretur>0 && ws_brandtype==3 &&
			ws_inputstation==0 && DONST58ON &&
			!strlen(ws_evtextra) && !strlen(ws_grp)) {
			ws_station = 58;
			strcpy(ws_grp,"A");
			ws_sendretur += send_genprisliste(3);
			ws_station = 58;
			strcpy(ws_grp,"3");
			ws_sendretur += send_genprisliste(3);
			strcpy(ws_grp,"");
		}
		if (ws_funkretur>0 && ws_brandtype==3 &&
			ws_inputstation==0 && DONST57ON &&
			!strlen(ws_evtextra) && !strlen(ws_grp)) {
			ws_station = 57;
			strcpy(ws_grp,"A");
			ws_sendretur += send_genprisliste(3);
			ws_station = 57;
			strcpy(ws_grp,"3");
			ws_sendretur += send_genprisliste(3);
			strcpy(ws_grp,"");
		}
		if (ws_funkretur>0 && ws_brandtype==3 &&
			ws_inputstation==0 && DONST56ON &&
			!strlen(ws_evtextra) && !strlen(ws_grp)) {
			ws_station = 56;
			strcpy(ws_grp,"A");
			ws_sendretur += send_genprisliste(3);
			ws_station = 56;
			strcpy(ws_grp,"3");
			ws_sendretur += send_genprisliste(3);
			strcpy(ws_grp,"");
		}

		if (ws_funkretur>0 && ws_brandtype==3 &&
			ws_inputstation==0 && DONST66ON &&
			strlen(ws_evtextra)) {
			ws_station = 66;
			ws_sendretur += send_genextprisliste(3);
		}
		if (ws_funkretur>0 && ws_brandtype==3 &&
			ws_inputstation==0 && DONST58ON &&
			strlen(ws_evtextra)) {
			ws_station = 58;
			ws_sendretur += send_genextprisliste(3);
		}
		if (ws_funkretur>0 && ws_brandtype==3 &&
			ws_inputstation==0 && DONST57ON &&
			strlen(ws_evtextra)) {
			ws_station = 57;
			ws_sendretur += send_genextprisliste(3);
		}
		if (ws_funkretur>0 && ws_brandtype==3 &&
			ws_inputstation==0 && DONST56ON &&
			strlen(ws_evtextra)) {
			ws_station = 56;
			ws_sendretur += send_genextprisliste(3);
		}
		if (ws_sendretur<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;
	case 3 :
/* GetAvailabilityList */
/* GLFUNK 310 */
/* INPUT GP+station+inpstation+grp+afh.dato+afl.dato+afh.tid+afl.tid */
		alarm(30);
/* RETTET 150108 DONSYSTEMFEJL
		alarm(20);
*/
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_short(&ws_station);
/* NYT 120910 ProductId Input */
			get_alfa(ws_donspcstr);
			get_alfa_tgn(ws_donspcstr,0,ws_tmppara,';');
			if (strlen(ws_tmppara)) {
				sscanf(ws_tmppara,"%hd",&ws_inputspecnr);
			}
			get_alfa_tgn(ws_donspcstr,1,ws_extspcstr,';');

			get_short(&ws_tilstation);

			get_alfa(ws_grp);
			ege_toupper((unsigned char *)ws_grp);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
/*			sscanf(ws_tmppara,"%ld",&ws_fradato); */
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_fradato = m036_funktion(18, ege_w_int1);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
/*			sscanf(ws_tmppara,"%ld",&ws_tildato); */
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_tildato = m036_funktion(18, ege_w_int1);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_fratid);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_tiltid);
		}
/* NYT 131204 PSALDER */
		if (ws_inputfunktion<=0 && ws_brandtype==4 &&
			ws_feltantal>=19) {
			get_alfa(ws_alderstr);
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
/* NYT 140505 UNDERCONTRUCTION */
		sprintf(ws_tmppara,"psucok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==4) {
			ws_don2errno = DON2PSUC;
		}
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK3 ws_fradato=%ld\n",
                                ws_fradato);
			fprintf(logfil,
				"main:DON2FUNK3 ws_fratid=%ld\n",
                                ws_fratid);
			fprintf(logfil,
				"main:DON2FUNK3 ws_tildato=%ld\n",
                                ws_tildato);
			fprintf(logfil,
				"main:DON2FUNK3 ws_tiltid=%ld\n",
                                ws_tiltid);
			fprintf(logfil,
				"main:DON2FUNK3 ws_grp=%s\n",
                                ws_grp);
			fprintf(logfil,
				"main:DON2FUNK3 ws_station=%hd\n",
                                ws_station);
			fprintf(logfil,
				"main:DON2FUNK3 ws_alderstr=%s\n",
                                ws_alderstr);
		}
		if (ws_fradato==-1 && ws_fratid==0 &&
			ws_tildato==-1 && ws_tiltid==0) {
			ws_don2errno = DON2SRVTMOUT;
		}
/* NYT 140130 STEP3LOGIN */
		sprintf(ws_tmppara,"don2loginstep3ok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==3 &&
			ws_kundenr<=0) {
			ws_don2errno = DON2STP3LOGIN;
		}
/* NYT 141015 DONSTEP3BOOKPRBL */
		sprintf(ws_tmppara,"donstep3.blok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==3) {
			ws_don2errno = DON2BOOKPRBL;
		}

/* TEST 131206 TESTFEJL */
		if (ws_station>0 && ws_brandtype==4 &&
			strlen(ws_grp) && strcmp(ws_grp,"LST")==0) {
			ws_don2errno = DON2TESTFEJL1;
		}
		if (ws_station>0 && ws_brandtype==4 &&
			strlen(ws_alderstr) && strcmp(ws_alderstr,"-1")==0) {
			ws_don2errno = DON2ALDERMGL;
		}
		if (ws_station>0 && ws_brandtype==4 &&
			!strlen(ws_alderstr)) {
			ws_don2errno = DON2ALDERMGL;
		}
/* NYT 140327 UDINDDATOCHECK */
		if (ws_brandtype==4 &&
			ws_fradato>ws_tildato) {
			ws_don2errno = DON2UDINDDT;
		}
		if (ws_brandtype==4 &&
			ws_fradato==ws_tildato &&
			ws_fratid>ws_tiltid) {
			ws_don2errno = DON2UDINDTID;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}

		init_reg();
		ws_kundedtfra = ws_fradato;
		ws_kundetdfra = ws_fratid;
		ws_kundedttil = ws_tildato;
		ws_kundetdtil = ws_tiltid;

                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK3 ws_kreds=%s\n",
				ws_kreds);
		}
		ws_funkretur = find_pc_id();
		if (ws_funkretur<=0) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-8);
			web_errormess(0,ws_langstr,"8");
			pack_exchkend();
			send_linie();
			if (logfil) {
				fprintf(logfil, "SENDT:str=%s", str);
				fflush(logfil);
			}
			ws_funkretur = -1;
/* NYT 131205 */
			close_reg();
			break;
		}
		if (ws_funkretur>0 &&
			ws_fradato==ws_tildato &&
			ws_fratid==ws_tiltid) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-50);
			web_errormess(0,ws_langstr,"50");
			pack_exchkend();
			send_linie();
			if (logfil) {
				fprintf(logfil, "SENDT:str=%s", str);
				fflush(logfil);
			}
			ws_funkretur = -2;
		}
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK3 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			ws_brandtype==3) {
			(void)find_statresmin(ws_station);
			ws_funkretur2 = send_match_prodliste(1,
				ws_langstr,
				ws_station,
				ws_kundenr,
				ws_grp,
				ws_fradato,
				ws_tildato);
		}

/* NYT 131203 */
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			ws_brandtype==4) {
			(void)find_statresmin(ws_station);
			ws_funkretur2 = send_psmatch_prodliste(1,
				ws_langstr,
				ws_station,
				ws_kundenr,
				ws_fradato,
				ws_tildato);
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			ws_brandtype==4 &&
			ws_funkretur2==0 &&
			ws_don2errno>0) {
			close_reg();
			break;
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station==0 &&
			ws_brandtype==3 &&
			DONST66ON) {
			ws_inputstation = 0;
			ws_station = 66;
			ws_tilstation = ws_station;
			(void)find_statresmin(ws_station);
			ws_funkretur2 = send_match_prodliste(1,
				ws_langstr,
				ws_station,
				ws_kundenr,
				ws_grp,
				ws_fradato,
				ws_tildato);
			ws_station = 0;
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station==0 &&
			ws_brandtype==3 &&
			DONST58ON) {
			ws_inputstation = 0;
			ws_station = 58;
			ws_tilstation = ws_station;
			(void)find_statresmin(ws_station);
			ws_funkretur2 += send_match_prodliste(1,
				ws_langstr,
				ws_station,
				ws_kundenr,
				ws_grp,
				ws_fradato,
				ws_tildato);
			ws_station = 0;
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station==0 &&
			ws_brandtype==3 &&
			DONST57ON) {
			ws_inputstation = 0;
			ws_station = 57;
			ws_tilstation = ws_station;
			(void)find_statresmin(ws_station);
			ws_funkretur2 += send_match_prodliste(1,
				ws_langstr,
				ws_station,
				ws_kundenr,
				ws_grp,
				ws_fradato,
				ws_tildato);
			ws_station = 0;
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station==0 &&
			ws_brandtype==3 &&
			DONST56ON) {
			ws_inputstation = 0;
			ws_station = 56;
			ws_tilstation = ws_station;
			(void)find_statresmin(ws_station);
			ws_funkretur2 += send_match_prodliste(1,
				ws_langstr,
				ws_station,
				ws_kundenr,
				ws_grp,
				ws_fradato,
				ws_tildato);
			ws_station = 0;
		}
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK3 ws_funkretur2=%d\n",
                                ws_funkretur2);
		}
/* NYT 150108 MAANEDKONTAKT */
		if (ws_sendretur<=0 && ws_funkretur2<=0 && ws_brandtype==3 &&
			ws_station==66 &&
			check_donmaaned()>0) {
			if (logfil) {
				fprintf(logfil,
					"main:DON2FUNK3 MAANEDKONTAKT\n");
			}
			frankly_err(ws_funktion,"fejl",(long int)119);
			close_reg();
			break;
		}
/* NYT 150109 MAANEDKONTAKT */
		if (ws_sendretur<=0 && ws_funkretur2<=0 && ws_brandtype==3 &&
			ws_station==58 &&
			check_donmaaned()>0) {
			if (logfil) {
				fprintf(logfil,
					"main:DON2FUNK3 MAANEDKONTAKT\n");
			}
			frankly_err(ws_funktion,"fejl",(long int)120);
			close_reg();
			break;
		}

/* NYT 130508 UDSOLGT */
		if (ws_sendretur<=0 && ws_funkretur2<=0 && ws_brandtype==3) {
			ws_udsolgtdage = find_dato_udsolgt();
		}
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK3 ws_udsolgtstr=<%s> %d\n",
                                ws_udsolgtstr,
				ws_udsolgtdage);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0 && ws_udsolgtdage>0) {
			reclow(r198,R198);
			f198_start(1,ISGTEQ);
			r198->oplkode = 16604;
			r198->keynum = (double)ws_station;
			egeread(f198,ISEQUAL);
			if (f198_ok && strlen(r198->alfafelt)) {
				strcpy(ws_emailadr,r198->alfafelt);
			}
			ws_biltp = 0;
			strcpy(ws_bilnavn,"personbiler");
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0 && ws_udsolgtdage>0 &&
			ws_grp[0]=='3') {
			ws_biltp = 1;
			strcpy(ws_bilnavn,"varevogne");
		}
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK3 ws_udsolgtstr=<%s> %d\n",
                                ws_udsolgtstr,
				ws_udsolgtdage);
			fprintf(logfil,
				"main:DON2FUNK3 ws_biltp=%hd\n",ws_biltp);
			fprintf(logfil,
				"main:DON2FUNK3 ws_emailadr=%s\n",ws_emailadr);
		}

		if (ws_sendretur<=0 && ws_funkretur2<=0 &&
			ws_udsolgtdage==1 &&
			strlen(ws_udsolgtstr)) {
			alfalow(str);
			pack_init(str);
			pack_alfa("ERR");
			pack_int2((long)30101);
			sprintf(ws_tmpstr,
		"%sVi har desværre ingen ledige %s d.%s.<BR>Forespørg via <a href='mailto:%s'>%s</a> eller prøv en anden periode.%s",
			ws_udsolgtdivst,
			ws_bilnavn,
			ws_udsolgtstr,
			ws_emailadr,
			ws_emailadr,
			ws_udsolgtdivsl);

			pack_alfa(ws_tmpstr);
			pack_exchkend();
			send_linie();
			if (logfil) {
				fprintf(logfil, "SENDT:str=%s", str);
				fflush(logfil);
			}
			ws_sendretur = 10;
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0 &&
			ws_udsolgtdage>1 &&
			ws_udsolgtdage<=UDSOLGTMAX &&
			strlen(ws_udsolgtstr)) {
			alfalow(str);
			pack_init(str);
			pack_alfa("ERR");
			pack_int2((long)30101);
			sprintf(ws_tmpstr,
		"%sVi har desværre ingen ledige %s d.%s.<BR>Forespørg via <a href='mailto:%s'>%s</a> eller prøv en anden periode.%s",
			ws_udsolgtdivst,
			ws_bilnavn,
			ws_udsolgtstr,
			ws_emailadr,
			ws_emailadr,
			ws_udsolgtdivsl);
			pack_alfa(ws_tmpstr);
			pack_exchkend();
			send_linie();
			if (logfil) {
				fprintf(logfil, "SENDT:str=%s", str);
				fflush(logfil);
			}
			ws_sendretur = 10;
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0 &&
			ws_udsolgtdage>UDSOLGTMAX &&
			strlen(ws_udsolgtstr)) {
			alfalow(str);
			pack_init(str);
			pack_alfa("ERR");
			pack_int2((long)30101);
			sprintf(ws_tmpstr,
		"%sDesværre ingen ledige %s i over 3 dage i din valgte periode.<BR>Forespørg via <a href='mailto:%s'>%s</a><BR>eller prøv en anden periode.%s",
			ws_udsolgtdivst,
			ws_bilnavn,
			ws_emailadr,
			ws_emailadr,
			ws_udsolgtdivsl);
			pack_alfa(ws_tmpstr);
			pack_exchkend();
			send_linie();
			if (logfil) {
				fprintf(logfil, "SENDT:str=%s", str);
				fflush(logfil);
			}
			ws_sendretur = 10;
		}


		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK3 ws_sendretur=%d\n",
                                ws_sendretur);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0 && ws_brandtype==3) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
/* NYT 140423 ALDERBLOK */
		ege_w_int1 = 102;
		if (ws_sendretur<=0 && ws_funkretur2<=0 && ws_brandtype==4 &&
			ws_alderblok>0) {
			ege_w_int1 = 111;
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0 && ws_brandtype==4) {
			frankly_err(ws_funktion,"fejl",(long int)ege_w_int1);
		}
		close_reg();
		break;

	case 4 :
/* SelectProduct */
/* GLFUNK 315 */
/* INPUT GP+station+aflstation+afh.dato+afl.dato+afh.tid+afl.tid+grp+prodID */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_short(&ws_station);
			get_short(&ws_tilstation);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
/*			sscanf(ws_tmppara,"%ld",&ws_fradato); */
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_fradato = m036_funktion(18, ege_w_int1);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_fratid);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
/*			sscanf(ws_tmppara,"%ld",&ws_tildato); */
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_tildato = m036_funktion(18, ege_w_int1);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_tiltid);

			get_alfa(ws_grp);
			ege_toupper((unsigned char*)ws_grp);

			get_alfa(ws_donspcstr);
			get_alfa_tgn(ws_donspcstr,0,ws_tmppara,';');
			if (strlen(ws_tmppara)) {
				sscanf(ws_tmppara,"%hd",&ws_specnr);
			}
			get_alfa_tgn(ws_donspcstr,1,ws_extspcstr,';');
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
/* NYT 140130 STEP4LOGIN */
/*
		sprintf(ws_tmppara,"don2loginstep4ok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==3 &&
			ws_kundenr<=0) {
			ws_don2errno = DON2STP4LOGIN;
			break;
		}
*/
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
		ws_kundedtfra = ws_fradato;
		ws_kundetdfra = ws_fratid;
		ws_kundedttil = ws_tildato;
		ws_kundetdtil = ws_tiltid;

                ws_funkretur2 = 0;
		ws_funkretur = find_pc_id();
		if (ws_funkretur<=0) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-8);
			web_errormess(0,ws_langstr,"8");
			pack_exchkend();
			send_linie();
			if (logfil) {
				fprintf(logfil, "SENDT:str=%s", str);
				fflush(logfil);
			}
			ws_funkretur = -1;
		}
		if (ws_funkretur>0 &&
			ws_fradato==ws_tildato &&
			ws_fratid==ws_tiltid) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-50);
			web_errormess(0,ws_langstr,"50");
			pack_exchkend();
			send_linie();
			if (logfil) {
				fprintf(logfil, "SENDT:str=%s", str);
				fflush(logfil);
			}
			ws_funkretur = -2;
		}
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK4 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0) {
/* NYT 121122 */
			check_firmaloginflag();
			(void)init_extraptab(1);
			ws_funkretur2 = send_extraptab(1,0);
		}
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK4 ws_funkretur2=%d\n",
                                ws_funkretur2);
		}
		if (ws_funkretur>0 && ws_station>0 &&
			ws_snydflag>0 && strcmp(ws_grp,"A")==0) {
			ws_sendretur = don2snyd("4");
		}
		if (ws_funkretur>0 && ws_station>0 &&
			ws_snydflag>0 && strcmp(ws_grp,"3")==0) {
			ws_sendretur = don2snyd("4");
		}
/* SYSTEMFEJL 40100 */
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;

	case 5 :
/* UpdatePrice */
/* GLFUNK 342 */
/* INPUT GP+station+aflstation+afh.dato+afh.tid+afl.dato+afl.tid+grp+prodID+ExtraINDEX */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_short(&ws_station);
			get_short(&ws_tilstation);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
/*			sscanf(ws_tmppara,"%ld",&ws_fradato); */
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_fradato = m036_funktion(18, ege_w_int1);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_fratid);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
/*			sscanf(ws_tmppara,"%ld",&ws_tildato); */
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_tildato = m036_funktion(18, ege_w_int1);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_tiltid);

			get_alfa(ws_grp);

			get_alfa(ws_donspcstr);
			get_alfa_tgn(ws_donspcstr,0,ws_tmppara,';');
			if (strlen(ws_tmppara)) {
				sscanf(ws_tmppara,"%hd",&ws_specnr);
			}
			get_alfa_tgn(ws_donspcstr,1,ws_extspcstr,';');

			ws_parameterantal = ws_feltantal;
			ws_parameterantal -= 1; /* FUNKNR */
			ws_parameterantal -= ws_minimumparaantal; /* GP */
			ws_parameterantal -= 8; /* FUNK5PARA */
			(void)udpak_extratab(ws_parameterantal);
		}



		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
/* NYT 140130 STEP5LOGIN */
		sprintf(ws_tmppara,"don2loginstep5ok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==3 &&
			ws_kundenr<=0) {
			ws_don2errno = DON2STP5LOGIN;
			break;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
		ws_kundedtfra = ws_fradato;
		ws_kundetdfra = ws_fratid;
		ws_kundedttil = ws_tildato;
		ws_kundetdtil = ws_tiltid;

                ws_funkretur2 = 0;
		ws_funkretur = find_pc_id();
		if (ws_funkretur<=0) {
			ws_don2errno = DON2SRVSYS;
			ws_funkretur = -1;
		}
		if (ws_funkretur>0 &&
			ws_fradato==ws_tildato &&
			ws_fratid==ws_tiltid) {
			ws_don2errno = DON2SRVDTTM;
			ws_funkretur = -2;
		}
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK5 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
			fprintf(logfil,
				"main:DON2FUNK5 ws_don2errno=%ld\n",
				ws_don2errno);
			fprintf(logfil,
				"main:DON2FUNK5 ws_fradato=%ld\n",
				ws_fradato);
			fprintf(logfil,
				"main:DON2FUNK5 ws_tildato=%ld\n",
				ws_tildato);
			fprintf(logfil,
				"main:DON2FUNK5 ws_grp=%s\n",
				ws_grp);
			fprintf(logfil,
				"main:DON2FUNK5 ws_biltype=%s\n",
				ws_biltype);
		}
		if (ws_funkretur<0 && ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			close_reg();
			break;
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			ws_brandtype==3) {
/* NYT 140307 CO996FIRMANUL */
			check_firmaloginflag();
			(void)init_extraptab(1);
			ws_funkretur2 = don2_opdaterpris(0);
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			ws_brandtype==4) {
			(void)init_extraptab(1);
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			ws_brandtype==4 && ws_don2errno>0) {
			frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			close_reg();
			break;
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			ws_brandtype==4) {
			ws_funkretur2 = don2_opdaterpris(0);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			ws_don2errno = DON2STP5PRISUK;
			frankly_err(ws_funktion,"fejl",ws_don2errno);
/* RETTET 140929 PSWEEKENDPRISFEJL
			frankly_err(ws_funktion,"fejl",(long int)100);
*/
		}
		close_reg();
		break;
	case 6 :
/* GetLocationList */
/* GLFUNK 201 */
/* INPUT GP+station */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_short(&ws_station);
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK6 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0 &&
			ws_station==0) {
			ws_inputstation = 0;
		}
		if (ws_funkretur>0 && ws_station>0 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"6_%2.2hd",ws_station);
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_station==0 &&
			ws_inputstation==0 &&
			ws_snydflag>0) {
			ws_station = 66;
			ws_sendretur += don2snyd("6_66");
			ws_station = 58;
			ws_sendretur += don2snyd("6_58");
			ws_station = 56;
			ws_sendretur += don2snyd("6_56");
			ws_station = 57;
			ws_sendretur += don2snyd("6_57");
		}
		if (ws_funkretur>0 &&
			ws_snydflag<=0) {
			ws_funkretur2 = send_stationliste(1,0,ws_langstr);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;

	case 7 :
/* Login */
/* GLFUNK305 */
/* INPUT GP+logintype+loginid-1+loginid-2 */
/* JANNICK 111212 */
/* DON 404485 */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_short(&ws_logintype);
			get_alfa(ws_loginid1);
			get_alfa(ws_loginid2);
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK7 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0 && ws_logintype==1 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"7_person");
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_logintype==2 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"7_firma");
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 &&
			ws_logintype>0 &&
			ws_snydflag<=0) {
			ws_funkretur2 = don2_login();
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;

	case 8 :
/* Account */
/* GLFUNK308 */
/* INPUT GP+kundetype+opdfunk+kundenr */
/* JANNICK 111212 */
/* DON 404485 */
		alarm(20);
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK8START ws_systemdato=%ld\n",
				ws_systemdato);
		}
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_short(&ws_kundetype);
			get_long(&ws_opdaterknr);
			ws_parameterantal = ws_feltantal;
			ws_parameterantal -= 1; /* FUNKNR */
			ws_parameterantal -= ws_minimumparaantal; /* GP */
			ws_parameterantal -= 2; /* FUNK8PARA */
			if (logfil) {
				fprintf(logfil,
				"main:DON2FUNK8TEST01 ws_systemdato=%ld\n",
					ws_systemdato);
			}
			(void)udpak_paratab(1,ws_parameterantal,0);
		}
		if (logfil) {
			fprintf(logfil,
			"main:DON2FUNK8TEST02 ws_systemdato=%ld\n",
				ws_systemdato);
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK8 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
			fprintf(logfil,
				"main:DON2FUNK8 ws_systemdato=%ld\n",
				ws_systemdato);
		}
		if (ws_funkretur>0 && ws_kundetype==1 &&
			ws_opdaterknr<=0 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"8_p_opr_ok");
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_kundetype==1 &&
			ws_opdaterknr>0 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"8_p_opd_ok");
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_kundetype==2 &&
			ws_opdaterknr<=0 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"8_f_opr_ok");
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_kundetype==2 &&
			ws_opdaterknr>0 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"8_f_opd_ok");
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_kundetype>0 &&
			ws_opdaterknr>=0 &&
			ws_snydflag<=0) {
			ws_funkretur2 = don2_account();
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;
	case 9 :
/* ReturnCompanyCustomerId */
/* INPUT GP+kundetype+navn+adr+postnr+email */
		alarm(20);
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK9START ws_systemdato=%ld\n",
				ws_systemdato);
		}
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
/* RETTET 121017
			get_short(&ws_kundetype);
*/
			ws_parameterantal = ws_feltantal;
			ws_parameterantal -= 1; /* FUNKNR */
			ws_parameterantal -= ws_minimumparaantal; /* GP */
                        if (logfil) {
                                fprintf(logfil,
                                "main:DON2FUNK9TEST01 ws_systemdato=%ld\n",
                                        ws_systemdato);
                                fprintf(logfil,
                                "main:DON2FUNK9TEST01 ws_parameterantal=%hd\n",
                                        ws_parameterantal);
                        }
                        (void)udpak_paratab(1,ws_parameterantal,0);
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
			break;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK9 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0 &&
			ws_snydflag<=0) {
			ws_funkretur2 = don2_firma_kundenr();
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;

	case 10 :
/* SubmitRental */
/* GLFUNK340 */
/* INPUT GP+station+prodID+grp+aflstation+afh.dato+afh.tid+afl.dato+afl.tid+ExtraINDEX */
		alarm(30);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			ws_funkparaantal = 0;
			get_short(&ws_station);
			ws_funkparaantal++;
			get_short(&ws_tilstation);
			ws_funkparaantal++;
/* FLYTTET 121017 */
			get_alfa(ws_donspcstr);
			ws_funkparaantal++;
			get_alfa_tgn(ws_donspcstr,0,ws_tmppara,';');
			if (strlen(ws_tmppara)) {
				sscanf(ws_tmppara,"%hd",&ws_specnr);
			}
			get_alfa_tgn(ws_donspcstr,1,ws_extspcstr,';');

			get_alfa(ws_tmppara);
			ws_funkparaantal++;
			rens_datotidstr(ws_tmppara);
/*			sscanf(ws_tmppara,"%ld",&ws_fradato); */
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_fradato = m036_funktion(18, ege_w_int1);

			get_alfa(ws_tmppara);
			ws_funkparaantal++;
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_fratid);

			get_alfa(ws_tmppara);
			ws_funkparaantal++;
			rens_datotidstr(ws_tmppara);
/*			sscanf(ws_tmppara,"%ld",&ws_tildato); */
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_tildato = m036_funktion(18, ege_w_int1);

			get_alfa(ws_tmppara);
			ws_funkparaantal++;
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_tiltid);

			get_alfa(ws_grp);
			ws_funkparaantal++;
			ege_toupper((unsigned char *)ws_grp);
/* NYT 120925 */
/* RETTET 121210
			get_long(&ws_lejerknr);
			get_alfa(ws_lejerfornavn);
			get_alfa(ws_lejereftnavn);
			get_alfa(ws_lejerkkortnr);
			get_alfa(ws_lejerfdato);
*/
/* RETTET 130107
			get_long(&ws_medlknr);
			ws_funkparaantal++;
*/
/* NYT 130322 KONV8859MEDL */
			get_alfa(ws_tmpstr);
			strcpy(ws_medlfornavn,
			(char *) konvert_ext_ascii_til_8859(ws_tmpstr));
/*
			get_alfa(ws_medlfornavn);
*/
			ws_funkparaantal++;
/* NYT 130322 KONV8859MEDL */
			get_alfa(ws_tmpstr);
			strcpy(ws_medleftnavn,
			(char *) konvert_ext_ascii_til_8859(ws_tmpstr));
/*
			get_alfa(ws_medleftnavn);
*/
			ws_funkparaantal++;
			get_alfa(ws_medlkkortnr);
			ws_funkparaantal++;
			get_alfa(ws_medlfdato);
			ws_funkparaantal++;
/* NYT 121121 SUBMIT2FELTER 45 felter */
/* IKKE OK 121203 */
			get_alfa(ws_rekvnr);
			ws_funkparaantal++;
			get_alfa(ws_betalingstype);
			ws_funkparaantal++;
/* NYT 121204 COMPANYDRIVERSMAX10 */
			get_alfa(ws_drivertab[0]);
			ws_funkparaantal++;
			get_alfa(ws_drivertab[1]);
			ws_funkparaantal++;
			get_alfa(ws_drivertab[2]);
			ws_funkparaantal++;
			get_alfa(ws_drivertab[3]);
			ws_funkparaantal++;
			get_alfa(ws_drivertab[4]);
			ws_funkparaantal++;
			get_alfa(ws_drivertab[5]);
			ws_funkparaantal++;
			get_alfa(ws_drivertab[6]);
			ws_funkparaantal++;
			get_alfa(ws_drivertab[7]);
			ws_funkparaantal++;
			get_alfa(ws_drivertab[8]);
			ws_funkparaantal++;
			get_alfa(ws_drivertab[9]);
			ws_funkparaantal++;
/* NYT 140409 PSKUNDEOPLSUBMIT */
			if (ws_brandtype==4) {
				get_alfa(ws_tmppara);
				ws_funkparaantal++;
				sscanf(ws_tmppara,"%d",&ws_psbookstatus);
				get_alfa(ws_pslejeropl[0]);
				ws_funkparaantal++;
				get_alfa(ws_pslejeropl[1]);
				ws_funkparaantal++;
				get_alfa(ws_pslejeropl[2]);
				ws_funkparaantal++;
				get_alfa(ws_pslejeropl[3]);
				ws_funkparaantal++;
				get_alfa(ws_pslejeropl[4]);
				ws_funkparaantal++;
				get_alfa(ws_pslejeropl[5]);
				ws_funkparaantal++;
			}
/* NYT 140411 PSMEDLOPLSUBMIT */
/*
			if (ws_brandtype==4) {
				get_alfa(ws_psmedl1opl[0]);
				ws_funkparaantal++;
				get_alfa(ws_psmedl1opl[1]);
				ws_funkparaantal++;
			}
*/
/* NYT 121017 */
			if (ws_kundenr<=0 && ws_lejerknr>0) {
				ws_kundenr = ws_lejerknr;
			}
			ws_parameterantal = ws_feltantal;
			ws_parameterantal -= 1; /* FUNKNR */
			ws_parameterantal -= ws_minimumparaantal; /* GP */
			ws_parameterantal -= ws_funkparaantal; /* FUNK10PARA */
/* RETTET 121210
			ws_parameterantal -= 30;
*/
			(void)udpak_extratab(ws_parameterantal);
		}
/* NYT 130814 DOBBELBOOKCHECK */
		sprintf(ws_dobbelnavnopl,"%s%s%s%s%s",
			ws_donspcstr,
			ws_medlfornavn,
			ws_medleftnavn,
			ws_rekvnr,
			ws_betalingstype);

		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
		ws_kundedtfra = ws_fradato;
		ws_kundetdfra = ws_fratid;
		ws_kundedttil = ws_tildato;
		ws_kundetdtil = ws_tiltid;
/* DON2HERTIL */
		ws_don2errno = 0;
                ws_funkretur2 = 0;
		ws_funkretur = find_pc_id();
		if (ws_funkretur<=0) {
			ws_don2errno = DON2SRVFEJL;
			ws_funkretur = -1;
		}
		if (logfil) {
			fprintf(logfil,
	"main:DON2FUNK10X01 ws_funkretur=%d,ws_don2errno=%ld\n",
				ws_funkretur,
				ws_don2errno);
			fprintf(logfil,
	"main:DON2FUNK10X01 ws_fradato=%ld ws_tildato=%ld\n",
				ws_fradato,
				ws_tildato);
			fprintf(logfil,
	"main:DON2FUNK10X01 ws_rekvnr=<%s> ws_betalingstype=<%s>\n",
				ws_rekvnr,
				ws_betalingstype);
			fprintf(logfil,
	"main:DON2FUNK10X01 ws_funkparaantal=%hd\n",
				ws_funkparaantal);
			fflush(logfil);
		}
		if (ws_funkretur>0 &&
			ws_fradato==ws_tildato &&
			ws_fratid==ws_tiltid) {
			ws_don2errno = DON2SUBTID;
			ws_funkretur = -2;
		}
		if (logfil) {
			fprintf(logfil,
	"main:DON2FUNK10X02 ws_funkretur=%d,ws_don2errno=%ld\n",
				ws_funkretur,
				ws_don2errno);
			fprintf(logfil,
	"main:DON2FUNK10X02 ws_kundenr=%ld\n",
				ws_kundenr);
			fflush(logfil);
		}
/* NYT 140408 PSKUNDENRNUL */
		if (ws_funkretur>0 &&
			ws_brandtype==3 &&
			ws_kundenr<=0) {
			ws_don2errno = DON2SUBKNR;
			ws_funkretur = -3;
		}
                if (ws_funkretur>0 && ws_kundenr>0) {
			sprintf(ws_tmppara,"%ld",ws_kundenr);
			ws_funkretur3 = don2_check_dau(1,ws_tmppara,ws_tmppara);
		}
                if (ws_funkretur>0 && ws_funkretur3==2) {
			ws_don2errno = DON2SUBACC2;
			ws_funkretur = -4;
		}
                if (ws_funkretur>0 && ws_funkretur3==3) {
			ws_don2errno = DON2SUBACC3;
			ws_funkretur = -4;
		}
                if (ws_funkretur>0 && ws_funkretur3==4) {
			ws_don2errno = DON2SUBACC4;
			ws_funkretur = -4;
		}
		if (logfil) {
			fprintf(logfil,
	"main:DON2FUNK10X03 ws_funkretur=%d,ws_don2errno=%ld\n",
				ws_funkretur,
				ws_don2errno);
			fprintf(logfil,
	"main:DON2FUNK10X03 ws_station=%hd ws_grp=%s ws_specnr=%hd\n",
				ws_station,
				ws_grp,
				ws_specnr);
		}
		if (ws_funkretur>0 && ws_brandtype==3) {
			(void)find_statresmin(ws_station);
			ws_funkretur = check_ressourcer(CHKRESFUNK,
				ws_station,
				ws_grp,
				ws_specnr,
				ws_extspcstr,
				ws_fradato,
				0);
			if (ws_orgbooknr<=0 && ws_funkretur<=0) {
				ws_don2errno = DON2SUBRES;
				ws_funkretur = -5;
			}
		}
		if (ws_funkretur>0 &&
			ws_fradato==ws_systemdato &&
			ws_fratid<=ws_systemtid) {
			ws_don2errno = DON2SUBTID2;
			ws_funkretur = -6;
		}
		if (logfil) {
			fprintf(logfil,
	"main:DON2FUNK10 ws_kreds=%s,ws_funkretur=%d,ws_don2errno=%ld\n",
				ws_kreds,
				ws_funkretur,
				ws_don2errno);
			fprintf(logfil,
	"main:DON2FUNK10 ws_funkretur3=%d\n",
				ws_funkretur3);
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		if (ws_funkretur>0 && ws_station>0 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"10_%2.2hd",ws_station);
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_station>0 &&
			ws_snydflag<=0 &&
			ws_brandtype==3) {
			ws_donsaesonflag = check_don_tilbud(-1,
				ws_station,
				ws_specnr,
				ws_grp,
				-1,
				ws_fradato,
				ws_tildato,
				ws_tmppara);
		}
		if (logfil) {
			fprintf(logfil,
	"main:DON2FUNK10 ws_donsaesonflag=%hd\n",
				ws_donsaesonflag);
			fprintf(logfil,
	"main:DON2FUNK10 ws_orgbooknr=%ld\n",
				ws_orgbooknr);
			fprintf(logfil,
	"main:DON2FUNK10 ws_resnr=%ld\n",
				ws_resnr);
		}
/* NYT 130920 DOBBELBOOKCHECK */
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			check_dobbelcheck()>0) {
			ws_funkretur = -1;
		}
		if (ws_dobbelresnr>0 && ws_funkretur==-1) {
			reclow(r159,R159);
			f159_start(1,ISGTEQ);
			r159->record_x = ws_dobbelresnr;
			egeread(f159,ISEQUAL);
		}
		if (ws_dobbelresnr>0 && ws_funkretur==-1 && f159_ok) {
			alfalow(str);
			pack_init(str);
			sprintf(str,"%s\n",ws_dobbelbooksvar);
			send_linie();
			if (logfil) {
				fprintf(logfil, "SENDT:str=%s", str);
				fflush(logfil);
			}
			ws_fatallog = 1;
			close_reg();
			break;
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			ws_brandtype==3) {
/* NYT 140307 CO996FIRMANUL */
			check_firmaloginflag();

			(void)init_extraptab(1);
			ws_funkretur3 = don2_opdaterpris(1);
			ws_funkretur2 = ws_funkretur3;
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			ws_brandtype==4) {
			(void)init_extraptab(1);
			ws_funkretur3 = don2_opdaterpris(1);
			ws_funkretur2 = ws_funkretur3;
		}

		if (logfil) {
			fprintf(logfil,
	"main:DON2FUNK10 ws_funkretur=%d\n",
				ws_funkretur);
			fprintf(logfil,
	"main:DON2FUNK10 ws_funkretur3=%d\n",
				ws_funkretur3);
		}
		if (ws_funkretur>0 && ws_funkretur3<=0) {
			ws_don2errno = DON2SUBOPR;
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
/* NYT 130701 WEBOPRETLOG */
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			r159->record_x>0 &&
			ws_funkretur3==1) {
			add_webopretlog(ws_ipadr,r159->record_x);
/* NYT 130923 DOBBELBOOKCHECK */
			(void)opdat_dobbelcheck();
		}

/* NYT 130121 SMSKVIT */
		ws_smskvitflag = 0;
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			r159->record_x>0 &&
			ws_funkretur3==1 && strcmp(ws_betalingstype,"2")==0) {
			ws_smskvitflag = 1;
/* NYT 130226 */
			opdat_don_wgk(3,r159->record_x);
			sprintf(ws_tmppara,"don_%8.8ld.web",r159->record_x);
			(void)unlink(ws_tmppara);
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			r159->record_x>0 &&
			ws_funkretur3==1 && strcmp(ws_betalingstype,"3")==0) {
			ws_smskvitflag = 1;
/* NYT 130124 KONTROLGODK */
			opdat_don_wgk(3,r159->record_x);
			sprintf(ws_tmppara,"don_%8.8ld.web",r159->record_x);
			(void)unlink(ws_tmppara);
		}
		if (logfil) {
			fprintf(logfil,
	"main:DON2FUNK10 ws_smskvitflag=%d ws_betalingstype=%s\n",
				ws_smskvitflag,
				ws_betalingstype);
			fprintf(logfil,
	"main:DON2FUNK10 SUBMITRENTAL%ld\n", r159->record_x);
		}
		if (ws_smskvitflag>0) {
			(void)checksend_sms((int)1,(long int)0,"20417815");
/* TEST
			sleep(1);
			(void)checksend_sms((int)2,(long int)0,"20417815");
*/
		}
/* NYT 130617 SUBMITCANCELORG */
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			r159->record_x>0 &&
			ws_funkretur3==1 && strcmp(ws_betalingstype,"2")==0 &&
			ws_orgbooknr>0) {
			(void)cancel_reservation(ws_orgbooknr,0,1);
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			r159->record_x>0 &&
			ws_funkretur3==1 && strcmp(ws_betalingstype,"3")==0 &&
			ws_orgbooknr>0) {
			(void)cancel_reservation(ws_orgbooknr,0,1);
		}
/* NYT 130614 LOGSUBMITRENTAL */
		ws_fatallog = 1;
		close_reg();
		break;

	case 11 :
/* GetBookingList */
/* GLFUNKxxx */
/* INPUT GP+logintype+kundenr */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_short(&ws_logintype);
			get_long(&ws_opdaterknr);
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
                ws_funkretur = 1;
		if (ws_funkretur>0 && ws_logintype==1 &&
			ws_opdaterknr>0 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"11_%ld",ws_opdaterknr);
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_logintype==2 &&
			ws_opdaterknr>0 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"11_%ld",ws_opdaterknr);
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		init_reg();
		if (ws_funkretur>0 && ws_logintype==1 &&
			ws_opdaterknr>0 &&
			ws_snydflag<=0) {
			ws_funkretur2 = send_don2_booklist();
		}
		if (ws_funkretur>0 && ws_logintype==2 &&
			ws_opdaterknr>0 &&
			ws_snydflag<=0) {
			ws_funkretur2 = send_don2_booklist();
		}
		if (logfil) {
			fprintf(logfil,
	"main:DON2FUNK11 ws_kreds=%s,ws_funkretur=%d,ws_don2errno=%ld\n",
				ws_kreds,
				ws_funkretur,
				ws_don2errno);
			fprintf(logfil,
	"main:DON2FUNK11 ws_funkretur2=%d\n",
				ws_funkretur2);
		}
/* TEST 1305030
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			ws_don2errno = DON2BLNOM;
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
*/
		close_reg();
		break;

	case 12 :
/* CancelBooking CancelRental */
/* GLFUNK340 */
/* INPUT GP+bookingnr */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_long(&ws_resnr);
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_don2errno = 0;
                ws_funkretur2 = 0;
                ws_funkretur = find_pc_id();
                if (ws_funkretur<=0) {
                        ws_don2errno = DON2SRVFEJL;
                        ws_funkretur = -1;
                }
		if (ws_funkretur>0 && ws_resnr<=0) {
                        ws_don2errno = DON2CNCBNR;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			close_reg();
			break;
		}
		if (ws_funkretur>0 && ws_resnr>0 &&
			ws_snydflag<=0) {
			ws_funkretur2 = cancel_reservation(ws_resnr,0,1);
		}
		if (ws_funkretur>0 && ws_resnr==26600001 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"12_%ld",ws_resnr);
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_resnr==25600001 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"12_%ld",ws_resnr);
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_resnr==25700001 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"12_%ld",ws_resnr);
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_resnr==25800001 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"12_%ld",ws_resnr);
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_resnr>0 &&
			ws_snydflag>0 &&
			ws_sendretur<=0) {
			sprintf(ws_tmpstr,"12_err");
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_resnr<=0 &&
			ws_snydflag>0 &&
			ws_sendretur<=0) {
			sprintf(ws_tmpstr,"12_err_nr");
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (logfil) {
			fprintf(logfil,
	"main:DON2FUNK12 ws_kreds=%s,ws_funkretur=%d,ws_don2errno=%ld\n",
				ws_kreds,
				ws_funkretur,
				ws_don2errno);
			fprintf(logfil,
	"main:DON2FUNK12 ws_funkretur2=%d\n",
				ws_funkretur2);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;

	case 13 :
/* EditBooking EditRental */
/* GLFUNKxxx */
/* INPUT GP+bookingnr */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_long(&ws_resnr);
		}
		init_reg();
                ws_funkretur = 1;
		if (ws_funkretur>0 && ws_resnr==26600001 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"13_%ld",ws_resnr);
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_resnr==25600001 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"13_%ld",ws_resnr);
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_resnr==25700001 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"13_%ld",ws_resnr);
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_resnr==25800001 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"13_%ld",ws_resnr);
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_resnr>0 &&
			ws_snydflag>0 &&
			ws_sendretur<=0) {
			sprintf(ws_tmpstr,"13_err");
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 && ws_resnr<=0 &&
			ws_snydflag>0 &&
			ws_sendretur<=0) {
			sprintf(ws_tmpstr,"13_err_nr");
			ws_sendretur = don2snyd(ws_tmpstr);
		}
                ws_don2errno = 0;
                ws_funkretur2 = 0;
		if (ws_funkretur>0 && ws_resnr<=0) {
                        ws_don2errno = DON2EDTBNR;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			close_reg();
			break;
		}
		if (ws_funkretur>0 && ws_resnr>0 &&
			ws_snydflag<=0) {
			ws_funkretur2 = send_don2_editrental();
		}
		if (logfil) {
			fprintf(logfil,
	"main:DON2FUNK13 ws_kreds=%s,ws_funkretur=%d,ws_don2errno=%ld\n",
				ws_kreds,
				ws_funkretur,
				ws_don2errno);
			fprintf(logfil,
	"main:DON2FUNK13 ws_funkretur2=%d\n",
				ws_funkretur2);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;

	case 14 :
/* GetAddDefaults */
/* GLFUNKxxx */
/* INPUT GP+kampagneid */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_long(&ws_kampagneid);
		}
		ws_funkretur = 1;
		if (ws_funkretur>0 && ws_kampagneid>=0 &&
			ws_snydflag>0) {
			sprintf(ws_tmpstr,"14_%ld",ws_kampagneid);
			ws_sendretur = don2snyd(ws_tmpstr);
		}
		if (ws_funkretur>0 &&
			ws_snydflag>0 &&
			ws_sendretur<=0) {
			sprintf(ws_tmpstr,"14_err");
			ws_sendretur = don2snyd(ws_tmpstr);
		}

		break;
	case 15 :
/* GetFrontpageDefaults */
/* GLFUNKxxx */
/* INPUT GP */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
/* NYT 120924 */
			get_short(&ws_station);
		}
/* NYT 131210 */
		ws_don2errno = 0;
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		ws_funkretur = 1;
		init_reg();
		if (ws_brandtype==3) {
			ws_funkretur2 = send_don2_fp_default();
		}
		if (ws_brandtype==4) {
			ws_funkretur2 = send_ps_fp_default();
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;

	case 16 :
/* UpdateCompanyDrivers */
/* GLFUNKxxx */
/* INPUT GP+subfunk+kundenr */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_short(&ws_subfunktion);
			get_long(&ws_opdaterknr);
		}
		if (ws_inputfunktion<=0 && ws_subfunktion==2) {
/* NYT 130321 KONV8859DRIVER */
			get_alfa(ws_tmpstr);
			strcpy(ws_lejerfornavn,
			(char *) konvert_ext_ascii_til_8859(ws_tmpstr));
			get_alfa(ws_tmpstr);
			strcpy(ws_lejereftnavn,
			(char *) konvert_ext_ascii_til_8859(ws_tmpstr));
/* RETTET 130321 KONV8859DRIVER
			get_alfa(ws_lejerfornavn);
			get_alfa(ws_lejereftnavn);
*/
			get_alfa(ws_lejerfdato);
			get_alfa(ws_lejerkkortnr);
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
                ws_funkretur = 1;
		init_reg();
		if (ws_subfunktion==0) {
			ws_funkretur2 = send_don2_drivers();
		}
		if (ws_subfunktion==1) {
			ws_funkretur2 = slet_don2_driver();
		}
		if (ws_subfunktion==2) {
			ws_funkretur2 = opret_don2_driver();
		}
		if (logfil) {
			fprintf(logfil,
	"main:DON2FUNK16 ws_kreds=%s,ws_funkretur=%d,ws_don2errno=%ld\n",
				ws_kreds,
				ws_funkretur,
				ws_don2errno);
			fprintf(logfil,
	"main:DON2FUNK16 ws_funkretur2=%d\n",
				ws_funkretur2);
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;

	case 17 :
/* DibsResult DIBS */
/* GLFUNK341 */
/* INPUT GP+ */
		alarm(100);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_long(&ws_resnr);
			get_short(&ws_betalingsflag);
			get_alfa(ws_betalingstype);
			ege_toupper((unsigned char *)ws_betalingstype);
			get_alfa(ws_betalingskode);
/* NYT 130319 KOMMADECI */
			get_alfa(ws_tmpstr);
			scan_xls_char(ws_tmpstr, &ws_betalingsbeloeb);
			if (ws_betalingsbeloeb==0) {
				sscanf(ws_tmpstr,"%lf",&ws_betdepbeloeb);
			}
/*
			get_doub(&ws_betalingsbeloeb);
*/
			get_alfa(ws_betdepkode);
/* NYT 130319 KOMMADECI */
			get_alfa(ws_tmpstr);
			scan_xls_char(ws_tmpstr, &ws_betdepbeloeb);
			if (ws_betdepbeloeb==0) {
				sscanf(ws_tmpstr,"%lf",&ws_betdepbeloeb);
			}
/*
			get_doub(&ws_betdepbeloeb);
*/
		}
/* NYT 130422 CHECKDIBSRETURKODE */
/*
		if (strcmp(ws_betdepkode,"-99")==0) {
			ws_don2errno = DON2DBSERR;
		}
		if (strcmp(ws_betalingskode,"-99")==0) {
			ws_don2errno = DON2DBSERR;
		}
*/
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
                ws_funkretur = 1;
		init_reg();
		opdat_kredit_betaling();

/* SLET don_XXXXXX.web */
		sprintf(ws_tmppara,"don_%8.8ld.web",ws_resnr);
		(void)unlink(ws_tmppara);
/* NYT 130124 KONTROLGODK */
		(void)opdat_don_wgk(3,ws_resnr);
/* NYT 130618 SUBMITCANCELORG */
		if (ws_resnr>0 && ws_orgbooknr>0) {
			(void)cancel_reservation(ws_orgbooknr,0,1);
		}

/* SEND reservation */
		alfalow(str);
		pack_init(str);
		pack_int2((long)1);
		pack_alfa("OK");
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		ws_funkretur2 = 1;
/* NYT 130124 SMSKVIT */
		ws_smskvitflag = 0;
		if (ws_funkretur2>0) {
			ws_smskvitflag = 1;
		}
		if (logfil) {
			fprintf(logfil,
	"main:DON2FUNK17 ws_smskvitflag=%d ws_betalingstype=%s\n",
				ws_smskvitflag,
				ws_betalingstype);
			fprintf(logfil,"DIBSTRANS\n");
		}
		if (ws_smskvitflag>0) {
			(void)checksend_sms((int)1,(long int)0,"20417815");
/* TEST
			sleep(1);
			(void)checksend_sms((int)2,(long int)0,"20417815");
*/
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		ws_fatallog = 1;
		close_reg();
		break;
	case 18 :
/* GetInvalidPickupDates */
/* GLFUNKxxx */
/* INPUT GP+location+år+måned */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_short(&ws_station);
			get_alfa(ws_grp);
			ege_toupper((unsigned char *)ws_grp);
			get_long(&ws_inpaa);
			get_long(&ws_inpmm);
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
                ws_funkretur = 1;
		init_reg();
		ws_funkretur2 = send_don2_lukketdage();
		if (ws_funkretur2<=0) {
			ws_don2errno = DON2PCKNOT;
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;

	case 19 :
/* GetInvalidReturnDates */
/* GLFUNKxxx */
/* INPUT GP+location+år+måned */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_short(&ws_station);
			get_alfa(ws_grp);
			ege_toupper((unsigned char *)ws_grp);
			get_long(&ws_inpaa);
			get_long(&ws_inpmm);
			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_fradato = m036_funktion(18, ege_w_int1);
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
                ws_funkretur = 1;
		init_reg();
		ws_funkretur2 = send_don2_lukketdage();
		if (ws_funkretur2<=0) {
			ws_don2errno = DON2RETNOT;
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;
	case 20 :
/* GetOpenHours */
/* GLFUNKxxx */
/* INPUT GP+location+dato */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_short(&ws_station);
			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_fradato = m036_funktion(18, ege_w_int1);
/* NYT 121214 */
			get_short(&ws_subfunktion);
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
                ws_funkretur = 1;
		init_reg();
		ws_funkretur2 = send_don2_aabentid();
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;
/* NYT 121121 PROMOTION */
	case 21 :
/* PromotionUpdate */
/* INPUT GP+station+aflstation+afh.dato+afh.tid+afl.dato+afl.tid+grp+prodID+ExtraINDEX */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_short(&ws_station);
			get_short(&ws_tilstation);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
/*			sscanf(ws_tmppara,"%ld",&ws_fradato); */
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_fradato = m036_funktion(18, ege_w_int1);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_fratid);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
/*			sscanf(ws_tmppara,"%ld",&ws_tildato); */
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_tildato = m036_funktion(18, ege_w_int1);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_tiltid);

			get_alfa(ws_grp);

			get_alfa(ws_donspcstr);
			get_alfa_tgn(ws_donspcstr,0,ws_tmppara,';');
			if (strlen(ws_tmppara)) {
				sscanf(ws_tmppara,"%hd",&ws_specnr);
			}
			get_alfa_tgn(ws_donspcstr,1,ws_extspcstr,';');

			ws_parameterantal = ws_feltantal;
			ws_parameterantal -= 1; /* FUNKNR */
			ws_parameterantal -= ws_minimumparaantal; /* GP */
			ws_parameterantal -= 8; /* FUNK21PARA */
			(void)udpak_extratab(ws_parameterantal);
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 && ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
		ws_kundedtfra = ws_fradato;
		ws_kundetdfra = ws_fratid;
		ws_kundedttil = ws_tildato;
		ws_kundetdtil = ws_tiltid;

                ws_funkretur2 = 0;
		ws_funkretur = find_pc_id();
		if (ws_funkretur<=0) {
			ws_don2errno = DON2SRVSYS;
			ws_funkretur = -1;
		}
		if (ws_funkretur>0 &&
			ws_fradato==ws_tildato &&
			ws_fratid==ws_tiltid) {
			ws_don2errno = DON2SRVDTTM;
			ws_funkretur = -2;
		}

/* NYT 121121 PROMOTION */
 		if (check_promotion()<=0) {
			ws_don2errno = DON2PRONOT;
			ws_funkretur = -3;
		}
/* NYT 130617 PROMOTIONTOM */
		if (ws_don2errno==DON2PRONOT && ws_funkretur==-3 &&
			strcmp(ws_promokode,"RABATKODE")==0) {
			ws_don2errno = DON2PROTOM;
		}
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK21 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
			fprintf(logfil,
				"main:DON2FUNK21 ws_don2errno=%ld\n",
				ws_don2errno);
			fprintf(logfil,
				"main:DON2FUNK21 ws_fradato=%ld\n",
				ws_fradato);
			fprintf(logfil,
				"main:DON2FUNK21 ws_tildato=%ld\n",
				ws_tildato);
			fprintf(logfil,
				"main:DON2FUNK21 ws_promokode=%s\n",
				ws_promokode);
			fprintf(logfil,
				"main:DON2FUNK21 ws_promotype=%d\n",
				ws_promotype);
		}
		if (ws_funkretur<0 && ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			close_reg();
			break;
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			ws_brandtype==3) {
			(void)init_extraptab(1);
			ws_funkretur2 = don2_opdaterpris(0);
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			ws_brandtype==4) {
			(void)init_extraptab(1);
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			ws_brandtype==4 && ws_don2errno>0) {
			frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			close_reg();
			break;
		}
		if (ws_funkretur>0 && ws_snydflag<=0 && ws_station>0 &&
			ws_brandtype==4) {
			ws_funkretur2 = don2_opdaterpris(0);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;
	case 22 :
/* ReturnProductDefs */
/* INPUT GP */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
/*
			get_short(&ws_station);
			get_alfa(ws_grp);
			ege_toupper((unsigned char *)ws_grp);
*/
			get_alfa(ws_donspcstr);
			ege_toupper((unsigned char *)ws_donspcstr);
		}
		ws_funkretur = 1;
		init_reg();
		ws_funkretur = find_pc_id();
		if (ws_funkretur<=0) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-8);
			web_errormess(0,ws_langstr,"8");
			pack_exchkend();
			send_linie();
			if (logfil) {
				fprintf(logfil, "SENDT:str=%s", str);
				fflush(logfil);
			}
			ws_funkretur = -1;
		}
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK22 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
/*
		if (ws_station<=0) {
			ws_don2errno = DON2DEFST;
		}
		if (!strlen(ws_grp)) {
			ws_don2errno = DON2DEFGRP;
		}
*/
		if (!strlen(ws_donspcstr)) {
			ws_don2errno = DON2DEFSPC;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			close_reg();
			break;
		}
		ws_funkretur2 = send_don2_proddefs();
		if (logfil) {
			fprintf(logfil,
				"main:DON2FUNK22 ws_funkretur2=%d\n",
				ws_funkretur2);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			ws_don2errno = DON2DEFUK;
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			close_reg();
			break;
		}
		if (ws_stepnr>=3) {
			ws_kundedtfra = ws_fradato;
			ws_kundetdfra = ws_fratid;
			ws_kundedttil = ws_tildato;
			ws_kundetdtil = ws_tiltid;

			ws_tilstation = ws_station;
			ws_inputspecnr = ws_specnr;
			(void)find_statresmin(ws_station);
			ws_funkretur2 = send_match_prodliste(1,
				ws_langstr,
				ws_station,
				ws_kundenr,
				ws_grp,
				ws_fradato,
				ws_tildato);
		}
		if (ws_stepnr>=3 && ws_sendretur<=0 && ws_funkretur2<=0) {
			ws_don2errno = DON2DEFPF;
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		close_reg();
		break;
/* NYT 130521 PDF */
	case 23 :
/* GetOrMailPdf */
/* INPUT GP+pdftype+booknr */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_short(&ws_pdftype);
			get_long(&ws_resnr);
		}
		if (ws_inputfunktion<=0 && ws_feltantal==13) {
			get_alfa(ws_emailadr);
		}
		ws_funkretur = 1;
		init_reg();
		if (ws_pdftype<0) {
			ws_don2errno = DON2PDFTP;
		}
		if (ws_resnr<=0) {
			ws_don2errno = DON2PDFNR;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			close_reg();
			break;
		}
		ws_funkretur2 = styr_don2_pdf();
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			ws_don2errno = DON2PDFUK;
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		close_reg();
		break;

/* NYT 150324 WEBAPI */
	case 24 :
/* WEBAPI24 GetLocations */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=11) {
			get_short(&ws_station);
		}
		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:WEBAPI24 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0 &&
			ws_station==0) {
			ws_inputstation = 0;
		}
		if (ws_funkretur>0) {
			ws_funkretur2 = send_webapi_stationer(1);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;

	case 25 :
/* WEBAPI25 GetLocationsDetails */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=11) {
			get_short(&ws_station);
		}
		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:WEBAPI25 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0 &&
			ws_station==0) {
			ws_inputstation = 0;
		}
		if (ws_funkretur>0) {
			ws_funkretur2 = send_webapi_stationer(2);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;
	case 26 :
/* WEBAPI26 GetCountryList */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
		}
		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:WEBAPI26 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0) {
			ws_funkretur2 = send_webapi_lande(1);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;
	case 27 :
/* WEBAPI27 GetAvailableCars */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_alfa(ws_landekode);
			get_short(&ws_station);
			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_fradato = m036_funktion(18, ege_w_int1);
			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_fratid);

			get_short(&ws_tilstation);
			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_tildato = m036_funktion(18, ege_w_int1);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_tiltid);
		}
/* NYT 150408 CARTYPE */
		if (ws_inputfunktion<=0 && ws_feltantal>=18) {
			get_alfa(ws_biltype);
		}
/* NYT 150526 GRP */
		if (ws_inputfunktion<=0 && ws_feltantal>=19) {
			get_alfa(ws_grp);
			strcpy(ws_inpgrp,ws_grp);
		}

		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:WEBAPI27 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
/* NYT 150511 ECNYWEBPRSNYD */
		if (ws_funkretur>0 && access("ecnywebprsnyd",0)==0) {
			ws_funkretur2 = send_webapi_biler(1);
		}
		if (ws_funkretur>0 && access("ecnywebprsnyd",0)!=0) {
			(void)find_statresmin(ws_station);
			ws_funkretur2 = send_ecmatch_prodliste(1,
				ws_langstr,
				ws_station,
				ws_kundenr,
				ws_fradato,
				ws_tildato);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		if (ws_funkretur2<=0 && ws_don2errno<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;
	case 28 :
/* WEBAPI28 GetTypeList */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
		}
		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:WEBAPI28 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0 &&
			ws_station==0) {
			ws_inputstation = 0;
		}
		if (ws_funkretur>0) {
			ws_funkretur2 = send_webapi_cartypes(1);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;
	case 29 :
/* WEBAPI29 GetCarExtras */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_alfa(ws_landekode);
			get_short(&ws_station);
			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_fradato = m036_funktion(18, ege_w_int1);
			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_fratid);

			get_short(&ws_tilstation);
			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_tildato = m036_funktion(18, ege_w_int1);

			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_tiltid);
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=18) {
			get_alfa(ws_biltype);
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=19) {
			get_alfa(ws_tmppara);
			if (strlen(ws_tmppara)) {
				sscanf(ws_tmppara,"%hd",&ws_specnr);
			}
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=20) {
			get_alfa(ws_grp);
		}
/* RETTET 150602 BOOKFLOWJUST1
		if (ws_inputfunktion<=0 && ws_feltantal>=19) {
			get_alfa(ws_donspcstr);
			strcpy(ws_tmppara,"");
			get_alfa_tgn(ws_donspcstr,0,ws_tmppara,'-');
			if (strlen(ws_tmppara)) {
				sscanf(ws_tmppara,"%hd",&ws_specnr);
			}
			get_alfa_tgn(ws_donspcstr,1,ws_grp,'-');
		}
*/
		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:WEBAPI29 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0) {
			ws_funkretur2 = send_webapi_bilextra(1);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;
	case 30 :
/* WEBAPI30 PriceUpdate */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			ws_funkparaantal = 0;
			get_alfa(ws_landekode);
			ws_funkparaantal++;
			get_short(&ws_station);
			ws_funkparaantal++;
			get_alfa(ws_tmppara);
			ws_funkparaantal++;
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_fradato = m036_funktion(18, ege_w_int1);
			get_alfa(ws_tmppara);
			ws_funkparaantal++;
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_fratid);

			get_short(&ws_tilstation);
			ws_funkparaantal++;
			get_alfa(ws_tmppara);
			ws_funkparaantal++;
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_tildato = m036_funktion(18, ege_w_int1);

			get_alfa(ws_tmppara);
			ws_funkparaantal++;
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_tiltid);
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=18) {
			get_alfa(ws_biltype);
			ws_funkparaantal++;
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=19) {
			get_alfa(ws_tmppara);
			ws_funkparaantal++;
			if (strlen(ws_tmppara)) {
				sscanf(ws_tmppara,"%hd",&ws_specnr);
			}
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=20) {
			get_alfa(ws_grp);
			ws_funkparaantal++;
		}
/* RETTET 150602 BOOKFLOWJUST1
		if (ws_inputfunktion<=0 && ws_feltantal>=19) {
			get_alfa(ws_donspcstr);
			strcpy(ws_tmppara,"");
			get_alfa_tgn(ws_donspcstr,0,ws_tmppara,'-');
			if (strlen(ws_tmppara)) {
				sscanf(ws_tmppara,"%hd",&ws_specnr);
			}
			get_alfa_tgn(ws_donspcstr,1,ws_grp,'-');
		}
*/
/* NYT 150525 BOOKFLOWJUST1 */
		if (ws_inputfunktion<=0 && ws_feltantal>=21) {
/* RETTET 150602
		if (ws_inputfunktion<=0 && ws_feltantal>=20) {
*/
			ws_parameterantal = ws_feltantal;
			ws_parameterantal -= 1; /* FUNKNR */
			ws_parameterantal -= ws_minimumparaantal; /* GP */
			ws_parameterantal -= ws_funkparaantal; /* FUNK30PARA */
			(void)udpak_webapi_extratab(ws_parameterantal);
		}

		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
		ws_kundedtfra = ws_fradato;
		ws_kundetdfra = ws_fratid;
		ws_kundedttil = ws_tildato;
		ws_kundetdtil = ws_tiltid;
		ws_funkretur = find_pc_id();
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:WEBAPI30 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
			fprintf(logfil,
				"main:WEBAPI30 ws_don2errno=%ld\n",
				ws_don2errno);
			fprintf(logfil,
				"main:WEBAPI30 ws_fradato=%ld\n",
				ws_fradato);
			fprintf(logfil,
				"main:WEBAPI30 ws_tildato=%ld\n",
				ws_tildato);
			fprintf(logfil,
				"main:WEBAPI30 ws_grp=%s\n",
				ws_grp);
			fprintf(logfil,
				"main:WEBAPI30 ws_biltype=%s\n",
				ws_biltype);
		}
		if (ws_funkretur<0 && ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			close_reg();
			break;
		}
//		(void)init_extraptab(1);
		if (ws_don2errno>0) {
			frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			close_reg();
			break;
		}
		ws_funkretur2 = ecw_opdaterpris(0);
//		ws_funkretur2 = don2_opdaterpris(0);
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;

	case 31 :
/* WEBAPI31 MakeReservation */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			ws_funkparaantal = 0;
			get_alfa(ws_landekode);
			ws_funkparaantal++;
			get_short(&ws_station);
			ws_funkparaantal++;
			get_alfa(ws_tmppara);
			ws_funkparaantal++;
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_fradato = m036_funktion(18, ege_w_int1);
			get_alfa(ws_tmppara);
			ws_funkparaantal++;
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_fratid);

			get_short(&ws_tilstation);
			ws_funkparaantal++;
			get_alfa(ws_tmppara);
			ws_funkparaantal++;
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_tildato = m036_funktion(18, ege_w_int1);

			get_alfa(ws_tmppara);
			ws_funkparaantal++;
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ws_tiltid);
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=18) {
			get_alfa(ws_biltype);
			ws_funkparaantal++;
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=19) {
			get_alfa(ws_tmppara);
			ws_funkparaantal++;
			if (strlen(ws_tmppara)) {
				sscanf(ws_tmppara,"%hd",&ws_specnr);
			}
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=20) {
			get_alfa(ws_grp);
			ws_funkparaantal++;
		}
/* RETTET 150602 BOOKFLOWJUST1
		if (ws_inputfunktion<=0 && ws_feltantal>=18) {
			get_alfa(ws_donspcstr);
			ws_funkparaantal++;
			strcpy(ws_tmppara,"");
			get_alfa_tgn(ws_donspcstr,0,ws_tmppara,'-');
			if (strlen(ws_tmppara)) {
				sscanf(ws_tmppara,"%hd",&ws_specnr);
			}
			get_alfa_tgn(ws_donspcstr,1,ws_grp,'-');
		}
*/
		if (ws_inputfunktion<=0 && ws_feltantal>=21) {
// TITLE
			get_alfa(ws_lejertitle);
			ws_funkparaantal++;
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=22) {
// GENDER
			get_alfa(ws_lejergender);
			ws_funkparaantal++;
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=23) {
// FORNAVN
			get_alfa(ws_tmpstr);
			strcpy(ws_lejerfornavn,
			(char *) konvert_ext_ascii_til_8859(ws_tmpstr));
			ws_funkparaantal++;
// EFTERNAVN
			get_alfa(ws_tmpstr);
			strcpy(ws_lejereftnavn,
			(char *) konvert_ext_ascii_til_8859(ws_tmpstr));
			ws_funkparaantal++;
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=25) {
// FDATO
			get_alfa(ws_lejerfdato);
			ws_funkparaantal++;
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=26) {
// ADR1
			get_alfa(ws_eclejeropl[0]);
			ws_funkparaantal++;
// ADR2
			get_alfa(ws_eclejeropl[1]);
			ws_funkparaantal++;
// ADR3
			get_alfa(ws_eclejeropl[2]);
			ws_funkparaantal++;
// BY
			get_alfa(ws_eclejeropl[4]);
			ws_funkparaantal++;
// POSTKODE
			get_alfa(ws_eclejeropl[5]);
			ws_funkparaantal++;
// LAND
			get_alfa(ws_eclejeropl[6]);
			ws_funkparaantal++;
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=32) {
// MAIL
			get_alfa(ws_ecbookingmail);
			ws_funkparaantal++;
			ege_tolower((unsigned char*)ws_ecbookingmail);
// CONFIRM
//			get_alfa(ws_tmpstr);
//			ws_funkparaantal++;
		}
/* NYT 150703 WEBAPI31JUST1 */
		if (ws_inputfunktion<=0 && ws_feltantal>=33) {
			get_alfa(ws_betalingstype);
			ws_funkparaantal++;
		}
/* NYT 150710 WEBAPI31JUST2 */
		if (ws_inputfunktion<=0 && ws_feltantal>=34) {
			get_short(&ws_ecbookstatus);
			ws_funkparaantal++;
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=35) {
			ws_parameterantal = ws_feltantal;
			ws_parameterantal -= 1; /* FUNKNR */
			ws_parameterantal -= ws_minimumparaantal; /* GP */
			ws_parameterantal -= ws_funkparaantal; /* FUNK31PARA */
			(void)udpak_webapi_extratab(ws_parameterantal);
		}

/* REQUEST OR BOOK */
/* NYT 150710 WEBAPI31JUST2 */
		if (ws_brandtype<3 && ws_ecbookstatus==2) {
			ws_don2errno = WEBAPI31REQ;
		}
		if (ws_brandtype<3 && ws_ecbookstatus==3) {
			ws_don2errno = WEBAPI31REQ;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}

		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
	"main:WEBAPI31 ws_kreds=%s,ws_funkretur=%d,ws_funkparaantal=%hd\n",
				ws_kreds,
				ws_funkretur,
				ws_funkparaantal);
		}
		if (ws_funkretur>0) {
			ws_funkretur2 = opretsend_webapi_resnr(1);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;

	case 32 :
/* WEBAPI32 SearchBooking */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_short(&ws_findmoenster);
			get_long(&ws_findresnr);
			get_alfa(ws_findmail);
			ege_tolower((unsigned char*)ws_findmail);
			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_finduddato = m036_funktion(18, ege_w_int1);

			get_alfa(ws_findeftnavn);
			ege_toupper((unsigned char *)ws_findeftnavn);
			bss_konv_txt(3,ws_findeftnavn);
		}
		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:WEBAPI32 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0) {
			ws_funkretur2 = send_webapi_resliste(1);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0 && ws_don2errno<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;
	case 33 :
/* WEBAPI33 CancelBooking */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=11) {
			get_long(&ws_findresnr);
		}
		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:WEBAPI33 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0) {
			ws_funkretur2 = cancel_webapi_resnr(1);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;

	case 34 :
/* WEBAPI34 GetPdfBooking */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=11) {
			get_long(&ws_findresnr);
			ws_resnr = ws_findresnr;
			ws_pdftype = 0;
			strcpy(ws_emailadr,"");
		}
		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:WEBAPI34 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0) {
			ws_funkretur2 = styr_don2_pdf();
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;

	case 35 :
/* WEBAPI35 CreateAccount */
	case 38 :
/* WEBAPI38 ModifyAccount */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=11) {
			get_short(&ws_kundetype);
			ws_parameterantal = ws_feltantal;
			ws_parameterantal -= 1; /* FUNKNR */
			ws_parameterantal -= ws_minimumparaantal; /* GP */
			ws_parameterantal -= 1;
			(void)udpak_webapi_paratab(1,ws_parameterantal,0);
		}
		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:WEBAPI%hd ws_kreds=%s,ws_funkretur=%d\n",
				ws_funktion,
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0) {
			ws_funkretur2 = styr_webapi_kunde(1);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;
	case 36 :
/* WEBAPI36 Login */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=11) {
			get_short(&ws_logintype);
			get_alfa(ws_loginid1);
			get_alfa(ws_loginid2);
		}
		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:WEBAPI36 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0) {
			ws_funkretur2 = styr_webapi_login(1);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;
	case 37 :
/* WEBAPI37 ForgottenPassword */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=11) {
			get_short(&ws_logintype);
			get_alfa(ws_loginid1);
//			get_alfa(ws_loginid2);
		}
		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:WEBAPI37 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0) {
			ws_funkretur2 = styr_webapi_pw(1);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;
	case 39 :
/* WEBAPI39 GetCarSpecs */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=11) {
			get_alfa(ws_biltype);
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=12) {
			get_alfa(ws_grp);
			ege_toupper((unsigned char *)ws_grp);
		}
		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:WEBAPI39 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0) {
			ws_funkretur2 = send_webapi_bilspecs(1);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;

/* GetAccountSelectionLists */
	case 40 :
/* WEBAPI40 Question */
	case 41 :
/* WEBAPI41 PaymentCardTypes */
	case 42 :
/* WEBAPI42 FrequentTraveler */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
		}
		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:WEBAPI4x ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0) {
			ws_funkretur2 = send_webapi_kundevalg(1);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;
	case 43 :
/* WEBAPI43 GetLocationDateExceptions */
		alarm(20);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=11) {
			get_short(&ws_station);
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=12) {
			get_alfa(ws_tmppara);
			rens_datotidstr(ws_tmppara);
			sscanf(ws_tmppara,"%ld",&ege_w_int1);
			ws_fradato = m036_funktion(18, ege_w_int1);
		}
		if (ws_inputfunktion<=0 && ws_feltantal>=13) {
			get_short(&ws_dgvarighed);
		}

		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==3 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_brandtype==4 && check_donweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"dononline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==3) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"psonline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype==4) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
		init_reg();
                ws_funkretur = 1;
                ws_funkretur2 = 0;
		if (logfil) {
			fprintf(logfil,
				"main:WEBAPI43 ws_kreds=%s,ws_funkretur=%d\n",
				ws_kreds,
				ws_funkretur);
		}
		if (ws_funkretur>0) {
			ws_funkretur2 = send_webapi_st_aabenhlg(1);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
		}
		if (ws_funkretur>0 && ws_funkretur2<=0 && ws_don2errno<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		close_reg();
		break;
/* WEBAPI44 */
	case 44 :
/* DibsResult DIBS */
		alarm(100);
		if (ws_inputfunktion<=0) {
			(void)udpak_minimum_para(ws_funktion);
			get_long(&ws_resnr);
			get_short(&ws_betalingsflag);
			get_alfa(ws_betalingstype);
			ege_toupper((unsigned char *)ws_betalingstype);
			get_alfa(ws_betalingskode);
			get_alfa(ws_tmpstr);
			scan_xls_char(ws_tmpstr, &ws_betalingsbeloeb);
			if (ws_betalingsbeloeb==0) {
				sscanf(ws_tmpstr,"%lf",&ws_betdepbeloeb);
			}
			get_alfa(ws_betdepkode);
			get_alfa(ws_tmpstr);
			scan_xls_char(ws_tmpstr, &ws_betdepbeloeb);
			if (ws_betdepbeloeb==0) {
				sscanf(ws_tmpstr,"%lf",&ws_betdepbeloeb);
			}
		}
		if (ws_brandtype<3 && check_ecweboffline(1)==1) {
			ws_don2errno = DON2SRVOFFL;
		}
		sprintf(ws_tmppara,"econline.blok");
		if (access(ws_tmppara,0)==0 &&
			ws_brandtype<3) {
			ws_don2errno = DON2SRVOFFL;
		}
		if (ws_don2errno>0) {
			ws_funkretur2 = frankly_err(ws_funktion,
				"fejl",ws_don2errno);
			break;
		}
                ws_funkretur = 1;
		init_reg();
		opdat_kredit_betaling();

/* SLET don_XXXXXX.web */
		sprintf(ws_tmppara,"don_%8.8ld.web",ws_resnr);
		(void)unlink(ws_tmppara);
/* NYT 130124 KONTROLGODK */
		(void)opdat_don_wgk(3,ws_resnr);
/* NYT 130618 SUBMITCANCELORG */
		if (ws_resnr>0 && ws_orgbooknr>0) {
			(void)cancel_reservation(ws_orgbooknr,0,1);
		}

/* SEND reservation */
		alfalow(str);
		pack_init(str);
		pack_int2((long)1);
		pack_alfa("OK");
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		ws_funkretur2 = 1;
		ws_smskvitflag = 0;
//		if (ws_funkretur2>0) {
//			ws_smskvitflag = 1;
//		}
		if (logfil) {
			fprintf(logfil,
	"main:WEBAPI44 ws_smskvitflag=%d ws_betalingstype=%s\n",
				ws_smskvitflag,
				ws_betalingstype);
			fprintf(logfil,"DIBSTRANS\n");
		}
		if (ws_smskvitflag>0) {
			(void)checksend_sms((int)1,(long int)0,"20417815");
		}
		if (ws_sendretur<=0 && ws_funkretur2<=0) {
			frankly_err(ws_funktion,"fejl",(long int)100);
		}
		ws_fatallog = 1;
		close_reg();
		break;

/* TESTFUNK */
	case 999 :
		alarm(20);
		init_reg();
		if (logfil) {
			fprintf(logfil,"999 FUNDET TESTFUNK KALDES\n");
			fflush(logfil);
		}
		ws_station = 66;
		strcpy(ws_grp,"A");
		strcpy(ws_langstr,"DA");
/*
		ws_sendretur = send_genprisliste(3);
*/
		ws_sendretur = send_genextprisliste(3);
/* NYT 120705 DON2SNYD */
/*
		ws_sendretur = don2snyd("1");
*/
		close_reg();
		break;
	default :
		break;
	}
	(void)log_stopur(99);
	if (logfil) {
		fprintf(logfil,"ws_sendretur=%d\n",ws_sendretur);
		fprintf(logfil,"SLEEP-1\n");
	}
	sleep(1);
styr_99:
	ws_slutsek = (ULI)time(0);
	if (logfil) {
		fprintf(logfil, "ws_fatallog=%hd\n",
			ws_fatallog);
		fprintf(logfil, "slutsek=%lu\n",
			ws_slutsek);
		fprintf(logfil, "IALTSEK=%3lu,ws_funktion=%2hd\n",
			ws_slutsek-ws_startsek,
			ws_funktion);
		fprintf(logfil,"kaldfunk_check_bssaaben=%d\n",
			kaldfunk_check_bssaaben);
		fflush(logfil);
	}
	ws_funkretur = 0;
	sprintf(dum_str, "%slog.on",ws_kreds);
	if (access(dum_str,0)==0) {
		ws_funkretur = 1;
	}
	sprintf(dum_str, "%slog.p7912",ws_kreds);
	if (access(dum_str,0)==0) {
		ws_funkretur = 2;
	}
/* NYT 121012 */
	if (DONWANLOGFILTER && ws_funkretur==0) {
/* RETTET 130606
	if (DONWANLOGFILTER) {
*/
		ws_funkretur = 0;
	}
	if (DONWANLOGFILTER && check_wanlogfilter()>0) {
		ws_funkretur = 3;
	}
/* NYT 130327 FATALLOG */
	if (ws_fatallog>0) {
		ws_funkretur = 3;
	}
	if (ws_funkretur>0) {
		fclose(logfil);
		logfil = (FILE*)0;
		(void)chmod(logfil_navn,0777);
	} else {
		luk_logfil();
		logfil = (FILE*)0;
	}
	free(p7502ls);
	free(xlsprismain);
	free(xlsprissub);
	free(xlsprismatch);
/* NYT 150518 UDVRATE */
	free(udvrate);

	m002_2;
	egeexit(0);
}

/* NYT 150324 WEBAPI24 */
/* **************************************** */
static int send_webapi_stationer(int inpfunk) {
	int retur = 0;
	short int dondafolo = 0;
	short int psbookflag = 0;
	short int okflag = 1;
	short int webstation = 0;
	short int nglindkast = 0;
	short int sortflag = 0;
	short int sortantal = 0;
	short int sortstnr = 0;
	short int minnr = 0;
	short int maxnr = 0;
	short int wx1 = 0;
	int funkretur = 0;
	char resmailadr[81] = "";
	char vlmailadr[81] = "";
	char brandstr[21] = "";
	char gwkode[21] = "";
	char tmpstr[81] = "";
	char tmpstr2[81] = "";
	char tmpstr3[81] = "";
	char sortalfa[21] = "";
	char sortbuffer[201] = "";

	reclow(r198, R198);
	f198_start(1, ISGTEQ);
	reclow(r166, R166);
	f166_start(1, ISGTEQ);
	if (f166_ukendt) {
		okflag = -1;
	}
	sortflag = 1;
	if (ws_station>0) {
		minnr = ws_station;
		maxnr = ws_station;
		r166->stat_nr = minnr;
		f166_start(1, ISGTEQ);
		if (f166_ukendt) {
			okflag = -1;
		}
	}
	if (logfil) {
		fprintf(logfil, "send_webapi_stationer inpfunk=%d\n",inpfunk);
		fprintf(logfil, "\tminnr=%hd maxnr=%hd\n", minnr,maxnr);
		fprintf(logfil, "\tokflag=%hd\n",okflag);
		fflush(logfil);
	}
	while (okflag>0) {
		egeread(f166, ISNEXT);
		if (f166_eof) { break; }
		if (maxnr>0 && r166->stat_nr>maxnr) { break; }
		if (strcmp(r166->navn, "CANCELLED")==0) { continue; }
		strcpy(brandstr,"EC");
		reclow(r198, R198);
		r198->oplkode = 16610;
		r198->keynum = r166->stat_nr;
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			strcpy(brandstr,r198->alfafelt);
		}
		if (ws_brandtype<3 && strncmp(brandstr,"EC",2)!=0) {
			continue;
		}
		if (ws_brandtype==3 && strncmp(brandstr,"SY",2)!=0) {
			continue;
		}
		if (ws_brandtype==4 && strncmp(brandstr,"PS",2)!=0) {
			continue;
		}
		strcpy(sortalfa,"");
		webstation = 0;
		reclow(r198, R198);
		r198->oplkode = 16619;
		r198->keynum = r166->stat_nr;
		egeread(f198, ISEQUAL);
		if (f198_ukendt) { continue; }
		webstation = (short int)r198->numfelt;
		if (webstation<=0) { continue; }
/* AGENT 	r198->oplkode = 16652; */
/* UDREGNERGRP 	r198->oplkode = 16627; */

		strcpy(sortalfa,r198->alfafelt);
		sortalfa[15] = '\0';
		if (sortflag && !strlen(sortalfa)) {
			strcpy(sortalfa,r166->by);
		}
		if (sortflag && r166->stat_nr==52) {
			sprintf(sortalfa,"00%s",r166->by);
		}
		if (sortflag && sortantal==0) {
			egesort(1, "sort");
		}
		if (sortflag) {
			ege_toupper((unsigned char *)sortalfa);
			for (wx1=0;wx1<sizeof(sortalfa);wx1++)  {
				if (sortalfa[wx1] == ' ') {
					sortalfa[wx1] = '!';
				}
			}
			if (!strlen(sortalfa)) {
				strcpy(sortalfa, "!!!!!!!!!!!!!!!");
			}
			sprintf(sortbuffer,
				"%-15s %3hd \n \0",
				sortalfa,
				r166->stat_nr);
			egesort(2, sortbuffer);
			sortantal++;
			continue;
		}
	}
	if (logfil) {
		fprintf(logfil, "\tsortantal=%hd\n",sortantal);
	}
	if (sortflag && sortantal>0) {
		egesort(3, "sort");
	}
	while (okflag && sortflag && sortantal>0 && inpfunk==1) {
		if (egesort(4, sortbuffer) <= 0) {
			break;
		}
		reclow(r166, R166);
                sscanf(sortbuffer, "%s %hd",
			sortalfa,
                        &sortstnr);
		if (logfil) {
			fprintf(logfil, "SORT:%s", sortbuffer);
			fflush(logfil);
		}
		r166->stat_nr = sortstnr;
		egeread(f166, ISEQUAL);
		if (f166_ukendt) {
			continue;
		}
		alfalow(str);
		pack_init(str);
		pack_int2((long)r166->stat_nr);
		reclow(r198, R198);
		r198->oplkode = 16601;
		r198->keynum = r166->stat_nr;
		strcpy(tmpstr,r166->navn);
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			strcpy(tmpstr,r198->alfafelt);
		}
               	stednavn_form((unsigned char *)tmpstr);
		pack_alfa(tmpstr);
/* type city,lufthavn,agent */
		strcpy(tmpstr,"by");
/* NYT 150507 DIVJUST01 */
		reclow(r198, R198);
		r198->oplkode = 16618;
		r198->keynum = r166->stat_nr;
		egeread(f198, ISEQUAL);
		if (f198_ok && r198->numfelt>0) {
			strcpy(tmpstr,"lufthavn");
		}
//		if (r166->stat_nr==6) { strcpy(tmpstr,"lufthavn"); }
//		if (r166->stat_nr==33) { strcpy(tmpstr,"lufthavn"); }
		pack_alfa(tmpstr);
		funkretur = find_gwkode(1,r166->stat_nr,gwkode);
		if (logfil) {
			fprintf(logfil,"\t\tstat_nr=%hd,gwkode=%s\n",
				r166->stat_nr,
				gwkode);
		}
		funkretur = find_gwgpskoor(1,r166->stat_nr,gwkode,tmpstr);
		sscanf(tmpstr,"%s %s",tmpstr2,tmpstr3);
/* NYT 150507 DIVJUST01 */

		ege_w_int2 = 0;
		if (strlen(tmpstr2)) {
			sscanf(tmpstr2,"%ld",&ege_w_int2);
		}
		egeedit(ege_w_dou1=ege_w_int2,"zz9.9999",tmpstr);
		pack_alfa(tmpstr);

/* BYTTET 150602 */
		ege_w_int1 = 0;
		if (strlen(tmpstr3)) {
			sscanf(tmpstr3,"%ld",&ege_w_int1);
		}
		egeedit(ege_w_dou1=ege_w_int1,"zz9.9999",tmpstr);
		pack_alfa(tmpstr);


/* RETTET 150507 DIVJUST01
		pack_alfa(tmpstr2);
		pack_alfa(tmpstr3);
*/
		pack_exchkend();
		send_linie();
		retur++;
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
/* GetLocationDetails */
	while (okflag && sortflag && sortantal>0 && inpfunk==2) {
		if (egesort(4, sortbuffer) <= 0) {
			break;
		}
		reclow(r166, R166);
                sscanf(sortbuffer, "%s %hd",
			sortalfa,
                        &sortstnr);
		r166->stat_nr = sortstnr;
		egeread(f166, ISEQUAL);
		if (f166_ukendt) {
			continue;
		}
		alfalow(str);
		pack_init(str);
		pack_int2((long)r166->stat_nr);
		reclow(r198, R198);
		r198->oplkode = 16601;
		r198->keynum = r166->stat_nr;
		strcpy(tmpstr,r166->navn);
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			strcpy(tmpstr,r198->alfafelt);
		}
               	stednavn_form((unsigned char *)tmpstr);
		pack_alfa(tmpstr);
/* type city,lufthavn,agent */
/* NYT 150507 DIVJUST01 */
		strcpy(tmpstr,"by");
		reclow(r198, R198);
		r198->oplkode = 16618;
		r198->keynum = r166->stat_nr;
		egeread(f198, ISEQUAL);
		if (f198_ok && r198->numfelt>0) {
			strcpy(tmpstr,"lufthavn");
		}
//		if (r166->stat_nr==6) { strcpy(tmpstr,"lufthavn"); }
//		if (r166->stat_nr==33) { strcpy(tmpstr,"lufthavn"); }
		pack_alfa(tmpstr);

		strcpy(tmpstr,r166->adr);
               	stednavn_form((unsigned char *)tmpstr);
		pack_alfa(tmpstr);

		strcpy(tmpstr,r166->postkode);
		pack_alfa(tmpstr);

		strcpy(tmpstr,r166->by);
               	stednavn_form((unsigned char *)tmpstr);
		pack_alfa(tmpstr);

		strcpy(tmpstr,"Danmark");
		pack_alfa(tmpstr);

		sprintf(tmpstr,"+45 %s",r166->tlf);
		pack_alfa(tmpstr);

		reclow(r198, R198);
		r198->oplkode = 16604;
		r198->keynum = r166->stat_nr;
		strcpy(tmpstr,"?");
		egeread(f198,ISEQUAL);
		if (f198_ok){
			strcpy(tmpstr,r198->alfafelt);
		}
		pack_alfa(tmpstr);

		funkretur = find_gwkode(1,r166->stat_nr,gwkode);
		if (logfil) {
			fprintf(logfil,"\t\tstat_nr=%hd,gwkode=%s\n",
				r166->stat_nr,
				gwkode);
		}
		pack_alfa(gwkode);

		funkretur = find_gwgpskoor(1,r166->stat_nr,gwkode,tmpstr);
		sscanf(tmpstr,"%s %s",tmpstr2,tmpstr3);

		ege_w_int2 = 0;
		if (strlen(tmpstr2)) {
			sscanf(tmpstr2,"%ld",&ege_w_int2);
		}
		egeedit(ege_w_dou1=ege_w_int2,"zz9.9999",tmpstr);
		pack_alfa(tmpstr);
/* BYTTET 150602 */
		ege_w_int1 = 0;
		if (strlen(tmpstr3)) {
			sscanf(tmpstr3,"%ld",&ege_w_int1);
		}
		egeedit(ege_w_dou1=ege_w_int1,"zz9.9999",tmpstr);
		pack_alfa(tmpstr);

/* RETTET 150507 DIVJUST01 
		pack_alfa(tmpstr3);
		pack_alfa(tmpstr2);
*/
		strcpy(tmpstr,"Openhours");
		pack_alfa(tmpstr);
/* man-søn */
 		pack_del();
		add_webapi_aabentid(1,r166->stat_nr);

		pack_exchkend();
		send_linie();
		retur++;
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
	if (logfil) {
		fprintf(logfil,"send_stationliste:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* WEBAPI25 */
/* **************************************** */
static int add_webapi_aabentid(int inpfunk,int inpstation) {
	int retur = 0;
	int idx = 0;
	int fundet = 0;
	int klokken = 0;
	long int aabendgkode[20];
	int aabenfra[20];
	int aabentil[20];
	char tmpstr[81] = "";
	char aabentab[4][21] = {"","","",""};

	while (idx<20) {
		aabendgkode[idx] = 0;
		aabenfra[idx] = 0;
		aabentil[idx] = 0;
		idx++;
	}
	reclow(r198,R198);
	r198->oplkode = 16606;
	r198->keynum = (double)inpstation;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		fundet = -1;
	}
	while (fundet>=0) {
		egeread(f198,ISNEXT);
		if (f198_eof) { break; }
		if (r198->oplkode>16606) { break; }
		if (r198->keynum>(double)inpstation) { break; }
		get_alfa_tgn(r198->alfafelt,0,tmpstr,59);
		idx = 0;
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&idx);
		}
		if (idx>0 && idx<8) {
			aabendgkode[idx] = idx;
			klokken = 0;
			get_alfa_tgn(r198->alfafelt,1,tmpstr,59);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%d",&klokken);
			}
			aabenfra[idx] = klokken;
			klokken = 0;
			get_alfa_tgn(r198->alfafelt,2,tmpstr,59);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%d",&klokken);
			}
			aabentil[idx] = klokken;
			fundet++;
		}
	}
	idx = 1;
	while (fundet>0 && idx<8) {
		(void)dan_aabentid_ny(ws_langstr,
			aabendgkode[idx],
			aabendgkode[idx],
			aabenfra[idx],
			aabentil[idx],
			tmpstr);
		sscanf(tmpstr,"%s %s %s %s",
			aabentab[0],
			aabentab[1],
			aabentab[2],
			aabentab[3]);
		pack_alfa(aabentab[0]);
		if (strcmp(aabentab[1],"lukket")==0) {
			pack_alfa("0");
			pack_alfa("");
			pack_alfa("");
		} else {
			pack_alfa("1");
			pack_alfa(aabentab[1]);
			pack_alfa(aabentab[3]);
/*
			sprintf(tmpstr,"%s %s %s",
				aabentab[1],
				aabentab[2],
				aabentab[3]);
*/
		}
/* NYT 150507 DIVJUST01 */
		sprintf(tmpstr,"%d",idx);
		pack_alfa(tmpstr);
		sprintf(tmpstr,"%d",(int)0);
		pack_alfa(tmpstr);
		idx++;
		retur++;
	}
afslut:
	if (retur==0) {
		strcpy(tmpstr,"N/A");
		pack_alfa(tmpstr);
	}
	return(retur);
}

/* **************************************** */
static int find_gwkode(int inpfunk,int inpstnr,char *returstr) {
	int retur = 0;
	int chkstnr = 0;
	char tmpstr[81] = "";

	strcpy(returstr,"?");
	reclow(r198, R198);
	r198->oplkode = 16614;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		retur = -1;
	}
	while (retur>=0) {
		egeread(f198,ISNEXT);
		if (f198_eof) { break; }
		if (r198->oplkode>16614) { break; }
		get_alfa_tgn(r198->alfafelt,0,tmpstr,59);
		chkstnr = 0;
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&chkstnr);
		}
		if (chkstnr>0 && chkstnr==inpstnr) {
			strcpy(returstr,r198->keyalfa);
			retur = 1;
			break;
		}
	}
	return(retur);
}

/* ************************************************* */
static int find_gwgpskoor(int inpfunk,int inpstnr,char *inpgwkode,char *returstr) {
	int retur = 0;
	char inpstr[501] = "";
	char tmpstr[81] = "";
	char chkgwkode[21] = "";
	char gpslong[21] = "";
	char gpslat[21] = "";
	FILE * tmpfil;

	strcpy(returstr,"? ?");
	tmpfil = (FILE*)0;
	sprintf(inpstr,"%sgwstationer.csv",ws_kreds);
	tmpfil = fopen(inpstr,"r");
	if (!tmpfil) {
		tmpfil = (FILE*)0;
	}
	while (tmpfil && retur==0) {
		if (!fgets(inpstr,500,tmpfil)) { break; }
		get_alfa_tgn(inpstr,4,chkgwkode,59);
		if (!strlen(chkgwkode)) { continue; }
		if (strcmp(inpgwkode,chkgwkode)!=0) { continue; }

		get_alfa_tgn(inpstr,16,gpslong,59);
		get_alfa_tgn(inpstr,17,gpslat,59);
		sprintf(returstr,"%s %s",gpslong,gpslat);
		retur = 1;
	}
	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}
	return(retur);
}

/* *********************************************** */
static int send_webapi_lande(int inpfunk) {
	int retur = 0;
	int funkretur = 0;
	int nuvlandenr = 1;
	char landekode[21] = "";
	char landenavn[81] = "";

	if (logfil) {
		fprintf(logfil,"send_webapi_lande %d\n",inpfunk);
	}
	alfalow(e_landenavn);
	while (nuvlandenr<1000) {
		e_landenr = nuvlandenr;
		funkretur = ege_lande(1);
		if (funkretur<=0) {
			nuvlandenr++;
			continue;
		}
		strcpy(landekode,e_lande_ISO);
		strcpy(landenavn,e_landenavn);

		alfalow(str);
		pack_init(str);
		pack_alfa(landekode);
		pack_alfa(landenavn);
		pack_exchkend();
		send_linie();
		retur++;
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		nuvlandenr++;
	}
	if (logfil) {
		fprintf(logfil,"send_webapi_lande retur=%d\n",retur);
	}
	return(retur);
}

/* NYT 150504 WEBAPI27XLS */
/* ********************************* */
static int send_ecmatch_prodliste(short funk,char *langstr,short station,long kundenr,long fradt,long tildt) {
	short int retur = 0;
	int xlsprisflag = 0;
	short int aabenflag = 0;
	short int fejlkode = 0;
	short int dondafolo = 0;
	short int sendflag = 0;
	short int wx1 = 0;
	short int wx2 = 0;
	short int blokfundet = 0;
	short int funkretur = 0;
	short int funkretur2 = 0;
	short int specantal = 0;
	short int prisspecnr = 0;
	short int prisenhed = 0;
	short int prisextra = 0;
	short int prissmdgn = 0;
	short int prisdgvarighed = 0;
	short int pristmvarighed = 0;
	short int pristill = 0;
	short int prisafhfratid = 0;
	short int prisafltiltid = 0;
	short int stationafhtiltid = 0;
	short int stationaflfratid = 0;
	short int saesonextspc = 0;
	short int saesonextant = 0;

	short int tillspecnr = 0;
	short int tillantal = 0;
	short int nytillantal = 0;

	short int mintolerance = 0;
	short int maxtolerance = 1;
	short int gemmintol = 0;
	short int gemmaxtol = 1;
	short int forskelvarighed = 0;
	short int kundenrtype = 0;
	short int altproduktvarighed = 0;

	short int koblenhed = 0;
	short int koblfra = 0;
	short int kobltil = 0;
	short int koblspecnr = 0;
	short int koblfyraftenext = 0;
	long int tilbtvgafldato = 0;
	short int tilbtvgextspc = 0;
	short int tilbtvgextant = 0;

	short int kundealder = 0;
	long int minperiode = 0;
	long int evttildato = 0;
	long int kundevarighed = 0;
	long int produktvarighed = 0;
	long int chkantaldg = 0;
	long int chkfradgnr = 0;
	long int julian = 0;
	long int returdato = 0;
	long int udregndato = 0;
	long int udregnvar = 0;
	long int returaud = 0;
	long int specialfradato = 0;
	long int specialtildato = 0;
	long int produktfradato = 0;
	long int produkttildato = 0;
	long int produktfratid = 0;
	long int produkttiltid = 0;
	long int kundefratid = 0;
	long int kundetiltid = 0;
	long int altdato = 0;
	long int extfdato = 0;
	long int exttdato = 0;
	long int nytildt = 0;
	double kundefdatotid = 0;
	double kundetdatotid = 0;
	double prodfdatotid = 0;
	double prodtdatotid = 0;

	long int firmakundenr = 0;
	long int firmaaftfra = 0;
	long int firmaafttil = 0;
	short int aftaleflag = 0;
	short int weekendflag = 0;
	short int tvungenextspecnr = 0;
	short int starttypeidx = -1;
	short int sluttypeidx = -1;
	short int mainloopidx = -1;
	short int xlsprodidx = -1;
	short int extraretur = 0;
	short int chkalderfra = 0;
	short int chkaldertil = 0;

	char tmpstr[81] = "";
	char tmpgrpliste[81] = "";
	char tmpferienavn[41] = "";
	char tmpdatointerval[101] = "";
	char tmpfelt[81] = "";
	char stdgstr[81] = "";
	char f198key[21] = "";
	char transstr[21] = "";
	char weekenddtstr[31] = "";
	char psbiltype[31] = "";
	char psgrp[31] = "";
	char produktkode[31] = "";
	char produkttekst[81] = "";
	char produktincl[201] = "";

	char modelstr[41] = "";
	char nuvbiltype[41] = "";
	int nuvidx = 0;
	int nuvidx2 = 0;
	int typestyr = 1;
	int grpstyr = 1;

	if (logfil) {
		fprintf(logfil, "send_ecmatch_prodliste %hd\n",funk);
	}
/* OBS */
	if (ws_funktion==27) {
		dondafolo = 1;
		mintolerance = -1;
		ws_prodsortflag = 1;
		ws_alderblok = 0;
	}
	log_stopur(80);
	if (station>0) {
		strcpy(ws_sttlfnr,"N/A");
		reclow(r166,R166);
		f166_start(1,ISGTEQ);
		r166->stat_nr = station;
		egeread(f166,ISEQUAL);
		if (f166_ok) {
			strcpy(ws_sttlfnr,r166->tlf);
		}
	}
	if (logfil) {
		fprintf(logfil,
			"\tfradt=%ld,tildt=%ld\n",
			fradt,
			tildt);
		fprintf(logfil,
			"\tkundenr=%ld\n",
			kundenr);
		fprintf(logfil,
			"\tdondafolo=%hd\n",
			dondafolo);
		fprintf(logfil,
			"\tws_prodsortflag=%hd\n",
			ws_prodsortflag);
		fprintf(logfil,
			"\tws_fradato=%ld\n",
			ws_fradato);
		fprintf(logfil,
			"\tws_fratid=%ld\n",
			ws_fratid);
		fprintf(logfil,
			"\tws_sttlfnr=%s\n",
			ws_sttlfnr);
		fprintf(logfil,
			"\tws_inputspecnr=%hd\n",
			ws_inputspecnr);
		fprintf(logfil,
			"\tws_stepnr=%d\n",
			ws_stepnr);
		fprintf(logfil,
			"\tws_alderstr=%s\n",
			ws_alderstr);
	}
/* NYT 141010 PSFREDAGDEFAULTUDTID */
	aabenflag = check_bssaaben(-1,ws_station,ws_fradato,ws_fratid);
	if (logfil) {
		fprintf(logfil, "\taabenflag=%hd\n", aabenflag);
	}
	if (aabenflag<=0) {
		ws_don2errno = DON2PSLUKKET;
	}
	if (logfil) {
		fprintf(logfil,
			"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		retur = 0;
		goto afslut;
	}
	if (typestyr>0) {
		funkretur = dan_webapi_typegrpliste(1,ws_landekode);
		if (funkretur<=0) { goto afslut; }
	}
	if (logfil) {
		fprintf(logfil,"\tws_maxidxtypegrpliste=%d\n",
			ws_maxidxtypegrpliste);
	}
	ws_grpidx = -1;
	nuvidx2 = 0;
	while (nuvidx2<=ws_maxidxtypegrpliste) {
		funkretur = dan_ecwebapi_grpliste(1,
			ws_landekode,
			ws_typegrpliste[nuvidx2]);
		if (funkretur<=0) {
			nuvidx2++;
			continue;
		}
		(void)opbyg_grptab(ws_typegrpliste[nuvidx2]);
		if (logfil) {
			fprintf(logfil,"\t\tnuvidx2=%d ws_grpidx=%d\n",
				nuvidx2,
				ws_grpidx);
		}
		nuvidx2++;
	}
	wx1 = 0;
	while (logfil && wx1<=ws_grpidx) {
		fprintf(logfil,"\tws_grptab-%hd=%s\n",wx1,ws_grptab[wx1]);
		wx1++;
	}
	if (ws_grpidx>=0) {
		starttypeidx = 0;
		sluttypeidx = ws_grpidx;
	}

/* PS
	funkretur = dan_psgrptab(1,langstr,station);
	starttypeidx = -1;
	sluttypeidx = -1;
	wx1 = 0;
	while (wx1<ws_grpidx) {
		if (strncmp(ws_grptab[wx1]+2,ws_grp,3)==0 && starttypeidx==-1) {
			starttypeidx = wx1;
			sluttypeidx = wx1;
			strcpy(ws_biltype,ws_grp);
			strcpy(ws_grp,"");
		}
		if (strlen(ws_biltype) &&
			strncmp(ws_grptab[wx1]+2,ws_biltype,3)==0) {
			sluttypeidx = wx1;
		}
		wx1++;
	}
	wx1 = 0;
	while (wx1<ws_grpidx && !strlen(ws_biltype)) {
		sscanf(ws_grptab[wx1]+8,"%s",tmpstr);
		if (strcmp(tmpstr,ws_grp)==0 && starttypeidx==-1) {
			starttypeidx = wx1;
			sluttypeidx = wx1;
			sscanf(ws_grptab[wx1]+2,"%s",ws_biltype);
			break;
		}
		wx1++;
	}
*/
	if (logfil) {
		fprintf(logfil,
			"\tfunkretur=%hd\n",funkretur);
		fprintf(logfil,
			"\tws_grp=%s\n",ws_grp);
		fprintf(logfil,
			"\tws_biltype=%s\n",ws_biltype);
		fprintf(logfil,
			"\tstarttypeidx=%hd\n",starttypeidx);
		fprintf(logfil,
			"\tsluttypeidx=%hd\n",sluttypeidx);
	}
/* NYT 131209 BILTYPEFEJL */
	if (starttypeidx==-1 || sluttypeidx==-1) {
		ws_don2errno = DON2TPGRPUK;
	}
	if (logfil) {
		fprintf(logfil,
			"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		retur = 0;
		goto afslut;
	}

	returdato = m036_funktion(11, fradt);
	chkfradgnr = returdato%10;
	julian = m036_funktion(12, fradt);
        chkantaldg = m036_funktion(12, tildt);
	chkantaldg -= julian;
	kundevarighed = chkantaldg;

	if (dondafolo>0 && chkantaldg>14) {
		mintolerance = -2;
		maxtolerance = 2;
	}
	if (logfil) {
		fprintf(logfil, "\tkundevarighed=%ld\n", kundevarighed);
		fprintf(logfil, "\tchkantaldg=%ld\n", chkantaldg);
		fprintf(logfil, "\tchkfradgnr=%ld\n", chkfradgnr);
		fprintf(logfil, "\tmintolerance=%hd\n", mintolerance);
		fprintf(logfil, "\tmaxtolerance=%hd\n", maxtolerance);
	}
/*
	if (kundevarighed>29) {
		ws_don2errno = DON2MAXVAR29;
	}
	if (kundevarighed>29 && ws_station==52) {
		ws_don2errno = DON2LANGST52;
	}
	if (kundevarighed>29 && ws_station==53) {
		ws_don2errno = DON2LANGST53;
	}
	if (kundevarighed>29 && ws_station==61) {
		ws_don2errno = DON2LANGST61;
	}
	if (logfil) {
		fprintf(logfil,
			"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		ws_funkretur2 = frankly_err(ws_funktion,
			"fejl",ws_don2errno);
		retur = 0;
		goto mainloopstop;
	}
*/

	gemmintol = mintolerance;
	gemmaxtol = maxtolerance;
	blokfundet = 0;

	funkretur = check_minsalg(2,16625,station,ws_grp,fradt,tildt);
	if (funkretur>0) {
		if (logfil) {
			fprintf(logfil,
			"\t16625FUNDET %hd\n",funkretur);
			fprintf(logfil,
			"\tnum=%.0lf,alfa=%s\n",
			r198->numfelt,
			r198->alfafelt);
			fprintf(logfil,
			"\tchkantaldg=%ld\n",
			chkantaldg);
		}
	}
	if (funkretur>0) {
		(void)get_alfa_tgn(r198->alfafelt,0,tmpgrpliste,';');
		(void)get_alfa_tgn(r198->alfafelt,1,tmpferienavn,';');
		(void)get_alfa_tgn(r198->alfafelt,2,tmpdatointerval,';');
	}
	if (funkretur>0 && strcmp(tmpgrpliste,"*")==0) {
		blokfundet = 1;
		minperiode = (long int)r198->numfelt;
	}
/* NYT 131128 JUL2013 */
	if (funkretur>0 && strcmp(ws_grp,tmpgrpliste)==0) {
		blokfundet = 1;
		minperiode = (long int)r198->numfelt;
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,
			"\tblokfundet=%hd\n",blokfundet);
		fprintf(logfil,
			"\ttmpgrpliste=%s\n",tmpgrpliste);
		fprintf(logfil,
			"\ttmpferienavn=%s\n",tmpferienavn);
		fprintf(logfil,
			"\ttmpdatointerval=%s\n",tmpdatointerval);
		fprintf(logfil,
			"\tminperiode=%ld\n",minperiode);
	}
/* NYT 091102 */
	if (funkretur>0 && blokfundet==1 &&
		chkantaldg>=minperiode) {
		blokfundet = 0;
	}
	if (funkretur>0 && blokfundet==1) {
		fejlkode = -28;
	}
/*
	if (funkretur>0 &&
		blokfundet==1 &&
		r198->numfelt>0 &&
		chkantaldg<minperiode) {
		fejlkode = -28;
	}
*/
	log_stopur(82);
/* NYT 111110 DONAFLBLOK */
	if (blokfundet<=0) {
		funkretur = check_ecdon_aflblok(1,
			station,
			psgrp,
			fradt,
			tildt,
			tmpfelt);
	}
	if (blokfundet<=0 && funkretur>0) {
		fejlkode = -28;
		blokfundet = 1;
		strcpy(tmpferienavn,"DONAFLBLOK");
	}
	if (logfil) {
		fprintf(logfil,
			"AFLBLOK blokfundet=%hd\n",blokfundet);
		fprintf(logfil,
			"\ttmpferienavn=%s\n",tmpferienavn);
	}
/* NYT 120120 CHECK STOPSALG */
        funkretur = check_stopsalg(1,ws_station,ws_grp,ws_fradato,ws_tildato);
        if (funkretur>0) {
		fejlkode = -28;
		strcpy(tmpferienavn,"DONSTOPSALG");
        }
	if (fejlkode==-28 && strcmp(tmpferienavn,"st.bede")==0) {
		fejlkode = -29;
	}
	if (fejlkode==-28 && strcmp(tmpferienavn,"kr.him")==0) {
		fejlkode = -30;
	}
	if (fejlkode==-28 && strcmp(tmpferienavn,"pinse")==0) {
		fejlkode = -31;
	}
	if (fejlkode==-28 && strcmp(tmpferienavn,"jul")==0) {
		fejlkode = -32;
	}
	if (logfil) {
		fprintf(logfil,
			"\ttmpferienavn=%s\n",tmpferienavn);
		fprintf(logfil,
			"\tfejlkode=%hd\n",fejlkode);
	}
	if (fejlkode!=0 && strlen(tmpdatointerval)) {
		sprintf(ws_differrormess,
"Der kan ikke bookes enkelte dage i perioden %s. Kontakt derfor nærmeste udlejningssted på tlf.%s.",
			tmpdatointerval,
			"7011 4455");
	}
/* NYT 131128 JUL2013 */
	if (fejlkode!=0 && strlen(tmpdatointerval) && fejlkode==-32) {
		sprintf(ws_differrormess,
			"Julen 2013: %s.",
			tmpdatointerval);
/*
		sprintf(ws_differrormess,
			"Julen 2013: Enkelte dage kan ikke bookes %s.",
			tmpdatointerval);
*/
	}
/* NYT 111110 DONAFLBLOK */
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONAFLBLOK")==0) {
		sprintf(ws_differrormess,
"Det er ikke muligt at aflevere denne dag. Prøv venligst en anden afleveringsdag eller kontakt os på tlf.%s.",
			"7011 4455");
	}
/* NYT 111114 DONPRODHENVIS */
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONPRODHENV01")==0 &&
		strcmp(langstr,"EN")!=0) {
		sprintf(ws_differrormess,
"Ved billeje på denne periode (%ld dage) er det prisen på 30 dage som bedst kan betale sig. Ret dato til 30 dage og prøv venligst igen.",chkantaldg);
	}
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONPRODHENV01")==0 &&
		strcmp(langstr,"EN")==0) {
		sprintf(ws_differrormess,
"The price for 30 days is cheaper than the chosen rental period (%ld days). Please change the period to 30 days.",chkantaldg);
	}
/* NYT 120119 DONPRODHENVIS */
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONPRODHENV02")==0 &&
		strcmp(langstr,"EN")!=0) {
		sprintf(ws_differrormess,
			"Ring %s for et leasing-tilbud.",ws_sttlfnr);
	}
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONPRODHENV02")==0 &&
		strcmp(langstr,"EN")==0) {
		sprintf(ws_differrormess,
			"Please call %s for a long term offer.",ws_sttlfnr);
	}
/* NYT 120120 DONSTOPSALG */
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONSTOPSALG")==0 &&
		strcmp(langstr,"EN")!=0) {
		sprintf(ws_differrormess,
			"Problemer med at booke. Ring evt. til %s.",
				ws_sttlfnr);
	}
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONSTOPSALG")==0 &&
		strcmp(langstr,"EN")==0) {
		sprintf(ws_differrormess,
			"Booking error. Please call %s.",ws_sttlfnr);
	}
	if (fejlkode!=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)fejlkode);
		web_errormess(0,ws_langstr,"28");
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		return(0);
	}
	funkretur = dan_ecxlsprodmatchtabel(1,kundevarighed);
	if (logfil) {
		fprintf(logfil,"\tECXLSPRODMATCH funkretur=%d\n",funkretur);
	}
	if (funkretur<=0) {
		ws_don2errno = DON2PRODUK;
	}
//	if (funkretur<=0 && ws_tiltid>700) {
//		ws_don2errno = DON2PRODUKTID;
//	}

	if (logfil) {
		fprintf(logfil,
			"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
//		ws_funkretur2 = frankly_err(ws_funktion,
//			"fejl",ws_don2errno);
		retur = 0;
		goto mainloopstop;
	}
	xlsprodidx = -1;
mainprodukt:
	xlsprodidx++;
	if (logfil) {
		fprintf(logfil,"MAINPRODUKT xlsprodidx=%hd\n",xlsprodidx);
	}
	if (xlsprodidx>MAXXLSPRODMATCH) {
		goto mainprodstop;
	}
	if (ws_xlsprodmatchtabel[xlsprodidx]<=0) {
		goto mainprodstop;
	}
	reclow(r165,R165);
	f165_start(1,ISGTEQ);
	mainloopidx = starttypeidx;
mainloop00:
	if (mainloopidx>=ws_grpidx) {
		goto mainloopstop;
	}
	if (mainloopidx>sluttypeidx) {
		goto mainloopstop;
	}
	sscanf(ws_grptab[mainloopidx],"%s %s",nuvbiltype,ws_grp);
/* NYT 150526 GRP */
	if (strlen(ws_inpgrp) && strcmp(ws_grp,ws_inpgrp)!=0) {
		goto mainloopvidere;
	}

mainloop01:
	chkalderfra = -1;
	chkaldertil = -1;
// ECALDER
//	if (strlen(ws_grpaldertab[mainloopidx])) {
//		sscanf(ws_grpaldertab[mainloopidx],"%hd",&chkalderfra);
//		chkaldertil = 999;
//	}
//	if (strlen(ws_alderstr)) {
//		sscanf(ws_alderstr,"%hd",&kundealder);
//	}
	if (logfil) {
		fprintf(logfil,"MAINLOOP01 mainloopidx=%hd\n",mainloopidx);
		fprintf(logfil,"\t\tws_grp=%s\n",ws_grp);
		fprintf(logfil,"\t\tws_biltype=%s\n",ws_biltype);
//		fprintf(logfil,"\t\tws_specnr=%hd\n",ws_specnr);
		fprintf(logfil,"\t\tws_grpxtab=%s\n",
			ws_grpxtab[mainloopidx]);
		fprintf(logfil,"\t\tws_grpaldertab=%s\n",
			ws_grpaldertab[mainloopidx]);
		fprintf(logfil,"\t\tchkalderfra-til=%hd-%hd\n",
			chkalderfra,chkaldertil);
		fprintf(logfil,"\t\tws_alderstr=%s\n",
			ws_alderstr);
		fprintf(logfil,"\t\tkundealder=%hd\n",
			kundealder);
		fprintf(logfil,"\t\tws_paiflag=%hd\n",
			ws_paiflag);
	}
	wx1 = 1;
//	wx1 = 0;
//	if (kundealder>=chkalderfra && kundealder<=chkaldertil) {
//		wx1 = 1;
//	}
	if (logfil) {
		fprintf(logfil,"\t\tALDERCHECK wx1=%hd\n", wx1);
	}
	if (wx1<=0) {
		ws_alderblok++;
		mainloopidx++;
		goto mainloop00;
	}
	xlsprisflag = 1;
	if (xlsprisflag>0) {
		ws_specnr = (short int)ws_xlsprodmatchtabel[xlsprodidx];
		ws_maxindtid = (long int)ws_xlsprodmatchindtidtabel[xlsprodidx];
		sprintf(produktkode,"%hd",ws_specnr);
	}
	if (logfil) {
		fprintf(logfil,"\t\tws_specnr=%hd (%s)\n",
			ws_specnr,produktkode);
	}
/* NYT 140513 PSSENEREAFLTID */
	ws_psextradag = 0;
	kundefratid = ws_fratid;
	kundetiltid = ws_tiltid;
/*
	if (ws_maxindtid>0 && kundetiltid>ws_maxindtid) {
		ws_psextradag = 1;
	}
*/
	produktfradato = ws_fradato;
	produkttildato = ws_tildato;
	produktfratid = ws_fratid;
	produkttiltid = ws_tiltid;
	produktvarighed = kundevarighed;
/* NYT 141022 */
	ws_altfradato = 0;
	ws_altfratid = 0;
	ws_alttildato = 0;
	ws_alttiltid = 0;
/* NYT 140724 PSWEEKENDMATCH */
	if (xlsprisflag>0 && strlen(ws_xlsprodmatchtidopl[xlsprodidx])) {
               	get_alfa_tgn(ws_xlsprodmatchtidopl[xlsprodidx],0,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&produktfradato);
		}
               	get_alfa_tgn(ws_xlsprodmatchtidopl[xlsprodidx],1,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&produktfratid);
		}
               	get_alfa_tgn(ws_xlsprodmatchtidopl[xlsprodidx],2,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&produkttildato);
		}
               	get_alfa_tgn(ws_xlsprodmatchtidopl[xlsprodidx],3,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&produkttiltid);
		}
               	get_alfa_tgn(ws_xlsprodmatchtidopl[xlsprodidx],4,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&produktvarighed);
		}
		ws_altfradato = produktfradato;
		ws_altfratid = produktfratid;
		ws_alttildato = produkttildato;
		ws_alttiltid = produkttiltid;
	}
	if (xlsprisflag>0 && !strlen(ws_xlsprodmatchtidopl[xlsprodidx])) {
		ws_altfratid = ws_fratid;
	}

	sprintf(produkttekst,"Testrate grp.%s - %ld dage",
		ws_grp,
		produktvarighed);
	if (produktvarighed==1) {
		sprintf(produkttekst,"Testrate grp.%s - %ld dag",
			ws_grp,
			produktvarighed);
	}
	sprintf(produktincl,"incl. xxxx");
/* NYT 140306 PSPRODUKTINKL */
	sprintf(produktincl,"inkl. moms, forsikring (selvrisiko) og");

	if (logfil) {
		fprintf(logfil,"MAINBUND mainloopidx=%hd\n",mainloopidx);
		fprintf(logfil,"\t\tproduktfradato=%ld\n",produktfradato);
		fprintf(logfil,"\t\tprodukttildato=%ld\n",produkttildato);
		fprintf(logfil,"\t\tproduktvarighed=%ld\n",produktvarighed);
		fprintf(logfil,"\t\tkundevarighed=%ld\n",kundevarighed);
		fprintf(logfil,"\t\tkundefratid=%ld\n",kundefratid);
		fprintf(logfil,"\t\tkundetiltid=%ld\n",kundetiltid);
		fprintf(logfil,"\t\txlsprisflag=%d\n",xlsprisflag);
		fprintf(logfil,"\t\tws_maxindtid=%ld\n",ws_maxindtid);
		fprintf(logfil,"\t\tws_altfradato=%ld\n",ws_altfradato);
		fprintf(logfil,"\t\tws_altfratid=%ld\n",ws_altfratid);
		fprintf(logfil,"\t\tws_alttildato=%ld\n",ws_alttildato);
		fprintf(logfil,"\t\tws_alttiltid=%ld\n",ws_alttiltid);
		fprintf(logfil,"\t\tws_psextradag=%d\n",ws_psextradag);
	}
	r159->station_ud_nr = ws_station;
	r159->station_ind_nr = ws_tilstation;

	r159->dato_ud = produktfradato;
	r159->forv_dato_ind = produkttildato;
	r159->tid_ud = produktfratid;
	r159->forv_tid_ind = produkttiltid;

	funkretur = nyopret_reservation(0,0,1);
	if (logfil) {
		fprintf(logfil,
		"\t\tNYOPRET_RESERVATION:funkretur=%hd\n",
			funkretur);
		fprintf(logfil,
		"\t\tr159->total=%.2lf\n",
			r159->total);
	}
/* NYT 150527 GRPPRODUKTIKKEFUNDET */
	if (funkretur<=0) { goto mainloopvidere; }



/* NYT 140218 XLSPRIS */
	if (xlsprisflag>0) {
		sprintf(produkttekst,"%s-%ld dage",
			r159->rate_tekst[0],
			produktvarighed);
	}
	if (xlsprisflag>0 && produktvarighed==1) {
		sprintf(produkttekst,"%s-%ld dag",
			r159->rate_tekst[0],
			produktvarighed);
	}
/*
	add_prislinie(0,
		produktvarighed,
		0,
		ws_station,
		810,
		ws_grp,
		1,
		0);

	udregn_kontrakt((short int)0,
		(short int)0,
		(long int)0,
		(long int)0);
*/
/* NYT 131211 PSSNYDTID */
	r159->forv_tid_ind = produkttiltid;

/* NYT 140425 ECXLSMAINCHECK UDTID TIDUD */
	sprintf(tmpstr, "EC%5.5hd%5.5hdSTD.main",
		ws_station,
		r159->rate_spec_nr[0]);
	funkretur = xlspris_udpakmain(tmpstr);
	if (logfil) {
		fprintf(logfil,"\t\tECXLSMAINCHECK funkretur=%d\n",funkretur);
		fprintf(logfil,"\t\t\txlsprismain->udtid=%ld",
			xlsprismain->udtid);
	}
/* NYT 150527 GRPPRODUKTIKKEFUNDET */
	if (funkretur<=0) { goto mainloopvidere; }

	if (logfil) {
		fprintf(logfil,"\t\trate_spec_nr-0=%hd\n",
			r159->rate_spec_nr[0]);
		fprintf(logfil,"\t\trate_gruppe-0=%s\n",
			r159->rate_gruppe[0]);
		fprintf(logfil,"\t\trate_antal-0=%ld\n",
			r159->rate_antal[0]);
		fprintf(logfil,"\t\trate_pris-0=%lf\n",
			r159->rate_pris[0]);
		fprintf(logfil,"\t\ttotal=%lf\n",r159->total);
		fprintf(logfil,"\t\tpai_ialt=%lf\n",r159->pai_ialt);
		fprintf(logfil,"\t\tforv_tid_ind=%ld\n",r159->forv_tid_ind);
		fprintf(logfil,"\t\ttid_ud=%ld\n",r159->tid_ud);
	}
/* NYT 140901 PSMBIDRAGPRODUKTINKL */
	ege_w_int1 = 0;
	wx1 = 0;
	while (wx1<10) {
		if (r159->rate_spec_nr[wx1]==944) { ege_w_int1++; }
		wx1++;
	}
	if (ege_w_int1>0) {
		sprintf(produktincl,
		"inkl. moms, miljøbidrag, forsikring (selvrisiko) og");
	}
	if (logfil) {
		fprintf(logfil,"\t\tproduktincl=<%s>\n",produktincl);
	}
	alfalow(str);
	pack_init(str);

	sprintf(tmpstr,"%hd-%s",r159->rate_spec_nr[0],ws_grp);
	pack_alfa(tmpstr);
	(void)retur_ecwebapi_data(109,ws_grp,modelstr);
	sprintf(tmpstr,"model%s(%s)",ws_grp,modelstr);
	pack_alfa(tmpstr);
	strcpy(tmpstr,nuvbiltype);
	pack_alfa(tmpstr);
	sprintf(tmpstr,"image-%s.jpg",ws_grp);
	pack_alfa(tmpstr);

/* Pris */
	ege_w_dou1 = r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

/* KampagnePris = det samme */
	ege_w_dou1 = r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
/* UDDATO/TID ws_station */
	pack_int2((long)ws_station);
/* NYT 150615 LOKATIONUDNAVN */
	pack_alfa(r159->station_ud_navn);

	ege_w_int1 = m036_funktion(17,(long int)r159->dato_ud);
	sprintf(tmpstr,"%8.8ld",ege_w_int1);
	pack_alfa(tmpstr);
	sprintf(tmpstr,"%4.4ld",r159->tid_ud);
	pack_alfa(tmpstr);

/* INDDATO/TID */
	pack_int2((long)ws_tilstation);
/* NYT 150615 LOKATIONINDNAVN */
	pack_alfa(r159->station_ind_navn);

	ege_w_int1 = m036_funktion(17,(long int)r159->forv_dato_ind);
	sprintf(tmpstr,"%8.8ld",ege_w_int1);
	pack_alfa(tmpstr);
	sprintf(tmpstr,"%4.4ld",r159->forv_tid_ind);
	pack_alfa(tmpstr);
/* NYT 150505 ACRISSKODE */
	strcpy(tmpstr,"????");
	find_acriss_kode(ws_grp,tmpstr);
	pack_alfa(tmpstr);
/* NYT 150602 BOOKFLOWJUST1 */
	sprintf(tmpstr,"%hd",r159->rate_spec_nr[0]);
	pack_alfa(tmpstr);
	sprintf(tmpstr,"%s",r159->rate_tekst[0]);
	pack_alfa(tmpstr);
	pack_alfa(ws_grp);

/* NYT 150710 ECWBOOKSTATUS */
	ws_ecbookstatus = retur_ecw_bookstatus(1,
		ws_landekode,
		ws_station,
		ws_grp,
		r159->dato_ud,
		produktvarighed,
		tmpstr);
	if (logfil) {
		fprintf(logfil,"\t\tECWBOOKSTATUS ws_requestflag=%d (%s)\n",
			ws_requestflag,
			tmpstr);
		fprintf(logfil,"\t\t\tws_ecbookstatus=%hd\n",
			ws_ecbookstatus);

	}
	pack_int2((long)ws_ecbookstatus);
	pack_alfa(tmpstr);

	sprintf(tmpstr,"CarOptionList");
	pack_alfa(tmpstr);
 	pack_del();
	add_webapi_biloptionliste(1,ws_grp);

#ifdef egetest
	pack_int2((long)r159->station_ud_nr);
	pack_alfa(ws_biltype);
	pack_alfa(ws_grp);
	pack_int2((long)r159->station_ind_nr);

	ege_w_int1 = m036_funktion(17,(long int)r159->dato_ud);
	sprintf(tmpstr,"%8.8ld",ege_w_int1);
	pack_alfa(tmpstr);

	ege_w_int1 = m036_funktion(17,(long int)r159->forv_dato_ind);
	sprintf(tmpstr,"%8.8ld",ege_w_int1);
	pack_alfa(tmpstr);

	sprintf(tmpstr,"%4.4ld",r159->tid_ud);
	pack_alfa(tmpstr);

	sprintf(tmpstr,"%4.4ld",r159->forv_tid_ind);
	pack_alfa(tmpstr);

/* varighed */
	ege_w_int1 = produktvarighed;
	if (ws_psextradag>0) {
		ege_w_int1++;
	}
/* NYT 141021 PSWEEKENDVARIGHEDJUSTERING */
/* OBS CHECK OM FULD WEEKENDPRODUKT */
	altproduktvarighed = 0;

	if (ws_fradato>0) {
		kundefdatotid = (double)ws_fradato;
		kundefdatotid *= 10000;
		kundefdatotid += (double)ws_fratid;
	}
	if (ws_tildato>0) {
		kundetdatotid = (double)ws_tildato;
		kundetdatotid *= 10000;
		kundetdatotid += (double)ws_tiltid;
	}
	if (ws_altfradato>0) {
		prodfdatotid =(double) ws_altfradato;
		prodfdatotid *= 10000;
		prodfdatotid += (double)ws_altfratid;
	}
	if (ws_alttildato>0) {
		prodtdatotid = (double)ws_alttildato;
		prodtdatotid *= 10000;
		prodtdatotid += (double)ws_alttiltid;
	}
	if (logfil) {
		fprintf(logfil,
			"\t\tPSVARIGHED-1 kundedatotid %12.0lf-%12.0lf\n",
			kundefdatotid,
			kundetdatotid);
		fprintf(logfil,
			"\t\tproddatotid %12.0lf-%12.0lf\n",
			prodfdatotid,
			prodtdatotid);
		fprintf(logfil,
			"\t\taltproduktvarighed=%hd\n",altproduktvarighed);
	}

/*
		ws_altfradato = produktfradato;
		ws_altfratid = produktfratid;
		ws_alttildato = produkttildato;
		ws_alttiltid = produkttiltid;
*/
	if (altproduktvarighed>0 && kundevarighed<produktvarighed) {
		ege_w_int1 = kundevarighed;
	}
	pack_int2((long)ege_w_int1);
/* prodid */
	pack_alfa(produktkode);
/* prodtekst */
/* NYT 140423 PRODUKTNAVN */
/*
	strcpy(tmpstr,produkttekst);
*/
/* NYT 140820 PSUPDATEPRODNAVN */
	(void)opbyg_psproduktnavn(mainloopidx,produktkode,tmpstr);

/* RETTET 140820 PSUPDATEPRODNAVN
	(void)get_alfa_tgn(ws_grpxtab[mainloopidx],0,tmpstr,';');
	if (strcmp(produktkode,"801")==0) {
		strcat(tmpstr,"-weekend");
	}
	if (ws_psextradag>0) {
		strcat(tmpstr,"(+1)");
	}
*/

	pack_alfa(tmpstr);
/* prodincl */
	pack_alfa(produktincl);
/* prodfilref */
	sprintf(tmpstr,"stdbil.jpg");
/* NYT 140409 */
/*
	sprintf(tmpstr,"./Bilgrupper/grp%s.jpg",ws_grp);
	sprintf(tmpstr,"./Bilgrupper/%s.jpg",ws_grp);
	sprintf(tmpstr,"%s.jpg",ws_grp);
*/
	sprintf(tmpstr,"grp%s.jpg",ws_grp);
/* NYT 140411 GRPPLUS */
	if (ws_grp[1]=='+') {
		tmpstr[4] = '\0';
		strcat(tmpstr,"plus.jpg");
	}
	ege_tolower((unsigned char *)tmpstr);
	pack_alfa(tmpstr);

/* Incl.Km */
	pack_int2((long)r159->rate_incl_km[10]);
/* Pris.Extra.Km */
/*	pack_doub(r159->rate_ekstra_km[10]); */
	ege_w_dou1 = r159->rate_ekstra_km[10];
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
/* selvrisiko */
	(void)add_divpligtopl(1,ws_grp);
/* RETTET 140509
	sprintf(tmpstr,"Selvrisiko DKK 3.500.");
	pack_alfa(tmpstr);
*/

/* afhtekst */
	sprintf(tmpstr,"Medbring kørekort ved afhentning og evt.booknr.");
	pack_alfa(tmpstr);
/* afltekst */
	sprintf(tmpstr,"Spar omk. ved at aflevere med fuld tank.");
	pack_alfa(tmpstr);
/* lokketekst TEASER */
	sprintf(tmpstr,"Dagsprisen falder, når perioden stiger...");
/* TEST 140327 */
	if (produktvarighed==1) {
		strcpy(tmpstr,"");
	}
/* NYT 140723 PSNOTEASER */
	strcpy(tmpstr,"");
/* NYT 140725 PSWEEKENDMATCH */
	(void)opbyg_teasertekst(xlsprodidx,tmpstr);

	pack_alfa(tmpstr);

/* NYT 140401 OBS PSREQUEST */
	ws_requestflag = 0;
/* RETTET 140416
	if (strcmp(ws_grp,"F")==0) {
		ws_requestflag = 1;
	}
*/

/* REQUEST
	ws_psbookstatus = 1;
	ws_requestflag = check_requestflag(0,produktvarighed);
	if (ws_requestflag>0) {
		ws_psbookstatus = 2 + ws_requestflag;
	}
	if (logfil) {
		fprintf(logfil,
	"\tPSREQUEST check_requestflag ws_requestflag=%d ws_psbookstatus=%d\n",
			ws_requestflag,
			ws_psbookstatus);
	}
	ws_requestflag = check_requeststyr(1,
		ws_station,
		ws_biltype,
		ws_grp,
		r159->dato_ud);
	if (ws_requestflag>0) {
		ws_psbookstatus = 2 + ws_requestflag;
	}
	if (logfil) {
		fprintf(logfil,
	"\tPSREQUEST check_requeststyr ws_requestflag=%d ws_psbookstatus=%d\n",
			ws_requestflag,
			ws_psbookstatus);
	}
	pack_int2((long)ws_psbookstatus);
	sprintf(tmpstr,"Ok");
	if (ws_psbookstatus==3) {
		sprintf(tmpstr,"Request");
	}
	if (ws_psbookstatus==4) {
		sprintf(tmpstr,"Request m. nr");
	}
	pack_alfa(tmpstr);
*/

/* pris pr dag PrisPrDag */
	ege_w_int1 = produktvarighed;
/* NYT 141021 PSWEEKENDVARIGHEDJUSTERING */
/* OBS CHECK OM FULD WEEKENDPRODUKT */


	if (altproduktvarighed>0 && kundevarighed<produktvarighed) {
		ege_w_int1 = kundevarighed;
	}
	if (logfil) {
		fprintf(logfil,
	"\tECVARIGHED-2 produktvarighed=%ld kundevarighed=%ld ege_w_int1=%ld\n",
			produktvarighed,
			kundevarighed,
			ege_w_int1);
	}
	ege_w_dou1 = r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
	ege_w_dou1 /= (double)ege_w_int1;
/*	pack_doub(ege_w_dou1); */
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

	(void)add_psbetalinginfo(1,produktkode,produktvarighed);

/* Ekstra */
	sprintf(tmpstr,"Ekstraudstyrsliste");
	pack_alfa(tmpstr);
	sscanf(produktkode,"%hd",&ws_specnr);
	(void)init_extraptab(1);
 	pack_del();
	extraretur = send_extraptab(2,produktvarighed);
#endif

	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil,"SENDT:%s",str);
		fflush(logfil);
	}
	retur++;
mainloopvidere:
/* NULSTIL DIV FELTER */
	ws_paiflag = 0;

	if (logfil) {
		fprintf(logfil,"\tMAINLOOPBUND\n");
		fprintf(logfil,"\t\tws_paiflag=%hd\n",ws_paiflag);
	}

	mainloopidx++;
	goto mainloop00;
mainloopstop:
	if (logfil) {
		fprintf(logfil, "\tMAINLOOPSTOP\n");
	}
	if (mainloopidx>0) {
		goto mainprodukt;
	}
mainprodstop:
	if (logfil) {
		fprintf(logfil, "\tws_alderblok=%d\n", ws_alderblok);
	}
afslut:
	if (logfil) {
		fprintf(logfil, "send_ecmatch_prodliste:retur=%hd\n", retur);
		fflush(logfil);
	}
	return(retur);
}

/* NYT 150706 ECWBOOKSTATUS */
/* *************************************************************** */
static int retur_ecw_bookstatus(int inpfunk,char *inplandekode,int inpstnr,char *inpgrp,long inpdatoud,long inpvar,char *returstr) {
	int retur = 1;
	int fundet = 0;
	short int udldkfrgspg = 0;
	long int varighed = 0;
	char reqtxt[81] = "ok";

	if (logfil) {
		fprintf(logfil,"retur_ecw_bookstatus %d %s %d %s %ld %ld\n",
			inpfunk,
			inplandekode,
			inpstnr,
			inpgrp,
			inpdatoud,
			inpvar);
		fflush(logfil);
	}
	ws_requestflag = 0;
	if (strcmp(inplandekode,"DK")!=0) { goto udl00; }
	fundet = check_ecwebapi_reqstgrp(1,(int)inpstnr,inpgrp);
	if (fundet>0) {
		ws_requestflag = 1;
		strcpy(reqtxt,"forespørgsel");
	}
	goto afslut;
udl00:
	ws_udldkflag = 1;
	if (ws_udldkflag>0 && ws_udldkfrgspg<0) {
		udldkfrgspg = udldk_checkfrgspg(1,
			"",
			inpgrp,
			inpvar,
			ws_systemdato,
			ws_systemtid);
	}
	if (logfil) {
		fprintf(logfil,"\tudldkfrgspg=%hd\n",udldkfrgspg);
	}
	if (udldkfrgspg>0) {
		ws_requestflag = 2;
		sprintf(reqtxt,"forespørgsel (svar indenfor %hd timer)",
			udldkfrgspg);
	}
afslut:
	if (ws_requestflag>0) {
		retur = 2 + ws_requestflag;
	}
	strcpy(returstr,reqtxt);
	if (logfil) {
		fprintf(logfil,"retur_ecw_bookstatus retur=%d (%s)\n",
			retur,returstr);
		fflush(logfil);
	}
	return(retur);
}

/* NYT 150326 WEBAPI27 */
/* *********************************************** */
static int send_webapi_biler(int inpfunk) {
	int retur = 0;
	int funkretur = 0;
	int okflag = 1;
	int nuvidx = 0;
	int nuvidx2 = 0;
	int typestyr = 1;
	int grpstyr = 1;
	double pris1 = 0;
	double pris2 = 0;
	char tmpstr[81] = "";
	char nuvbiltype[41] = "";
	char modelstr[41] = "";

	if (logfil) {
		fprintf(logfil,"send_webapi_biler %d\n",inpfunk);
		fprintf(logfil,"\tws_landekode=%s\n",ws_landekode);
		fprintf(logfil,"\tws_station=%hd\n",ws_station);
		fprintf(logfil,"\tws_fradato=%8.8ld\n",ws_fradato);
		fprintf(logfil,"\tws_fratid=%4.4ld\n",ws_fratid);
		fprintf(logfil,"\tws_tilstation=%hd\n",ws_tilstation);
		fprintf(logfil,"\tws_tildato=%8.8ld\n",ws_tildato);
		fprintf(logfil,"\tws_tiltid=%4.4ld\n",ws_tiltid);
		fprintf(logfil,"\tws_biltype=%s\n",ws_biltype);
	}
	if (typestyr>0) {
		funkretur = dan_webapi_typegrpliste(1,ws_landekode);
		if (funkretur<=0) { goto afslut; }
		nuvidx2 = 0;
		goto typeloop01;
	}
	if (grpstyr>0) {
		funkretur = dan_webapi_grpliste(1,ws_landekode);
		if (funkretur<=0) { goto afslut; }
		goto grpsend01;
	}
	if (typestyr<=0) { goto grpsend01; }
	nuvidx2 = 0;
typeloop01:
	if (nuvidx2>ws_maxidxtypegrpliste) { goto afslut; }
	funkretur = dan_webapi_grpliste(1,ws_landekode);
	if (funkretur<=0) {
		nuvidx2++;
		goto typeloop01;
	}
	strcpy(nuvbiltype,ws_typegrpliste[nuvidx2]);
	if (strlen(ws_biltype) && strcmp(ws_biltype,nuvbiltype)!=0) {
		nuvidx2++;
		goto typeloop01;
	}
grpsend01:
	nuvidx = 0;
	while (grpstyr>0 && nuvidx<=ws_maxidxgrpliste) {
		alfalow(str);
		pack_init(str);
		sprintf(tmpstr,"671-%s",ws_grpliste[nuvidx]);
		pack_alfa(tmpstr);
		(void)retur_ecwebapi_data(109,ws_grpliste[nuvidx],modelstr);
		sprintf(tmpstr,"model%s(%s)",ws_grpliste[nuvidx],modelstr);
		pack_alfa(tmpstr);
/*
		(void)retur_ecwebapi_data(1,nuvbiltype,tmpstr);
*/
		strcpy(tmpstr,nuvbiltype);
		pack_alfa(tmpstr);
		sprintf(tmpstr,"image-%s.jpg",ws_grpliste[nuvidx]);
		pack_alfa(tmpstr);
		pris1 = 1000;
		pris1 += (double)nuvidx;
		ege_w_dou1 = pris1;
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);
		pris2 = pris1;
		pris2 -= 100;
		ege_w_dou1 = pris2;
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);
/* UDDATO/TID ws_station */
		pack_int2((long)ws_station);
		ege_w_int1 = m036_funktion(17,(long int)ws_fradato);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		pack_alfa(tmpstr);
		sprintf(tmpstr,"%4.4ld",ws_fratid);
		pack_alfa(tmpstr);

/* INDDATO/TID */
		pack_int2((long)ws_tilstation);
		ege_w_int1 = m036_funktion(17,(long int)ws_tildato);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		pack_alfa(tmpstr);
		sprintf(tmpstr,"%4.4ld",ws_tiltid);
		pack_alfa(tmpstr);
/* NYT 150505 ACRISSKODE */
		strcpy(tmpstr,"????");
		find_acriss_kode(ws_grpliste[nuvidx],tmpstr);
		pack_alfa(tmpstr);

		sprintf(tmpstr,"CarOptionList");
		pack_alfa(tmpstr);
 		pack_del();
		add_webapi_biloptionliste(1,ws_grpliste[nuvidx]);

		pack_exchkend();
		send_linie();
		nuvidx++;
		retur++;
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
	if (typestyr>0) {
		nuvidx2++;
		goto typeloop01;
	}

afslut:
	if (logfil) {
		fprintf(logfil,"send_webapi_biler retur=%d\n",retur);
	}
	return(retur);
}

/* NYT 150505 ACRISSKODE */
/* **************************************** */
static int find_acriss_kode(char *inpgrp,char* returstr) {
	int retur = 0;
	int idx = 0;
	int antal = 0;
	char matchtab[2][21] = {"",""};

	if (logfil) {
		fprintf(logfil,"find_acriss_kode <%s>\n",inpgrp);
	}
	reclow(r198, R198);
	r198->oplkode = 16819;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) { antal = -1; }
	while (antal>=0 && antal<=2) {
		egeread(f198, ISNEXT);
		if (f198_eof) { break; }
		if (r198->oplkode > 16819) { break; }
		if (strcmp(r198->alfafelt,inpgrp)!=0) { continue; }
		idx = (int)r198->numfelt;
		if (idx>=0 && idx<=1) {
			strcpy(matchtab[idx],r198->keyalfa);
			antal++;
		}
	}
	if (logfil) {
		fprintf(logfil,"\tantal=%d\n",antal);
	}
	if (retur==0 && antal>0 && strlen(matchtab[1])) {
		strcpy(returstr,matchtab[1]);
		retur = 1;
	}
	if (retur==0 && antal>0 && strlen(matchtab[0])) {
		strcpy(returstr,matchtab[0]);
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"find_acriss_kode retur=%d\n",retur);
	}
	return(retur);
}

/* **************************************** */
static int add_webapi_biloptionliste(int inpfunk,char *inpgrp) {
	int retur = 0;
	char tmpstr[81] = "";
	int optnr = 0;
	char optnavn[81] = "";
	char optvalue[81] = "";
	char opticon[81] = "";

	optnr = 8;
/* RETTET 150602 BOOKFLOWJUST1
	optnr = 1;
*/
	strcpy(optnavn,"minimum alder");
	strcpy(optvalue,"23");
	strcpy(opticon,"TEXT");
	pack_alfa(optnavn);
	(void)retur_ecwebapi_data(108,inpgrp,optvalue);
	pack_alfa(optvalue);
	pack_alfa(opticon);
/* NYT 150513 OPTIONID */
	sprintf(tmpstr,"%d",optnr);
	pack_alfa(tmpstr);
	retur++;

/* RETTET 150602 BOOKFLOWJUST1 MANGLER WEBSTYRING */
#ifdef egetest
	optnr = 2;
	strcpy(optnavn,"sæder");
	strcpy(optvalue,"5");
	strcpy(opticon,"persons.jpg");
	pack_alfa(optnavn);
//	(void)retur_ecwebapi_data(109,inpgrp,optvalue);
	pack_alfa(optvalue);
	pack_alfa(opticon);
/* NYT 150513 OPTIONID */
	sprintf(tmpstr,"%d",optnr);
	pack_alfa(tmpstr);
	retur++;
#endif

/* RETTET 150602 BOOKFLOWJUST1 MANGLER WEBSTYRING */
#ifdef egetest
	optnr = 3;
	strcpy(optnavn,"transmission");
	strcpy(optvalue,"Manuel transmission");
	strcpy(opticon,"transmission.jpg");
	pack_alfa(optnavn);
	(void)retur_ecwebapi_data(101,inpgrp,optvalue);
	pack_alfa(optvalue);
	pack_alfa(opticon);
/* NYT 150513 OPTIONID */
	sprintf(tmpstr,"%d",optnr);
	pack_alfa(tmpstr);
	retur++;
#endif

	optnr = 3;
/* RETTET 150602 BOOKFLOWJUST1
	optnr = 4;
*/
	strcpy(optnavn,"suitcases");
	strcpy(optvalue,"1");
	strcpy(opticon,"suitcase.jpg");
	pack_alfa(optnavn);
	(void)retur_ecwebapi_data(103,inpgrp,optvalue);
	pack_alfa(optvalue);
	pack_alfa(opticon);
/* NYT 150513 OPTIONID */
	sprintf(tmpstr,"%d",optnr);
	pack_alfa(tmpstr);
	retur++;

	optnr = 2;
/* RETTET 150602 BOOKFLOWJUST1
	optnr = 5;
*/
	strcpy(optnavn,"doors");
	strcpy(optvalue,"2-4");
	strcpy(opticon,"door.jpg");
	pack_alfa(optnavn);
	(void)retur_ecwebapi_data(102,inpgrp,optvalue);
	pack_alfa(optvalue);
	pack_alfa(opticon);
/* NYT 150513 OPTIONID */
	sprintf(tmpstr,"%d",optnr);
	pack_alfa(tmpstr);
	retur++;

	optnr = 7;
/* RETTET 150602 BOOKFLOWJUST1
	optnr = 6;
*/
	strcpy(optnavn,"co2");
	strcpy(optvalue,"125 g/km");
	strcpy(opticon,"emission.jpg");
	pack_alfa(optnavn);
	(void)retur_ecwebapi_data(107,inpgrp,optvalue);
	pack_alfa(optvalue);
	pack_alfa(opticon);
/* NYT 150513 OPTIONID */
	sprintf(tmpstr,"%d",optnr);
	pack_alfa(tmpstr);
	retur++;

	return(retur);
}

/* ******************************* */
static int opbyg_grptab(char *inptype) {
	int retur = 0;
	int nuvidx = 0;

	while (nuvidx<=ws_maxidxgrpliste) {
		ws_grpidx++;
		sprintf(ws_grptab[ws_grpidx],"%s %s",
			inptype,ws_grpliste[nuvidx]);
		nuvidx++;
		retur++;
	}
	return(retur);
}

/* **************************************** */
static int dan_webapi_typegrpliste(int inpfunk,char *inplandekode) {
	int retur = 0;
	int nuvidx = 0;
	int lnnr = 0;
	int okflag = 0;
	int grpidx = 0;
	int udllink = -1;
	int sortfunk = 1;
	int sortantal = 0;
	int undtagelsesflag = 0;
	char idstr[21] = "";
	char sortgrp[21] = "";
	char sortbuffer[201] = "";
	char tmpstr[81] = "";
	char returstr[81] = "";
	char filsti[81] = "";
	char inpstr[501] = "";
	FILE * tmpfil;

	tmpfil = (FILE*)0;
	if (logfil) {
		fprintf(logfil,"dan_webapi_typegrpliste %d <%s>\n",
			inpfunk,inplandekode);
		fprintf(logfil,"\tws_station=%hd\n",ws_station);
		fprintf(logfil,"\tws_biltype=%s\n",ws_biltype);
	}
	nuvidx = 0;
	ws_maxidxtypegrpliste = -1;
	while (nuvidx<MAXGRPLISTE) {
		strcpy(ws_typegrpliste[nuvidx],"");
		nuvidx++;
	}
	sprintf(filsti,"ecwebapi_02.csv");
	tmpfil = fopen(filsti,"r");
	if (!tmpfil) {
		tmpfil = (FILE*)0;
	}
	lnnr = 0;
	nuvidx = 0;
	while (tmpfil) {
		if (!fgets(inpstr,500,tmpfil)) { break; }
		lnnr++;
		if (lnnr==1) { continue; }
		(void)get_alfa_tgn(inpstr,0,idstr,59);
/* NYT 150512 */
		if (strlen(ws_biltype) && strcmp(idstr,ws_biltype)!=0) {
			continue;
		}
/* NYT 150623 UDLANDUNDTAGELSER */
		undtagelsesflag = 0;
		if (strlen(inplandekode) && strcmp(inplandekode,"DK")!=0) {
			undtagelsesflag = check_ecw_udl_undtagelse(1,idstr,"");
		}
		if (undtagelsesflag>0) { continue; }

		strcpy(ws_typegrpliste[nuvidx],idstr);
		ws_maxidxtypegrpliste = nuvidx;
		nuvidx++;
		retur++;
	}
	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}
/* SORTERING */
	if (sortfunk>0 && retur>0) {
		egesort(1,"sort");
		nuvidx = 0;
		sortantal = 0;
	}
	while (sortfunk>0 && nuvidx<=ws_maxidxtypegrpliste) {
		strcpy(sortgrp,ws_typegrpliste[nuvidx]);
		sort_form_felt(1,sortgrp,20);
		sprintf(sortbuffer, "%-20s %-10s \n \0",
			sortgrp,
			ws_typegrpliste[nuvidx]);
			egesort(2, sortbuffer);
			sortantal++;
		nuvidx++;
		sortantal++;
	}
	if (sortfunk>0 && sortantal>0) {
		egesort(3,"sort");
		nuvidx = 0;
	}
	while (sortfunk>0 && sortantal>0) {
                if (egesort(4, sortbuffer) <= 0) { break; }
		sscanf(sortbuffer,"%s %s",sortgrp,ws_typegrpliste[nuvidx]);
		nuvidx++;
	}
	nuvidx = 0;
	while (logfil && nuvidx<=ws_maxidxtypegrpliste) {
		fprintf(logfil,"\t%d=%s\n",nuvidx,ws_typegrpliste[nuvidx]);
		nuvidx++;
	}
	if (logfil) {
		fprintf(logfil,"\tws_maxidxtypegrpliste=%d\n",
			ws_maxidxtypegrpliste);
		fprintf(logfil,"dan_webapi_typegrpliste retur=%d\n",retur);
	}
	return(retur);
}

/* **************************************************************** */
static int dan_ecwebapi_grpliste(int inpfunk,char *inplandekode,char *inptype) {
	int retur = 0;
	int fundet = 0;
	int lnnr = 0;
	int nuvidx = 0;
	int okflag = 0;
	int undtagelsesflag = 0;
	char idstr[21] = "";
	char chkgrp[21] = "";
	char filsti[81] = "";
	char inpstr[501] = "";
	char typegrpliste[501] = "";
	FILE * tmpfil;

	tmpfil = (FILE*)0;
	if (logfil) {
		fprintf(logfil,"dan_ecwebapi_grpliste %d <%s> <%s>\n",
			inpfunk,inplandekode,inptype);
		fprintf(logfil,"\tws_station=%hd\n",ws_station);
	}
	nuvidx = 0;
	ws_maxidxgrpliste = -1;
	while (nuvidx<MAXGRPLISTE) {
		strcpy(ws_grpliste[nuvidx],"");
		nuvidx++;
	}
	sprintf(filsti,"ecwebapi_02.csv");
	tmpfil = fopen(filsti,"r");
	if (!tmpfil) {
		tmpfil = (FILE*)0;
	}
	lnnr = 0;
	while (tmpfil && fundet==0) {
		if (!fgets(inpstr,500,tmpfil)) { break; }
		lnnr++;
		if (lnnr==1) { continue; }
		(void)get_alfa_tgn(inpstr,0,idstr,59);
		if (strcmp(idstr,inptype)!=0) { continue; }
		(void)get_alfa_tgn(inpstr,2,typegrpliste,59);
		fundet = 1;
	}
	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}
	if (logfil) {
		fprintf(logfil,"\tfundet=%d\n",fundet);
		fprintf(logfil,"\ttypegrpliste=%s\n",typegrpliste);
	}
	if (fundet<=0) { goto afslut; }
	nuvidx = 0;
	while (nuvidx<50) {
		strcpy(chkgrp,"");
		(void)get_alfa_tgn(typegrpliste,nuvidx,chkgrp,44);
		if (!strlen(chkgrp)) { break; }
		okflag = 1;
		if (strcmp(inplandekode,"DK")==0) {
			okflag = check_ecwebapi_stgrp(1,(int)ws_station,chkgrp);
		}
/* NYT 150623 UDLANDUNDTAGELSER */
		undtagelsesflag = 0;
		if (strcmp(inplandekode,"DK")!=0) {
			undtagelsesflag = check_ecw_udl_undtagelse(2,
				inptype,
				chkgrp);
		}
		if (undtagelsesflag>0) { okflag = 0; }
		if (okflag<=0) {
			nuvidx++;
			continue;
		}
		ws_maxidxgrpliste++;
		strcpy(ws_grpliste[ws_maxidxgrpliste],chkgrp);
		nuvidx++;
		retur++;
	}
afslut:
	if (logfil) {
		fprintf(logfil,"\tws_maxidxgrpliste=%d\n",
			ws_maxidxgrpliste);
		fprintf(logfil,"dan_ecwebapi_grpliste retur=%d\n",retur);
	}
	return(retur);
}

/* NYT 150623 UDLANDUNDTAGELSER */
/* ********************************************************** */
static int check_ecw_udl_undtagelse(int inpfunk,char *inptype,char *inpgrp) {
	int retur = 0;
	int fundet = 0;
	int okflag = 0;
	int lnnr = 0;
	char filsti[81] = "";
	char inpstr[501] = "";
	char grpliste[501] = "";
	char idstr[81] = "";
	FILE * tmpfil;

	tmpfil = (FILE*)0;
	sprintf(filsti,"ecwebapi_03.csv");
	tmpfil = fopen(filsti,"r");
	if (!tmpfil) {
		tmpfil = (FILE*)0;
	}
	lnnr = 0;
	while (tmpfil && fundet==0) {
		if (!fgets(inpstr,500,tmpfil)) { break; }
		lnnr++;
		if (lnnr==1) { continue; }
		if (inpstr[0]=='#') { continue; }
		(void)get_alfa_tgn(inpstr,0,idstr,59);
		okflag = 0;
		if (strcmp(idstr,inptype)==0) { okflag = 1; }
		if (inpfunk==2 && strcmp(idstr,"*")==0) { okflag = 1; }
		if (okflag<=0) { continue; }
		(void)get_alfa_tgn(inpstr,1,grpliste,59);
		if (inpfunk==1 && strcmp(grpliste,"*")==0) {
			fundet = 1;
		}
		if (inpfunk==2 && findes_grp_liste(inpgrp,grpliste)>=0) {
			fundet = 1;
		}
	}
	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}
	if (fundet>0) { retur = 1; }
	return(retur);
}

/* NYT 150706 ECWBOOKSTATUS */
/* **************************************** */
static int check_ecwebapi_reqstgrp(int inpfunk,int inpstnr,char *inpgrp) {
	int retur = 0;
	int fundet = 0;
	int lnnr = 0;
	int nuvidx = 0;
	int okflag = 0;
	int chkstation = 0;
	char idstr[21] = "";
	char chkgrp[21] = "";
	char filsti[81] = "";
	char inpstr[501] = "";
	char streqliste[501] = "";
	FILE * tmpfil;

	tmpfil = (FILE*)0;
	sprintf(filsti,"ecwebapi_00.csv");
	tmpfil = fopen(filsti,"r");
	if (!tmpfil) {
		tmpfil = (FILE*)0;
	}
	lnnr = 0;
	while (tmpfil && fundet==0) {
		if (!fgets(inpstr,500,tmpfil)) { break; }
		lnnr++;
		if (lnnr==1) { continue; }
		(void)get_alfa_tgn(inpstr,0,idstr,59);
		chkstation = 0;
		if (strlen(idstr)) {
			sscanf(idstr,"%d",&chkstation);
		}
		if (chkstation!=inpstnr) { continue; }
		(void)get_alfa_tgn(inpstr,4,streqliste,59);
		fundet = 1;
	}
	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}
	if (fundet<=0) { goto afslut; }
	nuvidx = 0;
	while (nuvidx<50 && retur==0) {
		strcpy(chkgrp,"");
		(void)get_alfa_tgn(streqliste,nuvidx,chkgrp,44);
		if (!strlen(chkgrp)) { break; }
		if (strcmp(chkgrp,inpgrp)!=0) {
			nuvidx++;
			continue;
		}
		retur = 1;
	}
afslut:
	return(retur);
}

/* **************************************** */
static int check_ecwebapi_stgrp(int inpfunk,int inpstnr,char *inpgrp) {
	int retur = 0;
	int fundet = 0;
	int lnnr = 0;
	int nuvidx = 0;
	int okflag = 0;
	int chkstation = 0;
	char idstr[21] = "";
	char chkgrp[21] = "";
	char filsti[81] = "";
	char inpstr[501] = "";
	char stgrpliste[501] = "";
	FILE * tmpfil;

	tmpfil = (FILE*)0;
	sprintf(filsti,"ecwebapi_00.csv");
	tmpfil = fopen(filsti,"r");
	if (!tmpfil) {
		tmpfil = (FILE*)0;
	}
	lnnr = 0;
	while (tmpfil && fundet==0) {
		if (!fgets(inpstr,500,tmpfil)) { break; }
		lnnr++;
		if (lnnr==1) { continue; }
		(void)get_alfa_tgn(inpstr,0,idstr,59);
		chkstation = 0;
		if (strlen(idstr)) {
			sscanf(idstr,"%d",&chkstation);
		}
		if (chkstation!=inpstnr) { continue; }
		(void)get_alfa_tgn(inpstr,3,stgrpliste,59);
		fundet = 1;
	}
	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}
	if (fundet<=0) { goto afslut; }
	nuvidx = 0;
	while (nuvidx<50 && retur==0) {
		strcpy(chkgrp,"");
		(void)get_alfa_tgn(stgrpliste,nuvidx,chkgrp,44);
		if (!strlen(chkgrp)) { break; }
		if (strcmp(chkgrp,inpgrp)!=0) {
			nuvidx++;
			continue;
		}
		retur = 1;
	}
afslut:
	return(retur);
}

/* **************************************** */
static int dan_webapi_grpliste(int inpfunk,char *inplandekode) {
	int retur = 0;
	int nuvidx = 0;
	int okflag = 0;
	int grpidx = 0;
	int udllink = -1;
	int sortfunk = 1;
	int sortantal = 0;
	char sortgrp[21] = "";
	char sortbuffer[201] = "";
	char tmpstr[81] = "";
	char returstr[81] = "";

	if (logfil) {
		fprintf(logfil,"dan_webapi_grpliste %d <%s>\n",
			inpfunk,inplandekode);
		fprintf(logfil,"\tws_station=%hd\n",ws_station);
		fprintf(logfil,"\tws_biltype=%s\n",ws_biltype);
	}
	nuvidx = 0;
	ws_maxidxgrpliste = -1;
	while (nuvidx<MAXGRPLISTE) {
		strcpy(ws_grpliste[nuvidx],"");
//		strcpy(ws_typegrpliste[nuvidx],"");
		nuvidx++;
	}
	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	if (strcmp(inplandekode,"DK")==0) {
		okflag = 1;
		nuvidx = 0;
		r198->oplkode = 16627;
		r198->keynum = (double)ws_station;
		f198_start(1,ISGTEQ);
		if (f198_ukendt) { okflag = -1; }
	}
	if (logfil) {
		fprintf(logfil,"\tokflag=%d\n",okflag);
	}
	while (strcmp(inplandekode,"DK")==0 && okflag>0) {
		egeread(f198,ISNEXT);
		if (f198_eof) { break; }
		if (logfil) {
			fprintf(logfil,"\t\t%ld %.0lf %s\n",
				r198->oplkode,
				r198->keynum,
				r198->keyalfa);
		}
		if (r198->oplkode>16627) { break; }
		if (r198->keynum>(double)ws_station) { break; }
		if (r198->numfelt<1) { continue; }
		strcpy(ws_grpliste[nuvidx],r198->keyalfa);
		ws_maxidxgrpliste = nuvidx;
		nuvidx++;
		retur++;
	}
/* DEFAULT */
	grpidx = 1;
	nuvidx = 0;
	while (strcmp(inplandekode,"DK")==0 && okflag==-1) {
		strcpy(returstr,"P7911EC");
		sprintf(tmpstr,"WebGrp%3.3d=",grpidx);
		if (retur_f198_def((long int)1002,tmpstr,returstr)>0) {
			strcpy(ws_grpliste[nuvidx],returstr);
			ws_maxidxgrpliste = nuvidx;
			nuvidx++;
			retur++;
		} else {
			break;
		} 
		grpidx++;
	}
	if (strcmp(inplandekode,"DK")!=0) {
		okflag = 1;
		nuvidx = 0;
		reclow(r198,R198);
		f198_start(1,ISGTEQ);
		r198->oplkode = 16649;
		r198->keynum = (double)ws_station;
		egeread(f198,ISEQUAL);
		if (f198_ok) { udllink = (int)r198->numfelt; }
		if (f198_ukendt) { okflag = -1; }
	}
	if (logfil) {
		fprintf(logfil,"\tudllink=%d\n",udllink);
	}
	if (strcmp(inplandekode,"DK")!=0 && okflag>0 && udllink>=0) {
		r198->oplkode = 16650;
		r198->keynum = (double)udllink;
		f198_start(1,ISGTEQ);
		if (f198_ukendt) { okflag = -1; }
	}
	if (logfil) {
		fprintf(logfil,"\tokflag=%d\n",okflag);
	}
	while (strcmp(inplandekode,"DK")!=0 && okflag>0 && udllink>=0) {
		egeread(f198,ISNEXT);
		if (f198_eof) { break; }
		if (r198->oplkode>16650) { break; }
		if (r198->keynum>(double)udllink) { break; }
		if (r198->numfelt<1) { continue; }
		strcpy(sortgrp,r198->alfafelt+4);
		if (nuvidx>0 && retur_grp_grpliste(sortgrp)>=0) {
			continue;
		}
		strcpy(ws_grpliste[nuvidx],sortgrp);
		ws_maxidxgrpliste = nuvidx;
		nuvidx++;
		retur++;
	}

/* SORTERING */
	if (sortfunk>0 && retur>0) {
		egesort(1,"sort");
		nuvidx = 0;
		sortantal = 0;
	}
	while (sortfunk>0 && nuvidx<=ws_maxidxgrpliste) {
		bilgrp_form(1,ws_grpliste[nuvidx],sortgrp);
		sort_form_felt(1,sortgrp,20);
		sprintf(sortbuffer, "%-20s %-5s \n \0",
			sortgrp,
			ws_grpliste[nuvidx]);
			egesort(2, sortbuffer);
			sortantal++;
		nuvidx++;
		sortantal++;
	}
	if (sortfunk>0 && sortantal>0) {
		egesort(3,"sort");
		nuvidx = 0;
	}
	while (sortfunk>0 && sortantal>0) {
                if (egesort(4, sortbuffer) <= 0) { break; }
		sscanf(sortbuffer,"%s %s",sortgrp,ws_grpliste[nuvidx]);
		nuvidx++;
	}
	if (logfil) {
		fprintf(logfil,"\tws_maxidxgrpliste=%d\n",ws_maxidxgrpliste);
		fprintf(logfil,"dan_webapi_grpliste retur=%d\n",retur);
	}
	return(retur);
}

/* ********************************************* */
static int retur_grp_grpliste(char *inpgrp) {
	int retur = -1;
	int nuvidx = 0;

	while (nuvidx<=ws_maxidxgrpliste && retur==-1) {
		if (strcmp(ws_grpliste[nuvidx],inpgrp)==0) {
			retur = nuvidx;
		}
		nuvidx++;
	}
	return(retur);
}

/* NYT 150623 UDLANDUNDTAGELSER */
/* ********************************************* */
static int findes_grp_liste(char *inpgrp,char *inpgrpliste) {
	int retur = -1;
	int nuvidx = 0;
	int sktgn = 44;
	char chkgrp[21] = "";

	while (retur==-1) {
		(void)get_alfa_tgn(inpgrpliste,nuvidx,chkgrp,sktgn);
		if (!strlen(chkgrp)) {
			break;
		}
		if (strcmp(chkgrp,inpgrp)==0) {
			retur = nuvidx;
		}
		nuvidx++;
	}
	return(retur);
}

/* ************* */
/* fra p7807.c */
static void sort_form_felt(short funk,char *str,int sz) {
	short int wx1;

/* TEST
	if (logfil) {
		fprintf(logfil, "sort_form_felt:funk=%hd,str=%s,sz=%d\n",
			funk,str,sz);
	}
*/
	for (wx1=0;wx1<sz;wx1++)  {
		if (funk==1 && str[wx1] == '!') {
			str[wx1] = 96;
		}
		if (funk==1 && str[wx1] == ' ') {
			str[wx1] = '!';
		}
		if (funk==2 && str[wx1] == '!') {
			str[wx1] = ' ';
		}
		if (funk==2 && str[wx1] == 96) {
			str[wx1] = '!';
		}
	}
	if (funk==1 && !strlen(str)) {
		memset (str, '!', sz);
		str[sz] = '\0';
	}
	return;
}

/* NYT 150408 WEBAPI28 */
/* *********************************************** */
static int send_webapi_cartypes(int inpfunk) {
	int retur = 0;
	int nuvidx = 0;
	int funkretur = 0;
	int lnnr = 0;
	char filsti[81] = "";
	char idstr[41] = "";
	char navnstr[81] = "";
	char inpstr[501] = "";
	FILE * tmpfil;

	tmpfil = (FILE*)0;
	if (logfil) {
		fprintf(logfil,"send_webapi_cartypes %d\n",inpfunk);
		fflush(logfil);
	}
	funkretur = dan_webapi_typegrpliste(1,ws_landekode);
	if (funkretur<=0) { goto afslut; }
	while (nuvidx<=ws_maxidxtypegrpliste) {
		alfalow(str);
		pack_init(str);
		pack_alfa(ws_typegrpliste[nuvidx]);
		(void)retur_ecwebapi_data(1,ws_typegrpliste[nuvidx],navnstr);
/*
		sprintf(navnstr,"typenavn-%s",ws_typegrpliste[nuvidx]);
*/
		pack_alfa(navnstr);
		pack_exchkend();
		send_linie();
		nuvidx++;
		retur++;
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
afslut:
	if (logfil) {
		fprintf(logfil,"send_webapi_cartypes retur=%d\n",retur);
	}
	return(retur);
}

/* NYT 150408 WEBAPI29 */
/* *********************************************** */
static int send_webapi_bilextra(int inpfunk) {
	int retur = 0;
	int nuvidx = 0;
	int nuvniv = 0;
	int nivsendt = 0;
	int funkretur = 0;
	int prisfundet = 0;
	int lnnr = 0;
	int xlsstationnr = ws_station;
	int chkniv = 0;
	int fundet = 0;
	int minantal = 0;
	int maxantal = 0;
	int startantal = 0;
	int enhed = 0;
	int extraok = 0;
	int extraspecnr = 0;
	int extraprisfundet = 0;
	long int varighed = 0;
	double enhedpris = 0;
	char filsti[81] = "";
	char valgtype[21] = "";
	char valgnavn[41] = "";
	char enhedtxt[41] = "";
	char idstr[41] = "";
	char tmpstr[81] = "";
	char xlsbrand[11] = "EC";
	char inpstr[501] = "";
	FILE * tmpfil;

	tmpfil = (FILE*)0;
	if (logfil) {
		fprintf(logfil,"send_webapi_bilextra %d\n",inpfunk);
		fprintf(logfil,"\tws_specnr=%hd\n",ws_specnr);
		fprintf(logfil,"\tws_grp=%s\n",ws_grp);
		fprintf(logfil,"\tws_fradato=%ld\n",ws_fradato);
		fprintf(logfil,"\tws_tildato=%ld\n",ws_tildato);
		fflush(logfil);
	}
	r159->station_ud_nr = ws_station;
	r159->station_ind_nr = ws_tilstation;

	r159->dato_ud = ws_fradato;
	r159->forv_dato_ind = ws_tildato;
	r159->tid_ud = ws_fratid;
	r159->forv_tid_ind = ws_tiltid;
	xlsprismatch->uddato = r159->dato_ud;

	funkretur = nyopret_reservation(0,0,1);
	if (logfil) {
		fprintf(logfil,
		"\tNYOPRET_RESERVATION:funkretur=%hd\n",
			funkretur);
		fprintf(logfil,"\tr159->total=%.2lf\n",r159->total);
		fprintf(logfil,"\tr159->antal_dage=%ld\n",r159->antal_dage);
		fprintf(logfil,"\tr159->antal_uger=%ld\n",r159->antal_uger);
		fprintf(logfil,"\tr159->antal_maaneder=%ld\n",
			r159->antal_maaneder);
	}
	varighed = 0;
	varighed += (int)(r164->antal_maaneder * 30);
	varighed += (int)(r164->antal_uger * 7);
	varighed += (int)(r164->antal_dage);
	if (bss->id_opstart[0]>=0 && r164->antal_timer>bss->id_opstart[8]) {
		varighed++;
	}
	if (logfil) {
		fprintf(logfil,"\tvarighed=%ld\n",
			varighed);
	}
	prisfundet = xlspris_findpris(1010,
		xlsbrand,
		(long)xlsstationnr,
		(long)ws_specnr,
		(int)0,
		ws_grp,
		(long)varighed,
		(long)1,
		tmpstr);
	if (logfil) {
		fprintf(logfil,"\tprisfundet=%d\n",prisfundet);
		fprintf(logfil,"\ttmpstr=%s\n",tmpstr);
	}
// goto test00;
	alfalow(str);
	pack_init(str);
/* NYT 150624 ECEXTUDSTYR */
	nuvniv = 0;
ext02:
	nivsendt = 0;
	nuvidx = 0;
	while (nuvidx<MAXUDSTYRXTRA) {
		if (!strlen(ws_udstyrxtratabel[nuvidx])) {
			break;
		}
		strcpy(tmpstr,"");
		(void)get_alfa_tgn(ws_udstyrxtratabel[nuvidx],0,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&chkniv);
		}
		if (chkniv!=nuvniv) {
			nuvidx++;
			continue;
		}
		(void)get_alfa_tgn(ws_udstyrxtratabel[nuvidx],1,idstr,59);
		if (logfil) {
			fprintf(logfil,"\t\tnuvniv=%d idstr=%s\n",
				nuvniv,
				idstr);
		}
		strcpy(tmpstr,"");
		(void)get_alfa_tgn(ws_udstyrxtratabel[nuvidx],2,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&minantal);
		}
		strcpy(tmpstr,"");
		(void)get_alfa_tgn(ws_udstyrxtratabel[nuvidx],3,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&maxantal);
		}
		strcpy(tmpstr,"");
		(void)get_alfa_tgn(ws_udstyrxtratabel[nuvidx],4,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&startantal);
		}
		(void)get_alfa_tgn(ws_udstyrxtratabel[nuvidx],5,valgtype,59);
		(void)get_alfa_tgn(ws_udstyrxtratabel[nuvidx],6,valgnavn,59);

		strcpy(tmpstr,"");
		(void)get_alfa_tgn(ws_udstyrxtratabel[nuvidx],7,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&enhed);
		}
		if (logfil) {
			fprintf(logfil,
				"\t\t\tminantal=%d maxantal=%d startantal=%d\n",
				minantal,
				maxantal,
				startantal);
			fprintf(logfil,
				"\t\t\tvalgtype=%s\n",
				valgtype);
			fprintf(logfil,
				"\t\t\tvalgnavn=%s enhed=%d\n",
				valgnavn,
				enhed);
		}
		extraok = check_ecw_extraudstyr(1,
			ws_specnr,
			ws_grp,
			idstr,
			ws_station,
			valgnavn);
		if (strcmp(idstr,"KMP")==0) {
			extraok = 100;
		}
		if (logfil) {
			fprintf(logfil,
				"\t\textraok=%d\n",
				extraok);
		}
		if (logfil && extraok<=0) {
			fprintf(logfil,
				"\t\tEXTRAUNDTAGET%s\n",
				idstr);
		}
		if (extraok<=0) {
			nuvidx++;
			continue;
		}
		if (nuvniv==0 && nivsendt==0) {
			pack_alfa("RecommendedExtras");
 			pack_del();
		}
		if (nuvniv==1 && nivsendt==0) {
			pack_alfa("Insurance");
 			pack_del();
		}
		if (nuvniv==2 && nivsendt==0) {
			pack_alfa("Mileage");
 			pack_del();
		}
		strcpy(enhedtxt,"DKK pr. stk");
		if (enhed==201) {
			strcpy(enhedtxt,"DKK");
		}
		if (enhed==-1) {
			strcpy(enhedtxt,"-");
		}
		pack_alfa(idstr);
		pack_alfa(valgnavn);
		pack_alfa(enhedtxt);
		enhedpris = 10;
		if (strcmp(idstr,"PAI")==0) {
			enhedpris = r159->pris_pai_pr_dag;
			enhedpris *= (double)varighed;
			afrund2(enhedpris);
		}
		if (strcmp(idstr,"KMP")==0) {
			enhedpris = 0;
		}
		extraspecnr = 0;
		if (strcmp(idstr,"PAI")!=0) {
			sscanf(idstr,"%d",&extraspecnr);
		}
		if (extraspecnr>0) {
			extraprisfundet = xlspris_findpris(1011,
				xlsbrand,
				(long)xlsstationnr,
				(long)extraspecnr,
				(int)0,
				ws_grp,
				(long)varighed,
				(long)1,
				tmpstr);
		}
		if (logfil) {
			fprintf(logfil,
				"\t\textraspecnr=%d extraprisfundet=%d (%s)\n",
				extraspecnr,
				extraprisfundet,
				tmpstr);
			fprintf(logfil,"\t\txlsprissub->enhed=%ld\n",
				xlsprissub->enhed);
			fprintf(logfil,"\t\txlsprissub->prisprenhed=%.2lf\n",
				xlsprissub->prisprenhed);
		}
		if (extraspecnr>0 && extraprisfundet) {
			enhedpris = xlsprissub->prisprenhed;
			if (xlsprissub->enhed==201) {
				enhedpris *= (double)varighed;
			}
			afrund2(enhedpris);
		}

		xls_char(tmpstr,(double)enhedpris,2);
		pack_alfa(tmpstr);
		if (strcmp(valgtype,"CHECKBOX")==0) {
			pack_int2((long)startantal);
			pack_int2((long)minantal);
			pack_int2((long)maxantal);
			pack_alfa(valgtype);
		}
		if (strcmp(valgtype,"DROPDOWN")==0) {
			pack_int2((long)startantal);
			pack_int2((long)minantal);
			pack_int2((long)maxantal);
			pack_alfa(valgtype);
		}
		nivsendt++;
		nuvidx++;
		fundet++;
	}
	if (nuvniv<2) {
		nuvniv++;
		nivsendt = 0;
		goto ext02;
	}
	if (fundet<=0) { goto afslut; }
	pack_exchkend();
	send_linie();
	retur++;
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	goto afslut;

test00:
	alfalow(str);
	pack_init(str);
	pack_alfa("RecommendedExtras");
 	pack_del();
	strcpy(idstr,"910");
	pack_alfa(idstr);
	strcpy(tmpstr,"Vinterdæk");
	pack_alfa(tmpstr);
	strcpy(enhedtxt,"DKK pr. dag");
	pack_alfa(enhedtxt);
	ege_w_dou1 = 10;
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
	pack_int2((long)0);
	pack_int2((long)0);
	pack_int2((long)1);
	pack_alfa("CHECKBOX");
	strcpy(idstr,"905");
	pack_alfa(idstr);
	strcpy(tmpstr,"Barnestol");
	pack_alfa(tmpstr);
	strcpy(enhedtxt,"DKK pr. dag");
	pack_alfa(enhedtxt);
	ege_w_dou1 = 20;
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
	pack_int2((long)0);
	pack_int2((long)0);
	pack_int2((long)1);
	pack_alfa("DROPDOWN");

	pack_alfa("Insurance");
 	pack_del();
	strcpy(idstr,"PAI");
	pack_alfa(idstr);
	strcpy(tmpstr,"Personforsikring");
	pack_alfa(tmpstr);
	strcpy(enhedtxt,"DKK");
	pack_alfa(enhedtxt);
	ege_w_dou1 = 45;
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
	pack_int2((long)0);
	pack_int2((long)0);
	pack_int2((long)1);
	pack_alfa("CHECKBOX");

	pack_alfa("Mileage");
 	pack_del();

	strcpy(idstr,"969");
	pack_alfa(idstr);
	strcpy(tmpstr,"Km-pakke");
	pack_alfa(tmpstr);
	pack_int((long int)2);
	pack_alfa("KM0");

	nuvidx = 0;
	pack_alfa("KM100");
	pack_alfa("100 km");
	ege_w_dou1 = 110;
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

	pack_alfa("KM200");
	pack_alfa("200 km");
	ege_w_dou1 = 120;
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
	pack_alfa("DROPDOWNEXTRA");

	pack_exchkend();
	send_linie();
	retur++;
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
afslut:
	if (logfil) {
		fprintf(logfil,"send_webapi_bilextra retur=%d\n",retur);
	}
	return(retur);
}

/* ************************************************************ */
static int check_ecw_extraudstyr(int inpfunk,int inpspecnr,char *inpgrp,char *inpid,int inpstation,char *returnavn) {
	int retur = 0;
	int idok = 0;
	int onofflag = 0;
	int grpfundet = 0;
	int stfundet = 0;
	int idfundet = 0;
	int datook = 0;
	int lnnr = 0;
	char inpstr[501] = "";
	char tmpstr[81] = "";
	char chkid[41] = "";
	char aktivmarkstr[11] = "00000";
	FILE * tmpfil;

	tmpfil = (FILE*)0;
	if (logfil) {
		fprintf(logfil,"check_ecw_extraudstyr %d %d %s %s %d\n",
			inpfunk,
			inpspecnr,
			inpgrp,
			inpid,
			inpstation);
	}
	strcpy(aktivmarkstr,"00000");
	onofflag = 1;
forfra:
	idfundet = 0;
	lnnr = 0;
	if (logfil) {
		fprintf(logfil,"\tFORFRA onofflag=%d\n",onofflag);
	}
	sprintf(tmpstr,"ecwebapi_04.csv");
	tmpfil = fopen(tmpstr,"r");
	if (!tmpfil) {
		tmpfil = (FILE*)0;
	}
	while (tmpfil) {
		if (!fgets(inpstr,500,tmpfil)) {
			break;
		}
		lnnr++;
		if (lnnr==1) { continue; }
		if (strlen(inpstr)) {
                        inpstr[strlen(inpstr)-1] = '\0';
		}

		pktkomma_xls_char(inpstr);

		strcpy(chkid,"");
		(void)get_alfa_tgn(inpstr,0,chkid,59);
/* NYT 150626 */
		if (strlen(inpstr) && inpstr[0]=='#') { continue; }

		if (strlen(chkid) && strcmp(chkid,inpid)!=0 &&
			idfundet>0) { break; }
		if (strlen(chkid) && strcmp(chkid,inpid)!=0) { continue; }
		if (strlen(chkid) && strcmp(chkid,inpid)==0) { idfundet=1; }
		if (!strlen(chkid) && idfundet<=0) { continue; }
		(void)get_alfa_tgn(inpstr,1,tmpstr,59);
		if (strlen(tmpstr)) {
			strcpy(returnavn,tmpstr);
		}
		(void)get_alfa_tgn(inpstr,2,tmpstr,59);
		if (onofflag==1 && strcmp(tmpstr,"A")!=0) { continue; }
		if (onofflag==0 && strcmp(tmpstr,"U")!=0) { continue; }
		if (logfil) {
			fprintf(logfil,"\t\t(%d)%s\n",idfundet,inpstr);
		}
		(void)get_alfa_tgn(inpstr,3,tmpstr,59);
		grpfundet = 1;
		if (!strlen(tmpstr)) { grpfundet = 0; }
		if (strlen(tmpstr) && strcmp(tmpstr,"*")!=0) {
			grpfundet = check_extfundet(1,ws_station,ws_grp,tmpstr);
		}
		if (onofflag==1 && grpfundet>0) { aktivmarkstr[0] = '1'; }
		if (onofflag==0 && grpfundet>0) { aktivmarkstr[0] = '0'; }
		(void)get_alfa_tgn(inpstr,4,tmpstr,59);
		grpfundet = 1;
		if (!strlen(tmpstr)) { grpfundet = 0; }

		if (strlen(tmpstr) && strcmp(tmpstr,"*")!=0) {
			grpfundet = check_extfundet(2,ws_station,ws_grp,tmpstr);
		}
		if (onofflag==1 && grpfundet>0) { aktivmarkstr[1] = '1'; }
		if (onofflag==0 && grpfundet>0) { aktivmarkstr[1] = '0'; }
		(void)get_alfa_tgn(inpstr,5,tmpstr,59);
		stfundet = 1;
		if (!strlen(tmpstr)) { stfundet = 0; }
		if (strlen(tmpstr) && strcmp(tmpstr,"*")!=0) {
			stfundet = check_extfundet(3,ws_station,ws_grp,tmpstr);
		}
		if (onofflag==1 && stfundet>0) { aktivmarkstr[2] = '1'; }
		if (onofflag==0 && stfundet>0) { aktivmarkstr[2] = '0'; }
		(void)get_alfa_tgn(inpstr,6,tmpstr,59);
		datook = 1;
		if (onofflag==0) { datook = 0; }
/*
		if (strlen(tmpstr) && strcmp(tmpstr,"*")!=0) {
			datook = check_extfundet(4,ws_station,ws_grp,tmpstr);
		}
*/
		if (onofflag==1 && datook>0) { aktivmarkstr[3] = '1'; }
		if (onofflag==0 && datook>0) { aktivmarkstr[3] = '0'; }
	}
	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}
	if (onofflag>0) {
		onofflag--;
		goto forfra;
	}
afslut:
	if (strncmp(aktivmarkstr,"1111",4)==0) {
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"\taktivmarkstr-%s=%s\n",inpid,aktivmarkstr);
		fprintf(logfil,"check_ecw_extraudstyr retur=%d returnavn=%s\n",
			retur,
			returnavn);
	}
	return(retur);
}

/* ********************** */
static int check_extfundet(int inpfunk,int inpstnr,char *inpgrp,char *inpliste) {
	int retur = 0;
	int nuvidx = 0;
	int funkretur = 0;
	int chkstnr = 0;
	char returstr[81] = "";

	if (logfil) {
		fprintf(logfil,"check_extfundet %d %d <%s> <%s>\n",
			inpfunk,
			inpstnr,
			inpgrp,
			inpliste);
	}
	while (nuvidx<100 && retur==0) {
		(void)get_alfa_tgn(inpliste,nuvidx,returstr,44);
		if (!strlen(returstr)) {
			break;
		}
		if (inpfunk==3) {
			sscanf(returstr,"%d",&chkstnr);
		}
		if (inpfunk==3 && inpstnr==chkstnr) {
			retur = 1;
			break;
		}
		if (inpfunk==2 && strcmp(returstr,inpgrp)==0) {
			retur = 1;
			break;
		}
		if (inpfunk==1) {
			funkretur = dan_ecwebapi_grpliste(1,
				ws_landekode,
				returstr);
		}
		if (inpfunk==1 && funkretur<=0) {
			nuvidx++;
			continue;
		}
		if (inpfunk==1 && funkretur>0 &&
			retur_grp_grpliste(inpgrp)>=0) {
			retur = 1;
			break;
		}
		nuvidx++;
	}
	if (logfil) {
		fprintf(logfil,"check_extfundet retur=%d\n",
			retur);
	}
	return(retur);
}

/* NYT 150409 WEBAPI31 */
/* *********************************************** */
static int opretsend_webapi_resnr(int inpfunk) {
	int retur = 0;
	int nuvidx = 0;
	int funkretur = 0;
	int nyopretur = 0;
	int lnnr = 0;
	int funk = 0;
	long int resnr = 0;
	short int fatalnrfejl = 0;
	short int ecflag = 0;
	short int resstnr = 0;
	short int resstud = 0;
	char filsti[81] = "";
	char enhedtxt[41] = "";
	char idstr[41] = "";
	char navnstr[81] = "";
	char tmpstr[81] = "";
	char inpstr[501] = "";
	double dep_online = 1000;
	double dep_kontant = 2000;
	double dep_kredit = 3000;
	double depositum = 0;

	funk = 1;
	ecflag = 1;
	if (strcmp(ws_landekode,"DK")!=0) {
		ws_udldkflag = 1;
	}
	if (logfil) {
		fprintf(logfil,"opretsend_webapi_resnr %d\n",inpfunk);
		fprintf(logfil,"\tfunk=%d\n",funk);
		fprintf(logfil,"\tecflag=%hd\n",ecflag);
		fprintf(logfil,"\tws_udldkflag=%hd\n",ws_udldkflag);
		fprintf(logfil,"\tws_ecbookingmail=<%s>\n",ws_ecbookingmail);
		fprintf(logfil,"\tws_lejerfdato=<%s>\n",ws_lejerfdato);
		fprintf(logfil,"\tws_kundenr=%ld\n",ws_kundenr);
		fprintf(logfil,"\tws_fradato=%ld\n",ws_fradato);
		fprintf(logfil,"\tws_tildato=%ld\n",ws_tildato);
		fprintf(logfil,"\tws_fratid=%ld\n",ws_fratid);
		fprintf(logfil,"\tws_tiltid=%ld\n",ws_tiltid);
		fprintf(logfil,"\tws_lejerfornavn=%s\n",ws_lejerfornavn);
		fprintf(logfil,"\tws_lejereftnavn=%s\n",ws_lejereftnavn);
		fprintf(logfil,"\tws_landekode=%s\n",ws_landekode);
		fflush(logfil);
	}
	resstnr = ws_station;
	resstud = ws_station;
	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	if (funk==1 && ecflag==1) {
		funkretur = find_r198(1,16624,(double)ws_station,"",0);
	}
	if (funk==1 && ecflag==1 && funkretur>0 &&
		r198->numfelt>0) {
		resstnr = (short int)r198->numfelt;
	}
	if (funk==1 && ecflag==1 && funkretur>0 &&
		strncmp(r198->alfafelt,"StUdNr=",7)==0) {
		sscanf(r198->alfafelt+7,"%hd",&resstud);
	}
	if (funk==1 && ecflag==1) { resstnr = 84; }
	if (funk==1 && ecflag==1 && ws_udldkflag>0) { resstnr = 82; }
	if (funk==1 && ecflag==1 && ws_udldkflag==2) { resstnr = 88; }
	if (funk==1 && ecflag==1 && ws_udldkflag==3) { resstnr = 87; }

	ege_w_int1 = 0;
	if (funk==1 && ecflag==0) {
		ege_w_int1 = check_don_wgk(0);
	}
	if (funk==1 && ecflag==0 && ege_w_int1>0) {
		ws_resnr = ege_w_int1;
	}
	if (logfil) {
		fprintf(logfil,"\tKONTROLGODK\n");
		fprintf(logfil,"\tws_resnr=%ld\n",ws_resnr);
		fprintf(logfil,"\tege_w_int1=%ld\n",ege_w_int1);
		fflush(logfil);
	}
/* NYTNUMMER */
	if (funk==1 && ws_resnr<=0) {
//		resnr = resnrfind(resstnr);
		resnr = konnrfind((short)resstnr,(short)3,(short)99);
	}
	if (funk==1 && ws_resnr>0) {
		resnr = ws_resnr;
	}
/* FATAL NYTNUMMER */
	if (funk==1 && resnr<=20000000) {
		fatalnrfejl = 2;
	}
	if (funk==1 && resnr>29999999) {
		fatalnrfejl = 2;
	}
	if (funk==1 && resnr<=0) {
		fatalnrfejl = 1;
	}
	if (logfil) {
		fprintf(logfil,"\tws_resnr=%ld\n",ws_resnr);
		fprintf(logfil,"\tresnr=%ld\n",resnr);
		fprintf(logfil,"\tfatalnrfejl=%hd\n",fatalnrfejl);
		fflush(logfil);
	}
	if (fatalnrfejl>0) { goto afslut; }

	reccpy(&q159,r159,R159);

	reclow(r159, R159);
	f159_start(1,ISGTEQ);
	r159->record_x = resnr;
	egeread(f159,ISEQUAL);
	if (f159_ok) { goto resnr10; }

	r159->record_x 		= resnr;
	r159->status 		= 10;
	r159->kontrakttype_kode = 3;
	r159->dato_ud = ws_fradato;
	r159->tid_ud = ws_fratid;
	r159->forv_dato_ind = ws_tildato;
	r159->forv_tid_ind = ws_tiltid;

/* NYT 150604 */
	strcpy(r159->bil_grp,ws_grp);

	reclow(r166, R166);
	r159->station_ud_nr = ws_station;
	r166->stat_nr = resstud;
	egeread(f166, ISEQUAL);
	if (f166_ok) {
		r159->station_ud_nr = r166->stat_nr;
		strcpy(r159->station_ud_navn, r166->navn);
		strcpy(r159->station_ud_adr, r166->adr);
		strcpy(r159->station_ud_postkode, r166->postkode);
		strcpy(r159->station_ud_by, r166->by);
		strcpy(r159->station_ud_land, r166->land);
		strcpy(r159->station_ud_tlf, r166->tlf);
	}
	r159->station_ind_nr = ws_tilstation;
	r166->stat_nr = ws_tilstation;
	egeread(f166, ISEQUAL);
	if (f166_ok) {
		r159->station_ind_nr = r166->stat_nr;
		strcpy(r159->station_ind_navn, r166->navn);
		strcpy(r159->station_ind_adr, r166->adr);
		strcpy(r159->station_ind_postkode, r166->postkode);
		strcpy(r159->station_ind_by, r166->by);
		strcpy(r159->station_ind_land, r166->land);
		strcpy(r159->station_ind_tlf, r166->tlf);
	}

	sprintf(r159->bem[0],"webapi reservation st.%hd",ws_station);
	strcpy(tmpstr,ws_lejerfornavn);
	tmpstr[20] = '\0';
	ege_toupper((unsigned char *)tmpstr);
	bss_konv_txt(2,tmpstr);
	strcpy(r159->lejerfornavn,tmpstr);
	strcpy(tmpstr,ws_lejereftnavn);
	tmpstr[30] = '\0';
	ege_toupper((unsigned char *)tmpstr);
	bss_konv_txt(3,tmpstr);
	strcpy(r159->lejerefternavn,tmpstr);

/* NYT 150623 KUNDENRMATCHBOOKING */
	if (ws_kundenr>0) {
		r159->lejerkundenr = ws_kundenr;
	}
/* NYT 150623 KUNDENRMATCHBOOKING */

	nyopretur = ecw_opdaterpris(100);
/* RETTET 150626 ECEXTUDSTYRECW31
	nyopretur = nyopret_reservation(0,0,1);
*/
	if (logfil) {
		fprintf(logfil,"\tnyopretur=%d\n",nyopretur);
		fprintf(logfil,"\tws_lejetotal=%.2lf\n",ws_lejetotal);
		fprintf(logfil,"\tws_extratotal=%.2lf\n",ws_extratotal);
	}
	if (nyopretur<=0) {
		goto afslut;
	}
	r159->record_x = resnr;
	if (ws_kundenr>0) {
		r159->lejerkundenr = ws_kundenr;
	}
	depositum = 0;
	if (strcmp(ws_betalingstype,"2")==0) {
		depositum = dep_kontant;
	}
	if (strcmp(ws_betalingstype,"3")==0) {
		depositum = dep_kredit;
	}
	if (depositum>0) {
		sprintf(r159->forud_4_opl[4],"Aftalt dep. %.0lf",depositum);
	}

	(void)resdatagem(bss->data_sti);
//	egewrite(f159);

	reclow(r359,R359);
	f359_start(1,ISGTEQ);
/* RESMAIL F359 */
	if (strlen(ws_ecbookingmail)) {
		r359->keynum = (double)r159->record_x;
		r359->oplkode = 21;
		strcpy(r359->alfafelt,ws_ecbookingmail);
		r359->uid = 0;
		r359->unixtid = (ULI)time(0);
		reccpy (&z359, r359, R359);
		egeread(f359,ISEQUAL + ISLOCK);
		if (f359_ok) {
			reccpy(r359, &z359, R359);
			egerew(f359);
			egerel(f359);
		} else {
			egerel(f359);
			reccpy(r359, &z359, R359);
			egewrite(f359);
		}
	}
	if (r159->record_x>0) {
        	reclow(r155, R155);
		f155_start(1,ISGTEQ);
        	reclow(r155, R155);
		r155->funktion = 1;
		strcpy(r155->sign, "webapi");
		r155->lb_nr = (ULI)time(0);
		r155->dato = ws_systemdato;
		r155->kl_slet = ws_systemtid;
		r155->statnr = 7912;
/* IPADRESSE */
		if (strlen(ws_ipadr)) {
			strcpy(tmpstr,"");
			(void)get_alfa_tgn(ws_ipadr,0,tmpstr,46);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%hd",&r155->kode_tabel[6]);
			}
			strcpy(tmpstr,"");
			(void)get_alfa_tgn(ws_ipadr,1,tmpstr,46);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%hd",&r155->kode_tabel[7]);
			}
			strcpy(tmpstr,"");
			(void)get_alfa_tgn(ws_ipadr,2,tmpstr,46);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%hd",&r155->kode_tabel[8]);
			}
			strcpy(tmpstr,"");
			(void)get_alfa_tgn(ws_ipadr,3,tmpstr,46);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%hd",&r155->kode_tabel[9]);
			}
		}
		r155->pcnr = 0;
		r155->type = 3;
		r155->statud = r159->station_ud_nr;
		r155->record_x = resnr;
		egewrite(f155);
	}
	reccpy(&q159,r159,R159);
resnr10:
	reccpy(r159,&q159,R159);
	opdat_don_wgk(1,r159->record_x);

	sprintf(ws_donorderid,"%ld",r159->record_x);
	sprintf(ws_tmppara,"don_%8.8ld.web",r159->record_x);
	tmpfil = fopen(ws_tmppara,"w");
	if (tmpfil) {
		fprintf(tmpfil,"%lu\n",ws_startsek);
		fprintf(tmpfil,"%hd\n",ege_pid);
		fprintf(tmpfil,"%s\n",ws_donorderid);
		fclose(tmpfil);
		(void)chmod(ws_tmppara,0777);
	}
	tmpfil = (FILE*)0;

	alfalow(str);
	pack_init(str);
	pack_alfa(ws_donorderid);
//	pack_int2((long)1);
//	pack_int2((long)resnr);


/* NYT 150703 WEBAPI31JUST1 */
	ege_w_dou1 = r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
/*	pack_doub(ege_w_dou1); */

	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
/* Depositum */
/*	pack_doub(dep_online); */
	xls_char(tmpstr,(double)dep_online,2);
	pack_alfa(tmpstr);
/*	pack_doub(dep_kontant); */
	xls_char(tmpstr,(double)dep_kontant,2);
	pack_alfa(tmpstr);
/*	pack_doub(dep_kredit); */
	xls_char(tmpstr,(double)dep_kredit,2);
	pack_alfa(tmpstr);

/* DEPOSITUM + LEJE */
	ege_w_dou1 = dep_online;
	ege_w_dou1 += r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
/*	pack_doub(ege_w_dou1); */
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

	ege_w_dou1 = dep_kontant;
	ege_w_dou1 += r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
/*	pack_doub(ege_w_dou1); */
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

	ege_w_dou1 = dep_kredit;
	ege_w_dou1 += r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
/*	pack_doub(ege_w_dou1); */
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

	ege_w_dou1 = ws_extratotal;
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

/* NYT 121219 LEJEPRISUDENEXTRA */
	ege_w_dou1 = ws_lejetotal;
/*
	ege_w_dou1 = r159->total;
	ege_w_dou1 -= ws_extratotal;
*/
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);


/* PLIGTOPLYSNINGER */
/*
	(void)retur_pligttekst(tmpstr);
	pack_alfa(tmpstr);
	if (ws_brandtype==0) {
		(void)add_divpligtopl(1,ws_grp);
	}
*/

	pack_exchkend();
/* DOBBELBOOKCHECK */
	strcpy(ws_dobbelbooksvar,str);
	ws_dobbelbooksvar[strlen(str)-1] = '\0';
	send_linie();
	retur++;
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
afslut:
	if (logfil) {
		fprintf(logfil,"opretsend_webapi_resnr retur=%d\n",retur);
	}
	return(retur);
}

/* WEBAPI32 */
/* ********************************************* */
static int send_webapi_resliste(int inpfunk) {
	int retur = 0;
	int keynr = 0;
	int okflag = -2;
	int matchok = 0;
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil,"send_webapi_resliste %d\n",inpfunk);
		fprintf(logfil,"\tws_findmoenster=%hd\n",ws_findmoenster);
		fprintf(logfil,"\tws_findresnr=%ld\n",ws_findresnr);
		fprintf(logfil,"\tws_findmail=<%s>\n",ws_findmail);
		fprintf(logfil,"\tws_finduddato=%ld\n",ws_finduddato);
		fprintf(logfil,"\tws_findeftnavn=<%s>\n",ws_findeftnavn);
		fprintf(logfil,"\tws_kundenr=%ld\n",ws_kundenr);
		fflush(logfil);
	}
/* NYT 150623 KUNDENRMATCHBOOKING */
	if (ws_kundenr>0 && ws_findmoenster<=0) { ws_findmoenster = -1; }

/* NYT 150604 */
	if (ws_findmoenster<0 && ws_kundenr<=0) { goto afslut; }

	if (ws_findmoenster==0 && ws_findresnr<=0) { goto afslut; }
	if (ws_findmoenster==1 && ws_findresnr<=0) { goto afslut; }
	if (ws_findmoenster==1 && !strlen(ws_findmail)) { goto afslut; }
	if (ws_findmoenster==2 && !strlen(ws_findmail)) { goto afslut; }
	if (ws_findmoenster==2 && ws_finduddato<=0) { goto afslut; }
	if (ws_findmoenster==3 && ws_findresnr<=0) { goto afslut; }
	if (ws_findmoenster==2 && !strlen(ws_findeftnavn)) { goto afslut; }
	reclow(r359,R359);
	f359_start(1,ISGTEQ);

	reclow(r159,R159);
/* NYT 150623 KUNDENRMATCHBOOKING */
	if (ws_findmoenster==-1) {
		keynr = 10;
		r159->lejerkundenr = ws_kundenr;
		okflag = 1;
	}
	if (ws_findmoenster==0) {
		keynr = 1;
		r159->record_x = ws_findresnr;
		okflag = 1;
	}
	if (ws_findmoenster==1) {
		keynr = 1;
		r159->record_x = ws_findresnr;
		okflag = 1;
	}
	if (ws_findmoenster==2) {
		keynr = 6;
		r159->dato_ud = ws_finduddato;
		okflag = 1;
	}
	if (ws_findmoenster==3) {
		keynr = 1;
		r159->record_x = ws_findresnr;
		okflag = 1;
	}
/* NYT 150623 KUNDENRMATCHBOOKING */
	if (ws_findmoenster==4) {
		keynr = 10;
		r159->lejerkundenr = ws_kundenr;
		okflag = 1;
	}
	if (okflag<1) { goto afslut; }
	f159_start(keynr,ISGTEQ);
	if (f159_ukendt) {
		okflag = -1;
	}
	while (okflag>0) {
		egeread(f159,ISNEXT);
		if (f159_eof) { break; }
		if (keynr==1 && r159->record_x>ws_findresnr) { break; }
		if (keynr==6 && r159->dato_ud>ws_finduddato) { break; }
/* NYT 150623 KUNDENRMATCHBOOKING */
		if (keynr==10 && r159->lejerkundenr>ws_kundenr) { break; }
		matchok = 0;
/* NYT 150623 KUNDENRMATCHBOOKING */
		if (ws_findmoenster==4) { matchok = 1; }
		if (ws_findmoenster==-1) { matchok = 1; }
		if (ws_findmoenster==0) { matchok = 1; }
		if (ws_findmoenster==1 || ws_findmoenster==2) {
			r359->oplkode = 21;
			r359->keynum = (double)r159->record_x;
			egeread(f359,ISEQUAL);
		}
		if ((ws_findmoenster==1 || ws_findmoenster==2) &&
			f359_ukendt) {
			continue;
		}
		if ((ws_findmoenster==1 || ws_findmoenster==2) &&
			strlen(r359->alfafelt) &&
			strcmp(r359->alfafelt,ws_findmail)==0) {
			matchok = 1;
		}
		if (ws_findmoenster==3 &&
			strlen(r159->lejerefternavn) &&
			strcmp(r159->lejerefternavn,ws_findeftnavn)==0) {
			matchok = 1;
		}
		if (matchok<=0) { continue; }
		matchok = 0;
		if (r159->status==2) { matchok = 1; }
		if (r159->status==10) { matchok = 1; }
		if (matchok<=0) { continue; }

		alfalow(str);
		pack_init(str);
		pack_int2((long)r159->record_x);
/* NYT 150604 */ 
		pack_alfa(r159->bil_grp);
		pack_int2((long)r159->station_ud_nr);
		pack_alfa(r159->station_ud_navn);
		ege_w_int1 = m036_funktion(17,(long int)r159->dato_ud);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		pack_alfa(tmpstr);
		sprintf(tmpstr,"%4.4ld",r159->tid_ud);
		pack_alfa(tmpstr);
		pack_int2((long)r159->station_ind_nr);
		pack_alfa(r159->station_ind_navn);
		ege_w_int1 = m036_funktion(17,(long int)r159->forv_dato_ind);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		pack_alfa(tmpstr);
		sprintf(tmpstr,"%4.4ld",r159->forv_tid_ind);
		pack_alfa(tmpstr);

		pack_exchkend();
		send_linie();
		retur++;
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
	if (logfil) {
		fprintf(logfil,"\tokflag=%d\n",okflag);
	}
	if (okflag==-1) { ws_don2errno = WEBAPI32UK; }
	if (retur<=0) { ws_don2errno = WEBAPI32UK; }
afslut:
	if (okflag==-2) { ws_don2errno = WEBAPI32INP; }
	if (logfil) {
		fprintf(logfil,"send_webapi_resliste retur=%d\n",retur);
	}
	return(retur);
}

/* WEBAPI33 */
/* ********************************************* */
static int cancel_webapi_resnr(int inpfunk) {
	int retur = 0;
	int okflag = -2;
	int fundet = 0;
	int slet198 = 0;
	int sendflag = 1;
	long int resnr = 0;
	char tmpstr[41] = "";

	if (logfil) {
		fprintf(logfil,"cancel_webapi_resnr %d\n",inpfunk);
		fprintf(logfil,"\tws_findresnr=%ld\n",ws_findresnr);
		fflush(logfil);
	}
	if (ws_findresnr<=0) { goto afslut; }
	okflag = 0;
	resnr = ws_findresnr;
	if (resnr>0) {
		reclow(r159, R159);
		f159_start(1, ISGTEQ);
		r159->record_x = resnr;
		egeread(f159, ISEQUAL);
	}
	if (resnr>0 && f159_ukendt) {
		ws_don2errno = WEBAPI33UK;
		goto afslut;
	}
	if (resnr>0 && f159_ok && r159->status==5) {
		ws_don2errno = WEBAPI33UK;
		goto afslut;
	}
	if (resnr>0 && f159_ok && r159->status==7) {
		ws_don2errno = WEBAPI33UK;
		goto afslut;
	}
	if (resnr>0 && f159_ok && r159->status==2 &&
		ws_don2errno<=0) {
		r159->status = 5;
		r159->opdat_dato = ws_systemdato;
		fundet++;
	}
	if (resnr>0 && f159_ok && r159->status==10 &&
		ws_don2errno<=0) {
		r159->status = 5;
		r159->opdat_dato = ws_systemdato;
		fundet++;
	}
	if (logfil) {
		fprintf(logfil,"\tfundet=%d\n",fundet);
		fprintf(logfil,"\tresnr=%ld\n",resnr);
		fflush(logfil);
	}
	if (fundet==1 && resnr>0) {
		resdatagem(bss->data_sti);
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"\tretur=%d\n",retur);
		fflush(logfil);
	}
	if (fundet==1 && retur>0 && resnr>0 && slet198) {
		reclow(r198, R198);
		f198_start(1, ISGTEQ);
		r198->oplkode = 15903;
		r198->keynum = resnr;
		egeread(f198, ISEQUAL + ISLOCK);
		if (f198_ok) {
			egedelete(f198);
			egerel(f198);
		}
	}
/* NYT 090430 */
	if (fundet==1 && retur==1 && resnr>0) {
        	reclow(r155, R155);
		f155_start(1,ISGTEQ);
        	reclow(r155, R155);
		r155->funktion = 5;
		strcpy(r155->sign, "web");
		r155->lb_nr = (ULI)time(0);
		r155->dato = ws_systemdato;
		r155->kl_slet = ws_systemtid;
		r155->statnr = bss->id_stat_nr;
		r155->pcnr = 0;
		r155->type = 3;
		r155->statud = r159->station_ud_nr;
		r155->record_x = resnr;
		egewrite(f155);
		if (f155_ukendt) {
			console_err("bss.log f155 ikke gemt");
		}
	}
/* NYT 090902 */
	if (resnr>0) {
		reclow(r145,R145);
		r145->opdfunk = 5;
		r145->rec_x = resnr;
		r145->rec_tp = r159->kontrakttype_kode;
		r145->lbnr = (ULI)time(0);
		r145->kundenr = ws_kundenr;
		r145->dato = ws_systemdato;
		r145->klslet = ws_systemtid;
		r145->statnr = r159->station_ud_nr;
		r145->pcnr = -1;
		r145->status = 1;
		r145->prognr = 7912;
		r145->progfunk = 40;
		r145->dato_ud = r159->dato_ud;
		r145->tid_ud = (short int)r159->tid_ud;
		sprintf(r145->sign,"webfunk%hd",ws_funktion);
		egewrite(f145);
		if (f145_ukendt) {
			console_err("bss.log f145 ikke gemt");
		}
	}
	if (fundet==1 && retur==1 && resnr>0 && ws_udldkflag>0) {
		styr_resprint(r159->station_ud_nr);
	}
	if (retur>0 && sendflag>0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)1);
		sprintf(tmpstr,"%ld cancel ok",r159->record_x);
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
afslut:
	if (okflag==-2) { ws_don2errno = WEBAPI33INP; }
	if (logfil) {
		fprintf(logfil,"cancel_webapi_resnr retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* NYT 150415 WEBAPI35 WEBAPI38 */
/* ********************************************* */
static int styr_webapi_kunde(int inpfunk) {
	int retur = 0;
	int nuvindex = 0;
	int daustatus = 0;
	int wx1 = 0;
	int wx2 = 0;
	long int fdato = 0;
	long int alder = 0;
	long int firmakundenr = 0;
	char mobilnr[41] = "";
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil,"styr_webapi_kunde %d\n",inpfunk);
		fprintf(logfil,"\tws_funktion=%hd\n",ws_funktion);
		fprintf(logfil,"\tws_kundetype=%hd\n",ws_kundetype);
		fprintf(logfil,"\tws_kundenr=%ld\n",ws_kundenr);
		fprintf(logfil,"\tws_maxwebapiparatab=%d\n",
			ws_maxwebapiparatab);
		fflush(logfil);
	}
	ws_opdaterfunk = 0;
	if (ws_kundenr>0) {
		ws_opdaterfunk = 1;
		ws_opdaterknr = ws_kundenr;
	}
	if (logfil) {
		fprintf(logfil,"\tws_opdaterfunk=%hd\n",ws_opdaterfunk);
	}
	if (ws_opdaterfunk==1 && ws_opdaterknr<=0) {
		ws_don2errno = WEBAPI35NRF;
		goto afslut;
	}
	reclow(r198, R198);
	f198_start(1, ISGTEQ);
	reclow(r178, R178);
	f178_start(1, ISGTEQ);
	reclow(r167, R167);
	f167_start(1, ISGTEQ);

	nuvindex = 0;
	while(logfil && nuvindex<=ws_maxwebapiparatab) {
		fprintf(logfil,"\tws_webapi_paratab-%d <%s>\n",
			nuvindex,
			ws_webapi_paratab[nuvindex]);
		alfalow(tmpstr);
		strcpy(tmpstr,ws_webapi_paratab[nuvindex]);
		strcpy(ws_webapi_paratab[nuvindex],
			(char *) konvert_ext_ascii_til_8859(tmpstr));
		fprintf(logfil,"\tEFTER KONV ws_webapi_paratab-%d <%s>\n",
			nuvindex,
			ws_webapi_paratab[nuvindex]);
		nuvindex++;
	}
	strcpy(tmpstr,ws_webapi_paratab[16]);
	tmpstr[15] = '\0';
	if (ws_don2errno<=0 && ws_kundetype==1 && ws_opdaterfunk==0 &&
		webapi_check_kundefindes(1,tmpstr,ws_webapi_paratab[13])>0) {
		ws_don2errno = WEBAPI35ALR;
	}
/* NYT 150518 EMAILKUNDEFINDES */
	strcpy(tmpstr,"");
	if (ws_don2errno<=0 && ws_kundetype==1 && ws_opdaterfunk==0 &&
		webapi_check_kundefindes(11,ws_webapi_paratab[10],tmpstr)>0) {
		ws_don2errno = WEBAPI35ALR;
	}

	if (logfil) {
		fprintf(logfil,"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) { goto afslut; }
	if (ws_kundetype==1) {
		daustatus = webapi_check_dau(6,
			ws_webapi_paratab[16],
			ws_webapi_paratab[3]);
	}
	if (ws_kundetype==1 && daustatus==2) {
		ws_don2errno = WEBAPI35DAU2;
	}
	if (ws_kundetype==1 && daustatus==3) {
		ws_don2errno = WEBAPI35DAU3;
	}
	if (ws_kundetype==1 && daustatus==4) {
		ws_don2errno = WEBAPI35DAU4;
	}
	if (logfil) {
		fprintf(logfil,"\tws_don2errno-3=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) { goto afslut; }

	wx1 = 0;
	wx2 = 0;
	alfalow(tmpstr);
	while (ws_kundetype==1 && wx1<strlen(ws_webapi_paratab[13])) {
		if (ws_webapi_paratab[13][wx1]>='0' &&
			ws_webapi_paratab[13][wx1]<='9') {
			tmpstr[wx2] = ws_webapi_paratab[13][wx1];
			wx2++;
			tmpstr[wx2] = '\0';
		}
		wx1++;
	}
	if (strlen(tmpstr)) {
		sscanf(tmpstr,"%ld",&ege_w_int1);
		fdato = m036_funktion(18,(long int)ege_w_int1);
	}
	if (logfil) {
		fprintf(logfil,"\ttmpstr=<%s> fdato=%8.8ld\n",
			tmpstr,fdato);
		fprintf(logfil,"\tws_systemdato=%8.8ld\n",
			ws_systemdato);
	}
	if (fdato<=0) {
		ws_don2errno = WEBAPI35NDTF;
	}
	if (logfil) {
		fprintf(logfil,"\tws_don2errno-4.0=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		goto afslut;
	}

	ege_w_int1 = 19000101;
	if (logfil) {
		fprintf(logfil,"\tege_w_int1=%8.8ld\n",
			ege_w_int1);
	}
	if (ws_kundetype==1 && fdato<=ege_w_int1) {
		ws_don2errno = WEBAPI35DTF;
	}
	if (ws_kundetype==1 && fdato>ws_systemdato) {
		ws_don2errno = WEBAPI35DTF;
	}
/* NYT 130416 CHECK21ALDER */
	if (ws_kundetype==1 && fdato>0) {
                alder = ws_systemdato;
                alder -= fdato;
                if (alder<210000) {
			ws_don2errno = WEBAPI35ALDER;
                }
	}
	if (logfil) {
		fprintf(logfil,"\talder=%ld\n",alder);
		fprintf(logfil,"\tws_don2errno-4.1=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		goto afslut;
	}
	if (ws_kundenr>0 && ws_kundetype==1) {
		reclow(r167, R167);
		f167_start(1, ISGTEQ);
		r167->kunde_nr = ws_kundenr;
		egeread(f167,ISEQUAL);
		if (f167_ok && r167->type==2) {
			firmakundenr = ws_kundenr;
		}
	}
	reclow(r167, R167);
	f167_start(1, ISGTEQ);
	reclow(r178, R178);
	f178_start(1, ISGTEQ);
	if (ws_opdaterfunk==0) {
		nytkundenr();
	}
	if (ws_opdaterfunk==1) {
		r167->kunde_nr = ws_opdaterknr;
		egeread(f167, ISEQUAL);
		if (f167_ukendt) {
			r167->kunde_nr = -1;
		}
	}
	if (logfil) {
        	fprintf(logfil, "\tr167->kunde_nr=%ld\n", r167->kunde_nr);
	}
	if (r167->kunde_nr<=0) {
		ws_don2errno = WEBAPI35NRF;
	}
	if (logfil) {
		fprintf(logfil,"\tws_don2errno-5=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) { goto afslut; }

/* F og ENAVN */
	ws_webapi_paratab[2][20] = '\0';
	ws_webapi_paratab[3][30] = '\0';
/* ADR */
	ws_webapi_paratab[4][30] = '\0';
	ws_webapi_paratab[5][30] = '\0';
	ws_webapi_paratab[6][30] = '\0';
/* POSTNR */
	ws_webapi_paratab[7][15] = '\0';
/* BY */
	ws_webapi_paratab[8][15] = '\0';
/* LAND */
	ws_webapi_paratab[9][10] = '\0';
/* EMAIL */
	ws_webapi_paratab[10][60] = '\0';
/* TLF */
	ws_webapi_paratab[11][20] = '\0';
/* PW */
	ws_webapi_paratab[12][20] = '\0';
/* FØDEDATO */
	ws_webapi_paratab[13][20] = '\0';
/* FØDESTED */
	ws_webapi_paratab[14][15] = '\0';
/* FØDELAND */
	ws_webapi_paratab[15][10] = '\0';
/* KKORTNR */
	ws_webapi_paratab[16][15] = '\0';

/* PASNR */
	ws_webapi_paratab[20][15] = '\0';
/* ISSUED */
	ws_webapi_paratab[21][15] = '\0';
/* PASLAND */
	ws_webapi_paratab[24][15] = '\0';

/* SECRET */
	ws_webapi_paratab[29][80] = '\0';

	if (ws_kundetype==1) {
		strcpy(r167->navn_1, ws_webapi_paratab[2]);
		strcpy(r167->navn_2, ws_webapi_paratab[3]);
		strcpy(r167->adr_1, ws_webapi_paratab[4]);
		strcpy(r167->adr_2, ws_webapi_paratab[5]);
		strcpy(r167->postkode, ws_webapi_paratab[7]);
		strcpy(r167->by, ws_webapi_paratab[8]);
		strcpy(r167->land, ws_webapi_paratab[9]);
		strcpy(r167->tlf, ws_webapi_paratab[11]);
		if (strlen(ws_webapi_paratab[11])) {
			strcpy(mobilnr, ws_webapi_paratab[11]);
		}
/* NYT 150604 */
//		fdato = 0;
//		if (strlen(ws_webapi_paratab[13])) {
//			rens_datotidstr(ws_webapi_paratab[13]);
//			sscanf(ws_webapi_paratab[13],"%ld",&ege_w_int1);
//			fdato = m036_funktion(18, ege_w_int1);
//		}
		r167->foedselsdato = fdato;
		strcpy(r167->kkortnr, ws_webapi_paratab[16]);
		strcpy(r167->foede_sted, ws_webapi_paratab[14]);
		bss_konv_txt(2,r167->navn_1);
		bss_konv_txt(3,r167->navn_2);
		bss_konv_txt(4,r167->adr_1);
		bss_konv_txt(4,r167->adr_2);
		bss_konv_txt(5,r167->postkode);
		bss_konv_txt(4,r167->by);
		bss_konv_txt(4,r167->land);
		bss_konv_txt(8,r167->kkortnr);
		bss_konv_txt(4,r167->foede_sted);
/* NYT 150604 */
		ege_w_int2 = 0;
		if (strlen(ws_webapi_paratab[17])) {
			rens_datotidstr(ws_webapi_paratab[17]);
			sscanf(ws_webapi_paratab[17],"%ld",&ege_w_int1);
			ege_w_int2 = m036_funktion(18, ege_w_int1);
		}
		r167->kkort_ud_den = ege_w_int2;
		ws_webapi_paratab[19][15] = '\0';
		strcpy(r167->kkort_ud_af,ws_webapi_paratab[19]);
		bss_konv_txt(4,r167->kkort_ud_af);

		strcpy(r167->pasnr,ws_webapi_paratab[20]);
		strcpy(r167->pas_ud_af,ws_webapi_paratab[21]);
		bss_konv_txt(4,r167->pas_ud_af);
		ege_w_int2 = 0;
		if (strlen(ws_webapi_paratab[22])) {
			rens_datotidstr(ws_webapi_paratab[22]);
			sscanf(ws_webapi_paratab[22],"%ld",&ege_w_int1);
			ege_w_int2 = m036_funktion(18, ege_w_int1);
		}
		r167->pas_ud_den = ege_w_int2;
		ege_w_int2 = 0;
		if (strlen(ws_webapi_paratab[23])) {
			rens_datotidstr(ws_webapi_paratab[23]);
			sscanf(ws_webapi_paratab[23],"%ld",&ege_w_int1);
			ege_w_int2 = m036_funktion(18, ege_w_int1);
		}
		r167->pas_gyldig_til = ege_w_int2;




	}
	if (ws_opdaterfunk==0 && ws_kundetype==1) {
		r167->type = 1;
	}
	if (ws_opdaterfunk==0 && ws_kundetype==2) {
		r167->type = 2;
	}
	if (ws_opdaterfunk==0) {
		r167->oprettelses_dato = ege_date();
		r167->status = 1;
		strcpy(r167->bem, "webopret ok");
	}
	egewrite(f167);
	if (f167_ok) {
		retur = 1;
	}
	if (f167_ukendt) {
		reccpy(&q167,r167,R167);
		egeread(f167, ISEQUAL + ISLOCK);
		reccpy(r167,&q167,R167);
		egerew(f167);
		egerel(f167);
		retur = 1;
	}

/* PW */
	if (strlen(ws_webapi_paratab[12])) {
		reclow(r178, R178);
		strcpy(r178->alfa_felt,ws_webapi_paratab[12]);
		opdat_r178(45,(double)r167->kunde_nr);
	}
/* BRAND */
	if (ws_opdaterfunk==0) {
		reclow(r178, R178);
		strcpy(r178->alfa_felt, "ECWEBOPR_");
		opdat_r178(11,(double)r167->kunde_nr);
	}
/* EMAIL */
	reclow(r178, R178);
	strcpy(r178->alfa_felt, ws_webapi_paratab[10]); 
/* NYT 150518 EMAILLOWER */
	ege_tolower((unsigned char *)r178->alfa_felt);
	opdat_r178(10,(double)r167->kunde_nr);
/* MOBILNR */
	reclow(r178, R178);
	strcpy(r178->alfa_felt, mobilnr);
	opdat_r178(65,(double)r167->kunde_nr);
/* NYHEDSBREV */
//	reclow(r178, R178);
//	if (nyhedsbrev<=0) {
//		r178->num_felt = 3;
//	}
//	opdat_r178(40,(double)r167->kunde_nr);
/* NYT 150604 ACCOUNTNYDATA */
	reclow(r178, R178);
	strcpy(r178->alfa_felt,ws_webapi_paratab[6]); 
	bss_konv_txt(4,r178->alfa_felt);
	opdat_r178(73,(double)r167->kunde_nr);

	reclow(r178, R178);
	strcpy(r178->alfa_felt,ws_webapi_paratab[15]); 
	bss_konv_txt(4,r178->alfa_felt);
	opdat_r178(74,(double)r167->kunde_nr);

	reclow(r178, R178);
	ege_w_int2 = 0;
	if (strlen(ws_webapi_paratab[18])) {
		rens_datotidstr(ws_webapi_paratab[18]);
		sscanf(ws_webapi_paratab[18],"%ld",&ege_w_int1);
		ege_w_int2 = m036_funktion(18, ege_w_int1);
	}
	r178->num_felt = (double)ege_w_int2;
	opdat_r178(75,(double)r167->kunde_nr);

	reclow(r178, R178);
	strcpy(r178->alfa_felt,ws_webapi_paratab[24]); 
	bss_konv_txt(4,r178->alfa_felt);
	opdat_r178(76,(double)r167->kunde_nr);

	reclow(r178, R178);
	sscanf(ws_webapi_paratab[25],"%lf", &r178->num_felt);
	opdat_r178(77,(double)r167->kunde_nr);
	reclow(r178, R178);
	strcpy(r178->alfa_felt,ws_webapi_paratab[26]); 
	opdat_r178(78,(double)r167->kunde_nr);

	reclow(r178, R178);
	ege_w_int1 = 0;
	ege_w_int2 = 0;
	if (strlen(ws_webapi_paratab[27])) {
		rens_datotidstr(ws_webapi_paratab[27]);
		sscanf(ws_webapi_paratab[27],"%ld",&ege_w_int1);
	}
	if (ege_w_int1>0) {
		ege_w_int2 = m036_funktion(18, ege_w_int1);
	}
	r178->num_felt = (double)ege_w_int2;
	opdat_r178(79,(double)r167->kunde_nr);

	reclow(r178, R178);
	sscanf(ws_webapi_paratab[28],"%lf", &r178->num_felt);
	opdat_r178(80,(double)r167->kunde_nr);
	reclow(r178, R178);
	strcpy(r178->alfa_felt,ws_webapi_paratab[29]); 
	opdat_r178(81,(double)r167->kunde_nr);

/* KUNDEKORT */

	reccpy(&q167, r167, R167);

	if (retur==1) {
		alfalow(str);
		pack_init(str);
		pack_alfa("ok");
		if (ws_opdaterfunk==0) {
			sprintf(tmpstr,"opret %ld",r167->kunde_nr);
		}
		if (ws_opdaterfunk==1) {
			sprintf(tmpstr,"opdatering %ld",r167->kunde_nr);
		}
		pack_alfa(tmpstr);
		pack_int2((long)r167->kunde_nr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s\n",str);
			fflush(logfil);
		}
	}
afslut:
	if (ws_don2errno>0 && ws_funktion==38) {
		ws_don2errno += 30000;
	}
	if (logfil) {
		fprintf(logfil,"styr_webapi_kunde retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ***************************************** */
static int webapi_check_dau(short keynr,char *nrstr,char *navnstr) {
	int retur = 0;
	long int chknr = 0;
	long int nuvnr = 0;

	if (logfil) {
		fprintf(logfil,
		"webapi_check_dau keynr=%hd nrstr=<%s> navnstr=<%s>\n",
		keynr,
		nrstr,
		navnstr);
	}
	reclow(r167, R167);
	if (keynr==1) {
		sscanf(nrstr,"%ld",&chknr);
		r167->kunde_nr = chknr;
	}
	if (keynr==6) {
		strcpy(r167->kkortnr,nrstr);
	}
	f167_start(keynr, ISGTEQ);
	if (f167_ukendt) {
		retur = -1;
	}
	while (retur==0) {
		egeread(f167, ISNEXT);
		if (f167_eof) {
			break;
		}
		if (keynr==1 && r167->kunde_nr!=chknr) {
			break;
		}
		if (keynr==6 && strcmp(r167->kkortnr, nrstr)!=0) {
			break;
		}
		if (r167->status<2 || r167->status>4) {
			continue;
		}
		retur = r167->status;
		nuvnr = r167->kunde_nr;
	}
	if (logfil) {
		fprintf(logfil,"\tnuvnr=%ld\n",nuvnr);
		fprintf(logfil,"webapi_check_dau:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ******************************************************************** */
/* inpfunk 1 person 1=kkortnr 2=fdato					*/
static int webapi_check_kundefindes(int inpfunk,char *inpid1,char *inpid2) {
	int retur = 0;
	int wx1 = 0;
	int wx2 = 0;
	int keynr = 0;
	int keyopl = 0;
	int fundet = 0;
	int kundetype = 0;
	int kundebrand = 0;
	long int testkundenr = 0;
	long int kundenr = 0;
	int readantal = 0;
	int fejlkode = 0;
	char chkid1[41] = "";
	char chkid2[41] = "";
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil,"webapi_check_kundefindes:%d %s %s\n",
			inpfunk,
			inpid1,
			inpid2);
	}
	reclow(r178,R178);
	f178_start(1,ISGTEQ);
	reclow(r167,R167);
	f167_start(1,ISGTEQ);
	if (inpfunk==1) {
		kundetype = 1;
		strcpy(chkid1,inpid1);
		egechartest((unsigned char *)chkid1);
		ege_toupper((unsigned char *)chkid1);

		strcpy(r167->kkortnr,chkid1);
		keynr = 6;
	}
/* NYT 150518 KUNDEFINDESEMAIL */
	if (inpfunk==11) {
		kundetype = 1;
		strcpy(chkid1,inpid1);
		egechartest((unsigned char *)chkid1);
		ege_tolower((unsigned char *)chkid1);
		keyopl = 10;
		r178->opl_kode = keyopl;
		strcpy(r178->alfa_felt,chkid1);
		keynr = 104;
	}

	wx1 = 0;
	wx2 = 0;
	while (inpfunk==1 && kundetype==1 && wx1<strlen(inpid2)) {
		if (inpid2[wx1]>='0' && inpid2[wx1]<='9') {
			chkid2[wx2] = inpid2[wx1];
			wx2++;
			chkid2[wx2] = '\0';
		}
		wx1++;
	}
	if (logfil) {
		fprintf(logfil,"\tkeynr=%d\n",keynr);
	}
	if (keynr>0 && keynr<100) {
		f167_start(keynr,ISGTEQ);
	}
	while (keynr>0 && keynr<100 && kundenr<=0) {
		egeread(f167,ISNEXT);
		readantal++;
		if (f167_eof) {
			break;
		}
		if (logfil) {
			fprintf(logfil,"\t\t%d kunde_nr=%ld\n",
				readantal,
				r167->kunde_nr);
			fprintf(logfil,"\t\t%s\n",r167->kkortnr);
		}
		if (keynr==6 && strcmp(r167->kkortnr,chkid1)!=0) {
			break;
		}
		if (kundetype==1 && r167->type!=1) {
			continue;
		}
		if (kundetype==2 && r167->type!=2) {
			continue;
		}
		kundebrand = check_ec_kundenr((long int)r167->kunde_nr);
		if (logfil) {
			fprintf(logfil,"\t\tkundebrand=%d\n",
				kundebrand);
		}
		if (kundebrand<=0) {
			continue;
		}
		if (logfil) {
			fprintf(logfil,"\t\tfdato=%ld ID2=%s\n",
				r167->foedselsdato,
				chkid2);
		}
		ege_w_int1 = m036_funktion(17,(long int)r167->foedselsdato);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		if (logfil) {
			fprintf(logfil,"\t\ttmpstr=%s\n",
				tmpstr);
			fprintf(logfil,"\t\tnavn_2=%s\n",
				r167->navn_2);
		}
/* RETTET 130115 CHECKKKNR
		if (kundetype==1 && inpfunk==1 &&
			strcmp(chkid2,tmpstr)!=0) {
			continue;
		}
*/
		fundet = 1;
		kundenr = r167->kunde_nr;
	}
	if (keynr>100 && keynr<200) {
		f178_start(keynr-100,ISGTEQ);
		if (f178_ukendt) { fejlkode = 1; }
	}
	while (keynr>100 && keynr<200 && fejlkode==0 && kundenr<=0) {
		egeread(f178,ISNEXT);
		readantal++;
		if (f178_eof) { break; }
		if (logfil) {
			fprintf(logfil,"\t\t%d kunde_nr=%.0lf\n",
				readantal,
				r178->kunde_nr);
		}
		if (r178->opl_kode!=keyopl) { break; }
		if (keynr==104 &&
			strcmp(r178->alfa_felt,chkid1)!=0) { break; }

		reccpy(&q178,r178,R178);
		testkundenr = (long int)r178->kunde_nr;
		kundebrand = check_ec_kundenr(testkundenr);
		if (kundebrand<=0) {
			reccpy(r178,&q178,R178);
			f178_start(keynr-100, ISGREAT);
			if (f178_ukendt) { break; }
			continue;
		}
		r167->kunde_nr = testkundenr;
		egeread(f167,ISEQUAL);
		if (f167_ukendt) {
			reccpy(r178,&q178,R178);
			f178_start(keynr-100, ISGREAT);
			if (f178_ukendt) { break; }
			continue;
		}
		if (r167->type!=kundetype) {
			reccpy(r178,&q178,R178);
			f178_start(keynr-100, ISGREAT);
			if (f178_ukendt) { break; }
			continue;
		}
		fundet = 1;
		kundenr = testkundenr;
		reccpy(r178,&q178,R178);
		f178_start(keynr-100, ISGREAT);
		if (f178_ukendt) { break; }
	}
	if (logfil) {
		fprintf(logfil,"\tfundet=%d\n",fundet);
		fprintf(logfil,"\tkundenr=%ld\n",kundenr);
	}
	if (fundet>0 && kundenr>0) {
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"webapi_check_kundefindes:retur=%d\n",
			retur);
		fflush(logfil);
	}
	return(retur);
}

/* NYT 150416 WEBAPI36 */
/* ********************************************* */
static int styr_webapi_login(int inpfunk) {
	int retur = 0;
	int wx1 = 0;
	int wx2 = 0;
	int fejlkode = 0;
	int keynr = 0;
	int keyopl = 0;
	int fundet = 0;
	int kundenr = 0;
	int kundebrand = 0;
	int readantal = 0;
	int funkretur = 0;
	long int chkkundenr = 0;
	long int testkundenr = 0;
	char tmpstr[81] = "";
	char password[81] = "";

	if (logfil) {
		fprintf(logfil,"styr_webapi_login %d\n",inpfunk);
		fprintf(logfil,"\tws_logintype=%hd\n",ws_logintype);
		fprintf(logfil,"\tws_loginid1=%s\n",ws_loginid1);
		fprintf(logfil,"\tws_loginid2=%s\n",ws_loginid2);
		fflush(logfil);
	}
	if (!strlen(ws_loginid1)) { goto afslut; }

	wx1 = 0;
	wx2 = 0;
	reclow(r178,R178);
	f178_start(1,ISGTEQ);
	reclow(r167,R167);
	f167_start(1,ISGTEQ);
	if (ws_logintype==1) {
		egechartest((unsigned char *)ws_loginid1);
		ege_tolower((unsigned char *)ws_loginid1);
		egechartest((unsigned char *)ws_loginid2);
		strcpy(r178->alfa_felt,ws_loginid1);
		keyopl = 10;
		r178->opl_kode = keyopl;
		keynr = 104;
	}
	if (logfil) {
		fprintf(logfil,"\tkeynr=%d\n",keynr);
	}
	fejlkode = 0;
	if (keynr>100 && keynr<200) {
		f178_start(keynr-100,ISGTEQ);
		if (f178_ukendt) { fejlkode = 1; }
	}
	while (keynr>100 && keynr<200 && fejlkode==0 && kundenr<=0) {
		egeread(f178,ISNEXT);
		readantal++;
		if (f178_eof) { break; }
		if (logfil) {
			fprintf(logfil,"\t\t%d kunde_nr=%.0lf\n",
				readantal,
				r178->kunde_nr);
		}
		if (r178->opl_kode!=keyopl) { break; }
		if (keynr==104 &&
			strcmp(r178->alfa_felt,ws_loginid1)!=0) { break; }

		reccpy(&q178,r178,R178);
		testkundenr = (long int)r178->kunde_nr;
		kundebrand = check_ec_kundenr(testkundenr);
		if (kundebrand<=0) {
			reccpy(r178,&q178,R178);
			f178_start(keynr-100, ISGREAT);
			if (f178_ukendt) { break; }
			continue;
		}
		strcpy(password,"ToMtPw");
		funkretur = find_r178(1,45,0,(double)testkundenr);
		if (funkretur>0 && strlen(r178->alfa_felt)) {
			strcpy(password, r178->alfa_felt);
		}
		if (logfil) {
			fprintf(logfil,"\t\t\tpassword=<%s>\n",
				password);
		}
		if (strcmp(password,ws_loginid2)!=0) {
			reccpy(r178,&q178,R178);
			f178_start(keynr-100, ISGREAT);
			if (f178_ukendt) { break; }
			continue;
		}
		fundet = 1;
		kundenr = testkundenr;
		reccpy(r178,&q178,R178);
		f178_start(keynr-100, ISGREAT);
		if (f178_ukendt) { break; }
	}

	if (keynr>0 && keynr<100) {
		f167_start(keynr,ISGTEQ);
	}
	while (keynr>0 && keynr<100 && fejlkode==0 && kundenr<=0) {
		egeread(f167,ISNEXT);
		readantal++;
		if (f167_eof) { break; }
		if (logfil) {
			fprintf(logfil,"\t\t%d kunde_nr=%ld\n",
				readantal,
				r167->kunde_nr);
			fprintf(logfil,"\t\t%s\n",r167->kkortnr);
		}
		if (keynr==6 && strcmp(r167->kkortnr,ws_loginid1)!=0) {
			break;
		}
		if (keynr==1 && r167->kunde_nr!=chkkundenr) {
			break;
		}
		if (ws_logintype==1 && r167->type!=1) {
			continue;
		}
		if (ws_logintype==2 && r167->type!=2) {
			continue;
		}
		kundebrand = check_ec_kundenr((long int)r167->kunde_nr);
		if (kundebrand<=0) { continue; }
/*
		ege_w_int1 = m036_funktion(17,(long int)r167->foedselsdato);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		if (logfil) {
			fprintf(logfil,"\t\ttmpstr=%s\n",
				tmpstr);
			fprintf(logfil,"\t\tnavn_2=%s\n",
				r167->navn_2);
		}
		wx1 = 0;
		if (ws_logintype==1 && ploginsetup==1 &&
			strcmp(chkid2,tmpstr)!=0) {
			wx1 = 1;
		}
*/
		fundet = 1;
		kundenr = r167->kunde_nr;
	}
	if (logfil) {
		fprintf(logfil,"\tfejlkode=%d\n",fejlkode);
		fprintf(logfil,"\tfundet=%d\n",fundet);
		fprintf(logfil,"\tkundenr=%ld\n",kundenr);
	}
	if (fundet>0 && kundenr>0 && keynr>100 && keynr<200) {
		r167->kunde_nr = kundenr;
		egeread(f167,ISEQUAL);
		if (f167_ukendt) { fundet = -1; }
	}

	if (fundet>0 && kundenr>0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)kundenr);
		pack_alfa(r167->navn_1);
		pack_alfa(r167->navn_2);

		pack_alfa(r167->adr_1);
		pack_alfa(r167->adr_2);
		strcpy(tmpstr,"");
/* OBS ADR3 */	pack_alfa(tmpstr);
		pack_alfa(r167->postkode);
		pack_alfa(r167->by);
		pack_alfa(r167->land);
		pack_alfa(r167->tlf);
/* Email */
		strcpy(tmpstr,"");
		if (find_r178(1,10,0,(double)r167->kunde_nr)>0) {
			strcpy(tmpstr,r178->alfa_felt);
		}
		pack_alfa(tmpstr);
/* DriverLicense */
		pack_alfa(r167->kkortnr);
/* Birthdate Fdato */
		ege_w_int1 = m036_funktion(17,(long int)r167->foedselsdato);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		pack_alfa(tmpstr);
/* WEBAPI36_CUSTOMERTYPE */
		pack_int((int)r167->type);
		
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
	}
	if (fundet<=0) {
		ws_don2errno = WEBAPI36UK;
	}
afslut:
	if (logfil) {
		fprintf(logfil,"styr_webapi_login retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* NYT 150416 WEBAPI37 */
/* ********************************************* */
static int styr_webapi_pw(int inpfunk) {
	int retur = 0;
	int wx1 = 0;
	int wx2 = 0;
	int fejlkode = 0;
	int keynr = 0;
	int keyopl = 0;
	int fundet = 0;
	int kundenr = 0;
	int kundebrand = 0;
	int readantal = 0;
	int funkretur = 0;
	long int chkkundenr = 0;
	long int testkundenr = 0;
	char tmpstr[81] = "";
	char password[81] = "";

	if (logfil) {
		fprintf(logfil,"styr_webapi_pw %d\n",inpfunk);
		fprintf(logfil,"\tws_logintype=%hd\n",ws_logintype);
		fprintf(logfil,"\tws_loginid1=%s\n",ws_loginid1);
		fprintf(logfil,"\tws_loginid2=%s\n",ws_loginid2);
		fflush(logfil);
	}
	if (!strlen(ws_loginid1)) { goto afslut; }

	wx1 = 0;
	wx2 = 0;
	reclow(r178,R178);
	f178_start(1,ISGTEQ);
	reclow(r167,R167);
	f167_start(1,ISGTEQ);
	if (ws_logintype==1) {
		egechartest((unsigned char *)ws_loginid1);
		ege_tolower((unsigned char *)ws_loginid1);
		egechartest((unsigned char *)ws_loginid2);
		strcpy(r178->alfa_felt,ws_loginid1);
		keyopl = 10;
		r178->opl_kode = keyopl;
		keynr = 104;
	}
	if (logfil) {
		fprintf(logfil,"\tkeynr=%d\n",keynr);
	}
	fejlkode = 0;
	if (keynr>100 && keynr<200) {
		f178_start(keynr-100,ISGTEQ);
		if (f178_ukendt) { fejlkode = 1; }
	}
	while (keynr>100 && keynr<200 && fejlkode==0 && kundenr<=0) {
		egeread(f178,ISNEXT);
		readantal++;
		if (f178_eof) { break; }
		if (logfil) {
			fprintf(logfil,"\t\t%d kunde_nr=%.0lf\n",
				readantal,
				r178->kunde_nr);
		}
		if (r178->opl_kode!=keyopl) { break; }
		if (keynr==104 &&
			strcmp(r178->alfa_felt,ws_loginid1)!=0) { break; }

		reccpy(&q178,r178,R178);
		testkundenr = (long int)r178->kunde_nr;
		kundebrand = check_ec_kundenr(testkundenr);
		if (kundebrand<=0) {
			reccpy(r178,&q178,R178);
			f178_start(keynr-100, ISGREAT);
			if (f178_ukendt) { break; }
			continue;
		}
		strcpy(password,"ToMtPw");
		funkretur = find_r178(1,45,0,(double)testkundenr);
		if (funkretur>0 && strlen(r178->alfa_felt)) {
			strcpy(password, r178->alfa_felt);
		}
		if (logfil) {
			fprintf(logfil,"\t\t\tpassword=<%s>\n",
				password);
		}
//		if (strcmp(password,ws_loginid2)!=0) {
//			reccpy(r178,&q178,R178);
//			f178_start(keynr-100, ISGREAT);
//			if (f178_ukendt) { break; }
//			continue;
//		}
		fundet = 1;
		kundenr = testkundenr;
		reccpy(r178,&q178,R178);
		f178_start(keynr-100, ISGREAT);
		if (f178_ukendt) { break; }
	}

	if (keynr>0 && keynr<100) {
		f167_start(keynr,ISGTEQ);
	}
	while (keynr>0 && keynr<100 && fejlkode==0 && kundenr<=0) {
		egeread(f167,ISNEXT);
		readantal++;
		if (f167_eof) { break; }
		if (logfil) {
			fprintf(logfil,"\t\t%d kunde_nr=%ld\n",
				readantal,
				r167->kunde_nr);
			fprintf(logfil,"\t\t%s\n",r167->kkortnr);
		}
		if (keynr==6 && strcmp(r167->kkortnr,ws_loginid1)!=0) {
			break;
		}
		if (keynr==1 && r167->kunde_nr!=chkkundenr) {
			break;
		}
		if (ws_logintype==1 && r167->type!=1) {
			continue;
		}
		if (ws_logintype==2 && r167->type!=2) {
			continue;
		}
		kundebrand = check_ec_kundenr((long int)r167->kunde_nr);
		if (kundebrand<=0) { continue; }
/*
		ege_w_int1 = m036_funktion(17,(long int)r167->foedselsdato);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		if (logfil) {
			fprintf(logfil,"\t\ttmpstr=%s\n",
				tmpstr);
			fprintf(logfil,"\t\tnavn_2=%s\n",
				r167->navn_2);
		}
		wx1 = 0;
		if (ws_logintype==1 && ploginsetup==1 &&
			strcmp(chkid2,tmpstr)!=0) {
			wx1 = 1;
		}
*/
		fundet = 1;
		kundenr = r167->kunde_nr;
	}
	if (logfil) {
		fprintf(logfil,"\tfejlkode=%d\n",fejlkode);
		fprintf(logfil,"\tfundet=%d\n",fundet);
		fprintf(logfil,"\tkundenr=%ld\n",kundenr);
		fprintf(logfil,"\tpassword=<%s>\n",password);
	}
	if (fundet>0 && kundenr>0 && keynr>100 && keynr<200) {
		r167->kunde_nr = kundenr;
		egeread(f167,ISEQUAL);
		if (f167_ukendt) { fundet = -1; }
	}

	if (fundet>0 && kundenr>0) {
		alfalow(str);
		pack_init(str);
/* Email */
		strcpy(tmpstr,"");
		if (find_r178(1,10,0,(double)r167->kunde_nr)>0) {
			strcpy(tmpstr,r178->alfa_felt);
		}
		pack_alfa(tmpstr);
		pack_alfa(password);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
	}
	if (fundet<=0) {
		ws_don2errno = WEBAPI37UK;
	}
afslut:
	if (logfil) {
		fprintf(logfil,"styr_webapi_pw retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* NYT 150420 WEBAPI39 */
/* ********************************************* */
static int send_webapi_bilspecs(int inpfunk) {
	int retur = 0;
	int funkretur = 0;
	int typeidx = -1;
	int grpidx = -1;
	int maxgrpidx = -1;
	int sktgn = 44;
	int sktgn2 = 59;
	int dataidx = 0;
	int maxdataidx = 0;
	char tmpstr[81] = "";
	char tmpstr2[81] = "";
	char typenavn[81] = "";
	char nuvgrp[41] = "";
	char nuvtype[41] = "";
	char grpliste[501] = "";
	char dataliste[501] = "";
	char datatabel[100][81];
	char dataidtabel[100][21];
	int dataidxtabel[100];

	if (logfil) {
		fprintf(logfil,"send_webapi_bilspecs %d\n",inpfunk);
		fprintf(logfil,"\tws_biltype=%s\n",ws_biltype);
		fprintf(logfil,"\tws_grp=%s\n",ws_grp);
		fflush(logfil);
	}
	ws_maxidxtypegrpliste = -1;
	if (!strlen(ws_biltype) && strlen(ws_grp)) {
		strcpy(grpliste,ws_grp);
		maxgrpidx = 0;
		goto loop10;
	}
	if (strlen(ws_biltype)) {
		funkretur = dan_webapi_typegrpliste(1,"");
	}
	if (!strlen(ws_biltype) && !strlen(ws_grp)) {
		funkretur = dan_webapi_typegrpliste(1,"");
	}
	if (logfil) {
		fprintf(logfil,"\tfunkretur=%d\n",funkretur);
	}
	if (funkretur>0) {
		typeidx = -1;
		goto loop01;
	}
loop01:
	typeidx++;
	if (logfil) {
		fprintf(logfil,"\tLOOP01 typeidx=%d\n",typeidx);
	}
	if (typeidx>ws_maxidxtypegrpliste) { goto afslut; }
	if (strlen(ws_biltype) &&
		strcmp(ws_typegrpliste[typeidx],ws_biltype)!=0) {
		goto loop01;
	}
	(void)retur_ecwebapi_data(2,ws_typegrpliste[typeidx],grpliste);
	strcpy(nuvtype,ws_typegrpliste[typeidx]);
	if (logfil) {
		fprintf(logfil,"\t\tgrpliste=<%s>\n",grpliste);
	}
loop10:
	grpidx = -1;
loop11:
	grpidx++;
	if (logfil) {
		fprintf(logfil,"\tLOOP11 grpidx=%d maxgrpidx=%d\n",
			grpidx,maxgrpidx);
	}
	strcpy(nuvgrp,"");
	(void)get_alfa_tgn(grpliste,grpidx,nuvgrp,sktgn);
	if (!strlen(nuvgrp)) { goto loop01; }
	if (strlen(ws_grp) && strcmp(nuvgrp,ws_grp)) { goto loop11; }

	alfalow(str);
	pack_init(str);
	pack_alfa(nuvtype);
	pack_alfa(nuvgrp);
/* NYT 150518 ACRISSKODE */
	strcpy(tmpstr,"????");
	find_acriss_kode(nuvgrp,tmpstr);
	pack_alfa(tmpstr);

	dataidx = 0;
	while (dataidx<100) {
		strcpy(datatabel[dataidx],"");
		strcpy(dataidtabel[dataidx],"");
		dataidxtabel[dataidx] = 0;
		dataidx++;
	}
	funkretur = retur_ecwebapi_data(100,nuvgrp,dataliste);
	if (logfil) {
		fprintf(logfil,"\t\tfunkretur=%d dataliste=%s\n",
			funkretur,dataliste);
	}
	maxdataidx = 0;
	while (funkretur>0 && maxdataidx<100) {
		strcpy(tmpstr,"");
		(void)get_alfa_tgn(dataliste,maxdataidx,tmpstr,sktgn2);
		if (!strlen(tmpstr)) { break; }
		if (maxdataidx>0) {
			(void)get_alfa_tgn(tmpstr,0,tmpstr2,'-');
			strcpy(dataidtabel[maxdataidx],tmpstr2);
			(void)get_alfa_tgn(tmpstr,1,tmpstr2,'-');
			strcpy(datatabel[maxdataidx],tmpstr2);
			dataidxtabel[maxdataidx] = maxdataidx;
		} else {
			strcpy(datatabel[maxdataidx],tmpstr);
			dataidxtabel[maxdataidx] = maxdataidx;
		}
		maxdataidx++;
	}
	if (logfil) {
		fprintf(logfil,"\t\tmaxdataidx=%d\n",maxdataidx);
	}
/* NYT 150519 */
	sprintf(tmpstr,"CarOptionList");
	pack_alfa(tmpstr);
 	pack_del();
	dataidx = 1;
	while (dataidx<maxdataidx) {
/* NYT 150507 DIVJUST01 */
		sprintf(tmpstr,"%s",dataidtabel[dataidx]);
		pack_alfa(tmpstr);

		sprintf(tmpstr,"%s",datatabel[dataidx]);
		pack_alfa(tmpstr);
		(void)retur_ecwebapi_data(100+dataidx,nuvgrp,tmpstr);
		if (!strlen(tmpstr)) {
			strcpy(tmpstr,"");
/* RETTET 150603
			strcpy(tmpstr,"N/A");
*/
		}
		pack_alfa(tmpstr);
		dataidx++;
	}
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	retur++;
	if (maxgrpidx>=0 && grpidx>=maxgrpidx) { goto afslut; }
	if (maxgrpidx<0) { goto loop11; }
afslut:
	if (logfil) {
		fprintf(logfil,"send_webapi_bilspecs retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* NYT 150420 WEBAPI40 WEBAPI41 WEBAPI42 */
/* ********************************************* */
static int send_webapi_kundevalg(int inpfunk) {
	int retur = 0;
	long int oplkode = 0;
	int okflag = 0;
	int kortok = 0;
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil,"send_webapi_kundevalg %d\n",inpfunk);
		fflush(logfil);
	}
	if (inpfunk==1 && ws_funktion==40) {
		alfalow(str);
		pack_init(str);
		sprintf(tmpstr,"%d",retur+1);
		pack_alfa(tmpstr);
		strcpy(tmpstr,"Hvad er din mors pigenavn ?");
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
		alfalow(str);
		pack_init(str);
		sprintf(tmpstr,"%d",retur+1);
		pack_alfa(tmpstr);
		strcpy(tmpstr,"Hvad hedder dit kæledyr ?");
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
		alfalow(str);
		pack_init(str);
		sprintf(tmpstr,"%d",retur+1);
		pack_alfa(tmpstr);
		strcpy(tmpstr,"Hvad er din favoritby ?");
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
		alfalow(str);
		pack_init(str);
		sprintf(tmpstr,"%d",retur+1);
		pack_alfa(tmpstr);
		strcpy(tmpstr,"Hvad er din favoritfilm ?");
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
	}
	if (inpfunk==1 && ws_funktion==41) {
		okflag = 1;
		reclow(r172,R172);
		f172_start(1,ISGTEQ);
		if (f172_ukendt) { okflag = 0; }
	}
	while (inpfunk==1 && ws_funktion==41 && okflag>0) {
		egeread(f172,ISNEXT);
		if (f172_eof) { break; }
		kortok = 0;
		if (r172->kto_nr>=4000000) { kortok = 1; }
		if (r172->flag>0 && r172->kto_nr>0) { kortok = 0; }
		if (r172->flag==1 && r172->kto_nr==0) { kortok = 0; }
		if (r172->type>=100) { kortok = 0; }
		if (kortok<=0) { continue; }

		alfalow(str);
		pack_init(str);
		sprintf(tmpstr,"%hd",r172->type);
		pack_alfa(tmpstr);
		strcpy(tmpstr,r172->tekst);
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
/*
	if (inpfunk==1 && ws_funktion==41) {
		alfalow(str);
		pack_init(str);
		sprintf(tmpstr,"%d",retur+1);
		pack_alfa(tmpstr);
		strcpy(tmpstr,"American Express");
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
		alfalow(str);
		pack_init(str);
		sprintf(tmpstr,"%d",retur+1);
		pack_alfa(tmpstr);
		strcpy(tmpstr,"Diners Club");
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
*/
	}
	if (inpfunk==1 && ws_funktion==42) {
		okflag = 1;
		reclow(r198,R198);
		f198_start(1,ISGTEQ);
		oplkode = 16799;
		r198->oplkode = oplkode;
		f198_start(1,ISGTEQ);
		if (f198_ukendt) { okflag = 0; }
	}
	while (inpfunk==1 && ws_funktion==42 && okflag>0) {
		egeread(f198,ISNEXT);
		if (f198_eof) { break; }
		if (r198->oplkode!=oplkode) { break; }
		if (r198->numfelt<=0) { continue; }
		alfalow(str);
		pack_init(str);
		strcpy(tmpstr,"");
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,59);
		if (!strlen(tmpstr)) { continue; }
//		sprintf(tmpstr,"%d",retur+1);
		pack_alfa(tmpstr);
		strcpy(tmpstr,"");
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,59);
		ege_toupper((unsigned char*)tmpstr);
		if (!strlen(tmpstr)) { continue; }
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;

/* RETTET 150428
	if (inpfunk==1 && ws_funktion==42) {
		alfalow(str);
		pack_init(str);
		sprintf(tmpstr,"%d",retur+1);
		pack_alfa(tmpstr);
		strcpy(tmpstr,"AEROFLOT BONUS");
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
		alfalow(str);
		pack_init(str);
		sprintf(tmpstr,"%d",retur+1);
		pack_alfa(tmpstr);
		strcpy(tmpstr,"AEROLINEAS ARGENTINAS PLUS");
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
*/
	}



afslut:
	if (logfil) {
		fprintf(logfil,"send_webapi_kundevalg retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* NYT 150507 WEBAPI43 */
/* ****************************************************** */
static int send_webapi_st_aabenhlg(int inpfunk) {
	int retur = 0;
	long int julian = 0;
	long int nuvjulian = 0;
	long int nuvdato = 0;
	long int returdato = 0;
	long int fratid = 0;
	long int tiltid = 0;
	int funkretur = 0;
	int idx = 0;
	int idx2 = 0;
	int dgantal = 0;
	int nuvdgnr = 0;
	int hlgdgnr = 0;
	int okflag = 0;
	int fundet = 0;
	char normaltider[8][41] = {"","","","","","","",""};
	char hlgnavn[41] = "";
	char tmpstr[41] = "";

	if (logfil) {
		fprintf(logfil,"send_webapi_st_aabenhlg %d\n",inpfunk);
		fprintf(logfil,"\tws_station=%hd\n",ws_station);
		fprintf(logfil,"\tws_fradato=%ld\n",ws_fradato);
		fprintf(logfil,"\tws_dgvarighed=%hd\n",ws_dgvarighed);
		fflush(logfil);
	}
	reclow(r198,R198);
	r198->oplkode = 16606;
	r198->keynum = (double)ws_station;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		fundet = -1;
	}
	while (fundet>=0) {
		egeread(f198,ISNEXT);
		if (f198_eof) { break; }
		if (r198->oplkode>16606) { break; }
		if (r198->keynum>(double)ws_station) { break; }
		get_alfa_tgn(r198->alfafelt,0,tmpstr,59);
		idx = 0;
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&idx);
		}
		if (idx>0 && idx<8) {
			fratid = 0;
			get_alfa_tgn(r198->alfafelt,1,tmpstr,59);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%ld",&fratid);
			}
			tiltid = 0;
			get_alfa_tgn(r198->alfafelt,2,tmpstr,59);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%ld",&tiltid);
			}
			sprintf(normaltider[idx],"%ld;%ld",fratid,tiltid);
			fundet++;
		}
	}
	dgantal = 0;
	julian = m036_funktion(12, ws_fradato);
	while (dgantal<=ws_dgvarighed) {
		nuvjulian = julian+dgantal;
		nuvdato = m036_funktion(19, nuvjulian);
		returdato = m036_funktion(11, nuvdato);
		nuvdgnr = (int)(returdato%10);
		strcpy(ws_alert_txt,"");
		funkretur = check_bssaaben(-1,ws_station,nuvdato,-1);
		hlgdgnr = (long int)m036_alfa_funk(2,
			(long int)nuvdato,
			40,
			hlgnavn);
		okflag = 0;
		if (hlgdgnr>=10) { okflag = 1; }
		if (okflag==0 && funkretur<=0) {
			okflag = 10;
			strcpy(hlgnavn,"obs-lukket.dag");
		}
		if (okflag==0 && funkretur>0 &&
			strcmp(ws_alert_txt,normaltider[nuvdgnr])!=0) {
			okflag = 100;
			strcpy(hlgnavn,"obs-åben.dag");
		}
		if (logfil) {
			fprintf(logfil,
		"\t\tok%d nuvdato=%8.8ld(%d) funkretur=%d hlg%d<%s> <%s>\n",
				okflag,
				nuvdato,nuvdgnr,funkretur,hlgdgnr,hlgnavn,
				ws_alert_txt);
		}
		if (okflag<=0) {
			dgantal++;
			continue;
		}
		strcpy(tmpstr,hlgnavn);
		idx2 = 0;
		for (idx=0;idx<strlen(tmpstr);idx++) {
			if (tmpstr[idx]!='X') {
				hlgnavn[idx2] = tmpstr[idx];
				idx2++;
				hlgnavn[idx2] = '\0';
			}
		}


		alfalow(str);
		pack_init(str);
		sprintf(tmpstr,"%d",nuvdgnr);
		pack_alfa(tmpstr);
		pack_alfa(hlgnavn);
		if (funkretur<=0) {
			fratid = 0;
			tiltid = 0;
			sprintf(tmpstr,"%4.4ld",fratid);
			pack_alfa(tmpstr);
			sprintf(tmpstr,"%4.4ld",tiltid);
			pack_alfa(tmpstr);
		} else {
			(void)get_alfa_tgn(ws_alert_txt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%ld", &fratid);
			}
			(void)get_alfa_tgn(ws_alert_txt,1,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%ld", &tiltid);
			}
			sprintf(tmpstr,"%4.4ld",fratid);
			pack_alfa(tmpstr);
			sprintf(tmpstr,"%4.4ld",tiltid);
			pack_alfa(tmpstr);
		}
		ege_w_int1 = m036_funktion(17,(long int)nuvdato);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		pack_alfa(tmpstr);

		sprintf(tmpstr,"%d",(int)0);
		pack_alfa(tmpstr);

		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
		dgantal++;
	}
	if (logfil) {
		fprintf(logfil,"send_webapi_st_aabenhlg retur=%d\n",retur);
	}
	return(retur);
}

/* ************************************* */
static int udpak_webapi_paratab(int inpfunk,short feltantal,short startindex) {
	int retur = 0;
	short int nuvantal = 0;
	short int nuvindex = 0;

	if (logfil) {
		fprintf(logfil,"udpak_webapi_paratab %d %hd %hd\n",
			inpfunk,feltantal,startindex);
		fflush(logfil);
	}
	nuvindex = startindex;
	while (nuvantal<feltantal) {
		get_alfa(ws_webapi_paratab[nuvindex]);
		egechartest((unsigned char *)ws_webapi_paratab[nuvindex]);
		if (logfil) {
			fprintf(logfil,"\tws_webapi_paratab-%hd=<%s>\n",
				nuvindex,
				ws_webapi_paratab[nuvindex]);
		}
		ws_maxwebapiparatab = nuvindex;
		nuvantal++;
		nuvindex++;
	}
afslut:
	if (logfil) {
		fprintf(logfil,"\tws_maxwebapiparatab=%d\n",
			ws_maxwebapiparatab);
		fprintf(logfil,"udpak_webapi_paratab retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* **************************************** */
/* inpfunk 1 typenavn				*/
/* inpfunk 2 typegrpliste				*/
/* inpfunk 100 overskrift				*/
/* inpfunk 101 grp gear				*/
/* inpfunk 102 grp døre				*/
/* inpfunk 103 grp kufferter				*/
/* inpfunk 104 grp aircon				*/
/* inpfunk 105 grp brændstof				*/
/* inpfunk 106 grp hk				*/
/* inpfunk 107 grp co2				*/
/* inpfunk 108 grp alder				*/
/* inpfunk 109 grp model				*/
static int retur_ecwebapi_data(int inpfunk,char *inpid,char *returstr) {
	int retur = 0;
	int idx = 0;
	char filsti[81] = "";
	char inpstr[501] = "";
	char chkid[41] = "";
	FILE * tmpfil;

	tmpfil = (FILE*)0;
	strcpy(returstr,"");
	if (logfil) {
		fprintf(logfil,"retur_ecwebapi_data %d <%s>\n",inpfunk,inpid);
	}
	if (inpfunk==1) { sprintf(filsti,"ecwebapi_02.csv"); }
	if (inpfunk==2) { sprintf(filsti,"ecwebapi_02.csv"); }
	if (inpfunk>=100 && inpfunk<200) { sprintf(filsti,"ecwebapi_01.csv"); }
	if (!strlen(filsti)) { goto afslut; }
	tmpfil = fopen(filsti,"r");
	if (!tmpfil) {
		tmpfil = (FILE*)0;
	}
	while (tmpfil && retur==0) {
		if (!fgets(inpstr,500,tmpfil)) {
			break;
		}
		if (strlen(inpstr)) {
                        inpstr[strlen(inpstr)-1] = '\0';
		}
		strcpy(chkid,"");
		if (inpfunk==1) { (void)get_alfa_tgn(inpstr,0,chkid,59); }
		if (inpfunk==2) { (void)get_alfa_tgn(inpstr,0,chkid,59); }
		if (inpfunk==100) {
			strcpy(returstr,inpstr);
			retur = 1;
			break;
		}
		if (inpfunk>=101 &&
			inpfunk<200) {
			(void)get_alfa_tgn(inpstr,0,chkid,59);
		}
		if (strcmp(chkid,inpid)!=0) { continue; }
		if (inpfunk==1) { (void)get_alfa_tgn(inpstr,1,returstr,59); }
		if (inpfunk==2) { (void)get_alfa_tgn(inpstr,2,returstr,59); }
		if (inpfunk==100) { (void)get_alfa_tgn(inpstr,2,returstr,59); }
		if (inpfunk>=101 &&
			inpfunk<200) {
			idx = inpfunk-100;
		}
		if (inpfunk>=101 &&
			inpfunk<200) {
			(void)get_alfa_tgn(inpstr,idx,returstr,59);
		}
		retur = 1;
	}
	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}
afslut:
	if (logfil) {
		fprintf(logfil,"retur_ecwebapi_data retur=%d <%s>\n",
			retur,returstr);
	}
	return(retur);
}


/* NYT 130701 WEBOPRETLOG */
/* **************************************** */
static int add_webopretlog(char *inpipadr,long int inpnr) {
	int retur = 0;
	FILE * weboprlog;

	weboprlog = (FILE*)0;
	weboprlog = fopen("webopr.log","a");
	if (weboprlog) {
		fprintf(weboprlog,"%s",ege_prognr);
		fprintf(weboprlog,";%8.8ld",(long int)ege_date());
		fprintf(weboprlog,";%6.6ld",(long int)ege_time()/100);
		fprintf(weboprlog,";%hd",ws_funktion);
		fprintf(weboprlog,";%ld",inpnr);
		fprintf(weboprlog,";%s",inpipadr);
/* NYT 131125 GEMOPRKOMMANDO */
		fprintf(weboprlog,";\"%s\"",ws_kommandostr);
		fprintf(weboprlog,";\n");
		fclose(weboprlog);
		retur = 1;
	}
	weboprlog = (FILE*)0;
	return(retur);
}

/* NYT 130923 DOBBELBOOKCHECK */
/* **************************************************** */
static int check_dobbelcheck() {
	int retur = 0;
	long int maxsek = DOBBELSEKANTAL;
	long int nuvsek = 0;
	long int checksek = 0;
	long int checkresnr = 0;
	short int checkfrgspg = 0;
	char nuvidstr[201] = "";
	char checkidstr[201] = "";
	char checksvar[101] = "";
	char inpstr[501] = "";
	char tmpstr[101] = "";
	FILE * dobbelfil;

	dobbelfil = (FILE*)0;
        if (access("dobbelcheckok",0)!=0) {
		return(-1);
        }
	nuvsek = (ULI)time(0);
	sprintf(nuvidstr,"%s%8.8ld%4.4ld%8.8ld%4.4ld%s%8.8ld%s",
		ws_booktype,
		ws_fradato,
		ws_fratid,
		ws_tildato,
		ws_tiltid,
		ws_grp,
		ws_kundenr,
		ws_dobbelnavnopl);
	dobbelfil = fopen("last10.p7912","r");
	if (dobbelfil) {
		if (!fgets(inpstr,500,dobbelfil)) {
			retur = -2;
		}
		fclose(dobbelfil);
	}
	dobbelfil = (FILE*)0;
	if (retur==0 && strlen(inpstr)) {
		(void)get_alfa_tgn(inpstr,0,tmpstr,9);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&checksek);
		}
		(void)get_alfa_tgn(inpstr,1,checkidstr,9);
		(void)get_alfa_tgn(inpstr,2,checksvar,9);
		(void)get_alfa_tgn(inpstr,3,tmpstr,9);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&checkresnr);
		}
	}
	if (logfil) {
		fprintf(logfil,"DOBBELCHECK-%ld\n",nuvsek);
		fprintf(logfil,"DOBBELCHECK-%ld\n",checksek);
		fprintf(logfil,"DOBBELCHECK-%ld (%ld)\n",
			maxsek,
			(long int)nuvsek-checksek);
		fprintf(logfil,"DOBBELCHECK-%s\n",nuvidstr);
		fprintf(logfil,"DOBBELCHECK-%s\n",checkidstr);
		fprintf(logfil,"DOBBELCHECK-%hd\n",checkfrgspg);
		fprintf(logfil,"DOBBELCHECK-%s\n",checksvar);
		fprintf(logfil,"DOBBELCHECK-%ld\n",checkresnr);
		fflush(logfil);
	}
	if (retur==0 && strlen(checkidstr) &&
		strcmp(nuvidstr,checkidstr)!=0) { retur = -3; }
	if (retur==0 && checksek>0 &&
		nuvsek-checksek<=maxsek) {
		retur = 1;
		ws_dobbelresnr = checkresnr;
		strcpy(ws_dobbelbooksvar,checksvar);
/*
		ws_dobbelfrgspg = checkfrgspg;
*/
	}
	if (logfil) {
		fprintf(logfil,"DOBBELCHECK RETUR=%d\n",retur);
		fflush(logfil);
	}
	if (retur>0) {
		dobbelfil = fopen("p7912last10.log","a");
	}
	if (retur>0 && dobbelfil) {
		fprintf(dobbelfil,"%ld",ege_date());
		fprintf(dobbelfil,";%ld",ege_time());
		fprintf(dobbelfil,";%ld",ws_dobbelresnr);
		fprintf(dobbelfil,";%s",checkidstr);
		fprintf(dobbelfil,";\n");
		fclose(dobbelfil);
	}
	dobbelfil = (FILE*)0;
	return(retur);
}

/* **************************************************** */
static int opdat_dobbelcheck() {
	int retur = 0;
	long int nuvsek = 0;
	char bookidstr[201] = "";
	FILE * dobbelfil;

	dobbelfil = (FILE*)0;
	nuvsek = (ULI)time(0);
	sprintf(bookidstr,"%s%8.8ld%4.4ld%8.8ld%4.4ld%s%8.8ld%s",
		ws_booktype,
		ws_fradato,
		ws_fratid,
		ws_tildato,
		ws_tiltid,
		ws_grp,
		ws_kundenr,
		ws_dobbelnavnopl);
	dobbelfil = fopen("last10.p7912","w");
	if (dobbelfil) {
		fprintf(dobbelfil,"%ld",nuvsek);
		fprintf(dobbelfil,"\t%s",bookidstr);
		fprintf(dobbelfil,"\t%s",ws_dobbelbooksvar);
/*
		fprintf(dobbelfil,"\t%hd",ws_dobbelfrgspg);
*/
		fprintf(dobbelfil,"\t%ld",r159->record_x);
		fclose(dobbelfil);
		retur = 1;
	}
	dobbelfil = (FILE*)0;
	return(retur);
}

/* NYT 130124 KONTROLGODK */
/* ******************************************************************** */
static long int check_don_wgk(int inpfunk) {
	long int retur = 0;
	long int nuvresnr = 0;
	unsigned long int nuvtid = 0;
	unsigned long int mintid = 0;
	unsigned long int maxtid = 0;
	char tmpstr[81] = "";
	char filsti[81] = "";
	FILE * godkfil;

	godkfil = (FILE*)0;
	if (logfil) {
		fprintf(logfil,"check_don_wgk:%d\n",inpfunk);
		fprintf(logfil,"\tKONTROLGODK\n");
		fflush(logfil);
	}
	nuvtid = (ULI)time(0);
	strcpy(tmpstr,ws_ipadr);
        rens_datotidstr(tmpstr);
	sprintf(filsti,"/tmp/don_%s_%ld.wgk",tmpstr,ws_kundenr);
	if (logfil) {
		fprintf(logfil,"\t%s\n",filsti);
		fflush(logfil);
	}
	if (inpfunk==0) {
		godkfil = fopen(filsti,"r");
		if (!godkfil) {
			godkfil = (FILE*)0;
		}
	}
	alfalow(tmpstr);
	if (inpfunk==0 && godkfil && fgets(tmpstr,80,godkfil)) {
		sscanf(tmpstr,"%ld %lu %lu",&nuvresnr,&mintid,&maxtid);
		fclose(godkfil);
		godkfil = (FILE*)0;
	}
	if (nuvresnr>0 &&
		mintid>0 && maxtid>0 &&
		nuvtid>mintid && nuvtid<maxtid) {
		retur = nuvresnr;
	}
	if (logfil) {
		fprintf(logfil,"\tmintid=%lu\n",mintid);
		fprintf(logfil,"\tnuvtid=%lu\n",nuvtid);
		fprintf(logfil,"\tmaxtid=%lu\n",maxtid);
		fprintf(logfil,"\tnuvresnr=%ld\n",nuvresnr);
		fprintf(logfil,"check_don_wgk:retur=%ld\n",retur);
		fflush(logfil);
	}
	return((long int)retur);
}

/* ******************************************************************** */
/* inpfunk	1 opret							*/
/*		3 slet							*/
/* ******************************************************************** */
static int opdat_don_wgk(int inpfunk,long inpresnr) {
	int retur = 0;
	char tmpstr[81] = "";
	char filsti[81] = "";
	unsigned long int mintid = 0;
	unsigned long int maxtid = 0;
	FILE * godkfil;

	godkfil = (FILE*)0;
	if (logfil) {
		fprintf(logfil,"opdat_don_wgk:%d %ld\n",inpfunk,inpresnr);
		fprintf(logfil,"\tKONTROLGODK\n");
		fflush(logfil);
	}
	strcpy(tmpstr,ws_ipadr);
        rens_datotidstr(tmpstr);
	sprintf(filsti,"/tmp/don_%s_%ld.wgk",tmpstr,ws_kundenr);
	if (logfil) {
		fprintf(logfil,"\t%s\n",filsti);
		fflush(logfil);
	}
	if (inpfunk==1) {
		godkfil = fopen(filsti,"w");
		if (!godkfil) {
			godkfil = (FILE*)0;
		}
	}
	if (inpfunk==1 && godkfil) {
		mintid = (ULI)time(0);
		maxtid = mintid;
		maxtid += 600;
		fprintf(godkfil,"%ld %lu %lu\n",
			r159->record_x,
			mintid,
			maxtid);
		fclose(godkfil);
		godkfil = (FILE*)0;
		(void)chmod(filsti,0777);
		retur = 1;
	}
	if (inpfunk==3) {
		(void)unlink(filsti);
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"opdat_don_wgk:retur=%d\n",retur);
	}
	return(retur);
}

/* ********************************** */
static int check_wanlogfilter() {
	int retur = 0;
	int idx = 0;
	char host[41] = "";
	char tmpstr[81] = "";
	FILE * tmpfil;

	tmpfil = (FILE*)0;
	gethostname(host,20);
	if (logfil) {
		fprintf(logfil,"check_wanlogfilter <%s>\n",host);
		fflush(logfil);
	}
	if (!strlen(ws_ipadr) && strcmp(host,"postgres")==0) {
		retur = 1;
	}
	if (retur==0) {
		sprintf(tmpstr,"waniplog.p7912");
		tmpfil = fopen(tmpstr,"r");
		if (!tmpfil) {
			tmpfil = (FILE*)0;
		}
	}
	idx = 0;
	while (tmpfil && retur==0 && idx<MAXWANLOGFILTER) {
		if (!fgets(tmpstr,80,tmpfil)) {
			break;
		}
		if (strlen(tmpstr)) {
			tmpstr[strlen(tmpstr)-1] = '\0';
		}
		if (!strlen(tmpstr)) {
			continue;
		}
		strcpy(ws_wanlog[idx],tmpstr);
		idx++;
	}
	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}
	idx = 0;
	while (idx<MAXWANLOGFILTER && strlen(ws_ipadr) && retur==0) {
		if (strcmp(ws_wanlog[idx],ws_ipadr)==0) {
			retur = 1;
		}
/* NYT 121112 */
		if (strcmp(ws_wanlog[idx],"*")==0) {
			retur = 1;
		}
		idx++;
	}
	return(retur);
}

/* ********************************** */
static int log_stopur(int inpfunk) {
	int retur = 0;
	struct timeb time_buffer;
	char returstr[41];
	char msekstr[21];

	ftime(&time_buffer);
	strcpy(returstr,ctime(&time_buffer.time)+11);
	returstr[8] = '\0';
	sprintf(msekstr,":%3.3hu",time_buffer.millitm);
	strcat(returstr,msekstr);
	if (logfil) {
/*
		fprintf(logfil,"stopur%2d:time=%s 1/1000=%hu\n",
			inpfunk,
			ctime(&time_buffer.time),
			time_buffer.millitm);
*/
		fprintf(logfil,"LOGSTOPUR%2.2d %s\n",inpfunk,returstr);
		fflush(logfil);
	}
	return(retur);
}

/* ************************* */
static void init_reg() {

	if (logfil) {
		fprintf(logfil,"init_reg:START\n");
	}
	switch(ws_funktion) {
	case 18 :
	case 19 :
	case 20 :
		f145_init(&f145, INPUT);
		f197_init(&f197, INPUT);
		f198_init(&f198, INPUT);
		f159_init(&f159, INPUT);
		f174_init(&f174, INPUT);
		f166_init(&f166, INPUT);
		f165_init(&f165, INPUT);
		f168_init(&f168, INPUT);
		f167_init(&f167, INPUT);
		f178_init(&f178, INPUT);
		break;
	case 15 :
		f159_init(&f159, INPUT);
		f165_init(&f165, INPUT);
		f166_init(&f166, INPUT);
		f198_init(&f198, INPUT);
		f167_init(&f167, INPUT);
		f178_init(&f178, INPUT);
		break;
	case 17 :
	case 44 :
		f197_init(&f197, IO_MAN);
		f198_init(&f198, IO_MAN);
		f159_init(&f159, IO_MAN);
		f145_init(&f145, IO_MAN);
		f167_init(&f167, INPUT);
		f178_init(&f178, INPUT);
		break;
	case 16 :
		f198_init(&f198, INPUT);
		f178_init(&f178, IO_MAN);
		f167_init(&f167, IO_MAN);
		f174_init(&f174, IO_MAN);
		break;
	case 13 :
	case 11 :
	case 32 :
		f165_init(&f165, INPUT);
		f198_init(&f198, INPUT);
		f159_init(&f159, INPUT);
		f359_init(&f359, INPUT);
		f167_init(&f167, INPUT);
		f178_init(&f178, INPUT);
		break;
	case 10 :
	case 12 :
	case 23 :
	case 30 :
	case 31 :
	case 33 :
	case 34 :
		f145_init(&f145, IO_MAN);
		f155_init(&f155, IO_MAN);
		f197_init(&f197, IO_MAN);
		f198_init(&f198, IO_MAN);
		f159_init(&f159, IO_MAN);
		f174_init(&f174, IO_MAN);
		f359_init(&f359, IO_MAN);
		f166_init(&f166, INPUT);
		f165_init(&f165, INPUT);
		f168_init(&f168, INPUT);
		f167_init(&f167, INPUT);
		f178_init(&f178, INPUT);
		bss = (BSS*) malloc(sizeof(BSS));
		reclow(bss, BSS);
		strcpy(bss->data_sti, ws_kreds);
		sprintf(ws_bruger, "ecar%2.2hd", ws_station);
		strcpy(bss->data_bruger, ws_bruger);
/* NYT 130522 */
		bss->unix_prt_type = 3;
		break;
	case 9 :
		f198_init(&f198, INPUT);
		f166_init(&f166, INPUT);
		f167_init(&f167, INPUT);
		f178_init(&f178, INPUT);
		break;
	case 8 :
	case 35 :
	case 38 :
		f198_init(&f198, IO_MAN);
		f178_init(&f178, IO_MAN);
		f167_init(&f167, IO_MAN);
		f174_init(&f174, IO_MAN);
		f166_init(&f166, INPUT);
		break;
	case 7 :
	case 36 :
		f198_init(&f198, INPUT);
		f166_init(&f166, INPUT);
		f167_init(&f167, INPUT);
		f178_init(&f178, INPUT);
		break;
	case 37 :
		f198_init(&f198, INPUT);
		f166_init(&f166, INPUT);
		f167_init(&f167, INPUT);
		f178_init(&f178, IO_MAN);
		break;
	case 6 :
	case 24 :
	case 25 :
	case 28 :
	case 39 :
	case 43 :
		f198_init(&f198, INPUT);
		f166_init(&f166, INPUT);
		break;
	case 40 :
	case 41 :
	case 42 :
		f198_init(&f198, INPUT);
		f166_init(&f166, INPUT);
		f172_init(&f172, INPUT);
		break;
	case 3 :
	case 4 :
	case 5 :
	case 21 :
	case 22 :
	case 27 :
	case 29 :
		f145_init(&f145, INPUT);
		f197_init(&f197, INPUT);
		f198_init(&f198, INPUT);
		f159_init(&f159, INPUT);
		f174_init(&f174, INPUT);
		f166_init(&f166, INPUT);
		f165_init(&f165, INPUT);
		f168_init(&f168, INPUT);
		f167_init(&f167, INPUT);
		f178_init(&f178, INPUT);
		bss = (BSS*) malloc(sizeof(BSS));
		reclow(bss, BSS);
		strcpy(bss->data_sti, ws_kreds);
		sprintf(ws_bruger, "ecar%2.2hd", ws_station);
		strcpy(bss->data_bruger, ws_bruger);
		break;
	case 1 :
	case 2 :
	case 999 :
		f198_init(&f198, INPUT);
		f166_init(&f166, INPUT);
		f165_init(&f165, INPUT);
		f168_init(&f168, INPUT);
		break;
	default :
		break;
	}
	if (logfil) {
		fprintf(logfil,"init_reg:SLUT\n");
	}
	return;
}

/* ******************************************************** */
static void close_reg() {

	if (logfil) {
		fprintf(logfil,"close_reg:START\n");
	}
	switch(ws_funktion) {
	case 18 :
	case 19 :
	case 20 :
		egeclose(f145);
		egeclose(f197);
		egeclose(f198);
		egeclose(f159);
		egeclose(f174);
		egeclose(f166);
		egeclose(f165);
		egeclose(f168);
		egeclose(f167);
		egeclose(f178);
		break;
	case 15 :
		egeclose(f159);
		egeclose(f198);
		egeclose(f166);
		egeclose(f165);
		egeclose(f167);
		egeclose(f178);
		break;
	case 17 :
	case 44 :
		egeclose(f197);
		egeclose(f198);
		egeclose(f159);
		egeclose(f145);
		egeclose(f167);
		egeclose(f178);
		break;
	case 16 :
		egeclose(f198);
		egeclose(f167);
		egeclose(f178);
		egeclose(f174);
		break;
	case 13 :
	case 11 :
	case 32 :
		egeclose(f165);
		egeclose(f198);
		egeclose(f159);
		egeclose(f359);
		egeclose(f167);
		egeclose(f178);
		break;
	case 10 :
	case 12 :
	case 23 :
	case 30 :
	case 31 :
	case 33 :
	case 34 :
		egeclose(f145);
		egeclose(f155);
		egeclose(f197);
		egeclose(f198);
		egeclose(f159);
		egeclose(f174);
		egeclose(f359);
		egeclose(f166);
		egeclose(f165);
                egeclose(f168);
		egeclose(f167);
		egeclose(f178);
		free(bss);
		break;
	case 9 :
		egeclose(f198);
		egeclose(f166);
		egeclose(f167);
		egeclose(f178);
		break;
	case 8 :
	case 35 :
	case 38 :
		egeclose(f198);
		egeclose(f178);
		egeclose(f167);
		egeclose(f174);
		egeclose(f166);
		break;
	case 7 :
	case 36 :
	case 37 :
		egeclose(f198);
		egeclose(f166);
		egeclose(f167);
		egeclose(f178);
		break;
	case 6 :
	case 24 :
	case 25 :
	case 28 :
	case 39 :
	case 43 :
		egeclose(f198);
		egeclose(f166);
		break;
	case 40 :
	case 41 :
	case 42 :
		egeclose(f198);
		egeclose(f166);
		egeclose(f172);
		break;
	case 3 :
	case 4 :
	case 5 :
	case 21 :
	case 22 :
	case 27 :
	case 29 :
		egeclose(f145);
		egeclose(f197);
		egeclose(f198);
		egeclose(f159);
		egeclose(f174);
		egeclose(f166);
		egeclose(f165);
		egeclose(f168);
		egeclose(f167);
		egeclose(f178);
		free(bss);
		break;
	case 1 :
	case 2 :
	case 999 :
		egeclose(f198);
		egeclose(f166);
		egeclose(f165);
		egeclose(f168);
		break;
	default :
		break;
	}
	if (logfil) {
		fprintf(logfil,"close_reg:SLUT\n");
	}
	return;
}

/* ************************************************************************** */
static int styr_don2_pdf() {
	int retur = 0;
	int lnnr = 0;
	int wx1 = 0;
	short int loopnr = 0;
	short int fundet = 0;
	short int kopi_nr = 0;
	short int nettoflag = 0;
	short int selvrflag = 0;
	short int specialflag = 0;
	char brandstr[21] = "";
	char emailadr[81] = "";
	char afsadr[81] = "";
	char afsnavn[81] = "";
	char emnestr[81] = "";
	char pdfsti[81] = "";
	char konvsti[81] = "";
	char tmpstr[201] = "";
	FILE * tmpfil;

	tmpfil = (FILE*)0;
	if (logfil) {
		fprintf(logfil,"styr_don2_pdf\n");
		fprintf(logfil,"\tws_pdftype=%hd\n",ws_pdftype);
		fprintf(logfil,"\tws_resnr=%ld\n",ws_resnr);
		fprintf(logfil,"\tws_emailadr=%s\n",ws_emailadr);
		fflush(logfil);
	}
	reclow(r159,R159);
	f159_start(1,ISGTEQ);
	r159->record_x = ws_resnr;
	egeread(f159,ISEQUAL);
	if (f159_ukendt) {
		goto afslut;
	}
	if (ws_pdftype==1 && ws_kundenr>0) {
		reclow(r178,R178);
		f178_start(1,ISGTEQ);
		r178->kunde_nr = (double)ws_kundenr;
		r178->opl_kode = 10;
		egeread(f178,ISEQUAL);
		if (f178_ok && strlen(r178->alfa_felt)) {
			strcpy(emailadr,r178->alfa_felt);
		}
	}
	if (logfil) {
		fprintf(logfil,"\temailadr=%s\n",emailadr);
	}
	if (ws_pdftype==1 && !strlen(emailadr)) {
		goto afslut;
	}
	if (ws_pdftype==1) {
		sprintf(tmpstr,"/tmp/p7912body_%hd.tmp",ege_pid);
		tmpfil = fopen(tmpstr,"w");
		if (tmpfil) {
			fprintf(tmpfil,"Kære kunde\n");
			fprintf(tmpfil,"\n");
			fprintf(tmpfil,"Vedhæftet er den ønskede kontrakt (pdf).\n");
			fprintf(tmpfil,"\n");
			fprintf(tmpfil,"   MVH\n");
			fprintf(tmpfil,"driveon.net\n");
			fclose(tmpfil);
		}
		tmpfil = (FILE*)0;
	}
/* TEST OBS */
	if (ws_pdftype==1) {
		strcpy(emailadr,"claus@egetved.dk");
		sprintf(emnestr,"DON RA %ld",ws_resnr);
		strcpy(afsadr,"info@driveon.net");
		strcpy(afsnavn,"driveon.net");
	}
/* NYT 150415 WEBAPI34 */
	if (ws_pdftype==1 && ws_funktion==34) {
		strcpy(emailadr,"cb@goapplicate.dk");
		sprintf(emnestr,"RA %ld",ws_resnr);
		strcpy(afsadr,"info@europcar.dk");
		strcpy(afsnavn,"www.europcar.dk");
	}

	if (ws_pdftype==1 && strlen(ws_emailadr)) {
		strcpy(emailadr,ws_emailadr);
	}
	if (logfil) {
		fprintf(logfil,"\temailadr=%s\n",emailadr);
	}




		bss->felt_kode[1] = 0;
		bss->felt_kode[2] = 0;
		if (r159->sprog_kode==0) {
			bss->felt_kode[1] = 1;
			bss->felt_kode[2] = 0;
		}
		if (r159->sprog_kode==1) {
			bss->felt_kode[1] = 0;
			bss->felt_kode[2] = 1;
		}
		if (r159->kontrakttype_kode==1) {
			bss->felt_kode[8] = 1;
		}
		if (r159->kontrakttype_kode==2) {
			bss->felt_kode[3] = 1;
			bss->felt_kode[8] = 2;
		}
		if (r159->kontrakttype_kode==3) {
			bss->felt_kode[1] = 1;
			bss->felt_kode[2] = 0;
			bss->felt_kode[3] = 1;
			bss->felt_kode[8] = 5;
		}
		if (r159->status == 13 ||
			r159->status == 14 ||
			r159->status == 6 ||
			r159->status == 4) {
			bss->felt_kode[4] = 1;
			bss->felt_kode[7] = 1;
		} else {
			bss->felt_kode[4] = 0;
			bss->felt_kode[7] = 0;
		}
		bss->felt_kode[5] = 1;
		bss->felt_kode[6] = 0;
		bss->felt_kode[9] = 0;

	if (ws_pdftype==0) {
		bss->felt_kode[15] = 2;
	}
/* NYT 150415 WEBAPI34 */
	if (ws_pdftype==0 && ws_funktion==34) {
		bss->felt_kode[15] = 2;
		bss->felt_kode[14] = 2;
		bss->felt_kode[8] = 1;
	}

	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16610;
	r198->keynum = (double)r159->station_ud_nr;
	egeread(f198,ISEQUAL);
	if (f198_ok) {
		strcpy(brandstr,r198->alfafelt);
	}
/* NYT 150415 WEBAPI34 */
	if (ws_funktion==34 && !strlen(brandstr)) {
		strcpy(brandstr,"EC");
	}

	if (logfil) {
		fprintf(logfil,"\tbrandstr=%s\n",brandstr);
		fprintf(logfil,"\tKONPRINT\n");
		fflush(logfil);
	}

	(void)konprint(1,
		emailadr,
		brandstr,
		afsadr,
		afsnavn,
		emnestr,
		kopi_nr,
		nettoflag,
		selvrflag,
		specialflag);
	if (logfil) {
		fprintf(logfil,"\tEFTER KONPRINT\n");
		fflush(logfil);
	}
	ege_pclose_direkte(listeptr);
/*
	ege_pclose(listeptr);
*/
	listeptr = (FILE*)0;
	if (ws_pdftype==1) {
		alfalow(str);
		pack_init(str);
		pack_alfa("OK");
		sprintf(tmpstr, "RA %ld mail sendt til %s",ws_resnr,emailadr);
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur = 1;
	}
	if (ws_pdftype==0) {
		sprintf(pdfsti,"/tmp/%hd_don%ld.pdf",ege_pid,ws_resnr);
	}
/* NYT 150415 WEBAPI34 */
	if (ws_pdftype==0 && ws_funktion==34) {
		sprintf(pdfsti,"/tmp/%hd_ec%ld.pdf",ege_pid,ws_resnr);
	}

	if (logfil) {
		fprintf(logfil,"\tpdfsti=%s\n",pdfsti);
	}
	fundet = 0;
	loopnr = 0;
	while (ws_pdftype==0 && fundet==0 && loopnr<10) {
		loopnr++;
		if (logfil) {
			fprintf(logfil,"\t\tloopnr=%hd fundet=%hd\n",
				loopnr,
				fundet);
		}
		(void)sleep(1);
		if (access(pdfsti,0)==0) {
			fundet = 1;
		}
	}
	if (logfil) {
		fprintf(logfil,"\tfundet=%hd\n",fundet);
	}
	if (ws_pdftype==0 && fundet>0) {
		sprintf(konvsti, "/tmp/base64_%hd.fil",ege_pid);
		(void)unlink(konvsti);
		ateof = FALSE;
		linelength= 0;
		base64_en_init();
		(void)base64_encode(pdfsti,konvsti);
		tmpfil = fopen(konvsti,"r");
		if (!tmpfil) {
			tmpfil = (FILE*)0;
		}
	}
	while (ws_pdftype==0 && fundet>0 && tmpfil) {
		if (!fgets(tmpstr,100,tmpfil)) {
			break;
		}
		if (strlen(tmpstr)) {
			tmpstr[strlen(tmpstr)-1] = '\0';
		}
		alfalow(str);
		pack_init(str);
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		lnnr++;
		retur++;
	}
	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}
	if (logfil) {
		fprintf(logfil,"\tlnnr=%d\n",lnnr);
	}

/* OPRYD */
	sprintf(ege_w_ch1,"/tmp/espool_%hd.tmp",ege_pid);
	(void)unlink(ege_w_ch1);
	wx1 = 1;
	if (ws_funktion==34) { wx1 = 0; }
 	if (wx1==1 && strlen(pdfsti)) {
		(void)unlink(pdfsti);
	}
 	if (strlen(konvsti)) {
		(void)unlink(konvsti);
	}
	sprintf(tmpstr,"/tmp/p7912body_%hd.tmp",ege_pid);
	(void)unlink(tmpstr);
afslut:
	if (logfil) {
		fprintf(logfil,"styr_don2_pdf retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************************** */
static int send_don2_proddefs() {
	int retur = 0;
	int dagnrfundet = 0;
	int maxantal = 0;
	int nuvantal = 0;
	int nuvdagnr = 0;
	int chkdagnr = 0;
	int specnrflag = 0;
	int specnrfundet = 0;
	long int varighed = 1;
	long int nuvjulian = 0;
	long int nuvaar = 0;
	long int julian = 0;
	long int julian2 = 0;
	long int nuvdato = 0;
	long int returdato = 0;
	long int startdato = 0;
	long int starttid = 800;
	long int slutdato = 0;
	long int sluttid = 800;
	char tmpstr[201] = "";

	ws_stepnr = 2;
	if (logfil) {
		fprintf(logfil,"send_don2_proddefs\n");
		fprintf(logfil,"\tws_station=%hd\n",ws_station);
		fprintf(logfil,"\tws_grp=%s\n",ws_grp);
		fprintf(logfil,"\tws_donspcstr=%s\n",ws_donspcstr);
	}
	specnrflag = 0;
/*
	specnrflag = 1;
	(void)retur_numalfa_data(1,ws_donspcstr,tmpstr);
	if (strlen(tmpstr) && strcmp(ws_donspcstr,tmpstr)==0) {
		specnrflag = 0;
	}
*/
	if (logfil) {
		fprintf(logfil,"\ttmpstr=%s\n",tmpstr);
		fprintf(logfil,"\tspecnrflag=%d\n",specnrflag);
	}
	if (specnrflag==0 && strcmp(ws_donspcstr,"JUL1")==0) {
		ws_specnr = 650;
		strcpy(ws_grp,"A");
		ws_station = 66;
	}
	if (specnrflag==0 && strcmp(ws_donspcstr,"JUL2")==0) {
		ws_specnr = 650;
		strcpy(ws_grp,"A");
		ws_station = 58;
	}
	if (specnrflag==0 && strcmp(ws_donspcstr,"JUL3")==0) {
		ws_specnr = 650;
		strcpy(ws_grp,"3");
		ws_station = 66;
	}
	if (specnrflag==0 && strcmp(ws_donspcstr,"JUL4")==0) {
		ws_specnr = 650;
		strcpy(ws_grp,"3");
		ws_station = 58;
	}
/* NYT 130607 */

	if (specnrflag==0 && strcmp(ws_donspcstr,"WEEKEND1")==0) {
		ws_specnr = 196;
		strcpy(ws_grp,"A");
		ws_station = 66;
	}
	if (specnrflag==0 && strcmp(ws_donspcstr,"WEEKEND2")==0) {
		ws_specnr = 196;
		strcpy(ws_grp,"A");
		ws_station = 58;
	}
	if (specnrflag==0 && strcmp(ws_donspcstr,"WEEKEND3")==0) {
		ws_specnr = 196;
		strcpy(ws_grp,"3");
		ws_station = 66;
	}
	if (specnrflag==0 && strcmp(ws_donspcstr,"WEEKEND4")==0) {
		ws_specnr = 196;
		strcpy(ws_grp,"3");
		ws_station = 58;
	}

	if (specnrflag==0 && strcmp(ws_donspcstr,"LANGWEEKENDT1")==0) {
		ws_specnr = 197;
		strcpy(ws_grp,"A");
		ws_station = 66;
	}
	if (specnrflag==0 && strcmp(ws_donspcstr,"LANGWEEKENDT2")==0) {
		ws_specnr = 197;
		strcpy(ws_grp,"A");
		ws_station = 58;
	}
	if (specnrflag==0 && strcmp(ws_donspcstr,"LANGWEEKENDT3")==0) {
		ws_specnr = 197;
		strcpy(ws_grp,"3");
		ws_station = 66;
	}
	if (specnrflag==0 && strcmp(ws_donspcstr,"LANGWEEKENDT4")==0) {
		ws_specnr = 197;
		strcpy(ws_grp,"3");
		ws_station = 58;
	}

	if (specnrflag==0 && strcmp(ws_donspcstr,"LANGWEEKENDF1")==0) {
		ws_specnr = 198;
		strcpy(ws_grp,"A");
		ws_station = 66;
	}
	if (specnrflag==0 && strcmp(ws_donspcstr,"LANGWEEKENDF2")==0) {
		ws_specnr = 198;
		strcpy(ws_grp,"A");
		ws_station = 58;
	}
	if (specnrflag==0 && strcmp(ws_donspcstr,"LANGWEEKENDF3")==0) {
		ws_specnr = 198;
		strcpy(ws_grp,"3");
		ws_station = 66;
	}
	if (specnrflag==0 && strcmp(ws_donspcstr,"LANGWEEKENDF4")==0) {
		ws_specnr = 198;
		strcpy(ws_grp,"3");
		ws_station = 58;
	}




	if (specnrflag>0) {
		get_alfa_tgn(ws_donspcstr,0,ws_tmppara,';');
		if (strlen(ws_tmppara)) {
			sscanf(ws_tmppara,"%hd",&ws_specnr);
		}
		get_alfa_tgn(ws_donspcstr,1,ws_extspcstr,';');
	}
	if (logfil) {
		fprintf(logfil,"\tws_specnr=%hd\n",ws_specnr);
	}
	if (ws_specnr<=0) { goto afslut; }
	if (ws_station<=0) { goto afslut; }
	if (!strlen(ws_grp)) { goto afslut; }

	varighed = 1;
	reclow(r165,R165);
	f165_start(1,ISGTEQ);
	r165->spec_nr = ws_specnr;
	r165->stat_nr = ws_station;
	strcpy(r165->bil_grp,ws_grp);
	egeread(f165,ISEQUAL);
	if (r165->slet_mark>0) {
		goto afslut;
	}

	if (f165_ok && r165->enhed>200 && r165->enhed<300) {
		varighed = (long int)r165->enhed;
		varighed -= 200;
		specnrfundet = 1;
	}
	if (f165_ok && r165->enhed>400 && r165->enhed<500) {
		varighed = (long int)r165->enhed;
		varighed -= 400;
		varighed *= 30;
		specnrfundet = 1;
	}

	if (logfil) {
		fprintf(logfil,"\tspecnrfundet=%hd\n",specnrfundet);
	}
	if (specnrfundet<=0) {
		goto afslut;
	}

	julian = m036_funktion(12, ws_systemdato);
	dagnrfundet = 1;
	maxantal = 7;
	nuvantal = 0;
	if (ws_specnr==196) {
		dagnrfundet = 0;
		chkdagnr = 5;
		ws_stepnr = 4;
	}
	if (ws_specnr==197) {
		dagnrfundet = 0;
		chkdagnr = 4;
		ws_stepnr = 4;
	}
	if (ws_specnr==198) {
		dagnrfundet = 0;
		chkdagnr = 5;
		ws_stepnr = 4;
	}
	if (ws_specnr==185) {
		starttid = 1600;
	}
	if (ws_specnr==650) {
		nuvaar = ws_systemdato / 10000;
		startdato = nuvaar;
		startdato *= 10000;
		startdato += 1222;
		julian = m036_funktion(12, startdato);
		varighed = 5;
		ws_stepnr = 4;
		goto videre;
	}


	if (dagnrfundet==1) {
		julian++;
		startdato = m036_funktion(19, julian);
	}
	while (dagnrfundet==0 && nuvantal<maxantal) {
		nuvdato = m036_funktion(19, julian);
		returdato = m036_funktion(11, nuvdato);
		nuvdagnr = (int)(returdato%10);
		if (chkdagnr==nuvdagnr) {
			startdato = nuvdato;
			dagnrfundet = 1;
			break;
		}
		nuvantal++;
		julian++;
	}
videre:
	if (dagnrfundet>0 && varighed>=1) {
		julian += varighed;
		slutdato = m036_funktion(19, julian);
	}
	if (logfil) {
		fprintf(logfil,"\tstartdato=%ld\n",startdato);
		fprintf(logfil,"\tstarttid=%ld\n",starttid);
		fprintf(logfil,"\tslutdato=%ld\n",slutdato);
		fprintf(logfil,"\tsluttid=%ld\n",sluttid);
		fprintf(logfil,"\tws_stepnr=%d\n",ws_stepnr);
	}
	if (ws_stepnr>=3) {
		ws_fradato = startdato;
		ws_tildato = slutdato;
		ws_fratid = starttid;
		ws_tiltid = sluttid;
		retur = 100;
		goto afslut;
	}

	alfalow(str);
	pack_init(str);
/* Step */
	sprintf(tmpstr,"%d",ws_stepnr);
	pack_alfa(tmpstr);
/* ProductId */
	sprintf(tmpstr,"%s",ws_donspcstr);
	pack_alfa(tmpstr);
/* LocationId */
	sprintf(tmpstr,"%hd",ws_station);
	pack_alfa(tmpstr);
/* PickupDate */
	ege_w_int1 = m036_funktion(17,(long int)startdato);
	sprintf(tmpstr,"%8.8ld",ege_w_int1);
	pack_alfa(tmpstr);
/* PickupTime */
	sprintf(tmpstr,"%4.4ld",starttid);
	pack_alfa(tmpstr);
/* ReturnDate */
	ege_w_int1 = m036_funktion(17,(long int)slutdato);
	sprintf(tmpstr,"%8.8ld",ege_w_int1);
	pack_alfa(tmpstr);
/* ReturnTime */
	sprintf(tmpstr,"%4.4ld",sluttid);
	pack_alfa(tmpstr);
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	retur++;
afslut:
	if (logfil) {
		fprintf(logfil,"send_don2_proddefs retur=%d\n",retur);
	}
	return(retur);
}

/* ************************************************************************** */
static int send_ps_fp_default() {
	int retur = 0;
	int wx1 = 0;
	int funkretur = 0;
	int aabenantal = 0;
	int udtid = 0;
	short int lukketflag = 0;
	short int aftaleflag = 0;
	short int defspecnr = 180;
	short int defstation = 66;
	char defproduktnavn[41] = "1 dag";
	long int varighed = 1;
	long int julian = 0;
	long int chkdato = 0;
	long int firmakundenr = 0;
	long int firmaaftfra = 0;
	long int firmaafttil = 0;
	char tmpstr[201] = "";
	double niv_pris = 0;
	double niv_cdi = 0;
	double niv_pai = 0;
	double niv_km = 0;
	long int inclkm = 0;

	if (logfil) {
		fprintf(logfil, "send_ps_fp_default\n");
		fprintf(logfil, "\tws_kundenr=%ld\n",ws_kundenr);
		fflush(logfil);
	}
/*
	if (ws_station<=0) {
		ws_don2errno = DON2FPDLOC;
	}
	if (ws_don2errno>0) {
		(void)frankly_err(ws_funktion,
			"fejl",ws_don2errno);
		retur = 1;
		goto afslut;
	}
*/
/* NYT 130416 AFTALEFLAG */
/*
        if (ws_kundenr>0) {
		reclow(r167, R167);
		f167_start(1, ISGTEQ);
		r167->kunde_nr = ws_kundenr;
		egeread(f167, ISEQUAL);
		if (f167_ok && r167->type==2) {
			firmakundenr = r167->kunde_nr;
		}
	}
	if (firmakundenr>0) {
		if (find_r178(0,16,0,(double)firmakundenr)>0) {
			firmaaftfra = (long int)r178->num_felt;
		}
		if (find_r178(0,4,0,(double)firmakundenr)>0) {
			firmaafttil = (long int)r178->num_felt;
		}
		if (firmaafttil==0) {
			firmaafttil = 99999999;
		}
	}
	if (firmakundenr>0 &&
		firmaaftfra>0 &&
		ws_systemdato>=firmaaftfra && ws_systemdato<=firmaafttil) {
		aftaleflag = 1;
	}
	if (logfil) {
		fprintf(logfil, "\tfirmaaft=%ld-%ld\n",
			firmaaftfra,
			firmaafttil);
		fprintf(logfil, "\tfirmakundenr=%ld\n",firmakundenr);
		fprintf(logfil, "\taftaleflag=%hd\n",aftaleflag);
		fflush(logfil);
	}
	reclow(r165,R165);
	f165_start(1,ISGTEQ);
*/

	alfalow(str);
	pack_init(str);
/* PickupDate */
	udtid = 1600;
	julian = m036_funktion(12, ws_systemdato);
/*
	if (ws_systemtid>1500) {
		julian += (long int)1;
		udtid = 800;
	}
*/
	julian += (long int)1;
/* NYT 131223 CHECKFPLUKKET */
	lukketflag = 1;
	while (lukketflag>0) {
		aabenantal = 0;
		chkdato = m036_funktion(19, julian);
		funkretur = check_bssaaben(-1,52,chkdato,-1);
		if (funkretur>0) { aabenantal++; }
		funkretur = check_bssaaben(-1,53,chkdato,-1);
		if (funkretur>0) { aabenantal++; }
		funkretur = check_bssaaben(-1,61,chkdato,-1);
		if (funkretur>0) { aabenantal++; }
		if (aabenantal>=3) {
			lukketflag = 0;
			break;
		}
		julian += (long int)1;
		if (logfil) {
			fprintf(logfil,
				"\t\tCHECKFPLUKKET aabenantal=%d julian=%ld\n",
				aabenantal,
				julian);
		}
	}
	udtid = 700;
/* RETTET 140512 DEFAULTTID
	udtid = 800;
*/
	ege_w_int2 = m036_funktion(19, julian);
	ege_w_int1 = m036_funktion(17,(long int)ege_w_int2);
	sprintf(tmpstr,"%8.8ld",ege_w_int1);
	pack_alfa(tmpstr);
/* PickupTime */
	sprintf(tmpstr,"%4.4d",udtid);
	pack_alfa(tmpstr);
/* ReturnDate */
	julian += (long int)1;
	ege_w_int2 = m036_funktion(19, julian);
	ege_w_int1 = m036_funktion(17,(long int)ege_w_int2);
	sprintf(tmpstr,"%8.8ld",ege_w_int1);
	pack_alfa(tmpstr);
/* ReturnTime */
	sprintf(tmpstr,"0700");
/* RETTET 140512 DEFAULTTID
	sprintf(tmpstr,"0800");
*/
	pack_alfa(tmpstr);
/* MinAlder */
	sprintf(tmpstr,"20");
	pack_alfa(tmpstr);
/* MaxAlder */
	sprintf(tmpstr,"26");
	pack_alfa(tmpstr);
/* DefaultStationNr */
	sprintf(tmpstr,"0");
	pack_alfa(tmpstr);
/* NYT 140723 PSFPDEFAULTTID */
	sprintf(tmpstr,"0700");
	pack_alfa(tmpstr);
	sprintf(tmpstr,"0700");
	pack_alfa(tmpstr);

	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	retur++;
afslut:
	return(retur);
}

/* ************************************************************************** */
static int send_don2_fp_default() {
	int retur = 0;
	int wx1 = 0;
	int funkretur = 0;
	int udtid = 0;
	short int aftaleflag = 0;
	short int defspecnr = 180;
	short int defstation = 66;
	char defproduktnavn[41] = "1 dag";
	long int varighed = 1;
	long int julian = 0;
	long int firmakundenr = 0;
	long int firmaaftfra = 0;
	long int firmaafttil = 0;
	char tmpstr[201] = "";
	double niv_pris = 0;
	double niv_cdi = 0;
	double niv_pai = 0;
	double niv_km = 0;
	long int inclkm = 0;

	if (logfil) {
		fprintf(logfil, "send_don2_fp_default\n");
		fprintf(logfil, "\tws_kundenr=%ld\n",ws_kundenr);
		fflush(logfil);
	}
/*
	if (ws_station<=0) {
		ws_don2errno = DON2FPDLOC;
	}
	if (ws_don2errno>0) {
		(void)frankly_err(ws_funktion,
			"fejl",ws_don2errno);
		retur = 1;
		goto afslut;
	}
*/
/* NYT 130416 AFTALEFLAG */
        if (ws_kundenr>0) {
		reclow(r167, R167);
		f167_start(1, ISGTEQ);
		r167->kunde_nr = ws_kundenr;
		egeread(f167, ISEQUAL);
		if (f167_ok && r167->type==2) {
			firmakundenr = r167->kunde_nr;
		}
	}
	if (firmakundenr>0) {
		if (find_r178(0,16,0,(double)firmakundenr)>0) {
			firmaaftfra = (long int)r178->num_felt;
		}
		if (find_r178(0,4,0,(double)firmakundenr)>0) {
			firmaafttil = (long int)r178->num_felt;
		}
		if (firmaafttil==0) {
			firmaafttil = 99999999;
		}
	}
	if (firmakundenr>0 &&
		firmaaftfra>0 &&
		ws_systemdato>=firmaaftfra && ws_systemdato<=firmaafttil) {
		aftaleflag = 1;
	}
	if (logfil) {
		fprintf(logfil, "\tfirmaaft=%ld-%ld\n",
			firmaaftfra,
			firmaafttil);
		fprintf(logfil, "\tfirmakundenr=%ld\n",firmakundenr);
		fprintf(logfil, "\taftaleflag=%hd\n",aftaleflag);
		fflush(logfil);
	}
	reclow(r165,R165);
	f165_start(1,ISGTEQ);

	alfalow(str);
	pack_init(str);
/* UpLeftProductId */
	sprintf(tmpstr,"%hd",defspecnr);
	pack_alfa(tmpstr);
/* UpLeftCategoryId */
	sprintf(tmpstr,"3");
	pack_alfa(tmpstr);
/* UpLeftText */
	sprintf(tmpstr,"LEJ DEN STORE");
	pack_alfa(tmpstr);
/* UpLeftModel */
	sprintf(tmpstr,"Renault Trafic");
	pack_alfa(tmpstr);
/* UpLeftPriceDKK */
	r159->rate_spec_nr[0] = defspecnr;
	r159->rate_station[0] = defstation;
	strcpy(r159->rate_gruppe[0],"3");
	r159->rate_antal[0] = varighed;

	r165->spec_nr = defspecnr;
	r165->stat_nr = defstation;
	strcpy(r165->bil_grp,"3");
	sprintf(tmpstr,"?");
	ege_w_dou1 = 0;
	egeread(f165,ISEQUAL);
	if (f165_ok) {
		ege_w_dou1 = r165->pris;
		ege_w_dou1 += (double)r165->rate_cdw;
	}
/* NYT 130521 DEFAULTFIRMAAFTALE */
	if (aftaleflag>0) {
		wx1 = find_f198_firmaaftale(defstation,
                        r165->spec_nr,
                        r165->bil_grp,
                        &niv_pris,
                        &niv_cdi,
                        &niv_pai,
                        &niv_km,
                        &inclkm);
	}
	if (logfil) {
		fprintf(logfil,"\twx1=%d\n",wx1);
		fprintf(logfil,"\tniv_pris=%.2lf\n",niv_pris);
		fprintf(logfil,"\tniv_cdi=%.2lf\n",niv_cdi);
		fprintf(logfil,"\tniv_pai=%.2lf\n",niv_pai);
		fprintf(logfil,"\tniv_km=%.2lf\n",niv_km);
		fprintf(logfil,"\tinclkm=%ld\n",inclkm);
	}
	if (aftaleflag>0 && wx1>0) {
		ege_w_dou1 = niv_pris;
		ege_w_dou1 += (double)r165->rate_cdw;
	}
/* NYT 121108 MBIDRAGOK */
	if (ege_w_dou1>0 && ECMBIDRAG>0) {
		funkretur = adm_mbidrag(2,
			ECMBIDRAG,
			varighed,
			&ws_mbidrag);
	}
	if (ege_w_dou1>0 && ECMBIDRAG>0 && funkretur>0 && ws_mbidrag>0) {
		ws_mbidrag *= 1.25;
		ege_w_dou1 += ws_mbidrag;
	}

/* TEST */
	if (logfil) {
		fprintf(logfil,"\tvarighed=%ld,funkretur=%d,ws_mbidrag=%.2lf\n",
			varighed,
			funkretur,
			ws_mbidrag);
		fflush(logfil);
	}
	if (ege_w_dou1>0) {
		xls_char(tmpstr,(double)ege_w_dou1,2);
	}
	pack_alfa(tmpstr);
/* UpLeftPriceText */
	sprintf(tmpstr,"%s i København",defproduktnavn);
	pack_alfa(tmpstr);
/* UpRightProductId */
	sprintf(tmpstr,"%hd",defspecnr);
	pack_alfa(tmpstr);
/* UpRightCategory */
	sprintf(tmpstr,"A");
	pack_alfa(tmpstr);
/* UpRightText */
	sprintf(tmpstr,"LEJ DEN LILLE");
	pack_alfa(tmpstr);
/* UpRightModel */
	sprintf(tmpstr,"Renault Clio");
	pack_alfa(tmpstr);
/* UpRightPriceDKK */
	r165->spec_nr = defspecnr;
	r165->stat_nr = defstation;
	strcpy(r165->bil_grp,"A");
	sprintf(tmpstr,"?");
	egeread(f165,ISEQUAL);
	if (f165_ok) {
		ege_w_dou1 = r165->pris;
		ege_w_dou1 += (double)r165->rate_cdw;
	}
/* NYT 130521 DEFAULTFIRMAAFTALE */
	if (aftaleflag>0) {
		wx1 = find_f198_firmaaftale(defstation,
                        r165->spec_nr,
                        r165->bil_grp,
                        &niv_pris,
                        &niv_cdi,
                        &niv_pai,
                        &niv_km,
                        &inclkm);
	}
	if (logfil) {
		fprintf(logfil,"\twx1=%d\n",wx1);
		fprintf(logfil,"\tniv_pris=%.2lf\n",niv_pris);
		fprintf(logfil,"\tniv_cdi=%.2lf\n",niv_cdi);
		fprintf(logfil,"\tniv_pai=%.2lf\n",niv_pai);
		fprintf(logfil,"\tniv_km=%.2lf\n",niv_km);
		fprintf(logfil,"\tinclkm=%ld\n",inclkm);
	}
	if (aftaleflag>0 && wx1>0) {
		ege_w_dou1 = niv_pris;
		ege_w_dou1 += (double)r165->rate_cdw;
	}
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
/* UpRightPriceText */
	sprintf(tmpstr,"%s i København",defproduktnavn);
	pack_alfa(tmpstr);
/* PrivateLoginCheckMark */
	sprintf(tmpstr,"True");
	pack_alfa(tmpstr);
/* CompanyLoginCheckMark */
	sprintf(tmpstr,"False");
	pack_alfa(tmpstr);
/*
	sprintf(tmpstr,"Kørekort");
	pack_alfa(tmpstr);
	sprintf(tmpstr,"Fødselsdato");
	pack_alfa(tmpstr);
	sprintf(tmpstr,"Firmanavn");
	pack_alfa(tmpstr);
	sprintf(tmpstr,"Kundenr");
	pack_alfa(tmpstr);
*/
/* Bottom1Text */
	sprintf(tmpstr,"Test driveon.net grafik");
	pack_alfa(tmpstr);
/* Bottom1GraphicUrl */
	sprintf(tmpstr,"");
	strcpy(tmpstr,"http://80.62.245.11/Files/Templates/Designs/Main/images/nyheder-img-1.png");
	pack_alfa(tmpstr);
/* Bottom1DestinationUrl */
	sprintf(tmpstr,"");
	strcpy(tmpstr,"http://www.google.dk");
	pack_alfa(tmpstr);
/* Bottom1ButtonText */
	sprintf(tmpstr,"Google-link");
	pack_alfa(tmpstr);
/* Bottom2Text */
	sprintf(tmpstr,"Velkommen til driveon.net");
	pack_alfa(tmpstr);
/* Bottom2GraphicUrl */
	sprintf(tmpstr,"");
	pack_alfa(tmpstr);
/* Bottom2DestinationUrl */
	sprintf(tmpstr,"");
	pack_alfa(tmpstr);
/* Bottom2ButtonText */
	sprintf(tmpstr,"Læs mere her");
	pack_alfa(tmpstr);
/* Bottom3Text */
	sprintf(tmpstr,"Velkommen til driveon.net");
	pack_alfa(tmpstr);
/* Bottom3GraphicUrl */
	sprintf(tmpstr,"");
	pack_alfa(tmpstr);
/* Bottom3DestinationUrl */
	sprintf(tmpstr,"");
	pack_alfa(tmpstr);
/* Bottom3ButtonText */
	sprintf(tmpstr,"Læs mere her");
	pack_alfa(tmpstr);
/* LocationId */
	sprintf(tmpstr,"%hd",defstation);
	pack_alfa(tmpstr);
/* PickupDate */
	udtid = 1600;
	julian = m036_funktion(12, ws_systemdato);
	if (ws_systemtid>1500) {
		julian += (long int)1;
		udtid = 800;
	}
	ege_w_int2 = m036_funktion(19, julian);
	ege_w_int1 = m036_funktion(17,(long int)ege_w_int2);
	sprintf(tmpstr,"%8.8ld",ege_w_int1);
	pack_alfa(tmpstr);
/* PickupTime */
	sprintf(tmpstr,"%4.4d",udtid);
	pack_alfa(tmpstr);
/* ReturnDate */
	julian += (long int)1;
	ege_w_int2 = m036_funktion(19, julian);
	ege_w_int1 = m036_funktion(17,(long int)ege_w_int2);
	sprintf(tmpstr,"%8.8ld",ege_w_int1);
	pack_alfa(tmpstr);
/* ReturnTime */
	sprintf(tmpstr,"0800");
	pack_alfa(tmpstr);
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	retur++;
afslut:
	return(retur);
}

/* *********************** */
static int frankly_err(int inpfunk,char *inptxt,long inpkode) {
	int retur = 0;
	int chkfjlkode = 0;
	char inpstr[501] = "";
	char fejlstr[501] = "";
	char kodestr[21] = "";
	FILE * fejlfil;

	fejlfil = (FILE*)0;
	if (inpkode<10000) {
		retur = inpfunk;
		retur *= 10000;
		retur += inpkode;
	} else {
		retur = (int)inpkode;
	}
	sprintf(inpstr,"don2fejl.%d",retur);
/* NYT 150326 WEBAPI */
	if (ws_funktion>=24 && ws_brandtype<3) {
//		sprintf(inpstr,"webapifejl.%d",retur);
/* NYT 150520 WEBAPIFEJLKODE */
		sprintf(inpstr,"ecwebapi_fejl.csv");
		goto webapi00;
	}
	fejlfil = fopen(inpstr,"r");
	if (fejlfil) {
                if (!fgets(inpstr,500,fejlfil)) {
			sprintf(inpstr,"(%d) fejl beskrivelse på vej...",retur);
                } else {
                        inpstr[strlen(inpstr)-1] = '\0';
                }
		fclose(fejlfil);
	}
	fejlfil = (FILE*)0;
	alfalow(str);
	pack_init(str);
	pack_alfa("ERR");
	pack_int2((long)retur);
/* NYT 140918 ERRKODEITEST */
	if (ws_testkreds>0) {
		sprintf(kodestr," (fejlkode=%d)",retur);
		strcat(inpstr,kodestr);
	}
	pack_alfa(inpstr);
/*
	pack_alfa(inptxt);
*/
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	goto afslut;
webapi00:
	fejlfil = fopen(inpstr,"r");
	if (!fejlfil) {
		sprintf(fejlstr,"(%d) fejl beskrivelse på vej...",retur);
		fejlfil = (FILE*)0;
		goto webapi99;
	}
	while (fejlfil && !strlen(fejlstr)) {
                if (!fgets(inpstr,500,fejlfil)) {
			sprintf(fejlstr,
				"(%d) fejl beskrivelse på vej...",retur);
			break;
                }
		(void)get_alfa_tgn(inpstr,0,kodestr,59);
		if (strlen(kodestr)) {
			sscanf(kodestr,"%d",&chkfjlkode);
		}
		if (chkfjlkode!=retur) {
			continue;
		}
		(void)get_alfa_tgn(inpstr,1,fejlstr,59);
	}
	if (fejlfil) {
		fclose(fejlfil);
		fejlfil = (FILE*)0;
	}
webapi99:
	alfalow(str);
	pack_init(str);
	pack_alfa("ERR");
	pack_int2((long)retur);
	if (ws_testkreds>0) {
		sprintf(kodestr," (fejlkode=%d)",retur);
		strcat(fejlstr,kodestr);
	}
	pack_alfa(fejlstr);
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
afslut:
	return(retur);
}

/* ********************************************************************* */
static void check_firmaloginflag() {

	reclow(r167,R167);
	f167_start(1,ISGTEQ);
	if (ws_kundenr>0) {
		r167->kunde_nr = ws_kundenr;
		egeread(f167,ISEQUAL);
	}
	if (ws_kundenr>0 & f167_ok && r167->type==2) {
		ws_firmaloginflag = 1;
	}
	return;
}

/* ********************************************************************* */
static int check_promotion() {
	int retur = 0;
	int videre = 0;
	long int chkdato = 0;
	char chkkode[21] = "";
	char brandstr[21] = "";
	char tmpstr[21] = "";

	if (logfil) {
		fprintf(logfil,"check_promotion\n");
		fprintf(logfil,"\tws_promokode=<%s>\n",ws_promokode);
	}
/*
	if (!strlen(ws_promokode)) {
		retur = 1;
	}
*/
/* NYT 140306 PROMOSTYR */
	reclow(r198,R198);
	r198->oplkode = 15605;
	if (ws_brandtype==3) {
		strcpy(brandstr,"DON");
		strcpy(r198->keyalfa,brandstr);
	}
	if (ws_brandtype==4) {
		strcpy(brandstr,"PS");
		strcpy(r198->keyalfa,brandstr);
	}
	if (logfil) {
		fprintf(logfil,"\tbrandstr=%s\n",brandstr);
	}
	videre = 1;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		videre = -1;
	}
	while (videre==1 && retur==0) {
		egeread(f198,ISNEXT);
		if (f198_eof) { break; }
		if (r198->oplkode!=15605) { break; }
		if (strcmp(r198->keyalfa,brandstr)!=0) { continue; }
		if (r198->numfelt<=0) { continue; }
		chkdato = 0;
		if (r198->numfelt==1) { chkdato = ws_fradato; }
		if (r198->numfelt==2) { chkdato = ws_systemdato; }
		if (logfil) {
			fprintf(logfil,"\t\tchkdato=%ld (%ld-%ld)\n",
				chkdato,
				r198->fradato,
				r198->tildato);
		}
		if (chkdato<=0) { continue; }
		if (chkdato<r198->fradato) { continue; }
		if (chkdato>r198->tildato) { continue; }
		(void)get_alfa_tgn(r198->alfafelt,0,chkkode,59);
		ege_toupper((unsigned char *)chkkode);
		if (logfil) {
			fprintf(logfil,"\t\tchkkode=<%s>\n",
				chkkode);
		}
		if (strcmp(chkkode,ws_promokode)!=0) { continue; }
		retur = 1;
		ws_donpromotype = (int)r198->numfelt;
		(void)get_alfa_tgn(r198->alfafelt,1,ws_donpromoretur,59);
		(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&ws_donpromofunk);
		}
/* NYT 140411 PROMOPRISJUST */
		(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%lf",&ws_donpromojustering);
		}
		(void)get_alfa_tgn(r198->alfafelt,4,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&ws_donpromomaxvarighed);
		}
/* NYT 140825 PSPROMOPCT */
		(void)get_alfa_tgn(r198->alfafelt,5,ws_donpromobiltype,59);
		(void)get_alfa_tgn(r198->alfafelt,6,ws_donpromobilgrp,59);

	}
/* RETTET 140306
	if (strcmp(ws_promokode,"PROMO1")==0) {
		retur = 1;
	}
	if (strcmp(ws_promokode,"PROMO2")==0) {
		retur = 1;
	}
	if (strcmp(ws_promokode,"PROMO3")==0) {
		retur = 1;
	}
	if (strcmp(ws_promokode,"PROMO4")==0) {
		retur = 1;
	}
*/
/* NYT 131219 PSPROMO */
	if (ws_brandtype==4 && strcmp(ws_promokode,"SUPERPS")==0) {
		retur = 1;
		ws_promotype = 1;
	}
	if (logfil) {
		fprintf(logfil,"\tws_donpromotype=%d\n",ws_donpromotype);
		fprintf(logfil,"\tws_donpromofunk=%d\n",ws_donpromofunk);
		fprintf(logfil,"\tws_donpromomaxvarighed=%ld\n",
			ws_donpromomaxvarighed);
		fprintf(logfil,"\tws_donpromojustering=%lf\n",
			ws_donpromojustering);
		fprintf(logfil,"\tws_donpromobiltype=<%s>\n",
			ws_donpromobiltype);
		fprintf(logfil,"\tws_donpromobilgrp=<%s>\n",
			ws_donpromobilgrp);
		fprintf(logfil,"\tws_donpromoretur=<%s>\n",ws_donpromoretur);
		fprintf(logfil,"check_promotion retur=%d\n",retur);
	}
	return(retur);
}

/* ********************************************************************* */
static int udpak_testinput() {
	int retur = 0;
	int nuvidx = 0;
	int maxidx = 0;
	int inpnum = 0;
	char inpalfa[41] = "";
	char inputtabel[12][41] = {"","","","","","","","","","","",""};

	while (nuvidx<strlen(str)) {
		if (str[nuvidx]==ws_testsktgn) {
			maxidx++;
		}
		nuvidx++;
	}
	if (logfil) {
		fprintf(logfil,
			"udpak_testinput:%s ws_testsktgn=%hd maxidx=%d\n",
			str,
			ws_testsktgn,
			maxidx);
		fflush(logfil);
	}
	if (maxidx<=0) {
		return(0);
	}
	nuvidx = 0;
	while (maxidx>0 && nuvidx<=maxidx) {
		(void)get_alfa_tgn(str,nuvidx,inputtabel[nuvidx],ws_testsktgn);
		nuvidx++;
	}
	if (strlen(inputtabel[0])) {
		sscanf(inputtabel[0],"%hd",&ws_inputfunktion);
		retur++;
	}
	if (logfil) {
		fprintf(logfil,"\tws_inputfunktion=%hd\n",ws_inputfunktion);
	}
	nuvidx = 1;
	while (maxidx>0 && nuvidx<=maxidx) {
		if (!strlen(inputtabel[nuvidx])) {
			nuvidx++;
			continue;
		}
		if (logfil) {
			fprintf(logfil,"\t\t%s\n",inputtabel[nuvidx]);
		}
		if (ws_inputfunktion==901 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_station);
		}
		if (ws_inputfunktion==902 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_station);
		}
		if (ws_inputfunktion==902 && nuvidx==2) {
			sscanf(inputtabel[nuvidx],"%s",ws_grp);
			ege_toupper((unsigned char *)ws_grp);
		}
		if (ws_inputfunktion==902 && nuvidx==3) {
			sscanf(inputtabel[nuvidx],"%s",ws_evtextra);
			ege_toupper((unsigned char *)ws_evtextra);
		}
		if (ws_inputfunktion==903 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_station);
		}
		if (ws_inputfunktion==903 && nuvidx==2) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_inputspecnr);
		}
		if (ws_inputfunktion==903 && nuvidx==3) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_tilstation);
		}
		if (ws_inputfunktion==903 && nuvidx==4) {
			sscanf(inputtabel[nuvidx],"%s",ws_grp);
			ege_toupper((unsigned char *)ws_grp);
		}
		if (ws_inputfunktion==903 && nuvidx==5) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_fradato);
		}
		if (ws_inputfunktion==903 && nuvidx==6) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_tildato);
		}
		if (ws_inputfunktion==903 && nuvidx==7) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_fratid);
		}
		if (ws_inputfunktion==903 && nuvidx==8) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_tiltid);
		}
		if (ws_inputfunktion==904 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_station);
		}
		if (ws_inputfunktion==904 && nuvidx==2) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_tilstation);
		}
		if (ws_inputfunktion==904 && nuvidx==3) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_fradato);
		}
		if (ws_inputfunktion==904 && nuvidx==4) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_fratid);
		}
		if (ws_inputfunktion==904 && nuvidx==5) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_tildato);
		}
		if (ws_inputfunktion==904 && nuvidx==6) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_tiltid);
		}
		if (ws_inputfunktion==904 && nuvidx==7) {
			sscanf(inputtabel[nuvidx],"%s",ws_grp);
			ege_toupper((unsigned char *)ws_grp);
		}
		if (ws_inputfunktion==904 && nuvidx==8) {
			strcpy(ws_donspcstr,inputtabel[nuvidx]);
			get_alfa_tgn(ws_donspcstr,0,ws_tmppara,';');
			if (strlen(ws_tmppara)) {
				sscanf(ws_tmppara,"%hd",&ws_specnr);
			}
			get_alfa_tgn(ws_donspcstr,1,ws_extspcstr,';');
		}
		if (ws_inputfunktion==905 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_station);
		}
		if (ws_inputfunktion==905 && nuvidx==2) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_tilstation);
		}
		if (ws_inputfunktion==905 && nuvidx==3) {
/*
			sscanf(inputtabel[nuvidx],"%ld",&ws_fradato);
*/
			strcpy(ws_tmppara,inputtabel[nuvidx]);
                        rens_datotidstr(ws_tmppara);
/*                      sscanf(ws_tmppara,"%ld",&ws_fradato); */
                        sscanf(ws_tmppara,"%ld",&ege_w_int1);
                        ws_fradato = m036_funktion(18, ege_w_int1);
		}
		if (ws_inputfunktion==905 && nuvidx==4) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_fratid);
		}
		if (ws_inputfunktion==905 && nuvidx==5) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_tildato);
		}
		if (ws_inputfunktion==905 && nuvidx==6) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_tiltid);
		}
		if (ws_inputfunktion==905 && nuvidx==7) {
			sscanf(inputtabel[nuvidx],"%s",ws_grp);
			ege_toupper((unsigned char *)ws_grp);
		}
		if (ws_inputfunktion==905 && nuvidx==8) {
			strcpy(ws_donspcstr,inputtabel[nuvidx]);
			get_alfa_tgn(ws_donspcstr,0,ws_tmppara,';');
			if (strlen(ws_tmppara)) {
				sscanf(ws_tmppara,"%hd",&ws_specnr);
			}
			get_alfa_tgn(ws_donspcstr,1,ws_extspcstr,';');
		}
		if (ws_inputfunktion==905 && nuvidx==9) {
			inpnum = 0;
			sprintf(ws_extratab[inpnum],"%s",
				inputtabel[nuvidx]);
		}
		if (ws_inputfunktion==905 && nuvidx==10) {
			inpnum = 1;
			sprintf(ws_extratab[inpnum],"%s",
				inputtabel[nuvidx]);
		}

		if (ws_inputfunktion==906 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_station);
		}
		if (ws_inputfunktion==907 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_logintype);
		}
		if (ws_inputfunktion==907 && nuvidx==2) {
			strcpy(ws_loginid1,inputtabel[nuvidx]);
		}
		if (ws_inputfunktion==907 && nuvidx==3) {
			strcpy(ws_loginid2,inputtabel[nuvidx]);
		}
		if (ws_inputfunktion==908 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_kundetype);
		}
		if (ws_inputfunktion==908 && nuvidx==2) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_opdaterknr);
		}
		if (ws_inputfunktion==908 && nuvidx==3) {
			strcpy(ws_paratab[0],inputtabel[nuvidx]);
			ws_maxparatab = 0;
		}
		if (ws_inputfunktion==908 && nuvidx==4) {
			strcpy(ws_paratab[1],inputtabel[nuvidx]);
			ws_maxparatab = 1;
		}
		if (ws_inputfunktion==908 && nuvidx==5) {
			strcpy(ws_paratab[2],inputtabel[nuvidx]);
			ws_maxparatab = 2;
		}
		if (ws_inputfunktion==908 && nuvidx==6) {
			strcpy(ws_paratab[3],inputtabel[nuvidx]);
			ws_maxparatab = 3;
		}
		if (ws_inputfunktion==908 && nuvidx==7) {
			strcpy(ws_paratab[4],inputtabel[nuvidx]);
			ws_maxparatab = 4;
		}
		if (ws_inputfunktion==908 && nuvidx==8 && ws_kundetype==2) {
			strcpy(ws_paratab[5],inputtabel[nuvidx]);
			ws_maxparatab = 5;
		}
/* TEST */
		if (ws_inputfunktion==908 && ws_kundetype==1) {
			strcpy(ws_paratab[5],"adresse-1");
			strcpy(ws_paratab[7],"3200");
			strcpy(ws_paratab[8],"bynavn");
			strcpy(ws_paratab[9],"land");
			strcpy(ws_paratab[10],"tlfnr");
			strcpy(ws_paratab[11],"mobnr");
			strcpy(ws_paratab[12],"True");
			strcpy(ws_paratab[13],"True");
			ws_maxparatab = 13;
		}
		if (ws_inputfunktion==908 && ws_kundetype==2) {
			strcpy(ws_paratab[6],"bynavn");
			strcpy(ws_paratab[7],"land");
			strcpy(ws_paratab[8],"tlfnr");
			strcpy(ws_paratab[9],"mobnr");
			strcpy(ws_paratab[10],"True");
			strcpy(ws_paratab[11],"True");
			ws_maxparatab = 11;
		}

		if (ws_inputfunktion==909 && nuvidx==1) {
			ws_kundetype = 2;
			strcpy(ws_paratab[0],inputtabel[nuvidx]);
			ws_maxparatab = 0;
		}
		if (ws_inputfunktion==909 && nuvidx==2) {
			strcpy(ws_paratab[1],inputtabel[nuvidx]);
			ws_maxparatab = 1;
		}

		if (ws_inputfunktion==910 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_station);
		}
		if (ws_inputfunktion==911 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_logintype);
		}
		if (ws_inputfunktion==911 && nuvidx==2) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_opdaterknr);
		}
		if (ws_inputfunktion==912 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_resnr);
		}
		if (ws_inputfunktion==913 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_resnr);
		}
		if (ws_inputfunktion==914 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_kampagneid);
		}
		if (ws_inputfunktion==916 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_subfunktion);
/*
			ws_kundenr = 404485;
			ws_kundenr = 534069;
*/
			ws_kundenr = 564183;
		}
		if (ws_inputfunktion==916 && nuvidx==2) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_opdaterknr);
		}
		if (ws_inputfunktion==916 && nuvidx==3) {
			strcpy(ws_lejerfornavn,inputtabel[nuvidx]);
		}
		if (ws_inputfunktion==916 && nuvidx==4) {
			strcpy(ws_lejereftnavn,inputtabel[nuvidx]);
		}
		if (ws_inputfunktion==916 && nuvidx==5) {
			strcpy(ws_lejerfdato,inputtabel[nuvidx]);
		}
		if (ws_inputfunktion==916 && nuvidx==6) {
			strcpy(ws_lejerkkortnr,inputtabel[nuvidx]);
		}


		if (ws_inputfunktion==918 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_station);
		}
		if (ws_inputfunktion==918 && nuvidx==2) {
			sscanf(inputtabel[nuvidx],"%s",ws_grp);
			ege_toupper((unsigned char *)ws_grp);
		}
		if (ws_inputfunktion==918 && nuvidx==3) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_inpaa);
		}
		if (ws_inputfunktion==918 && nuvidx==4) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_inpmm);
		}
		if (ws_inputfunktion==919 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_station);
		}
		if (ws_inputfunktion==919 && nuvidx==2) {
			sscanf(inputtabel[nuvidx],"%s",ws_grp);
			ege_toupper((unsigned char *)ws_grp);
		}
		if (ws_inputfunktion==919 && nuvidx==3) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_inpaa);
		}
		if (ws_inputfunktion==919 && nuvidx==4) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_inpmm);
		}
		if (ws_inputfunktion==919 && nuvidx==5) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_fradato);
		}
		if (ws_inputfunktion==920 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_station);
		}
		if (ws_inputfunktion==920 && nuvidx==2) {
			sscanf(inputtabel[nuvidx],"%ld",&ws_fradato);
		}
		if (ws_inputfunktion==922 && nuvidx==1) {
			sscanf(inputtabel[nuvidx],"%hd",&ws_station);
		}
		if (ws_inputfunktion==922 && nuvidx==2) {
			sscanf(inputtabel[nuvidx],"%s",ws_grp);
		}
		if (ws_inputfunktion==922 && nuvidx==3) {
			strcpy(ws_donspcstr,inputtabel[nuvidx]);
		}
		nuvidx++;
		retur++;
	}
	ws_brandtype = 3;
	ws_don2flag = 1;
	ws_dkflag = 1;
	if (logfil) {
		fprintf(logfil,"udpak_testinput:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ********************************************************************* */
static int udpak_minimum_para(int inpfunk) {
	int retur = 0;
	int wx1 = 0;
	int wx2 = 0;
	char tmpstr[501] = "";
	char chkstr[301] = "";

	if (logfil) {
		fprintf(logfil,"udpak_minimum_para:%d\n",inpfunk);
		fflush(logfil);
	}
	get_alfa(ws_langstr);
	ege_toupper((unsigned char *)ws_langstr);
	if (DONDKONLY) {
		strcpy(ws_langstr,"DA");
	}
	retur++;
	get_alfa(ws_booktype);
	ege_toupper((unsigned char *)ws_booktype);
	retur++;
	get_alfa(ws_ipadr);
	retur++;
	get_long(&ws_aftalenr);
	retur++;
	get_long(&ws_kundenr);
	retur++;
	get_alfa(ws_extraid);
	ege_toupper((unsigned char *)ws_extraid);
	retur++;
	get_alfa(ws_promokode);
	ege_toupper((unsigned char *)ws_promokode);
	retur++;
/* NYT 120817 OrgBookNr */
	get_long(&ws_orgbooknr);
	retur++;
	get_short(&ws_don2stepnr);
	retur++;
	ws_minimumparaantal = retur;

	ws_brandtype = 0;
/* NYT 150324 WEBAPI */
	if (strcmp(ws_booktype,"ECBOOK")==0) {
		ws_brandtype = 0;
	}
	if (strcmp(ws_booktype,"DONBOOK")==0) {
		ws_brandtype = 3;
	}
	if (strcmp(ws_booktype,"DON2BOOK")==0) {
		ws_brandtype = 3;
		ws_don2flag = 1;
	}
/* NYT 131120 PSSTATION */
	if (strcmp(ws_booktype,"PSBOOK")==0) {
		ws_brandtype = 4;
		ws_don2flag = 1;
	}
/* NYT 131203 */
	if (ws_brandtype==4) {
		strcpy(tmpstr,ws_ipadr);
	}
	if (ws_brandtype==4 && strlen(tmpstr)) {
		wx1 = 0;
		(void)get_alfa_tgn(tmpstr,1,chkstr,'|');
		if (strlen(chkstr)) {
			strcpy(ws_browserid[wx1],chkstr);
			wx1++;
		}
		(void)get_alfa_tgn(tmpstr,0,ws_ipadr,'|');
	}
	if (ws_brandtype==4) {
		(void)nulstil_psextraprio();
	}
/* NYT 120918 */
	if (strcmp(ws_langstr,"DK")==0) { ws_dkflag = 1; }
	if (strcmp(ws_langstr,"DA")==0) { ws_dkflag = 1; }
	if (logfil) {
		fprintf(logfil,"\tws_langstr=%s\n",ws_langstr);
		fprintf(logfil,"\tws_dkflag=%hd\n",ws_dkflag);
		fprintf(logfil,
		"\tws_booktype=%s brandtype=%hd don2flag=%hd\n",
			ws_booktype,
			ws_brandtype,
			ws_don2flag);
		fprintf(logfil,"\tws_ipadr=%s\n",ws_ipadr);
		fprintf(logfil,"\t\tws_browserid-0=%s\n",ws_browserid[0]);
		fprintf(logfil,"\t\tws_browserid-1=%s\n",ws_browserid[1]);
		fprintf(logfil,"\t\tws_browserid-2=%s\n",ws_browserid[2]);
		fprintf(logfil,"\t\tws_browserid-3=%s\n",ws_browserid[3]);
		fprintf(logfil,"\t\tws_browserid-4=%s\n",ws_browserid[4]);

		fprintf(logfil,"\tws_aftalenr=%ld\n",ws_aftalenr);
		fprintf(logfil,"\tws_kundenr=%ld\n",ws_kundenr);
		fprintf(logfil,"\tws_extraid=%s\n",ws_extraid);
		fprintf(logfil,"\tws_promokode=%s\n",ws_promokode);
		fprintf(logfil,"\tws_orgbooknr=%ld\n",ws_orgbooknr);
		fprintf(logfil,"udpak_minimum_para:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************************** */
static int udpak_paratab(int inpfunk,short feltantal,short startindex) {
	int retur = 0;
	short int nuvantal = 0;
	short int nuvindex = 0;

	if (logfil) {
		fprintf(logfil,"udpak_paratab:%d %hd\n",inpfunk,feltantal);
		fflush(logfil);
	}
	nuvindex = startindex;
	while (nuvantal<feltantal) {
		get_alfa(ws_paratab[nuvindex]);
		egechartest((unsigned char *)ws_paratab[nuvindex]);
		if (logfil) {
			fprintf(logfil,"\tws_paratab-%hd=<%s>\n",
				nuvindex,
				ws_paratab[nuvindex]);
		}
		ws_maxparatab = nuvindex;
		nuvantal++;
		nuvindex++;
	}
	if (logfil) {
		fprintf(logfil,"\tws_maxparatab=%d\n",ws_maxparatab);
		fprintf(logfil,"udpak_paratab:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************************** */
static int udpak_extratab(short feltantal) {
	int retur = 0;
	int wx1 = 0;
	short int nuvantal = 0;
	short int maxkolnr = 2;
	short int kolnr = 0;
	short int lnnr = 0;
	char tmpstr[81] = "";
	char liniedata[201] = "";

	if (logfil) {
		fprintf(logfil,"udpak_extratab:%hd\n",feltantal);
		fprintf(logfil,"\tws_funktion=%hd\n",ws_funktion);
		fprintf(logfil,"\tfeltantal=%hd\n",feltantal);
		fflush(logfil);
	}
	kolnr = 1;
	lnnr = 0;
	alfalow(liniedata);
	while (nuvantal<feltantal) {
		get_alfa(tmpstr);
		if (logfil) {
			fprintf(logfil,"\t%hd tmpstr=<%s>\n",
				nuvantal,
				tmpstr);
			fflush(logfil);
		}
/* NYT 121105 SUBMITEXTRAKOMPENSATION */
		if (ws_funktion==10 && !strlen(tmpstr)) {
			nuvantal++;
			continue;
		}
		if (kolnr>1) {
			strcat(liniedata,";");
		}
		strcat(liniedata,tmpstr);
		nuvantal++;
		kolnr++;
		if (kolnr>maxkolnr) {
			strcpy(ws_extratab[lnnr],liniedata);
			lnnr++;
			kolnr = 1;
			alfalow(liniedata);
		}
		if (lnnr>MAX_EXTRAPRODTAB) {
			break;
		}
	}
	if (logfil) {
		fprintf(logfil,"\tlnnr=%hd\n",lnnr);
		fprintf(logfil,"\tMAX_EXTRAPRODTAB=%d\n",MAX_EXTRAPRODTAB);
		fflush(logfil);
	}
	wx1 = 0;
	while (logfil && wx1<MAX_EXTRAPRODTAB) {
		fprintf(logfil,"\tws_extratab-%d=<%s>\n",wx1,ws_extratab[wx1]);
		fflush(logfil);
		wx1++;
	}
	if (logfil) {
		fprintf(logfil,"udpak_extratab:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************************** */
static int udpak_webapi_extratab(short feltantal) {
	int retur = 0;
	int wx1 = 0;
	int feltnr = 0;
	short int nuvantal = 0;
	short int maxkolnr = 2;
	short int kolnr = 0;
	short int lnnr = 0;
	char tmpstr[81] = "";
	char liniedata[201] = "";

	if (logfil) {
		fprintf(logfil,"udpak_webapi_extratab:%hd\n",feltantal);
		fprintf(logfil,"\tws_funktion=%hd\n",ws_funktion);
		fprintf(logfil,"\tfeltantal=%hd\n",feltantal);
		fflush(logfil);
	}
	kolnr = 1;
	lnnr = 0;
	feltnr = -1;
	alfalow(liniedata);
	while (nuvantal<feltantal) {
		feltnr++;
		get_alfa(tmpstr);
		if (logfil) {
			fprintf(logfil,"\t%hd tmpstr=<%s>\n",
				nuvantal,
				tmpstr);
			fflush(logfil);
		}
		if (strncmp(tmpstr,"Recomm",6)==0) {
			nuvantal++;
			continue;
		}
		if (strncmp(tmpstr,"Insura",6)==0) {
			nuvantal++;
			continue;
		}
		if (strncmp(tmpstr,"Mileag",6)==0) {
			nuvantal++;
			continue;
		}
/*
		if (feltnr==0 || feltnr%3==0) {
			nuvantal++;
			continue;
		}
*/
		if (ws_funktion==30 && !strlen(tmpstr)) {
			nuvantal++;
			continue;
		}
		if (ws_funktion==31 && !strlen(tmpstr)) {
			nuvantal++;
			continue;
		}
		if (kolnr>1) {
			strcat(liniedata,";");
		}
		strcat(liniedata,tmpstr);
		nuvantal++;
		kolnr++;
		if (kolnr>maxkolnr) {
			strcpy(ws_extratab[lnnr],liniedata);
			lnnr++;
			kolnr = 1;
			alfalow(liniedata);
		}
		if (lnnr>MAX_EXTRAPRODTAB) {
			break;
		}
	}
	if (logfil) {
		fprintf(logfil,"\tlnnr=%hd\n",lnnr);
		fprintf(logfil,"\tMAX_EXTRAPRODTAB=%d\n",MAX_EXTRAPRODTAB);
		fflush(logfil);
	}
	wx1 = 0;
	while (logfil && wx1<MAX_EXTRAPRODTAB) {
		fprintf(logfil,"\tws_extratab-%d=<%s>\n",wx1,ws_extratab[wx1]);
		fflush(logfil);
		wx1++;
	}
	if (logfil) {
		fprintf(logfil,"udpak_webapi_extratab:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************************** */
static int send_don2_lukketdage() {
	int retur = 0;
	int maxdagnr = 31;
	int nuvdagnr = 1;
	int kapacitetflag = 0;
	int funkretur = 0;
	int returid = 0;
	int pgaabenflag = 0;
	long int startdato = 0;
	long int datoretur = 0;
	long int tmpdato = 0;
	long int mindato = 0;
	char tmpstr[41] = "";
	char pgfilsti[81] = "";


	if (logfil) {
		fprintf(logfil,"send_don2_lukketdage\n");
		fprintf(logfil,"\tws_funktion=%hd\n",ws_funktion);
		fprintf(logfil,"\tws_station=%hd\n",ws_station);
		fprintf(logfil,"\tws_grp=%s\n",ws_grp);
		fprintf(logfil,"\tws_inpaa=%ld\n",ws_inpaa);
		fprintf(logfil,"\tws_inpmm=%ld\n",ws_inpmm);
		fflush(logfil);
	}
	if (ws_funktion==18 && ws_station<=0) {
		ws_don2errno = DON2PCKLOC;
	}
	if (ws_funktion==18 && ws_inpaa<=0) {
		ws_don2errno = DON2PCKAA;
	}
	if (ws_funktion==18 && ws_inpmm<=0) {
		ws_don2errno = DON2PCKMM;
	}
	if (ws_funktion==19 && ws_station<=0) {
		ws_don2errno = DON2RETLOC;
	}
	if (ws_funktion==19 && ws_fradato<=0) {
		ws_don2errno = DON2RETPCK;
	}
/* NYT 121015 */
	if (ws_funktion==19 && ws_don2errno<=0 && ws_fradato>0 && ws_inpaa==0) {
		ws_inpaa = ws_fradato / 10000;
	}
	if (ws_funktion==19 && ws_inpaa<=0) {
		ws_don2errno = DON2RETAA;
	}
	if (ws_funktion==19 && ws_don2errno<=0 && ws_fradato>0 && ws_inpmm==0) {
		ws_inpmm = ws_fradato % 10000;
		ws_inpmm /= 100;
	}
	if (ws_funktion==19 && ws_inpmm<=0) {
		ws_don2errno = DON2RETMM;
	}
	if (ws_don2errno>0) {
		(void)frankly_err(ws_funktion,
			"fejl",ws_don2errno);
		retur = 1;
		goto afslut;
	}
	startdato = ws_inpaa;
	startdato *= 10000;
	ege_w_int1 = ws_inpmm;
	ege_w_int1 *= 100;
	ege_w_int1 += 1;
	startdato += ege_w_int1;
	mindato = ws_systemdato;
	if (ws_funktion==19) {
		mindato = ws_fradato;
	}
	if (logfil) {
		fprintf(logfil,"\tws_inpaa=%ld\n",ws_inpaa);
		fprintf(logfil,"\tws_inpmm=%ld\n",ws_inpmm);
		fprintf(logfil,"\tmindato=%ld\n",mindato);
	}
	datoretur = m036_funktion(16,(long int)startdato);
	datoretur /= 10;
	maxdagnr = (datoretur % 100);
	if (logfil) {
		fprintf(logfil,"\tdatoretur=%ld\n",datoretur);
		fprintf(logfil,"\tmaxdagnr=%d\n",maxdagnr);
	}
/* NYT 131203 PGAABEN */
	if (ws_pgflag>0) {
		pgaabenflag = dan_pgaaben(1,ws_station,pgfilsti);
	}
	if (ws_pgflag>0 && pgaabenflag>0) {
		strcpy(ws_pgaabenfilsti,pgfilsti);
	}
	if (logfil) {
		fprintf(logfil,"\tpgaabenflag=%d\n",pgaabenflag);
		fprintf(logfil,"\tpgfilsti=%s\n",pgfilsti);
	}
	log_stopur(81);
	nuvdagnr = 1;
	while (nuvdagnr<=maxdagnr) {
/*
		(void)log_stopur(83);
*/
		tmpdato = ws_inpaa;
		tmpdato *= 10000;
		ege_w_int1 = ws_inpmm;
		ege_w_int1 *= 100;
		tmpdato += ege_w_int1;
		tmpdato += nuvdagnr;
		if (logfil) {
			fprintf(logfil,"\t\ttmpdato=%ld\n",tmpdato);
		}
		if (tmpdato<mindato) {
			nuvdagnr++;
			continue;
		}
/* check åbent */
/*
                tmpdato = m036_funktion(19, julian);
*/
                strcpy(ws_alert_txt,"");
/* NYT 131205 PGAABEN */
                funkretur = check_bssaaben(-1,ws_station,tmpdato,-1);
		if (logfil) {
                	fprintf(logfil,
			"\t\tcheck_bssaaben %ld funkretur=%d ws_alert_txt=%s\n",
                        	tmpdato,
                        	funkretur,
                        	ws_alert_txt);
		}
		returid = 0;
		if (funkretur<=0) {
			returid = 1;
		}
/* check ressourcer */
/*
		funkretur = check_ressourcer(CHKRESFUNK,
			ws_station,
			ws_grp,
			ws_specnr,
			ws_extspcstr,
			ws_fradato,
			0);
*/
/* RETTET 121009 KAPACITETOFF
		if (kapacitetflag<=0) {
			funkretur = check_ressourcer(CHKRESFUNK,
				ws_station,
				ws_grp,
				0,
				"",
				tmpdato,
				(long int)1);
		}
		if (kapacitetflag<=0 && funkretur<=CHKRESMINIMUM) {
			kapacitetflag = 1;
		}
*/
		if (logfil) {
			fprintf(logfil,
			"\t\tressourcer funkretur=%d kapacitetflag=%d\n",
				funkretur,kapacitetflag);
		}
		if (kapacitetflag>0) {
			returid += 2;
		}
		if (returid<=0) {
			nuvdagnr++;
			continue;
		}
		alfalow(str);
		pack_init(str);
		ege_w_int1 = m036_funktion(17,(long int)tmpdato);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		pack_alfa(tmpstr);
		pack_int2((long int)returid);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}

		nuvdagnr++;
		retur++;
	}
	log_stopur(81);
	if (retur==0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long int)retur);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur = 1;
	}
afslut:
/* PGAABEN */
	if (pgaabenflag>0) {
		(void)dan_pgaaben(-1,ws_station,pgfilsti);
		strcpy(ws_pgaabenfilsti,"");
	}
	if (logfil) {
		fprintf(logfil,"send_don2_lukketdage:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* NYT 131203 PGAABEN */
/* ************************************************************************** */
static int dan_pgaaben(int inpfunk,int inpstation,char *returfilsti) {
	int retur = 0;
/* NYT 121214 FINDPG2 */
	short int pgfindflag = 0;
	long int pgantal = 0;
	char pginpstr[201] = "";
	char pgselectstr[201] = "";
	char pgfilsti[81] = "";
	char tmpstr[81] = "";
	FILE * tmpfil;

	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	if (logfil) {
		fprintf(logfil,"dan_pgaaben PGAABEN\n");
	}
	tmpfil = (FILE*)0;
	sprintf(pgfilsti,"/tmp/f198_%ld_%hd.pg", (long int)16606,ege_pid);
	if (inpfunk==-1) {
		(void)unlink(pgfilsti);
		goto afslut;
	}
	sprintf(pgselectstr, "select oplkode");
	strcat(pgselectstr,", keynum");
	strcat(pgselectstr,", keyalfa");
	strcat(pgselectstr,", fradato");
	strcat(pgselectstr,", tildato");
	strcat(pgselectstr,", numfelt");
	strcat(pgselectstr,", alfafelt");
	strcat(pgselectstr," from f198");
	strcat(pgselectstr," where ");
	sprintf(tmpstr,"oplkode=%ld",(long int)16606);
	strcat(pgselectstr,tmpstr);
	sprintf(tmpstr," and keynum=%d",
		inpstation);
	strcat(pgselectstr,tmpstr);
/*
	strcat(pgselectstr," and numfelt>0");
	sprintf(tmpstr," and (keynum=%hd or keynum=%ld)",
		nuvdagnr,
		nuvdato);
	strcat(pgselectstr,tmpstr);
*/
	strcat(pgselectstr," order by keynum");
	pgantal = find_pg(f198,pgselectstr,pgfilsti,'\0','\0');
	pgfindflag = 1;
	if (logfil) {
		fprintf(logfil,"\tpgselectstr=%s\n",pgselectstr);
	}
	if (pgantal<=0) {
		pgfindflag = -1;
		retur = -1;
	}
	if (retur>=0) {
		retur = (int)pgantal;
		strcpy(returfilsti,pgfilsti);
	}
afslut:
	return(retur);
}

/* ************************************************************************** */
static int send_don2_aabentid() {
	int retur = 0;
	int funkretur = 0;
	long int startfratid = 0;
	long int starttiltid = 0;
	long int nextoktid = 0;
	long int lukketid = 0;
	long int korrlukketid = 0;
	char tmpstr[41] = "";

	if (logfil) {
		fprintf(logfil,"send_don2_aabentid\n");
		fprintf(logfil,"\tws_station=%hd\n",ws_station);
		fprintf(logfil,"\tws_fradato=%ld\n",ws_fradato);
		fprintf(logfil,"\tws_subfunktion=%hd\n",ws_subfunktion);
	}
	if (ws_station<=0) {
		ws_don2errno = DON2ABNLOC;
	}
	if (ws_fradato<=0) {
		ws_don2errno = DON2ABNDAT;
	}
	if (ws_don2errno>0) {
		(void)frankly_err(ws_funktion,
			"fejl",ws_don2errno);
		retur = 1;
		goto afslut;
	}

	strcpy(ws_alert_txt,"");
	funkretur = check_bssaaben(-1,ws_station,ws_fradato,-1);
	if (logfil) {
		fprintf(logfil,
			"\tcheck_bssaaben %ld funkretur=%d ws_alert_txt=%s\n",
			ws_fradato,
			funkretur,
			ws_alert_txt);
	}
	alfalow(str);
	pack_init(str);
	ege_w_int1 = m036_funktion(17,(long int)ws_fradato);
	sprintf(tmpstr,"%8.8ld",ege_w_int1);
	pack_alfa(tmpstr);
	if (funkretur<=0) {
		strcpy(tmpstr,"0000");
		pack_alfa(tmpstr);
		strcpy(tmpstr,"0000");
		pack_alfa(tmpstr);
	} else {
		(void)get_alfa_tgn(ws_alert_txt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &startfratid);
		}
		(void)get_alfa_tgn(ws_alert_txt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &starttiltid);
			lukketid = starttiltid;
		}
/* TEST 130304 */
		if (logfil) {
			fprintf(logfil,"\tfunkretur=%d\n",funkretur);
			fprintf(logfil,"\tstartfratid=%ld\n",startfratid);
			fprintf(logfil,"\tstarttiltid=%ld\n",starttiltid);
			fprintf(logfil,"\tlukketid=%ld\n",lukketid);
		}

/* NYT 121121 730-800JUST */
		if (startfratid==730) {
			startfratid = 800;
		}
/* NYT 121214 800-800 */
		if (ws_funktion==20 && ws_subfunktion==0) {
			starttiltid = 800;
		}
/* NYT 130128 */
		if (ws_funktion==20 && ws_subfunktion==1 &&
			ws_fradato==ws_systemdato &&
			starttiltid>1600) {
			startfratid = 1600;
		}
/* NYT 130304 NEXTOKTID */
		if (ws_funktion==20 && ws_subfunktion==1 &&
			ws_fradato==ws_systemdato) {
			nextoktid = ws_systemtid;
			nextoktid /= 100;
			nextoktid *= 100;
			nextoktid += 200;
/* RETTET 130319 NEXTOKTID2
			nextoktid += 300;
*/
		}
/* RETTET 130319 NEXTOKTID2
		if (ws_funktion==20 && ws_subfunktion==1 &&
			ws_fradato==ws_systemdato &&
			nextoktid>0 && nextoktid<1200) {
			nextoktid = 1200;
		}
*/
		if (ws_funktion==20 && ws_subfunktion==1 &&
			ws_fradato==ws_systemdato &&
			nextoktid<lukketid) {
			startfratid = nextoktid;
		}
/* NYT 130410 KORRLUKKETID */
		korrlukketid = starttiltid;
		if (ws_funktion==20 && ws_subfunktion==1 &&
			korrlukketid==lukketid &&
			korrlukketid%100==30) {
			korrlukketid -= 30;
		}
		if (ws_funktion==20 && ws_subfunktion==1 &&
			korrlukketid==lukketid &&
			korrlukketid%100==0) {
			korrlukketid -= 70;
		}
/* NYT 150106 PSKORRLUKKETID */
		if (ws_funktion==20 && ws_subfunktion==1 &&
			starttiltid==lukketid &&
			ws_brandtype==4) {
			korrlukketid = starttiltid;
		}
/* NYT 140513 PSAFLEVERING */
		if (ws_funktion==20 && ws_subfunktion==0 &&
			ws_brandtype==4) {
			startfratid = 700;
			korrlukketid = 700;
		}
		if (logfil) {
			fprintf(logfil,"\tlukketid=%ld\n",lukketid);
			fprintf(logfil,"\tkorrlukketid=%ld\n",korrlukketid);
			fprintf(logfil,"\tnextoktid=%ld\n",nextoktid);
		}

		sprintf(tmpstr,"%4.4ld",startfratid);
		pack_alfa(tmpstr);
		sprintf(tmpstr,"%4.4ld",korrlukketid);
/* RETTET 130410 KORRLUKKETID
		sprintf(tmpstr,"%4.4ld",starttiltid);
*/
		pack_alfa(tmpstr);
	}
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	retur++;
afslut:
	if (logfil) {
		fprintf(logfil,"send_don2_aabentid:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************************** */
static int send_don2_drivers() {
	int retur = 0;
	int okflag = 0;
	int readantal = 0;
	char firmanavn[81] = "";
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil, "send_don2_drivers\n");
		fflush(logfil);
	}
	if (ws_kundenr<=0) {
		ws_don2errno = DON2DRVNRM;
	}
	if (logfil) {
		fprintf(logfil,"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		return(0);
	}
	reclow(r178,R178);
	f178_start(1,ISGTEQ);

	reclow(r167,R167);
	f167_start(1,ISGTEQ);
	r167->kunde_nr = ws_kundenr;
	egeread(f167,ISEQUAL);
	if (f167_ukendt) {
		ws_don2errno = DON2DRVNOT;
	}
	if (f167_ok && r167->type!=2) {
		ws_don2errno = DON2DRVNOT;
	}
	if (f167_ok && r167->type==2 && check_sy_kundenr(r167->kunde_nr)<=0) {
		ws_don2errno = DON2DRVNOT;
	}
	if (logfil) {
		fprintf(logfil,"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		return(0);
	}
	if (ws_subfunktion==0) {
		strcpy(firmanavn,r167->navn_2);
	}
	if (logfil) {
		fprintf(logfil,"\tfirmanavn=%s\n",firmanavn);
	}
	okflag = 0;
	if (ws_subfunktion==0) {
		reclow(r167,R167);
		r167->firma_reference = ws_kundenr;
		f167_start(9,ISGTEQ);
		if (f167_ukendt) {
			okflag = -1;
		}
	}
	if (ws_subfunktion==1 && ws_opdaterknr<=0) {
		ws_don2errno = DON2DRVIDM;
	}
	if (logfil) {
		fprintf(logfil,"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		return(0);
	}
	if (ws_subfunktion==1 && ws_opdaterknr>0) {
		f167_start(1,ISGTEQ);
		r167->kunde_nr = ws_opdaterknr;
		egeread(f167,ISEQUAL);
		if (f167_ukendt) {
			ws_don2errno = DON2DRVIDN;
		}
		if (f167_ok && r167->type!=1) {
			ws_don2errno = DON2DRVIDN;
		}
		if (f167_ok && r167->type==1 &&
			check_sy_kundenr(r167->kunde_nr)<=0) {
			ws_don2errno = DON2DRVIDN;
		}
	}
	if (logfil) {
		fprintf(logfil,"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		return(0);
	}
	if (logfil) {
		fprintf(logfil,"\tfirma_reference=%ld\n",r167->firma_reference);
	}
	while (ws_subfunktion==0 && okflag>=0) {
		egeread(f167,ISNEXT);
		readantal++;
		if (f167_eof) {
			break;
		}
		if (r167->firma_reference>ws_kundenr) {
			break;
		}
		if (r167->firma_reference<ws_kundenr) {
			continue;
		}
		alfalow(str);
		pack_init(str);
		pack_int2((long)r167->kunde_nr);
		pack_alfa(r167->navn_1);
		pack_alfa(r167->navn_2);
		pack_alfa(r167->kkortnr);
		ege_w_int1 = m036_funktion(17,(long int)r167->foedselsdato);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		okflag++;
		retur++;
	}
/* 121002 ALTFIRMAREF */
	if (ws_subfunktion==0 && okflag>=0) {
		reclow(r167,R167);
		f167_start(1,ISGTEQ);
		reclow(r178,R178);
		r178->opl_kode = 64;
		f178_start(2,ISGTEQ);
	}
	while (ws_subfunktion==0 && okflag>=0) {
		egeread(f178,ISNEXT);
		readantal++;
		if (f178_eof) {
			break;
		}
		if (r178->opl_kode>64) {
			break;
		}
		if (r178->num_felt!=ws_kundenr) {
			continue;
		}
		r167->kunde_nr = (long int)r178->kunde_nr;
		egeread(f167,ISEQUAL);
		if (f167_ukendt) {
			continue;
		}
		if (r167->type!=1) {
			continue;
		}
		reccpy(&q178,r178,R178);
		if (check_sy_kundenr(r167->kunde_nr)<=0) {
			continue;
		}
		alfalow(str);
		pack_init(str);
		pack_int2((long)r167->kunde_nr);
		pack_alfa(r167->navn_1);
		pack_alfa(r167->navn_2);
		pack_alfa(r167->kkortnr);
		ege_w_int1 = m036_funktion(17,(long int)r167->foedselsdato);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		okflag++;
		retur++;
		reccpy(r178,&q178,R178);
		f178_start(2, ISGREAT);
		if (f178_ukendt) {
			break;
		}
	}
	if (logfil) {
		fprintf(logfil,"\treadantal=%d\n",readantal);
	}
	if (logfil) {
		fprintf(logfil,"send_don2_drivers:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************************** */
static int opret_don2_driver() {
	int retur = 0;
	int okflag = 0;
	int readantal = 0;
	int freffundet = 0;
	long int fdato = 0;
	long int lejerkundenr = 0;
	char firmanavn[81] = "";
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil, "opret_don2_driver\n");
		fprintf(logfil,"\tws_kundenr=%ld\n",
			ws_kundenr);
		fprintf(logfil,"\tws_lejerfdato=%s\n",
			ws_lejerfdato);
		fprintf(logfil,"\tws_lejerkkortnr=%s\n",
			ws_lejerkkortnr);
		fprintf(logfil,"\tws_lejerfornavn=%s\n",
			ws_lejerfornavn);
		fprintf(logfil,"\tws_lejereftnavn=%s\n",
			ws_lejereftnavn);
		fflush(logfil);
	}
	if (ws_kundenr<=0) {
		ws_don2errno = DON2DRVNRM;
	}
	if (!strlen(ws_lejerfornavn)) {
		ws_don2errno = DON2DRVFLD1;
	}
	if (!strlen(ws_lejereftnavn)) {
		ws_don2errno = DON2DRVFLD2;
	}
	if (!strlen(ws_lejerkkortnr)) {
		ws_don2errno = DON2DRVFLD3;
	}
	if (!strlen(ws_lejerfdato)) {
		ws_don2errno = DON2DRVFLD4;
	}
	strcpy(tmpstr,ws_lejerfdato);
	rens_datotidstr(tmpstr);
	sscanf(tmpstr,"%ld",&ege_w_int1);
	fdato = m036_funktion(18, ege_w_int1);
	ege_w_int1 = 19000101;
/* NYT 140312 DRVFDATOMIN21 */
	ege_w_int2 = ws_systemdato;
	ege_w_int2 -= 210000;

	if (logfil) {
		fprintf(logfil,"\tws_kundetype=%hd\n",
			ws_kundetype);
		fprintf(logfil,"\tws_systemdato=%8.8ld\n",
			ws_systemdato);
		fprintf(logfil,"\tege_w_int1=%8.8ld\n",
			ege_w_int1);
		fprintf(logfil,"\tege_w_int2=%8.8ld\n",
			ege_w_int2);
		fprintf(logfil,"\tfdato=%8.8ld\n",
			fdato);
	}
	if (ws_kundetype==1 && fdato<=ege_w_int1) {
		ws_don2errno = DON2DRVDTF;
	}
	if (ws_kundetype==1 && fdato>ws_systemdato) {
		ws_don2errno = DON2DRVDTF;
	}
/* NYT 140312 DRVFDATOMIN21 */
/*
	if (ws_kundetype==0 && fdato>ege_w_int2) {
		ws_don2errno = DON2DRVALDER;
	}
*/

	if (logfil) {
		fprintf(logfil,"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		goto afslut;
	}
	reclow(r167,R167);
	f167_start(1,ISGTEQ);
	r167->kunde_nr = ws_kundenr;
	egeread(f167,ISEQUAL);
	if (f167_ukendt) {
		ws_don2errno = DON2DRVNOT;
	}
	if (f167_ok && r167->type!=2) {
		ws_don2errno = DON2DRVNOT;
	}
	if (f167_ok && r167->type==2 && check_sy_kundenr(r167->kunde_nr)<=0) {
		ws_don2errno = DON2DRVNOT;
	}
	if (logfil) {
		fprintf(logfil,"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		goto afslut;
	}
	strcpy(firmanavn,r167->navn_2);
	if (logfil) {
		fprintf(logfil,"\tfirmanavn=%s\n",firmanavn);
	}
	okflag = 0;
/* check kunde findes */
	if (don2_check_kundefindes(1,ws_lejerkkortnr,ws_lejerfdato)>0) {
		lejerkundenr = r167->kunde_nr;
	}
	if (logfil) {
		fprintf(logfil,"\tlejerkundenr=%ld\n",lejerkundenr);
		fflush(logfil);
	}
/* check firma_reference */
	if (lejerkundenr>0) {
		freffundet = check_lejer_firmaref(lejerkundenr,ws_kundenr);
	}
	if (logfil) {
		fprintf(logfil,"\tfreffundet=%d\n",freffundet);
		fflush(logfil);
	}
/*
	if (lejerkundenr>0 && freffundet<=0) {
		okflag = opdat_lejer_firmaref(lejerkundenr,ws_kundenr);
	}
	if (logfil) {
		fprintf(logfil,"\tokflag=%d\n",okflag);
		fflush(logfil);
	}
	if (lejerkundenr>0 && freffundet<=0 && okflag<=0) {
		ws_don2errno = DON2DRVROPD;
	}
*/
	if (lejerkundenr>0 && freffundet>0) {
		ws_don2errno = DON2DRVALR;
	}
	if (logfil) {
		fprintf(logfil,"\tws_don2errno=%ld\n",ws_don2errno);
		fflush(logfil);
	}
	if (ws_don2errno>0) {
		goto afslut;
	}
	if (lejerkundenr>0 && freffundet<=0 && okflag>0) {
		alfalow(str);
		pack_init(str);
		pack_alfa("ok");
		sprintf(tmpstr,"%ld ref %ld",ws_kundenr,lejerkundenr);
		pack_alfa(tmpstr);
		pack_int2((long)lejerkundenr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
		goto afslut;
	}
	reclow(r167,R167);
	f167_start(1,ISGTEQ);

	nytkundenr();

	strcpy(r167->navn_1, ws_lejerfornavn);
	strcpy(r167->navn_2, ws_lejereftnavn);
	strcpy(r167->adr_1, "");
	strcpy(r167->land, "DANMARK");
	r167->foedselsdato = fdato;
	strcpy(r167->kkortnr, ws_lejerkkortnr);
	bss_konv_txt(2,r167->navn_1);
	bss_konv_txt(3,r167->navn_2);
	bss_konv_txt(4,r167->adr_1);
	bss_konv_txt(4,r167->adr_2);
	bss_konv_txt(5,r167->postkode);
	bss_konv_txt(4,r167->by);
	bss_konv_txt(4,r167->land);
	bss_konv_txt(8,r167->kkortnr);
	r167->type = 1;
	r167->oprettelses_dato = ege_date();
	r167->status = 1;
	strcpy(r167->bem, "webopret ok");
	r167->firma_reference = ws_kundenr;
	egewrite(f167);
	if (f167_ok) {
		retur = 1;
	}
	if (f167_ukendt) {
		reccpy(&q167,r167,R167);
		egeread(f167,ISEQUAL + ISLOCK);
		reccpy(r167,&q167,R167);
		egerew(f167);
		egerel(f167);
		retur = 1;
	}
/* NYT 121109 */
	if (retur==1) {
		reclow(r178, R178);
		strcpy(r178->alfa_felt, "SYWEB");
		opdat_r178(11,(double)r167->kunde_nr);
	}
	if (retur>0) {
		alfalow(str);
		pack_init(str);
/*
		pack_alfa("ok");
		sprintf(tmpstr,"%ld ref %ld",ws_kundenr,lejerkundenr);
		pack_alfa(tmpstr);
*/
		pack_int2((long)r167->kunde_nr);
		pack_alfa(r167->navn_1);
		pack_alfa(r167->navn_2);
		ege_w_int1 = m036_funktion(17,(long int)r167->foedselsdato);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		pack_alfa(tmpstr);
		pack_alfa(r167->kkortnr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
	if (logfil) {
		fprintf(logfil,"\treadantal=%d\n",readantal);
	}
afslut:
	if (logfil) {
		fprintf(logfil,"opret_don2_driver:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************************** */
static int slet_don2_driver() {
	int retur = 0;
	int okflag = 0;
	int readantal = 0;
	int freffundet = 0;
	long int fdato = 0;
	long int lejerkundenr = 0;
	char firmanavn[81] = "";
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil, "slet_don2_driver\n");
		fprintf(logfil,"\tws_kundenr=%ld\n",
			ws_kundenr);
	}
	if (ws_opdaterknr<=0) {
		goto afslut;
	}
	reclow(r167,R167);
	f167_start(1,ISGTEQ);
	r167->kunde_nr = ws_opdaterknr;
	egeread(f167,ISEQUAL + ISLOCK);
	if (f167_ok) {
		egedelete(f167);
		egerel(f167);
		retur = 1;
	}
	if (retur>0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)r167->kunde_nr);
		pack_alfa(r167->navn_1);
		pack_alfa(r167->navn_2);
		ege_w_int1 = m036_funktion(17,(long int)r167->foedselsdato);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		pack_alfa(tmpstr);
		pack_alfa(r167->kkortnr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
afslut:
	if (logfil) {
		fprintf(logfil,"slet_don2_driver:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************************** */
static int check_lejer_firmaref(long inplejerknr,long inpfirmaknr) {
	int retur = 0;

	if (logfil) {
		fprintf(logfil, "check_lejer_firmaref\n");
	}
	reclow(r167,R167);
	f167_start(1,ISGTEQ);
	r167->kunde_nr = inplejerknr;
	egeread(f167,ISEQUAL);
	if (f167_ukendt) {
		retur = -1;
		goto afslut;
	}
	if (r167->firma_reference==inpfirmaknr) {
		retur = 1;
		goto afslut;
	}
	reclow(r178,R178);
	f178_start(1,ISGTEQ);
	r178->kunde_nr = (double)inplejerknr;
	r178->opl_kode = 64;
	f178_start(1,ISGTEQ);
	while (retur==0) {
		egeread(f178,ISNEXT);
		if (f178_eof) {
			break;
		}
		if (r178->kunde_nr!=inplejerknr) {
			break;
		}
		if (r178->opl_kode!=64) {
			continue;
		}
		if (r178->num_felt!=inpfirmaknr) {
			continue;
		}
		retur = 1;
	}
afslut:
	if (logfil) {
		fprintf(logfil, "check_lejer_firmaref:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************************** */
static int opdat_lejer_firmaref(long inplejerknr,long inpfirmaknr) {
	int retur = 0;
	long int nextlbnr = 0;

	if (logfil) {
		fprintf(logfil, "opdat_lejer_firmaref\n");
	}
	reclow(r167,R167);
	f167_start(1,ISGTEQ);
	r167->kunde_nr = inplejerknr;
	egeread(f167,ISEQUAL+ISLOCK);
	if (f167_ukendt) {
		retur = -1;
		goto afslut;
	}
	if (r167->firma_reference<=0) {
		r167->firma_reference = inpfirmaknr;
		retur = 1;
		egerew(f167);
		egerel(f167);
		nextlbnr = -1;
		goto afslut;
	}
	nextlbnr = 0;
	reclow(r178,R178);
	f178_start(1,ISGTEQ);
	r178->kunde_nr = (double)inplejerknr;
	r178->opl_kode = 64;
	f178_start(1,ISGTEQ);
	while (nextlbnr>=0) {
		egeread(f178,ISNEXT);
		if (f178_eof) {
			break;
		}
		if (r178->kunde_nr!=inplejerknr) {
			break;
		}
		if (r178->opl_kode!=64) {
			continue;
		}
		if (r178->num_felt>0 && r178->num_felt==inpfirmaknr) {
			continue;
		}
		nextlbnr = r178->lb_nr;
		nextlbnr++;
	}
	if (nextlbnr>=0) {
		r178->lb_nr = nextlbnr;
		r178->num_felt = (double)inpfirmaknr;
		strcpy(r178->alfa_felt,"");
		(void)opdat_r178(64,(double)inplejerknr);
		retur = 1;
	}
afslut:
	if (logfil) {
		fprintf(logfil, "opdat_lejer_firmaref:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************************** */
static int send_don2_booklist() {
	int retur = 0;
	int okflag = 0;
	int keynr = 0;
	int antal = 0;
	int konantal = 0;
	int readantal = 0;
	int aktivflag = 0;
	char tmpstr[101] = "";

	if (logfil) {
		fprintf(logfil, "send_don2_booklist\n");
		fflush(logfil);
	}
	reclow(r159,R159);
	f159_start(1,ISGTEQ);
	if (ws_logintype==1) {
		r159->lejerkundenr = ws_opdaterknr;
		keynr = 10;
	}
	if (ws_logintype==2) {
		r159->firmakundenr = ws_opdaterknr;
		keynr = 9;
	}
	if (keynr>0) {
		f159_start(keynr,ISGTEQ);
		if (f159_ukendt) {
			antal = -1;
		}
	}
	if (logfil) {
		fprintf(logfil,"\tTIDLIGERE\n");
		fprintf(logfil,"\tkeynr=%d\n",keynr);
		fprintf(logfil,"\tantal=%d\n",antal);
	}
	while (keynr>0 && antal>=0) {
		egeread(f159,ISNEXT);
		readantal++;
		if (f159_eof) {
			break;
		}
/*
		if (logfil) {
			fprintf(logfil,"\t\t%ld %ld %ld %hd %hd\n",
				r159->record_x,
				r159->lejerkundenr,
				r159->firmakundenr,
				r159->status,
				r159->kontrakttype_kode);
		}
*/
		if (keynr==9 && r159->firmakundenr>ws_opdaterknr) {
			break;
		}
		if (keynr==10 && r159->lejerkundenr>ws_opdaterknr) {
			break;
		}
		if (r159->kontrakttype_kode!=3) {
			continue;
		}
		if (r159->status==7) { continue; }


/* NYT 130624 BOOKLISTANNULL */
		if (r159->status==5) { continue; }
/* NYT 130624 NOSHOW */
		if (r159->dato_ud<ws_systemdato) { continue; }



/* OBS TEST */
/*
		if (ws_opdaterknr==404485 && r159->record_x==26637418) {
			continue;
		}
		if (ws_opdaterknr==404485 && r159->record_x==26637605) {
			continue;
		}
		if (r159->lejerkundenr==821135) { continue; }
*/
/* TEST 121204 */
/*
		r159->tid_ud /= 100;
		r159->tid_ud *= 100;
		r159->forv_tid_ind /= 100;
		r159->forv_tid_ind *= 100;
		if (r159->tid_ud>=1700) { r159->tid_ud = 1600; }
		if (r159->tid_ud<=800) { r159->tid_ud = 800; }
		if (r159->forv_tid_ind>=1700) { r159->forv_tid_ind = 1600; }
		if (r159->forv_tid_ind<=800) { r159->forv_tid_ind = 800; }
		r159->tid_ud = 800;
		r159->forv_tid_ind = 1300;
*/
		alfalow(str);
		pack_init(str);
/* NYT 121031 */
		pack_int2((long)r159->record_x);

		pack_int2((long)r159->station_ud_nr);
		pack_int2((long)r159->station_ind_nr);
		ege_w_int1 = m036_funktion(17,(long int)r159->dato_ud);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		pack_alfa(tmpstr);
		sprintf(tmpstr,"%4.4ld",r159->tid_ud);
/* TEST 130115
		sprintf(tmpstr,"1201");
		sprintf(tmpstr,"1400");
*/
		pack_alfa(tmpstr);
		ege_w_int1 = m036_funktion(17,(long int)r159->forv_dato_ind);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		pack_alfa(tmpstr);
		sprintf(tmpstr,"%4.4ld",r159->forv_tid_ind);
/* TEST 130115
		sprintf(tmpstr,"1201");
		sprintf(tmpstr,"1400");
*/
		pack_alfa(tmpstr);
		strcpy(tmpstr,"A");
		if (r159->bil_grp[0]>=48 && r159->bil_grp[0]<=57) {
			strcpy(tmpstr,"3");
		}
		pack_alfa(tmpstr);
/* RETTET 130226
		pack_alfa(r159->bil_grp);
*/
		pack_int2((long)r159->rate_spec_nr[0]);
/* NYT 130123 BOOKLISTANNULL */
		if (r159->status!=5) {
/* NYT 121015 BOOKLISTNAVNE */
			pack_alfa(r159->lejerfornavn);
			pack_alfa(r159->lejerefternavn);
			pack_alfa(r159->medlfornavn);
			pack_alfa(r159->medlefternavn);
		} else {
			strcpy(tmpstr,"");
			pack_alfa(tmpstr);
			pack_alfa(tmpstr);
			sprintf(tmpstr,"ANNULLERET");
			pack_alfa(tmpstr);
			strcpy(tmpstr,r159->medlefternavn);
			pack_alfa(tmpstr);
		}

		ege_w_dou1 = r159->total;
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);
/* NYT 121012 */
		aktivflag = 1;
		if (r159->status!=2) {
			aktivflag = 0;
		}
		pack_int2((long)aktivflag);

#ifdef egetest
		ws_specnr = r159->rate_spec_nr[0];
		ws_station = r159->station_ud_nr;
		strcpy(ws_grp,r159->bil_grp);
		(void)init_extraptab(1);
/* OBS
		opdater_extraptab(1);
*/
		pak_extraptab(1);
#endif
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		antal++;
		retur++;
/* OBS */
/*
		if (ws_opdaterknr==404485 && retur>3) {
			break;
		}
*/
	}
/* NYT 130606 KONTRAKTLISTE */

	if (logfil) {
		fprintf(logfil, "\tKONTRAKTER\n");
		fflush(logfil);
	}
	reclow(r159,R159);
	f159_start(1,ISGTEQ);
	if (ws_logintype==1) {
		r159->lejerkundenr = ws_opdaterknr;
		keynr = 10;
	}
	if (ws_logintype==2) {
		r159->firmakundenr = ws_opdaterknr;
		keynr = 9;
	}
	if (keynr>0) {
		f159_start(keynr,ISGTEQ);
		if (f159_ukendt) {
			konantal = -1;
		}
	}
	if (logfil) {
		fprintf(logfil,"\tTIDLIGERE\n");
		fprintf(logfil,"\tkeynr=%d\n",keynr);
		fprintf(logfil,"\tantal=%d\n",antal);
	}
	while (keynr>0 && konantal>=0) {
		egeread(f159,ISNEXT);
		readantal++;
		if (f159_eof) {
			break;
		}
/*
		if (logfil) {
			fprintf(logfil,"\t\t%ld %ld %ld %hd %hd\n",
				r159->record_x,
				r159->lejerkundenr,
				r159->firmakundenr,
				r159->status,
				r159->kontrakttype_kode);
		}
*/
		if (keynr==9 && r159->firmakundenr>ws_opdaterknr) {
			break;
		}
		if (keynr==10 && r159->lejerkundenr>ws_opdaterknr) {
			break;
		}
		if (r159->kontrakttype_kode!=1) {
			continue;
		}
		okflag = 0;
		if (r159->status==4) { okflag = 1; }
		if (r159->status==6) { okflag = 1; }
		if (okflag<=0) {
			continue;
		}

		alfalow(str);
		pack_init(str);
/* NYT 121031 */
		pack_int2((long)r159->record_x);

		pack_int2((long)r159->station_ud_nr);
		pack_int2((long)r159->station_ind_nr);
		ege_w_int1 = m036_funktion(17,(long int)r159->dato_ud);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		pack_alfa(tmpstr);
		sprintf(tmpstr,"%4.4ld",r159->tid_ud);
		pack_alfa(tmpstr);
		ege_w_int1 = m036_funktion(17,(long int)r159->dato_ind);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		pack_alfa(tmpstr);
		sprintf(tmpstr,"%4.4ld",r159->tid_ind);
		pack_alfa(tmpstr);
		strcpy(tmpstr,"A");
		if (r159->bil_grp[0]>=48 && r159->bil_grp[0]<=57) {
			strcpy(tmpstr,"3");
		}
		pack_alfa(tmpstr);
		pack_int2((long)r159->rate_spec_nr[0]);
		pack_alfa(r159->lejerfornavn);
		pack_alfa(r159->lejerefternavn);
		pack_alfa(r159->medlfornavn);
		pack_alfa(r159->medlefternavn);

		ege_w_dou1 = r159->total;
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);
		aktivflag = 0;
		pack_int2((long)aktivflag);

		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		konantal++;
		retur++;
	}

/* TEST 130530 BOOKNOMATCH */
	if (retur==0) {
		alfalow(str);
		pack_init(str);
		pack_alfa("0");
		pack_alfa("");
		pack_alfa("");
		pack_alfa("01012013");
		pack_alfa("0800");
		pack_alfa("01012013");
		pack_alfa("0800");
		pack_alfa("");
		pack_alfa("");
		pack_alfa("");
		pack_alfa("");
		pack_alfa("");
		pack_alfa("");
		pack_alfa("");
		pack_alfa("");
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur=1;
	}
	if (logfil) {
		fprintf(logfil,"\treadantal=%d\n",readantal);
		fprintf(logfil,"send_don2_booklist:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************************** */
static int pak_extraptab(int inpfunk) {
	int nuvindex = 0;
	int retur = 0;
	char tmpstr[81] = "";

	nuvindex = 0;
	while (nuvindex<MAX_EXTRAPRODTAB) {
		if (!strlen(extraptab[nuvindex].id)) {
			nuvindex++;
			continue;
		}
		pack_alfa(extraptab[nuvindex].id);
		pack_alfa(extraptab[nuvindex].beskrivelse);
		pack_alfa(extraptab[nuvindex].enhedtxt);
		ege_w_dou1 = extraptab[nuvindex].enhedpris;
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);
		pack_int2((long)extraptab[nuvindex].nuvantal);
		pack_int2((long)extraptab[nuvindex].minantal);
		pack_int2((long)extraptab[nuvindex].maxantal);
		pack_alfa(extraptab[nuvindex].valgtype);
		ege_w_dou1 = extraptab[nuvindex].totalpris;
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);
		nuvindex++;
	}

	return(retur);
}

/* ************************************************************************** */
static int send_don2_editrental() {
	int retur = 1;
	int fundet = 1;
	long int resnr = 0;
	char tmpstr[81] = "";

	resnr = ws_resnr;
	if (logfil) {
		fprintf(logfil, "send_don2_rental:resnr=%ld\n",
			resnr);
		fflush(logfil);
	}
	if (resnr>0) {
		reclow(r159, R159);
		f159_start(1, ISGTEQ);
		r159->record_x = resnr;
		egeread(f159, ISEQUAL);
	}
	if (resnr>0 && f159_ukendt) {
		ws_don2errno = DON2EDTCNC;
		retur = 0;
		fundet = 0;
	}
	if (retur==1 && resnr>0 && f159_ok && r159->status==5) {
		ws_don2errno = DON2EDTCNC;
		fundet = 0;
		retur = 0;
	}
	if (retur==1 && resnr>0 && f159_ok && r159->status==7) {
		ws_don2errno = DON2EDTKNV;
		fundet = 0;
		retur = 0;
	}
	if (fundet==0 && retur==0 && resnr>0 && ws_don2errno>0) {
		(void)frankly_err(ws_funktion,
			"fejl",ws_don2errno);
		retur = 1;
		goto afslut;
	}

	alfalow(str);
	pack_init(str);
	pack_int2((long)r159->station_ud_nr);
	pack_int2((long)r159->station_ind_nr);
	ege_w_int1 = m036_funktion(17,(long int)r159->dato_ud);
	sprintf(tmpstr,"%8.8ld",ege_w_int1);
	pack_alfa(tmpstr);
	sprintf(tmpstr,"%4.4ld",r159->tid_ud);
	pack_alfa(tmpstr);
	ege_w_int1 = m036_funktion(17,(long int)r159->forv_dato_ind);
	sprintf(tmpstr,"%8.8ld",ege_w_int1);
	pack_alfa(tmpstr);
	sprintf(tmpstr,"%4.4ld",r159->forv_tid_ind);
	pack_alfa(tmpstr);
	pack_alfa(r159->bil_grp);
	pack_int2((long)r159->rate_spec_nr[0]);
	ege_w_dou1 = r159->total;
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
	ws_specnr = r159->rate_spec_nr[0];
	ws_station = r159->station_ud_nr;
	strcpy(ws_grp,r159->bil_grp);
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	retur++;
afslut:
	return(retur);
}

/* ************************************************** */
static int send_psgenprisliste(int inpfunk) {
	int retur = 0;
	short int wx1 = 0;
	short int okflag = 0;
	short int aftaleflag = 0;
	short int dkflag = 0;
	short int pbilflag = 0;
	short int funkretur = 0;
	short int prisextra = 0;
	short int station = 0;
	short int starttypeidx = 0;
	short int sluttypeidx = 0;
	short int mainloopidx = 0;
	long int fradato = 0;
        double mbdag = 0;
        double mbmax = 0;
	char mbtxt[41] = "";
	char tmpstr[201] = "";
	char addtxt[201] = "";

	if (logfil) {
		fprintf(logfil, "send_psgenprisliste:inpfunk=%d\n",inpfunk);
		fprintf(logfil, "\tws_biltype=<%s>\n",ws_biltype);
		fprintf(logfil, "\tws_grp=<%s>\n",ws_grp);
		fprintf(logfil, "\tws_grpidx=%hd\n",ws_grpidx);
		fprintf(logfil, "\tws_evtextra=%s\n",ws_evtextra);
		fprintf(logfil, "\tdkflag=%hd\n",dkflag);
		fprintf(logfil, "\tpbilflag=%hd\n",pbilflag);
		fprintf(logfil, "\tmbdag=%lf\n",mbdag);
		fprintf(logfil, "\tmbmax=%lf\n",mbmax);
	}
	if (strcmp(ws_evtextra,"EXTRA")==0) {
		prisextra = 1;
	}
	if (logfil) {
		fprintf(logfil, "\tprisextra=%hd\n",prisextra);
	}
	starttypeidx = -1;
	sluttypeidx = -1;
	if (logfil) {
		fprintf(logfil, "\tBILTYPEOGGRUPPEBLANK\n");
	}
	if (!strlen(ws_grp) && !strlen(ws_biltype)) {
		funkretur = dan_psgrptab(1,ws_langstr,ws_station);
	}
	if (logfil) {
		fprintf(logfil,"\tfunkretur=%d\n",funkretur);
	}
	if (!strlen(ws_grp) && !strlen(ws_biltype) && funkretur>0) {
		starttypeidx = 0;
		sluttypeidx = ws_grpidx-1;
		goto mainloop00;
	}
	if (logfil) {
		fprintf(logfil, "\tBILTYPEOGGRUPPECHECK\n");
	}
	wx1 = 0;
	while (wx1<ws_grpidx && strlen(ws_biltype) && strlen(ws_grp)) {
		if (strncmp(ws_grptab[wx1]+2,ws_biltype,3)==0 &&
			strncmp(ws_grptab[wx1]+8,ws_grp,3)==0) {
			starttypeidx = wx1;
			sluttypeidx = wx1;
			break;
		}
		wx1++;
	}
	if (starttypeidx>=0 && sluttypeidx>=0) {
		goto mainloop00;
	}
	if (logfil) {
		fprintf(logfil, "\tBILTYPECHECK\n");
	}
	wx1 = 0;
	while (wx1<ws_grpidx && strlen(ws_biltype)) {
		if (strncmp(ws_grptab[wx1]+2,ws_biltype,3)==0 &&
			starttypeidx==-1) {
			starttypeidx = wx1;
		}
		if (strncmp(ws_grptab[wx1]+2,ws_biltype,3)==0) {
			sluttypeidx = wx1;
		}
		wx1++;
	}
	if (starttypeidx>=0 && sluttypeidx>=0) {
		goto mainloop00;
	}
	wx1 = 0;
	while (wx1<ws_grpidx) {
		if (strncmp(ws_grptab[wx1]+2,ws_grp,3)==0 &&
			starttypeidx==-1) {
			starttypeidx = wx1;
			sluttypeidx = wx1;
			strcpy(ws_biltype,ws_grp);
			strcpy(ws_grp,"");
		}
		if (strlen(ws_biltype) &&
			strncmp(ws_grptab[wx1]+2,ws_biltype,3)==0) {
			sluttypeidx = wx1;
		}
		wx1++;
	}
	wx1 = 0;
	while (wx1<ws_grpidx && !strlen(ws_biltype)) {
		sscanf(ws_grptab[wx1]+8,"%s",tmpstr);
		if (strcmp(tmpstr,ws_grp)==0 && starttypeidx==-1) {
			starttypeidx = wx1;
			sluttypeidx = wx1;
			sscanf(ws_grptab[wx1]+2,"%s",ws_biltype);
			break;
		}
		wx1++;
	}
	if (logfil) {
		fprintf(logfil,
			"\tws_grp=%s\n",ws_grp);
		fprintf(logfil,
			"\tws_biltype=%s\n",ws_biltype);
		fprintf(logfil,
			"\tstarttypeidx=%hd\n",starttypeidx);
		fprintf(logfil,
			"\tsluttypeidx=%hd\n",sluttypeidx);
	}
/* NYT 131209 BILTYPEFEJL */
	if (starttypeidx==-1 || sluttypeidx==-1) {
		ws_don2errno = DON2TPGRPUK;
	}
	if (logfil) {
		fprintf(logfil,
			"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		ws_funkretur2 = frankly_err(ws_funktion,
			"fejl",ws_don2errno);
		retur = 0;
		goto afslut;
	}
mainloop00:
	mainloopidx = starttypeidx;
	if (logfil) {
		fprintf(logfil,"\tMAINLOOP00mainloopidx=%hd\n",mainloopidx);
		fprintf(logfil,"\tMAINLOOP00sluttypeidx=%hd\n",sluttypeidx);
	}
mainloop01:
	if (mainloopidx>sluttypeidx) { goto mainloopslut; }
	if (logfil) {
		fprintf(logfil,"\t\tmainloopidx=%hd\n",mainloopidx);
	}
	sscanf(ws_grptab[mainloopidx]+2,"%s",ws_biltype);
	sscanf(ws_grptab[mainloopidx]+8,"%s",ws_grp);

	alfalow(str);
	pack_init(str);
	pack_int2((long)ws_station);
	pack_alfa(ws_biltype);
	pack_alfa(ws_grp);

/* NYT 140411 BILGRUPPEFILREF */
	if (access("nypslistejpgok",0)==0) {
		sprintf(tmpstr,"stdbil.jpg");
		sprintf(tmpstr,"grp%s.jpg",ws_grp);
		if (ws_grp[1]=='+') {
			tmpstr[4] = '\0';
			strcat(tmpstr,"plus.jpg");
		}
		ege_tolower((unsigned char *)tmpstr);
		pack_alfa(tmpstr);
	}

	sprintf(tmpstr,"GrpSpecialTopTxt-grp.%s",ws_grp);
/* NYT 140409 */
	if (strcmp(ws_biltype,"PRS")==0) {
		sprintf(tmpstr,"Personbiler-grp.%s",ws_grp);
	}
	if (strcmp(ws_biltype,"BUS")==0) {
		sprintf(tmpstr,"Busser-grp.%s",ws_grp);
	}
	if (strcmp(ws_biltype,"VAR")==0) {
		sprintf(tmpstr,"Varevogne-grp.%s",ws_grp);
	}
	if (strcmp(ws_biltype,"LST")==0) {
		sprintf(tmpstr,"Lastvogne-grp.%s",ws_grp);
	}
	if (prisextra>0) {
		strcpy(tmpstr,"ExtraGrpSpecialTopTxt");
	}
	pack_alfa(tmpstr);

/*
	sprintf(tmpstr,"GrpSpecialBundTxt-grp.%s",ws_grp);
*/
	strcpy(tmpstr,"");
/* NYT 140306 PSPRODUKTINKL */
/* NYT 140905 PSMBIDRAGPRISLISTE */
	strcpy(mbtxt,"");
	if (strlen(ws_grp) && ws_grp[0]>='0' && ws_grp[0]<='9') {
		strcpy(mbtxt,", miljøbidrag");
	}
	sprintf(addtxt,"Ovenstående priser er vejledende salgspriser inkl. moms%s og forsikring (selvrisiko).",mbtxt);
	strcat(tmpstr,addtxt);
	strcpy(addtxt," Brændstof er ikke inkl. i priserne");
	strcat(tmpstr,addtxt);
	sprintf(addtxt," (GrpSpecialBundTxt-grp.%s)",ws_grp);
	strcat(tmpstr,addtxt);

	if (prisextra>0) {
		strcpy(tmpstr,"ExtraGrpSpecialBundTxt");
	}
	pack_alfa(tmpstr);

 	pack_del();
/* Prislinier */
	if (prisextra>0) {
		strcpy(tmpstr,"EXTRA");
		pack_alfa(tmpstr);
		strcpy(tmpstr,"Ekstraudstyrspriser undervejs...");
		pack_alfa(tmpstr);
/*
		ege_w_dou1 = 300;
		xls_char(tmpstr,(double)ege_w_dou1,2);
*/
		strcpy(tmpstr,"N/A");
		pack_alfa(tmpstr);
	} else {
		(void)add_psprislinier(1,ws_station,ws_biltype,ws_grp);
	}

	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil,"SENDT:%s",str);
	}

	retur++;
	mainloopidx++;
	goto mainloop01;
mainloopslut:


afslut:
	if (logfil) {
		fprintf(logfil, "send_psgenprisliste:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************* */
static int add_psprislinier(int inpfunk,short inpstation,char *inptype,char *inpgrp) {
	int retur = 0;
	int nuvidx = 0;
	int maxidx = 0;
	int nytkatalogflag = 0;
	int xlsprisflag = 0;
	int nyprisflag = 0;
	int funkretur = 0;
	int lnantal = 0;
	int mbidragflag = 0;
	long int nuvvarighed = 0;
	long int inclkm = 0;
	double mbialt = 0;
	double mbdag = 0;
	double mbmax = 0;
	double pris = 0;
	double cdipris = 0;
	double paipris = 0;
	double lastkmpris = 0;
	char testmaerke[11] = "";
	char tmpstr[81] = "";
	char specnrtxt[51] = "810";
	char addtxt[51] = "";
	short int dgvartabel[60] = {
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

	for (nuvidx=0;nuvidx<60;nuvidx++) {
		dgvartabel[nuvidx] = 0;
	}
/* XLSPRIS */
	if (inpstation==53) {
		xlsprisflag = 1;
		sprintf(ws_prisfilid,"PS%5.5ld%5.5ldSTD",
			(long int)inpstation,
			(long int)800);
		nuvidx = 1;
		maxidx = 29;
		dgvartabel[1] = 1;
		dgvartabel[3] = 1;
		dgvartabel[5] = 1;
		dgvartabel[7] = 1;
		strcpy(specnrtxt,"800");
	}
/* NYT 140310 XLSPRIS2 */
	if (inpstation==52 || inpstation==61) {
		xlsprisflag = 1;
		sprintf(ws_prisfilid,"PS%5.5ld%5.5ldSTD",
			(long int)inpstation,
			(long int)800);
		nuvidx = 1;
		maxidx = 29;
		dgvartabel[1] = 1;
		dgvartabel[3] = 1;
		dgvartabel[5] = 1;
		dgvartabel[7] = 1;
		strcpy(specnrtxt,"800");
	}
	if (access("nypsprislisteok",0)==0) {
		nyprisflag = 1;
	}
/* NYT 141117 PSGLNYKATALOG */
	sprintf(tmpstr,"PS%5.5ld%5.5ldSTD.main",
		(long int)inpstation,
		(long int)830);
	nytkatalogflag = xlspris_findesmain(tmpstr);

	if (access("psnyprod",0)==0 && nytkatalogflag>0 &&
		strcmp(inptype,"PRS")==0) {
		sprintf(ws_prisfilid,"PS%5.5ld%5.5ldSTD",
			(long int)inpstation,
			(long int)830);
		strcpy(specnrtxt,"830");
	}
	if (access("psnyprod",0)==0 && nytkatalogflag>0 &&
		strcmp(inptype,"BUS")==0) {
		sprintf(ws_prisfilid,"PS%5.5ld%5.5ldSTD",
			(long int)inpstation,
			(long int)830);
		strcpy(specnrtxt,"830");
	}
	sprintf(tmpstr,"PS%5.5ld%5.5ldSTD.main",
		(long int)inpstation,
		(long int)831);
	nytkatalogflag = xlspris_findesmain(tmpstr);
	if (access("psnyprod",0)==0 && nytkatalogflag>0 &&
		strcmp(inptype,"VAR")==0) {
		sprintf(ws_prisfilid,"PS%5.5ld%5.5ldSTD",
			(long int)inpstation,
			(long int)831);
		strcpy(specnrtxt,"831");
	}
	if (access("psnyprod",0)==0 && nytkatalogflag>0 &&
		strcmp(inptype,"LST")==0) {
		sprintf(ws_prisfilid,"PS%5.5ld%5.5ldSTD",
			(long int)inpstation,
			(long int)831);
		strcpy(specnrtxt,"831");
	}
	if (logfil) {
		fprintf(logfil,"add_psprislinier %d %hd %s %s\n",
			inpfunk,
			inpstation,
			inptype,
			inpgrp);
		fprintf(logfil,"\tnyprisflag=%d\n",
			nyprisflag);
		fprintf(logfil,"\tnytkatalogflag=%d\n",
			nytkatalogflag);
		fprintf(logfil,"\tXLSPRIS %d %s %d-%d\n",
			xlsprisflag,
			ws_prisfilid,
			nuvidx,
			maxidx);
	}

/* NYT 131216 PSPRISER */
	if (xlsprisflag==0) {
		nuvidx = 0;
		maxidx = 0;
	}
	if (xlsprisflag==0 && strcmp(inptype,"VAR")==0) {
		strcpy(specnrtxt,"820");
	}
	if (xlsprisflag==0 && strcmp(inptype,"LST")==0) {
		strcpy(specnrtxt,"820");
	}

	while (xlsprisflag==0 && nuvidx<=maxidx) {
		strcpy(tmpstr,specnrtxt);
		pack_alfa(tmpstr);
		strcpy(tmpstr,"1 dag inkl. 100 km");
		pack_alfa(tmpstr);
		ege_w_dou1 = 300;
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);
		retur++;
		nuvidx++;
	}
	if (xlsprisflag==0 && retur>0) {
		sprintf(tmpstr,"%sXKM",specnrtxt);
		pack_alfa(tmpstr);
		strcpy(tmpstr,"Pr. ekstra km.");
		pack_alfa(tmpstr);
		ege_w_dou1 = 2;
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);

		retur++;
	}
igen:
	if (logfil) {
		fprintf(logfil,"\tIGEN xlsprisflag=%d\n",
			xlsprisflag);
	}
	lnantal = 0;
	lastkmpris = 0;
	while (xlsprisflag>0 && nuvidx<maxidx) {
		if (dgvartabel[nuvidx]<=0) {
			nuvidx++;
			continue;
		}
/* NYT 140404 NYPSPRISLISTE */
		if (lnantal==0 && nyprisflag>0) {
			strcpy(tmpstr,"OVERSK");
			pack_alfa(tmpstr);
			strcpy(tmpstr,"Produkt");
			pack_alfa(tmpstr);
			strcpy(tmpstr,"Pris");
			pack_alfa(tmpstr);
			strcpy(tmpstr,"Pr. ekstra km.");
			pack_alfa(tmpstr);
			strcpy(tmpstr,"Evt.");
			pack_alfa(tmpstr);
		}
		nuvvarighed = (long int)nuvidx;
		sprintf(tmpstr,"%s.spec",ws_prisfilid);
		funkretur = xlspris_udpaksub(tmpstr,
			inpgrp,
			(long int)nuvvarighed);
                pris = xlsprissub->prisprenhed;
                inclkm = xlsprissub->inclkm;
                cdipris = xlsprissub->cdiprdag;
                paipris = xlsprissub->paiprdag;
/* NYT 140514 WEEKENDPRIS */
		if (xlsprissub->specnr==801 && xlsprissub->enhed==203) {
			cdipris *= (double)nuvvarighed;
		}
/* NYT 141117 PSGLNYKATALOG */
		if (xlsprissub->specnr==832 && xlsprissub->enhed==203) {
			cdipris *= (double)nuvvarighed;
		}
		if (xlsprissub->specnr==833 && xlsprissub->enhed==203) {
			cdipris *= (double)nuvvarighed;
		}

		if (xlsprissub->enhed==201) {
			pris *= (double)nuvvarighed;
			inclkm *= nuvvarighed;
			cdipris *= (double)nuvvarighed;
			paipris *= (double)nuvvarighed;
		}
		if (xlsprissub->inclcdiflag>0) {
			pris += cdipris;
		}
		if (xlsprissub->inclpaiflag>0) {
			pris += paipris;
		}
/* NYT 140905 PSMBIDRAGPRISLISTE */
		mbidragflag = 0;
		mbialt = 0;
		if (strlen(inpgrp) && inpgrp[0]>='0' && inpgrp[0]<='9') {
			mbidragflag = 1;
			udregn_mbidrag_beloeb(1,inpgrp,&mbdag,&mbmax);
		}
		if (mbidragflag>0) {
			mbialt = mbdag;
			mbialt *= (double)nuvvarighed;
			if (mbialt>mbmax) {
				mbialt = mbmax;
			}
/* MOMS */
			mbialt *= 1.25;
		}
		pris += mbialt;

		strcpy(tmpstr,specnrtxt);
		pack_alfa(tmpstr);
		strcpy(testmaerke,"");
		if (ws_testkreds>0 && access("psnyprod",0)==0) {
			strcpy(testmaerke,"NyT-");
		}
		if (ws_testkreds>0 && strcmp(specnrtxt,"800")==0) {
			strcpy(testmaerke,"GlT");
		}
		if (ws_testkreds>0 && strcmp(specnrtxt,"801")==0) {
			strcpy(testmaerke,"GlT");
		}
		if (nuvvarighed==1) {
			sprintf(tmpstr,"%s%ld dag inkl.",
				testmaerke,
				nuvvarighed);
		} else {
			sprintf(tmpstr,"%s%ld dage inkl.",
				testmaerke,
				nuvvarighed);
		}
		strcpy(testmaerke,"");
		if (ws_testkreds>0 && access("psnyprod",0)==0) {
			strcpy(testmaerke,"NyT-");
		}
		if (ws_testkreds>0 && strcmp(specnrtxt,"800")==0) {
			strcpy(testmaerke,"GlT");
		}
		if (ws_testkreds>0 && strcmp(specnrtxt,"801")==0) {
			strcpy(testmaerke,"GlT");
		}
		if (nuvvarighed>1 && xlsprissub->specnr==801) {
			sprintf(tmpstr,"%sWeekend inkl.",testmaerke);
		}
/* NYT 141117 PSGLNYKATALOG */
		if (nuvvarighed>1 && xlsprissub->specnr==832) {
			sprintf(tmpstr,"%sWeekend inkl.",testmaerke);
		}
		if (nuvvarighed>1 && xlsprissub->specnr==833) {
			sprintf(tmpstr,"%sWeekend inkl.",testmaerke);
		}
/*
		if (xlsprissub->inclmomsflag>0) {
			sprintf(addtxt," moms");
			strcat(tmpstr,addtxt);
		}
*/
/* TEST 140514 */
		if (logfil) {
			fprintf(logfil,
				"\t\tnuvvarighed=%ld specnr=%ld inpgrp=%s\n",
				nuvvarighed,
				xlsprissub->specnr,
				inpgrp);
			fprintf(logfil,"\t\t\tenhed=%ld\n",
				xlsprissub->enhed);
			fprintf(logfil,"\t\t\tcdipris=%lf\n",
				cdipris);
			fprintf(logfil,"\t\t\tpaipris=%lf\n",
				paipris);
			fprintf(logfil,"\t\t\tpris=%lf\n",
				pris);
			fprintf(logfil,"\t\t\tmbidragflag=%d mbialt=%lf\n",
				mbidragflag,
				mbialt);
		}

		sprintf(addtxt," %ld km",inclkm);
		strcat(tmpstr,addtxt);

		pack_alfa(tmpstr);
		ege_w_dou1 = pris;
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);

/* NYT 140404 NYPSPRISLISTE */
		if (nyprisflag>0) {
			if (lastkmpris==xlsprissub->ekstrakmpris) {
				strcpy(tmpstr,"");
			} else {
				ege_w_dou1 = xlsprissub->ekstrakmpris;
				xls_char(tmpstr,(double)ege_w_dou1,2);
			}
			pack_alfa(tmpstr);
			strcpy(tmpstr,"");
			pack_alfa(tmpstr);
		} else {
/* RETTET 140404 NYPSPRISLISTE */
			sprintf(tmpstr,"%sXKM",specnrtxt);
			pack_alfa(tmpstr);
			strcpy(tmpstr,"Pr. ekstra km.");
			pack_alfa(tmpstr);
			ege_w_dou1 = xlsprissub->ekstrakmpris;
			xls_char(tmpstr,(double)ege_w_dou1,2);
			pack_alfa(tmpstr);
		}
		lastkmpris = xlsprissub->ekstrakmpris;
		nuvidx++;
		retur++;
		lnantal++;
	}
	if (xlsprisflag==2) {
		goto afslut;
	}
/* WEEKEND */
	if (inpstation==53 && xlsprisflag==1) {
		sprintf(ws_prisfilid,"PS%5.5ld%5.5ldSTD",
			(long int)inpstation,
			(long int)801);
		nuvidx = 1;
		maxidx = 29;
		dgvartabel[1] = 0;
		dgvartabel[3] = 1;
		dgvartabel[5] = 0;
		dgvartabel[7] = 0;
		strcpy(specnrtxt,"801");
		xlsprisflag++;
/* FLYTTET 141117
		goto igen;
*/
	}
/* NYT 140310 WEEKEND XLSPRIS2 */
	if ((inpstation==52 || inpstation==61) && xlsprisflag==1) {
		sprintf(ws_prisfilid,"PS%5.5ld%5.5ldSTD",
			(long int)inpstation,
			(long int)801);
		nuvidx = 1;
		maxidx = 29;
		dgvartabel[1] = 0;
		dgvartabel[3] = 1;
		dgvartabel[5] = 0;
		dgvartabel[7] = 0;
		strcpy(specnrtxt,"801");
		xlsprisflag++;
/* FLYTTET 141117
		goto igen;
*/
	}
/* NYT 141117 PSGLNYKATALOG */
	sprintf(tmpstr,"PS%5.5ld%5.5ldSTD.main",
		(long int)inpstation,
		(long int)832);
	nytkatalogflag = xlspris_findesmain(tmpstr);
	if (access("psnyprod",0)==0 && nytkatalogflag>0 &&
		strcmp(inptype,"PRS")==0) {
		sprintf(ws_prisfilid,"PS%5.5ld%5.5ldSTD",
			(long int)inpstation,
			(long int)832);
		strcpy(specnrtxt,"832");
	}
	if (access("psnyprod",0)==0 && nytkatalogflag>0 &&
		strcmp(inptype,"BUS")==0) {
		sprintf(ws_prisfilid,"PS%5.5ld%5.5ldSTD",
			(long int)inpstation,
			(long int)832);
		strcpy(specnrtxt,"832");
	}
	sprintf(tmpstr,"PS%5.5ld%5.5ldSTD.main",
		(long int)inpstation,
		(long int)833);
	nytkatalogflag = xlspris_findesmain(tmpstr);
	if (access("psnyprod",0)==0 && nytkatalogflag>0 &&
		strcmp(inptype,"VAR")==0) {
		sprintf(ws_prisfilid,"PS%5.5ld%5.5ldSTD",
			(long int)inpstation,
			(long int)833);
		strcpy(specnrtxt,"833");
	}
	if (access("psnyprod",0)==0 && nytkatalogflag>0 &&
		strcmp(inptype,"LST")==0) {
		sprintf(ws_prisfilid,"PS%5.5ld%5.5ldSTD",
			(long int)inpstation,
			(long int)833);
		strcpy(specnrtxt,"833");
	}
	if (xlsprisflag==2) {
		goto igen;
	}
afslut:
	if (logfil) {
		fprintf(logfil,"\txlsprisflag=%hd\n",xlsprisflag);
		fprintf(logfil,"add_psprislinier retur=%d\n",
			retur);
	}
	return(retur);
}

/* ************************************ */
/* DONFUNK2				*/
static int send_genprisliste(int inpfunk) {
	int retur = 0;
	short int wx1 = 0;
	short int okflag = 0;
	short int aftaleflag = 0;
	short int dkflag = 0;
	short int pbilflag = 0;
	short int funkretur = 0;
	short int prisextra = 0;
	short int station = 0;
	long int fradato = 0;
	long int tildato = 0;
	long int julian = 0;
	long int antaldgn = 1;
	long int antalmdage = 1;
	long int firmakundenr = 0;
	long int firmaaftfra = 0;
	long int firmaafttil = 0;
	long int klafh = 0;
	long int klafl = 0;
	char grp[11] = "";
	char transstr[21] = "";
	char prisstr[21] = "";
	char returstr[81] = "";
	char tmpstr[101] = "";
	char langstr[21] = "";
	double niv_pris;
	double niv_cdi;
        double niv_pai;
        double niv_km;
        double mbdag = 0;
        double mbmax = 0;
	long int inclkm;
	FILE * tmpfil;

	tmpfil = (FILE*)0;

	station = ws_station;
	strcpy(langstr,ws_langstr);
	if (strcmp(ws_langstr, "DK")==0 ||
		strcmp(ws_langstr,"DA")==0) {
		dkflag = 1;
	}
	if (strcmp(ws_grp, "A")==0) {
		pbilflag = 1;
	}
	if (strcmp(ws_grp, "3")==0) {
		udregn_mbidrag_beloeb(1,ws_grp,&mbdag,&mbmax);
	}
	if (logfil) {
		fprintf(logfil, "send_genprisliste:inpfunk=%d\n",inpfunk);
		fprintf(logfil, "\tdkflag=%hd\n",dkflag);
		fprintf(logfil, "\tpbilflag=%hd\n",pbilflag);
		fprintf(logfil, "\tmbdag=%lf\n",mbdag);
		fprintf(logfil, "\tmbmax=%lf\n",mbmax);
	}
	reclow(r165, R165);
	r165->stat_nr = station;
	f165_start(2, ISGTEQ);
	if (f165_ukendt) {
		okflag = -1;
	}
	if (logfil) {
		fprintf(logfil, "\tokflag=%hd\n",okflag);
		fflush(logfil);
	}
/* NYT 121203 DON2PRISLST */
	sprintf(tmpstr, "don2prislst.%s",ws_grp);
	tmpfil = fopen(tmpstr,"r");
	if (!tmpfil) {
		okflag = 0;
	}

	while (okflag>=0) {
		if (!fgets(tmpstr,100,tmpfil)) {
                        break;
                }
                if (strlen(tmpstr)) {
                        tmpstr[strlen(tmpstr)-1] = '\0';
                }
		if (!strlen(tmpstr)) {
			break;
		}
		sscanf(tmpstr,"%hd",&r165->spec_nr);
		strcpy(r165->bil_grp,ws_grp);
		r165->stat_nr = station;
		egeread(f165, ISEQUAL);
		if (f165_ukendt) {
			continue;
		}

/* RETTET 121203
		egeread(f165, ISNEXT);
		if (f165_eof) {
			break;
		}
*/
		if (logfil) {
			fprintf(logfil, "\t\tstat_nr=%hd\n",r165->stat_nr);
			fprintf(logfil, "\t\tspec_nr=%hd\n",r165->spec_nr);
			fprintf(logfil, "\t\tbil_grp=%s\n",r165->bil_grp);
			fprintf(logfil, "\t\tenhed=%hd\n",r165->enhed);
			fprintf(logfil, "\t\trate_cdw=%.2f\n",r165->rate_cdw);
			fflush(logfil);
		}
		if (r165->stat_nr!=station) {
			break;
		}
		if (strcmp(r165->bil_grp,ws_grp)!=0) {
			continue;
		}
		if (r165->slet_mark>0) {
			continue;
		}
/* OVERSPRING */
		if (r165->spec_nr==89) { continue; }
		if (r165->spec_nr==199) { continue; }
		if (r165->spec_nr==645) { continue; }
		if (r165->spec_nr==646) { continue; }
		if (r165->spec_nr==647) { continue; }
		if (r165->spec_nr==648) { continue; }
		if (r165->spec_nr==649) { continue; }
		if (r165->spec_nr==650) { continue; }
		if (r165->spec_nr==651) { continue; }
		if (r165->spec_nr==656) { continue; }
		if (r165->spec_nr==657) { continue; }
/*
		if (pbilflag && r165->spec_nr==194) { continue; }
		if (pbilflag && r165->spec_nr==663) { continue; }
		if (pbilflag && r165->spec_nr==664) { continue; }
*/

		if (r165->spec_nr==667) { continue; }
/* NYT 121122 */
		if (r165->spec_nr==654) { continue; }
		if (r165->spec_nr==665) { continue; }
		if (r165->spec_nr==667) { continue; }
/* NYT 141021 641MAANED1000PRISLISTE */
		sprintf(tmpstr,"don%3.3hdonline",r165->spec_nr);
		if (r165->spec_nr==641 && access(tmpstr,0)!=0) {
			continue;
		}
		sprintf(tmpstr,"don%3.3hdonline",r165->spec_nr);
		if (r165->spec_nr==642 && access(tmpstr,0)!=0) {
			continue;
		}
		sprintf(tmpstr,"don%3.3hdonline",r165->spec_nr);
		if (r165->spec_nr==194 && access(tmpstr,0)!=0) {
			continue;
		}
		sprintf(tmpstr,"don%3.3hdonline",r165->spec_nr);
		if (r165->spec_nr==663 && access(tmpstr,0)!=0) {
			continue;
		}
		sprintf(tmpstr,"don%3.3hdonline",r165->spec_nr);
		if (r165->spec_nr==664 && access(tmpstr,0)!=0) {
			continue;
		}
/* NYT 150109 MAANEDPRISOFF */
		wx1 = 0;
		if (r165->spec_nr==641) { wx1++; }
		if (r165->spec_nr==642) { wx1++; }
		if (r165->spec_nr==194) { wx1++; }
		if (r165->spec_nr==663) { wx1++; }
		if (r165->spec_nr==664) { wx1++; }
		sprintf(tmpstr,"donlistmdpoff");
		if (wx1>0 && strcmp(ws_grp,"A")==0 && access(tmpstr,0)==0) {
			continue;
		}
		sprintf(tmpstr,"donlistmdvoff");
		if (wx1>0 && strcmp(ws_grp,"3")==0 && access(tmpstr,0)==0) {
			continue;
		}

		funkretur = 0;
		prisextra = 0;
                funkretur=find_r198(1,16503,(double)r165->spec_nr,"",0);
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisextra);
			}
			(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%ld", &klafh);
			}
			(void)get_alfa_tgn(r198->alfafelt,5,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%ld", &klafl);
			}
		}
		if (inpfunk==3 && prisextra>0) {
			continue;
		}
		funkretur=find_r198(1,16522,(double)r165->spec_nr,"",0);
		if (inpfunk==3 &&
			funkretur>0 && r198->numfelt>0 && aftaleflag==0) {
			continue;
		}
		funkretur = 0;

		alfalow(str);
		pack_init(str);
/* NYT 120817 */
		pack_int2((long)ws_station);

		pack_int2((long)r165->spec_nr);
		if (dkflag>0) {
			strcpy(tmpstr,r165->tekst_1);
		} else {
			sprintf(transstr, "%5.5ld%5.5hd",
				16507,r165->spec_nr);
			trans_tekst(langstr,0,transstr,tmpstr);
		}
/* NYT 121122 */
		if (dkflag>0 && r165->spec_nr==194) { tmpstr[7] = '\0'; }
		if (dkflag>0 && r165->spec_nr==663) { tmpstr[7] = '\0'; }
		if (dkflag>0 && r165->spec_nr==664) { tmpstr[7] = '\0'; }

		(void)stednavn_form(tmpstr);
		strcpy(returstr,"");
/* RETTET 130110
		if (dkflag>0) {
			sprintf(returstr," inkl. %ld km.",r165->incl_km);
		} else {
			sprintf(returstr," incl. %ld km.",r165->incl_km);
		}
*/
/* OBS klslet */
		strcat(tmpstr,returstr);
		pack_alfa(tmpstr);

/* specnr beskrivelse */
/*
		(void)f198_tekst(langstr,
			16501,(double)r165->spec_nr,"",0,tmpstr);
		pack_alfa(tmpstr);
*/
		ege_w_dou1 = r165->pris;
		if (logfil) {
			fprintf(logfil, "\t\tege_w_dou1=%.2lf\n",ege_w_dou1);
		}
/* NYT 121122 */
		antaldgn = 1;
/*
		if (r165->enhed>200 && r165->enhed<300) {
			antaldgn = (long int)r165->enhed;
			antaldgn -= 200;
		}
		if (r165->enhed>300 && r165->enhed<400) {
			antaldgn = (long int)r165->enhed;
			antaldgn -= 300;
			antaldgn *= 7;
		}
		if (r165->enhed>400 && r165->enhed<500) {
			antaldgn = (long int)r165->enhed;
			antaldgn -= 400;
			antaldgn *= 30;
		}
*/
		antalmdage = 1;
		if (r165->enhed>200 && r165->enhed<300) {
			antalmdage = (long int)r165->enhed;
			antalmdage -= 200;
		}
		if (r165->enhed>300 && r165->enhed<400) {
			antalmdage = (long int)r165->enhed;
			antalmdage -= 300;
			antalmdage *= 7;
		}
		if (r165->enhed>400 && r165->enhed<500) {
			antalmdage = (long int)r165->enhed;
			antalmdage -= 400;
			antalmdage *= 30;
		}

		if (logfil) {
			fprintf(logfil, "\t\tantaldgn=%ld\n",antaldgn);
			fprintf(logfil, "\t\tantalmdage=%ld\n",antalmdage);
		}
		ege_w_dou2 = 0;
		if (r165->incl_flag[1]>0 && antaldgn>0) {
/*
			ege_w_dou2 = (double)r165->rate_cdw;
			ege_w_dou2 *= (double)antaldgn;
*/
			udregn_cdipai_beloeb(r165->enhed,
				(short int)antaldgn,
				(double)r165->rate_cdw,
				&ege_w_dou2);
			ege_w_dou1 += ege_w_dou2;
		}
		if (logfil) {
			fprintf(logfil, "\t\tege_w_dou2=%.2lf\n",ege_w_dou2);
			fprintf(logfil, "\t\tege_w_dou1=%.2lf\n",ege_w_dou1);
		}
/* NYT 130225 PRISLISTEMBIDRAG */
		ege_w_dou2 = 0;
		if (strcmp(ws_grp,"3")==0 && antalmdage>0) {
			ege_w_dou2 = mbdag;
			ege_w_dou2 *= (double)antalmdage;
			if (ege_w_dou2>mbmax) {
				ege_w_dou2 = mbmax;
			}
/* MOMS */
			ege_w_dou2 *= 1.25;
			ege_w_dou1 += ege_w_dou2;
		}

		if (logfil) {
			fprintf(logfil, "\t\tege_w_dou2=%.2lf\n",ege_w_dou2);
			fprintf(logfil, "\t\tege_w_dou1=%.2lf\n",ege_w_dou1);
		}
		xls_char(tmpstr,(double)ege_w_dou1,2);
/* NYT 130304 TUSINDEKOMMA */
		if (ege_w_dou1>=1000 && ege_w_dou1<10000) {
			egeedit(ege_w_dou1,"z.zz9,99-",prisstr);
			prisstr[8] = '\0';
			strcpy(tmpstr,prisstr);
		}
		if (ege_w_dou1>=10000 && ege_w_dou1<100000) {
			egeedit(ege_w_dou1,"zz.zz9,99-",prisstr);
			prisstr[9] = '\0';
			strcpy(tmpstr,prisstr);
		}
		pack_alfa(tmpstr);
/* RETTET 121015 PRISKOMMA
		pack_doub(ege_w_dou1);
*/
		ege_w_dou1 = r165->ekstra_pr_km;
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);
/* RETTET 121015 PRISKOMMA
		pack_doub(ege_w_dou1);
*/
/* CategoryId */
		pack_alfa(r165->bil_grp);
/* CarType */
		(void)f198_tekst(langstr,
			16526,(double)0,r165->bil_grp,0,tmpstr);
		pack_alfa(tmpstr);
/* 120919 DefaultProductSelection */
		strcpy(tmpstr,"False");
		if (r165->spec_nr==180) {
			strcpy(tmpstr,"True");
		}
		pack_alfa(tmpstr);
/* NYT 121219 PRISLISTEEXTRAOPL 16503 */
		strcpy(tmpstr,"0800");
/* NYT 130304 WEEKENDVARETID1600 */
		if (r165->spec_nr==196 && strcmp(r165->bil_grp,"3")==0) {
			klafh = 1600;
		}
		if (klafh>0) {
			sprintf(tmpstr, "%4.4ld",klafh);
		}
		pack_alfa(tmpstr);
		strcpy(tmpstr,"0800");
		if (klafl>0) {
			sprintf(tmpstr, "%4.4ld",klafl);
		}
		pack_alfa(tmpstr);
		pack_int2((long)r165->incl_km);

		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
	}
	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}
	if (logfil) {
		fprintf(logfil, "send_genprisliste:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************ */
/* DONFUNK2 EXTRA			*/
static int send_genextprisliste(int inpfunk) {
	int retur = 0;
	short int wx1 = 0;
	short int okflag = 0;
	short int aftaleflag = 0;
	short int dkflag = 0;
	short int pbilflag = 0;
	short int funkretur = 0;
	short int prisextra = 0;
	short int station = 0;
	short int specnrukendt = 0;
	long int fradato = 0;
	long int tildato = 0;
	long int julian = 0;
	long int antaldgn = 1;
	long int firmakundenr = 0;
	long int firmaaftfra = 0;
	long int firmaafttil = 0;
	long int minantal = 0;
	long int maxantal = 0;
	char enhedstr[21] = "";
	char vlgtypestr[11] = "";
	char grp[11] = "";
	char transstr[21] = "";
	char returstr[81] = "";
	char tmpstr[101] = "";
	char prisstr[21] = "";
	char langstr[21] = "";
	double paipris = 0;
	double niv_pris;
	double niv_cdi;
        double niv_pai;
        double niv_km;
	long int inclkm;

	station = ws_station;
	strcpy(langstr,ws_langstr);
	if (strcmp(ws_langstr, "DK")==0 ||
		strcmp(ws_langstr,"DA")==0) {
		dkflag = 1;
	}
	if (strcmp(ws_grp, "A")==0) {
		pbilflag = 1;
	}
	if (logfil) {
		fprintf(logfil, "STARTsend_genextprisliste:inpfunk=%d\n",
			inpfunk);
		fprintf(logfil, "\tdkflag=%hd\n",dkflag);
		fprintf(logfil, "\tpbilflag=%hd\n",pbilflag);
		fflush(logfil);
	}
	reclow(r165, R165);
	f165_start(1, ISGTEQ);
	r165->stat_nr = station;
	r165->spec_nr = 180;
	strcpy(r165->bil_grp,"A");
	egeread(f165,ISEQUAL);
	if (f165_ok) {
		paipris = r165->rate_pai;
	}
	if (f165_ukendt) {
		paipris = 45;
	}
	if (logfil) {
		fprintf(logfil, "\tpaipris=%lf\n",paipris);
	}

	reclow(r165, R165);
	r165->stat_nr = station;
	r165->spec_nr = 900;
	f165_start(2, ISGTEQ);
	if (f165_ukendt) {
		okflag = -1;
	}
	if (logfil) {
		fprintf(logfil, "\tokflag=%hd\n",okflag);
		fflush(logfil);
	}
	while (okflag>=0) {
		egeread(f165, ISNEXT);
		if (f165_eof) {
			break;
		}
		if (logfil) {
			fprintf(logfil, "\t\tstat_nr=%hd\n",r165->stat_nr);
			fprintf(logfil, "\t\tspec_nr=%hd\n",r165->spec_nr);
			fprintf(logfil, "\t\tbil_grp=%s\n",r165->bil_grp);
			fflush(logfil);
		}
		if (r165->stat_nr!=station) {
			break;
		}
/*
		if (strcmp(r165->bil_grp,ws_grp)!=0) {
			continue;
		}
*/
		if (r165->slet_mark>0) {
			continue;
		}
		if (r165->spec_nr==901 && strcmp(ws_grp,"3")!=0) { continue; }
		if (r165->spec_nr==902 && strcmp(ws_grp,"3")!=0) { continue; }
		if (r165->spec_nr==903 && strcmp(ws_grp,"3")!=0) { continue; }
		if (r165->spec_nr==904 && strcmp(ws_grp,"3")!=0) { continue; }
/* RETTET 130225
		if (r165->spec_nr==901) { continue; }
		if (r165->spec_nr==902) { continue; }
		if (r165->spec_nr==903) { continue; }
		if (r165->spec_nr==904) { continue; }
*/
		if (r165->spec_nr==914) { continue; }
		if (r165->spec_nr==929) { continue; }
		if (r165->spec_nr==931) { continue; }
		if (r165->spec_nr>=935 && r165->spec_nr<=950) { continue; }
/* NYT 121122 */
		if (r165->spec_nr==981) { continue; }
		if (r165->spec_nr==982) { continue; }
		if (r165->spec_nr==983) { continue; }
		if (r165->spec_nr==984) { continue; }
/* NYT 140305 GENPRISJUST */
		if (r165->spec_nr==915) { continue; } /* extra nøgle */
		if (r165->spec_nr==924) { continue; } /* gps */
		if (r165->spec_nr==926) { continue; } /* extra nøgle */
		if (r165->spec_nr==954) { continue; } /* cleaning */
		if (r165->spec_nr==955) { continue; } /* cleaning */
		if (r165->spec_nr==956) { continue; } /* cleaning */
		if (r165->spec_nr==957) { continue; } /* cleaning */
/* NYT 140307 YOUNG997OFF */
		if (r165->spec_nr==997) { continue; } /* young */

		funkretur = 0;
		minantal = 0;
		maxantal = 10;

		strcpy(vlgtypestr,"DROPDOWN");

		if (r165->spec_nr==910) {
			maxantal = 1;
			strcpy(vlgtypestr,"CHECK");
		}
/* NYT 121022 */
		if (r165->spec_nr==901) {
			maxantal = 1;
			strcpy(vlgtypestr,"CHECK");
		}
/* NYT 121023 */
		if (r165->spec_nr==924) {
			maxantal = 1;
			strcpy(vlgtypestr,"CHECK");
		}
		if (r165->spec_nr==928) {
			maxantal = 1;
			strcpy(vlgtypestr,"CHECK");
		}

		if (r165->spec_nr==911) {
			maxantal = 1;
			strcpy(vlgtypestr,"CHECK");
		}
		if (r165->spec_nr==912) {
			maxantal = 1;
			strcpy(vlgtypestr,"CHECK");
		}
		if (r165->spec_nr==932) { maxantal = 5; }
		if (r165->spec_nr==933) { maxantal = 5; }
		if (r165->spec_nr==934) { maxantal = 5; }
/* NYT 131204 PSEXTRA */
		if (r165->spec_nr==905) { maxantal = 3; }
		if (r165->spec_nr==906) { maxantal = 3; }
		if (r165->spec_nr==907) { maxantal = 3; }

		alfalow(str);
		pack_init(str);
/* NYT 120817 */
		pack_int2((long)station);

		pack_int2((long)r165->spec_nr);
		if (dkflag>0) {
			strcpy(tmpstr,r165->tekst_1);
		} else {
			sprintf(transstr, "%5.5ld%5.5hd",
				16507,r165->spec_nr);
			trans_tekst(langstr,0,transstr,tmpstr);
		}
		if (r165->spec_nr==901) { strcpy(tmpstr,"Anhængertræk"); }
		if (r165->spec_nr==902) { strcpy(tmpstr,"Anhængertræk"); }
		if (r165->spec_nr==903) { strcpy(tmpstr,"Anhængertræk"); }
		if (r165->spec_nr==904) { strcpy(tmpstr,"Anhængertræk"); }
		if (r165->spec_nr==910) { strcpy(tmpstr,"Vinterdæk"); }
		if (r165->spec_nr==911) { strcpy(tmpstr,"Vinterdæk"); }
		if (r165->spec_nr==912) { strcpy(tmpstr,"Vinterdæk"); }
		if (r165->spec_nr==924) { strcpy(tmpstr,"GPS"); }
/* NYT 140514 DONSPECTEKSTER */
		if (r165->spec_nr==927) { strcpy(tmpstr,
			"Gebyr ved udeblivelse"); }

		if (r165->spec_nr==928) { strcpy(tmpstr,"Miljømærke"); }
/* NYT 140514 DONSPECTEKSTER */
		if (r165->spec_nr==967) { strcpy(tmpstr,"Indbygget navigation (gps)"); }
		if (r165->spec_nr==980) { strcpy(tmpstr,"Flyttekasse"); }
/* NYT 140307 CO996MAX180 */
		if (r165->spec_nr==996) {
			strcat(tmpstr," (max. kr. 180 pr. lejemål)");
		}
		pack_alfa(tmpstr);

		strcpy(enhedstr,"pr. stk.");
		if (r165->spec_nr==901) { strcpy(enhedstr,"pr. dag"); }
		if (r165->spec_nr==902) { strcpy(enhedstr,"pr. weekend"); }
		if (r165->spec_nr==903) { strcpy(enhedstr,"pr. uge"); }
		if (r165->spec_nr==904) { strcpy(enhedstr,"pr. måned"); }
		if (r165->spec_nr==910) { strcpy(enhedstr,"pr. dag"); }
		if (r165->spec_nr==911) { strcpy(enhedstr,"pr. uge"); }
		if (r165->spec_nr==912) { strcpy(enhedstr,"pr. måned"); }
		if (r165->spec_nr==924) { strcpy(enhedstr,"pr. dag"); }
/* NYT 140305 GENPRISJUST */
		if (r165->spec_nr==967) { strcpy(enhedstr,"pr. dag"); }
		if (r165->spec_nr==996) { strcpy(enhedstr,"pr. dag"); }
/* NYT 131204 PSEXTRA */
		if (r165->spec_nr==905) { strcpy(enhedstr,"pr. stk. pr. dag"); }
		if (r165->spec_nr==906) { strcpy(enhedstr,"pr. stk. pr. dag"); }
		if (r165->spec_nr==907) { strcpy(enhedstr,"pr. stk. pr. dag"); }
		if (r165->spec_nr==908) { strcpy(enhedstr,"pr. stk. pr. dag"); }
		if (r165->spec_nr==932) { strcpy(enhedstr,"pr. stk. pr. dag"); }
		if (r165->spec_nr==933) { strcpy(enhedstr,"pr. stk. pr. dag"); }
		if (r165->spec_nr==934) { strcpy(enhedstr,"pr. stk. pr. dag"); }
		pack_alfa(enhedstr);

		ege_w_dou1 = r165->pris;
/* NYT 140305 GENPRISJUST MOMS */
		if (r165->incl_flag[3]==0) {
			ege_w_dou1 *= 1.25;
		}

		xls_char(tmpstr,(double)ege_w_dou1,2);
/* NYT 130304 TUSINDEKOMMA */
		if (ege_w_dou1>=1000 && ege_w_dou1<10000) {
			egeedit(ege_w_dou1,"z.zz9,99-",prisstr);
			prisstr[8] = '\0';
			strcpy(tmpstr,prisstr);
		}
		if (ege_w_dou1>=10000 && ege_w_dou1<100000) {
			egeedit(ege_w_dou1,"zz.zz9,99-",prisstr);
			prisstr[9] = '\0';
			strcpy(tmpstr,prisstr);
		}
		pack_alfa(tmpstr);
/* RETTET 121015 PRISKOMMA
		pack_doub(ege_w_dou1);
*/
		pack_alfa(r165->bil_grp);

		strcpy(tmpstr,"extra");
		pack_alfa(tmpstr);

		pack_alfa(vlgtypestr);
		sprintf(tmpstr,"%ld",minantal);
		pack_alfa(tmpstr);
		sprintf(tmpstr,"%ld",maxantal);
		pack_alfa(tmpstr);

		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
/* NYT 130304 FLYTTEKASSEX10 */
		if (r165->spec_nr==980) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)station);

			pack_int2((long)r165->spec_nr);
			strcpy(tmpstr,"Flyttekasse");
			pack_alfa(tmpstr);
			strcpy(enhedstr,"10 stk.");
			pack_alfa(enhedstr);

			ege_w_dou1 = 250;
/* NYT 140828 FLYTTEKASSEX10RETTELSE */
			ege_w_dou1 = 288;
			xls_char(tmpstr,(double)ege_w_dou1,2);
			pack_alfa(tmpstr);

			pack_alfa(r165->bil_grp);

			strcpy(tmpstr,"extra");
			pack_alfa(tmpstr);

			pack_alfa(vlgtypestr);
			sprintf(tmpstr,"%ld",minantal);
			pack_alfa(tmpstr);
			sprintf(tmpstr,"%ld",maxantal);
			pack_alfa(tmpstr);

			pack_exchkend();
			send_linie();
			if (logfil) {
				fprintf(logfil, "SENDT:str=%s", str);
				fflush(logfil);
			}
			retur++;
		}
	}


/* OGSÅ DET KEDELIGE */
/* PAI 918 */
	r165->spec_nr = 918;
	strcpy(r165->tekst_1,"Person- og godsforsikring");
	strcpy(r165->bil_grp,"ALLE");
	r165->pris = 35;
/* NYT 140305 GENPRISJUST */
	r165->pris = paipris;

	strcpy(enhedstr,"pr. dag");
	strcpy(vlgtypestr,"RADIOJANEJ");
	minantal = 0;
	maxantal = 1;
	alfalow(str);
	pack_init(str);
/* NYT 120927 */
	pack_int2((long)station);
	strcpy(tmpstr,"PAI");
	pack_alfa(tmpstr);
/* RETTET 120927
	pack_int2((long)r165->spec_nr);
*/
	if (dkflag>0) {
		strcpy(tmpstr,r165->tekst_1);
	} else {
		strcpy(tmpstr,"PAI");
/* OBS ENG
		sprintf(transstr, "%5.5ld%5.5hd",
			16507,r165->spec_nr);
		trans_tekst(langstr,0,transstr,tmpstr);
*/
	}
	pack_alfa(tmpstr);

	pack_alfa(enhedstr);

	ege_w_dou1 = r165->pris;
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
/* RETTET 121015 PRISKOMMA
	pack_doub(ege_w_dou1);
*/
	pack_alfa(r165->bil_grp);

	strcpy(tmpstr,"extra");
	pack_alfa(tmpstr);

	pack_alfa(vlgtypestr);
	sprintf(tmpstr,"%ld",minantal);
	pack_alfa(tmpstr);
	sprintf(tmpstr,"%ld",maxantal);
	pack_alfa(tmpstr);

	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	retur++;
/* CO-DRIVER 996 */
/* NYT 140305 CO996EJGRATIS */
	specnrukendt = 0;
	r165->spec_nr = 996;
	r165->stat_nr = station;
	strcpy(r165->bil_grp,"ALLE");
	egeread(f165,ISEQUAL);
	if (f165_ukendt) {
		specnrukendt = 1;
	}
/* */
	r165->spec_nr = 996;
	strcpy(r165->tekst_1,"Medlejer");
	strcpy(r165->bil_grp,"ALLE");
/* RETTET 140305 CO996EJGRATIS
	r165->pris = 0;
*/
	strcpy(enhedstr,"pr. stk.");
	strcpy(vlgtypestr,"RADIOJANEJ");
	minantal = 0;
	maxantal = 1;
	alfalow(str);
	pack_init(str);
/* NYT 120927 */
	pack_int2((long)station);
	pack_int2((long)r165->spec_nr);
	if (dkflag>0) {
		strcpy(tmpstr,r165->tekst_1);
	} else {
		sprintf(transstr, "%5.5ld%5.5hd",
			16507,r165->spec_nr);
		trans_tekst(langstr,0,transstr,tmpstr);
	}
	pack_alfa(tmpstr);

	pack_alfa(enhedstr);

	ege_w_dou1 = r165->pris;
	xls_char(tmpstr,(double)ege_w_dou1,2);
/* RETTET 140305 CO996EJGRATIS
	if (specnrukendt>0) {
		strcpy(tmpstr,"?");
	}
*/
	pack_alfa(tmpstr);
/* RETTET 121015 PRISKOMMA
	pack_doub(ege_w_dou1);
*/
	pack_alfa(r165->bil_grp);

	strcpy(tmpstr,"extra");
	pack_alfa(tmpstr);

	pack_alfa(vlgtypestr);
	sprintf(tmpstr,"%ld",minantal);
	pack_alfa(tmpstr);
	sprintf(tmpstr,"%ld",maxantal);
	pack_alfa(tmpstr);

	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	retur++;

	if (logfil) {
		fprintf(logfil, "send_genextprisliste:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* *************************************** */
/* DON2SNYD */
static int don2snyd(char * inppara) {
	int retur = 0;
	char returstr[81] = "";
	char tmpstr[1001] = "";
	FILE * tmpfil;

	tmpfil = (FILE*)0;
	if (logfil) {
		fprintf(logfil,"don2snyd:inppara=%s\n",inppara);
		fflush(logfil);
	}
	sprintf(tmpstr,"%sdon2snyd.%s",ws_kreds,inppara);
	tmpfil = fopen(tmpstr,"r");
	if (!tmpfil) {
		tmpfil = (FILE*)0;
	}
	while (retur>=0 && tmpfil) {
		if (!fgets(tmpstr,1000,tmpfil)) {
                        break;
                }
                if (strlen(tmpstr)) {
                        tmpstr[strlen(tmpstr)-1] = '\0';
                }
		if (!strlen(tmpstr)) {
			break;
		}
		retur += send_don2snyd_linie(tmpstr,59);
	}
	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}
	if (logfil) {
		fprintf(logfil,"don2snyd:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* *************************************** */
static int send_don2snyd_linie(char *inpstr,int sktgn) {
	int retur = 0;
	int nuvidx = 0;
	int maxidx = 0;
	char returstr[201] = "";

	while (nuvidx<strlen(inpstr)) {
		if (inpstr[nuvidx]==sktgn) {
			maxidx++;
		}
		nuvidx++;
	}
	if (logfil) {
		fprintf(logfil,"send_don2snyd_linie:%s sktgn=%d maxidx=%d\n",
			inpstr,sktgn,maxidx);
		fflush(logfil);
	}
	if (maxidx<=0) {
		return(0);
	}
	nuvidx = 0;
	alfalow(str);
	pack_init(str);
	while (maxidx>0 && nuvidx<maxidx) {
		(void)get_alfa_tgn(inpstr,nuvidx,returstr,sktgn);
		pack_alfa(returstr);
		nuvidx++;
	}
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	retur = 1;
	return(retur);
}

/* ************ */
static void konv_f159_f198(funk)
short int funk; {
	int antal = 0;
	long kode = 0;
	double keynum = 0;
	char tmpstr[41];

	reclow(r198, R198);
	f198_start(1, ISGTEQ);

	reclow(r159, R159);
	r159->record_x = 6600001;
	f159_start(1, ISGTEQ);
	if (f159_ukendt) {
		antal = -1;
	}
	while (antal>=0) {
		egeread(f159, ISNEXT);
		if (f159_eof) {
			break;
		}
		if (r159->record_x>6699999) {
			break;
		}
		reclow(r198, R198);
		kode = 15900;
		kode += (long int)r159->kontrakttype_kode;
		keynum = (double)r159->record_x;

		strcpy(r198->alfafelt,r159->bil_grp);
		if (kode==15901 || kode==15902) {
			strcpy(r198->alfafelt,r159->bil_reg_nr);
		}
		if (!strlen(r198->alfafelt)) {
			continue;
		}

		r198->numfelt = r159->station_ud_nr;

		r198->fradato = r159->dato_ud;
		r198->tildato = r159->dato_ind;
		r198->fratid = (short int)r159->tid_ud;
		r198->tiltid = (short int)r159->tid_ind;

		if (r159->status==2 || r159->status==10) {
			r198->fradato = r159->dato_ud;
			r198->tildato = r159->forv_dato_ind;
			r198->fratid = (short int)r159->tid_ud;
			r198->tiltid = (short int)r159->forv_tid_ind;
		}
		if (r198->tildato==0) {
			r198->tildato = 99999999;
		}

		r198->status = r159->status;

		(void)opdat_r198(kode,(double)keynum,"",0);
/* TEST */
		sprintf(dum_str, "%5d %8ld konv", antal, r159->record_x);
		logfil_put(dum_str);

		antal++;
	}
	alfalow(str);
	pack_init(str);
	sprintf(tmpstr, "%d records konverteret", antal);
	pack_alfa(tmpstr);
	pack_exchkend();
	send_linie();
	return;
}

/* ********************* */
static int find_statresmin(short stnr) {
	short int retur = 0;

	if (logfil) {
		fprintf(logfil,"find_statresmin:st=%hd\n",stnr);
	}
	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16607;
	r198->keynum = (double)stnr;
	egeread(f198,ISEQUAL);
	if (f198_ok) {
		ws_statresmin = (short int)r198->numfelt;
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"find_statresmin:retur=%hd ws_statresmin=%hd\n",
			retur,
			ws_statresmin);
		fflush(logfil);
	}
	return(retur);
}

/* ******************** */
static int check_ressourcer(funk,st,grp,spc,extspc,inpfradt,inptildt)
short int funk;
short int st;
char * grp;
short int spc;
char * extspc;
long int inpfradt;
long int inptildt; {
	short int testflag  = 0;
	short int detail  = 0;
	int retur = 0;
	int kap_antal = 0;
	int dgantal = 0;
	int aabenflag = 0;
	long int fradato = 0;
	long int tildato = 0;
	long int nuvdato;
	long int julian;
	long int leas_antal = 0;
	long int blok_antal = 0;
	long int kon_antal = 0;
	long int res_antal = 0;
	long int maxkap = 999;
	char grptab[2][5] = {"",""};

	if (strcmp(ws_menuid, "zt")==0) {
		testflag = 1;
	}
	if (logfil) {
		fprintf(logfil,
"check_ressourcer:funk=%hd,st=%hd inpfra-til=%ld-%ld grp=%s spc=%hd extspc=%s tstflg=%hd\n",
		funk,
		st,
		inpfradt,
		inptildt,
		grp,
		spc,
		extspc,
		testflag);
		fprintf(logfil, "check_ressourcer:ege_pid=%hd\n", ege_pid);
		fflush(logfil);
	}

	if (inpfradt>0 && inptildt>365) {
		fradato = inpfradt;
		tildato = inptildt;
	}
	if (inpfradt>0 && inptildt>0 && inptildt<=365) {
		fradato = inpfradt;
		dgantal = (int)inptildt;
		julian = m036_funktion(12, fradato);
		julian += (long int)dgantal;
		tildato = m036_funktion(19, julian);
	}
	if (inpfradt>0 && inptildt==0 && spc>0) {
		fradato = inpfradt;
		dgantal = beregn_varighed(st,grp,spc,extspc);
/* OBS 081217 KOMPENSATION WEEKEND
		if (weekend_komp(st,grp,spc,extspc)>0) {
			dgantal++;
		}
*/
		julian = m036_funktion(12, fradato);
		julian += (long int)dgantal;
		tildato = m036_funktion(19, julian);
	}
	if (inpfradt>0 && inptildt==0 && spc==0) {
		fradato = inpfradt;
		tildato = fradato;
	}
	if (logfil) {
		fprintf(logfil,
			"check_ressourcer:fradato=%ld tildato=%ld dgantal=%d\n",
			fradato,
			tildato,
			dgantal);
		fflush(logfil);
	}
	if (fradato==0 || tildato==0) {
		return(-999);
	}
	if (fradato>tildato) {
		return(-999);
	}
/* NYT 141028 PRODUKTVALGLUKKET */
	strcpy(ws_alert_txt,"");
	if (funk==2 && ws_funktion==10 && ws_brandtype==3) {
		aabenflag = check_bssaaben(-1,st,tildato,ws_tiltid);
	}
	if (logfil) {
		fprintf(logfil, "\taabenflag=%d ws_alert_txt=%s\n",
			aabenflag,
			ws_alert_txt);
	}
	if (funk==2 && ws_funktion==10 && ws_brandtype==3 && aabenflag<=0) {
		retur = -999;
		goto afslut;
	}

	strcpy(grptab[0], grp);
	strcpy(grptab[1], grp);
	if (strcmp(grp,"A")==0) {
		strcpy(grptab[0], "A");
		strcpy(grptab[1], "Z");
	}
	if (strcmp(grp,"3")==0) {
		strcpy(grptab[0], "3");
		strcpy(grptab[1], "3");
	}
/* RETTET 090705
	if (strcmp(grp,"3")==0) {
		strcpy(grptab[0], "0");
		strcpy(grptab[1], "9");
	}
*/
	sprintf(dum_str,
		"check_ressourcer:st=%hd fra-til=%ld-%ld grptab=%s-%s",
		st,
		fradato,
		tildato,
		grptab[0],
		grptab[1]);
	logfil_put(dum_str);
/* NYT 081009 */
/* TEST
        leas_antal = check_f168leas(st,
                "",
                fradato,
                tildato,
                grptab[0],
                grptab[1]);
	sprintf(dum_str,
		"check_ressourcer:leas_antal=%ld",
		leas_antal);
	logfil_put(dum_str);
*/

/* NYT 150109 FRI30DAGE */
	if (funk==2 && strcmp(grp,"A")==0 &&
		dgantal>=30 &&
		access("don2fri30p",0)==0) {
		retur = 100;
		goto afslut;
	}
	if (funk==2 && strcmp(grp,"3")==0 &&
		dgantal>=30 &&
		access("don2fri30v",0)==0) {
		retur = 100;
		goto afslut;
	}

/* NYT 140618 FRI5DAGE */
	if (funk==2 && strcmp(grp,"A")==0 &&
		dgantal>=5 &&
		access("don2fri5p",0)==0) {
		retur = 100;
		goto afslut;
	}

/* NYT 130626 FRI7DAGE */
	if (funk==2 && strcmp(grp,"A")==0 &&
		dgantal>=7 &&
		access("don2fri7p",0)==0) {
		retur = 100;
		goto afslut;
	}
	if (funk==2 && strcmp(grp,"3")==0 &&
		dgantal>=7 &&
		access("don2fri7v",0)==0) {
		retur = 100;
		goto afslut;
	}
/* NYT 130923 FRI1DAG */
	if (funk==2 && strcmp(grp,"A")==0 &&
		dgantal>=1 &&
		access("don2fri1p",0)==0) {
		retur = 100;
		goto afslut;
	}
	if (funk==2 && strcmp(grp,"3")==0 &&
		dgantal>=1 &&
		access("don2fri1v",0)==0) {
		retur = 100;
		goto afslut;
	}

	if (funk==1) {
		kap_antal = check_f168kap(detail,
			(short int)(1000+st),
			fradato,
			tildato,
			grptab[0],
			grptab[1],
			&blok_antal,
			&kon_antal,
			&res_antal);
		sprintf(dum_str,
		"check_ressourcer:%ld-%ld kap=%d blok=%ld kon=%ld res=%ld",
			fradato,
			tildato,
			kap_antal,
			blok_antal,
			kon_antal,
			res_antal);
		logfil_put(dum_str);
		retur = kap_antal;
		retur -= blok_antal;
		retur -= kon_antal;
		retur -= res_antal;
	}
	if (funk==2) {
		kap_antal = check_flaadekap((short int)(1000+st),
			fradato,
			tildato,
			grptab[0],
			grptab[1],
			&blok_antal,
			&res_antal);
		sprintf(dum_str,
		"check_ressourcer:%ld-%ld kap=%d dato=%ld tid=%ld",
			fradato,
			tildato,
			kap_antal,
			blok_antal,
			res_antal);
		logfil_put(dum_str);
		retur = kap_antal;
	}
#ifdef egetest
	if (funk==2 && !testflag) {
		nuvdato = fradato;
		julian = m036_funktion(12, fradato);
	}
	while (funk==2 && !testflag && nuvdato<tildato) {
		kap_antal = check_f168kap(detail,
			(short int)(1000+st),
			nuvdato,
			nuvdato,
			grptab[0],
			grptab[1],
			&blok_antal,
			&kon_antal,
			&res_antal);
		sprintf(dum_str,
		"check_ressourcer:%ld-%ld kap=%d blok=%ld kon=%ld res=%ld",
		nuvdato,
		nuvdato,
		kap_antal,
		blok_antal,
		kon_antal,
		res_antal);
		logfil_put(dum_str);
		kap_antal -= blok_antal;
		kap_antal -= kon_antal;
		kap_antal -= res_antal;
		if (kap_antal<maxkap) {
			maxkap = kap_antal;
		}
		julian++;
		nuvdato = m036_funktion(19, julian);
	}
	if (funk==2 && !testflag) {
		retur = (int)maxkap;
	}
#endif
afslut:
	if (logfil) {
		fprintf(logfil, "check_ressourcer:retur=%d\n",
			retur);
	}
/*
	sprintf(dum_str, "check_ressourcer:retur=%d",
		retur);
	logfil_put(dum_str);
*/
	return(retur);
}

/* **************************************************** */
static long int find_ledigdato(funk,st,grp,spc,extspc,startdato)
short int funk;
short int st;
char * grp;
short int spc;
char * extspc;
long int startdato; {
	int antal = 0;
	long int returdato = 0;
	short int funkretur  = 0;
	short int detail  = 0;
	int dgantal = 0;
	long int fradato = startdato;
	long int tildato = 0;
	long int julian = 0;
	long int frajulian = 0;
	int kap_antal = 0;
	long int blok_antal = 0;
	long int kon_antal = 0;
	long int res_antal = 0;
	long int fridato = 0;
	long int fritid = 0;
	long int fratid = 0;
	long int tiltid = 0;

	dgantal = beregn_varighed(st,grp,spc,extspc);
/* NYT 040331 */
	(void)find_tid_fra_til(st,grp,spc,extspc,&fratid,&tiltid);
	funkretur = find_next_fri(st,
			ws_systemdato,
			fratid,
			tiltid,
			(short int)dgantal,
			grp,
			&fridato,
			&fritid);
	sprintf(dum_str,
		"find_ledigdato:find_next_fri=%hd dato=%ld tid=%ld",
		funkretur,
		fridato,
		fritid);
        logfil_put(dum_str);
	frajulian = m036_funktion(12, fradato);
	julian = frajulian;
	julian += (long int)dgantal;
	tildato = m036_funktion(19, julian);
	sprintf(dum_str, "find_ledigdato:funk=%hd dgantal=%d",
		funk,
		dgantal);
	logfil_put(dum_str);
	while (returdato==0) {
		sprintf(dum_str, "find_ledigdato:fra-til=%ld-%ld",
			fradato,
			tildato);
		logfil_put(dum_str);
		kap_antal = check_f168kap(detail,
			(short int)(1000+st),
			fradato,
			tildato,
			grp,
			grp,
			&blok_antal,
			&kon_antal,
			&res_antal);
		kap_antal -= (int)blok_antal;
		kap_antal -= (int)kon_antal;
		kap_antal -= (int)res_antal;
		if (kap_antal>0) {
			returdato = fradato;
			break;
		}
		antal++;
		if (antal>365) {
			break;
		}
		frajulian++;
		fradato = m036_funktion(19, frajulian);
		julian = frajulian;
		julian += (long int)dgantal;
		tildato = m036_funktion(19, julian);
	}
	return((long int)returdato);
}

/* NYT 130508 UDSOLGT */
/* ************************************************************ */
static int find_dato_udsolgt() {
	short int st = 0;
	int retur = 0;
	short int detail  = 0;
	long int returdato = 0;
	long int fradato = 0;
	long int tildato = 0;
	long int julian = 0;
	long int frajulian = 0;
	long int tiljulian = 0;
	int kap_antal = 0;
	long int blok_antal = 0;
	long int kon_antal = 0;
	long int res_antal = 0;
	char grp[11] = "";
	char datostr[11] = "";

	st = ws_station;
	strcpy(grp,ws_grp);
	fradato = ws_fradato;
	tildato = ws_tildato;
	if (logfil) {
		fprintf(logfil,"find_dato_udsolgt\n");
		fprintf(logfil,"\tfradato=%ld\n",fradato);
		fprintf(logfil,"\ttildato=%ld\n",tildato);
		fprintf(logfil,"\tws_tiltid=%ld\n",ws_tiltid);
		fprintf(logfil,"\tst=%hd\n",st);
		fprintf(logfil,"\tgrp=%s\n",grp);
		fprintf(logfil,"\tUDSOLGTDGPRE=%d\n",(int)UDSOLGTDGPRE);
		fprintf(logfil,"\tUDSOLGTDGPOST=%d\n",(int)UDSOLGTDGPOST);
	}
	frajulian = m036_funktion(12, fradato);
/* NYT 130514 */
	frajulian -= UDSOLGTDGPRE;
	tiljulian = m036_funktion(12, tildato);
	if (ws_tiltid>=900) {
		tiljulian++;
	}
	tiljulian += UDSOLGTDGPOST;
	julian = frajulian;
	returdato = m036_funktion(19, julian);
	while (julian<tiljulian) {
		if (logfil) {
			fprintf(logfil,"\t\tjulian=%ld\n",julian);
			fprintf(logfil,"\t\treturdato=%ld\n",returdato);
		}
		kap_antal = check_f168kap(detail,
			(short int)(1000+st),
			returdato,
			returdato,
			grp,
			grp,
			&blok_antal,
			&kon_antal,
			&res_antal);
		kap_antal -= (int)blok_antal;
		kap_antal -= (int)kon_antal;
		kap_antal -= (int)res_antal;
		if (logfil) {
			fprintf(logfil,"\t\tUDSOLGTKAP%ld kap_antal=%d\n",
				returdato,
				kap_antal);
		}
		if (kap_antal<=0) {
			ege_w_int1 = m036_funktion(17,returdato);
			egeedit(ege_w_dou1=ege_w_int1,"99.99.9999",datostr);
			datostr[2] = '/';
			datostr[5] = '\0';
			if (retur==0) {
				strcat(ws_udsolgtstr," ");
			}
			if (retur>0) {
				strcat(ws_udsolgtstr,", ");
			}
/* RETTET 130604 UDSOLGTKOMMA
			strcat(ws_udsolgtstr," ");
*/
			strcat(ws_udsolgtstr,datostr);
			retur++;
		}
/*
		if (kap_antal>0) {
			returdato = fradato;
			break;
		}
		antal++;
		if (antal>365) {
			break;
		}
*/
		julian++;
		returdato = m036_funktion(19, julian);
	}
	if (logfil) {
		fprintf(logfil,"find_dato_udsolgt retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ******************** */
static void send_dato_tider(funk,langstr,station,dato)
short int funk;
char * langstr;
short int station;
long int dato; {
	short int okflag = 1;
	short int funkretur = 0;
	long int frakl = 0;
	long int tilkl = 0;
	long int nuvkl = 0;
	long int fradato = 0;
	long int tildato = 0;
	char tmpstr[41];

	alfalow(str);
	pack_init(str);
/*
	pack_del();
*/
	funkretur = check_bssaaben(-1,station,dato,-1);
	if (funkretur<=0 && check_tilbud(station,dato,tmpstr)>0) {
		pack_int2((long)-2);
		sscanf(tmpstr, "%ld %ld", &fradato,&tildato);
		pack_int2((long)fradato);
		pack_int2((long)tildato);
		pack_exchkend();
		send_linie();
		return;
	}
	if (funkretur<=0) {
		pack_int2((long)-1);
		pack_exchkend();
		send_linie();
		return;
	}
	pack_int2((long)0);
	(void)get_alfa_tgn(ws_alert_txt,0,tmpstr,';');
	if (strlen(tmpstr)) {
		sscanf(tmpstr, "%ld", &frakl);
	}
	(void)get_alfa_tgn(ws_alert_txt,1,tmpstr,';');
	if (strlen(tmpstr)) {
		sscanf(tmpstr, "%ld", &tilkl);
	}
	for (nuvkl=frakl;nuvkl<=tilkl;nuvkl+=100) {
		sprintf(tmpstr, "%2.2ld:%2.2ld",
			nuvkl/100,
			nuvkl%100);
		pack_alfa(tmpstr);
	}
	pack_exchkend();
	send_linie();
	return;
}

/* ************************************ */
static int check_donmaaned() {
	int retur = 0;
	long int varighed = 0;
	long int julian = 0;

	if (logfil) {
		fprintf(logfil,"check_donmaaned\n");
	}
	julian = m036_funktion(12, ws_kundedtfra);
	varighed = (long int)(m036_funktion(12, ws_kundedttil)-julian);
	if (logfil) {
		fprintf(logfil,"\tvarighed=%ld\n",varighed);
	}
	if (varighed>=30) { retur = 1; }
	if (access("donstp2mdfejl",0)!=0) {
		retur = 0;
		goto afslut;
	}
afslut:
	if (logfil) {
		fprintf(logfil,"check_donmaaned retur=%d\n",retur);
	}
	return(retur);
}

/* ************************************ */
static int check_donweboffline(short funk) {
	short int retur = 0;
	FILE * offllog;

	offllog = (FILE*)0;

/* TEST */
	sprintf(dum_str, "check_donweboffline:funk=%hd",funk);
        logfil_put(dum_str);
	if (access("donweboffline",0)==0) {
		retur = 1;
	}
	if (access("bsslokal",0)==0) {
		retur = 1;
	}

/* TEST */
	sprintf(dum_str, "check_donweboffline:retur=%hd",retur);
        logfil_put(dum_str);
/* NYT 090423 */
	if (retur>0) {
		offllog = fopen("donweboffl.log","a");
	}
	if (retur>0 && offllog) {
		fprintf(offllog,"%8.8ld %4.4ld %hd %s\n",
			ws_systemdato,
			ws_systemtid,
			ws_funktion,
			ws_booktype);
		fclose(offllog);
		offllog = (FILE*)0;
	}
	return(retur);
}

/* ************************************ */
static int check_ecweboffline(short funk) {
	short int retur = 0;
	FILE * offllog;

	offllog = (FILE*)0;
/* TEST */
	sprintf(dum_str, "check_ecweboffline:funk=%hd",funk);
        logfil_put(dum_str);
	if (access("ecweboffline",0)==0) {
		retur = 1;
	}
	if (access("bsslokal",0)==0) {
		retur = 1;
	}

/* TEST */
	sprintf(dum_str, "check_ecweboffline:retur=%hd",retur);
        logfil_put(dum_str);
/* NYT 090423 */
	if (retur>0) {
		offllog = fopen("ecweboffl.log","a");
	}
	if (retur>0 && offllog) {
		fprintf(offllog,"%8.8ld %4.4ld %hd %s\n",
			ws_systemdato,
			ws_systemtid,
			ws_funktion,
			ws_booktype);

		fclose(offllog);
		offllog = (FILE*)0;
	}
	return(retur);
}

/* ************************************ */
static int ecweb_booktype_liste() {
	short int retur = 0;


	alfalow(str);
	pack_init(str);
	pack_alfa("ECBook");
	pack_exchkend();
	send_linie();
	retur++;

	alfalow(str);
	pack_init(str);
	pack_alfa("ECVLPris");
	pack_exchkend();
	send_linie();
	retur++;

	alfalow(str);
	pack_init(str);
	pack_alfa("PSBook");
	pack_exchkend();
	send_linie();
	retur++;

	alfalow(str);
	pack_init(str);
	pack_alfa("DONBook");
	pack_exchkend();
	send_linie();
	retur++;

/* 090224 UDLBOOK */
	alfalow(str);
	pack_init(str);
	pack_alfa("ECUDLBook");
	pack_exchkend();
	send_linie();
	retur++;

/* NYT 120413 TXBCBOOK */
	alfalow(str);
	pack_init(str);
	pack_alfa("TXUDLBook");
	pack_exchkend();
	send_linie();
	retur++;
	alfalow(str);
	pack_init(str);
	pack_alfa("BCUDLBook");
	pack_exchkend();
	send_linie();
	retur++;

	return(retur);
}

/* ************************************************** */
static int ecweb_aftalecheck() {
	short int retur = 0;
	char returtxt[81] = "";

	alfalow(str);
	pack_init(str);
/* OBS */
	if (ws_aftalenr==12345678) {
		pack_int2((long)1);
		pack_alfa("firmanavn");
		pack_alfa("firmaadr");
		pack_alfa("firmapostnr");
		pack_alfa("firmaby");
		pack_alfa("firmatlf");
		pack_alfa("firmaaftaleoverskrift");
		pack_int2((long)0);
		pack_int2((long)0);
		retur++;
	}
	if (ws_aftalenr==87654321) {
		pack_int2((long)1);
		pack_alfa("firma2navn");
		pack_alfa("firma2adr");
		pack_alfa("firma2postnr");
		pack_alfa("firma2by");
		pack_alfa("firma2tlf");
		pack_alfa("firma2aftaleoverskrift");
		pack_int2((long)1);
		pack_int2((long)1);
		retur++;
	}
	if (retur==0) {
		strcpy(returtxt,"UKENDT");
		pack_int2((long)0);
/* NYT 061116 */
		if (strcmp(ws_langstr,"DA")==0) {
			strcpy(returtxt,"Angiv korrekt aftalenummer");
		}
		pack_alfa(returtxt);
	}
	pack_exchkend();
	send_linie();
	return(retur);
}

/* ************************************ */
static int ecweb_check_bilgrp(char *grp,char *type) {
	short int retur = 1;
	short int idx = 1;
	char tmpstr[41] = "";
	char returstr[41] = "";

	strcpy(type,"");
	if (grp[0]>=48 && grp[0]<=57) {
		retur = 2;
	}
	if (grp[0]=='I') {
		retur = 3;
	}
	if (grp[0]=='J') {
		retur = 3;
	}
	idx = 1;
	while (idx>=1 && retur==1) {
		strcpy(returstr,"P7911EC");
		sprintf(tmpstr,"BssPrisPersGrp%3.3hd=",idx);
                if (retur_f198_def((long int)1002,tmpstr,returstr)<=0) {
                        break;
                }
		if (strcmp(grp,returstr)==0) {
			retur = 4;
		}
		idx++;
	}

	if (retur==2) {
		strcpy(type,"VARE");
	}
	if (retur==3) {
		strcpy(type,"BUS");
	}
	if (retur==4) {
		strcpy(type,"PERS");
	}
	return(retur);
}

/* ************************************ */
static int ecweb_check_biltype(short stnr,char *grp,char *type,short uddgnr,short varighed,char * returstr,char *ret2str,char *ret3str) {
	short int retur = 0;
	short int nuvstnr = 0;
	short int fundet = 0;
	short int nivchk = 0;
	short int nivinit = 0;
	short int dgvarighed = 0;
	short int dginterval[2] = {1,7};
	char tmpstr[41] = "";
	char chkstr[41] = "";

	strcpy(returstr,"");
	reclow(r198,R198);
	r198->oplkode = 16628;
	r198->keynum = (double)nuvstnr;
	strcpy(r198->keyalfa,type);
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		nivinit = 1;
	}
	while (retur>=0 && nivchk<=1) {
		if (nivinit==1) {
			nivinit = 0;
			nivchk++;
			if (nivchk>1) {
				break;
			}
			if (nivchk==1) {
				nuvstnr = stnr;
				r198->oplkode = 16628;
				r198->keynum = (double)nuvstnr;
				strcpy(r198->keyalfa,type);
			}
			f198_start(1,ISGTEQ);
			if (f198_ukendt) {
				nivinit = 1;
				continue;
			}
		}
		egeread(f198,ISNEXT);
		if (f198_eof) {
			nivinit = 1;
			continue;
		}
		if (r198->oplkode!=16628) {
			nivinit = 1;
			continue;
		}
		if (r198->keynum!=(double)nuvstnr) {
			nivinit = 1;
			continue;
		}
		if (strcmp(r198->keyalfa,type)!=0) {
			nivinit = 1;
			continue;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		dginterval[0] = 1;
		dginterval[1] = 7;
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		strcpy(chkstr,"");
		if (strlen(tmpstr)) {
			(void)get_alfa_tgn(tmpstr,0,chkstr,45);
		}
		if (strlen(chkstr)) {
			sscanf(chkstr,"%hd",&dginterval[0]);
		}
		strcpy(chkstr,"");
		if (strlen(tmpstr)) {
			(void)get_alfa_tgn(tmpstr,1,chkstr,45);
		}
		if (strlen(chkstr)) {
			sscanf(chkstr,"%hd",&dginterval[1]);
		}
		if (uddgnr>dginterval[1]) {
			continue;
		}
		if (uddgnr<dginterval[0]) {
			continue;
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&dgvarighed);
		}
		if (varighed!=dgvarighed) {
			continue;
		}
		(void)get_alfa_tgn(r198->alfafelt,2,returstr,';');
		(void)get_alfa_tgn(r198->alfafelt,3,ret2str,';');
		(void)get_alfa_tgn(r198->alfafelt,4,ret3str,';');
		fundet++;
	}
	return(retur);
}

/* ************************************************ */
static void send_hallo() {
	long int dato = 0;
	long int tid = 0;
	char tmpstr[41] = "";
	char teststr[21] = "";
	char host[41] = "";

	dato = ege_date();
	tid = ege_time() / 10000;
	gethostname(host,20);
	if (ws_testkreds>0) {
		strcpy(teststr,"-TEST");
	}
	sprintf(tmpstr,
		"CarlaServer %s%s %2.2ld-%2.2ld-%4.4ld %2.2ld:%2.2ld",
		host,
		teststr,
		dato % 100,
		(dato % 10000) / 100,
		(dato / 10000),
		tid/100,
		tid%100);
	alfalow(str);
	pack_init(str);
	pack_alfa(tmpstr);
	pack_alfa("Hello");
	sprintf(tmpstr,"Ver.%s",WEBVER);
	pack_alfa(tmpstr);
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	return;
}

/* ************************************ */
static int send_stationliste(short funk,short ecflag,char *langstr) {
	int retur = 0;
	short int dondafolo = 0;
	short int psbookflag = 0;
	short int okflag = 1;
	short int webstation = 0;
	short int nglindkast = 0;
	short int sortflag = 0;
	short int sortantal = 0;
	short int sortstnr = 0;
	short int minnr = 0;
	short int maxnr = 0;
	short int wx1 = 0;
	char resmailadr[81] = "";
	char tmpstr[81] = "";
	char vlmailadr[81] = "";
	char sortalfa[21] = "";
	char sortbuffer[201] = "";

	reclow(r198, R198);
	f198_start(1, ISGTEQ);
	reclow(r166, R166);
	f166_start(1, ISGTEQ);
	if (f166_ukendt) {
		okflag = -1;
	}
	if (ecflag>=1) {
		sortflag = 1;
	}
	if (ecflag==0 && ws_funktion==201) {
		sortflag = 1;
		dondafolo = 1;
	}
	if (ecflag==0 && ws_funktion==6) {
		sortflag = 1;
		dondafolo = 1;
	}
/* NYT 131120 PSSTATION */
	if (ecflag==0 && ws_funktion==6 && ws_brandtype==4) {
		sortflag = 1;
		psbookflag = 1;
	}
	if (ecflag==0 && ws_station>0) {
		minnr = ws_station;
		maxnr = ws_station;
		r166->stat_nr = minnr;
		f166_start(1, ISGTEQ);
	}
	if (logfil) {
		fprintf(logfil,
			"send_stationliste:funk=%hd,ecflag=%hd,langstr=%s\n",
			funk,
			ecflag,
			langstr);
		fprintf(logfil,
			"\tdondafolo=%hd\n",
			dondafolo);
		fprintf(logfil,
			"\tpsbookflag=%hd\n",
			psbookflag);
		fprintf(logfil,
			"\tsortflag=%hd\n",
			sortflag);
		fprintf(logfil,
			"\tminnr=%hd maxnr=%hd\n",
			minnr,maxnr);
		fflush(logfil);
	}
/* NYT 131120 PSSTATION */
	while (okflag>0 && psbookflag>0) {
		egeread(f166, ISNEXT);
		if (f166_eof) {
			break;
		}
		if (maxnr>0 && r166->stat_nr>maxnr) {
			break;
		}
		if (strncmp(r166->navn,"PS",2)!=0) {
			continue;
		}
		strcpy(sortalfa,"");
		webstation = 0;
		reclow(r198, R198);
		r198->oplkode = 16619;
		r198->keynum = r166->stat_nr;
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			webstation = (short int)r198->numfelt;
			strcpy(sortalfa,r198->alfafelt);
			sortalfa[15] = '\0';
		}
		if (sortflag && !strlen(sortalfa)) {
			strcpy(sortalfa,r166->by);
		}
		if (sortflag && r166->stat_nr==52) {
			sprintf(sortalfa,"00%s",r166->by);
		}
		if (sortflag && sortantal==0) {
			egesort(1, "sort");
		}
		if (sortflag) {
			ege_toupper((unsigned char *)sortalfa);
			for (wx1=0;wx1<sizeof(sortalfa);wx1++)  {
				if (sortalfa[wx1] == ' ') {
					sortalfa[wx1] = '!';
				}
			}
			if (!strlen(sortalfa)) {
				strcpy(sortalfa, "!!!!!!!!!!!!!!!");
			}
			sprintf(sortbuffer,
				"%-15s %3hd \n \0",
				sortalfa,
				r166->stat_nr);
			egesort(2, sortbuffer);
			sortantal++;
			continue;
		}
	}


	while (okflag>0 && psbookflag<=0) {
		egeread(f166, ISNEXT);
		if (f166_eof) {
			break;
		}
		if (maxnr>0 && r166->stat_nr>maxnr) {
			break;
		}
		wx1 = -1;
		if (ecflag==0) {
			reclow(r198, R198);
			r198->oplkode = 16642;
			r198->keynum = r166->stat_nr;
			egeread(f198, ISEQUAL);
			if (f198_ok && r198->numfelt>0) {
				wx1 = 1;
			}
			if (f198_ok && r198->numfelt==0) {
				wx1 = 0;
			}
		}
		if (ecflag==0 && wx1==0) {
			continue;
		}
		if (ecflag==0 && wx1==-1 &&
			strcmp(r166->navn, "DRIVEONNET")!=0) {
			continue;
		}
/* NYT 121011 */
		wx1 = 0;
		if (ecflag==0 && r166->stat_nr==66 && DONST66ON) {
			wx1 = 1;
		}
		if (ecflag==0 && r166->stat_nr==58 && DONST58ON) {
			wx1 = 1;
		}
		if (ecflag==0 && r166->stat_nr==57 && DONST57ON) {
			wx1 = 1;
		}
		if (ecflag==0 && r166->stat_nr==56 && DONST56ON) {
			wx1 = 1;
		}
		if (wx1<=0) {
			continue;
		}

		if (ecflag>=1 && strcmp(r166->navn, "DRIVEONNET")==0) {
			continue;
		}
		if (ecflag>=1 && strcmp(r166->navn, "CANCELLED")==0) {
			continue;
		}
/* NYT 060626 */
		if (ecflag==2 && r166->stat_type>0) {
			continue;
		}
/* NYT 071015 DANECARS */
		if (ecflag==2 && r166->stat_nr==41) {
			continue;
		}
		if (ecflag==2 && r166->stat_nr==61) {
			continue;
		}

		strcpy(sortalfa,"");
		webstation = 0;
		reclow(r198, R198);
		r198->oplkode = 16619;
		r198->keynum = r166->stat_nr;
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			webstation = (short int)r198->numfelt;
			strcpy(sortalfa,r198->alfafelt);
			sortalfa[15] = '\0';
		}
		if (ecflag==3) {
			reclow(r198, R198);
			r198->oplkode = 16652;
			r198->keynum = r166->stat_nr;
			egeread(f198, ISEQUAL);
			if (f198_ok) {
				webstation = (short int)r198->numfelt;
				strcpy(sortalfa,r198->alfafelt);
				sortalfa[15] = '\0';
			}
		}
		if (ecflag==1 && webstation<=0) {
			continue;
		}
		if (ecflag==3 && webstation<=0) {
			continue;
		}
		if (ecflag==2) {
			webstation = 0;
			r198->oplkode = 16627;
			r198->keynum = r166->stat_nr;
			strcpy(r198->keyalfa,"A");
			egeread(f198, ISEQUAL);
			if (f198_ok) {
				webstation = (short int)r198->numfelt;
			}
		}
		if (ecflag==2 && webstation<=0) {
			continue;
		}
/* NYT 051207 */
		if (sortflag && !strlen(sortalfa)) {
			strcpy(sortalfa,r166->by);
		}
		if (sortflag && r166->stat_nr==66) {
			sprintf(sortalfa,"00%s",r166->by);
		}
		if (sortflag && sortantal==0) {
			egesort(1, "sort");
		}
		if (sortflag) {
			ege_toupper((unsigned char *)sortalfa);
			for (wx1=0;wx1<sizeof(sortalfa);wx1++)  {
				if (sortalfa[wx1] == ' ') {
					sortalfa[wx1] = '!';
				}
			}
			if (!strlen(sortalfa)) {
				strcpy(sortalfa, "!!!!!!!!!!!!!!!");
			}
			sprintf(sortbuffer,
				"%-15s %3hd \n \0",
				sortalfa,
				r166->stat_nr);
			egesort(2, sortbuffer);
			sortantal++;
			continue;
		}
		alfalow(str);
		pack_init(str);
		pack_int2((long)r166->stat_nr);
		if (ecflag>=1) {
			reclow(r198, R198);
			r198->oplkode = 16601;
			r198->keynum = r166->stat_nr;
			egeread(f198, ISEQUAL);
			if (f198_ok) {
				pack_alfa(r198->alfafelt);
			} else {
				pack_alfa("");
			}
/*
                	stednavn_form((unsigned char *)r166->navn);
			pack_alfa(r166->navn);
*/
		} else {
			pack_alfa("driveon.net");
		}
		if (funk==2) {
			pack_exchkend();
			send_linie();
			continue;
		}
                stednavn_form((unsigned char *)r166->adr);
		pack_alfa(r166->adr);
		reclow(r198, R198);
		r198->oplkode = 16602;
		r198->keynum = r166->stat_nr;
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			stednavn_form((unsigned char *)r198->alfafelt);
			pack_alfa(r198->alfafelt);
		} else {
			pack_alfa("");
		}
		pack_alfa(r166->postkode);
		stednavn_form((unsigned char *)r166->by);
		pack_alfa(r166->by);
		if (ecflag>=1) {
			pack_alfa(r166->tlf);
		} else {
			pack_alfa("");
			pack_alfa(r166->tlf);
/* fax */
			reclow(r198, R198);
			r198->oplkode = 16603;
			r198->keynum = r166->stat_nr;
			egeread(f198, ISEQUAL);
			if (f198_ok) {
				pack_alfa(r198->alfafelt);
			} else {
				pack_alfa("");
			}
		}
/* email */
/* NYT 081010 */
		if (ecflag==2) {
			strcpy(vlmailadr,"reservations@europcar.dk");
		}
		reclow(r198, R198);
		r198->oplkode = 16604;
		r198->keynum = r166->stat_nr;
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			pack_alfa(r198->alfafelt);
			strcpy(vlmailadr,r198->alfafelt);
		} else {
			pack_alfa("");
		}
/* reservemailadr OBS */
		if (ecflag==1) {
			pack_alfa("reservations@europcar.dk");
		}
		if (ecflag==2) {
			reclow(r198, R198);
			r198->oplkode = 16643;
			r198->keynum = r166->stat_nr;
			egeread(f198, ISEQUAL);
			if (f198_ok) { 
				strcpy(vlmailadr,r198->alfafelt);
			}
			pack_alfa(vlmailadr);
/* RETTET 081010
			pack_alfa("reservations@europcar.dk");
*/
		}
		if (ecflag==1 || ecflag==3) {
/* EC flynr påkrævet */
			reclow(r198, R198);
			r198->oplkode = 16618;
			r198->keynum = r166->stat_nr;
			egeread(f198, ISEQUAL);
			if (f198_ok) {
				pack_int2((long)r198->numfelt);
			} else {
				pack_int2((long)0);
			}
/* EC nøgleindkast */
			reclow(r198, R198);
			r198->oplkode = 16623;
			r198->keynum = r166->stat_nr;
			egeread(f198, ISEQUAL);
			if (f198_ok) {
				pack_int2((long)r198->numfelt);
			} else {
				pack_int2((long)0);
			}
/* EC BSS aabningstider */
			send_stationaaben(2,langstr,r166->stat_nr);
		}
		if (ecflag==2) {
/* EC flynr påkrævet */
			pack_int2((long)0);
/* EC nøgleindkast */
			reclow(r198, R198);
			r198->oplkode = 16623;
			r198->keynum = r166->stat_nr;
			egeread(f198, ISEQUAL);
			if (f198_ok) {
				pack_int2((long)r198->numfelt);
			} else {
				pack_int2((long)0);
			}
/* EC BSS aabningstider */
			send_stationaaben(2,langstr,r166->stat_nr);
		}
		pack_exchkend();
		send_linie();
	}
	if (sortflag && sortantal>0) {
		egesort(3, "sort");
	}
	while (okflag && sortflag && sortantal>0) {
		if (egesort(4, sortbuffer) <= 0) {
			break;
		}
		reclow(r166, R166);
                sscanf(sortbuffer, "%s %hd",
			sortalfa,
                        &sortstnr);
		if (logfil) {
			fprintf(logfil, "SORT:%s", sortbuffer);
			fflush(logfil);
		}
		r166->stat_nr = sortstnr;
		egeread(f166, ISEQUAL);
		if (f166_ukendt) {
			continue;
		}
		alfalow(str);
		pack_init(str);
		pack_int2((long)r166->stat_nr);
		if (ecflag>=1) {
			reclow(r198, R198);
			r198->oplkode = 16601;
			r198->keynum = r166->stat_nr;
			egeread(f198, ISEQUAL);
			if (f198_ok) {
				pack_alfa(r198->alfafelt);
			} else {
				pack_alfa("");
			}
		}
		if (ecflag==0 && dondafolo==0) {
			pack_alfa("driveon.net");
		}
		if (ecflag==0 && dondafolo==1) {
			strcpy(tmpstr,r166->by);
			r198->oplkode = 16640;
			r198->keynum = r166->stat_nr;
			egeread(f198, ISEQUAL);
			if (f198_ok) {
				strcpy(tmpstr,r198->alfafelt);
			}
		}
		if (ecflag==0 && dondafolo==1 && strcmp(langstr,"EN")==0) {
			reclow(r198, R198);
			r198->oplkode = 16641;
			r198->keynum = r166->stat_nr;
			egeread(f198, ISEQUAL);
			if (f198_ok) {
				strcpy(tmpstr,r198->alfafelt);
			}
		}
		if (ecflag==0 && dondafolo==1) {
                	stednavn_form((unsigned char *)tmpstr);
			pack_alfa(tmpstr);
		}
		if (funk==2) {
			pack_exchkend();
			send_linie();
			continue;
		}
                stednavn_form((unsigned char *)r166->adr);
		pack_alfa(r166->adr);
		reclow(r198, R198);
		r198->oplkode = 16602;
		r198->keynum = r166->stat_nr;
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			stednavn_form((unsigned char *)r198->alfafelt);
			pack_alfa(r198->alfafelt);
		} else {
			pack_alfa("");
		}
/* ZipCode */
		pack_alfa(r166->postkode);
/* City */
		stednavn_form((unsigned char *)r166->by);
		pack_alfa(r166->by);
/* Land */
		strcpy(tmpstr,"DANMARK");
		if (strcmp(langstr,"EN")==0) {
			strcpy(tmpstr,"DENMARK");
		}
		stednavn_form((unsigned char *)tmpstr);
		pack_alfa(tmpstr);
/* Phone */
		pack_alfa(r166->tlf);
/* Fax */
		reclow(r198, R198);
		r198->oplkode = 16603;
		r198->keynum = r166->stat_nr;
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			pack_alfa(r198->alfafelt);
		} else {
			pack_alfa("N/A");
		}
/* EmailLocation */
		reclow(r198, R198);
		r198->oplkode = 16604;
		r198->keynum = r166->stat_nr;
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			pack_alfa(r198->alfafelt);
		} else {
			pack_alfa("");
		}
/* Bookingmail */
/* NYT 131120 PSSTATION */
		strcpy(tmpstr,"info@driveon.net");
		if (psbookflag>0) {
			strcpy(tmpstr,"info@ps-biludlejning.dk");
		}
		pack_alfa(tmpstr);
/* flynr påkrævet */
		pack_int2((long)0);
/* Nøgleindkast */
		pack_int2((long)0);
/* aabningstider */
		sprintf(tmpstr,"Generelle åbningstider st.%hd",r166->stat_nr);
		pack_alfa(tmpstr);
		if (psbookflag>0) {
			send_stationaaben(2,langstr,r166->stat_nr);
/*
			send_station_afh_afl(1,langstr,r166->stat_nr,1);
*/
		}
		pack_exchkend();
		send_linie();
		retur++;
/* TEST */
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}

	if (okflag==-1 && funk==2) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)0);
		pack_alfa("INGEN");
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
	if (logfil) {
		fprintf(logfil,"send_stationliste:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* **************************************** */
static void send_station_afh_afl(short funktion,char *langstr,short statnr,short donflag) {
	short int okflag = 1;
	short int funkretur = 0;
	short int lukslip = 0;
	short int lufthavnsflag = 0;
	long int defaultvarighed = 1;
	long int julian = 0;
	long int tmpdato = 0;
	long int startdato = ws_systemdato;
	long int slutdato = ws_systemdato;
	long int startfratid = 0;
	long int starttiltid = 0;
	long int slutfratid = 0;
	long int sluttiltid = 0;
	long int forvalgtkl = 0;
	long int defaultrespons = 200;
	char tmpstr[41] = "";

	if (funktion==1 && donflag==1) {
		lukslip = 1;
	}
/* TEST */
	sprintf(dum_str,
		"send_station_afh_afl:donflag=%hd,lukslip=%hd,ws_udldkflag=%hd",
		donflag,
		lukslip,
		ws_udldkflag);
       	logfil_put(dum_str);
	reclow(r198, R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16620;
	r198->keynum = statnr;
	egeread(f198, ISEQUAL);
	if (f198_ok && r198->numfelt>0) {
		lufthavnsflag = 1;
	}
/* TEST */
	sprintf(dum_str,"send_station_afh_afl:lufthavnsflag=%hd",lufthavnsflag);
       	logfil_put(dum_str);

	julian = m036_funktion(12, startdato);
	while (okflag>0 && okflag<10) {
		tmpdato = m036_funktion(19, julian);
		strcpy(ws_alert_txt,"");
		funkretur = check_bssaaben(-1,statnr,tmpdato,-1);
/* TEST */
		sprintf(dum_str,
"send_station_afh_afl:check_bssaaben %ld funkretur=%hd ws_alert_txt=%s",
			tmpdato,
			funkretur,
			ws_alert_txt);
        	logfil_put(dum_str);
		if (funkretur>0) {
			(void)get_alfa_tgn(ws_alert_txt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%ld", &startfratid);
			}
			(void)get_alfa_tgn(ws_alert_txt,1,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%ld", &starttiltid);
			}
		}
		if (funkretur>0) {
			forvalgtkl = startfratid;
			startdato = m036_funktion(19, julian);
			if (startdato==ws_systemdato) {
				forvalgtkl = ws_systemtid;
				forvalgtkl += 200;
				forvalgtkl /= 100;
				forvalgtkl *= 100;
			}
			if (forvalgtkl>=starttiltid) {
				funkretur = 0;
				forvalgtkl = 0;
			}
		}
		if (funkretur>0) {
			okflag = 0;
			break;
		}
		julian++;
		okflag++;
	}
	startdato = m036_funktion(19, julian);

	julian += defaultvarighed;
	slutdato = m036_funktion(19, julian);
	strcpy(ws_alert_txt,"");
	funkretur = check_bssaaben(-1,statnr,slutdato,-1);
/* TEST */
	sprintf(dum_str,
"send_station_afh_afl:check_bssaaben %ld funkretur=%hd ws_alert_txt=%s",
		slutdato,
		funkretur,
		ws_alert_txt);
       	logfil_put(dum_str);
	if (funkretur>0) {
		(void)get_alfa_tgn(ws_alert_txt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &slutfratid);
		}
		(void)get_alfa_tgn(ws_alert_txt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &sluttiltid);
		}
	}
/* NYT 070207 */
	if (donflag==1) {
		if (starttiltid>=800) {
			startfratid = 800;
		}
/* NYT 070525 */
		if (starttiltid>=800 && lukslip==1 && starttiltid%100==0) {
			starttiltid -= 70;
			lukslip++;
		}
		if (starttiltid>=800 && lukslip==1 && starttiltid%100==30) {
			starttiltid -= 30;
			lukslip++;
		}
	}
/* NYT 090331 UDLDK */
	if (ws_udldkflag>0 && lufthavnsflag>0) {
		startfratid = 0600;
		starttiltid = 2345;
	}
/* NYT 100618 */
	if (donflag==0 && lufthavnsflag>0) {
		startfratid = 0600;
		starttiltid = 2345;
	}

	sprintf(tmpstr,"%8.8ld-%4.4ld-%4.4ld-%4.4ld",
		startdato,
		startfratid,
		starttiltid,
		forvalgtkl);
	pack_alfa(tmpstr);
/* NYT 070207 */
	if (donflag==1) {
		if (sluttiltid>=800) {
			sluttiltid = 800;
		}
	}
	sprintf(tmpstr,"%8.8ld-%4.4ld-%4.4ld",
		slutdato,
		slutfratid,
		sluttiltid);
	pack_alfa(tmpstr);

	return;
}

/* ******************************************** */
static void check_stationdata(station)
short int station; {
	long int fradato;
	long int tildato;
	int retur_antal;
	long int kap_antal = 0;
	long int blok_antal = 0;
	long int kon_antal = 0;
	long int res_antal = 0;
	char fragrp[5];
	char tilgrp[5];

/* TEST */
	if (logfil) {
		fprintf(logfil,
			"check_stationdata:station=%hd,ege_pid=%hd\n",
			station,
			ege_pid);
		fflush(logfil);
	}
	fradato = 20040504;
	tildato = 20040504;
	strcpy(fragrp, "A");
	strcpy(tilgrp, "A");
	if (logfil) {
		fprintf(logfil,
			"check_stationdata:fradato-tildato=%ld-%ld\n",
			fradato,
			tildato);
		fflush(logfil);
	}
	retur_antal = check_f168kap(1,
		(short int)(1000+station),
		fradato,
		tildato,
		fragrp,
		tilgrp,
		&blok_antal,
		&kon_antal,
		&res_antal);
	kap_antal = retur_antal;


/* TEST */
	if (logfil) {
		fprintf(logfil,
			"check_stationdata:kap_antal=%ld\n",
			kap_antal);
		fprintf(logfil,
			"check_stationdata:blok_antal=%ld\n",
			blok_antal);
		fprintf(logfil,
			"check_stationdata:kon_antal=%ld\n",
			kon_antal);
		fprintf(logfil,
			"check_stationdata:res_antal=%ld\n",
			res_antal);
		fflush(logfil);
	}
	return;
}

/* ************************************ */
static void send_stationdetail(langstr,station)
char * langstr;
short int station; {
	short int antal = 0;
	short int okflag = 1;
	short int brudflag = 0;
	char returstr[81];

	reclow(r198, R198);
	f198_start(1, ISGTEQ);
	reclow(r166, R166);
	f166_start(1, ISGTEQ);
	r166->stat_nr = station;
	egeread(f166, ISEQUAL);
	if (f166_ukendt) {
		okflag = 0;
		reclow(r166, R166);
	}
	if (okflag) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)r166->stat_nr);
/* RETTET 040519
		stednavn_form((unsigned char *)r166->navn);
		pack_alfa(r166->navn);
*/
		pack_alfa("driveon.net");
		stednavn_form((unsigned char *)r166->adr);
		pack_alfa(r166->adr);
		reclow(r198, R198);
		r198->oplkode = 16602;
		r198->keynum = r166->stat_nr;
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			stednavn_form((unsigned char *)r198->alfafelt);
			pack_alfa(r198->alfafelt);
		} else {
			pack_alfa("");
		}
		pack_alfa(r166->postkode);
		stednavn_form((unsigned char *)r166->by);
		pack_alfa(r166->by);
/* RETTET 050127
		pack_alfa(r166->land);
*/
		pack_alfa("");
		sprintf(returstr, "Tlf. %s", r166->tlf);
		pack_alfa(returstr);
/* RETTET 040519
		pack_alfa(r166->tlf);
*/
/* fax */
		reclow(r198, R198);
		r198->oplkode = 16603;
		r198->keynum = r166->stat_nr;
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			sprintf(returstr, "Fax. %s", r198->alfafelt);
			pack_alfa(returstr);
/* RETTET 040519
			pack_alfa(r198->alfafelt);
*/
		} else {
			pack_alfa("");
		}
/* email */
		reclow(r198, R198);
		r198->oplkode = 16604;
		r198->keynum = r166->stat_nr;
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			sprintf(returstr, "Mail. %s", r198->alfafelt);
			pack_alfa(returstr);
/* RETTET 040519
			pack_alfa(r198->alfafelt);
*/
		} else {
			pack_alfa("");
		}
/* mapfil */
		reclow(r198, R198);
		r198->oplkode = 16605;
		r198->keynum = r166->stat_nr;
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			pack_alfa(r198->alfafelt);
		} else {
			pack_alfa("");
		}
		pack_exchkend();
		send_linie();
	}
	if (okflag==1) {
		send_stationaaben(1,langstr,station);
		alfalow(str);
		pack_init(str);
		pack_alfa("");
		pack_exchkend();
		send_linie();
	}
	if (okflag<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)0);
		pack_alfa(r166->navn);
		pack_alfa(r166->adr);
		pack_alfa("");
		pack_alfa(r166->postkode);
		pack_alfa(r166->by);
		pack_alfa(r166->land);
		pack_alfa(r166->tlf);
		pack_alfa("");
		pack_alfa("");
		pack_alfa("");
		pack_exchkend();
		send_linie();
/*
		send_stationaaben(1,langstr,station);
*/
		alfalow(str);
		pack_init(str);
		pack_alfa("");
		pack_exchkend();
		send_linie();
	}
	return;
}

/* **************************************************** */
static void send_stationaaben(funk,langstr,station)
short int funk;
char * langstr;
short int station; {
	short int wx1;
	short int tmpidx = -1;
	short int antal = 0;
	short int okflag = 1;
	short int brudflag = 0;
	long int dagkode = 0;
	short int dagbryd = 0;
	short int mindagkode = 0;
	short int maxdagkode = 0;
	long int totfrakl = 0;
	long int tottilkl = 0;
	long int nuvfrakl = 0;
	long int nuvtilkl = 0;
	char returstr[81] = "";
	char tmpstr[81] = "";

/* TEST */
	if (logfil) {
		fprintf(logfil,
			"send_stationaaben:funk=%hd,langstr=%s,station=%hd\n",
			funk,
			langstr,
			station);
		fflush(logfil);
	}
	reclow(r198, R198);
	r198->oplkode = 16606;
	r198->keynum = station;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		okflag = 0;
	}
	if (logfil) {
		fprintf(logfil,
			"send_stationaaben:okflag=%hd\n",
			okflag);
		fflush(logfil);
	}
	while (okflag) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			brudflag = 1;
			break;
		}
		if (r198->oplkode!=16606) {
			brudflag = 1;
			break;
		}
		if (r198->keynum!=station) {
			brudflag = 1;
			break;
		}
/* TEST */
/*
		if (logfil) {
			fprintf(logfil,
				"send_stationaaben:r198_alfa=%s\n",
				r198->alfafelt);
			fflush(logfil);
		}
*/
		if (funk!=2 && antal==0) {
			alfalow(str);
			pack_init(str);
			pack_del();
		}
		if (funk==2 && antal==0) {
			pack_del();
		}
		reccpy(&q198, r198, R198);
/*
		if (dan_aabentid(langstr,q198.alfafelt,returstr)<100) {
			pack_alfa(returstr);
		} else {
			tmpidx++;
			if (tmpidx<MAX_TMPTAB) {
				strcpy(ws_tmptab[tmpidx], returstr);
			}
		}
*/
		(void)get_alfa_tgn(q198.alfafelt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &dagkode);
		}
		(void)get_alfa_tgn(q198.alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &nuvfrakl);
		}
		(void)get_alfa_tgn(q198.alfafelt,2,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &nuvtilkl);
		}
		strcpy(returstr, "");
		if (dagkode==1) {
			mindagkode = 1;
			totfrakl = nuvfrakl;
			tottilkl = nuvtilkl;
		}
		if (dagkode>=2 && dagkode<=5) {
			if (nuvfrakl<totfrakl) {
				totfrakl = nuvfrakl;
			}
			if (nuvtilkl>tottilkl) {
				tottilkl = nuvtilkl;
			}
		}
		if (dagkode==5) {
			maxdagkode = 5;
			(void)dan_aabentid_ny(langstr,
				(long int)mindagkode,
				(long int)maxdagkode,
				totfrakl,
				tottilkl,
				returstr);
		}
		if (dagkode==6) {
			mindagkode = 6;
			maxdagkode = 6;
			totfrakl = nuvfrakl;
			tottilkl = nuvtilkl;
			(void)dan_aabentid_ny(langstr,
				(long int)mindagkode,
				(long int)maxdagkode,
				totfrakl,
				tottilkl,
				returstr);
		}
		if (dagkode==7 && funk!=2) {
			mindagkode = 7;
			totfrakl = nuvfrakl;
			tottilkl = nuvtilkl;
		}
		if (dagkode==7 && funk==2) {
			mindagkode = 7;
			maxdagkode = 7;
			totfrakl = nuvfrakl;
			tottilkl = nuvtilkl;
			(void)dan_aabentid_ny(langstr,
				(long int)mindagkode,
				(long int)maxdagkode,
				totfrakl,
				tottilkl,
				returstr);
		}
		if (funk!=2 && dagkode>=8 && dagkode<=19) {
			if (nuvfrakl<totfrakl) {
				totfrakl = nuvfrakl;
			}
			if (nuvtilkl>tottilkl) {
				tottilkl = nuvtilkl;
			}
		}
		if (funk==2 && dagkode>=8 && dagkode<19) {
			mindagkode = dagkode;
			maxdagkode = dagkode;
			totfrakl = nuvfrakl;
			tottilkl = nuvtilkl;
			(void)dan_aabentid_ny(langstr,
				(long int)mindagkode,
				(long int)maxdagkode,
				totfrakl,
				tottilkl,
				returstr);
		}
		if (funk==2 && dagkode==19) {
			mindagkode = dagkode;
			if (nuvfrakl<totfrakl) {
				totfrakl = nuvfrakl;
			}
			if (nuvtilkl>tottilkl) {
				tottilkl = nuvtilkl;
			}
		}
		if (dagkode==19) {
			maxdagkode = 19;
			(void)dan_aabentid_ny(langstr,
				(long int)mindagkode,
				(long int)maxdagkode,
				totfrakl,
				tottilkl,
				returstr);
		}
		if (dagkode==20) {
			mindagkode = 20;
			maxdagkode = 20;
			totfrakl = nuvfrakl;
			tottilkl = nuvtilkl;
			(void)dan_aabentid_ny(langstr,
				(long int)mindagkode,
				(long int)maxdagkode,
				totfrakl,
				tottilkl,
				returstr);
		}
		if (dagkode==21) {
			mindagkode = 21;
			maxdagkode = 21;
			totfrakl = nuvfrakl;
			tottilkl = nuvtilkl;
			(void)dan_aabentid_ny(langstr,
				(long int)mindagkode,
				(long int)maxdagkode,
				totfrakl,
				tottilkl,
				returstr);
		}
		if (dagkode==22) {
			mindagkode = 22;
			maxdagkode = 22;
			totfrakl = nuvfrakl;
			tottilkl = nuvtilkl;
			(void)dan_aabentid_ny(langstr,
				(long int)mindagkode,
				(long int)maxdagkode,
				totfrakl,
				tottilkl,
				returstr);
		}
		if (dagkode==23) {
			mindagkode = 23;
			maxdagkode = 23;
			totfrakl = nuvfrakl;
			tottilkl = nuvtilkl;
			(void)dan_aabentid_ny(langstr,
				(long int)mindagkode,
				(long int)maxdagkode,
				totfrakl,
				tottilkl,
				returstr);
		}
		if (dagkode==10 || dagkode==24) {
			mindagkode = 10;
			maxdagkode = 10;
			totfrakl = nuvfrakl;
			tottilkl = nuvtilkl;
			(void)dan_aabentid_ny(langstr,
				(long int)mindagkode,
				(long int)maxdagkode,
				totfrakl,
				tottilkl,
				returstr);
		}
		if (dagkode>20000000 && dagkode<99999999) {
			if (dagkode<ws_systemdato) {
				reccpy(r198, &q198, R198);
				f198_start(1, ISGREAT);
				if (f198_ukendt) {
					break;
				}
				continue;
			}
			(void)dan_aabentid_ny(langstr,
				(long int)dagkode,
				(long int)dagkode,
				nuvfrakl,
				nuvtilkl,
				returstr);
/*
			dan_datotxt(langstr,dagkode,returstr);
*/
		}
		if (strlen(returstr)) {
			tmpidx++;
			if (tmpidx<MAX_TMPTAB) {
				strcpy(ws_tmptab[tmpidx], returstr);
			}
		}
		antal++;
		reccpy(r198, &q198, R198);
		f198_start(1, ISGREAT);
		if (f198_ukendt) {
			break;
		}
	}
	for (wx1=0;wx1<=tmpidx;wx1++) {
		pack_alfa(ws_tmptab[wx1]);
	}
	if (funk!=2 && brudflag && antal>0) {
		pack_exchkend();
		send_linie();
	}
	return;
}

/* ****************************************** */
static int send_udind_aabentid(short funk,short donflag) {
	short int retur = 0;
	short int funkretur = 0;
	short int nglindkast = 0;
	short int fejlkodeud = 0;
	short int fejlkodeind = 0;
	short int lukslip = 0;
	short int lufthavnsflag = 0;
	short int afllufthflag = 0;
	long int frakl = 0;
	long int tilkl = 0;
	long int forvalgtkl = 0;
	char tmpstr[81] = "";

	if (funk==2 && donflag==1) {
		lukslip = 1;
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,
			"send_udind_aabentid:funk=%hd,donflag=%hd\n",
			funk,
			donflag);
		fprintf(logfil,
		"send_udind_aabentid:%s,%hd-%hd,%ld+%ld-%ld+%ld\n",
			ws_langstr,
			ws_station,
			ws_tilstation,
			ws_fradato,
			ws_fratid,
			ws_tildato,
			ws_tiltid);
		fprintf(logfil,
		"send_udind_aabentid:lukslip=%hd\n",
			lukslip);
		fflush(logfil);
	}
	reclow(r198, R198);
	r198->oplkode = 16620;
	r198->keynum = ws_station;
	egeread(f198, ISEQUAL);
	if (f198_ok && r198->numfelt>0) {
		lufthavnsflag = 1;
	}
/* NYT 120427 LUFTHAVNAFL */
	reclow(r198, R198);
	r198->oplkode = 16620;
	r198->keynum = ws_tilstation;
	egeread(f198, ISEQUAL);
	if (f198_ok && r198->numfelt>0) {
		afllufthflag = 1;
	}
	reclow(r198, R198);
	r198->oplkode = 16623;
	r198->keynum = ws_tilstation;
	egeread(f198, ISEQUAL);
	if (f198_ok) {
		nglindkast = (short int)r198->numfelt;
	}
	if (ws_udldkflag>0) {
		nglindkast = 1;
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,
		"send_udind_aabentid:nglindkast=%hd,lufthavnsflag=%hd\n",
			nglindkast,
			lufthavnsflag);
	}
	if (ws_fradato<=0) {
		fejlkodeud = -10;
	}
	if (ws_tildato<=0) {
		fejlkodeind = -11;
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,
		"send_udind_aabentid:fejlkodeud=%hd,fejlkodeind=%hd\n",
			fejlkodeud,
			fejlkodeind);
	}

	alfalow(str);
	pack_init(str);
	if (fejlkodeud!=0) {
		pack_int2((long)fejlkodeud);
	}
	if (fejlkodeud==0) {
		strcpy(ws_alert_txt,"");
		funkretur = check_bssaaben(-1,ws_station,ws_fradato,-1);
	}
/* NYT 090331 UDLDK */
	if (ws_udldkflag>0 && lufthavnsflag>0) {
		funkretur = 1;
		strcpy(ws_alert_txt,"0600;2345;");
		fejlkodeud = 0;
	}
/* NYT 100618 */
	if (donflag==0 && lufthavnsflag>0) {
		funkretur = 1;
		strcpy(ws_alert_txt,"0600;2345;");
		fejlkodeud = 0;
	}
	if (fejlkodeud==0 && funkretur<=0) {
/* NYT 061120 */
		pack_int2(-55);
		web_errormess(0,ws_langstr,"55");
/*
		pack_int2((long)0);
*/
        }
	if (funk==2 && fejlkodeud==0 && funkretur>0) {
		forvalgtkl = frakl;
		if (ws_fradato==ws_systemdato) {
			forvalgtkl = ws_systemtid;
			forvalgtkl += 200;
			forvalgtkl /= 100;
			forvalgtkl *= 100;
		}
		if (forvalgtkl>2300) {
			forvalgtkl = 2300;
		}
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,
		"send_udind_aabentid:ws_alert_txt=%s\n",
			ws_alert_txt);
	}
	if (fejlkodeud==0 && funkretur>0) {
		frakl = 0;
		tilkl = 0;
		(void)get_alfa_tgn(ws_alert_txt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &frakl);
		}
		(void)get_alfa_tgn(ws_alert_txt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &tilkl);
		}
		sprintf(tmpstr,"%4.4ld-%4.4ld",
			frakl,
			tilkl);
	}
/* NYT 070207 */
	if (funk==2 && fejlkodeud==0 && funkretur>0 &&
		donflag==1) {
                if (tilkl>=800) {
                        frakl = 800;
                }
/* NYT 070525 */
		if (tilkl>=800 && lukslip==1 && tilkl%100==0) {
			tilkl -= 70;
			lukslip++;
		}
		if (tilkl>=800 && lukslip==1 && tilkl%100==30) {
			tilkl -= 30;
			lukslip++;
		}
	}
	if (funk==2 && fejlkodeud==0 && funkretur>0) {
		sprintf(tmpstr,"%8.8ld-%4.4ld-%4.4ld",
			ws_fradato,
			frakl,
			tilkl);
/* RETTET 061116
		sprintf(tmpstr,"%8.8ld-%4.4ld-%4.4ld-%4.4ld",
			ws_fradato,
			frakl,
			tilkl,
			forvalgtkl);
*/
	}
	if (fejlkodeud==0 && funkretur>0) {
		pack_alfa(tmpstr);
	}
	if (fejlkodeind!=0) {
		pack_int2((long)fejlkodeind);
	}
	if (fejlkodeind==0) {
		strcpy(ws_alert_txt,"");
		funkretur = check_bssaaben(-1,ws_tilstation,ws_tildato,-1);
	}
	if (ws_udldkflag>0 && funkretur<=0 && nglindkast>0) {
		funkretur = 1;
		sprintf(ws_alert_txt,"0015;2345;");
		fejlkodeind = 0;
	}
/* NYT 120427 LUFTHAFL */
	if (ws_udldkflag<=0 && afllufthflag>0 && funkretur<=0 && nglindkast>0) {
		funkretur = 1;
		sprintf(ws_alert_txt,"0015;2345;");
		fejlkodeind = 0;
	}
	if (fejlkodeind==0 && funkretur<=0) {
/* NYT 061120 */
		if (nglindkast>0) {
			pack_int2(-57);
			web_errormess(0,ws_langstr,"57");
		} else {
			pack_int2(-56);
			web_errormess(0,ws_langstr,"56");
		}
/*
		pack_int2((long)0);
*/
        }
/* TEST */
	if (logfil) {
		fprintf(logfil,
		"send_udind_aabentid:ws_alert_txt=%s\n",
			ws_alert_txt);
	}
	if (fejlkodeind==0 && funkretur>0) {
		frakl = 0;
		tilkl = 0;
		(void)get_alfa_tgn(ws_alert_txt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &frakl);
		}
		(void)get_alfa_tgn(ws_alert_txt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &tilkl);
		}
		sprintf(tmpstr,"%4.4ld-%4.4ld",
			frakl,
			tilkl);
	}
/* NYT 070207 */
	if (funk==2 && fejlkodeind==0 && funkretur>0 &&
		donflag==1) {
		if (tilkl>=800) {
                        tilkl = 800;
                }
	}
	if (funk==2 && fejlkodeind==0 && funkretur>0) {
		sprintf(tmpstr,"%8.8ld-%4.4ld-%4.4ld",
			ws_tildato,
			frakl,
			tilkl);
	}
	if (fejlkodeind==0 && funkretur>0) {
		pack_alfa(tmpstr);
	}
	pack_exchkend();
	send_linie();
/* TEST */
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	return(retur);
}

/* ******************************************** */
/* p7803 check_bssaaben				*/
/* udind 0 = ud					*/
/*	 1 = ind				*/
/* ******************************************** */
static int check_bssaaben(udind,station,dato,tid)
short int udind;
short int station;
long int dato;
long int tid; {
	short int retur = 0;
	short int fundet = 0;
	short int ugdgnr = 0;
	short int hlgdgnr = 0;
	long int frakl = 0;
	long int tilkl = 0;
	long int okfrakl = 0;
	long int oktilkl = 0;
	long int chknum = 0;
	long int dagkode = 0;
	char tmpstr[81] = "";
	char fejlstr[41] = "";
	char pgfilsti[81] = "";
	char pginpstr[201] = "";
	short int pgfindflag = 0;
	short int okflag = 0;

	if (station==0) {
		return(-1);
	}
	if (dato==0) {
		return(-1);
	}
/* NYT 140227 */
	kaldfunk_check_bssaaben++;

/*
	if (tid==0) {
		return(-1);
	}
*/
/*
	if (bit_check(ws_alert_flag,udind)==1) {
		return(-1);
	}
*/
	chknum = m036_funktion(11, (long int)dato);
	ugdgnr = (short int)(chknum % 10);
	hlgdgnr = (short int)m036_alfa_funk(2,(long int)dato,40,tmpstr);
/* TEST
	sprintf(dum_str,
		"check_bssaaben:dato=%ld,ugdgnr=%hd,hlgdgnr=%hd,tid=%ld",
		dato,
		ugdgnr,
		hlgdgnr,
		tid);
        logfil_put(dum_str);
*/
/* NYT 131205 PGAABEN */
	if (strlen(ws_pgaabenfilsti)) {
		strcpy(pgfilsti,ws_pgaabenfilsti);
		pgfindflag = 1;
	}
	if (pgfindflag>=1) {
		tmpfil = fopen(pgfilsti,"r");
		if (!tmpfil) {
			tmpfil = (FILE*)0;
			pgfindflag = 0;
			retur = -1;
		}
	}
	if (pgfindflag>=1 && tmpfil) {
		(void)fgets(pginpstr,200,tmpfil);
	}
	if (pgfindflag<=0) {
		reclow(r198, R198);
		r198->oplkode = 16606;
		r198->keynum = station;
		f198_start(1, ISGTEQ);
		if (f198_ukendt) {
			retur = -1;
		}
	}
	while (retur>=0) {
/*
		egeread(f198, ISNEXT);
		if (f198_eof) { break; }
*/
/* NYT 131205 PGAABEN */
		if (pgfindflag<=0) {
			egeread(f198,ISNEXT);
			if (f198_eof) { break; }
		}
		if (pgfindflag>0) {
			if (!fgets(pginpstr,200,tmpfil)) { break; }
			(void)get_alfa_tgn(pginpstr,0,tmpstr,9);
			sscanf(tmpstr,"%ld",&r198->oplkode);
			(void)get_alfa_tgn(pginpstr,1,tmpstr,9);
			sscanf(tmpstr,"%lf",&r198->keynum);
			(void)get_alfa_tgn(pginpstr,2,r198->keyalfa,9);

			(void)get_alfa_tgn(pginpstr,3,tmpstr,9);
			r198->fradato = 0;
			if (strcmp(tmpstr,"0001-01-01")!=0) {
				rens_datotidstr(tmpstr);
				sscanf(tmpstr,"%ld",&r198->fradato);
			}
			if (strcmp(tmpstr,"2099-12-31")==0) {
				r198->fradato = 99999999;
			}
			(void)get_alfa_tgn(pginpstr,4,tmpstr,9);
			r198->tildato = 0;
			if (strcmp(tmpstr,"0001-01-01")!=0) {
				rens_datotidstr(tmpstr);
				sscanf(tmpstr,"%ld",&r198->tildato);
			}
			if (strcmp(tmpstr,"2099-12-31")==0) {
				r198->tildato = 99999999;
			}
			(void)get_alfa_tgn(pginpstr,5,tmpstr,9);
			sscanf(tmpstr,"%lf",&r198->numfelt);
			(void)get_alfa_tgn(pginpstr,6,r198->alfafelt,9);
		}
		if (r198->oplkode!=16606) { break; }
		if (r198->keynum!=station) { break; }
		fundet++;
		okflag = 0;
		dagkode = 0;
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &dagkode);
		}
		frakl = 0;
		tilkl = 0;
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &frakl);
		}
		(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &tilkl);
		}
/* TEST
		sprintf(dum_str,
			"check_bssaaben:dagkode=%ld,fra-til=%ld-%ld",
			dagkode,
			frakl,
			tilkl);
	        logfil_put(dum_str);
*/
		if (hlgdgnr<10 &&
			dagkode>0 && dagkode<8 &&
			dagkode==ugdgnr) {
			retur = 1;
			okfrakl = frakl;
			oktilkl = tilkl;
			okflag++;
		}
		if (hlgdgnr>=10 &&
			dagkode>=10 && dagkode<100 &&
			dagkode==hlgdgnr) {
			retur = 1;
			okfrakl = frakl;
			oktilkl = tilkl;
			okflag++;
		}
		if (dagkode>20000000 &&
			dato==dagkode) {
			retur = 1;
			okfrakl = frakl;
			oktilkl = tilkl;
			okflag++;
		}
		if (okflag &&
			retur==1 &&
			tid==-1 &&
			frakl==0 &&
			tilkl==0) {
			retur = 0;
			break;
		}
		if (okflag &&
			retur==1 &&
			tid==2500 &&
			(frakl==0 ||
			frakl>1200)) {
			retur = 0;
			break;
		}
		if (okflag &&
			retur==1 &&
			tid==2600 &&
			(tilkl==0 ||
			tilkl<=1200)) {
			retur = 0;
			break;
		}
		if (okflag &&
			retur==1 &&
			tid==2700 &&
			frakl==0 &&
			tilkl==0) {
			retur = 0;
			break;
		}
		if (okflag &&
			retur==1 &&
			tid > 0 &&
			tid < 2400 &&
			(tid < frakl || tid > tilkl)) {
			retur = 0;
			break;
		}
		if (okflag &&
			retur==1 &&
			tid > 0 &&
			tid < 2400 &&
			tid >= frakl &&
			tid <= tilkl) {
			break;
		}
	}
	if (fundet<=0) {
		retur = -1;
	}
	if (fundet && retur>=0 && udind>=0) {
		ws_alert_flag = bit_toggle(ws_alert_flag, udind);
	}
	if (fundet && retur==0 && udind==0) {
		sprintf(fejlstr, "AFH:%ld-%ld",frakl,tilkl);
		if (okfrakl==0 && oktilkl==0) {
			sprintf(fejlstr, "AFH:LUKKET");
		}
	}
	if (fundet && retur==0 && udind==1) {
		sprintf(fejlstr, "AFL:%ld-%ld",okfrakl,oktilkl);
		if (okfrakl==0 && oktilkl==0) {
			sprintf(fejlstr, "AFL:LUKKET");
		}
	}
	if (fundet && retur==0 && tid>0) {
		sprintf(tmpstr, " ! Åbn.tider %s", fejlstr);
		strcat(ws_alert_txt, tmpstr);
	}
	if (fundet && retur<=0 && tid==-1) {
		strcpy(ws_alert_txt, "LUKKET");
	}
	if (fundet && retur>0 && tid==-1) {
		sprintf(ws_alert_txt, "%ld;%ld", okfrakl, oktilkl);
	}
	return(retur);
}

/* *********************** */
static int dan_aabentid_ny(langstr,dgfra,dgtil,frakl,tilkl,outstr)
char * langstr;
long int dgfra;
long int dgtil;
long int frakl;
long int tilkl;
char * outstr; {
	short int retur = 0;
	char dgstr1[41] = "";
	char dgstr2[41] = "";
	char tmpstr[41] = "";
/* TEST */
	if (logfil) {
		fprintf(logfil,
		"dan_aabentid_ny:dgfra-til=%ld-%ld kl:%ld-%ld\n",
			dgfra,
			dgfra,
			frakl,
			tilkl);
		fflush(logfil);
	}

	if (dgfra>0 && dgfra<=100) {
		dan_dagtxt(langstr,dgfra,dgstr1);
	}
	if (dgfra>100) {
		dan_datotxt(langstr,dgfra,dgstr1);
	}

	if (dgtil>0 && dgtil<=100) {
		dan_dagtxt(langstr,dgtil,dgstr2);
	}
	if (dgtil>100) {
		dan_datotxt(langstr,dgtil,dgstr2);
	}
	if (dgfra==dgtil) {
		strcpy(outstr, dgstr1);
	}
	if (dgfra!=dgtil) {
		strcpy(outstr, dgstr1);
		strcat(outstr, " - ");
		strcat(outstr, dgstr2);
	}
	if (dgfra==7 && dgtil==19) {
		trans_tekst(langstr,10008,"",dgstr1);
		strcpy(outstr, dgstr1);
	}
	if (frakl==0 && tilkl==0) {
		trans_tekst(langstr,10100,"",tmpstr);
	} else {
		sprintf(tmpstr, "%2.2hd:%2.2hd - %2.2hd:%2.2hd",
			frakl/100,
			frakl%100,
			tilkl/100,
			tilkl%100);
	}
	strcat(outstr, " ");
	strcat(outstr, tmpstr);
	return(retur);
}

/* *********************** */
static long int dan_aabentid(langstr,inpstr,outstr)
char * langstr;
char * inpstr;
char * outstr; {
	short int frakl = 0;
	short int tilkl = 0;
	long int chknum; 
	char tmpstr[41];

	if (logfil) {
		fprintf(logfil, "dan_aabentid:langstr=%s,inpstr=%s\n",
			langstr,
			inpstr);
	}
	strcpy(outstr, "");
	frakl = 0;
	tilkl = 0;
	(void)get_alfa_tgn(inpstr,1,tmpstr,';');
	if (strlen(tmpstr)) {
		sscanf(tmpstr, "%hd", &frakl);
	}
	(void)get_alfa_tgn(inpstr,2,tmpstr,';');
	if (strlen(tmpstr)) {
		sscanf(tmpstr, "%hd", &tilkl);
	}
	chknum = 0;
	(void)get_alfa_tgn(inpstr,0,tmpstr,';');
	if (strlen(tmpstr)) {
		sscanf(tmpstr, "%ld", &chknum);
	}
	if (chknum<=0) {
		strcpy(tmpstr,"???");
	}
	if (chknum>0 && chknum<=100) {
		dan_dagtxt(langstr,chknum,tmpstr);
	}
	if (chknum>100) {
		dan_datotxt(langstr,chknum,tmpstr);
	}
	strcpy(outstr, tmpstr);
	if (frakl==0 && tilkl==0) {
/*
		strcpy(tmpstr, "Lukket");
*/
		trans_tekst(langstr,10100,"",tmpstr);
	} else {
		sprintf(tmpstr, "%2.2hd:%2.2hd - %2.2hd:%2.2hd",
			frakl/100,
			frakl%100,
			tilkl/100,
			tilkl%100);
	}
	strcat(outstr, " ");
	strcat(outstr, tmpstr);
	if (logfil) {
		fprintf(logfil, "dan_aabentid:RETUR chknum=%ld\n",
			chknum);
	}
	return(chknum);
}

/* ************************* */
static void dan_datotxt(langstr,dagkode,returstr)
char * langstr;
long int dagkode;
char * returstr; {

	if (logfil) {
		fprintf(logfil, "dan_datotxt:langstr=%s,dagkode=%ld\n",
			langstr,
			dagkode);
		fflush(logfil);
	}
	egeedit(ege_w_dou1=m036_funktion(17, dagkode),
		"99.99.9999",returstr);
	returstr[2] = '-';
	returstr[5] = '-';
	return;
}

/* ************************* */
static void dan_dagtxt(langstr,dagkode,returstr)
char * langstr;
long int dagkode;
char * returstr; {

	if (logfil) {
		fprintf(logfil, "dan_dagtxt:langstr=%s,dagkode=%ld\n",
			langstr,
			dagkode);
		fflush(logfil);
	}
	trans_tekst(langstr,10000+dagkode,"",returstr);
	if (logfil) {
		fprintf(logfil, "dan_dagtxt:returstr=%s\n",
			returstr);
		fflush(logfil);
	}
	return;
}

/* ************************************ */
static void send_stationfelt(feltid,langstr,station)
long int feltid;
char * langstr;
short int station; {
	short int antal = 0;
	short int okflag = 0;

	if (feltid>10000) {
		reclow(r198, R198);
		f198_start(1, ISGTEQ);
		r198->oplkode = feltid;
		r198->keynum = station;
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			okflag  = 1;
		}
	} else {
		reclow(r166, R166);
		f166_start(1, ISGTEQ);
		r166->stat_nr = station;
		egeread(f166, ISEQUAL);
		if (f166_ok) {
			okflag  = 1;
		}
	}
	alfalow(str);
	pack_init(str);
	if (!okflag) {
		pack_alfa("");
	}
	if (okflag && feltid==2) {
		egechartest((unsigned char *)r166->navn);
		pack_alfa(r166->navn);
	}
	if (okflag && feltid==16604) {
		egechartest((unsigned char *)r198->alfafelt);
		pack_alfa(r198->alfafelt);
	}
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil,"send_stationfelt:str=%s\n",str);
		fflush(logfil);
	}
	return;
}

/* ******************************************** */
static void rel_firma_email(funk,langstr,emailadr,fkundenr)
short int funk;
char * langstr;
char * emailadr;
long int fkundenr; {
	short int okflag = 1;
	short int funkretur = 0;
	long int pkundenr = 0;
	char password[21] = "";

	if (logfil) {
		fprintf(logfil,
			"rel_firma_email:funk=%hd,email=%s,fkundenr=%ld\n",
			funk,
			emailadr,
			fkundenr);
		fflush(logfil);
	}
	okflag = 1;
	reclow(r167, R167);
	f167_start(1, ISGTEQ);
	r167->kunde_nr = fkundenr;
	egeread(f167, ISEQUAL);
	if (f167_ukendt) {
		okflag = -1;
	}
	if (okflag<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)okflag);
		pack_exchkend();
		send_linie();
		return;
	}

	okflag = 0;
	reclow(r178, R178);
	r178->opl_kode = 10;
	strcpy(r178->alfa_felt, emailadr);
	f178_start(4, ISGTEQ);
	if (f178_ukendt) {
		okflag = -1;
	}
	while (okflag==0) {
		egeread(f178, ISNEXT);
		if (f178_eof) {
			break;
		}
		if (strcmp(r178->alfa_felt, emailadr)!=0) {
			break;
		}
		if (r178->opl_kode!=10) {
			continue;
		}
		if (r178->kunde_nr<=0) {
			continue;
		}
		pkundenr = r178->kunde_nr;
		okflag = 1;
	}
	if (okflag<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)0);
		pack_exchkend();
		send_linie();
		return;
	}
	okflag = 1;
	reclow(r167, R167);
	r167->kunde_nr = pkundenr;
	egeread(f167, ISEQUAL+ISLOCK);
	if (f167_ukendt) {
		okflag = 0;
	}
	if (okflag<=0) {
		egerel(f167);
	} else {
		r167->firma_reference = fkundenr;
		egerew(f167);
		egerel(f167);
	}
	alfalow(str);
	pack_init(str);
	pack_int2((long)okflag);
	pack_exchkend();
	send_linie();
/* NYT 040609 */
	if (okflag>0) {
		funkretur = find_r178(1,45,0,(double)pkundenr);
		if (funkretur>0 && strlen(r178->alfa_felt)) {
			strcpy(password, r178->alfa_felt);
		}
	}
	if (okflag>0 && strlen(password)) {
		(void)send_password(2,langstr,emailadr,password,0);
	}
	return;
}

/* ***************************************** */
static int don2_check_dau(short keynr,char *nrstr,char *navnstr) {
	int retur = 0;
	long int chknr = 0;
	long int nuvnr = 0;

	if (logfil) {
		fprintf(logfil,
		"don2_check_dau keynr=%hd nrstr=<%s> navnstr=<%s>\n",
		keynr,
		nrstr,
		navnstr);
	}
	reclow(r167, R167);
	if (keynr==1) {
		sscanf(nrstr,"%ld",&chknr);
		r167->kunde_nr = chknr;
	}
	if (keynr==6) {
		strcpy(r167->kkortnr,nrstr);
	}
	f167_start(keynr, ISGTEQ);
	if (f167_ukendt) {
		retur = -1;
	}
	while (retur==0) {
		egeread(f167, ISNEXT);
		if (f167_eof) {
			break;
		}
		if (keynr==1 && r167->kunde_nr!=chknr) {
			break;
		}
		if (keynr==6 && strcmp(r167->kkortnr, nrstr)!=0) {
			break;
		}
		if (r167->status<2 || r167->status>4) {
			continue;
		}
		retur = r167->status;
		nuvnr = r167->kunde_nr;
	}
	if (logfil) {
		fprintf(logfil,"\tnuvnr=%ld\n",nuvnr);
		fprintf(logfil,"don2_check_dau:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ******************************************************************** */
/* inpfunk 1 person 1=kkortnr 2=fdato					*/
static int don2_check_kundefindes(int inpfunk,char *inpid1,char *inpid2) {
	int retur = 0;
	int wx1 = 0;
	int wx2 = 0;
	int keynr = 0;
	int fundet = 0;
	int kundetype = 0;
	int kundebrand = 0;
	long int kundenr = 0;
	int readantal = 0;
	char chkid1[41] = "";
	char chkid2[41] = "";
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil,"don2_check_kundefindes:%d %s %s\n",
			inpfunk,
			inpid1,
			inpid2);
	}
	reclow(r178,R178);
	f178_start(1,ISGTEQ);
	reclow(r167,R167);
	f167_start(1,ISGTEQ);
	if (inpfunk==1) {
		kundetype = 1;
		strcpy(chkid1,inpid1);
		egechartest((unsigned char *)chkid1);
		ege_toupper((unsigned char *)chkid1);

		strcpy(r167->kkortnr,chkid1);
		keynr = 6;
	}
	wx1 = 0;
	wx2 = 0;
	while (inpfunk==1 && kundetype==1 && wx1<strlen(inpid2)) {
		if (inpid2[wx1]>='0' && inpid2[wx1]<='9') {
			chkid2[wx2] = inpid2[wx1];
			wx2++;
			chkid2[wx2] = '\0';
		}
		wx1++;
	}
	if (logfil) {
		fprintf(logfil,"\tkeynr=%d\n",keynr);
	}
	if (keynr>0 && keynr<100) {
		f167_start(keynr,ISGTEQ);
	}
	while (keynr>0 && keynr<100 && kundenr<=0) {
		egeread(f167,ISNEXT);
		readantal++;
		if (f167_eof) {
			break;
		}
		if (logfil) {
			fprintf(logfil,"\t\t%d kunde_nr=%ld\n",
				readantal,
				r167->kunde_nr);
			fprintf(logfil,"\t\t%s\n",r167->kkortnr);
		}
		if (keynr==6 && strcmp(r167->kkortnr,chkid1)!=0) {
			break;
		}
		if (kundetype==1 && r167->type!=1) {
			continue;
		}
		if (kundetype==2 && r167->type!=2) {
			continue;
		}
		kundebrand = check_sy_kundenr((long int)r167->kunde_nr);
		if (logfil) {
			fprintf(logfil,"\t\tkundebrand=%d\n",
				kundebrand);
		}
		if (kundebrand<=0) {
			continue;
		}
		if (logfil) {
			fprintf(logfil,"\t\tfdato=%ld ID2=%s\n",
				r167->foedselsdato,
				chkid2);
		}
		ege_w_int1 = m036_funktion(17,(long int)r167->foedselsdato);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		if (logfil) {
			fprintf(logfil,"\t\ttmpstr=%s\n",
				tmpstr);
			fprintf(logfil,"\t\tnavn_2=%s\n",
				r167->navn_2);
		}
/* RETTET 130115 CHECKKKNR
		if (kundetype==1 && inpfunk==1 &&
			strcmp(chkid2,tmpstr)!=0) {
			continue;
		}
*/
		fundet = 1;
		kundenr = r167->kunde_nr;
	}
	if (logfil) {
		fprintf(logfil,"\tfundet=%d\n",fundet);
		fprintf(logfil,"\tkundenr=%ld\n",kundenr);
	}
	if (fundet>0 && kundenr>0) {
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"don2_check_kundefindes:retur=%d\n",
			retur);
		fflush(logfil);
	}
	return(retur);
}

/* ******************************************************************** */
/* inpfunk 2 firma 1=navn 2=adr1 3=postnr				*/
static int don2_check_firmafindes(int inpfunk,char *inpid1,char *inpid2,char *inpid3) {
	int retur = 0;
	int wx1 = 0;
	int wx2 = 0;
	int keynr = 0;
	int fundet = 0;
	int kundetype = 0;
	int kundebrand = 0;
	long int kundenr = 0;
	int readantal = 0;
	char chkid1[41] = "";
	char chkid2[41] = "";
	char chkid3[41] = "";
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil,"don2_check_firmafindes:%d <%s> <%s> <%s>\n",
			inpfunk,
			inpid1,
			inpid2,
			inpid3);
	}
	reclow(r178,R178);
	f178_start(1,ISGTEQ);
	reclow(r167,R167);
	f167_start(1,ISGTEQ);
	if (inpfunk==1) {
		kundetype = 2;
		strcpy(chkid1,inpid1);
		egechartest((unsigned char *)chkid1);
		ege_toupper((unsigned char *)chkid1);
                bss_konv_txt(1,chkid1);
		strcpy(chkid2,inpid2);
		egechartest((unsigned char *)chkid2);
		ege_toupper((unsigned char *)chkid2);
                bss_konv_txt(4,chkid2);
		strcpy(chkid3,inpid3);
		egechartest((unsigned char *)chkid3);
		ege_toupper((unsigned char *)chkid3);
                bss_konv_txt(5,chkid3);
		strcpy(r167->navn_2,chkid1);
		r167->navn_2[10] = '\0';
		keynr = 2;
	}
	if (logfil) {
		fprintf(logfil,"\tkeynr=%d\n",keynr);
		fprintf(logfil,"\tkundetype=%d\n",kundetype);
		fprintf(logfil,"\tchkid1=%s\n",chkid1);
	}
	if (keynr>0 && keynr<100) {
		f167_start(keynr,ISGTEQ);
	}
	while (keynr>0 && keynr<100 && kundenr<=0) {
		egeread(f167,ISNEXT);
		readantal++;
		if (f167_eof) {
			break;
		}
		if (logfil) {
			fprintf(logfil,"\t\t%d kunde_nr=%ld\n",
				readantal,
				r167->kunde_nr);
			fprintf(logfil,"\t\t%s\n",r167->navn_2);
		}
		if (keynr==2 && strncmp(r167->navn_2,chkid1,strlen(chkid1))>0) {
			break;
		}
/* RETTET 131114 DOBBELFIRMAOPRET
		if (keynr==2 && strcmp(r167->navn_2,chkid1)!=0) {
			break;
		}
*/
		if (kundetype==1 && r167->type!=1) {
			continue;
		}
		if (kundetype==2 && r167->type!=2) {
			continue;
		}
		kundebrand = check_sy_kundenr((long int)r167->kunde_nr);
		if (logfil) {
			fprintf(logfil,"\t\tkundebrand=%d\n",
				kundebrand);
		}
		if (kundebrand<=0) {
			continue;
		}
		if (logfil) {
			fprintf(logfil,"\t\tadr-1=%s ID2=%s\n",
				r167->adr_1,
				chkid2);
		}
		if (strlen(chkid2) && strcmp(r167->adr_1,chkid2)!=0) {
			continue;
		}
		if (logfil) {
			fprintf(logfil,"\t\tpostnr=%s ID3=%s\n",
				r167->adr_1,
				chkid3);
		}
		if (strlen(chkid3) && strcmp(r167->postkode,chkid3)!=0) {
			continue;
		}
		fundet = 1;
		kundenr = r167->kunde_nr;
	}
	if (logfil) {
		fprintf(logfil,"\tfundet=%d\n",fundet);
		fprintf(logfil,"\tkundenr=%ld\n",kundenr);
	}
	if (fundet>0 && kundenr>0) {
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"don2_check_firmafindes:retur=%d\n",
			retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************************** */
static int don2_kontrol_fref(int inpfunk,long inpknr,char *checkfelt) {
	int retur = 0;
	int fundet = 0;
	int readantal = 0;

	if (logfil) {
		fprintf(logfil,"don2_kontrol_fref %d %ld <%s>\n",
			inpfunk,inpknr,checkfelt); 
		fflush(logfil);
	}
	if (inpknr<=0) {
		retur = -1;
		goto afslut;
	}
	reclow(r178,R178);
	f178_start(1,ISGTEQ);
	reclow(r167,R167);
	r167->firma_reference = inpknr;
	f167_start(9,ISGTEQ);
	while (fundet==0) {
		egeread(f167,ISNEXT);
		readantal++;
		if (f167_eof) {
			break;
		}
		if (r167->firma_reference>inpknr) {
			break;
		}
		if (r167->firma_reference<inpknr) {
			continue;
		}
		if (r167->type!=1) {
			continue;
		}
		if (check_sy_kundenr(r167->kunde_nr)<=0) {
			continue;
		}
		reclow(r178,R178);
		f178_start(1,ISGTEQ);
		if (inpfunk==1) {
			r178->opl_kode = 10;
		}
		r178->kunde_nr = (double)r167->kunde_nr;
		egeread(f178,ISEQUAL);
		if (f178_ukendt) { continue; }
		if (f178_ok && inpfunk==1) {
			ege_tolower((unsigned char *)r178->alfa_felt);
		}
		if (f178_ok && inpfunk==1 &&
			strcmp(checkfelt,r178->alfa_felt)==0) {
			fundet = 1;
		}
	}
	if (logfil) {
		fprintf(logfil,"\tfundet=%d readantal=%d\n",fundet,readantal);
		fflush(logfil);
	}
	if (fundet==0) {
		reclow(r167,R167);
		f167_start(1,ISGTEQ);

		reclow(r178,R178);
		r178->opl_kode = 64;
		f178_start(2,ISGTEQ);
	}
	while (fundet==0) {
		egeread(f178,ISNEXT);
		readantal++;
		if (f178_eof) {
			break;
		}
		if (r178->opl_kode>64) {
			break;
		}
		if (r178->num_felt!=(double)inpknr) {
			continue;
		}
		r167->kunde_nr = (long int)r178->kunde_nr;
		egeread(f167,ISEQUAL);
		if (f167_ukendt) {
			continue;
		}
		if (r167->type!=1) {
			continue;
		}
		reccpy(&q178,r178,R178);
		if (check_sy_kundenr(r167->kunde_nr)<=0) {
			continue;
		}
		reclow(r178,R178);
		f178_start(1,ISGTEQ);
		if (inpfunk==1) {
			r178->opl_kode = 10;
		}
		r178->kunde_nr = (double)r167->kunde_nr;
		egeread(f178,ISEQUAL);
		if (f178_ukendt) { continue; }
		if (f178_ok && inpfunk==1) {
			ege_tolower((unsigned char *)r178->alfa_felt);
		}
		if (f178_ok && inpfunk==1 &&
			strcmp(checkfelt,r178->alfa_felt)==0) {
			fundet = 1;
		}
		reccpy(r178,&q178,R178);
		f178_start(2, ISGREAT);
		if (f178_ukendt) {
			break;
		}
	}
	if (logfil) {
		fprintf(logfil,"\tfundet=%d readantal=%d\n",fundet,readantal);
		fflush(logfil);
	}
	if (fundet>0) {
		retur = 1;
	}
afslut:
	if (logfil) {
		fprintf(logfil,"don2_kontrol_fref retur=%d\n",
			retur); 
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************************** */
static int don2_firma_kundenr() {
	int retur = 0;
	int okflag = 0;
	int fundet = 0;
	long int firmakundenr = 0;
	long int medarbkundenr = 0;
	char firmamailadr[81] = "";
	char firmaansv[81] = "";
	char firmanavn[81] = "";
	char firmaadr[81] = "";
	char firmapostnr[81] = "";
	char medarbmailadr[81] = "";
	char checkmailadr[81] = "";
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil,"don2_firma_kundenr\n");
		fprintf(logfil,"\tws_maxparatab=%d\n",ws_maxparatab);
		fflush(logfil);
	}
	reclow(r178,R178);
	f178_start(1,ISGTEQ);
	reclow(r167,R167);
	f167_start(1,ISGTEQ);
	if (ws_maxparatab==0) {
		strcpy(firmanavn,ws_paratab[0]);
	}
	if (ws_maxparatab==1) {
		strcpy(firmanavn,ws_paratab[0]);
		strcpy(checkmailadr,ws_paratab[1]);
	}
	if (ws_maxparatab==2) {
		strcpy(firmanavn,ws_paratab[0]);
		strcpy(firmaadr,ws_paratab[1]);
		strcpy(checkmailadr,ws_paratab[2]);
	}
	if (ws_maxparatab==3) {
		strcpy(firmanavn,ws_paratab[0]);
		strcpy(firmaadr,ws_paratab[1]);
		strcpy(firmapostnr,ws_paratab[2]);
		strcpy(checkmailadr,ws_paratab[3]);
	}
	ege_tolower((unsigned char *)checkmailadr);
	if (logfil) {
		fprintf(logfil,"\tfirmanavn=%s\n",firmanavn);
		fprintf(logfil,"\tfirmaadr=%s\n",firmaadr);
		fprintf(logfil,"\tfirmapostnr=%s\n",firmapostnr);
		fprintf(logfil,"\tcheckmailadr=%s\n",checkmailadr);
	}
	okflag = 0;
	if (strlen(firmanavn)) { okflag++; }
	if (strlen(checkmailadr)) { okflag++; }
	if (logfil) {
		fprintf(logfil,"\tokflag=%d\n",okflag);
	}

	if (okflag<2) {
		ws_don2errno = DON2COMMGL;
	}
/*
	if (ws_maxparatab<2) {
		ws_don2errno = DON2COMMGL;
	}
*/
	if (ws_don2errno<=0 &&
		don2_check_firmafindes(1,firmanavn,firmaadr,firmapostnr)<=0) {
		ws_don2errno = DON2COMUK;
	}
	if (ws_don2errno>0) {
		ws_funkretur2 = frankly_err(ws_funktion,"fejl",ws_don2errno);
		retur = 1;
		goto afslut;
	}
	firmakundenr = r167->kunde_nr;
	if (logfil) {
		fprintf(logfil,"\tfirmakundenr=%ld\n",firmakundenr);
		fflush(logfil);
	}
	r178->kunde_nr = (double)firmakundenr;
	r178->opl_kode = 10;
	egeread(f178,ISEQUAL);
/*
	if (f178_ukendt) {
		ws_don2errno = DON2COMEMGL;
	}
	if (f178_ok && !strlen(r178->alfa_felt)) {
		ws_don2errno = DON2COMEMGL;
	}
	if (logfil) {
		fprintf(logfil,"\tws_don2errno=%ld\n",ws_don2errno);
		fflush(logfil);
	}
	if (ws_don2errno>0) {
		ws_funkretur2 = frankly_err(ws_funktion,"fejl",ws_don2errno);
		retur = 1;
		goto afslut;
	}
*/
	if (f178_ok && strlen(r178->alfa_felt)) {
		strcpy(firmamailadr,r178->alfa_felt);
		ege_tolower((unsigned char *)firmamailadr);
	}
	if (logfil) {
		fprintf(logfil,"\tfirmamailadr=%s\n",firmamailadr);
		fflush(logfil);
	}
	strcpy(firmaansv,"?");
	r178->kunde_nr = (double)firmakundenr;
	r178->opl_kode = 100;
	egeread(f178,ISEQUAL);
	if (f178_ok && strlen(r178->alfa_felt)) {
		strcpy(firmaansv,r178->alfa_felt);
	}
	if (logfil) {
		fprintf(logfil,"\tfirmaansv=%s\n",firmaansv);
		fflush(logfil);
	}
	if (strcmp(firmamailadr,checkmailadr)==0) {
		fundet = 1;
	}
	if (fundet==0 && don2_kontrol_fref(1,firmakundenr,checkmailadr)>0) {
		fundet = 1;
	}
/* NYT 121017 */
	if (fundet<=0) {
		ws_don2errno = DON2COMANSV;
	}
	if (ws_don2errno>0) {
		sprintf(tmpstr,"kontakt venligst %s for login-opl.",firmaansv);
		ws_funkretur2 = frankly_err(ws_funktion,tmpstr,ws_don2errno);
		retur = 1;
		goto afslut;
	}
	alfalow(str);
	pack_init(str);
	if (fundet>0) {
		pack_int2((long)firmakundenr);
		sprintf(tmpstr,"FirmaLogin kundenr er %ld",firmakundenr);
		pack_alfa(tmpstr);
	}
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	retur++;
afslut:
	if (logfil) {
		fprintf(logfil,"don2_firma_kundenr:retur=%d\n", retur);
		fflush(logfil);
	}
	return(retur);
}

/* ********************************************************* */
static int don2_login() {
	int retur = 0;
	int wx1 = 0;
	int wx2 = 0;
	int readantal = 0;
	int keynr = 0;
	int fundet = 0;
	int ploginsetup = 1;
	int floginsetup = 1;
	int kundebrand = 0;
	int extrakonvflag = 0;
	long int kundenr = 0;
	long int chkkundenr = 0;
	char nyid1[41] = "";
	char chkid1[41] = "";
	char chkid2[41] = "";
	char chkfelt[41] = "";
	char tmpstr[81] = "";
	char tmpstr2[81] = "";

	if (logfil) {
		fprintf(logfil,"don2_login\n");
		fprintf(logfil,"\tws_logintype=%hd\n",ws_logintype);
		fprintf(logfil,"\tws_loginid1=%s\n",ws_loginid1);
		fprintf(logfil,"\tws_loginid2=%s\n",ws_loginid2);
		fprintf(logfil,"\tploginsetup=%d\n",ploginsetup);
		fprintf(logfil,"\tfloginsetup=%d\n",floginsetup);
	}
	wx1 = 0;
	wx2 = 0;
	while (ws_logintype==1 && ploginsetup==1 && wx1<strlen(ws_loginid2)) {
		if (ws_loginid2[wx1]>='0' && ws_loginid2[wx1]<='9') {
			chkid2[wx2] = ws_loginid2[wx1];
			wx2++;
			chkid2[wx2] = '\0';
		}
		wx1++;
	}
/* NYT 140627 KONVDKTGN	*/
	if (ws_logintype==2 && floginsetup==1 && access("don2konvogok",0)==0) {
		strcpy(nyid1,ws_loginid1);
		if (konv_asciiog(nyid1)>0) {
			strcpy(ws_loginid1,nyid1);
		}
	}
	if (logfil) {
		fprintf(logfil,"\tnyid1=%s\n",nyid1);
		fprintf(logfil,"\tws_loginid1=%s\n",ws_loginid1);
	}
	if (ws_logintype==2 && floginsetup==1) {
		strcpy(chkid1,ws_loginid1);
/* NYT 140627 KONVDKTGN */
		if (logfil) {
			fprintf(logfil,"\tFØRHTML8859 chkid1=%s\n",
				chkid1);
			fprintf(logfil,"\tFØRHTML8859 ws_loginid1=%s\n",
				ws_loginid1);
		}
		strcpy(chkid1,
			(char *) konvert_ext_html_til_8859(ws_loginid1));
/* NYT 130311 KONV8859LOGIN */
		if (logfil) {
			fprintf(logfil,"\tFØRASCII8859 chkid1=%s\n",
				chkid1);
			fprintf(logfil,"\tFØRASCII8859 ws_loginid1=%s\n",
				ws_loginid1);
		}
		strcpy(ws_loginid1,chkid1);
		strcpy(chkid1,
			(char *) konvert_ext_ascii_til_8859(ws_loginid1));
		if (logfil) {
			fprintf(logfil,"\tFØRBSSKONVTXT chkid1=%s\n",
				chkid1);
			fprintf(logfil,"\tFØRBSSKONVTXT ws_loginid1=%s\n",
				ws_loginid1);
		}
		bss_konv_txt(1,chkid1);
	}
	if (logfil) {
		fprintf(logfil,"\tchkid1=%s\n",chkid1);
		fprintf(logfil,"\tchkid2=%s\n",chkid2);
	}
	reclow(r178,R178);
	f178_start(1,ISGTEQ);
	reclow(r167,R167);
	f167_start(1,ISGTEQ);
	if (ws_logintype==1 && ploginsetup==1) {
		egechartest((unsigned char *)ws_loginid1);
		ege_toupper((unsigned char *)ws_loginid1);

		strcpy(r167->kkortnr,ws_loginid1);
		keynr = 6;
	}
	if (ws_logintype==2 && floginsetup==1) {
		egechartest((unsigned char *)ws_loginid1);
		ege_toupper((unsigned char *)ws_loginid1);

		sscanf(ws_loginid2,"%ld",&chkkundenr);
		r167->kunde_nr = chkkundenr;
		keynr = 1;
	}
	if (logfil) {
		fprintf(logfil,"\tkeynr=%d\n",keynr);
		fprintf(logfil,"\tr167->kunde_nr=%ld\n",r167->kunde_nr);
		fprintf(logfil,"\tr167->kkortnr=%s\n",r167->kkortnr);
	}
	if (keynr>0 && keynr<100) {
		f167_start(keynr,ISGTEQ);
	}
	while (keynr>0 && keynr<100 && kundenr<=0) {
		egeread(f167,ISNEXT);
		readantal++;
		if (f167_eof) {
			break;
		}
		if (logfil) {
			fprintf(logfil,"\t\t%d kunde_nr=%ld\n",
				readantal,
				r167->kunde_nr);
			fprintf(logfil,"\t\t%s\n",r167->kkortnr);
		}
		if (keynr==6 && strcmp(r167->kkortnr,ws_loginid1)!=0) {
			break;
		}
		if (keynr==1 && r167->kunde_nr!=chkkundenr) {
			break;
		}

		if (ws_logintype==1 && r167->type!=1) {
			continue;
		}
		if (ws_logintype==2 && r167->type!=2) {
			continue;
		}
		kundebrand = check_sy_kundenr((long int)r167->kunde_nr);
		if (logfil) {
			fprintf(logfil,"\t\tkundebrand=%d\n",
				kundebrand);
		}
		if (kundebrand<=0) {
			continue;
		}
		if (logfil) {
			fprintf(logfil,"\t\tfdato=%ld ID2=%s\n",
				r167->foedselsdato,
				chkid2);
		}
		ege_w_int1 = m036_funktion(17,(long int)r167->foedselsdato);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		if (logfil) {
			fprintf(logfil,"\t\ttmpstr=%s\n",
				tmpstr);
			fprintf(logfil,"\t\tnavn_2=%s\n",
				r167->navn_2);
		}
		wx1 = 0;
		if (ws_logintype==1 && ploginsetup==1 &&
			strcmp(chkid2,tmpstr)!=0) {
			wx1 = 1;
		}
/* NYT 121112 */
		if (wx1==1 && ws_logintype==1 && ploginsetup==1) {
			strcpy(tmpstr2,tmpstr+6);
			tmpstr[4] = '\0';
			strcat(tmpstr,tmpstr2);
		}
		if (logfil) {
			fprintf(logfil,"\t\twx1=%hd tmpstr=%s\n",
				wx1,
				tmpstr);
		}
		if (wx1==1 && ws_logintype==1 && ploginsetup==1 &&
			strcmp(chkid2,tmpstr)==0) {
			wx1 = 0;
		}
		if (wx1>0) {
			continue;
		}

		if (ws_logintype==2 && floginsetup==1) {
/* NYT 120928 */
			strcpy(chkfelt,r167->navn_2);
			bss_konv_txt(1,chkfelt);
		}
		if (ws_logintype==2 && floginsetup==1 &&
			strncmp(chkfelt,chkid1,3)!=0) {
			continue;
		}
		fundet = 1;
		kundenr = r167->kunde_nr;
	}
	if (logfil) {
		fprintf(logfil,"\tfundet=%d\n",fundet);
		fprintf(logfil,"\tkundenr=%ld\n",kundenr);
	}
/* NYT 131114 STATUS19 */
	if (fundet>0 && kundenr>0 && ws_logintype==2 && r167->status==19) {
		ege_w_int1 = DON2LOGUK;
		ege_w_int1++;
/*
		ws_funkretur2 = frankly_err(ws_funktion,
                                "fejl",ege_w_int1);
*/
		alfalow(str);
		pack_init(str);
		pack_alfa("ERR");
		pack_int2((long)70001);
		strcpy(tmpstr,"Brug venligst et andet kundenr");
		if (strlen(r167->bem)) {
			strcpy(tmpstr,r167->bem);
		}
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
		goto afslut;
	}
	if (fundet>0 && kundenr>0 && ws_logintype==1) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)kundenr);
		pack_int2((long)0);
		strcpy(tmpstr,"DA");
		pack_alfa(tmpstr);
		pack_alfa(r167->navn_1);
		pack_alfa(r167->navn_2);
		pack_alfa(r167->adr_1);
		pack_alfa(r167->adr_2);
		pack_alfa(r167->postkode);
		pack_alfa(r167->by);
/* NYT 120926 */
		pack_alfa(r167->land);

		pack_alfa(r167->tlf);
/* NYT 120926 MobilePhoneNr */
		strcpy(tmpstr,"");
/* NYT 121101 */
		if (find_r178(1,65,0,(double)r167->kunde_nr)>0) {
			strcpy(tmpstr,r178->alfa_felt);
		}
		pack_alfa(tmpstr);
/* Fax */
/* RETTET 120926
		strcpy(tmpstr,"");
		if (find_r178(1,9,0,(double)r167->kunde_nr)>0) {
			strcpy(tmpstr,r178->alfa_felt);
		}
		pack_alfa(tmpstr);
*/
/* Email */
		strcpy(tmpstr,"");
		if (find_r178(1,10,0,(double)r167->kunde_nr)>0) {
			strcpy(tmpstr,r178->alfa_felt);
		}
		pack_alfa(tmpstr);
/* DriverLicense */
		pack_alfa(r167->kkortnr);
/* Birthdate Fdato */
		ege_w_int1 = m036_funktion(17,(long int)r167->foedselsdato);
		sprintf(tmpstr,"%8.8ld",ege_w_int1);
		pack_alfa(tmpstr);
/* NewsLetter */
/*		strcpy(tmpstr,"False"); */
		strcpy(tmpstr,"0");
		if (find_r178(1,40,0,(double)r167->kunde_nr)>0) {
			if (r178->num_felt<=1) {
/*				strcpy(tmpstr,"True"); */
				strcpy(tmpstr,"1");
			}
		} else {
/*			strcpy(tmpstr,"True"); */
			strcpy(tmpstr,"1");
		}
		pack_alfa(tmpstr);
/* SMS-service */
/*		strcpy(tmpstr,"False"); */
		strcpy(tmpstr,"0");
		if (find_r178(1,66,0,(double)r167->kunde_nr)>0) {
			if (r178->num_felt>=1) {
/*				strcpy(tmpstr,"True"); */
				strcpy(tmpstr,"1");
			}
		}
		pack_alfa(tmpstr);

		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
	}
	if (fundet>0 && kundenr>0 && ws_logintype==2) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)kundenr);
		pack_int2((long)0);
		strcpy(tmpstr,"DA");
		pack_alfa(tmpstr);
		pack_alfa(r167->navn_2);
/* RETTET 121101
		pack_alfa("");
*/
		pack_alfa(r167->adr_1);
		pack_alfa(r167->adr_2);
		pack_alfa(r167->postkode);
		pack_alfa(r167->by);
/* NYT 120926 */
		pack_alfa(r167->land);
		pack_alfa(r167->tlf);
/* NYT 120926 MobilePhoneNr */
		strcpy(tmpstr,"");
/* NYT 121101 */
		if (find_r178(1,65,0,(double)r167->kunde_nr)>0) {
			strcpy(tmpstr,r178->alfa_felt);
		}
		pack_alfa(tmpstr);
/* Fax */
/* RETTET 120926
		strcpy(tmpstr,"");
		if (find_r178(1,9,0,(double)r167->kunde_nr)>0) {
			strcpy(tmpstr,r178->alfa_felt);
		}
		pack_alfa(tmpstr);
*/
/* Email */
		strcpy(tmpstr,"");
		if (find_r178(1,10,0,(double)r167->kunde_nr)>0) {
			strcpy(tmpstr,r178->alfa_felt);
		}
		pack_alfa(tmpstr);
/* DriverLicense */
/*		pack_alfa(""); */
/* Birthdate Fdato */
/*		pack_int2((long)0); */
/* CVR */
		strcpy(tmpstr,"");
		if (find_r178(1,1,0,(double)r167->kunde_nr)>0 &&
			r178->num_felt>0) {
			sprintf(tmpstr,"%.0lf",r178->num_felt);
		}
		pack_alfa(tmpstr);
/* NewsLetter */
/*		strcpy(tmpstr,"False"); */
		strcpy(tmpstr,"0");
		if (find_r178(1,40,0,(double)r167->kunde_nr)>0) {
			if (r178->num_felt<=1) {
/*				strcpy(tmpstr,"True"); */
				strcpy(tmpstr,"1");
			}
		} else {
/*			strcpy(tmpstr,"True"); */
			strcpy(tmpstr,"1");
		}
		pack_alfa(tmpstr);
/* SMS-service */
/*		strcpy(tmpstr,"False"); */
		strcpy(tmpstr,"0");
		if (find_r178(1,66,0,(double)r167->kunde_nr)>0) {
			if (r178->num_felt>=1) {
/*				strcpy(tmpstr,"True"); */
				strcpy(tmpstr,"1");
			}
		}
		pack_alfa(tmpstr);
/* NYT 121024 */
/* Contact */
		strcpy(tmpstr,"");
		if (find_r178(1,100,0,(double)r167->kunde_nr)>0 &&
			strlen(r178->alfa_felt)) {
			strcpy(tmpstr,r178->alfa_felt);
		}
		pack_alfa(tmpstr);
/* ContactInfo */
		strcpy(tmpstr,"");
		if (find_r178(1,101,0,(double)r167->kunde_nr)>0 &&
			strlen(r178->alfa_felt)) {
			strcpy(tmpstr,r178->alfa_felt);
		}
		pack_alfa(tmpstr);

		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
	}
	if (fundet<=0) {
		ege_w_int1 = DON2LOGUK;
		ws_funkretur2 = frankly_err(ws_funktion,
                                "fejl",ege_w_int1);

		alfalow(str);
		pack_init(str);
		pack_alfa("ERR");
		pack_int2((long)70001);
		strcpy(tmpstr,"Kunde ikke fundet");
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		retur++;
	}
afslut:
	if (logfil) {
		fprintf(logfil,"don2_login:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* NYT 140627 KONVDKTGN	*/
/* ************************************** */
static int konv_asciiog(char *inpstr) {
	int retur = 0;
	int antal = 0;
	int funkretur = 0;
	int ogstrengant = 0;
	int idx = 0;
	char workstr[81] = "";
	char ogstreng[21] = "";
	char gembuffer1[81] = "";
	char gembuffer2[81] = "";

	if (logfil) {
		fprintf(logfil,"konv_asciiog <%s>\n",inpstr);
	}
	strcpy(workstr,inpstr);
	sprintf(ogstreng,"%c%c0026",92,117);
	ogstrengant = strlen(ogstreng);
	if (logfil) {
		fprintf(logfil,"\tworkstr=<%s>\n",workstr);
		fprintf(logfil,"\togstreng=<%s>\n",ogstreng);
		fprintf(logfil,"\togstrengant=%d\n",ogstrengant);
	}
	idx = 0;
	while (logfil && idx<strlen(workstr)) {
		fprintf(logfil,"\t\tworkstr-%d=%d (%c)\n",
			idx,
			workstr[idx],
			workstr[idx]);
		idx++;
	}
	antal = 0;
	while (antal<100) {
		funkretur = chscan(workstr,ogstreng);
		if (logfil) {
			fprintf(logfil,"\t\tantal=%d funkretur=%d\n",
				antal,
				funkretur);
		}
		if (funkretur<=0) {
			break;
		}
		strcpy(gembuffer2,workstr+funkretur);
		strcpy(gembuffer1,workstr);
		gembuffer1[funkretur-ogstrengant] = '\0';
		sprintf(workstr,"%s%c%s",gembuffer1,38,gembuffer2);
		if (logfil) {
			fprintf(logfil,"\t\tgembuffer1=<%s>\n",gembuffer1);
			fprintf(logfil,"\t\tgembuffer2=<%s>\n",gembuffer2);
			fprintf(logfil,"\t\tworkstr=<%s>\n",workstr);
		}
		antal++;
	}
	if (antal>0) {
		strcpy(inpstr,workstr);
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"\tantal=%d\n",antal);
		fprintf(logfil,"konv_asciiog retur=%d inpstr=<%s>\n",
			retur,
			inpstr);
	}
	return(retur);
}

/* ******************************************** */
/* funk 1 check password			*/
/*	2 send password pr email		*/
/* ******************************************** */
static void check_kundelogon(funk,langstr,emailadr,password)
short int funk;
char * langstr;
char * emailadr;
char * password; {
	long int kundenr = 0;
	short int okflag = 0;
	short int nytokflag = 0;
	short int funkretur = 0;
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil,
			"check_kundelogon:funk=%hd,langstr=%s,email=%s\n",
			funk,
			langstr,
			emailadr);
		fflush(logfil);
	}
	kundenr = find_evt_bssnr(emailadr);
	if (kundenr>0) {
		okflag = 1;
	}
	reclow(r167, R167);
	f167_start(1, ISGTEQ);
	if (kundenr<=0) {
		reclow(r178, R178);
		r178->opl_kode = 10;
		strcpy(r178->alfa_felt, emailadr);
		f178_start(4, ISGTEQ);
		if (f178_ukendt) {
			okflag = -1;
		}
	}
	while (okflag==0 && kundenr<=0) {
		egeread(f178, ISNEXT);
		if (f178_eof) {
			break;
		}
		if (strcmp(r178->alfa_felt, emailadr)!=0) {
			break;
		}
		if (r178->opl_kode!=10) {
			continue;
		}
		if (r178->kunde_nr<=0) {
			continue;
		}
		if (logfil) {
			fprintf(logfil,
				"check_kundelogon:r178,kundenr=%.0lf\n",
				r178->kunde_nr);
			fflush(logfil);
		}
/* NYT 050815 */
		r167->kunde_nr = (long int)r178->kunde_nr;
		if (logfil) {
			fprintf(logfil,
				"check_kundelogon:r167,kundenr=%ld\n",
				r167->kunde_nr);
			fflush(logfil);
		}
		egeread(f167, ISEQUAL);
		if (f167_ukendt) {
			add_donlogin_log((long int)r178->kunde_nr,
				emailadr,
				"F167UKENDT");
			continue;
		}
/* OBS CHECK KUNDETYPE */
		if (r167->type!=1) {
			add_donlogin_log((long int)r178->kunde_nr,
				emailadr,
				"TYPEFEJL");
			continue;
		}

/* check for SY */
		reccpy(&q178,r178,R178);
		if (check_sy_kundenr((long int)q178.kunde_nr)>0) {
			reccpy(r178,&q178,R178);
			kundenr = (long int)r178->kunde_nr;
			okflag = 1;
			break;
		}
		reccpy(r178,&q178,R178);
		f178_start(4, ISGREAT);
		if (f178_ukendt) {
			break;
		}
	}
	if (logfil) {
		fprintf(logfil,
			"check_kundelogon:okflag=%hd,kundenr=%ld\n",
			okflag,
			kundenr);
		fflush(logfil);
	}
	if (funk==2 && kundenr==0 && ws_funktion<300) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)okflag);
		strcpy(tmpstr, "UKENDT");
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		return;
	}
	if (funk==2 && kundenr==0 && ws_funktion>=300) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-305);
		web_errormess(0,ws_langstr,"305");
/* RETTET 070423
		pack_int2((long)-301);
		web_errormess(0,ws_langstr,"301");
*/
		pack_exchkend();
		send_linie();
		return;
	}



	if (funk==1 && kundenr>0) {
		r167->kunde_nr = kundenr;
		egeread(f167, ISEQUAL);
		if (f167_ukendt) {
			okflag = 0;
		}
	}
	if (funk==1 &&
		kundenr>0 &&
		okflag==1 &&
		r167->status==4) {
		okflag = -1;
	}
	if (funk==1 &&
		kundenr>0 &&
		okflag==1 &&
		r167->status==3) {
		okflag = -2;
	}
	if (funk==1 &&
		kundenr>0 &&
		okflag==1 &&
		r167->status==2) {
		okflag = -3;
	}
	if (kundenr>0 && okflag==1) {
		funkretur = find_r178(1,45,0,(double)kundenr);
		if (logfil) {
			fprintf(logfil,
				"check_kundelogon:funkretur=%hd\n",funkretur);
			fflush(logfil);
		}
		if (funkretur>0) {
			if (funk==2) {
				strcpy(password, r178->alfa_felt);
			}
			if (funk==1 &&
				strcmp(password, r178->alfa_felt)!=0) {
				okflag = -4;
			}
		} else {
			okflag = -4;
		}
	}
	if (logfil) {
		fprintf(logfil,
			"check_kundelogon:HERTIL-1\n");
		fflush(logfil);
	}
	if (funk==2 && kundenr>0 && okflag==1) {
		(void)send_password(2,langstr,emailadr,password,0);
	}
	if (logfil) {
		fprintf(logfil,
			"check_kundelogon:HERTIL-2\n");
		fflush(logfil);
	}
	if (kundenr>0 && okflag==1) {
		r167->kunde_nr = kundenr;
		egeread(f167, ISEQUAL);
	}
	alfalow(str);
	pack_init(str);
	if (ws_funktion<300) {
		pack_int2((long)okflag);
		if (okflag==1) {
			pack_int2((long)kundenr);
			sprintf(tmpstr, "%s %s", r167->navn_1, r167->navn_2);
			stednavn_form((unsigned char *)tmpstr);
			pack_alfa(tmpstr);
		}
		if (okflag==0) {
			strcpy(tmpstr, "UKENDT");
			pack_alfa(tmpstr);
		}
		if (okflag==-1||okflag==-2||okflag==-3) {
			strcpy(tmpstr, "BLACKLISTET");
			pack_alfa(tmpstr);
		}
		if (okflag==-4) {
			strcpy(tmpstr, "PASSWORD FEJL");
			pack_alfa(tmpstr);
		}
	} else {
		nytokflag = okflag;
		if (okflag==0) {
			nytokflag = -305;
/* RETTET 070423
			nytokflag = -301;
*/
		}
		if (okflag==-1) {
			nytokflag = -302;
		}
		if (okflag==-2) {
			nytokflag = -303;
		}
		if (okflag==-3) {
			nytokflag = -304;
		}
		if (okflag==-4) {
			nytokflag = -305;
		}
		if (nytokflag<1) {
			pack_int2((long)nytokflag);
			sprintf(tmpstr,"%hd",(nytokflag*-1));
			web_errormess(0,ws_langstr,tmpstr);
		} else {
			pack_int2((long)kundenr);
			sprintf(tmpstr, "%s %s", r167->navn_1, r167->navn_2);
			stednavn_form((unsigned char *)tmpstr);
			pack_alfa(tmpstr);
		}
	}
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil,
			"check_kundelogon:str=%s\n",
			str);
		fflush(logfil);
	}
	return;
}

/* ************ */
static long int find_evt_bssnr(emailstr)
char * emailstr; {
	short int wx1 = 0;
	short int wx2 = 0;
	long int bssnr = 0;
	char bssnrstr[81] = "";

	wx2 = 0;
	for (wx1=0;wx1<strlen(emailstr);wx1++) {
		if (emailstr[wx1]==64) {
			strcpy(bssnrstr, "");
			break;
		}
		if (emailstr[wx1]<=58 &&
			emailstr[wx1]>=48) {
			bssnrstr[wx2]=emailstr[wx1];
			wx2++;
			bssnrstr[wx2]='\0';
		}
	}
	if (strlen(bssnrstr)) {
		sscanf(bssnrstr, "%ld", &bssnr);
	}
	return((long int)bssnr);
}

/* ************************************ */
static void add_donlogin_log(nr,mailadr,fejltxt)
long int nr;
char * mailadr;
char * fejltxt; {
	FILE * donfil;

	donfil = (FILE*)0;
	donfil = fopen("donlogin.log", "a");
	if (!donfil) {
		return;
	}
	fprintf(donfil, "%ld", ws_systemdato);
	fprintf(donfil, "\t%ld", nr);
	fprintf(donfil, "\t%s", mailadr);
	fprintf(donfil, "\t%s", fejltxt);
	fprintf(donfil, "\n");
	fclose(donfil);
	donfil = (FILE*)0;
	return;
}

/* ************************************************ */
static void chksend_vagtmail(short stnr,long sysdt,long systd,long uddt,long udtd) {
	long int returdato = 0;
	long int julian = 0;
	short int sysdgnr = 0;
	short int uddgnr = 0;
	short int vagtstnr = 6;
	char emailadr[81] = "";
	char tmpstr[81] = "";
	char mailadr[81] = "";
	char afsender[41] = "";
	char host[21] = "";
	char emnestr[81] = "BSS Booking";
	char navnstr[81] = "BSS Server";
	FILE * mailfil;

	mailfil = (FILE*)0;
	if (logfil) {
		fprintf(logfil,
			"chksend_vagtmail:stnr=%hd,sys=%ld-%ld ud=%ld-%ld\n",
			stnr,
			sysdt,
			systd,
			uddt,
			udtd);
	}
	if (stnr!=25) {
		vagtstnr = 0;
	}
	julian = m036_funktion(12,sysdt);
	returdato = m036_funktion(11, sysdt);
        sysdgnr = (short int)(returdato%10);
	returdato = m036_funktion(11, uddt);
        uddgnr = (short int)(returdato%10);
	returdato = m036_funktion(12,uddt);
/* TEST
	if (returdato-julian>2) {
		vagtstnr = 0;
	}
	if (uddgnr>=1 && uddgnr<5) {
		vagtstnr = 0;
	}
	if (uddgnr==5 && udtd<2000) {
		vagtstnr = 0;
	}
	if (sysdgnr<5) {
		vagtstnr = 0;
	}
	if (sysdgnr==5 && systd<2000) {
		vagtstnr = 0;
	}
*/
	if (logfil) {
		fprintf(logfil,
			"chksend_vagtmail:vagtstnr=%hd\n", vagtstnr);
	}
	if (vagtstnr==0) {
		return;
	}

	if (ws_testkreds==1) {
		strcpy(emnestr,"TEST-BSS Booking-TEST");
	}
	reclow(r166,R166);
	f166_start(1,ISGTEQ);
	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	reclow(r198,R198);
	r198->oplkode = 16604;
	r198->keynum = (double)vagtstnr;
	egeread(f198,ISEQUAL);
	if (f198_ok && strlen(r198->alfafelt)) {
		strcpy(emailadr,r198->alfafelt);
	}
	if (logfil) {
		fprintf(logfil,
			"chksend_vagtmail:ws_testkreds=%hd,adr=%s\n",
			ws_testkreds,
			emailadr);
	}
	if (!strlen(emailadr)) {
		return;
	}
/* TEST */
	strcpy(emailadr,"mb@europcar.dk");
	strcpy(mailadr, emailadr);
	mailfil = (FILE*)0;
	sprintf(tmpstr, "/tmp/%hd.mail", ege_pid);
        mailfil = fopen(tmpstr, "w");
        if (!mailfil) {
		return;
        }
	if (ws_testkreds==1) {
		fprintf(mailfil,"!!!!! TEST TEST TEST !!!!!\n\n");
	}
	r166->stat_nr = vagtstnr;
	egeread(f166,ISEQUAL);
	if (f166_ok) {
		fprintf(mailfil,"Hej %s\n",r166->navn);
	} else {
		fprintf(mailfil,"Hej station %hd\n",stnr);
	}
	fprintf(mailfil,"\n");
	fprintf(mailfil,"Tirstrup har modtaget en Reservation.\n");
	fprintf(mailfil,"I bedes kontakte vagten i Tirstrup.\n");
	fprintf(mailfil,"\n");
	fprintf(mailfil,"Resnr: %ld\n",
		r159->record_x);
	fprintf(mailfil,"Navn: %s %s\n",
		r159->lejerfornavn,r159->lejerefternavn);
	fprintf(mailfil,"Tlf: %s\n",
		r159->lejertlf);
	fprintf(mailfil,"Bilgruppe: %s\n",
		r159->bil_grp);
	fprintf(mailfil,"Afh: ");
	ege_w_int1 = m036_funktion(17, (long int)r159->dato_ud);
	egeedit(ege_w_dou1 = ege_w_int1, "99.99.9999",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil," - ");
	sprintf(tmpstr,"%2.2ld:%2.2ld",
		r159->tid_ud/100,
		r159->tid_ud%100);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil,"\n");

	fprintf(mailfil,"Afl: ");
	ege_w_int1 = m036_funktion(17, (long int)r159->forv_dato_ind);
	egeedit(ege_w_dou1 = ege_w_int1, "99.99.9999",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil," - ");
	sprintf(tmpstr,"%2.2ld:%2.2ld",
		r159->forv_tid_ind/100,
		r159->forv_tid_ind%100);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil,"\n");

	fprintf(mailfil,"\n");
	fprintf(mailfil,"Hilsen\n");
	fprintf(mailfil,"BSS Book Online");
	if (ws_testkreds==1) {
		fprintf(mailfil," (beta.europcar.dk)");
	} else {
		fprintf(mailfil," (www.europcar.dk)");
	}
	fprintf(mailfil,"\n");
	fprintf(mailfil,"\n");
	fprintf(mailfil,"(Denne mail kan ikke besvares)\n");
	if (ws_testkreds==1) {
		fprintf(mailfil,"\n");
		fprintf(mailfil,"!!!!! TEST TEST TEST !!!!!\n\n");
	}
	if (mailfil) {
		fclose(mailfil);
		mailfil = (FILE*)0;
	}
	gethostname(host,20);
	(void)get_alfa_tgn(mailadr,1,tmpstr,64);
	if (!strlen(tmpstr)) {
		strcat(mailadr, "@");
		strcat(mailadr, host);
	}
	strcpy(afsender, "online");
	alfalow(str);
        sprintf(str,
"%s/egemail /plainmail:1 /p:%s?%s?%s?%s? /emne:%s /navn:%s /bodyfil:/tmp/%hd.mail\0",
		egeenv("EXECPATH"),
		egeenv("KREDS"),
		afsender,
		mailadr,
                host,
                emnestr,
		navnstr,
		ege_pid);
	if (logfil) {
		fprintf(logfil, "%s\n", str);
		fflush(logfil);
	}
	system(str);
	sprintf(tmpstr, "/tmp/%hd.mail", ege_pid);
	(void)unlink(tmpstr);
	if (logfil) {
		fprintf(logfil, "chksend_vagtmail:SLUT\n");
	}
	return;
}

/* ************************************************ */
static void send_station_mail(short stnr) {
	char emailadr[81] = "";
	char tmpstr[81] = "";
	char mailadr[81] = "";
	char afsender[41] = "";
	char host[21] = "";
	char emnestr[81] = "Online Booking";
	char navnstr[81] = "BSS Online Server";
	FILE * mailfil;

	mailfil = (FILE*)0;
	if (ws_testkreds==1) {
		strcpy(emnestr,"TEST-Online Booking-TEST");
	}
	reclow(r166,R166);
	f166_start(1,ISGTEQ);
	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	reclow(r198,R198);
	r198->oplkode = 16604;
	r198->keynum = (double)stnr;
	egeread(f198,ISEQUAL);
	if (f198_ok && strlen(r198->alfafelt)) {
		strcpy(emailadr,r198->alfafelt);
	}
	if (logfil) {
		fprintf(logfil,
			"send_station_mail:stnr=%hd,ws_testkreds=%hd,adr=%s\n",
			stnr,
			ws_testkreds,
			emailadr);
	}
	if (!strlen(emailadr)) {
		return;
	}
/* TEST */
/*
	strcpy(emailadr,"rl@europcar.dk");
*/
	strcpy(mailadr, emailadr);
	mailfil = (FILE*)0;
	sprintf(tmpstr, "/tmp/%hd.mail", ege_pid);
        mailfil = fopen(tmpstr, "w");
        if (!mailfil) {
		return;
        }
	if (ws_testkreds==1) {
		fprintf(mailfil,"!!!!! TEST TEST TEST !!!!!\n\n");
	}
	r166->stat_nr = stnr;
	egeread(f166,ISEQUAL);
	if (f166_ok) {
		fprintf(mailfil,"Hej %s\n",r166->navn);
	} else {
		fprintf(mailfil,"Hej station %hd\n",stnr);
	}
	fprintf(mailfil,"\n");
	fprintf(mailfil,"I har modtaget en Online Booking.\n");
	fprintf(mailfil,"Vær venlig at trække reservationen i BSS.\n");
	fprintf(mailfil,"\n");
	fprintf(mailfil,"Resnr: %ld\n",
		r159->record_x);
	fprintf(mailfil,"Navn: %s %s\n",
		r159->lejerfornavn,r159->lejerefternavn);
	fprintf(mailfil,"Tlf: %s\n",
		r159->lejertlf);
	fprintf(mailfil,"Bilgruppe: %s\n",
		r159->bil_grp);
	fprintf(mailfil,"Afh: ");
	ege_w_int1 = m036_funktion(17, (long int)r159->dato_ud);
	egeedit(ege_w_dou1 = ege_w_int1, "99.99.9999",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil," - ");
	sprintf(tmpstr,"%2.2ld:%2.2ld",
		r159->tid_ud/100,
		r159->tid_ud%100);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil,"\n");

	fprintf(mailfil,"Afl: ");
	ege_w_int1 = m036_funktion(17, (long int)r159->forv_dato_ind);
	egeedit(ege_w_dou1 = ege_w_int1, "99.99.9999",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil," - ");
	sprintf(tmpstr,"%2.2ld:%2.2ld",
		r159->forv_tid_ind/100,
		r159->forv_tid_ind%100);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil,"\n");

	fprintf(mailfil,"\n");
	fprintf(mailfil,"Hilsen\n");
	fprintf(mailfil,"BSS Server");
	if (ws_testkreds==1) {
		fprintf(mailfil," (beta.europcar.dk)");
	} else {
		fprintf(mailfil," (www.europcar.dk)");
	}
	fprintf(mailfil,"\n");
	fprintf(mailfil,"\n");
	fprintf(mailfil,"(Denne mail kan ikke besvares)\n");
	if (ws_testkreds==1) {
		fprintf(mailfil,"\n");
		fprintf(mailfil,"!!!!! TEST TEST TEST !!!!!\n\n");
	}
	if (mailfil) {
		fclose(mailfil);
		mailfil = (FILE*)0;
	}
	gethostname(host,20);
	(void)get_alfa_tgn(mailadr,1,tmpstr,64);
	if (!strlen(tmpstr)) {
		strcat(mailadr, "@");
		strcat(mailadr, host);
	}
	strcpy(afsender, "online");
	alfalow(str);
        sprintf(str,
"%s/egemail /plainmail:1 /p:%s?%s?%s?%s? /emne:%s /navn:%s /bodyfil:/tmp/%hd.mail\0",
		egeenv("EXECPATH"),
		egeenv("KREDS"),
		afsender,
		mailadr,
                host,
                emnestr,
		navnstr,
		ege_pid);
	if (logfil) {
		fprintf(logfil, "%s\n", str);
		fflush(logfil);
	}
	system(str);
	sprintf(tmpstr, "/tmp/%hd.mail", ege_pid);
	(void)unlink(tmpstr);
	if (logfil) {
		fprintf(logfil, "send_station_mail:SLUT\n");
	}
	return;
}

/* ************************************ */
/* funk 1 password			*/
static int send_password(funk,langstr,emailadr,password,kontant)
short int funk;
char * langstr;
char * emailadr;
char * password;
short int kontant; {
	short int funkretur = 0;
	long int nuvlbnr;
	char tmpstr[81] = "";
	char mailadr[81] = "";
	char afsender[41] = "";
	char host[21] = "";
	char emnestr[81] = "driveon.net Password";
	char navnstr[81] = "driveon.net Customer";
	FILE * mailfil;

	if (logfil) {
		fprintf(logfil, "send_password:funk=%hd,emailadr=%s\n",
			funk,
			emailadr);
		fflush(logfil);
	}
	if (!strlen(emailadr)) {
		return(-1);
	}
	strcpy(mailadr, emailadr);
	mailfil = (FILE*)0;
	sprintf(tmpstr, "/tmp/%hd.mail", ege_pid);
        mailfil = fopen(tmpstr, "w");
        if (!mailfil) {
                return(-1);
        }
/*
	fprintf(mailfil,"!!eqlknv==3D\n");
	fprintf(mailfil,"!!tabel=1\n");
	fprintf(mailfil,"!!td=0,0,0\n");
	fprintf(mailfil,"!VVV!\n");

	trans_tekst(langstr,10000,"",tmpstr);
	sprintf(bodystr,"%s %s",tmpstr,password);
	fprintf(mailfil,"<B>%s %s</B>",tmpstr,password);
	fprintf(mailfil,"\t");
	fprintf(mailfil,"\t");
	fprintf(mailfil,"\n");
*/
	nuvlbnr = 0;
	funkretur = 1;
	while (funk==1 && funkretur>0) {
		funkretur = trans_tekst_lbnr(langstr,10240,"",tmpstr,nuvlbnr);
		if (funkretur>0) {
			fprintf(mailfil,"%s\n",tmpstr);
		}
		nuvlbnr++;
	}
	if (funk==1) {
		fprintf(mailfil,"\n");
	}

	trans_tekst(langstr,10000,"",tmpstr);
	fprintf(mailfil,"%s %s",tmpstr,password);
/* NYT 051011 */
	alfa_password(langstr,password,tmpstr);
	fprintf(mailfil," (%s)",tmpstr);
	fprintf(mailfil,"\n");


	fprintf(mailfil,"\n");
	nuvlbnr = 0;
	funkretur = 1;
	while (funkretur>0) {
		funkretur = trans_tekst_lbnr(langstr,10241,"",tmpstr,nuvlbnr);
		if (funkretur>0) {
			fprintf(mailfil,"%s\n",tmpstr);
		}
		nuvlbnr++;
	}
	if (ws_station==56) {
		fprintf(mailfil,"\nPS:\n");
		fprintf(mailfil,"Husk ny adresse fra den 1/4 2007\n");
		fprintf(mailfil,"Ruggårdsvej 1\n");
		fprintf(mailfil,"5000 Odense C\n");
	}
	if (mailfil) {
		fclose(mailfil);
		mailfil = (FILE*)0;
	}
	gethostname(host,20);
	(void)get_alfa_tgn(mailadr,1,tmpstr,64);
	if (!strlen(tmpstr)) {
		strcat(mailadr, "@");
		strcat(mailadr, host);
	}
	strcpy(afsender, "doninfo");
	alfalow(str);
        sprintf(str,
"%s/egemail /plainmail:1 /p:%s?%s?%s?%s? /emne:%s /navn:%s /bodyfil:/tmp/%hd.mail\0",
		egeenv("EXECPATH"),
		egeenv("KREDS"),
		afsender,
		mailadr,
                host,
                emnestr,
		navnstr,
		ege_pid);
/* RETTET 050616
	sprintf(str,
"%s/egemail /tp:html /p1:%s?%s?%s /p2:%s?/tmp/%hd.mail /emne:%s /navn:%s\0",
		egeenv("EXECPATH"),
		egeenv("KREDS"),
		afsender,
		mailadr,
		host,
		ege_pid,
		emnestr,
		navnstr);
*/
	if (logfil) {
		fprintf(logfil, "%s\n", str);
		fflush(logfil);
	}
	system(str);
	return(1);
}

/* ************************************ */
static int send_annullering(resnr,langstr,emailadr)
long int resnr;
char * langstr;
char * emailadr; {
	char tmpstr[81] = "";
	char mailadr[81] = "";
	char afsender[41] = "";
	char host[21] = "";
	char emnestr[81] = "driveon.net Cancel";
	char navnstr[81] = "driveon.net Booking";
	FILE * mailfil;

	if (!strlen(emailadr)) {
		return(-1);
	}
	if (logfil) {
		fprintf(logfil, "send_annullering:resnr=%ld,emailadr=%s\n",
			resnr,
			emailadr);
		fflush(logfil);
	}
	trans_tekst(langstr,10150,"",tmpstr);
	sprintf(emnestr, "driveon.net %s", tmpstr);

	strcpy(mailadr, emailadr);
	mailfil = (FILE*)0;
	sprintf(tmpstr, "/tmp/%hd.mail", ege_pid);
        mailfil = fopen(tmpstr, "w");
        if (!mailfil) {
                return(-1);
        }
	fprintf(mailfil,"!!eqlknv==3D\n");
	fprintf(mailfil,"!!tabel=1\n");
	fprintf(mailfil,"!!td=0,0,0\n");
	fprintf(mailfil,"!VVV!\n");

	trans_tekst(langstr,10150,"",tmpstr);
	fprintf(mailfil,"<B>%ld %s</B>",resnr,tmpstr);
	fprintf(mailfil,"\t");
	fprintf(mailfil,"\t");
	fprintf(mailfil,"\n");
	if (mailfil) {
		fclose(mailfil);
		mailfil = (FILE*)0;
	}
	gethostname(host,20);
	(void)get_alfa_tgn(mailadr,1,tmpstr,64);
	if (!strlen(tmpstr)) {
		strcat(mailadr, "@");
		strcat(mailadr, host);
	}
	strcpy(afsender, "doninfo");
	alfalow(str);
	sprintf(str,
"%s/egemail /tp:html /p1:%s?%s?%s /p2:%s?/tmp/%hd.mail /emne:%s /navn:%s\0",
		egeenv("EXECPATH"),
		egeenv("KREDS"),
		afsender,
		mailadr,
		host,
		ege_pid,
		emnestr,
		navnstr);
	if (logfil) {
		fprintf(logfil, "%s\n", str);
		fflush(logfil);
	}
	system(str);
	return(1);
}

/* ************************************ */
static int send_reservation(funk,langstr,emailadr,password,kontant,varighed)
short int funk;
char * langstr;
char * emailadr;
char * password;
short int kontant;
long int varighed; {
	short int wx1, wx2;
	short int funkretur = 0;
	short int prisextra = 0;
	short int testflag = 0;
	long int keynum;
	long int extraantal;
	double dep_dankre = 1500;
	double dep_kontant = 1500;
	char tmpstr[81] = "";
	char mailadr[81] = "";
	char afsender[41] = "";
	char host[21] = "";
	char transstr[21] = "";
	char emnestr[81] = "driveon.net Reservation";
	char navnstr[81] = "driveon.net Booking";
	FILE * mailfil;

	if (!strlen(emailadr)) {
		return(-1);
	}
	if (strcmp(ws_menuid, "zt")==0) {
		testflag = 1;
	}
	funkretur = 0;
	keynum = (long int)r159->rate_spec_nr[0];
	keynum *= 1000;
	keynum += (long int)r159->station_ud_nr;
	funkretur = find_r198(1,16524,(double)keynum,"",0);
	if (funkretur>0 && r198->numfelt>0) {
		dep_dankre = r198->numfelt;
	}
	funkretur = 0;
	funkretur = find_r198(1,16525,(double)keynum,"",0);
	if (funkretur>0 && r198->numfelt>0) {
		dep_kontant = r198->numfelt;
	}
	if (logfil) {
		fprintf(logfil, "send_reservation:adr=%s\n",
			emailadr);
		fprintf(logfil, "send_reservation:forsikring_pai=%hd\n",
			r159->forsikring_pai);
		fprintf(logfil, "send_reservation:kontant=%hd\n",
			kontant);
		fflush(logfil);
	}
	strcpy(mailadr, emailadr);
	mailfil = (FILE*)0;
	sprintf(tmpstr, "/tmp/%hd.mail", ege_pid);
        mailfil = fopen(tmpstr, "w");
        if (!mailfil) {
                return(-1);
        }
	fprintf(mailfil,"!!eqlknv==3D\n");
	fprintf(mailfil,"!!tabel=1\n");
	fprintf(mailfil,"!!td=0,0,0\n");
	fprintf(mailfil,"!VVV!\n");
	fprintf(mailfil,"!!colspan=3,0,0\n");
	fprintf(mailfil, "<HR>\n");
	trans_tekst(langstr,10103,"",tmpstr);
	fprintf(mailfil, "<B>");
	if (testflag>0) {
		fprintf(mailfil, "*DEV*TEST* ");
	}
	fprintf(mailfil, "%s</B>\n",
		tmpstr);
	fprintf(mailfil, "<HR>\n");
	fprintf(mailfil,"!!colspan=1,1,1\n");

	trans_tekst(langstr,10142,"",tmpstr);
        fprintf(mailfil, "%s", tmpstr);
	fprintf(mailfil,"\t");
	stednavn_form((unsigned char *)r159->lejerfornavn);
	stednavn_form((unsigned char *)r159->lejerefternavn);
	fprintf(mailfil,"%s %s",
		r159->lejerfornavn,
		r159->lejerefternavn);
	fprintf(mailfil,"\t");
	fprintf(mailfil,"\n");

	if (strlen(r159->medlfornavn) && strlen(r159->medlefternavn)) {
		trans_tekst(langstr,10143,"",tmpstr);
	        fprintf(mailfil, "%s", tmpstr);
		fprintf(mailfil,"\t");
		stednavn_form((unsigned char *)r159->medlfornavn);
		stednavn_form((unsigned char *)r159->medlefternavn);
		fprintf(mailfil,"%s %s",
			r159->medlfornavn,
			r159->medlefternavn);
		fprintf(mailfil,"\t");
		fprintf(mailfil,"\n");
	}
	if (logfil) {
		fprintf(logfil, "send_reservation:firmakundenr=%ld\n",
			r159->firmakundenr);
		fflush(logfil);
	}
	if (r159->firmakundenr>0) {
		trans_tekst(langstr,10144,"",tmpstr);
	        fprintf(mailfil, "%s", tmpstr);
		fprintf(mailfil,"\t");
		strcpy(tmpstr, "");
		funkretur = find_r198(0,16702,(double)r159->firmakundenr,"",0);
                if (funkretur>0 && strlen(r198->alfafelt)) {
                        strcpy(tmpstr, r198->alfafelt);
                }
		if (!strlen(tmpstr)) {
			strcpy(tmpstr, r159->firmanavn);
			stednavn_form((unsigned char *)tmpstr);
		}
		if (logfil) {
			fprintf(logfil, "send_reservation:firma=%s\n", tmpstr);
			fflush(logfil);
		}
		fprintf(mailfil,"%s",
			tmpstr);
		fprintf(mailfil,"\t");
		fprintf(mailfil,"\n");
	}
        fprintf(mailfil, "E-mail");
	fprintf(mailfil,"\t");
	fprintf(mailfil,"%s",
		mailadr);
	fprintf(mailfil,"\t");
	fprintf(mailfil,"\n");
	fprintf(mailfil,"!!colspan=3,0,0\n");
	fprintf(mailfil, "<HR>\n");

	trans_tekst(langstr,10145,"",tmpstr);
	fprintf(mailfil, "<B>%s</B>\n",
		tmpstr);
	fprintf(mailfil, "<HR>\n");
	fprintf(mailfil,"!!colspan=1,1,1\n");

	trans_tekst(langstr,10102,"",tmpstr);
	fprintf(mailfil,"<B>%s</B>",
		tmpstr);
	fprintf(mailfil,"\t");
	fprintf(mailfil,"<B>%ld</B>",
		r159->record_x);
	fprintf(mailfil,"\t");
	fprintf(mailfil,"\n");

/* RETTET 040603
	r166->stat_nr = r159->station_ud_nr;
	egeread(f166, ISEQUAL);
	if (f166_ok) {
		stednavn_form((unsigned char *)r166->navn);
	} else {
		strcpy(r166->navn, "???");
	}
*/
	trans_tekst(langstr,10146,"",tmpstr);
	fprintf(mailfil,"%s",
		tmpstr);
	fprintf(mailfil,"\t");
	strcpy(r198->alfafelt,"");
	funkretur = find_r198(0,16601,(double)r159->station_ud_nr,"",0);
	if (funkretur>0 && strlen(r198->alfafelt)) {
		stednavn_form((unsigned char *)r198->alfafelt);
	}
	fprintf(mailfil,"%s %s",
		"driveon.net",
		r198->alfafelt);
	fprintf(mailfil,"\t");
	fprintf(mailfil,"\n");

	trans_tekst(langstr,10107,"",tmpstr);
	fprintf(mailfil,"%s",
		tmpstr);
	fprintf(mailfil,"\t");
/* RETTET 040514 */
	(void)f198_tekst(langstr,
		16526,(double)0,r159->bil_grp,0,tmpstr);
	stednavn_form((unsigned char *)tmpstr);
	fprintf(mailfil,"%s",
		tmpstr);
	fprintf(mailfil,"\t");
	fprintf(mailfil,"\n");

	trans_tekst(langstr,10105,"",tmpstr);
	fprintf(mailfil,"%s",
		tmpstr);
	fprintf(mailfil,"\t");
/* dag RETTET 040603 */
	ege_w_int1 = m036_funktion(11, (long int)r159->dato_ud);
	ege_w_int2 = 10000;
	ege_w_int2 += (ege_w_int1%10);
	trans_tekst(langstr,ege_w_int2,"",tmpstr);
	stednavn_form((unsigned char *)tmpstr);
	fprintf(mailfil,"%s ", tmpstr);

	ege_w_int1 = m036_funktion(17, (long int)r159->dato_ud);
	egeedit(ege_w_dou1 = ege_w_int1, "99.99.9999",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil," - ");
	sprintf(tmpstr,"%2.2ld:%2.2ld",
		r159->tid_ud/100,
		r159->tid_ud%100);
	fprintf(mailfil,"kl.%s", tmpstr);
	fprintf(mailfil,"\t");
	fprintf(mailfil,"\n");

	trans_tekst(langstr,10106,"",tmpstr);
	fprintf(mailfil,"%s",
		tmpstr);
	fprintf(mailfil,"\t");
/* dag RETTET 040603 */
	ege_w_int1 = m036_funktion(11, (long int)r159->forv_dato_ind);
	ege_w_int2 = 10000;
	ege_w_int2 += (ege_w_int1%10);
	trans_tekst(langstr,ege_w_int2,"",tmpstr);
	stednavn_form((unsigned char *)tmpstr);
	fprintf(mailfil,"%s ", tmpstr);

	ege_w_int1 = m036_funktion(17, (long int)r159->forv_dato_ind);
	egeedit(ege_w_dou1 = ege_w_int1, "99.99.9999",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil," - ");
	sprintf(tmpstr,"%2.2ld:%2.2ld",
		r159->forv_tid_ind/100,
		r159->forv_tid_ind%100);
	fprintf(mailfil,"kl.%s", tmpstr);
	fprintf(mailfil,"\t");
	fprintf(mailfil,"\n");

/* spec-liste IKKE extra */
	wx1 = 0;
	wx2 = 0;
	while (wx1<10) {
		if (r159->rate_spec_nr[wx1]<=0) {
			wx1++;
			continue;
		}
		prisextra = 0;
		funkretur=find_r198(1,
			16503,(double)r159->rate_spec_nr[wx1],"",0);
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisextra);
			}
		}
		if (r159->rate_spec_nr[wx1]>=900) {
			wx1++;
			continue;
		}
/*
		if (prisextra>0) {
			wx1++;
			continue;
		}
*/
		if (wx2==0) {
			trans_tekst(langstr,10111,"",tmpstr);
			fprintf(mailfil,"%s", tmpstr);
		}
		fprintf(mailfil,"\t");
/* RETTET 040625
		if (r159->rate_antal[wx1]>1) {
*/
		if (r159->rate_antal[wx1]>=1 && prisextra>0) {
			fprintf(mailfil,"%ld ", r159->rate_antal[wx1]);
		}
		if (strcmp(langstr,"DK")==0 ||
			strcmp(langstr,"DA")==0) {
			strcpy(tmpstr, r159->rate_tekst[wx1]);
		} else {
			sprintf(transstr, "%5.5ld%5.5hd",
				16507,r159->rate_spec_nr[wx1]);
			trans_tekst(langstr,0,transstr,tmpstr);
		}
		fprintf(mailfil,"%s", tmpstr);
/* ikke beskrivelse
		(void)f198_tekst(langstr,
			16501,(double)r159->rate_spec_nr[wx1],"",0,tmpstr);
		fprintf(mailfil," %s", tmpstr);
*/
		fprintf(mailfil,"\t");
		fprintf(mailfil,"\n");
		wx1++;
		wx2++;
	}
/* KM INCL */
	if (r159->rate_incl_km[10]>0) {
		trans_tekst(langstr,10126,"",tmpstr);
		fprintf(mailfil,"Km %s", tmpstr);
		fprintf(mailfil,"\t");
		fprintf(mailfil," %ld", r159->rate_incl_km[10]);
		trans_tekst(langstr,10127,"",tmpstr);
		fprintf(mailfil," %s", tmpstr);
		fprintf(mailfil,"\t");
		fprintf(mailfil,"\n");
	}
/* EVT SEPARAT EXTRAUDSTYR */
	wx1 = 0;
	wx2 = 0;
	while (wx1<10) {
		if (r159->rate_spec_nr[wx1]<=0) {
			wx1++;
			continue;
		}
		prisextra = 0;
		funkretur=find_r198(1,
			16503,(double)r159->rate_spec_nr[wx1],"",0);
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisextra);
			}
		}
		if (r159->rate_spec_nr[wx1]<900) {
			wx1++;
			continue;
		}
/*
		if (prisextra<=0) {
			wx1++;
			continue;
		}
*/
		if (wx2==0) {
			trans_tekst(langstr,10147,"",tmpstr);
			fprintf(mailfil,"%s", tmpstr);
		}
		fprintf(mailfil,"\t");
		extraantal = r159->rate_antal[wx1];
		extraantal /= varighed;
		if (r159->rate_antal[wx1]>1) {
			fprintf(mailfil,"%ld x ", extraantal);
		}
		if (strcmp(langstr,"DK")==0 ||
			strcmp(langstr,"DA")==0) {
			strcpy(tmpstr, r159->rate_tekst[wx1]);
		} else {
			sprintf(transstr, "%5.5ld%5.5hd",
				16507,r159->rate_spec_nr[wx1]);
			trans_tekst(langstr,0,transstr,tmpstr);
		}
		fprintf(mailfil,"%s", tmpstr);
/*
		(void)f198_tekst(langstr,
			16501,(double)r159->rate_spec_nr[wx1],"",0,tmpstr);
		fprintf(mailfil," %s", tmpstr);
*/
		fprintf(mailfil,"\t");
		fprintf(mailfil,"\n");
		wx1++;
		wx2++;
	}
/* PAI */
	trans_tekst(langstr,10108,"",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil,"\t");
	if (r159->forsikring_pai>0) {
		trans_tekst(langstr,10109,"",tmpstr);
	} else {
		trans_tekst(langstr,10110,"",tmpstr);
	}
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil,"\t");
	fprintf(mailfil,"\n");

	fprintf(mailfil,"\n");

	trans_tekst(langstr,10113,"",tmpstr);
	fprintf(mailfil,"<B>%s</B>", tmpstr);
	fprintf(mailfil,"\t");
	xls_char(tmpstr, (double)r159->total,2);
	fprintf(mailfil,"<B>DKK. %s</B>", tmpstr);
	fprintf(mailfil,"\t");
	fprintf(mailfil,"\n");
/* PAI PRIS */
	if (r159->forsikring_pai>0) {
		trans_tekst(langstr,10108,"",tmpstr);
		fprintf(mailfil,"%s", tmpstr);
		fprintf(mailfil,"\t");
		xls_char(tmpstr, (double)r159->pai_ialt,2);
		fprintf(mailfil,"DKK. %s", tmpstr);
		fprintf(mailfil,"\t");
		fprintf(mailfil,"\n");
	}
/* EVT SEPARAT EXTRAUDSTYR PRISER */
	ege_w_dou1 = 0;
	ege_w_dou2 = 0;
	wx1 = 0;
	while (wx1<10) {
		if (r159->rate_spec_nr[wx1]<=0) {
			wx1++;
			continue;
		}
		prisextra = 0;
		funkretur=find_r198(1,
			16503,(double)r159->rate_spec_nr[wx1],"",0);
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisextra);
			}
		}
		if (r159->rate_spec_nr[wx1]<900) {
			ege_w_dou1 += r159->rate_ialt[wx1];
		} else {
			ege_w_dou2 += r159->rate_ialt[wx1];
		}
/*
		if (prisextra<=0) {
			ege_w_dou1 += r159->rate_ialt[wx1];
		} else {
			ege_w_dou2 += r159->rate_ialt[wx1];
		}
*/
		wx1++;
	}
	if (r159->forsikring_cdw>0) {
		ege_w_dou1 += r159->cdw_ialt;
	}
	if (ege_w_dou1>0) {
		trans_tekst(langstr,10148,"",tmpstr);
		fprintf(mailfil,"%s", tmpstr);
		fprintf(mailfil,"\t");
		xls_char(tmpstr, (double)ege_w_dou1,2);
		fprintf(mailfil,"DKK. %s", tmpstr);
		fprintf(mailfil,"\t");
		fprintf(mailfil,"\n");
	}
	if (ege_w_dou2>0) {
		trans_tekst(langstr,10147,"",tmpstr);
		fprintf(mailfil,"%s", tmpstr);
		fprintf(mailfil,"\t");
		xls_char(tmpstr, (double)ege_w_dou2,2);
		fprintf(mailfil,"DKK. %s", tmpstr);
		fprintf(mailfil,"\t");
		fprintf(mailfil,"\n");
	}

/* EXTRA KM */
	trans_tekst(langstr,10128,"",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil,"\t");
	xls_char(tmpstr, (double)r159->rate_ekstra_km[10],2);
	fprintf(mailfil,"DKK. %s", tmpstr);
	trans_tekst(langstr,10129,"",tmpstr);
	fprintf(mailfil," %s", tmpstr);
	fprintf(mailfil,"\t");
	fprintf(mailfil,"\n");
/* MOMS */
	trans_tekst(langstr,10149,"",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil,"\t");
	fprintf(mailfil,"\t");
	fprintf(mailfil,"\n");

/* STATION IND UD */
	trans_tekst(langstr,10130,"",tmpstr);
	fprintf(mailfil,"!!colspan=3,0,0\n");
	fprintf(mailfil, "<HR>\n");
	fprintf(mailfil, "<B>%s</B>\n",
		tmpstr);
	fprintf(mailfil, "<HR>\n");
	fprintf(mailfil,"!!colspan=1,1,1\n");

	r166->stat_nr = r159->station_ud_nr;
	egeread(f166, ISEQUAL);
	if (f166_ok) {
		fprintf(mailfil,"%s", "driveon.net");
		fprintf(mailfil,"\t");
		fprintf(mailfil,"\t");
		fprintf(mailfil,"\n");
/* OBS 070320 */
		if (r159->dato_ud>=20070401 && r159->station_ud_nr==56) {
			strcpy(r166->adr,"Ruggårdsvej 1");
		}
/* OBS 070413 */
		if (r159->dato_ud>=20070419 && r159->station_ud_nr==57) {
			strcpy(r166->adr,"Søren Frichsvej 15");
		}
		stednavn_form((unsigned char *)r166->adr);
		fprintf(mailfil,"%s", r166->adr);
		fprintf(mailfil,"\t");
		if (r159->dato_ud>=20070401 && r159->station_ud_nr==56) {
			fprintf(mailfil,"OBS! ny adresse");
		}
		if (r159->dato_ud<20070401 &&
			r159->forv_dato_ind>=20070401 &&
			r159->station_ud_nr==56) {
			fprintf(mailfil,
				"OBS! aflevering ny adresse: Ruggårdsvej 1");
		}
/* OBS 070413 */
		if (r159->dato_ud>=20070419 && r159->station_ud_nr==57) {
			fprintf(mailfil,"OBS! ny adresse");
		}
		if (r159->dato_ud<20070419 &&
			r159->forv_dato_ind>=20070419 &&
			r159->station_ud_nr==57) {
			fprintf(mailfil,
				"OBS! aflevering ny adresse: Søren Frichsvej 15");
		}





		fprintf(mailfil,"\t");
		fprintf(mailfil,"\n");
		stednavn_form((unsigned char *)r166->by);
		fprintf(mailfil,"%s %s", r166->postkode, r166->by);
		fprintf(mailfil,"\t");
		fprintf(mailfil,"\t");
		fprintf(mailfil,"\n");
	}

/* annullering */
	fprintf(mailfil,"!!colspan=3,0,0\n");
	fprintf(mailfil, "<HR>\n");
	trans_tekst(langstr,10150,"",tmpstr);
	fprintf(mailfil, "<B>%s</B>\n",
		tmpstr);
	fprintf(mailfil, "<HR>\n");

	trans_tekst(langstr,10136,"",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil,"\n");

	trans_tekst(langstr,10137,"",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
       	funkretur = find_r198(1,16604,(double)r159->station_ud_nr,"",0);
	fprintf(mailfil," <a href=\"mailto:%s\">", r198->alfafelt);
	fprintf(mailfil,"%s</a> ", r198->alfafelt);
	fprintf(mailfil,"\n");

	trans_tekst(langstr,10138,"",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil," %s.", r166->tlf);
	fprintf(mailfil,"\n");

	trans_tekst(langstr,10139,"",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil,"\n");

/* depositum */
	fprintf(mailfil, "<HR>\n");
	trans_tekst(langstr,10151,"",tmpstr);
	fprintf(mailfil, "<B>%s</B>\n",
		tmpstr);
	fprintf(mailfil, "<HR>\n");

	if (kontant<=0) {
		trans_tekst(langstr,10117,"",tmpstr);
		fprintf(mailfil,"%s", tmpstr);
		trans_tekst(langstr,10118,"",tmpstr);
		fprintf(mailfil," %s", tmpstr);
		fprintf(mailfil,"\n");
	}

	trans_tekst(langstr,10115,"",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	xls_char(tmpstr, (double)dep_kontant,2);
	fprintf(mailfil," %s ", tmpstr);
	trans_tekst(langstr,10116,"",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil,"\n");

	trans_tekst(langstr,10119,"",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	xls_char(tmpstr, (double)dep_dankre,2);
	fprintf(mailfil," %s ", tmpstr);
	trans_tekst(langstr,10116,"",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil,"\n");
/* VENLIG HILSEN */
	fprintf(mailfil, "<HR>\n");
	trans_tekst(langstr,10133,"",tmpstr);
	fprintf(mailfil,"<B>%s</B>", tmpstr);
	fprintf(mailfil,"\n");
	fprintf(mailfil, "<HR>\n");

	trans_tekst(langstr,10134,"",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil,"\n");

	trans_tekst(langstr,10132,"",tmpstr);
	fprintf(mailfil,"%s", tmpstr);
	fprintf(mailfil,"\n");

	fprintf(mailfil,"!!colspan=1,1,1\n");

	if (mailfil) {
		fclose(mailfil);
		mailfil = (FILE*)0;
	}
	gethostname(host,20);
	(void)get_alfa_tgn(mailadr,1,tmpstr,64);
	if (!strlen(tmpstr)) {
		strcat(mailadr, "@");
		strcat(mailadr, host);
	}
	strcpy(afsender, "doninfo");
	alfalow(str);
	sprintf(str,
"%s/egemail /tp:html /p1:%s?%s?%s /p2:%s?/tmp/%hd.mail /emne:%s /navn:%s\0",
		egeenv("EXECPATH"),
		egeenv("KREDS"),
		afsender,
		mailadr,
		host,
		ege_pid,
		emnestr,
		navnstr);
	if (logfil) {
		fprintf(logfil, "%s\n", str);
		fflush(logfil);
	}
	system(str);
	return(1);
}

/* ************************************ */
static void send_kundeemail(funk,kundenr)
short int funk;
long int kundenr; {
	short int okflag = 1;
	char returstr[81];

	reclow(r178, R178);
	f178_start(1, ISGTEQ);

	alfalow(str);
	pack_init(str);
	strcpy(returstr, "");
	if (kundenr>0) {
		(void)find_r178(0,10,0,(double)kundenr);
		strcpy(returstr, r178->alfa_felt);
	}
	pack_alfa(returstr);
	pack_exchkend();
	send_linie();
	return;
}

/* ************************************ */
static void send_kundedata(short funk,char *langstr,long kundenr) {
	short int okflag = 1;
	short int firmafundet = 0;
	short int korttype = 0;
	short int retfirmaflag = 0;
	char kundemail[81] = "";
	char firmamail[81] = "";
	char returstr[81] = "";
	long int numfelt = 0;
	short int dondafolo = 0;

	if (ws_funktion>=300) {
		dondafolo = 1;
	}

	if (logfil) {
	fprintf(logfil,
	"send_kundedata:funk=%hd,langstr=%s,kundenr=%ld,dondafolo=%hd\n",
			funk,
			langstr,
			kundenr,
			dondafolo);
		fflush(logfil);
	}
	reclow(r198, R198);
	f198_start(1, ISGTEQ);
	reclow(r178, R178);
	f178_start(1, ISGTEQ);
	reclow(r167, R167);
	f167_start(1, ISGTEQ);
	r167->kunde_nr = kundenr;
	egeread(f167, ISEQUAL);
	if (f167_ukendt) {
		okflag = -1;
		reclow(r167, R167);
	}
	if (logfil) {
		fprintf(logfil, "send_kundedata:HERTIL-1\n");
		fflush(logfil);
	}

	alfalow(str);
	pack_init(str);

	if (okflag<0 && dondafolo>0) {
		pack_int2((long)-306);
		web_errormess(0,ws_langstr,"306");
	}
	pack_int2((long)kundenr);
	stednavn_form((unsigned char *)r167->navn_1);
	pack_alfa(r167->navn_1);
	stednavn_form((unsigned char *)r167->navn_2);
	pack_alfa(r167->navn_2);
	stednavn_form((unsigned char *)r167->adr_1);
	pack_alfa(r167->adr_1);
	stednavn_form((unsigned char *)r167->adr_2);
	pack_alfa(r167->adr_2);
	pack_alfa(r167->postkode);
	stednavn_form((unsigned char *)r167->by);
	pack_alfa(r167->by);
	stednavn_form((unsigned char *)r167->land);
	pack_alfa(r167->land);
	pack_alfa(r167->tlf);
	if (logfil) {
		fprintf(logfil, "send_kundedata:HERTIL-2\n");
		fflush(logfil);
	}
/* FAX */
	strcpy(returstr, "");
	if (r167->kunde_nr>0) {
		(void)find_r178(0,9,0,(double)r167->kunde_nr);
		strcpy(returstr, r178->alfa_felt);
	}
	pack_alfa(returstr);
	if (logfil) {
		fprintf(logfil, "send_kundedata:HERTIL-3\n");
		fflush(logfil);
	}
/* EMAIL */
	strcpy(returstr, "");
	if (r167->kunde_nr>0) {
		(void)find_r178(0,10,0,(double)r167->kunde_nr);
		strcpy(returstr, r178->alfa_felt);
		strcpy(kundemail, r178->alfa_felt);
	}
	pack_alfa(returstr);
	if (logfil) {
		fprintf(logfil, "send_kundedata:HERTIL-4\n");
		fflush(logfil);
	}
	pack_int2((long)r167->foedselsdato);
	pack_alfa(r167->kkortnr);
/* NYT 021219 */
	numfelt = 0;
/*
	if (r167->kunde_nr>0) {
		(void)find_r198(0,16703,(double)r167->kunde_nr,"",0);
		numfelt = r198->numfelt;
	}
*/
/* RETTET 040426 */
        korttype = 0;
        if (find_r178(0,42,0,(double)r167->kunde_nr)>0) {
                korttype = (short int)r178->num_felt;
        }
	if (korttype>0) {
		numfelt = 1;
	}
	pack_int2((long)numfelt);
/* NYT 030619 */
	reccpy(&q167, r167, R167);
	if (q167.firma_reference<=0) {
		firmafundet = 0;
	} else {
		firmafundet = 1;
		r167->kunde_nr = q167.firma_reference;
		egeread(f167, ISEQUAL);
		if (f167_ukendt) {
			firmafundet = -1;
		}
	}
	if (firmafundet==-1) {
		sprintf(returstr, "%ld ERROR", r167->kunde_nr);
		pack_alfa(returstr);
	}
	if (firmafundet==0) {
		strcpy(returstr, "");
		pack_alfa(returstr);
	}
	if (firmafundet<=0) {
		strcpy(returstr, "");
		pack_alfa(returstr);
		pack_alfa(returstr);
		pack_alfa(returstr);
		pack_alfa(returstr);
		pack_alfa(returstr);
		pack_alfa(returstr);
		pack_alfa(returstr);
		pack_alfa(returstr);
/* OBS 050211 FIRMAREF */
		pack_alfa(returstr);
	}
/* OBS 070502 RETFIRMA */
	if (firmafundet<=0 && dondafolo>0) {
		pack_alfa(returstr);
	}

	if (firmafundet>0) {
		strcpy(returstr, "");
		if (r167->kunde_nr>0) {
			(void)find_r178(0,1,0,(double)r167->kunde_nr);
			sprintf(returstr, "%.0lf", r178->num_felt);
		}
		pack_alfa(returstr);
/* NYT 040407 */
		strcpy(returstr, "");
		(void)find_r198(0,16702,(double)r167->kunde_nr,"",0);
		if (strlen(r198->alfafelt)) {
			strcpy(returstr, r198->alfafelt);
		} else {
			strcpy(returstr, r167->navn_2);
			stednavn_form((unsigned char *)returstr);
		}
		pack_alfa(returstr);
/*
		stednavn_form((unsigned char *)r167->navn_2);
		pack_alfa(r167->navn_2);
*/
		stednavn_form((unsigned char *)r167->adr_1);
		pack_alfa(r167->adr_1);
		stednavn_form((unsigned char *)r167->adr_2);
		pack_alfa(r167->adr_2);
		pack_alfa(r167->postkode);
		stednavn_form((unsigned char *)r167->by);
		pack_alfa(r167->by);
		stednavn_form((unsigned char *)r167->land);
		pack_alfa(r167->land);
		pack_alfa(r167->tlf);
		strcpy(returstr, "");
		if (r167->kunde_nr>0) {
			(void)find_r178(0,9,0,(double)r167->kunde_nr);
			strcpy(returstr, r178->alfa_felt);
		}
		pack_alfa(returstr);
/* OBS 050211 FIRMAREF */
		pack_int2((long)r167->kunde_nr);
	}
	if (firmafundet>0 && dondafolo>0) {
		(void)find_r178(0,10,0,(double)r167->kunde_nr);
		strcpy(firmamail, r178->alfa_felt);
	}
	if (firmafundet>0 && dondafolo>0 && strcmp(kundemail,firmamail)==0) {
		retfirmaflag = 1;
	}
/* OBS SNYD 070502 */
	if (firmafundet>0 && dondafolo>0 &&
		strcmp(kundemail,"aml@dafolo-marketing.dk")==0) {
		retfirmaflag = 1;
	}
	if (firmafundet>0 && dondafolo>0) {
		pack_int2((long)retfirmaflag);
	}
	if (logfil) {
		fprintf(logfil,"send_kundedata:HERTIL-10:str=%s\n", str);
		fflush(logfil);
	}
	pack_exchkend();
	if (logfil) {
		fprintf(logfil,"send_kundedata:HERTIL-11:str=%s", str);
		fflush(logfil);
	}
	send_linie();
	if (logfil) {
		fprintf(logfil,"send_kundedata:SLUT:str=%s", str);
		fflush(logfil);
	}
	return;
}

/* ************************************ */
static int don2_account() {
	int retur = 0;
	int nuvindex = 0;
	int daustatus = 0;
	short int dondafolo = 0;
	short int funkretur = 0;
	short int firmaflag = 0;
	short int korttype = 0;
	short int wx1;
	short int wx2;
	long int firmakundenr = 0;
	long int fdato = 0;
	long int alder = 0;
	int nyhedsbrev = 0;
	int smsserv = 0;
	int kundekortoenskes = 0;
	long int cvrnr = 0;
	long int nuvcvrnr = 0;
	char tmpstr[81] = "";
	char emailadr[81] = "";
	char langtfirmanavn[81] = "";
	char firmaansv[81] = "";
	char firmakontakt[81] = "";
	char faxnr[41] = "";
	char mobilnr[41] = "";

	if (ws_funktion>=300) {
		dondafolo = 1;
	}
	if (ws_funktion==8) {
		dondafolo = 1;
	}

	ws_opdaterfunk = 0;
	if (ws_opdaterknr>0) {
		ws_opdaterfunk = 1;
	}

/* TEST */
	if (logfil) {
        	fprintf(logfil, "don2_account:ws_maxparatab=%d\n",
			ws_maxparatab);
        	fprintf(logfil, "\tws_opdaterfunk=%hd\n",
			ws_opdaterfunk);
        	fprintf(logfil, "\tws_systemdato=%ld\n",
			ws_systemdato);
        	fprintf(logfil, "\tws_kundetype=%hd\n",
			ws_kundetype);
	}
	reclow(r198, R198);
	f198_start(1, ISGTEQ);
	reclow(r178, R178);
	f178_start(1, ISGTEQ);
	reclow(r167, R167);
	f167_start(1, ISGTEQ);

	nuvindex = 0;
	while(logfil && nuvindex<=ws_maxparatab) {
		fprintf(logfil,"\tws_paratab-%d <%s>\n",
			nuvindex,
			ws_paratab[nuvindex]);
		alfalow(tmpstr);
		strcpy(tmpstr,ws_paratab[nuvindex]);
		strcpy(ws_paratab[nuvindex],
			(char *) konvert_ext_ascii_til_8859(tmpstr));
		fprintf(logfil,"\tEFTER KONV ws_paratab-%d <%s>\n",
			nuvindex,
			ws_paratab[nuvindex]);
		nuvindex++;
	}

/* DON2HERTIL */
	if (ws_kundetype<1 || ws_kundetype>2) {
		ws_don2errno = DON2ACCFUK;
	}
/*
	if (ws_opdaterfunk==0 && ws_opdaterknr>0) {
		ws_don2errno = DON2ACCMM;
	}
	if (ws_opdaterfunk==1 && ws_opdaterknr<=0) {
		ws_don2errno = DON2ACCMM;
	}
*/
	if (ws_don2errno<=0 && ws_kundetype==1 && ws_opdaterfunk==0 &&
		don2_check_kundefindes(1,
			ws_paratab[1],ws_paratab[2])>0) {
		ws_don2errno = DON2ACCALR;
	}
	if (ws_don2errno<=0 && ws_kundetype==2 && ws_opdaterfunk==0 &&
		don2_check_firmafindes(1,
			ws_paratab[2],ws_paratab[3],ws_paratab[5])>0) {
		ws_don2errno = DON2ACCALR;
	}
	if (logfil) {
		fprintf(logfil,"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		return(0);
	}
/* check for minimumfelter */
/* PERSON */
	if (ws_kundetype==1 && !strlen(ws_paratab[0])) {
		ws_don2errno = DON2ACCMGL;
	}
	if (ws_kundetype==1 && !strlen(ws_paratab[1])) {
		ws_don2errno = DON2ACCMGL;
	}
	if (ws_kundetype==1 && !strlen(ws_paratab[2])) {
		ws_don2errno = DON2ACCMGL;
	}
	if (ws_kundetype==1 && !strlen(ws_paratab[3])) {
		ws_don2errno = DON2ACCMGL;
	}
	if (ws_kundetype==1 && !strlen(ws_paratab[4])) {
		ws_don2errno = DON2ACCMGL;
	}
	if (ws_kundetype==1 && !strlen(ws_paratab[5])) {
		ws_don2errno = DON2ACCMGL;
	}
	if (ws_kundetype==1 && !strlen(ws_paratab[7])) {
		ws_don2errno = DON2ACCMGL;
	}
	if (ws_kundetype==1 && !strlen(ws_paratab[8])) {
		ws_don2errno = DON2ACCMGL;
	}
/* NYT 130121 */
	if (ws_kundetype==1 && strlen(ws_paratab[10]) &&
		check_numtgn(ws_paratab[10])<=0) {
		ws_don2errno = DON2ACCTFJL;
	}
	if (ws_kundetype==1 && strlen(ws_paratab[11]) &&
		check_numtgn(ws_paratab[11])<=0) {
		ws_don2errno = DON2ACCMFJL;
	}
	if (ws_kundetype==1 && strcmp(ws_paratab[13],"1")==0 &&
		!strlen(ws_paratab[11])) {
		ws_don2errno = DON2ACCMGL;
	}

/* FIRMA */
	if (ws_kundetype==2 && !strlen(ws_paratab[0])) {
		ws_don2errno = DON2ACCMGL;
	}
	if (ws_kundetype==2 && !strlen(ws_paratab[1])) {
		ws_don2errno = DON2ACCMGL;
	}
	if (ws_kundetype==2 && !strlen(ws_paratab[2])) {
		ws_don2errno = DON2ACCMGL;
	}
	if (ws_kundetype==2 && !strlen(ws_paratab[3])) {
		ws_don2errno = DON2ACCMGL;
	}
	if (ws_kundetype==2 && !strlen(ws_paratab[5])) {
		ws_don2errno = DON2ACCMGL;
	}
	if (ws_kundetype==2 && !strlen(ws_paratab[6])) {
		ws_don2errno = DON2ACCMGL;
	}
	if (ws_kundetype==2 && !strlen(ws_paratab[8])) {
		ws_don2errno = DON2ACCMGL;
	}
/* NYT 130121 */
	if (ws_kundetype==2 && strlen(ws_paratab[8]) &&
		check_numtgn(ws_paratab[8])<=0) {
		ws_don2errno = DON2ACCTFJL;
	}
	if (ws_kundetype==2 && strlen(ws_paratab[9]) &&
		check_numtgn(ws_paratab[9])<=0) {
		ws_don2errno = DON2ACCMFJL;
	}
	if (ws_kundetype==2 && strcmp(ws_paratab[11],"1")==0 &&
		!strlen(ws_paratab[9])) {
		ws_don2errno = DON2ACCMGL;
	}

	if (logfil) {
		fprintf(logfil,"\tws_don2errno-2=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		return(0);
	}
	if (ws_kundetype==1) {
		daustatus = don2_check_dau(6,ws_paratab[1],ws_paratab[4]);
	}
	if (ws_kundetype==1 && daustatus==2) {
		ws_don2errno = DON2ACCDAU2;
	}
	if (ws_kundetype==1 && daustatus==3) {
		ws_don2errno = DON2ACCDAU3;
	}
	if (ws_kundetype==1 && daustatus==4) {
		ws_don2errno = DON2ACCDAU4;
	}
	if (logfil) {
		fprintf(logfil,"\tws_don2errno-3=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		return(0);
	}
	if (ws_kundetype==1) {
		ege_tolower((unsigned char *)ws_paratab[0]);
		ws_paratab[1][15] = '\0';
		ws_paratab[3][20] = '\0';
		ws_paratab[4][30] = '\0';
		ws_paratab[5][30] = '\0';
		ws_paratab[6][30] = '\0';
		ws_paratab[7][15] = '\0';
		ws_paratab[8][15] = '\0';
		ws_paratab[9][10] = '\0';
		ws_paratab[10][20] = '\0';
		ws_paratab[11][20] = '\0';
/*
		ws_paratab[12][20] = '\0';
		strcpy(faxnr,ws_paratab[12]);
		ege_toupper((unsigned char *)ws_paratab[13]);
		if (strcmp(ws_paratab[13],"TRUE")==0) {
			kundekortoenskes = 1;
		}
*/
		ege_toupper((unsigned char *)ws_paratab[12]);
		if (strcmp(ws_paratab[12],"TRUE")==0) {
			nyhedsbrev = 1;
		}
		if (strcmp(ws_paratab[12],"1")==0) {
			nyhedsbrev = 1;
		}
		ege_toupper((unsigned char *)ws_paratab[13]);
		if (strcmp(ws_paratab[13],"TRUE")==0) {
			smsserv = 1;
		}
		if (strcmp(ws_paratab[13],"1")==0) {
			smsserv = 1;
		}
	}
	wx1 = 0;
	wx2 = 0;
	alfalow(tmpstr);
	while (ws_kundetype==1 && wx1<strlen(ws_paratab[2])) {
		if (ws_paratab[2][wx1]>='0' && ws_paratab[2][wx1]<='9') {
			tmpstr[wx2] = ws_paratab[2][wx1];
			wx2++;
			tmpstr[wx2] = '\0';
		}
		wx1++;
	}
	if (strlen(tmpstr)) {
		sscanf(tmpstr,"%ld",&ege_w_int1);
		fdato = m036_funktion(18,(long int)ege_w_int1);
	}
	if (logfil) {
		fprintf(logfil,"\ttmpstr=<%s> fdato=%8.8ld\n",
			tmpstr,fdato);
		fprintf(logfil,"\tws_systemdato=%8.8ld\n",
			ws_systemdato);
	}
	ege_w_int1 = 19000101;
	if (logfil) {
		fprintf(logfil,"\tege_w_int1=%8.8ld\n",
			ege_w_int1);
	}
	if (ws_kundetype==1 && fdato<=ege_w_int1) {
		ws_don2errno = DON2ACCDTF;
	}
	if (ws_kundetype==1 && fdato>ws_systemdato) {
		ws_don2errno = DON2ACCDTF;
	}
/* NYT 130416 CHECK21ALDER */
	if (ws_kundetype==1 && fdato>0) {
                alder = ws_systemdato;
                alder -= fdato;
                if (alder<210000) {
			ws_don2errno = DON2ACCALDER;
                }
	}
	if (logfil) {
		fprintf(logfil,"\talder=%ld\n",alder);
		fprintf(logfil,"\tws_don2errno-4=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		return(0);
	}
	if (ws_kundetype==2) {
		ege_tolower((unsigned char *)ws_paratab[0]);
		ws_paratab[1][20] = '\0';
		if (strlen(ws_paratab[1])) {
			sscanf(ws_paratab[1],"%ld",&cvrnr);
		}

		strcpy(langtfirmanavn,ws_paratab[2]);
		langtfirmanavn[40] = '\0';
		ws_paratab[2][30] = '\0';
		ws_paratab[3][30] = '\0';
		ws_paratab[4][30] = '\0';
		ws_paratab[5][15] = '\0';
		ws_paratab[6][15] = '\0';
		ws_paratab[7][10] = '\0';
		ws_paratab[8][20] = '\0';
		ws_paratab[9][20] = '\0';
/*
		ws_paratab[10][20] = '\0';
		strcpy(faxnr,ws_paratab[10]);
*/
		ege_toupper((unsigned char *)ws_paratab[10]);
		if (strcmp(ws_paratab[10],"TRUE")==0) {
			nyhedsbrev = 1;
		}
		if (strcmp(ws_paratab[10],"1")==0) {
			nyhedsbrev = 1;
		}
		ege_toupper((unsigned char *)ws_paratab[11]);
		if (strcmp(ws_paratab[11],"TRUE")==0) {
			smsserv = 1;
		}
		if (strcmp(ws_paratab[11],"1")==0) {
			smsserv = 1;
		}
	}
	if (ws_kundetype==2 && strlen(ws_paratab[12])) {
		strcpy(firmaansv,ws_paratab[12]);
		firmaansv[40] = '\0';
	}
	if (ws_kundetype==2 && strlen(ws_paratab[13])) {
		strcpy(firmakontakt,ws_paratab[13]);
		firmakontakt[40] = '\0';
	}

	if (ws_kundenr>0 && ws_kundetype==1) {
		reclow(r167, R167);
		f167_start(1, ISGTEQ);
		r167->kunde_nr = ws_kundenr;
		egeread(f167,ISEQUAL);
		if (f167_ok && r167->type==2) {
			firmakundenr = ws_kundenr;
		}
	}
	wx1 = 0;
	wx2 = 5;
	if (logfil) {
		fprintf(logfil,"\tparatab-%hd=",wx2);
	}
	while (logfil && ws_kundetype==1 && wx1<strlen(ws_paratab[wx2])) {
		fprintf(logfil,"%hd+",(short int)ws_paratab[wx2][wx1]);
		wx1++;
	}

	if (logfil) {
		fprintf(logfil,"\tkundekortoenskes=%d\n",kundekortoenskes);
		fprintf(logfil,"\tnyhedsbrev=%d\n",nyhedsbrev);
		fprintf(logfil,"\tsmsserv=%d\n",smsserv);
		fprintf(logfil,"\tfaxnr=%s\n",faxnr);
		fprintf(logfil,"\tfirmakundenr=%ld\n",firmakundenr);
	}
	reclow(r167, R167);
	f167_start(1, ISGTEQ);
	reclow(r178, R178);
	f178_start(1, ISGTEQ);
	if (ws_opdaterfunk==0) {
		nytkundenr();
	}
	if (ws_opdaterfunk==1) {
		r167->kunde_nr = ws_opdaterknr;
		egeread(f167, ISEQUAL);
		if (f167_ukendt) {
			r167->kunde_nr = -1;
		}
	}
	if (logfil) {
        	fprintf(logfil, "\tr167->kunde_nr=%ld\n", r167->kunde_nr);
	}
	if (r167->kunde_nr<=0) {
		ws_don2errno = DON2ACCNRF;
	}
/* NYT 130122 CHECKFNVNCVR */
	if (ws_don2errno<=0 &&
		ws_kundetype==2 && ws_opdaterfunk==1 && ws_opdaterknr>0) {
		bss_konv_txt(1,ws_paratab[2]);
		if (strcmp(r167->navn_2,ws_paratab[2])!=0) {
			ws_don2errno = DON2ACCFNVN;
		}
	}
	if (ws_don2errno<=0 &&
		ws_kundetype==2 && ws_opdaterfunk==1 && ws_opdaterknr>0) {
		nuvcvrnr = 0;
		r178->kunde_nr = (double)ws_opdaterknr;
		r178->opl_kode = 1;
		egeread(f178,ISEQUAL);
	}
	if (ws_don2errno<=0 &&
		ws_kundetype==2 && ws_opdaterfunk==1 && ws_opdaterknr>0 &&
		f178_ok) {
		nuvcvrnr = (long int)r178->num_felt;
	}
	if (ws_don2errno<=0 &&
		ws_kundetype==2 && ws_opdaterfunk==1 && ws_opdaterknr>0 &&
		nuvcvrnr!=cvrnr) {
		ws_don2errno = DON2ACCCVR;
	}
	if (logfil) {
		fprintf(logfil,"\tws_don2errno-5=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		return(0);
	}
	if (ws_kundetype==1) {
		strcpy(r167->navn_1, ws_paratab[3]);
		strcpy(r167->navn_2, ws_paratab[4]);
		strcpy(r167->adr_1, ws_paratab[5]);
		strcpy(r167->adr_2, ws_paratab[6]);
		strcpy(r167->postkode, ws_paratab[7]);
		strcpy(r167->by, ws_paratab[8]);
		strcpy(r167->land, ws_paratab[9]);
		strcpy(r167->tlf, ws_paratab[10]);
		if (strlen(ws_paratab[11])) {
			strcpy(mobilnr, ws_paratab[11]);
/* RETTET 121101
			strcpy(r167->tlf, ws_paratab[11]);
*/
		}
		r167->foedselsdato = fdato;
		strcpy(r167->kkortnr, ws_paratab[1]);
/*
		ege_toupper((unsigned char *)r167->navn_1);
		ege_toupper((unsigned char *)r167->navn_2);
		ege_toupper((unsigned char *)r167->adr_1);
		ege_toupper((unsigned char *)r167->adr_2);
*/
		bss_konv_txt(2,r167->navn_1);
		bss_konv_txt(3,r167->navn_2);
		bss_konv_txt(4,r167->adr_1);
		bss_konv_txt(4,r167->adr_2);
		bss_konv_txt(5,r167->postkode);
		bss_konv_txt(4,r167->by);
		bss_konv_txt(4,r167->land);
		bss_konv_txt(8,r167->kkortnr);
	}
	if (ws_kundetype==2) {
		strcpy(r167->navn_2, ws_paratab[2]);
		strcpy(r167->adr_1, ws_paratab[3]);
		strcpy(r167->adr_2, ws_paratab[4]);
		strcpy(r167->postkode, ws_paratab[5]);
		strcpy(r167->by, ws_paratab[6]);
		strcpy(r167->land, ws_paratab[7]);
		strcpy(r167->tlf, ws_paratab[8]);
		if (strlen(ws_paratab[9])) {
			strcpy(mobilnr, ws_paratab[9]);
/* RETTET 121101
			strcpy(r167->tlf, ws_paratab[9]);
*/
		}
/*
		ege_toupper((unsigned char *)r167->navn_1);
		ege_toupper((unsigned char *)r167->navn_2);
		ege_toupper((unsigned char *)r167->adr_1);
		ege_toupper((unsigned char *)r167->adr_2);
*/
		bss_konv_txt(1,r167->navn_2);
		bss_konv_txt(4,r167->adr_1);
		bss_konv_txt(4,r167->adr_2);
		bss_konv_txt(5,r167->postkode);
		bss_konv_txt(4,r167->by);
		bss_konv_txt(4,r167->land);
	}
	if (ws_opdaterfunk==0 && ws_kundetype==1) {
		r167->type = 1;
	}
	if (ws_opdaterfunk==0 && ws_kundetype==2) {
		r167->type = 2;
	}
	if (ws_opdaterfunk==0) {
		r167->oprettelses_dato = ege_date();
		r167->status = 1;
		strcpy(r167->bem, "webopret ok");
		if (firmakundenr>0) {
			r167->firma_reference = firmakundenr;
		}
	}
/*
	if (funk==2 &&
		!strlen(ws_paratab[13]) &&
		!strlen(ws_paratab[14]) &&
		!strlen(ws_paratab[20])) {
		r167->firma_reference = 0;
	}
*/
	egewrite(f167);
	if (f167_ok) {
		retur = 1;
	}
	if (f167_ukendt) {
		reccpy(&q167,r167,R167);
		egeread(f167, ISEQUAL + ISLOCK);
		reccpy(r167,&q167,R167);
		egerew(f167);
		egerel(f167);
		retur = 1;
	}

/* password */
/*
	if (funk==0) {
		reclow(r178, R178);
		dan_password(4,r178->alfa_felt);
		opdat_r178(45,(double)r167->kunde_nr);
		reclow(r178, R178);
		strcpy(r178->alfa_felt, "SYWEB");
		opdat_r178(11,(double)r167->kunde_nr);
	}
	if (funk==1) {
		reclow(r178, R178);
		dan_password(4,r178->alfa_felt);
		opdat_r178(45,(double)r167->kunde_nr);
		reclow(r178, R178);
		strcpy(r178->alfa_felt, "SYWEB");
		opdat_r178(11,(double)r167->kunde_nr);
	}
*/
/* brand */
	if (ws_opdaterfunk==0) {
		reclow(r178, R178);
		strcpy(r178->alfa_felt, "SYWEB");
		opdat_r178(11,(double)r167->kunde_nr);
	}
/* NYT 121101 */
	if (ws_kundetype==2) {
		reclow(r178, R178);
		r178->num_felt = (double)cvrnr;
		opdat_r178(1,(double)r167->kunde_nr);
	}
/* NYT 121017 */
	if (ws_kundetype==2) {
		reclow(r178, R178);
		strcpy(r178->alfa_felt, langtfirmanavn);
		opdat_r178(19,(double)r167->kunde_nr);
	}
	if (ws_kundetype==2) {
		reclow(r178, R178);
		strcpy(r178->alfa_felt, firmaansv);
		opdat_r178(100,(double)r167->kunde_nr);
	}
	if (ws_kundetype==2) {
		reclow(r178, R178);
		strcpy(r178->alfa_felt, firmakontakt);
		opdat_r178(101,(double)r167->kunde_nr);
	}

/* fax */
	reclow(r178, R178);
	strcpy(r178->alfa_felt, faxnr);
	opdat_r178(9,(double)r167->kunde_nr);
/* email */
	reclow(r178, R178);
	strcpy(r178->alfa_felt, ws_paratab[0]);
	opdat_r178(10,(double)r167->kunde_nr);
/* mobilnr */
	reclow(r178, R178);
	strcpy(r178->alfa_felt, mobilnr);
	opdat_r178(65,(double)r167->kunde_nr);
/* smsserv */
	reclow(r178, R178);
	if (smsserv>0) {
		r178->num_felt = 1;
	}
	opdat_r178(66,(double)r167->kunde_nr);
/* nyhedsbrev */
	reclow(r178, R178);
	if (nyhedsbrev<=0) {
		r178->num_felt = 3;
	}
	opdat_r178(40,(double)r167->kunde_nr);

/* kundekort */
/* RETTET 121101
	korttype = 0;
	if (find_r178(0,42,0,(double)r167->kunde_nr)>0) {
		korttype = (short int)r178->num_felt;
	}
	if (korttype<=0 && kundekortoenskes>0) {
		reclow(r178, R178);
		r178->num_felt = 2030;
		opdat_r178(42,(double)r167->kunde_nr);
	}
*/
	reccpy(&q167, r167, R167);
#ifdef egetest
	firmaflag = 0;
	firmakundenr = 0;
	if (strlen(ws_paratab[13]) &&
		strlen(ws_paratab[14]) &&
		strlen(ws_paratab[20])) {
		if (funk==1) {
			firmaflag = 1;
			reclow(r167, R167);
			nytkundenr();
			r167->type = 2;
			r167->oprettelses_dato = ege_date();
			r167->status = 1;
			strcpy(r167->bem, "webopret ok");
			firmakundenr = r167->kunde_nr;
		}
/* NYT 041220 */
		if (funk==2 && q167.firma_reference>0) {
			reclow(r167, R167);
			f167_start(1,ISGTEQ);
			r167->kunde_nr = q167.firma_reference;
			egeread(f167, ISEQUAL);
			if (f167_ukendt) {
				r167->type = 2;
				r167->oprettelses_dato = ege_date();
				r167->status = 1;
				strcpy(r167->bem, "webopret ok");
			}
			firmaflag = 2;
			r167->kunde_nr = q167.firma_reference;
			firmakundenr = r167->kunde_nr;
		}
/*
		if (funk==2 && q167.firma_reference>0) {
			firmaflag = 2;
			reclow(r167, R167);
			r167->kunde_nr = q167.firma_reference;
			firmakundenr = r167->kunde_nr;
		}
*/
		if (funk==2 && q167.firma_reference<=0) {
			firmaflag = 1;
			reclow(r167, R167);
			nytkundenr();
			r167->type = 2;
			r167->oprettelses_dato = ege_date();
			r167->status = 1;
			strcpy(r167->bem, "webopret ok");
			firmakundenr = r167->kunde_nr;
		}
	}
/* TEST */
        sprintf(dum_str, "hertil3 firmaflag=%hd,firmakundenr=%ld",
		firmaflag,firmakundenr);
        logfil_put(dum_str);
	if (firmaflag>0) {
		if (r167->kunde_nr<=0 && ws_funktion<300) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-4);
			pack_alfa("FIRMAKUNDENRFEJL");
			pack_exchkend();
			send_linie();
			return;
		}
		if (r167->kunde_nr<=0 && ws_funktion>=300) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-313);
			web_errormess(0,ws_langstr,"313");
			pack_exchkend();
			send_linie();
			return;
		}

		strcpy(r167->navn_2, ws_paratab[14]);
		strcpy(r167->adr_1, ws_paratab[15]);
		strcpy(r167->adr_2, ws_paratab[16]);
		strcpy(r167->postkode, ws_paratab[17]);
		strcpy(r167->by, ws_paratab[18]);
		strcpy(r167->land, ws_paratab[19]);
		strcpy(r167->tlf, ws_paratab[20]);

		ege_toupper((unsigned char *)r167->navn_2);
		ege_toupper((unsigned char *)r167->adr_1);
		ege_toupper((unsigned char *)r167->adr_2);
/*
		bss_konv_txt(1,r167->navn_2);
		bss_konv_txt(4,r167->adr_1);
		bss_konv_txt(4,r167->adr_2);
*/
		bss_konv_txt(5,r167->postkode);
		bss_konv_txt(4,r167->by);
		bss_konv_txt(4,r167->land);
		egewrite(f167);
		if (f167_ukendt) {
			reccpy(&x167,r167,R167);
			egeread(f167, ISEQUAL + ISLOCK);
			reccpy(r167,&x167,R167);
			egerew(f167);
			egerel(f167);
		}
		reclow(r178, R178);
		strcpy(r178->alfa_felt, ws_paratab[21]);
		opdat_r178(9,(double)r167->kunde_nr);
		reclow(r178, R178);
		sscanf(ws_paratab[13], "%lf", &r178->num_felt);
		opdat_r178(1,(double)r167->kunde_nr);
/* NYT 040302 */
		if (firmaflag==1) {
			reclow(r178, R178);
			strcpy(r178->alfa_felt, "SYWEB");
			opdat_r178(11,(double)r167->kunde_nr);
		}
/* NYT 040407 */
		reclow(r198, R198);
		r198->numfelt = 0;
		strcpy(r198->alfafelt, ws_paratab[14]);
		opdat_r198(16702,(double)r167->kunde_nr,"",0);
		reccpy(r167,&q167, R167);
	}
	if (firmakundenr>0) {
		reclow(r167, R167);
		r167->kunde_nr = q167.kunde_nr;
		egeread(f167, ISEQUAL + ISLOCK);
		if (f167_ok) {
			r167->firma_reference = firmakundenr;
			egerew(f167);
			egerel(f167);
		}
	}
/* NYT 041104 */
	if (firmaflag>0 &&
		q167.kunde_nr>0 &&
		korttype==0 &&
		strlen(ws_paratab[12])) {
		reclow(r178, R178);
		r178->num_felt = 2031;
		opdat_r178(42,(double)q167.kunde_nr);
	}
	reclow(r178, R178);
	f178_start(1, ISGTEQ);
	reclow(r198, R198);
	f198_start(1, ISGTEQ);
        sprintf(dum_str, "hertil4 q167.kunde_nr=%ld", q167.kunde_nr);
        logfil_put(dum_str);
	if (funk==0 || funk==1) {
		retur = -4;
/* evt andre check */
		if (retur==-4) {
			funkretur = find_r178(0,10,0,(double)q167.kunde_nr);
		}
		if (retur==-4 && funkretur>0 && strlen(r178->alfa_felt)) {
			strcpy(emailadr, r178->alfa_felt);
		}
		sprintf(dum_str,
			"hertil4 retur=%hd,funkretur=%hd,r178->alfa_felt=%s",
			retur,
			funkretur,
			r178->alfa_felt);
        	logfil_put(dum_str);
		if (retur==-4 && strlen(emailadr)) {
			retur = 1;
			funkretur = find_r178(0,45,0,(double)q167.kunde_nr);
			strcpy(tmpstr, r178->alfa_felt);
		}
		if (retur==1 && strlen(emailadr) &&
			funkretur>0 && strlen(tmpstr)) {
			(void)send_password(1,langstr,emailadr,tmpstr,0);
		}
	}
        sprintf(dum_str, "hertil5 retur=%hd", retur);
        logfil_put(dum_str);
	if ((funk==0 || funk==1) && dondafolo==0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)retur);
		if (retur==1) {
			pack_int2((long)q167.kunde_nr);
			sprintf(tmpstr, "%s %s",q167.navn_1,q167.navn_2);
			pack_alfa(tmpstr);
		}
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "opdat_kundedata:str=%s\n",str);
			fflush(logfil);
		}
	}
	if ((funk==0 || funk==1) && dondafolo==1) {
		alfalow(str);
		pack_init(str);
		if (retur==1) {
			pack_int2((long)q167.kunde_nr);
		} else {
			pack_int2((long)0);
		}
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "opdat_kundedata:str=%s\n",str);
			fflush(logfil);
		}
/*
		send_kundedata(1,langstr,q167.kunde_nr);
*/
	}
	if (funk==2 && dondafolo==0) {
		send_kundedata(1,langstr,kundenr);
	}
	if (funk==2 && dondafolo==1 && q167.kunde_nr>0) {
		retur = 1;
	}
	if (funk==2 && dondafolo==1) {
		alfalow(str);
		pack_init(str);
		if (retur==1) {
			pack_int2((long)q167.kunde_nr);
		} else {
			pack_int2((long)0);
		}
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "opdat_kundedata:str=%s\n",str);
			fflush(logfil);
		}
/*
		send_kundedata(1,langstr,kundenr);
*/
	}
#endif
	if (retur==1) {
		alfalow(str);
		pack_init(str);
		pack_alfa("ok");
		if (ws_opdaterfunk==0) {
			sprintf(tmpstr,"opret %ld",r167->kunde_nr);
		}
		if (ws_opdaterfunk==1) {
			sprintf(tmpstr,"opdatering %ld",r167->kunde_nr);
		}
		pack_alfa(tmpstr);
		pack_int2((long)r167->kunde_nr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "opdat_kundedata:str=%s\n",str);
			fflush(logfil);
		}
	}
	if (logfil) {
		fprintf(logfil, "don2_account:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ********************************** */
static int check_emailfindes(char *emailadr,char *kgrp) {
	short int retur = 0;
	short int funkretur = -1;
	long int knr = 0;

	reclow(r178, R178);
	r178->opl_kode = 10;
	strcpy(r178->alfa_felt, emailadr);
	f178_start(4, ISGTEQ);
	if (f178_ukendt) {
		retur = -1;
	}
	while (retur==0) {
		egeread(f178, ISNEXT);
		if (f178_eof) {
			break;
		}
		if (strcmp(r178->alfa_felt, emailadr)!=0) {
			break;
		}
		if (r178->opl_kode!=10) {
			continue;
		}
		if (r178->kunde_nr<=0) {
			continue;
		}
		retur = 1;
		knr = (long int)r178->kunde_nr;
	}
/* NYT 080623 CHECK KUNDEGRP */
	if (retur>0 && knr>0 && strcmp(kgrp,"SY")==0) {
		funkretur = check_sy_kundenr(knr);
	}
	if (retur>0 && knr>0 && strcmp(kgrp,"SY")==0 && funkretur!=1) {
		retur = 0;
	}
	if (logfil) {
		fprintf(logfil,
		"check_emailfindes:knr=%ld,funkretur=%hd,retur=%hd\n",
			knr,
			funkretur,
			retur);
	}
	return(retur);
}

/* ***************************** */
static int check_sy_kkortfindes(kkort,kundenr)
char * kkort;
long int kundenr; {
	short int retur = 0;

	reclow(r178, R178);
	f178_start(1,ISGTEQ);
	reclow(r167, R167);
	strcpy(r167->kkortnr,kkort);
	f167_start(6, ISGTEQ);
	if (f167_ukendt) {
		retur = -1;
	}
	while (retur==0) {
		egeread(f167, ISNEXT);
		if (f167_eof) {
			break;
		}
		if (strcmp(r167->kkortnr,kkort)!=0) {
			break;
		}
		if (r167->type!=1) {
			continue;
		}
		if (kundenr>0 && r167->kunde_nr==kundenr) {
			continue;
		}
		reclow(r178, R178);
		r178->kunde_nr = r167->kunde_nr;
		r178->opl_kode = 11;
		egeread(f178, ISEQUAL);
		if (f178_ok &&
			strncmp(r178->alfa_felt,"SY",2)==0) {
			retur = 1;
		}
	}
	return(retur);
}

/* ***************************** */
static int check_sy_kundenr(long kundenr) {
	short int retur = 0;

	if (logfil) {
		fprintf(logfil,"check_sy_kundenr:kundenr=%ld\n", kundenr);
	}
	reclow(r178, R178);
	f178_start(1,ISGTEQ);
	r178->kunde_nr = (double)kundenr;
	r178->opl_kode = 11;
	egeread(f178, ISEQUAL);
	if (f178_ukendt) {
		retur = -1;
	}
	if (f178_ok &&
		strncmp(r178->alfa_felt,"SY",2)==0) {
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"check_sy_kundenr:retur=%hd\n", retur);
	}
	return(retur);
}

/* ***************************** */
static int check_ps_kundenr(long kundenr) {
	short int retur = 0;

	if (logfil) {
		fprintf(logfil,"check_ps_kundenr:kundenr=%ld\n", kundenr);
	}
	reclow(r178, R178);
	f178_start(1,ISGTEQ);
	r178->kunde_nr = (double)kundenr;
	r178->opl_kode = 11;
	egeread(f178, ISEQUAL);
	if (f178_ukendt) {
		retur = -1;
	}
	if (f178_ok &&
		strncmp(r178->alfa_felt,"PS",2)==0) {
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"check_ps_kundenr:retur=%hd\n", retur);
	}
	return(retur);
}

/* ***************************** */
static int check_ec_kundenr(long kundenr) {
	short int retur = 0;

	if (logfil) {
		fprintf(logfil,"check_ec_kundenr:kundenr=%ld\n", kundenr);
	}
	reclow(r178, R178);
	f178_start(1,ISGTEQ);
	r178->kunde_nr = (double)kundenr;
	r178->opl_kode = 11;
	egeread(f178, ISEQUAL);
	if (f178_ukendt) {
		retur = 1;
	}
	if (f178_ok &&
		strncmp(r178->alfa_felt,"EC",2)==0) {
		retur = 1;
	}
	if (f178_ok &&
		!strlen(r178->alfa_felt)) {
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"check_ec_kundenr:retur=%hd\n", retur);
	}
	return(retur);
}

/* ***************************** */
static int check_udldk_kundenr(long kundenr) {
	short int retur = 0;

	if (logfil) {
		fprintf(logfil,"check_udldk_kundenr:kundenr=%ld\n", kundenr);
		fflush(logfil);
	}
	reclow(r178, R178);
	f178_start(1,ISGTEQ);
	r178->kunde_nr = (double)kundenr;
	r178->opl_kode = 11;
	egeread(f178, ISEQUAL);
	if (f178_ukendt) {
		retur = 1;
	}
	if (f178_ok &&
		strncmp(r178->alfa_felt,"EC",2)==0) {
		retur = 1;
	}
	if (f178_ok &&
		!strlen(r178->alfa_felt)) {
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"check_udldk_kundenr:retur=%hd\n", retur);
		fflush(logfil);
	}
	return(retur);
}

/* *********************************************************** */
static int check_udldk_altiata() {
	int retur = 0;

	if (logfil) {
		fprintf(logfil,"check_udldk_altiata:ws_udldkland=%s\n",
			ws_udldkland);
		fflush(logfil);
	}
	if (strcmp(ws_udldkland,"GRØNLAND")==0) {
		retur = 32;
	}
	if (strcmp(ws_udldkland,"GREENLAND")==0) {
		retur = 32;
	}
	if (strcmp(ws_udldkland,"FÆRØERNE")==0) {
		retur = 31;
	}
	if (ws_udldkflag==3 && retur==32) {
		retur = 35;
	}
	if (ws_udldkflag==3 && retur==31) {
		retur = 34;
	}
	if (ws_udldkflag==3 && retur==32) {
		retur = 38;
	}
	if (ws_udldkflag==2 && retur==31) {
		retur = 37;
	}
	if (logfil) {
		fprintf(logfil,"check_udldk_altiata:retur=%d\n", retur);
		fflush(logfil);
	}
	return(retur);
}

/* ********************************* */
static void send_prisforslag(funk,langstr,grp,station,tilst,fradato,tildato,fratid,tiltid,pai)
short int funk;
char * langstr;
char * grp;
short int station;
short int tilst;
long int fradato;
long int tildato;
long int fratid;
long int tiltid;
short int pai; {
	long int chknum;
	long int returdgn = 0;
	long int kundedgn = 0;
	long int antaldgn = 0;
	long int antaltmr = 0;
	long int julian = 0;
	short int fraugdgnr;
	short int tilugdgnr;
	short int okflag = 0;
	int flaaderetur = 0;
	short int antal = 0;
	char transstr[21] = "";
	char tmpstr[81];
	char returstr[41];
	char sort_buffer[101];
	long int sort_afvigelse;
	short int sort_kundeinfo;
	long int sort_fradato;
	long int sort_tildato;
	long int sort_fratid;
	long int sort_tiltid;
	double sort_pris;

	sprintf(dum_str,
"send_prisforslag:fnk=%hd,stat=%hd-%hd,grp=%s,dato=%ld-%ld,tid=%ld-%ld,pai=%hd",
		funk,
		station,
		tilst,
		grp,
		fradato,
		tildato,
		fratid,
		tiltid,
		pai);
        logfil_put(dum_str);

	chknum = m036_funktion(11, (long int)fradato);
	fraugdgnr = (short int)(chknum % 10);
	chknum = m036_funktion(11, (long int)tildato);
	tilugdgnr = (short int)(chknum % 10);
	julian = m036_funktion(12, tildato);
	antaldgn = julian - m036_funktion(12, fradato);
	antaltmr = tiltid - fratid;
	antaltmr /= 100;
	if (antaltmr<0) {
		antaltmr = 0;
	}
#ifdef egetest
/* MAX 4 TIMER */
	if (antaldgn==0 && antaltmr>4) {
/* TEST */
		sprintf(dum_str, "send_prisforslag:>4 timer");
		logfil_put(dum_str);
		julian++;
		tildato = m036_funktion(19, julian);
		chknum = m036_funktion(11, (long int)tildato);
		tilugdgnr = (short int)(chknum % 10);
		antaldgn = julian - m036_funktion(12, fradato);
		antaltmr = 0;
		tiltid = 800;
	}
/* EXTRA DGN */
	if (antaldgn>0 && tiltid>800) {
/* TEST */
		sprintf(dum_str, "send_prisforslag:extra dg");
		logfil_put(dum_str);
		julian++;
		tildato = m036_funktion(19, julian);
		chknum = m036_funktion(11, (long int)tildato);
		tilugdgnr = (short int)(chknum % 10);
		antaldgn = julian - m036_funktion(12, fradato);
		antaltmr = 0;
	}
#endif
	kundedgn = antaldgn;
	sprintf(dum_str,
		"send_prisforslag:fraugd=%hd,tilugd=%hd,antdgn=%ld,anttmr=%ld",
		fraugdgnr,
		tilugdgnr,
		antaldgn,
		antaltmr);
        logfil_put(dum_str);
	if (antaldgn<0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-1);
		sprintf(ws_alert_txt, "DATOFEJL");
		pack_alfa(ws_alert_txt);
		pack_exchkend();
		send_linie();
		return;
	}
/*
        flaaderetur = check_ressourcer(0,station,fradato,tildato,grp);
	sprintf(dum_str,
		"send_prisforslag:flaaderetur=%d",
		flaaderetur);
        logfil_put(dum_str);
	if (flaaderetur<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)0);
		sprintf(ws_alert_txt, "%s ikke til rådighed", grp);
		pack_alfa(ws_alert_txt);
		pack_exchkend();
		send_linie();
		return;
	}
*/

	reclow(r198, R198);
	f198_start(1, ISGTEQ);

	reclow(r165, R165);
	r165->stat_nr = station;
	f165_start(2, ISGTEQ);
	if (f165_ukendt) {
		okflag = -1;
	}
	while (okflag>=0) {
		egeread(f165, ISNEXT);
		if (f165_eof) {
			break;
		}
		if (r165->stat_nr!=station) {
			break;
		}
		if (r165->slet_mark>0) {
			continue;
		}
		if (strlen(grp) &&
			strcmp(grp, r165->bil_grp)!=0) {
			continue;
		}
		if (r165->enhed<100) {
			continue;
		}
		returdgn = (long int)check_pris_data(r165->spec_nr,
			r165->enhed,
			r165->stat_nr,
			r165->bil_grp,
			fradato,
			tildato,
			fratid,
			tiltid,
			(long)fraugdgnr,
			(long)tilugdgnr,
			antaldgn,
			antaltmr,
			0,
			returstr);
		if (returdgn<0) {
			continue;
		}
		sprintf(dum_str,
		"send_prisforslag:returdgn=%ld,kundedgn=%ld,returstr=%s",
			returdgn,
			kundedgn,
			returstr);
        	logfil_put(dum_str);
		sscanf(returstr, "%ld %hd %ld %ld %ld %ld",
			&sort_afvigelse,
			&sort_kundeinfo,
			&sort_fradato,
			&sort_tildato,
			&sort_fratid,
			&sort_tiltid);
		if (check_bssaaben(-1,station,sort_fradato,sort_fratid)<=0) {
			continue;
		}
		if (check_bssaaben(-1,station,sort_tildato,sort_tiltid)<=0) {
			continue;
		}
		if (antal==0) {
			egesort(1, "sort");
		}
		ege_w_dou1 = r165->pris;
		if (r165->incl_flag[1]>0) {
			udregn_cdipai_beloeb(r165->enhed,
				1,
				(double)r165->rate_cdw,
				&ege_w_dou2);
			ege_w_dou1 += ege_w_dou2;
		}
		if (pai) {
			udregn_cdipai_beloeb(r165->enhed,
				1,
				(double)r165->rate_pai,
				&ege_w_dou2);
			ege_w_dou1 += ege_w_dou2;
		}
/*
		sort_match = abs(kundedgn - returdgn);
*/
		sprintf(sort_buffer,
			"%4ld %2hd %8.2lf %3hd %8ld %8ld %4ld %4ld \n \0",
			sort_afvigelse,
			sort_kundeinfo,
			ege_w_dou1,
			r165->spec_nr,
			sort_fradato,
			sort_tildato,
			sort_fratid,
			sort_tiltid);
		egesort(2, sort_buffer);
		antal++;
	}
	sprintf(dum_str, "send_prisforslag:antal=%hd",
		antal);
        logfil_put(dum_str);
	if (antal<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-1);
		pack_exchkend();
		send_linie();
		return;
	}
	reclow(r165, R165);
	f165_start(1, ISGTEQ);
	okflag = 1;
        egesort(3, "sort");
        while (okflag==1) {
                if (egesort(4, sort_buffer) <= 0) {
			break;
                }
		if (logfil) {
			fprintf(logfil, "send_prisforslag:sort_buffer=%s",
				sort_buffer);
		}
		reclow(r165, R165);
		sscanf(sort_buffer, "%ld %hd %lf %hd %ld %ld %ld %ld",
			&sort_afvigelse,
			&sort_kundeinfo,
			&sort_pris,
			&r165->spec_nr,
			&sort_fradato,
			&sort_tildato,
			&sort_fratid,
			&sort_tiltid);
		strcpy(r165->bil_grp, grp);
		r165->stat_nr = station;
		egeread(f165, ISEQUAL);
		if (f165_ukendt) {
			continue;
		}
		alfalow(str);
		pack_init(str);
		pack_int2((long)r165->spec_nr);
		dan_datotxt(langstr,sort_fradato,tmpstr);
		pack_alfa(tmpstr);
		sprintf(tmpstr, "%2.2ld:%2.2ld",
			sort_fratid/100,sort_fratid%100);
		pack_alfa(tmpstr);
		dan_datotxt(langstr,sort_tildato,tmpstr);
		pack_alfa(tmpstr);
		sprintf(tmpstr, "%2.2ld:%2.2ld",
			sort_tiltid/100,sort_tiltid%100);
		pack_alfa(tmpstr);
		pack_alfa(r165->bil_grp);
/* RETTET 040514 */
		(void)f198_tekst(langstr,
			16526,(double)0,r165->bil_grp,0,tmpstr);
		pack_alfa(tmpstr);
		pack_int2((long)r165->incl_km);
		pack_doub(sort_pris);
		pack_int2((long)pai);
		if (strcmp(langstr,"DK")==0 ||
			strcmp(langstr,"DA")==0) {
			pack_alfa(r165->tekst_1);
		} else {
			sprintf(transstr, "%5.5ld%5.5hd",
				16507,r165->spec_nr);
			trans_tekst(langstr,0,transstr,tmpstr);
			pack_alfa(tmpstr);
		}
		(void)f198_tekst(langstr,
			16501,(double)r165->spec_nr,"",0,tmpstr);
		pack_alfa(tmpstr);
		pack_doub(r165->ekstra_pr_km);
		pack_int2((long)sort_kundeinfo);
		pack_exchkend();
		send_linie();
	}
	return;
}

/* ************************************ */
/* funk 0 send_pris_forslag		*/
/* funk 1 send_liste	    		*/
/* ************************************ */
static int check_pris_data(spc,enh,st,grp,fdt,tdt,ftid,ttid,fugd,tugd,dgn,tmr,funk,rst)
short int spc;
short int enh;
short int st;
char * grp;
long int fdt;
long int tdt;
long int ftid;
long int ttid;
long int fugd;
long int tugd;
long int dgn;
long int tmr;
short int funk;
char * rst; {
	short int retur = -1;
	short int okflag = 0;
	short int prisextra = 0;
	short int prissmdgn = 0;
	long int chknum = 0;
	long int pristmr = 0;
	long int prisdgn = 0;
	long int prisdgn2 = 0;
	long int prisfugd[2] = {1,7};
	long int pristugd[2] = {1,7};
	long int prisftid[2] = {0,2400};
	long int pristtid[2] = {0,2400};
	long int returcheck = 0;
	short int returalternativ = 0;
	long int returafvigelse = 0;
	long int returdatofra = 0;
	long int returdatotil = 0;
	long int returtidfra = 0;
	long int returtidtil = 0;
	short int returflag = 0;
	long int returfra = 0;
	long int returtil = 0;
	long int kndfra = 0;
	long int kndtil = 0;
	long int prisfra[2] = {0,0};
	long int pristil[2] = {0,0};
	long int afvfra = 0;
	long int afvtil = 0;
	long int afvtot = 0;
	char tmpstr[41];
	char udvstr[81];
	char f198key[81];
	char intstr[41];

	strcpy(rst, "");
	kndfra = udvdatofunk(0,fdt,ftid);
	kndtil = udvdatofunk(0,tdt,ttid);
	if (logfil) {
		fprintf(logfil,
			"check_pris_data:spec=%hd,enh=%hd,st=%hd,grp=%s\n",
			spc,enh,st,grp);
		fprintf(logfil,"check_pris_data:kndfra-til=%10.10ld-%10.10ld\n",
			kndfra,kndtil);
		fprintf(logfil, "check_pris_data:fdt=%ld,tdt=%ld\n",
			fdt,tdt);
		fprintf(logfil, "check_pris_data:ftid=%ld,ttid=%ld\n",
			ftid, ttid);
		fprintf(logfil, "check_pris_data:fugd=%ld,tugd=%ld\n",
			fugd,tugd);
		fprintf(logfil, "check_pris_data:dgn=%ld,tmr=%ld\n",
			dgn,tmr);
		fprintf(logfil, "check_pris_data:funk=%hd\n",
			funk);
	}
	pristmr = 0;
	if (enh>100&&enh<200) {
		prisdgn = 0;
		pristmr = (enh%100);
	}
	if (enh>200&&enh<300) {
		prisdgn = (enh%200);
	}
	if (enh>300&&enh<400) {
		prisdgn = (enh%300);
		prisdgn *= 7;
	}
	if (enh>400&&enh<500) {
		prisdgn = (enh%400);
		prisdgn *= 30;
	}
	if (enh==501) {
		prisdgn = 3;
	}
	(void)find_r198(1,16503,(double)spc,"",0);
	if (strlen(r198->alfafelt)) {
		okflag = 1;
	}
/* std timer */
	if (okflag==0 && enh>100 && enh<200 &&
		dgn==prisdgn &&
		tmr==pristmr) {
		retur = prisdgn;
	}
/* std dage uger maaender */
	if (okflag==0 && enh>200 && enh<500 &&
		dgn==prisdgn) {
		retur = prisdgn;
	}
/* std weekend */
	if (okflag==0 && enh>=500 &&
		dgn==prisdgn && fugd==5) {
		retur = prisdgn;
	}
	if (okflag==0) {
		sprintf(rst, "%ld %ld %ld %ld %ld",
			0,
			fdt,
			tdt,
			ftid,
			ttid);
		return(retur);
	}
	(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
	if (strlen(tmpstr)) {
		sscanf(tmpstr, "%hd", &prisextra);
	}
	if (prisextra>0 && funk<=0) {
		return(-1);
	}
	(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
	if (strlen(tmpstr)) {
		sscanf(tmpstr, "%hd", &prissmdgn);
	}
/* FLYTTET 041001
	if (prissmdgn>0 && funk<=0 &&
		fdt != ws_systemdato) {
		return(-1);
	}
*/
/* fra ugedag */
	(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
	if (strlen(tmpstr)) {
		(void)get_alfa_tgn(tmpstr,0,intstr,'-');
		if (strlen(intstr)) {
			sscanf(intstr, "%ld", &prisfugd[0]);
			prisfugd[1] = prisfugd[0];
		}
		(void)get_alfa_tgn(tmpstr,1,intstr,'-');
		if (strlen(intstr)) {
			sscanf(intstr, "%ld", &prisfugd[1]);
		}
		if (prisfugd[0]==0 && prisfugd[1]==0) {
			prisfugd[0] = 1;
			prisfugd[1] = 7;
		}
	}
/* fra tid */
	(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
	if (strlen(tmpstr)) {
		(void)get_alfa_tgn(tmpstr,0,intstr,'-');
		if (strlen(intstr)) {
			sscanf(intstr, "%ld", &prisftid[0]);
		}
		(void)get_alfa_tgn(tmpstr,1,intstr,'-');
		if (strlen(intstr)) {
			sscanf(intstr, "%ld", &prisftid[1]);
		}
		if (prisftid[0]==0 && prisftid[1]==0) {
			prisftid[0] = 0;
			prisftid[1] = 2400;
		}
	}
/* til ugedag */
	(void)get_alfa_tgn(r198->alfafelt,4,tmpstr,';');
	if (strlen(tmpstr)) {
		(void)get_alfa_tgn(tmpstr,0,intstr,'-');
		if (strlen(intstr)) {
			sscanf(intstr, "%ld", &pristugd[0]);
			pristugd[1] = pristugd[0];
		}
		(void)get_alfa_tgn(tmpstr,1,intstr,'-');
		if (strlen(intstr)) {
			sscanf(intstr, "%ld", &pristugd[1]);
		}
		if (pristugd[0]==0 && pristugd[1]==0) {
			pristugd[0] = 1;
			pristugd[1] = 7;
		}
	}
/* til tid */
	(void)get_alfa_tgn(r198->alfafelt,5,tmpstr,';');
	if (strlen(tmpstr)) {
		(void)get_alfa_tgn(tmpstr,0,intstr,'-');
		if (strlen(intstr)) {
			sscanf(intstr, "%ld", &pristtid[1]);
		}
		(void)get_alfa_tgn(tmpstr,1,intstr,'-');
		if (strlen(intstr)) {
			pristtid[0] = pristtid[1];
			sscanf(intstr, "%ld", &pristtid[1]);
		}
		if (pristtid[0]==0 && pristtid[1]==0) {
			pristtid[0] = 0;
			pristtid[1] = 2400;
		}
	}
	if (enh==0) {
		(void)get_alfa_tgn(r198->alfafelt,6,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &prisdgn);
		}
		(void)get_alfa_tgn(r198->alfafelt,7,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &prisdgn2);
		}
	}
/* NYT 041001 */
	strcpy(udvstr,"");
	sprintf(f198key, "%3.3hd%3.3hd%s",
		st,
		spc,
		grp);
	strcpy(r198->alfafelt,"");
	if (find_r198(0,16527,(double)0,f198key,0)>0 &&
		strlen(r198->alfafelt)) {
		(void)get_alfa_tgn(r198->alfafelt,1,udvstr,';');
	}
	if (strlen(udvstr)) {
		sscanf(udvstr, "%hd", &prissmdgn);
	}
	if (prissmdgn>0 && funk<=0 &&
		fdt != ws_systemdato) {
		return(-1);
	}

	if (logfil) {
		fprintf(logfil, "check_pris_data:prisfugd=%ld-%ld\n",
			prisfugd[0],prisfugd[1]);
		fprintf(logfil, "check_pris_data:prisftid=%ld-%ld\n",
			prisftid[0],prisftid[1]);
		fprintf(logfil, "check_pris_data:pristugd=%ld-%ld\n",
			pristugd[0],pristugd[1]);
		fprintf(logfil, "check_pris_data:pristtid=%ld-%ld\n",
			pristtid[0],pristtid[1]);
		fprintf(logfil, "check_pris_data:prisdgn=%ld\n",
			prisdgn);
		fprintf(logfil, "check_pris_data:prisdgn2=%ld\n",
			prisdgn2);
		fprintf(logfil, "check_pris_data:pristmr=%ld\n",
			pristmr);
	}
	if (funk==1 && prisextra>0) {
		if (dgn>=prisdgn && dgn<=prisdgn2) {
			return(dgn);
		} else {
			return(-1);
		}
	}
/* chk 1 */
	chknum = 0;
	if (prisfugd[0]>=1 && prisfugd[1]<=7 &&
		fugd<prisfugd[0]) {
		chknum = m036_funktion(12, fdt);
		chknum -= (fugd-prisfugd[0]);
		prisfra[0] = udvdatofunk(1,chknum,prisftid[0]);
		chknum += prisdgn;
	}
/* chk 2 */
	if (prisfugd[0]>=1 && prisfugd[1]<=7 &&
		fugd>prisfugd[0]) {
		chknum = m036_funktion(12, fdt);
		chknum -= (fugd-prisfugd[0]);
		prisfra[0] = udvdatofunk(1,chknum,prisftid[0]);
	}
/* chk 3 */
	if (prisfugd[0]>=1 && prisfugd[1]<=7 &&
		fugd<prisfugd[1]) {
		chknum = m036_funktion(12, fdt);
		chknum -= (fugd-prisfugd[1]);
		prisfra[1] = udvdatofunk(1,chknum,prisftid[1]);
	}
/* chk 4 */
	if (prisfugd[0]>=1 && prisfugd[1]<=7 &&
		fugd>prisfugd[1]) {
		chknum = m036_funktion(12, fdt);
		chknum -= (fugd-prisfugd[1]);
		prisfra[1] = udvdatofunk(1,chknum,prisftid[1]);
	}
/* chk 5 */
	if (prisfugd[0]>=1 && prisfugd[1]<=7 &&
		fugd>=prisfugd[0] &&
		fugd<=prisfugd[1]) {
		chknum = m036_funktion(12, fdt);
		prisfra[0] = udvdatofunk(1,chknum,prisftid[0]);
		prisfra[1] = udvdatofunk(1,chknum,prisftid[1]);
	}
/* chk 6 */
	if (chknum>0 &&
		pristugd[0]>=1 && pristugd[1]<=7) {
		chknum +=prisdgn;
		pristil[0] = udvdatofunk(1,chknum,pristtid[0]);
		pristil[1] = udvdatofunk(1,chknum,pristtid[1]);
	}
/* chk 7 */
	if (prisfugd[0]>7 && prisfugd[1]>7 &&
		fdt>=prisfugd[0] &&
		fdt<=prisfugd[1]) {
		chknum = m036_funktion(12, fdt);
		prisfra[0] = udvdatofunk(1,chknum,prisftid[0]);
		prisfra[1] = udvdatofunk(1,chknum,prisftid[1]);
		chknum +=prisdgn;
		pristil[0] = udvdatofunk(1,chknum,pristtid[0]);
		pristil[1] = udvdatofunk(1,chknum,pristtid[1]);
	}
/* timer */
	if (pristmr>0 && prisdgn<=0) {
		prisfra[0] = udvdatofunk(0,fdt,ftid);
		prisfra[1] = prisfra[0];
		chknum = ftid;
		chknum += (pristmr * 100);
		pristil[0] = udvdatofunk(0,tdt,chknum);
		pristil[1] = pristil[0];
	}
	if (logfil) {
		fprintf(logfil, "check_pris_data:prisfra=%10.10ld-%10.10ld\n",
			prisfra[0],prisfra[1]);
		fprintf(logfil, "check_pris_data:pristil=%10.10ld-%10.10ld\n",
			pristil[0],pristil[1]);
	}
	returtidfra = ftid;
	returtidtil = ttid;
	returdatofra = fdt;
	returdatotil = tdt;
/* extraudstyr */
	if (enh==0 &&
		prisfugd[0]==1 &&
		prisfugd[1]==7 &&
		prisftid[0]==0 &&
		prisftid[1]==2400 &&
		pristugd[0]==1 &&
		pristugd[1]==7 &&
		pristtid[0]==0 &&
		pristtid[1]==2400 &&
		dgn>=prisdgn &&
		dgn<=prisdgn2) {
		retur = 1;
	}
	if (prisfra[0]>0 && pristil[1]>0) {
		afvfra = udvdatofunk(10,prisfra[0],kndfra);
		afvtil = udvdatofunk(10,kndtil,pristil[1]);
		afvtot = afvtil+afvfra;
	}
/* dage */
	if (dgn>=0 && pristmr==0 &&
		kndfra>=prisfra[0] &&
		kndtil<=pristil[1]) {
		returafvigelse = 0;
		retur = prisdgn;
	}
/* timer */
	if (dgn==0 && pristmr>0 &&
		kndfra>=prisfra[0] &&
		kndtil<=pristil[1]) {
		returafvigelse = 0;
		retur = prisdgn;
	}

	if (logfil) {
		fprintf(logfil,
		"check_pris_data:retur=%hd,afvfra=%ld,til=%ld,tot=%ld\n",
			retur,
			afvfra,
			afvtil,
			afvtot);
	}
/* droppe */
	if (retur>=0 && afvtot>24) {
		retur = -2;
	}
	if (retur>=0 && afvtot<-36) {
		retur = -2;
	}
/* juster returtidspunkt */
	if (retur>=0 && afvfra>0) {
		returafvigelse = abs(afvtot)+100;
		returfra = prisfra[0];
		returtidfra = prisfra[0]%10000;
		returdatofra = udvdatofunk(20,prisfra[0],0);
		returflag += 4;
	}
	if (retur>=0 && afvfra==0) {
		returfra = kndfra;
		returtidfra = ftid;
		returdatofra = fdt;
	}
	if (retur>=0 && afvfra<0) {
		returafvigelse = abs(afvtot);
		returfra = kndfra;
		returtidfra = ftid;
		returdatofra = fdt;
		returflag += 1;
	}
	if (retur>=0 && afvtil>0) {
		returafvigelse = abs(afvtot)+100;
		returtil = pristil[1];
		returtidtil = pristil[1]%10000;
		returdatotil = udvdatofunk(20,pristil[1],0);
		returflag += 8;
	}
	if (retur>=0 && afvtil==0) {
		returafvigelse = abs(afvtot);
		returtil = kndtil;
		returtidtil = ttid;
		returdatotil = tdt;
	}
	if (retur>=0 && afvtil>-24 && afvtil<0) {
		returafvigelse = abs(afvtot);
		returtil = kndtil;
		returtidtil = ttid;
		returdatotil = tdt;
		returflag += 2;
	}
	if (retur>=0 && afvtil>=-36 && afvtil<=-24) {
		returalternativ = 1;
		returafvigelse = abs(afvtot);
		returtil = kndtil;
		returtidtil = ttid;
		returdatotil = tdt;
		returflag += 2;
/*
		returtidtil = pristil[1]%10000;
		returdatotil = udvdatofunk(20,pristil[1],0);
*/
	}


/* tillad andre priser */
	if (retur==-1 && 
		prisdgn>=dgn &&
		fugd>=prisfugd[0] && fugd<=prisfugd[1] &&
		(afvfra!=0 || afvtil!=0) &&
		abs(afvtot)<=24) {
		if (logfil) {
			fprintf(logfil, "check_pris_data:tillad andre 1\n");
		}
		retur = prisdgn;
		returalternativ = 1;
		returafvigelse = abs(afvtot)+200;
		if (afvfra<0) {
			returfra = kndfra;
			returtidfra = ftid;
			returdatofra = fdt;
			returflag += 1;
		}
		if (afvfra==0) {
			returfra = kndfra;
			returtidfra = ftid;
			returdatofra = fdt;
		}
		if (afvfra>0) {
			returfra = prisfra[0];
			returtidfra = prisfra[0]%10000;
			returdatofra = udvdatofunk(20,prisfra[0],0);
			returflag += 4;
		}
		if (afvtil<0) {
			returtil = kndtil;
			returtidtil = ttid;
			returdatotil = tdt;
			returflag += 2;
		}
		if (afvtil==0) {
			returtil = kndtil;
			returtidtil = ttid;
			returdatotil = tdt;
		}
		if (afvtil>0) {
			returtil = pristil[1];
			returtidtil = pristil[1]%10000;
			returdatotil = udvdatofunk(20,pristil[1],0);
			returflag += 8;
		}
	}
	if (retur==-2 && 
		prisdgn>=dgn &&
		dgn<=2 &&
		fugd==6 &&
		prisfugd[0]==5 && prisfugd[1]==5) {
		if (logfil) {
			fprintf(logfil, "check_pris_data:tillad andre 2\n");
		}
		retur = prisdgn;
		returalternativ = 1;
		returafvigelse = abs(afvtot)+200;
		if (kndfra<prisfra[0]) {
			returfra = prisfra[0];
			returtidfra = prisfra[0]%10000;
			returdatofra = udvdatofunk(20,prisfra[0],0);
			returflag += 4;
		}
		if (kndfra>prisfra[0]) {
			returfra = kndfra;
			returtidfra = ftid;
			returdatofra = fdt;
			returflag += 1;
		}
		if (kndfra>prisfra[1]) {
			returtil = pristil[1];
			returtidtil = pristil[1]%10000;
			returdatotil = udvdatofunk(20,pristil[1],0);
			returflag += 8;
		}
		if (kndfra<prisfra[1]) {
			returfra = kndtil;
			returtidfra = ttid;
			returdatofra = tdt;
			returflag += 2;
		}
	}

	if (logfil) {
		fprintf(logfil, "check_pris_data:returalternativ=%hd\n",
			returalternativ);
		fprintf(logfil, "check_pris_data:returflag=%hd\n",
			returflag);
	}
	sprintf(rst, "%ld %hd %ld %ld %ld %ld",
		returafvigelse,
		returflag,
		returdatofra,
		returdatotil,
		returtidfra,
		returtidtil);
	if (logfil) {
		fprintf(logfil,
		"check_pris_data:RETUR=%hd,rst=%s\n",
			retur,
			rst);
	}
	return(retur);
}

/* **************************************************** */
/* funk 0 inp1=dato inp2=tid		retur=amdtm	*/
/*      1 inp1=julian inp2=tid		retur=amdtm	*/
/*     10 inp1=amdtm inp2=amdtm		retur=timer	*/
/*     20 inp1=amdtm inp2=0		retur=aaaammdd	*/
/* **************************************************** */
static long int udvdatofunk(funk,inp1,inp2)
short int funk;
long int inp1;
long int inp2; {
	long int returdato = 0;
	long int julian = 0;
	long int funkdato = 0;

	switch(funk) {
	case 0 :
		returdato = inp1%1000000;
		returdato *= 10000;
		returdato += inp2;
		break;
	case 1 :
		funkdato = m036_funktion(19, inp1);
		returdato = funkdato%1000000;
		returdato *= 10000;
		returdato += inp2;
		break;
	case 10 :
		returdato = 0;
		funkdato = (inp1/10000-inp2/10000);
		returdato += funkdato * 24;
		funkdato = (inp1%10000-inp2%10000);
		returdato += (funkdato/100);
		break;
	case 20 :
		returdato = inp1/10000;
		returdato += 20000000;
		break;
	default :
		break;
	}
	return((long int)returdato);
}

/* ****************************** */
static int check_pris_extramulige(specnr,grp)
short int specnr;
char * grp; {
	short int retur = 0;
	short int okflag = 1;
	short int fundetflag = 0;

	if (logfil) {
		fprintf(logfil, "check_pris_extramulige:specnr=%hd,grp=%s\n",
			specnr,
			grp);
	}
	reclow(r198, R198);
	r198->oplkode = 16504;
	r198->keynum = specnr;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		okflag = 0;
	}
	while(okflag) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=16504) {
			break;
		}
		if (r198->keynum!=specnr) {
			break;
		}
		ege_toupper((unsigned char *)r198->alfafelt);
		if (strcmp(r198->alfafelt, "ALLE")==0) {
			retur = 1;
			break;
		}
		if (strcmp(r198->alfafelt, "*")==0) {
			retur = 1;
			break;
		}
		fundetflag++;
		if (strcmp(r198->alfafelt, grp)==0) {
			retur = 1;
			break;
		}
	}
	if (fundetflag==0) {
		retur = 1;
	}
	return(retur);
}

/* ************************* */
static int check_tilbud(station,dato,returstr)
short int station;
long int dato;
char * returstr; {
	short int retur = 0;
	short int prisextra = 0;
	short int prissmdgn = 0;
	long int prisfugd[2] = {1,7};
	char tmpstr[81];
	char intstr[81];

	if (logfil) {
		fprintf(logfil, "check_tilbud:station=%hd,dato=%ld\n",
			station,
			dato);
	}
	reclow(r198, R198);
	r198->oplkode = 16503;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		retur = -1;
	}
	while (retur==0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=16503) {
			break;
		}
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%hd", &prisextra);
		}
		if (prisextra>0) {
			continue;
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%hd", &prissmdgn);
		}
		if (prissmdgn>0 &&
			dato != ws_systemdato) {
			continue;
		}
/* fra ugedag */
		(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
		if (strlen(tmpstr)) {
			(void)get_alfa_tgn(tmpstr,0,intstr,'-');
			if (strlen(intstr)) {
				sscanf(intstr, "%ld", &prisfugd[0]);
				prisfugd[1] = prisfugd[0];
			}
			(void)get_alfa_tgn(tmpstr,1,intstr,'-');
			if (strlen(intstr)) {
				sscanf(intstr, "%ld", &prisfugd[1]);
			}
			if (prisfugd[0]==0 && prisfugd[1]==0) {
				prisfugd[0] = 1;
				prisfugd[1] = 7;
			}
		}
		if (dato<prisfugd[0] ||
			dato>prisfugd[1]) {
			continue;
		}
		sprintf(returstr,"%ld %ld",prisfugd[0],prisfugd[1]);
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil, "check_tilbud:retur=%hd,returstr=%s\n",
			retur,
			returstr);
	}
	return(retur);
}

/* ********************************* */
static void ecweb_grpliste(short funk,char *langstr,short station,short donflag) {
	short int grpidx = 1;
	short int videre = 0;
	char returstr[81] = "";
	char tmpstr[81] = "";
	char beskrtxt[81] = "";
	char valgttxt[81] = "";
	char webgrp[41] = "";

	if (logfil) {
		fprintf(logfil,
		"ecweb_grpliste:16663 ws_systemdato=%ld station=%hd\n",
			ws_systemdato,
			station);
		fflush(logfil);
	}
/* NYT 120102 KAMPAGNEGRPO */
	reclow(r198,R198);
	r198->oplkode = 16663;
	r198->keynum = (double)station;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		videre = -1;
	}
	while (videre>=0) {
		egeread(f198,ISNEXT);
		if (f198_eof) { break; }
		if (r198->oplkode!=16663) { break; }
		if (r198->keynum!=(double)station) { break; }
		if (r198->numfelt<=0) { continue; }
 		if (ws_systemdato<r198->fradato||ws_systemdato>r198->tildato) {
			continue;
		}
		reccpy(&q198,r198,R198);
		strcpy(webgrp,q198.keyalfa);
		ege_toupper((unsigned char *)webgrp);
		alfalow(str);
		pack_init(str);
		pack_alfa(webgrp);
		(void)get_alfa_tgn(q198.alfafelt,0,beskrtxt,59);
		(void)get_alfa_tgn(q198.alfafelt,1,valgttxt,59);
		pack_alfa(beskrtxt);
		pack_alfa(valgttxt);
		strcpy(tmpstr,"0800");
		pack_alfa(tmpstr);

		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		reccpy(r198, &q198, R198);
		f198_start(1, ISGREAT);
		if (f198_ukendt) {
			break;
		}
		videre++;
	}
	while (grpidx>=1) {
		strcpy(returstr,"P7911EC");
		sprintf(tmpstr,"WebGrp%3.3d=",grpidx);
		sprintf(dum_str, "ecweb_grpliste:%s+%s",
			returstr,
			tmpstr);
		logfil_put(dum_str);
		if (retur_f198_def((long int)1002,tmpstr,returstr)>0) {
			strcpy(webgrp,returstr);
		} else {
			break;
		}
		alfalow(str);
		pack_init(str);
		pack_alfa(webgrp);
		strcpy(beskrtxt,"");
		strcpy(returstr,"P7911EC");
		sprintf(tmpstr,"BeskrWebGrp%s=",webgrp);
		if (retur_f198_def((long int)1002,tmpstr,returstr)>0) {
			strcpy(beskrtxt,returstr);
		}
		pack_alfa(beskrtxt);
		strcpy(valgttxt,"");
		strcpy(returstr,"P7911EC");
		sprintf(tmpstr,"ValgtWebGrp%s=",webgrp);
		if (retur_f198_def((long int)1002,tmpstr,returstr)>0) {
			strcpy(valgttxt,returstr);
		}
		pack_alfa(valgttxt);
/* NYT 061023 BETA-2 */
		strcpy(tmpstr,"0800");
		if (webgrp[0]>=48 && webgrp[0]<=57) {
			strcpy(tmpstr,"0700");
		}
		pack_alfa(tmpstr);

		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		grpidx++;
	}
	return;
}

/* ********************************* */
static int ecweb_grpliste2(short funk,char *langstr,short station,short donflag) {
	short int grpidx = 1;
	short int wx1 = 0;
	short int videre = 0;
	short int okflag = 0;
	short int tmpnum = 0;
	short int funkretur = 0;
	char biltype[41] = "";
	char returstr[81] = "";
	char tmpstr[81] = "";
	char beskrtxt[81] = "";
	char valgttxt[81] = "";
	char webgrp[41] = "";
	char sortgrp[21] = "";
	char sorttxt1[61] = "";
	char sorttxt2[61] = "";
	char sortbuffer[201] = "";

/* TEST */
	if (logfil) {
		fprintf(logfil,
		"ecweb_grpliste2:funk=%hd,station=%hd,donflag=%hd\n",
		funk,
		station,
		donflag);
	}

	reclow(r198,R198);
	r198->oplkode = 16627;
	r198->keynum = (double)station;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		videre = -1;
	}
	while (videre>=0) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
/* TEST */
		if (logfil) {
			fprintf(logfil,
		"ecweb_grpliste2:videre=%hd,opl=%ld,keynum=%.0lf,numfelt=%.0lf\n",
			videre,
			r198->oplkode,
			r198->keynum,
			r198->numfelt);
		}
		if (r198->oplkode!=16627) {
			break;
		}
		if (r198->keynum!=(double)station) {
			break;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		reccpy(&q198,r198,R198);
		if (ecweb_check_bilgrp(q198.keyalfa,biltype)<=1) {
			reccpy(r198, &q198, R198);
			f198_start(1, ISGREAT);
			if (f198_ukendt) {
				break;
			}
			continue;
		}
		strcpy(webgrp,q198.keyalfa);
		ege_toupper((unsigned char *)webgrp);
/* NYT 071016 CHECK st spc grp */
/* IKKE AKTIVERET
		funkretur = check_grpspcst_findes(webgrp,biltype,station);
		if (logfil) {
			fprintf(logfil,
			"ecweb_grpliste2:check_grpspcst_findes funkretur=%hd\n",
			funkretur);
		}
		if (funkretur<=0) {
			reccpy(r198, &q198, R198);
			f198_start(1, ISGREAT);
			if (f198_ukendt) {
				break;
			}
			continue;
		}
*/

		strcpy(beskrtxt,"");
		strcpy(returstr,"P7911EC");
		sprintf(tmpstr,"BeskrWebGrp%s=",webgrp);
		if (retur_f198_def((long int)1002,tmpstr,returstr)>0) {
			strcpy(beskrtxt,returstr);
		} else {
			sprintf(beskrtxt,"%s MANGLER",tmpstr);
		}
		strcpy(valgttxt,"");
		strcpy(returstr,"P7911EC");
		sprintf(tmpstr,"ValgtWebGrp%s=",webgrp);
		if (retur_f198_def((long int)1002,tmpstr,returstr)>0) {
			strcpy(valgttxt,returstr);
		} else {
			sprintf(valgttxt,"%s MANGLER",tmpstr);
		}
		reccpy(r198, &q198, R198);
		f198_start(1, ISGREAT);
		if (f198_ukendt) {
			break;
		}
		if (videre==0) {
			egesort(1, "sort");
		}
		strcpy(sortgrp,webgrp);
		if (webgrp[0]>=65 && webgrp[0]<=90) {
			sprintf(sortgrp,"%-4s",webgrp);
		}
		if (webgrp[0]>=48 && webgrp[0]<=57) {
			sscanf(webgrp,"%hd",&tmpnum);
			sprintf(sortgrp,"%4.4hd",tmpnum);
		}
		if (webgrp[0]>=65 && webgrp[0]<=90 &&
			webgrp[1]>=48 && webgrp[1]<=57) {
			sscanf(webgrp+1,"%hd",&tmpnum);
			sprintf(sortgrp,"%c%3.3hd",webgrp[0],tmpnum);
		}

		strcpy(sorttxt1,beskrtxt);
		strcpy(sorttxt2,valgttxt);

		for (wx1=0;wx1<sizeof(sortgrp);wx1++)  {
			if (sortgrp[wx1] == ' ') {
				sortgrp[wx1] = '!';
			}
		}
		if (!strlen(sortgrp)) {
			strcpy(sortgrp, "!!!!");
		}
		for (wx1=0;wx1<sizeof(sorttxt1);wx1++)  {
			if (sorttxt1[wx1] == ' ') {
				sorttxt1[wx1] = '!';
			}
		}
		if (!strlen(sorttxt1)) {
			strcpy(sorttxt1,
	"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
		}
		for (wx1=0;wx1<sizeof(sorttxt2);wx1++)  {
			if (sorttxt2[wx1] == ' ') {
				sorttxt2[wx1] = '!';
			}
		}
		if (!strlen(sorttxt2)) {
			strcpy(sorttxt2,
	"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
		}
		sprintf(sortbuffer,"%-4s %-60s %-60s %s\n \0",
			sortgrp,
			sorttxt1,
			sorttxt2,
			webgrp);
		egesort(2, sortbuffer);
		videre++;
	}
	if (videre<=0) {
		return(0);
	}
	okflag = 1;
	egesort(3, "sort");
	while (okflag==1) {
		if (egesort(4, sortbuffer) <= 0) {
			okflag = 0;
		}
/* ingen brud */
		if (okflag==0) {
			break;
		}
		sscanf(sortbuffer, "%s %s %s %s",
			sortgrp,
			sorttxt1,
			sorttxt2,
			webgrp);
		for (wx1=0;wx1<sizeof(sortgrp);wx1++)  {
			if (sortgrp[wx1] == '!') {
				sortgrp[wx1] = ' ';
			}
		}
		egechartest((unsigned char *)sortgrp);
		for (wx1=0;wx1<sizeof(sorttxt1);wx1++)  {
			if (sorttxt1[wx1] == '!') {
				sorttxt1[wx1] = ' ';
			}
		}
		egechartest((unsigned char *)sorttxt1);
		for (wx1=0;wx1<sizeof(sorttxt2);wx1++)  {
			if (sorttxt2[wx1] == '!') {
				sorttxt2[wx1] = ' ';
			}
		}
		egechartest((unsigned char *)sorttxt2);
		alfalow(str);
		pack_init(str);
		pack_alfa(webgrp);
		pack_alfa(sorttxt1);
		pack_alfa(sorttxt2);
/* NYT 061023 BETA-2 */
		strcpy(tmpstr,"0800");
		if (webgrp[0]>=48 && webgrp[0]<=57) {
			strcpy(tmpstr,"0700");
		}
		pack_alfa(tmpstr);

		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
	if (logfil) {
		fprintf(logfil,"ecweb_grpliste2:videre=%hd\n",videre);
	}
	return(videre);
}

/* ********************************* */
static int ecweb_grpliste3(short funk,char *langstr,short station,short donflag) {
	short int grpidx = 1;
	short int wx1 = 0;
	short int videre = 0;
	short int okflag = 0;
	short int tmpnum = 0;
	short int funkretur = 0;
	short int statkat = 0;
	char chkbilkat[11] = "";
	char chkbilgrp[11] = "";
	char returstr[81] = "";
	char tmpstr[81] = "";
	char beskrtxt[81] = "";
	char valgttxt[81] = "";
	char webgrp[41] = "";
	char sortgrp[21] = "";
	char lastgrp[21] = "";
	char sorttxt1[71] = "";
	char sorttxt2[71] = "";
	char sortbuffer[201] = "";

/* TEST */
	if (logfil) {
		fprintf(logfil,
		"ecweb_grpliste3:funk=%hd,station=%hd,donflag=%hd\n",
		funk,
		station,
		donflag);
		fprintf(logfil,
		"ecweb_grpliste3:ws_udldkflag=%hd\n",ws_udldkflag);
		fflush(logfil);
	}
	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16649;
	r198->keynum = (double)station;
	egeread(f198,ISEQUAL);
	if (f198_ukendt) {
		return(0);
	}
	statkat = (short int)r198->numfelt;
/* TEST */
	if (logfil) {
		fprintf(logfil,
		"ecweb_grpliste3:statkat=%hd\n",statkat);
	}
	reclow(r198,R198);
	r198->oplkode = 16650;
	r198->keynum = (double)statkat;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		videre = -1;
	}
	while (videre>=0) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=16650) {
			break;
		}
		if (r198->keynum!=(double)statkat) {
			break;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		reccpy(&q198,r198,R198);
		funkretur = check_udldk_st_undt(station,q198.alfafelt);
		if (funkretur>0) {
			reccpy(r198,&q198,R198);
			f198_start(1, ISGREAT);
			if (f198_ukendt) {
				break;
			}
			continue;
		}
/* EVT CHECK GRP SPC FINDES */
		(void)get_alfa_tgn(q198.alfafelt,0,chkbilkat,45);
		(void)get_alfa_tgn(q198.alfafelt,1,chkbilgrp,45);

		strcpy(webgrp,chkbilgrp);
		ege_toupper((unsigned char *)webgrp);

		strcpy(beskrtxt,q198.alfafelt);
		reclow(r198,R198);
		f198_start(1,ISGTEQ);
		r198->oplkode = 16824;
		strcpy(r198->keyalfa,q198.alfafelt);
		egeread(f198,ISEQUAL);
		if (f198_ok) {
			strcpy(beskrtxt,r198->alfafelt);
		}
/* NYT 090423 */
		reclow(r198,R198);
		f198_start(1,ISGTEQ);
		r198->oplkode = 16828;
		strcpy(r198->keyalfa,chkbilgrp);
		egeread(f198,ISEQUAL);
		if (f198_ok) {
			strcpy(beskrtxt,r198->alfafelt);
		}

		strcpy(valgttxt,"");
		reclow(r198,R198);
		f198_start(1,ISGTEQ);
		r198->oplkode = 16826;
		sprintf(r198->keyalfa,"*-%s",chkbilgrp);
		egeread(f198,ISEQUAL);
		if (f198_ok) {
			strcpy(valgttxt,r198->alfafelt);
		}

		if (videre==0) {
			egesort(1, "sort");
		}
		strcpy(sortgrp,webgrp);
		if (webgrp[0]>=65 && webgrp[0]<=90) {
			sprintf(sortgrp,"%-4s",webgrp);
		}
		if (webgrp[0]>=48 && webgrp[0]<=57) {
			sscanf(webgrp,"%hd",&tmpnum);
			sprintf(sortgrp,"%4.4hd",tmpnum);
		}
		if (webgrp[0]>=65 && webgrp[0]<=90 &&
			webgrp[1]>=48 && webgrp[1]<=57) {
			sscanf(webgrp+1,"%hd",&tmpnum);
			sprintf(sortgrp,"%c%2.2hd",
				webgrp[0],tmpnum);
		}
		if (webgrp[0]>=65 && webgrp[0]<=90 &&
			webgrp[1]>=48 && webgrp[1]<=57 &&
			webgrp[2]>=65 && webgrp[2]<=90) {
			sscanf(webgrp+1,"%hd",&tmpnum);
			sprintf(sortgrp,"%c%2.2hd%c",
				webgrp[0],tmpnum,webgrp[2]);
		}
/* NYT 100503 */
		if (webgrp[0]>=65 && webgrp[0]<=90 &&
			webgrp[1]>=48 && webgrp[1]<=57 &&
			webgrp[2]>=65 && webgrp[2]<=90 &&
			webgrp[3]>=65 && webgrp[3]<=90) {
			sscanf(webgrp+1,"%hd",&tmpnum);
			sprintf(sortgrp,"%c%2.2hd%c%c",
				webgrp[0],tmpnum,webgrp[2],webgrp[3]);
		}

		if (webgrp[0]>=65 && webgrp[0]<=90 &&
			webgrp[1]>=48 && webgrp[1]<=57 &&
			webgrp[2]>=48 && webgrp[2]<=57 &&
			webgrp[3]>=65 && webgrp[3]<=90) {
			sscanf(webgrp+1,"%hd",&tmpnum);
			sprintf(sortgrp,"%c%2.2hd%c",
				webgrp[0],tmpnum,webgrp[3]);
		}

		strcpy(sorttxt1,beskrtxt);
		strcpy(sorttxt2,valgttxt);

		for (wx1=0;wx1<sizeof(sortgrp);wx1++)  {
			if (sortgrp[wx1] == ' ') {
				sortgrp[wx1] = '!';
			}
		}
		if (!strlen(sortgrp)) {
			strcpy(sortgrp, "!!!!");
		}
		for (wx1=0;wx1<sizeof(sorttxt1);wx1++)  {
			if (sorttxt1[wx1] == ' ') {
				sorttxt1[wx1] = '!';
			}
		}
		if (!strlen(sorttxt1)) {
			strcpy(sorttxt1,
"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
		}
		for (wx1=0;wx1<sizeof(sorttxt2);wx1++)  {
			if (sorttxt2[wx1] == ' ') {
				sorttxt2[wx1] = '!';
			}
		}
		if (!strlen(sorttxt2)) {
			strcpy(sorttxt2,
"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
		}
		sprintf(sortbuffer,"%-5s %-70s %-70s %-5s \n \0",
			sortgrp,
			sorttxt1,
			sorttxt2,
			webgrp);
		egesort(2, sortbuffer);
/* TEST */
		if (logfil) {
			fprintf(logfil,"ecweb_grpliste3:sort_buffer=%s\n",
				sortbuffer);
		}
		reccpy(r198, &q198, R198);
		f198_start(1, ISGREAT);
		if (f198_ukendt) {
			break;
		}
		videre++;
	}
	if (logfil) {
		fprintf(logfil,"ecweb:grpliste3:videre=%hd\n",videre);
	}

	if (videre<=0) {
		return(0);
	}
	strcpy(lastgrp,"");
	okflag = 1;
	egesort(3, "sort");
	while (okflag==1) {
		if (egesort(4, sortbuffer) <= 0) {
			okflag = 0;
		}
		if (okflag==0) {
			break;
		}
/* TEST */
		if (logfil) {
			fprintf(logfil,"\tsort_buffer=%s\n",
				sortbuffer);
		}
		sscanf(sortbuffer, "%s %s %s %s",
			sortgrp,
			sorttxt1,
			sorttxt2,
			webgrp);
		for (wx1=0;wx1<sizeof(sortgrp);wx1++)  {
			if (sortgrp[wx1] == '!') {
				sortgrp[wx1] = ' ';
			}
		}
		egechartest((unsigned char *)sortgrp);
		for (wx1=0;wx1<sizeof(sorttxt1);wx1++)  {
			if (sorttxt1[wx1] == '!') {
				sorttxt1[wx1] = ' ';
			}
		}
		egechartest((unsigned char *)sorttxt1);
		for (wx1=0;wx1<sizeof(sorttxt2);wx1++)  {
			if (sorttxt2[wx1] == '!') {
				sorttxt2[wx1] = ' ';
			}
		}
		egechartest((unsigned char *)sorttxt2);
		if (strcmp(lastgrp,sortgrp)==0) {
			continue;
		}

		alfalow(str);
		pack_init(str);
		pack_alfa(webgrp);
		pack_alfa(sorttxt1);
		pack_alfa(sorttxt2);
/* NYT 061023 BETA-2 */
		strcpy(tmpstr,"0800");
		if (webgrp[0]>=48 && webgrp[0]<=57) {
			strcpy(tmpstr,"0700");
		}
		pack_alfa(tmpstr);

		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		strcpy(lastgrp,sortgrp);
	}
	if (logfil) {
		fprintf(logfil,"ecweb_grpliste3:videre=%hd\n",videre);
	}
	return(videre);
}

/* ************************************* */
static int check_grpspcst_findes(char *grp,char *type,short stnr) {
	short int retur = 1;
	short int nuvstnr = 0;
	short int nivchk = 0;
	short int nivinit = 0;
	short int chkspecnr = 0;
	short int specfundet = 0;
	short int dgvarighed = 0;
	short int dginterval[2] = {1,7};
	char spcstr[41] = "";
	char altstr[41] = "";
	char tmpstr[41] = "";
	char chkstr[41] = "";

	if (logfil) {
		fprintf(logfil,"check_grpspcst_findes:%s,%s,%hd\n",
			grp,type,stnr);
	}
	reclow(r198,R198);
	r198->oplkode = 16628;
	r198->keynum = (double)nuvstnr;
	strcpy(r198->keyalfa,type);
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		nivinit = 1;
	}
	while (retur>=1 && nivchk<=1) {
		if (nivinit==1) {
			nivinit = 0;
			nivchk++;
			if (nivchk>1) {
				break;
			}
			if (nivchk==1) {
				nuvstnr = stnr;
				r198->oplkode = 16628;
				r198->keynum = (double)nuvstnr;
				strcpy(r198->keyalfa,type);
			}
			f198_start(1,ISGTEQ);
			if (f198_ukendt) {
				nivinit = 1;
				continue;
			}
		}
		egeread(f198,ISNEXT);
		if (f198_eof) {
			nivinit = 1;
			continue;
		}
		if (r198->oplkode!=16628) {
			nivinit = 1;
			continue;
		}
		if (r198->keynum!=(double)nuvstnr) {
			nivinit = 1;
			continue;
		}
		if (strcmp(r198->keyalfa,type)!=0) {
			nivinit = 1;
			continue;
		}
		if (r198->numfelt<=0) {
			continue;
		}
/*
		dginterval[0] = 1;
		dginterval[1] = 7;
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		strcpy(chkstr,"");
		if (strlen(tmpstr)) {
			(void)get_alfa_tgn(tmpstr,0,chkstr,45);
		}
		if (strlen(chkstr)) {
			sscanf(chkstr,"%hd",&dginterval[0]);
		}
		strcpy(chkstr,"");
		if (strlen(tmpstr)) {
			(void)get_alfa_tgn(tmpstr,1,chkstr,45);
		}
		if (strlen(chkstr)) {
			sscanf(chkstr,"%hd",&dginterval[1]);
		}
		if (uddgnr>dginterval[1]) {
			continue;
		}
		if (uddgnr<dginterval[0]) {
			continue;
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&dgvarighed);
		}
		if (varighed!=dgvarighed) {
			continue;
		}
*/
		(void)get_alfa_tgn(r198->alfafelt,2,spcstr,';');
		(void)get_alfa_tgn(r198->alfafelt,3,altstr,';');
		specfundet = 0;
		chkspecnr = 0;
		strcpy(tmpstr,"");
		if (strlen(spcstr)) {
			(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,88);
		}
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&chkspecnr);
		}
		if (chkspecnr<=0) {
			retur = -1;
			break;
		}
		reclow(r165,R165);
		f165_start(1,ISGTEQ);
		r165->spec_nr = chkspecnr;
		r165->stat_nr = 0;
		strcpy(r165->bil_grp,grp);
		egeread(f165,ISEQUAL);
		if (f165_ok) {
			specfundet++;
			if (r165->slet_mark>0) {
				specfundet--;
			}
		}
		r165->spec_nr = chkspecnr;
		r165->stat_nr = stnr;
		strcpy(r165->bil_grp,grp);
		egeread(f165,ISEQUAL);
		if (f165_ok) {
			specfundet++;
			if (r165->slet_mark>0) {
				specfundet--;
			}
		}
		if (logfil) {
			fprintf(logfil,"\tcheck_grpspcst_findes:%hd %hd %s\n",
				chkspecnr,
				stnr,
				grp);
			fprintf(logfil,"\t\tspecfundet=%hd\n",specfundet);
		}
		if (specfundet<=0) {
			retur = 0;
		}
	}
	if (logfil) {
		fprintf(logfil,"check_grpspcst_findes:retur=%hd\n",retur);
	}
	return(retur);
}

/* *************************************************** */
static int send_don2grpliste() {
	int retur = 0;
	int idx = 0;
	int station = 0;
	char bilkategori[21] = "";
	char bilgrp[21] = "";
	char bilbeskr[41] = "";
	char def_afh[11] = "0800";
	char def_valg[11] = "";
	char tmpstr[41] = "";

	station = ws_station;
	if (logfil) {
		fprintf(logfil, "send_don2grpliste\n");
		fflush(logfil);
	}
	while (idx<=1) {
		alfalow(str);
		pack_init(str);
/* NYT 120913 */
		sprintf(tmpstr,"%d",station);
		pack_alfa(tmpstr);
		if (idx==0) {
			strcpy(bilkategori,"personbil");
			strcpy(bilgrp,"A");
			strcpy(bilbeskr,"Personbil (fx. Renault Clio)");
		}
		if (idx==1) {
			strcpy(bilkategori,"varebil");
			strcpy(bilgrp,"3");
			strcpy(bilbeskr,"Varevogn (fx. Renault Trafic)");
		}
		pack_alfa(bilkategori);
		pack_alfa(bilgrp);
		pack_alfa(bilbeskr);
		pack_alfa(bilbeskr);
		pack_alfa(def_afh);
		pack_alfa(def_valg);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		idx++;
		retur++;
	}
	if (logfil) {
		fprintf(logfil, "send_don2grpliste retur=%d idx=%d\n",
			retur,idx);
		fflush(logfil);
	}
	return(retur);
}

/* ********************************* */
static int find_pstypegruppe() {
	int retur = 0;
	int funkretur = 0;
	int wx1 = 0;
	short int starttypeidx = 0;
	short int sluttypeidx = 0;
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil,"find_pstypegruppe\n");
	}
	if (logfil) {
		fprintf(logfil,"\tws_langstr=%s\n",ws_langstr);
		fprintf(logfil,"\tws_station=%hd\n",ws_station);
	}
	funkretur = dan_psgrptab(1,ws_langstr,ws_station);
	if (logfil) {
		fprintf(logfil,"\tfunkretur=%d\n",funkretur);
	}
	starttypeidx = -1;
	sluttypeidx = -1;
	wx1 = 0;
	while (wx1<ws_grpidx) {
		if (strncmp(ws_grptab[wx1]+2,ws_grp,3)==0 && starttypeidx==-1) {
			starttypeidx = wx1;
			sluttypeidx = wx1;
			strcpy(ws_biltype,ws_grp);
			strcpy(ws_grp,"");
		}
		if (strlen(ws_biltype) &&
			strncmp(ws_grptab[wx1]+2,ws_biltype,3)==0) {
			sluttypeidx = wx1;
		}
		wx1++;
	}
	wx1 = 0;
	while (wx1<ws_grpidx && !strlen(ws_biltype)) {
		sscanf(ws_grptab[wx1]+8,"%s",tmpstr);
		if (strcmp(tmpstr,ws_grp)==0 && starttypeidx==-1) {
			starttypeidx = wx1;
			sluttypeidx = wx1;
			sscanf(ws_grptab[wx1]+2,"%s",ws_biltype);
			break;
		}
		wx1++;
	}
	if (logfil) {
		fprintf(logfil,
			"\tws_grp=%s\n",ws_grp);
		fprintf(logfil,
			"\tws_biltype=%s\n",ws_biltype);
		fprintf(logfil,
			"\tstarttypeidx=%hd\n",starttypeidx);
		fprintf(logfil,
			"\tsluttypeidx=%hd\n",sluttypeidx);
	}
	if (starttypeidx==-1 || sluttypeidx==-1) {
		ws_don2errno = DON2TPGRPUK;
	}
	if (logfil) {
		fprintf(logfil,
			"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		ws_funkretur2 = frankly_err(ws_funktion,
			"fejl",ws_don2errno);
		retur = 0;
		goto afslut;
	}
	retur = 1;
afslut:
	if (logfil) {
		fprintf(logfil,"find_pstypegruppe retur=%d\n",retur);
	}
	return(retur);
}

/* ********************************* */
static int dan_psgrptab(int inpfunk,char *langstr,short inpstation) {
	int retur = 0;
	int wx1 = 0;
	int wx2 = 0;
	short int okflag = 0;
	short int grpfundet = 0;
	short int typesort = 0;
	short int grpsort = 0;
	int funkretur = 0;
	char tmpstr[81] = "";
	char tmpstr2[81] = "";
	char chkgrp[21] = "";
	char chktype[21] = "";
	char lasttype[21] = "";
	char typenavn[21] = "";
	char grpnavn[21] = "";
	char extra1txt[81] = "";

	if (logfil) {
		fprintf(logfil,"dan_psgrptab %d %s %hd\n",
			inpfunk,
			langstr,
			inpstation);
	}
	ws_grpidx = 0;
	for (wx1=0;wx1<MAXGRPTAB;wx1++) {
		strcpy(ws_grptab[wx1], "");
		strcpy(ws_grpxtab[wx1], "");
		strcpy(ws_grpaldertab[wx1], "");
	}
	reclow(r198, R198);
	r198->oplkode = 16673;
	r198->keynum = (double)inpstation;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		okflag = -1;
	}
	while (okflag>=0) {
		egeread(f198, ISNEXT);
		if (f198_eof) { break; }
		if (r198->keynum!=inpstation) { break; }
		if (r198->numfelt<=0) { continue; }
		grpsort = 0;
		typesort = 0;

		strcpy(chkgrp,r198->keyalfa+4);
		grpsort = (short int)r198->numfelt;
		strcpy(chktype,r198->keyalfa);
		chktype[3] = '\0';
		if (strcmp(chktype,"BUS")==0) { typesort = 1; }
		if (strcmp(chktype,"VAR")==0) { typesort = 2; }
		if (strcmp(chktype,"LST")==0) { typesort = 3; }

		sprintf(ws_grptab[ws_grpidx],"%2.2hd%s %2.2hd%s",
			typesort,
			chktype,
			grpsort,
			chkgrp);
		strcpy(ws_grpxtab[ws_grpidx],r198->alfafelt);
/* NYT 131218 PSGRPALDER */
		strcpy(ws_grpaldertab[ws_grpidx],"20");
		if (strcmp(chkgrp,"A")==0) {
			strcpy(ws_grpaldertab[ws_grpidx],"21");
		}
		if (strcmp(chkgrp,"B")==0) {
			strcpy(ws_grpaldertab[ws_grpidx],"21");
		}
		if (strcmp(chkgrp,"C")==0) {
			strcpy(ws_grpaldertab[ws_grpidx],"26");
		}
		if (strcmp(chkgrp,"F")==0) {
			strcpy(ws_grpaldertab[ws_grpidx],"21");
		}
		if (strcmp(chkgrp,"J9D")==0) {
			strcpy(ws_grpaldertab[ws_grpidx],"23");
		}
		if (strcmp(chkgrp,"8")==0) {
			strcpy(ws_grpaldertab[ws_grpidx],"23");
		}
		ws_grpidx++;
	}

/* TEST */
	if (logfil) {
		fprintf(logfil,"\tokflag=%hd\n",okflag);
		fprintf(logfil,"\tws_grpidx=%hd\n",ws_grpidx);
	}
        wx2 = ws_grpidx;
        wx2--;
        while (wx2 > 0) {
                for (wx1=1;wx1<=wx2;wx1++) {
                        if (strcmp(ws_grptab[wx1], ws_grptab[wx1-1]) < 0)  {
				strcpy(chkgrp,
					ws_grptab[wx1]);
				strcpy(tmpstr,
					ws_grpxtab[wx1]);
				strcpy(tmpstr2,
					ws_grpaldertab[wx1]);

                                strcpy(ws_grptab[wx1],
					ws_grptab[wx1-1]);
                                strcpy(ws_grpxtab[wx1],
					ws_grpxtab[wx1-1]);
                                strcpy(ws_grpaldertab[wx1],
					ws_grpaldertab[wx1-1]);

				strcpy(ws_grptab[wx1-1], chkgrp);
				strcpy(ws_grpxtab[wx1-1], tmpstr);
				strcpy(ws_grpaldertab[wx1-1], tmpstr2);
			}
		}
		wx2--;
	}
	wx1 = 0;
	while (logfil && wx1<ws_grpidx) {
		fprintf(logfil,"ws_grptab-%hd %s %s alder=%s\n",
			wx1,
			ws_grptab[wx1],
			ws_grpxtab[wx1],
			ws_grpaldertab[wx1]);
		wx1++;
		retur++;
	}
	if (logfil) {
		fprintf(logfil,"dan_psgrptab retur=%d\n",retur);
	}
	return(retur);
}

/* ********************************* */
static int send_psgrpliste(short funk,char *langstr,short station) {
	int retur = 0;
	short int wx1 = 0;
	short int wx2 = 0;
	short int okflag = 0;
	short int grpfundet = 0;
	short int typesort = 0;
	short int grpsort = 0;
	int funkretur = 0;
	char tmpstr[81] = "";
	char chkgrp[21] = "";
	char chktype[21] = "";
	char lasttype[21] = "";
	char typenavn[21] = "";
	char grpnavn[21] = "";
	char extra1txt[81] = "";
/* TEST */
	sprintf(dum_str,
		"send_psgrpliste:funk=%hd,langstr=%s,stat=%hd",
		funk,
		langstr,
		station);
        logfil_put(dum_str);
/* NYT 131203 PSGRPTYPE */
	funkretur = dan_psgrptab(1,langstr,station);
	if (logfil) {
		fprintf(logfil,"\tfunkretur=%d\n",funkretur);
		fprintf(logfil,"\tws_grpidx=%hd\n",ws_grpidx);
	}

	wx1 = 0;
	strcpy(lasttype,"");
	while (funk==3 && wx1<ws_grpidx) {
		strcpy(typenavn,"?");
		sscanf(ws_grptab[wx1]+2,"%s",chktype);
		if (strcmp(chktype,"PRS")==0) {
			strcpy(typenavn,"Personbiler");
		}
		if (strcmp(chktype,"BUS")==0) {
			strcpy(typenavn,"Busser");
		}
		if (strcmp(chktype,"VAR")==0) {
			strcpy(typenavn,"Varevogne");
		}
		if (strcmp(chktype,"LST")==0) {
			strcpy(typenavn,"Lastvogne");
		}
		if (strcmp(chktype,lasttype)!=0) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)station);
			pack_alfa(chktype);
			pack_alfa(typenavn);
			pack_alfa("*");
			pack_alfa("");
			pack_alfa("");
			pack_alfa("");
/* NYT 131212 PSTYPESPEC */
			add_pstypespec(1,chktype);

			pack_exchkend();
			send_linie();
			retur++;
		}
		if (logfil && strcmp(chktype,lasttype)!=0) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		sscanf(ws_grptab[wx1]+8,"%s",chkgrp);
		(void)get_alfa_tgn(ws_grpxtab[wx1],0,grpnavn,';');
		if (!strlen(grpnavn)) {
			strcpy(grpnavn,chkgrp);
		}
		(void)get_alfa_tgn(ws_grpxtab[wx1],1,extra1txt,';');
		alfalow(str);
		pack_init(str);
		pack_int2((long)station);
		pack_alfa(chktype);
		pack_alfa(typenavn);
		pack_alfa(chkgrp);
		pack_alfa(grpnavn);
		pack_alfa(extra1txt);
/* NYT 140915 KOLONNEMANGLER */
		pack_alfa("");

/* NYT 131212 PSTYPESPEC */
		add_pstypespec(2,chkgrp);

		pack_exchkend();
		send_linie();
		retur++;
		strcpy(lasttype,chktype);
/* TEST */
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		wx1++;
	}
	if (ws_grpidx==0 && ws_station>0) {
		alfalow(str);
		pack_init(str);
		pack_alfa("");
		pack_alfa("");
		pack_exchkend();
		send_linie();
/* TEST */
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,"\tws_grpidx=%hd\n",ws_grpidx);
		fprintf(logfil,"send_psgrpliste retur=%d\n",retur);
	}
	return(retur);
}

/* NYT 131212 PSTYPESPEC */
/* ********************************* */
static int add_pstypespec(int inpfunk,char *inpgrptype) {
	int retur = 0;
	int nuvidx = 0;
	int maxidx = 10;
	char inpstr[201] = "";
	char tmpstr[81] = "";
	char datatabel[20][81] = {"","","","","","","","","","",
				  "","","","","","","","","",""};
	FILE * tmpfil;

	tmpfil = (FILE*)0;
	if (logfil) {
		fprintf(logfil,"add_pstypespec %d %s\n",inpfunk,inpgrptype);
	}
	if (inpfunk==1) {
		sprintf(tmpstr,"don2pstypespec.%s",inpgrptype);
	}
	if (inpfunk==2) {
		sprintf(tmpstr,"don2psgrpspec.%s",inpgrptype);
	}
	if (strlen(tmpstr)) {
		tmpfil = fopen(tmpstr,"r");
		if (!tmpfil) {
			tmpfil = (FILE*)0;
			retur = -1;
		}
	}
	if (tmpfil && retur==0  && fgets(inpstr,200,tmpfil)) {
		retur++;
	}
	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}
	nuvidx = 0;
	while (retur>0 && strlen(inpstr) && nuvidx<=maxidx) {
		(void)get_alfa_tgn(inpstr,nuvidx,tmpstr,';');
		strcpy(datatabel[nuvidx],tmpstr);
		nuvidx++;
	}
	nuvidx = 0;
	while (logfil && nuvidx<=maxidx) {
		fprintf(logfil,"\tdatatabel-%d <%s>\n",
			nuvidx,datatabel[nuvidx]);
		nuvidx++;
	}
	nuvidx = 0;
	while (retur>0 && nuvidx<=maxidx) {
		pack_alfa(datatabel[nuvidx]);
		nuvidx++;
	}
	if (logfil) {
		fprintf(logfil,"add_pstypespec retur=%d\n",retur);
	}
	return(retur);
}

/* ********************************* */
static int send_grpliste(short funk,char *langstr,short station) {
	int retur = 0;
	short int wx1 = 0;
	short int wx2 = 0;
	short int okflag = 0;
	short int grpidx = 0;
	short int grpfundet = 0;
	char tmpstr[81];
	char chkgrp[21];
	char grptab[50][11];

/* TEST */
	sprintf(dum_str,
		"send_grpliste:funk=%hd,langstr=%s,stat=%hd",
		funk,
		langstr,
		station);
        logfil_put(dum_str);

	for (wx1=0;wx1<50;wx1++) {
		strcpy(grptab[wx1], "");
	}
	reclow(r165, R165);
	r165->stat_nr = station;
	f165_start(2, ISGTEQ);
	if (f165_ukendt) {
		okflag = -1;
	}
	while (okflag>=0) {
		egeread(f165, ISNEXT);
		if (f165_eof) {
			break;
		}
		if (r165->stat_nr!=station) {
			break;
		}
		if (r165->slet_mark>0) {
			continue;
		}
		if (strcmp(r165->bil_grp, "ALLE")==0) {
			continue;
		}
/* CHECK WEBSPECNR */
		if (check_webspecnr(r165->spec_nr,
			r165->stat_nr,	
			r165->bil_grp)<=0) {
			continue;
		}
/* TEST */
		sprintf(dum_str,
			"send_grpliste:specnr=%hd,grp=%s",
			r165->spec_nr,
			r165->bil_grp);
		logfil_put(dum_str);
		if (r165->bil_grp[0]>=48 &&
			r165->bil_grp[0]<=57) {
			sprintf(chkgrp, "1%s", r165->bil_grp);
		} else {
			sprintf(chkgrp, "0%s", r165->bil_grp);
		}
		grpfundet = 0;
		for (wx1=0;wx1<grpidx;wx1++) {
			if (strcmp(grptab[wx1], chkgrp)==0) {
				grpfundet = 1;
				break;
			}
		}
		if (grpfundet==0) {
			strcpy(grptab[grpidx], chkgrp);
			grpidx++;
		}
	}
/* TEST */
	sprintf(dum_str,
		"send_grpliste:grpidx=%hd",
		grpidx);
	logfil_put(dum_str);

        wx2 = grpidx;
        wx2--;
        while (wx2 > 0) {
                for (wx1=1;wx1<=wx2;wx1++) {
                        if (strcmp(grptab[wx1], grptab[wx1-1]) < 0)  {
				strcpy(chkgrp, grptab[wx1]);

                                strcpy(grptab[wx1], grptab[wx1-1]);

                                strcpy(grptab[wx1-1], chkgrp);
                        }
                }
                wx2--;
	}
	for (wx1=0;wx1<grpidx;wx1++) {
		if (funk==1) {
			alfalow(str);
			pack_init(str);
			pack_alfa(grptab[wx1]+1);
/* RETTET 040514 */
			(void)f198_tekst(langstr,
				16526,(double)0,grptab[wx1]+1,0,tmpstr);
			pack_alfa(tmpstr);
			pack_exchkend();
			send_linie();
/* TEST */
			if (logfil) {
				fprintf(logfil, "SENDT:str=%s", str);
				fflush(logfil);
			}
		}
		if (funk==2) {
			send_billiste(1,station,langstr,grptab[wx1]+1);
		}
/* NYT 070208 */
		if (funk==3) {
			alfalow(str);
			pack_init(str);
/* NYT 120817 */
			pack_int2((long)station);
/* NYT 120704 */
			strcpy(tmpstr,"?");
			if (strcmp(grptab[wx1]+1,"A")==0) {
				strcpy(tmpstr,"personbil");
			}
			if (strcmp(grptab[wx1]+1,"3")==0) {
				strcpy(tmpstr,"varebil");
			}
			pack_alfa(tmpstr);

			pack_alfa(grptab[wx1]+1);
			strcpy(tmpstr,"");
/*
			(void)f198_tekst(langstr,
				16526,(double)0,grptab[wx1]+1,0,tmpstr);
			if (tmpstr[0]>=97 && tmpstr[0]<=122) {
				tmpstr[0] -= 32;
			}
*/
			if (strcmp(grptab[wx1]+1,"A")==0) {
				strcat(tmpstr, "Renault Clio");
/* RETTET 110317
				strcat(tmpstr, " (fx. Ford Fiesta)");
*/
			}
			if (strcmp(grptab[wx1]+1,"3")==0) {
				strcat(tmpstr, "Renault Trafic");
/* RETTET 110531
				strcat(tmpstr, " (fx. Ford Transit)");
*/
			}
			pack_alfa(tmpstr);
			pack_alfa(tmpstr);
			strcpy(tmpstr,"0800");
/*
			if (grptab[wx1][1]>=48 && grptab[wx1][1]<=57) {
				strcpy(tmpstr,"0700");
			}
*/
			pack_alfa(tmpstr);

			pack_exchkend();
			send_linie();
			retur++;
/* TEST */
			if (logfil) {
				fprintf(logfil, "SENDT:str=%s", str);
				fflush(logfil);
			}
		}
	}
	if (grpidx==0) {
		alfalow(str);
		pack_init(str);
		pack_alfa("");
		pack_alfa("");
		pack_exchkend();
		send_linie();
/* TEST */
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
/* TEST */
	sprintf(dum_str,
		"send_grpliste:grpidx=%hd",
		grpidx);
        logfil_put(dum_str);
	return(retur);
}

/* ************************************** */
static int check_webspecnr(short specnr,short st,char * grp) {
	short int retur = 0;
	char tmpstr[41] = "";

	switch(specnr) {
	case 180:
	case 181:
	case 182:
	case 183:
	case 184:
	case 185:
	case 186:
	case 187:
	case 188:
	case 189:
	case 190:
	case 191:
	case 192:
	case 193:
	case 194:
	case 195:
	case 196:
	case 197:
	case 198:
/* RETTET 111025 MINILEASINGRING
	case 199:
*/
/* NYT 141017 641MAANED1000 */
	case 641:
/* NYT 131003 MAANEDKAMPAGNE */
	case 642:
/* NYT 131003 EFTERAAR */
	case 644:

/* NYT 110323 */
	case 645:
	case 646:
	case 647:
	case 648:
	case 649:

	case 650:
	case 651:
	case 652:
	case 653:
	case 654:
	case 655:
/* RETTET 111025 MINILEASINGRING
	case 656:
*/
/* NYT 051117 */
	case 657:
	case 658:
/* NYT 120119 */
	case 663:
	case 664:
/* NYT 110921 */
	case 666:
/* RETTET 120120
	case 667:
*/
/* NYT 120321 */
	case 668:
	case 669:
/* NYT 150227 NYTPRODUKT683 */
	case 683:

	case 932:
	case 933:
	case 934:
		retur = 1;
		break;
	default:
		break;
	}

/* NYT 141017 641MAANED1000 */
	sprintf(tmpstr,"don%3.3hdonline",specnr);
	if (retur==1 && specnr==641 && access(tmpstr,0)!=0) {
		retur = 0;
	}
/* NYT 141020 641MAANED1000 */
	sprintf(tmpstr,"don%3.3hdonline",specnr);
	if (retur==1 && specnr==642 && access(tmpstr,0)!=0) {
		retur = 0;
	}
	sprintf(tmpstr,"don%3.3hdonline",specnr);
	if (retur==1 && specnr==194 && access(tmpstr,0)!=0) {
		retur = 0;
	}
	sprintf(tmpstr,"don%3.3hdonline",specnr);
	if (retur==1 && specnr==663 && access(tmpstr,0)!=0) {
		retur = 0;
	}
	sprintf(tmpstr,"don%3.3hdonline",specnr);
	if (retur==1 && specnr==664 && access(tmpstr,0)!=0) {
		retur = 0;
	}
/* NYT 150227 NYTPRODUKT683 */
	sprintf(tmpstr,"don%3.3hdonline",specnr);
	if (retur==1 && specnr==683 && access(tmpstr,0)!=0) {
		retur = 0;
	}

	return(retur);
}

/* ********************************* */
static void send_paipriser(funk,langstr,station,kundenr,extrastr)
short int funk;
char * langstr;
short int station;
long int kundenr;
char * extrastr; {
	short int okflag = 0;
	short int aftaleflag = 0;
	short int funkretur = 0;
	short int prisextra = 0;
	long int fradato = 0;
	long int tildato = 0;
	long int antaldgn = 1;
	long int firmakundenr = 0;
	long int firmaaftfra = 0;
	long int firmaafttil = 0;
	char grp[11] = "";
	char transstr[21] = "";
	char tmpstr[81] = "";

/* TEST */
	sprintf(dum_str,
		"send_paipriser:funk=%hd,stat=%hd,kundenr=%ld,extrastr=%s",
		funk,
		station,
		kundenr,
		extrastr);
        logfil_put(dum_str);
/* AFTALEFLAG */
	if (kundenr>0) {
		reclow(r167, R167);
		f167_start(1, ISGTEQ);
		r167->kunde_nr = kundenr;
		egeread(f167, ISEQUAL);
		if (f167_ok) {
			firmakundenr = r167->firma_reference;
		}
	}
	if (firmakundenr>0) {
		if (find_r178(0,16,0,(double)firmakundenr)>0) {
			firmaaftfra = (long int)r178->num_felt;
		}
		if (find_r178(0,4,0,(double)firmakundenr)>0) {
			firmaafttil = (long int)r178->num_felt;
		}
		if (firmaafttil==0) {
			firmaafttil = 99999999;
		}
        }
	if (firmakundenr>0 &&
		firmaaftfra>0 &&
		ws_systemdato>=firmaaftfra && ws_systemdato<=firmaafttil) {
		aftaleflag = 1;
	}
/* TEST */
	sprintf(dum_str, "send_paipriser:firma=%ld aft=%ld-%ld aftaleflag=%hd",
		firmakundenr,
		firmaaftfra,
		firmaafttil,
		aftaleflag);
	logfil_put(dum_str);

	if (strlen(extrastr)) {
		(void)get_alfa_tgn(extrastr,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &fradato);
		}
		(void)get_alfa_tgn(extrastr,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &tildato);
		}
		(void)get_alfa_tgn(extrastr,2,grp,';');
	}
	sprintf(dum_str, "send_paipriser:fradato=%ld,tildato=%ld,grp=%s",
		fradato,
		tildato,
		grp);
        logfil_put(dum_str);
/*
	if (fradato>0 && tildato>0) {
		julian = m036_funktion(12, tildato);
		antaldgn = julian - m036_funktion(12, fradato);
	}
	sprintf(dum_str, "send_paipriser:antaldgn=%ld",
		antaldgn);
        logfil_put(dum_str);
*/
	if (antaldgn<0) {
		antaldgn = 1;
	}
	reclow(r165, R165);
	r165->stat_nr = station;
	f165_start(2, ISGTEQ);
	if (f165_ukendt) {
		okflag = -1;
	}
	while (okflag>=0) {
		egeread(f165, ISNEXT);
		if (f165_eof) {
			break;
		}
		if (r165->stat_nr!=station) {
			break;
		}
		if (r165->slet_mark>0) {
			continue;
		}
/* CHECK FOR EXTRA */
		funkretur = 0;
		prisextra = 0;
                funkretur=find_r198(1,16503,(double)r165->spec_nr,"",0);
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisextra);
			}
			(void)get_alfa_tgn(r198->alfafelt,6,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%ld", &antaldgn);
			}
		}
		if (funk==1 && prisextra>0) {
			continue;
		}
		if (funk==1) {
			funkretur=find_r198(1,16522,(double)r165->spec_nr,"",0);
			if (funkretur>0 && r198->numfelt>0 && aftaleflag==0) {
				continue;
			}
		}
		if (funk==1 && strlen(grp) && strcmp(r165->bil_grp,grp)!=0) {
			continue;
		}
/* TEST */
		sprintf(dum_str, "send_paipriser:OK antaldgn=%ld",
			antaldgn);
        	logfil_put(dum_str);

		funkretur = 0;
		alfalow(str);
		pack_init(str);
		pack_int2((long)r165->spec_nr);
		pack_alfa(r165->bil_grp);
/* NYT 030117 */
/* RETTET 040514 */
		(void)f198_tekst(langstr,
			16526,(double)0,r165->bil_grp,0,tmpstr);
		pack_alfa(tmpstr);

		if (strcmp(langstr, "DK")==0 ||
			strcmp(langstr,"DA")==0) {
			pack_alfa(r165->tekst_1);
		} else {
			sprintf(transstr, "%5.5ld%5.5hd",
				16507,r165->spec_nr);
			trans_tekst(langstr,0,transstr,tmpstr);
			pack_alfa(tmpstr);
		}
/* specnr beskrivelse */
		strcpy(tmpstr, "");
/* PR.DAG
		trans_tekst(langstr,10114,"",tmpstr);
*/
/* BESKRIVELSE */
		(void)f198_tekst(langstr,
			16501,(double)r165->spec_nr,"",0,tmpstr);
		pack_alfa(tmpstr);

		ege_w_dou1 = (double)antaldgn;
		ege_w_dou1 *= (double)r165->rate_pai;
		pack_doub(ege_w_dou1);

/* MAX ANTAL */
		(void)find_r198(0,16505,(double)r165->spec_nr,"",0);
		pack_int2((long)r198->numfelt);

		pack_exchkend();
		send_linie();
	}
	return;
}

/* ******************************************** */
/* funk 1 med init osv				*/
/*      0 uden (kun pack_alfa)			*/
static void web_errormess(short funk,char *langstr,char *parastr) {
	char tmpstr[501] = "";
	char chkstr[201] = "";
	char returstr[201] = "";
	short int stnr = 0;
	short int offline = 0;
	short int multilinie = 0;
	short int funkretur = 0;
	int webkode = 0;
	long int extraretur = 0;
	long int transkode = 0;
	long int minudslip = 0;
	long int nuvlbnr = 0;

/* TEST */
	sprintf(dum_str,
		"web_errormess:funk=%hd,parastr=%s",
		funk,
		parastr);
	logfil_put(dum_str);
	sprintf(dum_str,
		"web_errormess:ws_sommerwebfejl=%hd",
		ws_sommerwebfejl);
	logfil_put(dum_str);
	if (logfil) {
		fprintf(logfil,"web_errormess:ws_differrormess=%s\n",
			ws_differrormess);
		fflush(logfil);
	}
	reclow(r166,R166);
	f166_start(1,ISGTEQ);
	if (strcmp(parastr,"0")==0) {
		sprintf(tmpstr,"WEBBSS ver.%s",WEBVER);
	}
	if (strcmp(parastr,"0")!=0 && strlen(ws_differrormess)) {
		strcpy(tmpstr,ws_differrormess);
	}
	if (strcmp(parastr,"0")!=0 && !strlen(ws_differrormess)) {
		sprintf(tmpstr,"%s + %s",langstr,parastr);
		sscanf(parastr,"%d", &webkode);
		if (webkode<0) {
			webkode *= -1;
		}
		if (webkode==24) {
			offline = 1;
		}
		if (webkode==28 ||
			webkode==29 ||
			webkode==30 ||
			webkode==31 ||
			webkode==32 ||
			webkode==33 ||
			webkode==34 ||
			webkode==35) {
			multilinie = 1;
			nuvlbnr = 1;
		}
		if (webkode==52) {
			multilinie = 1;
			nuvlbnr = 1;
		}
		if (webkode==53) {
			multilinie = 1;
			nuvlbnr = 1;
		}
		if (webkode==54) {
			multilinie = 1;
			nuvlbnr = 1;
		}
		if (webkode==55||webkode==56||webkode==57) {
			multilinie = 1;
			nuvlbnr = 1;
		}
		if (webkode==305||webkode==311) {
			multilinie = 1;
			nuvlbnr = 1;
		}
/* NYT 081124 TILBUD PAA VEJ */
		if (webkode==319) {
			multilinie = 1;
			nuvlbnr = 1;
		}

		if (webkode>0 && webkode<=900) {
			transkode = 10300;
			transkode += (long int)webkode;
			trans_tekst(langstr,transkode,"",tmpstr);
		}
		if (webkode>900 && webkode<1000) {
			transkode = 10318;
			trans_tekst(langstr,transkode,"",returstr);
			strcpy(tmpstr,returstr);
			transkode++;
			trans_tekst(langstr,transkode,"",returstr);
			strcat(tmpstr,returstr);
			stnr = (short int)webkode%100;
			r166->stat_nr = stnr;
			egeread(f166,ISEQUAL);
			if (f166_ok) {
				strcat(tmpstr, " ");
				strcat(tmpstr, r166->tlf);
			} else {
				strcat(tmpstr, " ?");
			}
			strcat(tmpstr, "<BR>");
			transkode++;
			trans_tekst(langstr,transkode,"",returstr);
			reclow(r198,R198);
			r198->oplkode = 16604;
			r198->keynum = (double)stnr;
			egeread(f198,ISEQUAL);
			if (f198_ok && strlen(r198->alfafelt)) {
				strcat(tmpstr,returstr);
				strcat(tmpstr," <A HREF=\"mailto:");
				strcat(tmpstr,r198->alfafelt);
				strcat(tmpstr,"\">");
				strcat(tmpstr,r198->alfafelt);
				strcat(tmpstr,"</A>");
			}
		}
		if (webkode>1000 && webkode<1100) {
			stnr = (short int)webkode%100;
			transkode = 10321;
			trans_tekst(langstr,transkode,"",returstr);
			strcpy(tmpstr,returstr);
			strcpy(returstr,"P7911EC");
			sprintf(chkstr,"MinUdSlip=");
			if (retur_f198_def((long int)1002,chkstr,returstr)>0) {
				sscanf(returstr,"%ld",&minudslip);
			}
			strcpy(returstr,"P7911EC");
			sprintf(chkstr,"MinUdSlip%2.2hd=",stnr);
			if (retur_f198_def((long int)1002,chkstr,returstr)>0) {
				sscanf(returstr,"%ld",&minudslip);
			}
			strcpy(returstr,"");
			if (minudslip==60) {
				strcpy(returstr," 1 times ");
			}
			if (minudslip==120) {
				strcpy(returstr," 2 timers ");
			}
			if (minudslip==1440) {
				strcpy(returstr," 1 døgns ");
			}

			if (!strlen(returstr)) {
				sprintf(returstr," %ld minutters ", minudslip);
			}
			strcat(tmpstr,returstr);
			transkode++;
			trans_tekst(langstr,transkode,"",returstr);
			strcat(tmpstr,returstr);
			transkode++;
			trans_tekst(langstr,transkode,"",returstr);
			strcat(tmpstr,returstr);
			stnr = (short int)webkode%100;
			r166->stat_nr = stnr;
			egeread(f166,ISEQUAL);
			if (f166_ok) {
				strcat(tmpstr, " ");
				strcat(tmpstr, r166->tlf);
			} else {
				strcat(tmpstr, " ?");
			}
		}
		if (webkode==1101) {
/*
			strcpy(returstr,"");
			sprintf(tmpstr,"%d",webkode);
*/
			transkode = 10321;
			trans_tekst(langstr,transkode,"",returstr);
			strcpy(tmpstr,returstr);
			strcpy(returstr," 1 døgns ");
			strcat(tmpstr,returstr);
			transkode++;
			trans_tekst(langstr,transkode,"",returstr);
			strcat(tmpstr,returstr);
			transkode++;
			trans_tekst(langstr,transkode,"",returstr);
			strcat(tmpstr,returstr);
			strcat(tmpstr, "7011 3355");
		}
		if (webkode>1101 && webkode<1200) {
			strcpy(returstr,"");
			sprintf(tmpstr,"%d",webkode);
		}

	}
/* TEST */
	sprintf(dum_str,
		"\twebkode=%d", webkode);
	logfil_put(dum_str);
	funkretur = 1;
	while (multilinie==1 && funkretur>0) {
		funkretur =
		trans_tekst_lbnr(langstr,transkode,"",returstr,nuvlbnr);
		if (funkretur>0) {
			strcat(tmpstr,returstr);
		}
                nuvlbnr++;
	}
	if (offline) {
		ecweb_online(2,langstr);
		return;
	}
	if (funk==1) {
		alfalow(str);
		pack_init(str);
	}
/* NYT 071107 */
	strcpy(chkstr,"");
	if (ws_brandtype==0 && ws_funktion==210 && webkode==14) {
		extraretur = error_extra_check(langstr,webkode,chkstr);
	}
	if (ws_brandtype==0 && ws_funktion==210 && webkode==14 &&
		strlen(chkstr)) {
		strcat(tmpstr,chkstr);
	}
/* NYT 110316 */
	if (ws_brandtype==0 && ws_funktion==210 && webkode==14 &&
		extraretur==2100 && strlen(chkstr)) {
		strcpy(tmpstr,chkstr);
	}


	if (ws_brandtype==3 && ws_funktion==310 && webkode==14) {
		error_extra_check(langstr,webkode,chkstr);
	}
	if (ws_brandtype==3 && ws_funktion==310 && webkode==14 &&
		strlen(chkstr)) {
		strcpy(tmpstr,chkstr);
	}
	pack_alfa(tmpstr);
	if (funk==1) {
		pack_exchkend();
		send_linie();
	}
	if (funk==1 && logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	return;
}

/* **************************************************** */
/* JUL08					 	*/
/* HLG 2010						*/
static int error_extra_check(char *langstr,int webkode,char *returstr) {
	short int retur = 0;
	short int multilinie = 1;
	short int nuvlbnr = 0;
	short int funkretur = 0;
	short int donfundet = 0;
	short int ecfundet = 0;
	long int transkode = 0;
	char extrastr[81] = "";

	if (logfil) {
		fprintf(logfil, "error_extra_check START webkode=%d\n",
			webkode);
		fprintf(logfil, "error_extra_check:ws_funktion=%hd\n",
			ws_funktion);
		fprintf(logfil, "error_extra_check:ws_station=%hd\n",
			ws_station);
		fprintf(logfil, "error_extra_check:ws_fradato,til=%ld,%ld\n",
			ws_fradato,
			ws_tildato);
		fprintf(logfil, "error_extra_check:ws_fradato,til/10000=%ld,%ld\n",
			ws_fradato%10000,
			ws_tildato%10000);


	}
	strcpy(returstr,"");
/* NYT 110416 */
	if (webkode==14 && ws_funktion==210) {
		ecfundet = check_hlgdg_info(1,ws_fradato,ws_tildato,returstr);
	}
	if (webkode==14 && ws_funktion==210 && ws_fradato%10000>=1222 &&
		ws_fradato%10000<=1231) {
		transkode = 10353;
		sprintf(returstr,"<BR>Julen %ld<BR>",ws_fradato/10000);
	}
	if (webkode==14 && ws_funktion==210 && ws_tildato%10000>=1222 &&
		ws_tildato%10000<=1231) {
		transkode = 10353;
		sprintf(returstr,"<BR>Julen %ld<BR>",ws_tildato/10000);
	}
	if (webkode==14 && ws_funktion==310 &&
		ws_fradato%10000>=1221 &&
		ws_fradato%10000<=1225) {
		transkode = 10353;
		donfundet = 1;
	}
	if (webkode==14 && ws_funktion==310 &&
		ws_tildato%10000>=1221 &&
		ws_tildato%10000<=1225) {
		transkode = 10353;
		donfundet = 1;
	}
/* NYT 100304 PAASEKE11 */
/* RETTET 120420 GAMMEL HLG */
#ifdef egetest
	if (webkode==14 && ws_funktion==310 &&
		(ws_station==58||ws_station==66) &&
		(ws_fradato%10000)>=421 &&
		(ws_fradato%10000)<=425) {
		transkode = 10353;
		donfundet = 2;
	}
	if (webkode==14 && ws_funktion==310 &&
		(ws_station==58||ws_station==66) &&
		(ws_fradato%10000)>=416 &&
		(ws_fradato%10000)<=419) {
		transkode = 10353;
		donfundet = 2;
	}
/* NYT 100423 STB 2011 */
	if (webkode==14 && ws_funktion==310 &&
		(ws_station==58||ws_station==66) &&
		(ws_tildato%10000)>=520 &&
		(ws_tildato%10000)<=522) {
		transkode = 10353;
		donfundet = 3;
	}
	if (webkode==14 && ws_funktion==310 &&
		(ws_station==58||ws_station==66) &&
		(ws_fradato%10000)>=517 &&
		(ws_fradato%10000)<=518) {
		transkode = 10353;
		donfundet = 3;
	}
/* NYT 100423 PINSE 2011 */
	if (webkode==14 && ws_funktion==310 &&
		(ws_station==58||ws_station==66) &&
		(ws_tildato%10000)>=611 &&
		(ws_tildato%10000)<=613) {
		transkode = 10353;
		donfundet = 4;
	}
	if (webkode==14 && ws_funktion==310 &&
		(ws_station==58||ws_station==66) &&
		(ws_fradato%10000)>=608 &&
		(ws_fradato%10000)<=609) {
		transkode = 10353;
		donfundet = 4;
	}
/* NYT 100423 KRH 2011 */
	if (webkode==14 && ws_funktion==310 &&
		(ws_station==58||ws_station==66) &&
		(ws_tildato%10000)>=602 &&
		(ws_tildato%10000)<=605) {
		transkode = 10353;
		donfundet = 5;
	}
	if (webkode==14 && ws_funktion==310 &&
		(ws_station==58||ws_station==66) &&
		(ws_fradato%10000)>=530 &&
		(ws_fradato%10000)<=531) {
		transkode = 10353;
		donfundet = 5;
	}
#endif

/* PAASKE 2010 */
	if (donfundet==2) {
		sprintf(returstr,
"Påsketilbudene starter mellem d. 15/4 og d. 20/4.<BR>Venligst ret afhentningsdag.<BR>Med venlig hilsen<BR>driveon.net");
	}
/* STB PINSE KRH 2010 */
	if (donfundet==3) {
		sprintf(returstr,
"St.Bededag er 19/5-23/5.<BR>Venligst ret afh.dag og/eller afl.dag.<BR>Med venlig hilsen<BR>driveon.net");
	}
	if (donfundet==4) {
		sprintf(returstr,
"Pinse er 10/6-14/6.<BR>Venligst ret afh.dag og/eller afl.dag.<BR>Med venlig hilsen<BR>driveon.net");
	}
	if (donfundet==5) {
		sprintf(returstr,
"Kr.Himmelfart er 1/6-6/6.<BR>Venligst ret afh.dag og/eller afl.dag.<BR>Med venlig hilsen<BR>driveon.net");
	}

	if (donfundet==1 && strcmp(langstr,"EN")==0) {
		sprintf(returstr,
"Christmas rental minimum 5 days.<BR>Please change date and try again.<BR>Best Regards Driveon.net");
	}
	if (donfundet==1 && strcmp(langstr,"EN")!=0) {
		sprintf(returstr,
"Billeje over julen skal minimum være på 5 dage.<BR>Ret dato og prøv venligst igen.<BR>Mvh. Driveon.net");
/* RETTET 111111
"<BR>Jul<BR>Få biler tilbage. Ring for tilbud (7011 4455).<BR>Med venlig hilsen driveon.net");
*/
/*
"<BR>Ønsker du at booke i julen, skal der bestilles minimum en uge.
<BR>Med venlig hilsen
<BR>driveon.net");
*/
/*
"<BR>driveon.net holder lukket d.25/12-07, 26/12-07 og d.1/1-08.<BR>Ønsker du at reserver en bil over d. 25/12 og d. 26/12 skal<BR>bilen minimum bestilles for 7 dage. Glædelig jul og godt nytår<BR>Med venlig hilsen driveon.net");
*/
	}
	if (logfil) {
		fprintf(logfil, "error_extra_check donfundet=%hd\n",
			donfundet);
		fprintf(logfil, "error_extra_check ecfundet=%hd\n",
			ecfundet);
		fflush(logfil);
	}
	if (donfundet>0) {
		return(1);
	}
	if (ecfundet>0) {
		return(2100);
	}
	if (transkode<=0) {
		return(0);
	}
	funkretur = 1;
	while (transkode>0 && multilinie==1 && funkretur>0) {
                funkretur =
                trans_tekst_lbnr(langstr,transkode,"",extrastr,nuvlbnr);
                if (funkretur>0) {
                        strcat(returstr,extrastr);
                }
                nuvlbnr++;
		retur++;
        }
	return(retur);
}

/* *********************************************************** */
static int check_hlgdg_info(int funk,long fradato,long tildato,char *returstr) {
	int retur = 0;
	int okflag = 0;
	int fundet = 0;

	if (logfil) {
		fprintf(logfil,"check_hlgdg_info:funk=%d %ld-%ld\n",
			funk,
			fradato,
			tildato);
		fflush(logfil);
	}
	reclow(r198,R198);
	r198->oplkode = 2100;
	f198_start(1,ISGTEQ);
	while (retur>=0) {
		egeread(f198,ISNEXT);
		if (f198_eof) { break; }
		if (r198->oplkode>2100) { break; }
		fundet++;
		okflag = 0;
		if (fradato>0 &&
			fradato>=r198->fradato&&fradato<=r198->tildato) {
			okflag++;
		}
		if (tildato>0 &&
			tildato>=r198->fradato&&tildato<=r198->tildato) {
			okflag++;
		}
		egechartest((unsigned char *)r198->alfafelt);
		if (!strlen(r198->alfafelt)) {
			continue;
		}
		if (okflag<=0) {
			continue;
		}
		if (retur>0) {
			strcat(returstr,"<BR>");
		}
		strcat(returstr,r198->alfafelt);
		retur++;
	}
	if (logfil) {
		fprintf(logfil,"check_hlgdg_info:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************** */
static int ecweb_deleteres(short funk,char * langstr,long resnr) {
	short int retur = 0;



	return(retur);
}

/* ************************************** */
static int ecweb_checklogin(short funk,char * langstr) {
	short int retur = 0;
	long int reskundenr = 0;
	unsigned char restlfnr[41] = "";

	if (logfil) {
		fprintf(logfil,
		"ecweb_checklogin:ws_kundenr=%ld,ws_resnr=%ld,ws_tlfnr=%s\n",
			ws_kundenr,
			ws_resnr,
			ws_tlfnr);
	}
	reskundenr = find_reskundenr(1,ws_resnr,restlfnr);
	slet_blanke((unsigned char *)restlfnr);
	ege_toupper((unsigned char *)restlfnr);
	if (logfil) {
		fprintf(logfil,
		"ecweb_checklogin:reskundenr=%ld,restlfnr=%s\n",
			reskundenr,
			restlfnr);
	}
	if (reskundenr>0 && ws_kundenr==reskundenr) {
		retur = 1;
	}
	if (retur==0 && strlen(ws_tlfnr) &&
		strcmp(ws_tlfnr,restlfnr)==0) {
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,
		"ecweb_checklogin:retur=%hd\n",
			retur);
	}
	return(retur);
}

/* ************************************* */
static long int find_reskundenr(short funk,long resnr,char * returtlf) {
	long int kundenr = 0;
	long int nextnr = 0;
	short int fundet = 0;

	strcpy(returtlf,"");
	reclow(r159,R159);
	f159_start(1,ISGTEQ);
/*
	r159->record_x = resnr;
	egeread(f159,ISEQUAL);
	if (f159_ukendt) {
		kundenr = -1;
	}
	if (kundenr==0 && r159->lejerkundenr>0) {
		kundenr = r159->lejerkundenr;
		strcpy(returtlf,r159->lejertlf);
	}
	if (kundenr==0 && r159->kon_ref_til>0) {
		refkonnr = r159->kon_ref_til;
	}
	if (kundenr==0 && refkonnr>0) {
		r159->record_x = refkonnr;
		egeread(f159,ISEQUAL);
		if (f159_ukendt) {
			kundenr = -1;
		}
	}
*/
	nextnr = resnr;
	while (nextnr>0) {
		r159->record_x = nextnr;
		egeread(f159, ISEQUAL);
		if (f159_ukendt) {
			nextnr = 0;
			break;
		}
		fundet++;
		nextnr = r159->kon_ref_til;
		if (strlen(r159->lejertlf)) {
			strcpy(returtlf,r159->lejertlf);
		}
		if (r159->lejerkundenr>0) {
			kundenr = r159->lejerkundenr;
		}
	}
	if (logfil) {
		fprintf(logfil,
			"find_reskundenr:kundenr=%ld,returtlf=%s,fundet=%hd\n",
			kundenr,
			returtlf,
			fundet);
	}
	return((long int)kundenr);
}

/* ************************************** */
static void ecweb_checkkunde(short funk,char * langstr,long fdato,short id,char * datafelt) {
	short int fundet = 0;
	short int keynr = 1;
	short int tmpnum = 0;
	short int specfejlkode = 0;
	long int kundenr = 0;
	char tmpstr[81] = "";
	char emailadr[81] = "";

/* TEST */
	sprintf(dum_str,
		"ecweb_checkkunde:funk=%hd,langstr=%s,%ld,%hd,%s",
		funk,
		langstr,
		fdato,
		id,
		datafelt);
        logfil_put(dum_str);
	reclow(r178,R178);
	f178_start(1,ISGTEQ);

	reclow(r167,R167);
	if (id==1) {
		keynr = 6;
		strcpy(r167->kkortnr,datafelt);
		specfejlkode = -26;
	}
	if (id==2) {
		keynr = 1;
		sscanf(datafelt,"%ld",&kundenr);
		r167->kunde_nr = kundenr;
		specfejlkode = -27;
	}
	f167_start(keynr,ISGTEQ);
	if (f167_ukendt) {
		fundet = -1;
	}
	while (fundet==0) {
		egeread(f167,ISNEXT);
		if (f167_eof) {
			break;
		}
		if (keynr==1 && r167->kunde_nr!=kundenr) {
			break;
		}
		if (keynr==6 && strcmp(r167->kkortnr,datafelt)!=0) {
			break;
		}
		if (r167->type!=1) {
			continue;
		}
		if (r167->foedselsdato!=fdato) {
			continue;
		}
		if (check_sy_kundenr(r167->kunde_nr)>0) {
			continue;
		}
/* NYT 090525 */
		if (check_ps_kundenr(r167->kunde_nr)>0) {
			continue;
		}
		fundet = 1;
	}
	sprintf(dum_str,
		"ecweb_checkkunde:fundet=%hd,specfejlkode=%hd",
		fundet,
		specfejlkode);
        logfil_put(dum_str);

	alfalow(str);
	pack_init(str);
	if (fundet<=0) {
		pack_int2((long)specfejlkode);
		sprintf(tmpstr,"%hd",(short int)(specfejlkode*-1));
		web_errormess(0,ws_langstr,tmpstr);
		pack_alfa("");
		pack_alfa("");
		pack_alfa("");
		pack_int2((long)0);
	} else {
		pack_int2((long)r167->kunde_nr);
/* navn */
		sprintf(tmpstr, "%s %s", r167->navn_1,r167->navn_2);
		pack_alfa(tmpstr);
/* tlf */
		pack_alfa(r167->tlf);
/* mail */
		strcpy(emailadr,"");
		if (find_r178(1,10,0,(double)r167->kunde_nr)>0 &&
			strlen(r178->alfa_felt)) {
			strcpy(emailadr,r178->alfa_felt);
		}
		pack_alfa(emailadr);
/* nyhedsmail */
		tmpnum = 0;
		if (strlen(emailadr) &&
			check_nyhedsmodtager(1997,0,emailadr)>0) {
			tmpnum = 1;
		}
		pack_int2((long)tmpnum);
	}
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	return;
}

/* **************************************** */
static void donweb_online(short funk,char * langstr) {
	short int retur = 0;
	short int natflag = 0;
	short int funkretur = 0;
	short int asciiflag = 0;
	short int checkflag = 0;
	long int transkode = 0;
	long int nuvlbnr = 0;
	char tmpstr[201] = "";
	char returstr[201] = "";

	tmpfil = (FILE*)0;
/* TEST */
	sprintf(dum_str,
		"donweb_online:langstr=%s,funk=%hd",
		langstr,
		funk);
        logfil_put(dum_str);
	if (funk==1) {
		checkflag = 1;
	}
/* TEST */
	sprintf(dum_str,
		"donweb_online:checkflag=%hd",
		checkflag);
        logfil_put(dum_str);
	if (checkflag==1 && access("donweboffline",0)==0) {
/* NYT 091130 */
		if (access("natbackup",0)==0) {
			natflag = 1;
		}
		retur = -1;
	}
	if (checkflag==1 && access("bsslokal",0)==0) {
/* NYT 091130 */
		if (access("natbackup",0)==0) {
			natflag = 1;
		}
		retur = -1;
	}

	if (funk==2) {
		retur = -1;
	}
	if (funk==3) {
		retur = -1;
/* NYT 100308 */
		if (access("natbackup",0)==0) {
			natflag = 1;
		}
		asciiflag = 1;
	}
/* TEST */
	sprintf(dum_str,"donweb_online:retur=%hd natflag=%hd",retur,natflag);
        logfil_put(dum_str);
	if (funk==0) {
		return;
	}

	alfalow(str);
	pack_init(str);
	if (funk!=2) {
		pack_int2((long)retur);
	}
	if (funk!=2 && retur==0) {
		pack_alfa("ONLINE");
	}

	if (asciiflag==0) {
		transkode = 10124;
		nuvlbnr = 0;
		funkretur = 1;
		strcpy(tmpstr,"");
	}
	while (asciiflag==0 && retur<0 && funkretur>0) {
		funkretur =
		trans_tekst_lbnr(langstr,transkode,"",returstr,nuvlbnr);
		if (funkretur>0 && nuvlbnr>0) {
			strcat(tmpstr,"<BR>");
		}
		if (funkretur>0) {
			strcat(tmpstr,returstr);
		}
                nuvlbnr++;
	}
/* NYT 091130 */
	if (asciiflag==1 && natflag<=0) {
		sprintf(tmpstr,"donweb_%s%hd.txt",langstr,retur);
	}
	if (asciiflag==1 && natflag>0) {
		sprintf(tmpstr,"donwebnat_%s%hd.txt",langstr,retur);
	}
	if (asciiflag==1) {
		tmpfil = fopen(tmpstr,"r");
		if (!tmpfil) {
			tmpfil = (FILE*)0;
		}
		nuvlbnr = 0;
		strcpy(tmpstr,"");
	}
	while (asciiflag==1 && retur<0 && tmpfil) {
		if (!fgets(returstr,100,tmpfil)) {
                        break;
                }
/*
                if (strlen(returstr)) {
                        returstr[strlen(returstr)-1] = '\0';
                }
*/
		egechartest((unsigned char *)returstr);
		if (nuvlbnr>0) {
			strcat(tmpstr,"<BR>");
		}
		strcat(tmpstr,returstr);
		nuvlbnr++;
	}
	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}

	if (retur<0 && strlen(tmpstr)) {
		pack_alfa(tmpstr);
	}
	if (retur<0 && !strlen(tmpstr)) {
		pack_alfa("OFFLINE");
	}
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	return;
}

/* **************************************** */
static void ecweb_online(short funk,char * langstr) {
	short int retur = 0;
	short int natflag = 0;
	short int funkretur = 0;
	short int asciiflag = 0;
	short int checkflag = 0;
	long int transkode = 0;
	long int nuvlbnr = 0;
	char tmpstr[201] = "";
	char returstr[201] = "";

	tmpfil = (FILE*)0;
/* TEST */
	sprintf(dum_str,
		"ecweb_online:langstr=%s,funk=%hd",
		langstr,
		funk);
        logfil_put(dum_str);
	if (funk==1) {
		checkflag = 1;
	}
/* TEST */
	sprintf(dum_str,
		"ecweb_online:checkflag=%hd",
		checkflag);
        logfil_put(dum_str);


	if (checkflag==1 && access("ecweboffline",0)==0) {
/* NYT 091130 */
		if (access("natbackup",0)==0) {
			natflag = 1;
		}
		retur = -1;
	}
	if (checkflag==1 && access("bsslokal",0)==0) {
/* NYT 091130 */
		if (access("natbackup",0)==0) {
			natflag = 1;
		}
		retur = -1;
	}

	if (funk==2) {
		retur = -1;
	}
	if (funk==3) {
		retur = -1;
/* NYT 100308 */
		if (access("natbackup",0)==0) {
			natflag = 1;
		}
		asciiflag = 1;
	}
/* TEST */
	sprintf(dum_str,"ecweb_online:retur=%hd natflag=%hd",retur,natflag);
        logfil_put(dum_str);
	if (funk==0) {
		return;
	}

	alfalow(str);
	pack_init(str);
	if (funk!=2) {
		pack_int2((long)retur);
	}
	if (funk!=2 && retur==0) {
		pack_alfa("ONLINE");
	}

	if (asciiflag==0) {
		transkode = 10324;
		nuvlbnr = 0;
		funkretur = 1;
		strcpy(tmpstr,"");
	}
	while (asciiflag==0 && retur<0 && funkretur>0) {
		funkretur =
		trans_tekst_lbnr(langstr,transkode,"",returstr,nuvlbnr);
		if (funkretur>0 && nuvlbnr>0) {
			strcat(tmpstr,"<BR>");
		}
		if (funkretur>0) {
			strcat(tmpstr,returstr);
		}
                nuvlbnr++;
	}
/* NYT 091130 */
	if (asciiflag==1 && natflag<=0) {
		sprintf(tmpstr,"ecweb_%s%hd.txt",langstr,retur);
	}
	if (asciiflag==1 && natflag>0) {
		sprintf(tmpstr,"ecwebnat_%s%hd.txt",langstr,retur);
	}
	if (asciiflag==1) {
		tmpfil = fopen(tmpstr,"r");
		if (!tmpfil) {
			tmpfil = (FILE*)0;
		}
		nuvlbnr = 0;
		strcpy(tmpstr,"");
	}
	while (asciiflag==1 && retur<0 && tmpfil) {
		if (!fgets(returstr,100,tmpfil)) {
                        break;
                }
/*
                if (strlen(returstr)) {
                        returstr[strlen(returstr)-1] = '\0';
                }
*/
		egechartest((unsigned char *)returstr);
		if (nuvlbnr>0) {
			strcat(tmpstr,"<BR>");
		}
		strcat(tmpstr,returstr);
		nuvlbnr++;
	}
	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}

	if (retur<0 && strlen(tmpstr)) {
		pack_alfa(tmpstr);
	}
	if (retur<0 && !strlen(tmpstr)) {
		pack_alfa("OFFLINE");
	}
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	return;
}

/* ECUDLBOOK */
/* PAI FORDELE */
/* *********************************************** */
static int udldk_udregn_pai(int antdg,double *paiprdag) {
	short int retur = 0;
	double prdag = 0;

/* TEST */
	if (logfil) {
		fprintf(logfil, "udldk_udregn_pai:antdg=%d\n",antdg);
	}

	*paiprdag = 0;
	if (antdg>0 && antdg<5) {
		retur = 1;
		prdag = 25;
	}
	if (antdg==5) {
		retur = 1;
		prdag = 20;
	}

	if (antdg>5 && antdg<=20) {
		retur = 1;
		prdag = 15;
	}
	if (antdg>20) {
		retur = 1;
		prdag = 10;
	}
	*paiprdag = prdag;
/*
	*pai *= antdg;
*/
	return(retur);
}

/* *********************************************************** */
static int udldk_checkfrgspg(short funk,char *bilkat,char *bilgrp,long var,long dato,long tid) {
	short int retur = 0;
	short int returanttm = 0;
	short int funkretur = 0;
	short int frgspg = 0;
	long int julian = 0;
	long int returdato = 0;
	long int chkdato = 0;
	long int nuvdato = 0;
	long int nuvtid = 0;
	short int nuvdagnr = 0;
	short int tildagnr = 0;
	short int fundet = 0;
	short int readantal = 0;
	short int chktimer = 0;
	short int chkdagnr = 0;
	short int chkaabentid = 0;
	short int aabendagnr = 0;
	short int aabenexttm = 0;
	long int chkfratid = 0;
	long int chktiltid = 0;
	char tmpstr[41] = "";
	char chkstr1[21] = "";
	char chkstr2[21] = "";

/* TEST */
	if (logfil) {
		fprintf(logfil,
		"udldk_checkfrgspg:funk=%hd,kat=%s,grp=%s,var=%ld,%ld-%ld\n",
			funk,
			bilkat,
			bilgrp,
			var,
			dato,
			tid);
		fflush(logfil);
	}
	if (funk==2) {
		frgspg = 1;
		goto frgspg10;
	}
	reclow(r198,R198);
	if (logfil) {
		fprintf(logfil,"\tHERTIL-000\n");
		fprintf(logfil,"\tf198->status=%hd\n",f198->status);
		fflush(logfil);
	}
	f198_start(1,ISGTEQ);
	if (logfil) {
		fprintf(logfil,"\tHERTIL-001\n");
		fflush(logfil);
	}
	r198->oplkode = 16827;
	sprintf(r198->keyalfa,"*-%s",bilgrp);
	egeread(f198,ISEQUAL);
	if (logfil) {
		fprintf(logfil,"\tHERTIL-002\n");
		fflush(logfil);
	}
	if (f198_ok) {
		frgspg = (short int)r198->numfelt;
	}
	if (logfil) {
		fprintf(logfil,"\tHERTIL-01\n");
		fflush(logfil);
	}
	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16827;
	sprintf(r198->keyalfa,"*-%c*",bilgrp[0]);
	egeread(f198,ISEQUAL);
	if (f198_ok) {
		frgspg = (short int)r198->numfelt;
	}
	if (logfil) {
		fprintf(logfil,"\tHERTIL-02\n");
		fflush(logfil);
	}
	if (strlen(bilkat)) {
		reclow(r198,R198);
		f198_start(1,ISGTEQ);
		r198->oplkode = 16827;
		sprintf(r198->keyalfa,"%s-*",bilkat);
		egeread(f198,ISEQUAL);
		if (f198_ok) {
			frgspg = (short int)r198->numfelt;
		}
		if (logfil) {
			fprintf(logfil,"\tHERTIL-03\n");
			fflush(logfil);
		}
	}
	if (strlen(bilkat) && strlen(bilgrp)) {
		reclow(r198,R198);
		f198_start(1,ISGTEQ);
		r198->oplkode = 16827;
		sprintf(r198->keyalfa,"%s-%s",bilkat,bilgrp);
		egeread(f198,ISEQUAL);
		if (f198_ok) {
			frgspg = (short int)r198->numfelt;
		}
		if (logfil) {
			fprintf(logfil,"\tHERTIL-04\n");
			fflush(logfil);
		}
	}
/* NYT 110108 PERIODEFRGSPG */
	funkretur = udldk_perfrgspg(0,bilgrp,ws_fradato,ws_fratid);
	if (logfil) {
		fprintf(logfil,"\tHERTIL-05\n");
		fflush(logfil);
	}
	funkretur += udldk_perfrgspg(ws_station,bilgrp,ws_fradato,ws_fratid);
	if (logfil) {
		fprintf(logfil,"\tHERTIL-06\n");
		fflush(logfil);
	}
	if (funkretur>0) {
		frgspg = 1;
	}
	if (var>UDLDKMAXFRGSPG) {
		frgspg = 1;
	}
frgspg10:
	nuvdato = dato;
	returdato = m036_funktion(11, nuvdato);
	nuvdagnr = (short int)(returdato%10);
	nuvtid = tid;
/* TEST */
	if (logfil) {
		fprintf(logfil,
		"\tnuvdato-tid=%8.8ld-%4.4ld nuvdagnr=%hd frgspg=%hd\n",
			nuvdato,
			nuvtid,
			nuvdagnr,
			frgspg);
		fflush(logfil);
	}
	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16653;
	r198->keynum = (double)nuvdagnr;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		fundet = -1;
	}
	while (frgspg>0 && fundet>=0) {
		readantal++;
		if (logfil) {
			fprintf(logfil,
			"\tLOOPreadantal=%hd,fundet=%hd,aabendagnr=%hd\n",
				readantal,
				fundet,
				aabendagnr);
			fflush(logfil);
		}
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=16653) {
			break;
		}
		funkretur = 0;
		if (r198->keynum==nuvdato) {
			funkretur++;
		}
		if (r198->keynum==nuvdagnr) {
			funkretur++;
		}
		if (logfil) {
			fprintf(logfil,
			"\tLOOPkeynum=%.0lf funkretur=%hd\n",
				r198->keynum,
				funkretur);
			fflush(logfil);
		}
		if (funkretur<=0) {
			continue;
		}
		chkfratid = 0;
		chktiltid = 2359;
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			(void)get_alfa_tgn(tmpstr,0,chkstr1,'-');
			(void)get_alfa_tgn(tmpstr,1,chkstr2,'-');
		}
		if (strlen(tmpstr) && strlen(chkstr1)) {
			sscanf(chkstr1,"%ld",&chkfratid);
		}
		if (strlen(tmpstr) && strlen(chkstr2)) {
			sscanf(chkstr2,"%ld",&chktiltid);
		}
		if (nuvtid>chktiltid) {
			continue;
		}
		if (nuvtid<chkfratid) {
			continue;
		}
		chkdagnr = 0;
		aabendagnr = 0;
		aabenexttm = 0;
		if (logfil) {
			fprintf(logfil,
			"\talfafelt=%s\n",
				r198->alfafelt);
			fflush(logfil);
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strcmp(tmpstr,"MANDAG")==0) { aabendagnr = 1; }
		if (strcmp(tmpstr,"TIRSDAG")==0) { aabendagnr = 2; }
		if (strcmp(tmpstr,"ONSDAG")==0) { aabendagnr = 3; }
		if (strcmp(tmpstr,"TORSDAG")==0) { aabendagnr = 4; }
		if (strcmp(tmpstr,"FREDAG")==0) { aabendagnr = 5; }
		if (strcmp(tmpstr,"LØRDAG")==0) { aabendagnr = 6; }
		if (strcmp(tmpstr,"SØNDAG")==0) { aabendagnr = 7; }
		if (strlen(tmpstr) && aabendagnr==0) {
			aabendagnr = nuvdagnr;
			sscanf(tmpstr,"%hd",&returanttm);
			aabenexttm = -1;
		}
		if (aabenexttm==0) {
			(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
		}
		if (aabenexttm==0 && strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&aabenexttm);
		}
		fundet++;
/* TEST */
		if (logfil) {
			fprintf(logfil,
			"\tchkfratil=%ld-%ld\n",
				chkfratid,
				chktiltid);
			fprintf(logfil,
			"\taabendagnr=%hd -exttm=%hd\n",
				aabendagnr,
				aabenexttm);
			fprintf(logfil,
			"\treturanttm=%hd\n",
				returanttm);
			fprintf(logfil,
			"\tfundet=%hd\n",
				fundet);
			fflush(logfil);
		}
	}
	if (logfil) {
		fprintf(logfil,
	"\tHERTIL-1frgspg=%hd,aabendagnr=%hd,-exttm=%hd,julian=%ld\n",
				frgspg,
				aabendagnr,
				aabenexttm,
				julian);
		fflush(logfil);
	}
	funkretur = 0;
	if (frgspg>0 && aabendagnr>0 && aabenexttm>=0) {
		julian = m036_funktion(12, nuvdato);
		chktimer = 24;
		chktimer -= (short int)(nuvtid/100);
		if (nuvtid%100>0) {
			chktimer -= 1;
		}
		julian++;
/* TEST */
		if (logfil) {
			fprintf(logfil, "\t chktimer=%hd\n", chktimer);
			fflush(logfil);
		}
	}
/* NYT 090814 */
	if (frgspg>0 && aabendagnr>0 && aabenexttm>=0 &&
		aabendagnr==nuvdagnr) {
		julian = m036_funktion(12, nuvdato);
		chktimer = 0;
		chktimer -= (short int)(nuvtid/100);
/* TEST */
		if (logfil) {
			fprintf(logfil, "\t chktimer=%hd\n", chktimer);
			fflush(logfil);
		}
	}

/* TEST */
	if (logfil) {
		fprintf(logfil,
	"\tHERTIL-2frgspg=%hd,aabendagnr=%hd,funkretur=%hd,julian=%ld\n",
			frgspg,
			aabendagnr,
			funkretur,
			julian);
		fflush(logfil);
	}

	while (frgspg>0 && aabendagnr>0 && aabenexttm>=0 && funkretur==0) {
		chkdato = m036_funktion(19, julian);
		returdato = m036_funktion(11, chkdato);
		nuvdagnr = (short int)(returdato%10);
		if (nuvdagnr==aabendagnr) {
/* find aaben tid */
			chkaabentid = find_8198aabentid(80,nuvdagnr);
			chktimer += (short int)(chkaabentid/100);
			chktimer += aabenexttm;
			returanttm = chktimer;
			funkretur = 1;
		} else {
			chktimer += 24;
		}
/* TEST
		if (logfil) {
			fprintf(logfil, "\t chktimer=%hd julian=%ld\n",
				chktimer,julian);
		}
*/
		julian++;
	}
	if (frgspg>0 && returanttm>0) {
		retur = returanttm;
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,"udldk_checkfrgspg:returanttm=%hd\n",
			returanttm);
		fflush(logfil);
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,"udldk_checkfrgspg:retur=%hd,frgspg=%hd\n",
			retur,
			frgspg);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************ */
static int retur_udldkvinter() {
	int retur = 0;
	long int mmdd = 0;

	if (ws_fradato>0) {
		mmdd = ws_fradato % 10000;
	}
	if (logfil) {
		fprintf(logfil,"retur_udldkvinter:%8.8ld %8.8ld\n",
			ws_fradato,ws_tildato);
		fprintf(logfil,"\tfdt-mmdd=%ld\n",mmdd);
		fflush(logfil);
	}
	if (mmdd>0 && mmdd>=1101) {
		retur = 1;
	}
	if (mmdd>0 && mmdd<=331) {
		retur = 1;
	}
	mmdd = 0;
	if (ws_tildato>0) {
		mmdd = ws_tildato % 10000;
	}
	if (logfil) {
		fprintf(logfil,"\ttdt-mmdd=%ld\n",mmdd);
		fflush(logfil);
	}
	if (mmdd>0 && mmdd>=1101) {
		retur = 1;
	}
	if (mmdd>0 && mmdd<=331) {
		retur = 1;
	}
/* OBS DEAKTIVER
	retur = -1;
*/
	if (logfil) {
		fprintf(logfil,"retur_udldkvinter:retur=%d\n",
			retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************ */
static int udldk_perfrgspg(short inpstatnr,char *inpgrp,long inpdato,long inptid) {
	int retur = 0;
	int okflag = 1;
	long int oplkode = 16831;

	if (logfil) {
		fprintf(logfil,"udldk_perfrpspg:%hd,%s,%ld,%ld\n",
			inpstatnr,
			inpgrp,
			inpdato,
			inptid);
		fflush(logfil);
	}
	reclow(r198,R198);
 	r198->oplkode = oplkode;
	r198->keynum = (double)inpstatnr;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		okflag = 0;
	}
	while (okflag>0 && retur==0) {
		egeread(f198,ISNEXT);
		if (f198_eof) { break; }
		if (r198->oplkode!=oplkode) { break; }
		if (r198->keynum!=inpstatnr) { break; }
		if (r198->numfelt<=0) { continue; }
		if (inpdato>0 && inpdato<r198->fradato) { continue; }
		if (inpdato>0 && inpdato>r198->tildato) { continue; }
		if (logfil) {
			fprintf(logfil,"\t%8.8ld-%8.8ld %s\n",
			r198->fradato,
			r198->tildato,
			r198->alfafelt);
		}
		if (strcmp(inpgrp,r198->alfafelt)==0) {
			retur = 1;
		}
		if (strcmp(r198->alfafelt,"*")==0) {
			retur = 1;
		}
		if (r198->alfafelt[1]==42 && r198->alfafelt[0]==inpgrp[0]) {
			retur = 1;
		}
	}
	if (logfil) {
		fprintf(logfil,"udldk_perfrpspg:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************ */
static int find_8198aabentid(short inpstnr,short inpdagnr) {
	short int retur = 0;
	short int videre = 1;
	long int chkdgnr = 0;
	char tmpstr[41] = "";

	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16606;
	r198->keynum = (double)inpstnr;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		videre = 0;
	}
	while (videre==1 && retur==0) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=16606) {
			break;
		}
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&chkdgnr);
		}
		if (chkdgnr!=inpdagnr) {
			continue;
		}
		if (chkdgnr>7) {
			break;
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&retur);
		}
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,"find_8198aabentid:retur=%hd\n",retur);
	}
	return(retur);
}

/* ************************************** */
static int udldk_checkkunde(short funk) {
	short int retur = 0;
	short int keynr = 0;
	long int kundenr = 0;
	char returstr[81] = "";

/* TEST */
	sprintf(dum_str, "udldk_checkkunde:funk=%hd", funk);
        logfil_put(dum_str);
	if (ws_subfunktion==1) {
		strcpy(ws_kkortnr,ws_tmppara);
	}
	if (ws_subfunktion==2) {
		sscanf(ws_tmppara,"%ld",&ws_kundenr);
	}
	if (ws_subfunktion==3) {
		strcpy(ws_emailadr,ws_tmppara);
	}

	sprintf(dum_str,"udldk_checkkunde:knr=%ld,fdato=%ld,kkort=%s,email=%s",
		ws_kundenr,
		ws_foedselsdato,
		ws_kkortnr,
		ws_emailadr);
        logfil_put(dum_str);

	if (strlen(ws_emailadr)) {
		keynr = 1010;
	}
	if (strlen(ws_kkortnr)) {
		keynr = 6;
	}
	if (ws_kundenr>0) {
		keynr = 1;
	}
/* TEST */
	sprintf(dum_str, "udldk_checkkunde:keynr=%hd", keynr);
        logfil_put(dum_str);
	if (keynr<=0) {
		return(0);
	}

	reclow(r178,R178);
	f178_start(1,ISGTEQ);

	reclow(r167,R167);
	if (keynr==1) {
		r167->kunde_nr = ws_kundenr;
	}
	if (keynr==5) {
		r167->foedselsdato = ws_foedselsdato;
	}
	if (keynr==6) {
		strcpy(r167->kkortnr,ws_kkortnr);
	}
	if (keynr<100) {
		f167_start(keynr,ISGTEQ);
		if (f167_ukendt) {
			kundenr = -1;
		}
	}
	while (keynr<100 && kundenr==0) {
		egeread(f167,ISNEXT);
		if (f167_eof) {
			break;
		}
/* TEST */
	sprintf(dum_str, "\tHERTIL-0 r167->kunde_nr=%ld",r167->kunde_nr);
        logfil_put(dum_str);

		if (keynr==1 && r167->kunde_nr!=ws_kundenr) {
			break;
		}
		if (keynr==5 && r167->foedselsdato!=ws_foedselsdato) {
			break;
		}
		if (keynr==6 && strcmp(r167->kkortnr,ws_kkortnr)!=0) {
			break;
/* RETTET 100322
			continue;
*/
		}
/* TEST */
	sprintf(dum_str, "\tHERTIL-1");
        logfil_put(dum_str);
		if (r167->type!=1) {
			continue;
		}
/* TEST */
	sprintf(dum_str, "\tHERTIL-2");
        logfil_put(dum_str);
		if (ws_foedselsdato >0 &&
			r167->foedselsdato!=ws_foedselsdato) {
			continue;
		}
/* TEST */
	sprintf(dum_str, "\tHERTIL-3");
        logfil_put(dum_str);
		if (check_udldk_kundenr(r167->kunde_nr)<=0) {
			continue;
		}
/* TEST */
	sprintf(dum_str, "\tHERTIL-4");
        logfil_put(dum_str);

		kundenr = r167->kunde_nr;
	}
	reclow(r178,R178);
	f178_start(1,ISGTEQ);
	if (keynr==1010) {
		reclow(r167,R167);
		f167_start(1,ISGTEQ);
		strcpy(r178->alfa_felt,ws_emailadr);
		r178->opl_kode = 10;
		f178_start(4,ISGTEQ);
		if (f178_ukendt) {
			kundenr = -1;
		}
	}
	while (keynr>1000 && kundenr==0) {
		egeread(f178,ISNEXT);
		if (f178_eof) {
			break;
		}
/* TEST */
	sprintf(dum_str, "\tHERTIL-10 r178->knr=%.0lf opl=%hd alfa=%s",
		r178->kunde_nr,
		r178->opl_kode,
		r178->alfa_felt);
        logfil_put(dum_str);
		if (keynr==1010 && strcmp(r178->alfa_felt,ws_emailadr)!=0) {
			break;
		}
		if (keynr==1010 && r178->opl_kode!=10) {
			continue;
		}
/* TEST */
	sprintf(dum_str, "\tHERTIL-11 r178->knr=%.0lf opl=%hd alfa=%s",
		r178->kunde_nr,
		r178->opl_kode,
		r178->alfa_felt);
        logfil_put(dum_str);
		r167->kunde_nr = (long int)r178->kunde_nr;
		egeread(f167,ISEQUAL);
		if (f167_ukendt) {
			continue;
		}
		if (r167->type!=1) {
			continue;
		}
		if (ws_foedselsdato>0 &&
			r167->foedselsdato!=ws_foedselsdato) {
			continue;
		}
		reccpy(&q178,r178,R178);
		if (check_udldk_kundenr((long int)q178.kunde_nr)<=0) {
			reccpy(r178, &q178, R178);
			f178_start(4,ISGREAT);
			if (f178_ukendt) {
				break;
			}
			continue;
		}
		kundenr = (long int)q178.kunde_nr;
/*
		reccpy(r178, &q178, R178);
		f178_start(4,ISGREAT);
		if (f178_ukendt) {
			break;
		}
*/
	}

/* TEST */
	sprintf(dum_str, "udldk_checkkunde:kundenr=%ld", kundenr);
        logfil_put(dum_str);
	if (kundenr<=0) {
		return(0);
	}
	reclow(r167,R167);
	f167_start(1,ISGTEQ);
	r167->kunde_nr = kundenr;
	egeread(f167,ISEQUAL);
	if (f167_ukendt) {
		return(0);
	}
	alfalow(str);
	pack_init(str);
/* EMAIL */
	strcpy(returstr, "");
	if (r167->kunde_nr>0) {
		(void)find_r178(0,10,0,(double)r167->kunde_nr);
		strcpy(returstr, r178->alfa_felt);
	}
	pack_alfa(returstr);
	pack_int2((long)r167->foedselsdato);
	pack_alfa(r167->kkortnr);
	pack_int2((long)r167->kunde_nr);
	pack_alfa(r167->navn_1);
	pack_alfa(r167->navn_2);
	pack_alfa(r167->land);
	pack_alfa(r167->tlf);
	pack_alfa(r167->adr_1);
	pack_alfa(r167->postkode);
	pack_alfa(r167->by);
/* LOKALADR */
	pack_alfa("");
	pack_alfa(r167->pasnr);
/* EXTRATLF */
	pack_alfa("");
/* FAX */
	strcpy(returstr, "");
	if (r167->kunde_nr>0) {
		(void)find_r178(0,9,0,(double)r167->kunde_nr);
		strcpy(returstr, r178->alfa_felt);
	}
	pack_alfa(returstr);
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	if (kundenr>0) {
		return(1);
	} else {
		return(0);
	}
}

/* ******************************************* */
static void udldk_opdaterpris(short funk) {
	short int wx1 = 0;
	short int wx2 = 0;
	short int funkretur = 0;
	short int nextlinie = 0;
	short int modtagantal = 6;
	short int maxextraln = 7;
	double dep_online = 0;
	double dep_kontant = 0;
	double dep_kredit = 0;
	double w_totalpris = 0;
	char idstr[41] = "";
	char datastr[201] = "";
	char tmpstr[81] = "";

/* NYT 090608 FORDELE */
	maxextraln = 8;
/* TEST 110107 VINTERUDL */
	if (ws_udldkvinter>0) {
		maxextraln = 9;
	}

/* TEST */
	sprintf(dum_str, "udldk_opdaterpris:funk=%hd,ws_udldkspcstr=%s",
		funk,
		ws_udldkspcstr);
	logfil_put(dum_str);
	sprintf(dum_str, "udldk_opdaterpris:maxextraln=%hd",
		maxextraln);
	logfil_put(dum_str);
	sprintf(dum_str, "udldk_opdaterpris:ws_udldkvinter=%d",
		ws_udldkvinter);
	logfil_put(dum_str);

	for (wx1=0;wx1<2;wx1++) {
		wx2 = get_alfa_tgn(ws_udldkspcstr,wx1,tmpstr,';');
		if (wx2<=0) {
			break;
		}
		if (wx1==0 && strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&ws_specnr);
		}
		if (wx1==1 && strlen(tmpstr)) {
			strcpy(ws_extspcstr,tmpstr);
		}
	}
/* TEST */
	sprintf(dum_str, "udldk_opdaterpris:ws_spcnr=%hd,ws_extspcstr=%s",
		ws_specnr,
		ws_extspcstr);
	logfil_put(dum_str);
	nextlinie = 1;
	while (nextlinie>=1 && nextlinie<=maxextraln) {
/* TEST */
		sprintf(dum_str, "udldk_opdaterpris:nextlinie=%hd", nextlinie);
		logfil_put(dum_str);
		if (get_subrecord()<=0) {
/* TEST */
			sprintf(dum_str,
				"udldk_opdaterpris:HERTIL:get_subrecord<=0");
			logfil_put(dum_str);
			break;
		}
		get_alfa(idstr);
		ege_toupper((unsigned char *)idstr);
		get_alfa(datastr);
		ege_toupper((unsigned char *)datastr);
/* TEST */
		sprintf(dum_str,
			"udldk_opdaterpris:HERTIL-1:idstr=%s,datastr=%s",
			idstr,
			datastr);
		logfil_put(dum_str);
		strcpy(ws_udldkidtab[nextlinie],idstr);
		strcpy(ws_udldkdatatab[nextlinie],datastr);
		nextlinie++;
	}
	ws_udldkextraidx = nextlinie;
/* TEST */
	sprintf(dum_str, "udldk_opdaterpris:nextlinie=%hd",
		nextlinie);
	logfil_put(dum_str);
/* PAI FORDELE */
        ws_paiflag = 0;
	if (ws_udldkvinter<1 && strcmp(ws_udldkidtab[8],"08_PAI")==0 &&
		strcmp(ws_udldkdatatab[8],"JA")==0) {
		ws_paiflag = 1;
	}
	if (ws_udldkvinter>=1 && strcmp(ws_udldkidtab[9],"08_PAI")==0 &&
		strcmp(ws_udldkdatatab[9],"JA")==0) {
		ws_paiflag = 1;
	}
/* RETTET 110108
	if (strcmp(ws_udldkidtab[8],"07_PAI")==0 &&
		strcmp(ws_udldkdatatab[8],"JA")==0) {
		ws_paiflag = 1;
	}
*/

/* TEST */
	sprintf(dum_str, "udldk_opdaterpris:ws_paiflag=%hd",
		ws_paiflag);
	logfil_put(dum_str);



/* 090401 UDLDKEXTRA */
	if (funk==240 && ws_udldkflag>0) {
/* tom */
		get_alfa(ws_udldkbemtab[0]);
/* lokal adr */
		get_alfa(ws_udldkbemtab[1]);
/* lejer adr 2 */
		get_alfa(ws_udldkbemtab[2]);
/* tom */
		get_alfa(ws_udldkbemtab[3]);
/* lokal postnr */
		get_alfa(ws_udldkbemtab[4]);
/* lokal by */
		get_alfa(ws_udldkbemtab[5]);
/* ukendt-1 */
		get_alfa(ws_udldkbemtab[6]);
/* ukendt-2 */
		get_alfa(ws_udldkbemtab[7]);
/* lejer fax */
		get_alfa(ws_udldkbemtab[8]);
/* ukendt-3 */
		get_alfa(ws_udldkbemtab[9]);
/* øvrige bem */
		get_alfa(ws_udldkbemtab[10]);
/* lokal adr 2 */
		get_alfa(ws_udldkbemtab[11]);

		return;
	}

	funkretur = nyopret_reservation(0,0,1);
/* TEST */
	if (logfil) {
		fprintf(logfil,
	"\tudldk_opdaterpris:NYOPRET_RESERVATION:funkretur=%hd,total=%.2lf\n",
			funkretur,
			r159->total);
		fprintf(logfil,"\t\trateantal-0=%ld,enhed-0=%hd,pris-0=%.2lf\n",
			r159->rate_antal[0],
			r159->rate_enhed[0],
			r159->rate_pris[0]);
	}
	dep_online = 0;
	dep_kontant = 0;
	dep_kredit = 0;
	ege_w_dou1 = 0;
	dep_online = ege_w_dou1;
	ege_w_dou1 = 0;
/* KREDITKORT */
	ege_w_dou1 = 2000;
	dep_kredit = ege_w_dou1;
	ege_w_dou1 = 0;
/* KONTANT */
	ege_w_dou1 = 3000;
	dep_kontant = ege_w_dou1;

/* NYT 110510 UDLDKPRIODE */

	w_totalpris = r159->total;
	if (logfil) {
		fprintf(logfil,"AFRUND0-FØR=%.2lf",w_totalpris);
	}
	afrund0(w_totalpris);
	if (logfil) {
		fprintf(logfil,"AFRUND0-EFT=%.2lf",w_totalpris);
	}

	alfalow(str);
	pack_init(str);
	ege_w_dou1 = w_totalpris;
/* RETTET 110510 UDLDKPERIODE
	ege_w_dou1 = r159->total;
*/
/*
	ege_w_dou1 += dep_online;
*/
	pack_doub(ege_w_dou1);
	ege_w_dou1 = w_totalpris;
/* RETTET 110510 UDLDKPERIODE
	ege_w_dou1 = r159->total;
*/
/*
	ege_w_dou1 += dep_kontant;
*/
	pack_doub(ege_w_dou1);
	ege_w_dou1 = w_totalpris;
/* RETTET 110510 UDLDKPERIODE
	ege_w_dou1 = r159->total;
*/
/*
	ege_w_dou1 += dep_kredit;
*/
	pack_doub(ege_w_dou1);
/* NYT 071113 LEJE + EXTRA */
	ege_w_dou1 = w_totalpris;
/* RETTET 110510 UDLDKPERIODE
	ege_w_dou1 = r159->total;
*/
	pack_doub(ege_w_dou1);
	for (wx1=1;wx1<nextlinie;wx1++) {
		pack_doub(ws_udldkdatapris[wx1]);
	}
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	return;
}
/* ********************************** */
static void udldk_extraliste(short funk,char * langstr,short stnr,long knr,long fradt,long tildt,char * grp) {
	short int retur = 0;
	short int nuvidx = 0;
	short int wx1 = 0;
	short int funkretur = 0;
	short int chkspcnr = 0;
	short int maxantal = 0;
	char chkgrp[11] = "";
	char tmpstr[81] = "";
	char chkstr[41] = "";
	char returstr[81] = "";
	char extrastr[501] = "";

/* TEST */
	sprintf(dum_str,
	"udldk_extraliste:funk=%hd,stnt=%hd,knr=%ld,dato=%ld-%ld,grp=%s",
		funk,
		stnr,
		knr,
		fradt,
		tildt,
		grp);
        logfil_put(dum_str);
	if (logfil) {
		fprintf(logfil,"\tws_udldkvinter=%d\n",ws_udldkvinter);
		fprintf(logfil,"\tws_udldkflag=%hd\n",ws_udldkflag);
	}

	reclow(r165, R165);
	f165_start(1,ISGTEQ);
	while (nuvidx>=0 && nuvidx<MAX_UDLEXTTAB) {
		if (ws_udldkexttab[nuvidx]==0) {
			nuvidx++;
			continue;
		}
/* NYT 110108 VINTERUDL */
		if (ws_udldkvinter<1 && ws_udldkexttab[nuvidx]==910) {
			nuvidx++;
			continue;
		}
		sprintf(tmpstr,"IDX%3.3hd",nuvidx);
		chkspcnr = ws_udldkexttab[nuvidx];
		strcpy(chkgrp,ws_udldkextgrp[nuvidx]);
/* NOTAT 090326 */
		if (chkspcnr==-1) {
			sprintf(tmpstr,"%2.2hd_%s",
				nuvidx,
				"NOTAT");
		}
		if (chkspcnr>=900) {
			r165->spec_nr = chkspcnr;
			r165->stat_nr = 0;
			strcpy(r165->bil_grp,chkgrp);
			egeread(f165,ISEQUAL);
		}
		if (chkspcnr>=900 && f165_ok) {
			sprintf(tmpstr,"%2.2hd_%3.3hd_%s",
				nuvidx,
				r165->spec_nr,
				r165->bil_grp);
		}
/* PAI FORDELE 090608 */
		if (chkspcnr==-2) {
			sprintf(tmpstr,"%2.2hd_%s",
				nuvidx,
				"PAI");
		}
		alfalow(str);
		pack_init(str);
		pack_alfa(tmpstr);

/* Korttekst */
		strcpy(extrastr, ws_udldkexttxt[nuvidx]);
		pack_alfa(extrastr);
/* Langtekst */
		if (chkspcnr==-1) {
			sprintf(extrastr,
"<BR>Skriv eventuelle ønsker i bemærkningsfeltet nedenfor, så vil vi forsøge at efterkomme dem.<BR>");
/* RETTET 110118
"<BR>Skriv eventuelle ønsker i bemærkningsfeltet nedenfor, så vil vi forsøge at efterkomme dem.<BR><BR><font color=\"\04304662C\">Vinterdæk?</font> <a title=\"Klik her\" href=\"%s\" target=\"_blank\">Klik her</a>","http://www.europcar.dk/dk/før_du_lejer_bil/vinterdæk-1.aspx");
*/
/* RETTET 091112
"Skriv eventuelle ønsker i bemærkningsfeltet nedenfor, så vil vi forsøge at efterkomme dem.");
*/


		}
		if (chkspcnr==905) {
			strcpy(extrastr,
"(Gratis ved forudbestilling)");
/* RETTET 090603 FORDELE
"(kr. 125,- pr. stk.)");
*/
		}
		if (chkspcnr==924) {
			strcpy(extrastr,
"(Specialpriser ved forudbestilling)<br>kr. 50,- pr. dag<br>kr. 250,- pr. uge<br>kr. 500,- pr. måned<br>(Der er en selvrisiko på kr. 3.200,- hvis GPS'en bliver beskadiget eller stjålet).<br>");
/* RETTET 090603 FORDELE
"kr. 95,- pr. dag<br>kr. 550,- pr. uge<br>kr. 1.250,- pr. måned<br>(Der er en selvrisiko på kr. 4.600,- hvis GPS'en bliver beskadiget eller stjålet).<br>");
*/
		}
		if (chkspcnr==996) {
			strcpy(extrastr,
"(Gratis ved forudbestilling)<br>Skal fremvise kørekort.");
/* RETTET 090605 FORDELE
"(kr. 95,- uanset antal)<br>Skal fremvise kørekort.");
*/
		}
		if (chkspcnr==997) {
			strcpy(extrastr,
"(kr. 95,- pr. ung fører)<br>Hvis fører er 23, 24 eller 25 år.<br>(OBS: må kun køre A,B,F).");
/* RETTET 100521
			strcpy(extrastr,
"(kr. 95,- pr. ung fører)<br>Hvis fører er 23 eller 24 år.<br>(OBS: må kun køre A,B,F).");
*/
		}
/* NYT 090608 PAI FORDELE PAI */
		if (chkspcnr==-2) {
/* NYT 090813 */
			strcpy(chkstr,"http://www.europcar.dk");
			if (ws_testkreds) {
				strcpy(chkstr,"http://beta.europcar.dk");
			}
			sprintf(extrastr,
"%s<a title=\"Læs mere her\" href=\"%s%s\" target=\"_blank\">%s</a>",
"(Specialpriser ved forudbestilling)<br>Pris pr. dag kr. 10,- 15,- 20,- 25,-<br>- afhængig af lejeperioden.<br>",
				chkstr,
				"/default.aspx?id=3379",
				"Forsikringsbetingelser (PAI)");
/*
			strcpy(extrastr,
"(Specialpriser ved forudbestilling)<br>Pris pr. dag kr. 10,- 15,- 20,- 25,-<br>- afhængig af lejeperioden.<br>");
*/


/*
			strcpy(extrastr,
"kr. 25,- pr. dag<br>kr. 105,- pr. uge<br>kr. 300,- pr. måned<br>");
*/
		}
/* NYT 120503 TXBC */
		if (chkspcnr==-2 && ws_udldkflag==2) {
			strcpy(chkstr,"http://www.taxfreecars.dk");
			if (ws_testkreds) {
				strcpy(chkstr,"http://beta.taxfreecars.dk");
			}
			sprintf(extrastr,
"%s<a title=\"Læs mere her\" href=\"%s%s\" target=\"_blank\">%s</a>",
"(Specialpriser ved forudbestilling)<br>Pris pr. dag kr. 10,- 15,- 20,- 25,-<br>- afhængig af lejeperioden.<br>",
				chkstr,
				"/default.aspx?id=4161",
				"Forsikringsbetingelser (PAI)");
		}
		if (chkspcnr==-2 && ws_udldkflag==3) {
			strcpy(chkstr,"http://www.bookcar.dk");
			if (ws_testkreds) {
				strcpy(chkstr,"http://beta.bookcar.dk");
			}
			sprintf(extrastr,
"%s<a title=\"Læs mere her\" href=\"%s%s\" target=\"_blank\">%s</a>",
"(Specialpriser ved forudbestilling)<br>Pris pr. dag kr. 10,- 15,- 20,- 25,-<br>- afhængig af lejeperioden.<br>",
				chkstr,
				"/default.aspx?id=4152",
				"Forsikringsbetingelser (PAI)");
		}




/* TEST 110108 VINTER */
		if (chkspcnr==910) {
			strcpy(extrastr,
"<a title=\"Vinterdæk info\" href=\"http://www.europcar.dk/dk/før_du_lejer_bil/vinterdæk-1.aspx\" target=\"_blank\">Se evt. mere her</a><br>kr. 50,- pr. dag<br>kr. 1.500,- pr. måned<br>(Specialpriser ved forudbestilling)<br>(OBS: vinterdæk er på forespørgsel)<br>");

/* RETTET 111005 VINTER2011
		if (chkspcnr==910) {
			strcpy(extrastr,
"<a title=\"Vinterdæk info\" href=\"http://www.europcar.dk/dk/før_du_lejer_bil/vinterdæk-1.aspx\" target=\"_blank\">Se evt. mere her</a><br>kr. 120,- pr. dag<br>kr. 490,- pr. uge<br>kr. 1470,- pr. måned<br>(OBS: vinterdæk er på forespørgsel)<br>");
*/
		}

		pack_alfa(extrastr);
		strcpy(tmpstr,"");
		maxantal = ws_udldkextant[nuvidx];
		if (maxantal==0) {
			pack_alfa("");
			pack_alfa("NOTAT");
			pack_alfa("");
		}
		if (maxantal==1) {
			pack_alfa("Ja;Nej");
			pack_alfa("RADIO");
			pack_alfa("Nej");
		} 
		if (maxantal>1 && maxantal<=6) {
			for (wx1=0;wx1<=maxantal;wx1++) {
				if (wx1==0) {
					sprintf(returstr,"%hd",wx1);
				} else {
					sprintf(returstr,";%hd",wx1);
				}
				strcat(tmpstr,returstr);
			}
			pack_alfa(tmpstr);
			pack_alfa("DROPDOWN");
			pack_alfa("0");
		}
		if (maxantal==7) {
			pack_alfa("Ja;Nej");
			pack_alfa("RADIO");
			pack_alfa("Nej");
		} 
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		nuvidx++;
		retur++;
	}
	return;
}

/* **************************************** */
static int ecweb_udldkgrptab(short inpspcnr,long inpudt,long inpvar) {
	short int chkstatnr = ws_station;
	short int statkat = 0;
	short int nuvidx = 0;
	short int funkretur = 0;
	short int readantal = 0;
	short int sortantal = 0;
	short int sortkode = 0;
	short int sortfrgspg = 0;
	short int retur = 0;
	short int pjretur = 0;
	short int nyenhed = 0;
	short int stopsalgflag = 0;
	long int nyantal = 0;
	long int nyinclkm = 0;
	double nypris = 0;
	double nycdidg = 0;
	double nypaidg = 0;
	double nyextkm = 0;
	long int sortpris = 0;
	char chkbilkat[11] = "";
	char chkbilgrp[11] = "";
	char sortbuffer[201] = "";

/* TEST */
	if (logfil) {
		fprintf(logfil,
		"ecweb_udldkgrptab:inpspcnr=%hd,inpudt=%ld,inpvar=%ld\n",
			inpspcnr,
			inpudt,
			inpvar);
	}
	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16649;
	r198->keynum = (double)chkstatnr;
	egeread(f198,ISEQUAL);
	if (f198_ukendt) {
		return(0);
	}
	statkat = (short int)r198->numfelt;
	if (logfil) {
		fprintf(logfil,"ecweb_udldkgrptab:statkat=%hd\n",statkat);
	}
	reclow(r198,R198);
	r198->oplkode = 16650;
	r198->keynum = (double)statkat;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		return(0);
	}
	sortantal = 0;
	while (statkat>=1 && sortantal>=0) {
		egeread(f198, ISNEXT);
		readantal++;
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=(long int)16650) {
			break;
		}
		if (r198->keynum!=(double)statkat) {
			break;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		if (logfil) {
			fprintf(logfil,
			"ecweb_udldkgrptab:%hd oplkode=%ld %.0lf %s\n",
				readantal,
				r198->oplkode,
				r198->keynum,
				r198->alfafelt);
		}
		reccpy(&z198,r198,R198);
		funkretur = check_udldk_st_undt(chkstatnr,z198.alfafelt);
		if (logfil) {
			fprintf(logfil,
			"ecweb_udldkgrptab:CHECK_UDLDK_ST_UNDT,funkretur=%hd\n",
				funkretur);
		}
		if (funkretur>0) {
			reccpy(r198,&z198,R198);
			f198_start(1, ISGREAT);
			if (f198_ukendt) {
				break;
			}
			continue;
		}

		sortkode = 0;
		(void)get_alfa_tgn(z198.alfafelt,0,chkbilkat,45);
		(void)get_alfa_tgn(z198.alfafelt,1,chkbilgrp,45);
		reclow(r198,R198);
		f198_start(1,ISGTEQ);
		r198->oplkode = 16822;
		strcpy(r198->keyalfa,chkbilkat);
		egeread(f198,ISEQUAL);
		if (f198_ok) {
			sortkode = (short int)r198->numfelt;
		}
/* CHECK STOPSALG */
		funkretur = check_stopsalg(1,
			0,chkbilgrp,ws_fradato,ws_tildato);
/* NYT 101223 */
		funkretur += check_stopsalg(1,
			chkstatnr,chkbilgrp,ws_fradato,ws_tildato);
/* TEST */
		if (logfil) {
			fprintf(logfil,
			"ecweb_udldkgrptab:CHECK_STOPSALG,funkretur=%hd\n",
				funkretur);
		}
		if (funkretur>0) {
			stopsalgflag++;
			reccpy(r198,&z198,R198);
			f198_start(1, ISGREAT);
			if (f198_ukendt) {
				break;
			}
			continue;
		}
/* NYT 120306 UDLDKINAKTIVGRP */
		funkretur = check_grpinaktiv(1,
			chkstatnr,chkbilgrp,ws_fradato,ws_tildato);
/* TEST */
		if (logfil) {
			fprintf(logfil,
			"ecweb_udldkgrptab:CHECK_GRPINAKTIV,funkretur=%hd\n",
				funkretur);
		}
		if (funkretur>0) {
			reccpy(r198,&z198,R198);
			f198_start(1, ISGREAT);
			if (f198_ukendt) {
				break;
			}
			continue;
		}
		sortfrgspg = udldk_checkfrgspg(1,
			chkbilkat,
			chkbilgrp,
			inpvar,
			ws_systemdato,
			ws_systemtid);
/* NYT 090327 */
		sortpris = 0;

		if (inpvar<=UDLDKMAXFRGSPG && inpspcnr>0) {
			pjretur = find_f198prisjust(inpspcnr,
			chkbilgrp,
			(short int)0,
			inpudt,
			(int)inpvar,
			&nypris,
			&nyenhed,
			&nyantal,
			&nycdidg,
			&nypaidg,
			&nyextkm,
			&nyinclkm);
		}
		if (inpspcnr>0 && pjretur>0) {
			nypris *= nyantal;
			sortpris = (long int)nypris;
		}
		if (inpspcnr>0 && inpvar>UDLDKMAXFRGSPG) {
			sortpris = 99999;
		}
/* TEST */
		if (logfil) {
			fprintf(logfil,
			"ecweb_udldkgrptab:SORTPRIS=%ld GRP=%s\n",
				sortpris,
				chkbilgrp);
		}
		if (sortantal==0 && strlen(chkbilgrp) && strlen(chkbilkat)) {
			egesort(1, "sort");
		}
		if (strlen(chkbilgrp) && strlen(chkbilkat)) {
			sprintf(sortbuffer, "%1hd %8.8ld %-3s %-4s %3hd \n \0",
				sortkode,
				sortpris,
				chkbilkat,
				chkbilgrp,
				sortfrgspg);
			egesort(2, sortbuffer);
			sortantal++;
		}
		reccpy(r198,&z198,R198);
		f198_start(1, ISGREAT);
		if (f198_ukendt) {
			break;
		}
	}
	if (logfil) {
		fprintf(logfil,"ecweb_udldkgrptab:ws_udldkgrpidx=%hd\n",
			ws_udldkgrpidx);
		fprintf(logfil,"ecweb_udldkgrptab:sortantal=%hd\n",sortantal);
		fprintf(logfil,"ecweb_udldkgrptab:readantal=%hd\n",readantal);
		fprintf(logfil,"ecweb_udldkgrptab:MAX_UDLGRPTAB=%hd\n",
			(short int)MAX_UDLGRPTAB);
		fflush(logfil);
	}
	nuvidx = 0;
	if (sortantal>0) {
		egesort(3, "sort");
	}
	while (sortantal>0) {
		if (egesort(4, sortbuffer)<=0) {
			break;
		}
		if (logfil) {
			fprintf(logfil,"\tsortbuffer=%s",sortbuffer);
		}
		sscanf(sortbuffer,"%hd %ld %s %s %hd",
			&sortkode,
			&sortpris,
			chkbilkat,
			chkbilgrp,
			&sortfrgspg);
		if (ws_udldkgrpidx<MAX_UDLGRPTAB && sortpris>0) {
/* RETTET 100503
		if (nuvidx<MAX_UDLGRPTAB && sortpris>0) {
*/
			sprintf(ws_udldkgrptab[ws_udldkgrpidx],"%s %s %hd",
				chkbilkat,
				chkbilgrp,
				sortfrgspg);
			ws_udldkgrpidx++;
		}
		nuvidx++;
		retur++;
	}
	if (logfil) {
		fprintf(logfil,"ecweb_udldkgrptab:nuvidx=%hd\n",
			nuvidx);
		fprintf(logfil,"ecweb_udldkgrptab:ws_udldkgrpidx=%hd\n",
			ws_udldkgrpidx);
		fprintf(logfil,"ecweb_udldkgrptab:stopsalgflag=%hd\n",
			stopsalgflag);
		fprintf(logfil,"ecweb_udldkgrptab:retur=%hd\n",
			retur);
	}
	if (logfil) {
		for (funkretur=0;funkretur<ws_udldkgrpidx;funkretur++) {
			fprintf(logfil,"ecweb_udldkgrptab:%hd=<%s>\n",
				funkretur,
				ws_udldkgrptab[funkretur]);
		}
	}
/* NYT 100416 */
	if (retur==0 && stopsalgflag>0) {
		retur = -1;
	}
	return(retur);
}

/* ********************************************* */
static int check_udldk_st_undt(short inpstatnr,char *inpbilkatgrp) {
	short int retur = 0;
	long int oplkode = 16651;

	if (logfil) {
		fprintf(logfil,"check_udldk_st_undt:%hd %s\n",
			inpstatnr,inpbilkatgrp);
	}
	reclow(r198,R198);
	r198->oplkode = oplkode;
	r198->keynum = (double)inpstatnr;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		return(0);
	}
	while (retur==0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
		if (r198->keynum!=inpstatnr) {
			break;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		if (strcmp(inpbilkatgrp,r198->alfafelt)!=0) {
			continue;
		}
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"check_udldk_st_undt:retur=%hd\n",
			retur);
	}
	return(retur);
}

/* **************************************** */
static int udldk_prisliste(short prisfunk) {
	short int retur = 0;
	short int wx1 = 0;
	short int udldkidx = 0;
	short int funkretur = 0;
	short int tabretur = 0;
	long int uddato = 0;
	long int inddato = 0;
	long int udtid = 0;
	long int dgnindtid = 0;
	long int indtid = 0;
	long int julian = 0;
	long int returdato = 0;
	long int returdato2 = 0;
	long int varighed = 0;
	long int altvarighed = 0;
	long int tmvarighed = 0;
	long int maxvarighed = 365;
	short int weekendflag = 0;
	short int uddagnr = 0;
	short int inddagnr = 0;
	short int styrspecnr = 228;
	long int minutslip = 0;
	long int minudslip = 0;
	long int minuddato = 0;
	long int minudtid = 0;
	short int udvslipflag = 0;
	short int fejlkode = 0;
	short int nglindkast = 0;
	char tmpstr[81] = "";
	char returstr[81] = "";

/* TEST */
	sprintf(dum_str, "udldk_prisliste:prisfunk=%hd ws_udldkflag=%hd",
		prisfunk,
		ws_udldkflag);
        logfil_put(dum_str);

	uddato = ws_fradato;
	inddato = ws_tildato;
	udtid = ws_fratid;
	indtid = ws_tiltid;
	julian = m036_funktion(12, uddato);
	varighed = (long int)(m036_funktion(12, inddato)-julian);
	returdato = m036_funktion(11, uddato);
	uddagnr = (short int)(returdato%10);
	returdato = m036_funktion(11, inddato);
	inddagnr = (short int)(returdato%10);
/* UDLDKDØGNPRISER 090331 */
	dgnindtid = udtid;
	dgnindtid += 100;
	if (indtid>dgnindtid && inddato>uddato) {
		varighed++;
	}
	if (inddato==uddato) {
		varighed++;
	}

	returdato = ws_fradato;
	returdato *= 10000;
	returdato += ws_fratid;
	returdato2 = ws_tildato;
	returdato2 *= 10000;
	returdato2 += ws_tiltid;
	tmvarighed = udvdatofunk(10,returdato2,returdato);

	if (uddagnr<=6 && inddagnr>6 && tmvarighed<=72 && varighed==3) {
		weekendflag = 1;
		styrspecnr = 227;
	}
	if (uddagnr<=6 && inddagnr==1 && tmvarighed<=72 && varighed==3) {
		weekendflag = 1;
		styrspecnr = 227;
	}
	if (uddagnr<=6 && inddagnr==2 && tmvarighed<=72 && varighed==3) {
		weekendflag = 1;
		styrspecnr = 227;
	}
/* NYT 120413 TXBCBOOK */
	if (ws_udldkflag==2 && styrspecnr==228) {
		styrspecnr = 113;
	}
	if (ws_udldkflag==2 && styrspecnr==227) {
		styrspecnr = 112;
	}
	if (ws_udldkflag==3 && styrspecnr==228) {
		styrspecnr = 111;
	}
	if (ws_udldkflag==3 && styrspecnr==227) {
		styrspecnr = 110;
	}

	ws_udldkjul = udldk_checkjul(uddato,inddato,weekendflag,varighed);


/* TEST */
	sprintf(dum_str,
	"udldk_prisliste:tmv=%ld,uddagnr=%hd,inddagnr=%hd,weekendflag=%hd",
		tmvarighed,
		uddagnr,
		inddagnr,
		weekendflag);
        logfil_put(dum_str);
	sprintf(dum_str,
		"udldk_prisliste:varighed=%ld,stspc=%hd",
		varighed,
		styrspecnr);
        logfil_put(dum_str);
	sprintf(dum_str,
		"udldk_prisliste:ws_udldkjul=%hd",
		ws_udldkjul);
        logfil_put(dum_str);

	strcpy(returstr,"P7911EC");
	sprintf(tmpstr,"MinUdSlip=");
	if (retur_f198_def((long int)1002,tmpstr,returstr)>0) {
		sscanf(returstr,"%ld",&minudslip);
	}
	strcpy(returstr,"P7911EC");
	sprintf(tmpstr,"MinUdSlip%2.2hd=",ws_station);
	if (retur_f198_def((long int)1002,tmpstr,returstr)>0) {
		sscanf(returstr,"%ld",&minudslip);
	}
	udvslipflag = check_udvstslip(ws_station,ws_fradato,ws_fratid);

/* TEST */
	sprintf(dum_str,
		"udldk_prisliste:minudslip=%ld,systemtid=%ld,udvslipflag=%hd",
		minudslip,
		ws_systemtid,
		udvslipflag);
        logfil_put(dum_str);
	minutslip = 0;
	minuddato = ws_systemdato;
	minudtid = ws_systemtid;
	if (minudslip>0) {
		julian = m036_funktion(12, ws_systemdato);
		ege_w_int1 = ws_systemtid/100;
		ege_w_int1 += (minudslip/60);

		ege_w_int2 = ws_systemtid%100;
		ege_w_int2 += (minudslip%60);
		if (ege_w_int2>=60) {
			ege_w_int1++;
			ege_w_int2 -= 60;
		}
		julian += (ege_w_int1/24);
		minuddato = m036_funktion(19, julian);
		minudtid = ege_w_int1%24;
		minudtid *= 100;
		minudtid += ege_w_int2;
/* TEST */
		sprintf(dum_str,
		"udldk_prisliste:MINUDSLIP-2 minuddato=%ld minudtid=%ld",
			minuddato,
			minudtid);
        	logfil_put(dum_str);
	}
	if (udvslipflag==0 && minudslip>0 &&
		ws_fradato<minuddato) {
		minutslip = 1;
	}
	if (udvslipflag==0 && minudslip>0 &&
		ws_fradato==minuddato && ws_fratid<minudtid) {
		minutslip = 1;
	}
/* TEST */
	sprintf(dum_str,
	"udldk_prisliste:MINUDSLIP-3 minutslip=%hd udvslipflag=%hd",
		minutslip,
		udvslipflag);
       	logfil_put(dum_str);
	if (udvslipflag==0 && minudslip>0 &&
		minutslip>0) {
		fejlkode = 1000;
		fejlkode += (int)ws_station;
		fejlkode *= -1;
	}
	if (udvslipflag>0) {
		fejlkode = 1100;
		fejlkode += udvslipflag;
		fejlkode *= -1;
	}
/* TEST */
	sprintf(dum_str,
	"udldk_prisliste:MINUDSLIP-4 fejlkode=%hd",
		fejlkode);
       	logfil_put(dum_str);

	if (ws_fradato<=0) {
		fejlkode = -10;
	}
	if (ws_tildato<=0) {
		fejlkode = -11;
	}
	if (ws_fratid<=0) {
		fejlkode = -12;
	}
	if (ws_tiltid<=0) {
		fejlkode = -13;
	}
/* TEST */
	sprintf(dum_str,
		"udldk_prisliste:fejlkode=%hd",
		fejlkode);
        logfil_put(dum_str);
	if (fejlkode!=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)fejlkode);
		sprintf(tmpstr,"%d",(fejlkode*-1));
		web_errormess(0,ws_langstr,tmpstr);
		pack_exchkend();
		send_linie();
		return(0);
	}
/* NYT 060119 */
	funkretur = check_bssaaben(-1,ws_station,uddato,udtid);
	if (funkretur<=0) {
		(void)check_bssaaben(-1,ws_station,uddato,-1);
	}
/* TEST */
	sprintf(dum_str,
	"udldk_prisliste:check_bssaaben UD %ld funkretur=%hd ws_alert_txt=%s",
		uddato,
		funkretur,
		ws_alert_txt);
        logfil_put(dum_str);

	if (varighed>maxvarighed) {
		fejlkode = 900;
		fejlkode += (int)ws_station;
		fejlkode *= -1;
	}
/* TEST */
	sprintf(dum_str,
		"udldk_prisliste:fejlkode=%hd",
		fejlkode);
        logfil_put(dum_str);
	if (fejlkode!=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)fejlkode);
		sprintf(tmpstr,"%d",(fejlkode*-1));
		web_errormess(0,ws_langstr,tmpstr);
		pack_exchkend();
		send_linie();
		return(0);
	}

	funkretur = check_bssaaben(-1,ws_tilstation,inddato,indtid);
	if (funkretur<=0) {
		(void)check_bssaaben(-1,ws_tilstation,inddato,-1);
	}
/* TEST */
	sprintf(dum_str,
	"udldk_prisliste:check_bssaaben IND %ld funkretur=%hd ws_alert_txt=%s",
		inddato,
		funkretur,
		ws_alert_txt);
        logfil_put(dum_str);
	nglindkast = 0;
	reclow(r198, R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16623;
	r198->keynum = ws_tilstation;
	egeread(f198, ISEQUAL);
	if (f198_ok) {
		nglindkast = (short int)r198->numfelt;
	}
/* NYT 090331 */
	if (ws_udldkflag>0) {
		nglindkast = 1;
	}
/* TEST */
	sprintf(dum_str,
		"udldk_prisliste:ws_tilstation=%hd nglindkast=%hd",
		ws_tilstation,
		nglindkast);
        logfil_put(dum_str);
	if (funkretur<=0 && nglindkast<=0) {
		fejlkode = -17;
	}
/* NYT 110510 OWBLOK */
	funkretur = 0;
	if (ws_station!=ws_tilstation) {
		funkretur += check_owblok(1,
			ws_station,"*",ws_fradato,ws_tildato);
		funkretur += check_owblok(1,
			ws_tilstation,"*",ws_fradato,ws_tildato);
	}
	if (funkretur) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-54);
		web_errormess(0,ws_langstr,"54");
		pack_exchkend();
		send_linie();
		return(0);
	}

	tabretur = ecweb_udldkgrptab(styrspecnr,uddato,varighed);
	if (ws_udldkgrpidx<=0 && tabretur==-1) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-54);
		web_errormess(0,ws_langstr,"54");
		pack_exchkend();
		send_linie();
		return(0);
	}
	if (ws_udldkgrpidx<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-52);
		web_errormess(0,ws_langstr,"52");
		pack_exchkend();
		send_linie();
		return(0);
	}
/* TEST */
	sprintf(dum_str,
		"udldk_prisliste:ws_udldkgrpidx=%hd",
		ws_udldkgrpidx);
        logfil_put(dum_str);

	udldkidx = 0;
/* NYT 090924 */
	altvarighed = varighed;
	if (ws_udldkjul>0) {
		altvarighed += (long int)ws_udldkjul;
	}
/* TEST */
	sprintf(dum_str,
		"udldk_prisliste:altvarighed=%ld",
		altvarighed);
        logfil_put(dum_str);

	while (udldkidx<ws_udldkgrpidx) {
		send_udldk_prod(udldkidx,
			uddato,
			udtid,
			inddato,
			indtid,
			altvarighed,
			styrspecnr,
			weekendflag);

		udldkidx++;
	}

	return(retur);
}

/* ******************************************************************* */
static int udldk_checkjul(long uddt,long inddt,short wflag,long var) {
	short int retur = 0;
	short int fundet = 0;
	long int minvar = 7;
	long int checkud = 0;
	long int checkind = 0;
	long int checkfra = 0;
	long int checktil = 0;

/* NYT 101028 */
	minvar = var;

	checkud = uddt % 10000;
	checkind = inddt % 10000;

	checkfra = 1223;
	checktil = 1226;
	if (checkud>=checkfra && checkud<=checktil) { fundet++; }
	if (checkind>=checkfra && checkind<=checktil) { fundet++; }
	if (checkud<checkfra && checkind>checktil) { fundet++; }
	if (fundet>0 && var<minvar) {
		retur = (short int)minvar-var;
	}
	return(retur);
}

/* ******************************************************************* */
static int send_udldk_prod(short idx,long uddato,long udtid,long inddato,long indtid,long varighed,short spcnr,short wflag) {
	short int retur = 0;
	short int wx1 = 0;
	short int funkretur = 0;
	short int chkfrgspg = 0;
	short int rateidx = 0;
	short int aftaleflag = 0;
	short int pjretur = 0;
	short int nyenhed = 0;
	long int nyantal = 0;
	long int nyinclkm = 0;
	double nypris = 0;
	double nycdidg = 0;
	double nypaidg = 0;
	double nyextkm = 0;

	double depositum = 0;
	short int extrastnr = 0;
	short int extraantal = 0;
	short int extraspecnr = 0;
	char extragrp[11] = "";

	char chkbilkat[11] = "";
	char chkbilgrp[11] = "";
	char tmpstr[301] = "";
	char chkstr[81] = "";

/* TEST */
	if (logfil) {
		fprintf(logfil,
	"send_udldk_prod:idx=%hd,ud=%ld-%ld,ind=%ld-%ld,var=%ld,spc=%hd,w=%hd\n",
			idx,
			uddato,
			udtid,
			inddato,
			indtid,
			varighed,
			spcnr,
			wflag);
		fprintf(logfil,"\t>%s<\n",ws_udldkgrptab[idx]);
	}
	sscanf(ws_udldkgrptab[idx],"%s %s %hd",
		chkbilkat,
		chkbilgrp,
		&chkfrgspg);
	if (logfil) {
		fprintf(logfil,"\tchkbilkat=%s,chkbilgrp=%s,chkfrgspg=%hd\n",
			chkbilkat,
			chkbilgrp,
			chkfrgspg);
		fflush(logfil);
	}

	reclow(r159, R159);
	r159->status = 2;
	r159->kontrakttype_kode = 3;
	strcpy(r159->bil_grp, chkbilgrp);
	r159->station_ud_nr = ws_station;
	r159->station_ind_nr = ws_tilstation;
/* forsikring */
	r159->forsikring_cdw = 1;
	if (ws_paiflag) {
		r159->forsikring_pai = 1;
	}
/* dato */
	r159->dato_ud = uddato;
	r159->forv_dato_ind = inddato;
/* tid */
	r159->tid_ud = udtid;
	r159->forv_tid_ind = indtid;

	funkretur = 1;

	reclow(r165, R165);
	f165_start(1, ISGTEQ);
	r165->spec_nr = spcnr;
	strcpy(r165->bil_grp,chkbilgrp);
	egeread(f165,ISEQUAL);
	if (f165_ukendt) {
		funkretur = 0;
	}
	if (r165->slet_mark>0) {
		funkretur = 0;
	}
	if (funkretur==0) {
/* TEST */
		if (logfil) {
			fprintf(logfil,
			"send_udldk_prod:RETURN funkretur=%hd\n",funkretur);
		}
		return(0);
	}
/*
	r159->total = 1000;
	r159->rate_spec_nr[0] = spcnr;
	strcpy(r159->rate_tekst[0],"UdlDkWeb");
*/
	rateidx = 0;
/* STYR SPEC */
	r165->tekst_1[20] = '\0';
	r159->rate_spec_nr[rateidx] = r165->spec_nr;
	r159->rate_station[rateidx] = r165->stat_nr;
	strcpy(r159->rate_gruppe[rateidx], r165->bil_grp);

	strcpy(r159->rate_tekst[rateidx], r165->tekst_1);
	r159->rate_pris[rateidx] = r165->pris;
	r159->rate_incl_km[rateidx] = r165->incl_km;
	r159->rate_ekstra_km[rateidx] = r165->ekstra_pr_km;
	r159->rate_enhed[rateidx] = r165->enhed;
	r159->rate_type[rateidx] = r165->type;
	r159->rate_cdw[rateidx] = r165->rate_cdw;
	r159->rate_pai[rateidx] = r165->rate_pai;
	strcpy(tmpstr, "0000000000");
	tmpstr[10] = '\0';
	for (wx1=0;wx1<=4;wx1++) {
		if (r165->incl_flag[wx1] > 0) {
			tmpstr[wx1] = 48+r165->incl_flag[wx1];
		} else {
			tmpstr[wx1] = '0';
		}
	}
	if (r165->incl_flag[7] > 0) {
		tmpstr[5] = 48+r165->incl_flag[7];
	} else {
		tmpstr[5] = '0';
	}
	if (r165->incl_flag[9] > 0) {
		tmpstr[6] = 48+r165->incl_flag[9];
	} else {
		tmpstr[6] = '0';
	}
	strcpy(r159->rate_incl_felt[rateidx], tmpstr);
	pjretur = 0;
	if (varighed<=UDLDKMAXFRGSPG) {
		pjretur = find_f198prisjust(spcnr,
			chkbilgrp,
			(short int)0,
			uddato,
			(int)varighed,
			&nypris,
			&nyenhed,
			&nyantal,
			&nycdidg,
			&nypaidg,
			&nyextkm,
			&nyinclkm);
	}
	if (pjretur>0) {
		r159->rate_pris[rateidx] = nypris;
		r159->rate_incl_km[rateidx] = nyinclkm;
		r159->rate_cdw[rateidx] = nycdidg;
		r159->rate_pai[rateidx] = nypaidg;
		r159->rate_enhed[rateidx] = nyenhed;
		r159->rate_antal[rateidx] = nyantal;
	}
/* TEST */
	sprintf(dum_str,
		"send_udldk_prod:pjretur=%hd",
		pjretur);
	logfil_put(dum_str);
	sprintf(dum_str,
		"send_udldk_prod:nypris=%.2lf,nyenhed=%hd,nyantal=%ld",
		nypris,
		nyenhed,
		nyantal);
	logfil_put(dum_str);

	if (rateidx==0) {
		r159->rate_ekstra_km[10] = r159->rate_ekstra_km[0];
		r159->rate_pris[10]     = r159->rate_ekstra_km[0];
		strcpy(r159->rate_incl_felt[10], r159->rate_incl_felt[0]);
		udregn_ratejustering(1,rateidx);
	}

/*
	r159->rate_antal[idx] = (long int)antal;
	if (type==1 && r159->rate_enhed[idx]==201) {
		r159->rate_antal[idx] *= var;
	}
*/
	udregn_incl();
	udregn_ekstra();
	opsaet_forsikring(idx);
	rateidx++;

/* LUFTHAVN AIRPORT 990 */
	extrastnr = 0;
	extraantal = 0;
	extraspecnr = 0;
	strcpy(extragrp,"");

	reclow(r198, R198);
	r198->oplkode = 16620;
	r198->keynum = ws_station;
	egeread(f198, ISEQUAL);
	if (f198_ok) {
		extraspecnr = (short int)r198->numfelt;
		extraantal = 1;
	}
	strcpy(extragrp,"ALLE");
	extrastnr = ws_station;
	funkretur = 0;
	ws_lufthavnsgebyr = 0;
	if (extraantal>0 && extraspecnr>0) {
		funkretur = add_prislinie(0,
			varighed,
			rateidx,
			extrastnr,
			extraspecnr,
			extragrp,
			extraantal,
			aftaleflag);
	}
	if (extraantal>0 && extraspecnr>0 && funkretur>0) {
		ws_lufthavnsgebyr = r159->rate_pris[rateidx];
/* MOMS LUFTHAVNSGEBYR AIRPORT */
		if (rate_incl(rateidx,3)==0) {
			ws_lufthavnsgebyr *= 1.25;
		}
		ws_lufthavnsgebyr *= (double)r159->rate_antal[rateidx];
		rateidx++;
	}
/* ONEWAY */
	extrastnr = 0;
	extraantal = 0;
	extraspecnr = 0;
	strcpy(extragrp,"");
	if (ws_station!=ws_tilstation) {
		extraspecnr = ONEWAYSPCNR;
		extraantal = 1;
		strcpy(extragrp,"ALLE");
		extrastnr = 0;
	}
	funkretur = 0;
	ws_onewaygebyr = 0;
	if (extraantal>0 && extraspecnr>0) {
		funkretur = add_prislinie(0,
			varighed,
			rateidx,
			extrastnr,
			extraspecnr,
			extragrp,
			extraantal,
			aftaleflag);
	}
	if (extraantal>0 && extraspecnr>0 && funkretur>0) {
		ws_onewaygebyr = r159->rate_pris[rateidx];
/* NYT 100306 MOMS ONEWAY */
		if (extraspecnr==920 &&
			rate_incl(rateidx,3)==0 &&
			rate_incl(rateidx,5)==1) {
			ws_onewaygebyr *= 1.25;
		}
		ws_onewaygebyr *= (double)r159->rate_antal[rateidx];
		rateidx++;
	}
/* TEST */
	sprintf(dum_str,
		"send_udldk_prod:rateidx=%hd chkbilgrp=%s",
		rateidx,
		chkbilgrp);
	logfil_put(dum_str);

/* CHECK RATELINIER */
	wx1 = 0;
	funkretur = 0;
	while (varighed<=UDLDKMAXFRGSPG && wx1<10) {
		if (r159->rate_spec_nr[wx1]>0 &&
			r159->rate_spec_nr[wx1]!=ONEWAYSPCNR &&
			r159->rate_pris[wx1]<=0) {
			funkretur++;
		}
		wx1++;
	}
	if (funkretur>0) {
		return(0);
	}

	r159->cdw_antal_dage = varighed;
	if (r159->cdw_antal_dage==0) {
		r159->cdw_antal_dage = 1;
	}
	r159->pai_antal_dage = varighed;
	if (r159->pai_antal_dage==0) {
		r159->pai_antal_dage = 1;
	}
	udregn_incl();
	udregn_kontrakt((short int)0,(short int)0,(long int)0,(long int)0);
	if (varighed>UDLDKMAXFRGSPG) {
		r159->total = 99999;
	}

/* TEST */
	sprintf(dum_str,
		"send_udldk_prod:total=%.2lf chkbilgrp=%s",
		r159->total,
		chkbilgrp);
	logfil_put(dum_str);


	alfalow(str);
	pack_init(str);
/* gruppe */
	strcpy(tmpstr,chkbilgrp);
	pack_alfa(tmpstr);
/* total */
	if (r159->total==99999) {
		strcpy(tmpstr,"Lejeperioden overstiger 60 dage.<br>Fortsæt til step 4 og modtag tilbud.");
		pack_alfa(tmpstr);
	} else {
		ege_w_dou1 = r159->total;
		if (logfil) {
			fprintf(logfil,"AFRUND0-1-FØR %.2lf\n",ege_w_dou1);
		}
		afrund0(ege_w_dou1);
		if (logfil) {
			fprintf(logfil,"AFRUND0-1-EFT %.2lf\n",ege_w_dou1);
		}
		pack_doub((double)ege_w_dou1);
/* RETTET 110510 UDLDKPERIODE
		pack_doub((double)r159->total);
*/
	}
/* incl km */
	pack_int2(99999);
/* extra pr km */
	pack_doub((double)0);
/* ud */
	sprintf(tmpstr,"%8.8ld-%4.4ld",
		uddato,
		udtid);
	pack_alfa(tmpstr);
/* ind */
	sprintf(tmpstr,"%8.8ld-%4.4ld",
		inddato,
		indtid);
	pack_alfa(tmpstr);
/* specnr */
	pack_int2((long)r159->rate_spec_nr[0]);
/* specnrtekst */
	sprintf(tmpstr, "%s", r159->rate_tekst[0]);
	pack_alfa(tmpstr);
/* leje + depositum */
	ege_w_dou1 = 0;
	ege_w_dou1 += r159->total;
/* NYT 110510 UDLDKPERIODE */
	if (logfil) {
		fprintf(logfil,"AFRUND0-2-FØR %.2lf\n",ege_w_dou1);
	}
	afrund0(ege_w_dou1);
	if (logfil) {
		fprintf(logfil,"AFRUND0-2-EFT %.2lf\n",ege_w_dou1);
	}
	pack_doub((double)ege_w_dou1);
/* lejedage */
	pack_int2((long)varighed);
/* ALTPRISID */
	sprintf(tmpstr,"UDLDK%2.2hd",idx);
	pack_alfa(tmpstr);
/* KREDITKORT */
	sprintf(tmpstr,
"Mastercard,Eurocard,Diners,Visa International (ikke Visa/DK),Amex,LIC Mastercard,Q8,Veko,Forbrugsforeningen,VisaElectron,Visa/Dankort,Dankort,Kontant");
	pack_alfa(tmpstr);
/* lejepris */
	ege_w_dou1 = 0;
	pack_doub((double)ege_w_dou1);
/* oneway */
	pack_doub((double)ws_onewaygebyr);
/* lufthavn */
	pack_doub((double)ws_lufthavnsgebyr);
/* link-forsikring */
	strcpy(chkstr,"http://www.europcar.dk");
	if (ws_testkreds) {
		strcpy(chkstr,"http://beta.europcar.dk");
	}
	sprintf(tmpstr,
	"<a title=\"Læs mere her\" href=\"%s%s\" target=\"_blank\">%s</a>",
			chkstr,
			"/default.aspx?id=19&purge=true",
			"selvrisikoforsikring");
	if (ws_paiflag>=1) {
		strcat(tmpstr,", <a title=\"Læs mere her\" href=\"");
		strcat(tmpstr,chkstr);
		strcat(tmpstr,"/default.aspx?id=19&purge=true");
		strcat(tmpstr,"\" target=\"_blank\">");
		strcat(tmpstr,"person- og tyveriforsikring</a>");
		strcat(tmpstr,"<BR>og moms.");
	} else {
		strcat(tmpstr," og moms.");
	}
	strcat(tmpstr,"<BR>Ekskl. brændstof");
	if (ws_paiflag>=1) {
		strcat(tmpstr,".");
	} else {
		strcat(tmpstr," og <a title=\"Læs mere her\" href=\"");
		strcat(tmpstr,chkstr);
		strcat(tmpstr,"/default.aspx?id=19&purge=true");
		strcat(tmpstr,"\" target=\"_blank\">");
		strcat(tmpstr,"person- og tyveriforsikring</a>.");
	}
	pack_alfa(tmpstr);
/* depositum */
	pack_doub((double)depositum);
/* bilkat */
	strcpy(tmpstr,"Default");
	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16822;
	sprintf(r198->keyalfa,"%s",chkbilkat);
	egeread(f198,ISEQUAL);
	if (f198_ok) {
		strcpy(tmpstr,r198->alfafelt);
	}
/* NYT 120503 TXBCFANER */
/*
	if (f198_ok && ws_udldkflag==2) {
		sprintf(tmpstr,"TX%s",r198->alfafelt);
	}
	if (f198_ok && ws_udldkflag==3) {
		sprintf(tmpstr,"BC%s",r198->alfafelt);
	}
*/

	pack_alfa(tmpstr);
/* billedfil FJERNET 090319
	sprintf(tmpstr,"defaultudldk.jpg");
	pack_alfa(tmpstr);
*/
/* modelkat. fx fiesta */
/* TEST */
	sprintf(dum_str,
		"send_udldk_prod:FX MODELKAT %s-%s",chkbilkat,chkbilgrp);
	logfil_put(dum_str);

	strcpy(tmpstr,"Fx.");
	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16824;
	sprintf(r198->keyalfa,"%s-%s",chkbilkat,chkbilgrp);
	egeread(f198,ISEQUAL);
	if (f198_ok) {
		strcpy(tmpstr,r198->alfafelt);
	}
/* NYT 090423 */
	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16828;
	strcpy(r198->keyalfa,chkbilgrp);
	egeread(f198,ISEQUAL);
	if (f198_ok) {
		strcpy(tmpstr,r198->alfafelt);
	}
/* TEST */
	sprintf(dum_str,
		"send_udldk_prod:FX MODELKAT tmpstr=%s",tmpstr);
	logfil_put(dum_str);

	pack_alfa(tmpstr);
/* modelopl. fx døre osv */
	strcpy(tmpstr,"");
	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16826;
	sprintf(r198->keyalfa,"*-%s",chkbilgrp);
	egeread(f198,ISEQUAL);
	if (f198_ok) {
		strcpy(tmpstr,r198->alfafelt);
	}
	pack_alfa(tmpstr);
/* forespørgsel antal timer */
/* RETTET 090327
	wx1 = 0;
	if (chkfrgspg>0) {
		wx1 = 1;
	}
	if (varighed>60) {
		wx1 = 1;
	}
	if (wx1>0) {
		pack_int2((long)24);
	} else {
		pack_int2((long)0);
	}
*/
	pack_int2((long)chkfrgspg);

	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}

	return(retur);
}

/* **************************************** */
static void ecweb_bsspris(short prisfunk) {
	short int wx1 = 0;
	short int antal = 0;
	short int bettype = 0;
	short int testflag = 0;
	short int prisstyr = 0;
	short int prisinit = 0;
	short int funkretur = 0;
	short int extraantal = 0;
	short int extraspecnr = 0;
	short int extrastnr = 0;
	short int extraidx = 0;
	char extragrp[5] = "";
	double depositum = 0;
	long int returdato = 0;
	long int julian = 0;
	long int indjulian = 0;
	long int uddato = 0;
	long int udtid = 0;
	long int inddato = 0;
	long int indtid = 0;
	long int rateinddato = 0;
	long int rateindtid = 0;
	long int ratevarighed = 0;
	long int varighed = 0;
	long int ratedage = 0;
	long int nyantal = 0;
	long int maxvarighed = 0;
	short int kombiflag = 0;
	short int aftaleflag = 0;
	short int uddagnr = 0;
	short int pristabidx = 1;
	short int pristabspc[5] = {0,0,0,0,0};
	short int pristabant[5] = {0,0,0,0,0};
	char biltype[21] = "";
	char matrixstr[41] = "";
	char defaultstr[41] = "";
	char altstr[41] = "";
	char alt2str[41] = "";
	char tmpstr[501] = "";
	char chkstr[41] = "";

/* TEST */
	sprintf(dum_str,
		"ecweb_bsspris:prisfunk=%hd",
		prisfunk);
        logfil_put(dum_str);
	sprintf(dum_str,
		"ecweb_bsspris:ws_grp=%s,ws_lang=%s",
		ws_grp,
		ws_langstr);
        logfil_put(dum_str);
	sprintf(dum_str,
		"ecweb_bsspris:dato/tid=%ld %ld - %ld %ld",
		ws_fradato,
		ws_fratid,
		ws_tildato,
		ws_tiltid);
        logfil_put(dum_str);
	sprintf(dum_str,
		"ecweb_bsspris:stud=%hd,stind=%hd",
		ws_station,
		ws_tilstation);
        logfil_put(dum_str);

	testflag = ws_testkreds;

	uddato = ws_fradato;
	inddato = ws_tildato;
	udtid = ws_fratid;
	indtid = ws_tiltid;
	julian = m036_funktion(12, uddato);
	varighed = (long int)(m036_funktion(12, inddato)-julian);
	returdato = m036_funktion(11, uddato);
	uddagnr = (short int)(returdato%10);
	if (indtid>800 && inddato>uddato) {
		varighed++;
	}
	if (inddato==uddato) {
		varighed++;
	}

	sprintf(dum_str,
		"ecweb_bsspris:varighed=%ld,uddagnr=%hd",
		varighed,
		uddagnr);
        logfil_put(dum_str);
	(void)ecweb_check_bilgrp(ws_grp,biltype);
	sprintf(dum_str,
		"ecweb_bsspris:biltype=%s",
		biltype);
        logfil_put(dum_str);
	(void)ecweb_check_biltype(ws_station,
		ws_grp,
		biltype,
		uddagnr,
		varighed,
		defaultstr,
		altstr,
		alt2str);
	sprintf(dum_str,
		"ecweb_bsspris:defaultstr=%s,altstr=%s,alt2str=%s",
		defaultstr,
		altstr,
		alt2str);
        logfil_put(dum_str);
	maxvarighed = 14;
	strcpy(tmpstr,"P7911EC");
        if (strcmp(biltype,"BUS")==0 &&
		retur_f198_def((long int)1002,"MaxBusPeriode=",tmpstr)>0) {
                sscanf(tmpstr,"%ld",&maxvarighed);
        }
        if (strcmp(biltype,"VARE")==0 &&
		retur_f198_def((long int)1002,"MaxVarePeriode=",tmpstr)>0) {
                sscanf(tmpstr,"%ld",&maxvarighed);
        }
        if (strcmp(biltype,"PERS")==0 &&
		retur_f198_def((long int)1002,"MaxPersPeriode=",tmpstr)>0) {
                sscanf(tmpstr,"%ld",&maxvarighed);
        }
	sprintf(dum_str,
		"ecweb_bsspris:maxvarighed=%ld",
		maxvarighed);
        logfil_put(dum_str);
	sprintf(dum_str,
		"ecweb_bsspris:ws_paiflag=%hd",
		ws_paiflag);
        logfil_put(dum_str);
/* NYT 110416 */
	funkretur = check_stopsalg(1,
		ws_station,ws_grp,ws_fradato,ws_tildato);
	sprintf(dum_str,
		"ecweb_bsspris:check_stopsalg funkretur=%hd",
		funkretur);
        logfil_put(dum_str);
	if (funkretur>0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-54);
		web_errormess(0,ws_langstr,"54");
		pack_exchkend();
		send_linie();
		return;
	}


/* CHECK VARIGHED OSV */
	if (varighed>maxvarighed) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-53);
		web_errormess(0,ws_langstr,"53");
		pack_exchkend();
		send_linie();
		return;
	}
/* NYT 060707 CHECK STUD IND */
	if (ws_station != ws_tilstation) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-53);
		web_errormess(0,ws_langstr,"53");
		pack_exchkend();
		send_linie();
		return;
	}


	prisinit = 1;
	prisstyr = -1;
	while (prisstyr<=1) {
		if (prisinit==1) {
			prisstyr++;
		}
		if (prisstyr>2) {
/* RETTET 081016
		if (prisstyr>1) {
*/
			break;
		}
		if (prisinit==1 && prisstyr==0) {
			strcpy(matrixstr,defaultstr);
		}
		if (prisinit==1 && prisstyr==1) {
			strcpy(matrixstr,altstr);
		}
		if (prisinit==1 && prisstyr==2) {
			strcpy(matrixstr,alt2str);
		}
		if (prisinit==1 && !strlen(matrixstr)) {
			continue;
		}
		if (prisinit==1) {
			pristabidx = 0;
		}
		sprintf(dum_str,
			"ecweb_bsspris:matrixstr=%s",
			matrixstr);
        	logfil_put(dum_str);

		while (prisinit==1 &&
			strlen(matrixstr) &&
			pristabidx>=0 && pristabidx<5) {
			(void)get_alfa_tgn(matrixstr,pristabidx,tmpstr,43);
			if (!strlen(tmpstr)) {
				break;
			}
			(void)get_alfa_tgn(tmpstr,0,chkstr,88);
			if (strlen(chkstr)) {
				sscanf(chkstr,"%hd",&pristabant[pristabidx]);
			}
			(void)get_alfa_tgn(tmpstr,1,chkstr,88);
			if (strlen(chkstr)) {
				sscanf(chkstr,"%hd",&pristabspc[pristabidx]);
			}
			pristabidx++;
		}
		if (prisinit==1) {
			prisinit = 0;
		}
		sprintf(dum_str,
			"ecweb_bsspris:prisstyr=%hd,pristabidx=%hd",
			prisstyr,
			pristabidx);
        	logfil_put(dum_str);
		wx1 = 0;
		while (wx1<pristabidx) {
			sprintf(dum_str,
				"ecweb_bsspris:pristab-%hd=%hd x %hd",
				wx1,
				pristabant[wx1],
				pristabspc[wx1]);
			logfil_put(dum_str);
			wx1++;
		}

		reclow(r159, R159);
		r159->status = 2;
		r159->kontrakttype_kode = 3;
		strcpy(r159->bil_grp, ws_grp);
		r159->station_ud_nr = ws_station;
		r159->station_ind_nr = ws_tilstation;
/* forsikring */
		r159->forsikring_cdw = 1;
		if (ws_paiflag) {
			r159->forsikring_pai = 1;
		}
/* dato */
		r159->dato_ud = uddato;
		r159->forv_dato_ind = inddato;
/* tid */
		r159->tid_ud = udtid;
		r159->forv_tid_ind = indtid;

	
		wx1 = 0;
		while (wx1<pristabidx) {
			funkretur = add_prislinie(0,
				(long)varighed,
				wx1,
				ws_station,
				pristabspc[wx1],
				ws_grp,
				pristabant[wx1],
				aftaleflag);
/* TEST */
			sprintf(dum_str,
				"ecweb_bsspris:wx1=%hd funkretur=%hd",
					wx1,
					funkretur);
			logfil_put(dum_str);

			wx1++;
		}
		extraidx = wx1;
/* LUFTHAVN AIRPORT */
		extrastnr = 0;
		extraantal = 0;
		extraspecnr = 0;
		strcpy(extragrp,"");

		reclow(r198, R198);
		r198->oplkode = 16620;
		r198->keynum = ws_station;
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			extraspecnr = (short int)r198->numfelt;
			extraantal = 1;
		}
		strcpy(extragrp,"ALLE");
		extrastnr = ws_station;
		funkretur = 0;
		ws_lufthavnsgebyr = 0;
		if (extraantal>0 && extraspecnr>0) {
			funkretur = add_prislinie(0,
				varighed,
				extraidx,
				extrastnr,
				extraspecnr,
				extragrp,
				extraantal,
				aftaleflag);
			ws_lufthavnsgebyr = r159->rate_pris[extraidx];
/* MOMS LUFTHAVNSGEBYR AIRPORT */
			if (rate_incl(extraidx,3)==0) {
				ws_lufthavnsgebyr *= 1.25;
			}
			ws_lufthavnsgebyr *= (double)r159->rate_antal[extraidx];
			extraidx++;
		}
/* ONEWAY */
		extrastnr = 0;
		extraantal = 0;
		extraspecnr = 0;
		strcpy(extragrp,"");
		if (ws_station!=ws_tilstation) {
/* RETTET 080408
			reclow(r198, R198);
			r198->oplkode = 16621;
			r198->keynum = ws_station;
			egeread(f198, ISEQUAL);
			if (f198_ok) {
				extraspecnr = (short int)r198->numfelt;
				extraantal = 1;
			}
*/
			extraspecnr = ONEWAYSPCNR;
			extraantal = 1;
			strcpy(extragrp,"ALLE");
			extrastnr = 0;
		}
		funkretur = 0;
		ws_onewaygebyr = 0;
		if (extraantal>0 && extraspecnr>0) {
			funkretur = add_prislinie(0,
				varighed,
				extraidx,
				extrastnr,
				extraspecnr,
				extragrp,
				extraantal,
				aftaleflag);
			ws_onewaygebyr = r159->rate_pris[extraidx];
/* NYT 100306 MOMS ONEWAYGEBYR */
			if (extraspecnr==920 &&
				rate_incl(extraidx,3)==0,
				rate_incl(extraidx,5)==1) {
				ws_onewaygebyr *= 1.25;
			}
			ws_onewaygebyr *= (double)r159->rate_antal[extraidx];
			extraidx++;
		}
/* NYT 100331 MILJØ BIDRAG 944 */
		strcpy(ws_mbidragtxt,"");
		ws_mbidrag = 0;
		funkretur = 0;
		if (ECMBIDRAG>0) {
			funkretur = adm_mbidrag(2,
				ECMBIDRAG,
				varighed,
				&ws_mbidrag);
		}
		if (ECMBIDRAG>0 && funkretur>0) {
			extraspecnr = ECMBIDRAG;
			extraantal = 1;
			strcpy(extragrp,"ALLE");
			extrastnr = 0;
			(void)add_prislinie(0,
				varighed,
				extraidx,
				extrastnr,
				extraspecnr,
				extragrp,
				extraantal,
				aftaleflag);
			r159->rate_pris[extraidx] = ws_mbidrag;
			r159->rate_antal[extraidx] = 1;
			udregn_incl();
			udregn_ekstra();
			opsaet_forsikring(extraidx);
		}
		if (ECMBIDRAG>0 && funkretur>0 && rate_incl(extraidx,3)==0) {
			ws_mbidrag *= 1.25;
		}
		if (ECMBIDRAG>0 && funkretur>0) {
			ws_mbidrag *= (double)r159->rate_antal[extraidx];
			strcpy(ws_mbidragtxt,r159->rate_tekst[extraidx]);
			ege_tolower((unsigned char *)ws_mbidragtxt);
			extraidx++;
		}
		if (logfil) {
			fprintf(logfil,
			"ecweb_bsspris:ECMBIDRAG=%hd funkretur=%hd %.2lf\n",
				(short int)ECMBIDRAG,
				funkretur,
				ws_mbidrag);
			fprintf(logfil,
				"\t%s\n",
				ws_mbidragtxt);
			fflush(logfil);
		}


/* CHECK RATELINIER */
		wx1 = 0;
		funkretur = 0;
		while (wx1<10) {
			if (r159->rate_spec_nr[wx1]>0 &&
				r159->rate_pris[wx1]<=0) {
				funkretur++;
			}
			wx1++;
		}
		if (funkretur>0) {
			prisinit = 1;
			continue;
		}
		if (r159->rate_ekstra_km[10]<=0) {
			prisinit = 1;
			continue;
		}
/* NYT 081017 */
/* WEEKEND MERSALG */
		rateinddato = inddato;
		rateindtid = indtid;
		ratevarighed = varighed;
		wx1 = 0;
		ratedage = 0;
		while (wx1<10) {
			funkretur = 0;
			if (r159->rate_spec_nr[wx1]>0 &&
				r159->rate_enhed[wx1]>200 &&
				r159->rate_enhed[wx1]<300) {
				funkretur = (short int)r159->rate_enhed[wx1];
				funkretur %= 200;
				funkretur *= (short int)r159->rate_antal[wx1];
				ratedage += (long int)funkretur;
			}
			wx1++;
		}
		sprintf(dum_str,
		"ecweb_bsspris:specnr-0=%hd,ratevarighed=%ld,varighed=%ld",
			r159->rate_spec_nr[0],
			ratedage,
			varighed);
		logfil_put(dum_str);
		indjulian = m036_funktion(12, inddato);
		funkretur = (short int)ratedage;
		funkretur -= (short int)varighed;
		if (funkretur>0) {
			ratevarighed = ratedage;
			indjulian += (long int)funkretur;
			rateinddato = m036_funktion(19, indjulian);
			r159->forv_dato_ind = rateinddato;
			rateindtid = 700;
			r159->forv_tid_ind = 700;
		}
		sprintf(dum_str,
		"ecweb_bsspris:funkretur=%hd,inddato=%ld,rateinddato=%ld",
			funkretur,
			inddato,
			rateinddato);
		logfil_put(dum_str);


		r159->cdw_antal_dage = ratevarighed;
		if (r159->cdw_antal_dage==0) {
			r159->cdw_antal_dage = 1;
		}
		r159->pai_antal_dage = ratevarighed;
		if (r159->pai_antal_dage==0) {
			r159->pai_antal_dage = 1;
		}
		udregn_incl();
		udregn_kontrakt((short int)0,
			(short int)0,
			(long int)0,
			(long int)0);

		sprintf(dum_str,
			"ecweb_bsspris:total=%.2lf",
			r159->total);
		logfil_put(dum_str);

		if (antal==0) {
			alfalow(str);
			pack_init(str);
			pack_alfa("HEADER");
		pack_alfa("Vi har følgende produkt");
/* RETTET 081016
		pack_alfa("Vi har følgende produkter");
*/
/* RETTET 070704
		pack_alfa("Følgende produkter er tilgængelige");
*/
			pack_exchkend();
			send_linie();
		}
		if (antal==1) {
			alfalow(str);
			pack_init(str);
			pack_alfa("ALTERNATIVE");
		pack_alfa("Vi har også alternativ(er) - check periode og km.");
/* RETTET 081016
		pack_alfa("Vi har også dette alternativ inkl. flere km.");
*/
			pack_exchkend();
			send_linie();
		}
/* 110826 KOMBIFORSIKRING */
		kombiflag = 0;
		if (ws_grp[0]>=49 && ws_grp[0]<=57) {
			kombiflag = 1;
		}
		alfalow(str);
		pack_init(str);
		pack_alfa(ws_grp);

		pack_doub(r159->total);
		pack_int2((long)r159->rate_incl_km[10]);
		pack_doub((double)r159->rate_ekstra_km[10]);

		sprintf(tmpstr,"%8.8ld-%4.4ld",
			uddato,
			udtid);
		pack_alfa(tmpstr);

		sprintf(tmpstr,"%8.8ld-%4.4ld",
			rateinddato,
			rateindtid);
/* RETTET 081017
		sprintf(tmpstr,"%8.8ld-%4.4ld",
			inddato,
			indtid);
*/
		pack_alfa(tmpstr);
		pack_int2((long)r159->rate_spec_nr[0]);
		sprintf(tmpstr, "%s", r159->rate_tekst[0]);
		pack_alfa(tmpstr);
/*
		julian = m036_funktion(12, inddato);
		nyantal = julian - m036_funktion(12, uddato);
		if (nyantal<=0) {
			nyantal = 1;
		}
*/
		ege_w_dou1 = 0;
/*
		udregn_depositum((int)nyantal,&depositum);
		ege_w_dou1 = depositum;
*/
		ege_w_dou1 += r159->total;

		pack_doub((double)ege_w_dou1);
		pack_int2((long)nyantal);
		pack_alfa("ALTPRISDATA");
/* KREDITKORT */
/* NYT 091203 */
		bettype = 1;
/* NYT 120418 GRPOVISADK */
		if (strcmp(ws_grp,"O")==0) { bettype = 0; }
		if (strcmp(ws_grp,"A")==0) { bettype = 0; }
		if (strcmp(ws_grp,"B")==0) { bettype = 0; }
		if (strcmp(ws_grp,"F")==0) { bettype = 0; }
		if (ws_grp[0]>=48 && ws_grp[0]<=57) {
			bettype = 0;
		}
		sprintf(tmpstr,
"Mastercard,Eurocard,Diners,Visa International (ikke Visa/DK),Amex,LIC Mastercard,Q8,Veko,Forbrugsforeningen,VisaElectron,Visa/Dankort,Dankort,Kontant");
		if (bettype==1) {
			sprintf(tmpstr,
"Mastercard,Eurocard,Diners,Visa International (ikke Visa/DK),Amex,LIC Mastercard");
		}
		pack_alfa(tmpstr);
/*
		ege_w_dou1 = totleje;
		ege_w_dou1 -= ws_onewaygebyr;
		ege_w_dou1 -= ws_lufthavnsgebyr;
*/
		ege_w_dou1 = 0;
		pack_doub((double)ege_w_dou1);
	
		pack_doub((double)ws_onewaygebyr);
		pack_doub((double)ws_lufthavnsgebyr);

		strcpy(chkstr,"http://www.europcar.dk");
		if (testflag) {
			strcpy(chkstr,"http://beta.europcar.dk");
		}
		sprintf(tmpstr,
	"<a title=\"Læs mere her\" href=\"%s%s\" target=\"_blank\">%s</a>",
			chkstr,
			"/default.aspx?id=19&purge=true",
			"selvrisikoforsikring");
/* NYT 110826 KOMBIFORSIKRING */
		if (kombiflag>0) {
			sprintf(tmpstr,
	"<a title=\"Læs mere her\" href=\"%s%s\" target=\"_blank\">%s</a>",
			chkstr,
			"/default.aspx?id=19&purge=true",
			"selvrisiko-");
		}
/* NYT 110826 KOMBIFORSIKRING */
		if (ws_paiflag>=1 && kombiflag>0) {
			strcat(tmpstr,", <a title=\"Læs mere her\" href=\"");
			strcat(tmpstr,chkstr);
			strcat(tmpstr,"/default.aspx?id=19&purge=true");
			strcat(tmpstr,"\" target=\"_blank\">");
			strcat(tmpstr," og tyveriforsikring");
			strcat(tmpstr,", kombineret person- og godsforsikring");
			strcat(tmpstr,"</a>");
			if (ws_mbidrag>0) {
				strcat(tmpstr,",");
			}
/* RETTET 110826 KOMBIFORSIKRIN
			strcat(tmpstr,"<BR>");
*/
			strcat(tmpstr," ");
/* NYT 100331 */
			if (ws_mbidrag>0) {
				strcat(tmpstr,ws_mbidragtxt);
				strcat(tmpstr," ");
			}
			strcat(tmpstr,"og moms.");
		}
		if (ws_paiflag>=1 && kombiflag<=0) {
			strcat(tmpstr,", <a title=\"Læs mere her\" href=\"");
			strcat(tmpstr,chkstr);
			strcat(tmpstr,"/default.aspx?id=19&purge=true");
			strcat(tmpstr,"\" target=\"_blank\">");
			strcat(tmpstr,"person- og tyveriforsikring</a>");
			if (ws_mbidrag>0) {
				strcat(tmpstr,",");
			}
			strcat(tmpstr,"<BR>");
/* NYT 100331 */
			if (ws_mbidrag>0) {
				strcat(tmpstr,ws_mbidragtxt);
				strcat(tmpstr," ");
			}
			strcat(tmpstr,"og moms.");
		}

		if (ws_paiflag<1) {
/* NYT 100331 */
			if (ws_mbidrag>0) {
				strcat(tmpstr,",");
				strcat(tmpstr,ws_mbidragtxt);
				strcat(tmpstr," ");
			}
			strcat(tmpstr," og moms.");
		}
		strcat(tmpstr,"<BR>Ekskl. brændstof");
		if (ws_paiflag>=1) {
			strcat(tmpstr,".");
		} else {
			strcat(tmpstr," og <a title=\"Læs mere her\" href=\"");
			strcat(tmpstr,chkstr);
			strcat(tmpstr,"/default.aspx?id=19&purge=true");
			strcat(tmpstr,"\" target=\"_blank\">");
			strcat(tmpstr,"person- og tyveriforsikring</a>.");
		}
/* NYT 110325 EKSKLDEP */
		if (strcmp(ws_booktype,"ECVLPRIS")==0) {
			strcat(tmpstr,"<BR>Ekskl. depositum.");
			strcat(tmpstr," Kontakt evt. udlejningskontoret for nærmere information.");
		}
		pack_alfa(tmpstr);
	
		pack_doub((double)depositum);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		prisinit = 1;
		antal++;
	}
	if (antal>0) {
		alfalow(str);
		pack_init(str);
		pack_alfa("FOOTER");
		pack_alfa("Tryk på 'Vælg' hvis du ønsker at reservere...");
		pack_exchkend();
		send_linie();
	}
	if (antal<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-52);
		web_errormess(0,ws_langstr,"52");
		pack_exchkend();
		send_linie();
	}
	return;
}

/* NYT 100331 fra p7502/p750208.c				*/
/* ************************************************************ */
int adm_mbidrag(short funk,short specnr,long var,double *returpris) {
	short int retur = 0;
	short int fundet = 0;
	long int rateantal = 0;
	short int specidx = -1;
	short int styrspecnr = -1;
	long int chkundnr = 0;
	double prisdag = 0;
	double prismax = 0;
	char chkgrp[11] = "";
	char styrgrp[11] = "";

	*returpris = 0;
	while (fundet<=9) {
		if (r164->rate_spec_nr[fundet]<=0) {
			fundet++;
			continue;
		}
		if (styrspecnr<0) {
			styrspecnr = r164->rate_spec_nr[fundet];
			strcpy(styrgrp,r164->rate_gruppe[fundet]);
		}
		if (specidx<0 && r164->rate_spec_nr[fundet]==specnr) {
			specidx = fundet;
		}
		fundet++;
	}
	if (logfil) {
		fprintf(logfil,"adm_mbidrag:funk=%hd specnr=%hd var=%ld\n",
			funk,specnr,var);
		fprintf(logfil,"\tstyr-spec=%hd -grp=%s\n",styrspecnr,styrgrp);
		fprintf(logfil,"\tspecidx=%hd\n",specidx);
		fprintf(logfil,"\tfundet=%hd\n",fundet);
		fflush(logfil);
	}

	if (!strlen(styrgrp)) {
/* SLET EVT 944 */
		if (specidx>=0) {
			nulstil_spec(specidx);
			return(1);
		}
		return(0);
	}
	fundet = 0;
	reclow(r198,R198);
	r198->oplkode = 16568;
	r198->keynum = (double)specnr;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		fundet = -1;
	}
	while (fundet>=0) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=16568) {
			break;
		}
		if (r198->keynum!=specnr) {
			break;
		}
		if (r198->numfelt!=1) {
			continue;
		}
		prisdag = 0;
		prismax = 0;
		(void)get_alfa_tgn(r198->alfafelt,3,chkgrp,59);
		if (strlen(chkgrp)) {
			sscanf(chkgrp,"%lf",&prisdag);
		}
		(void)get_alfa_tgn(r198->alfafelt,4,chkgrp,59);
		if (strlen(chkgrp)) {
			sscanf(chkgrp,"%lf",&prismax);
		}
		(void)get_alfa_tgn(r198->alfafelt,0,chkgrp,59);
		if (strcmp(styrgrp,chkgrp)==0) {
			fundet = 1;
			break;
		}
	}
	if (fundet<=0) {
/* SLET EVT 944 */
		if (specidx>=0) {
			nulstil_spec(specidx);
			return(1);
		}
		return(0);
	}
	reclow(r198,R198);
	r198->oplkode = 16568;
	r198->keynum = (double)specnr;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		fundet = -1;
	}
	while (fundet>0) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=16568) {
			break;
		}
		if (r198->keynum!=specnr) {
			break;
		}
		if (r198->numfelt<100) {
			continue;
		}
		chkundnr = -1;
		if (strlen(r198->alfafelt)) {
			sscanf(r198->alfafelt,"%ld",&chkundnr);
		}
		if (r198->numfelt==100 && r163->firmakundenr>0 &&
			r163->firmakundenr==chkundnr) {
			fundet = -1;
		}
		if (r198->numfelt==101 && styrspecnr>0 &&
			styrspecnr==chkundnr) {
			fundet = -1;
		}
		if (r198->numfelt==102 && r163->lejerkundenr>0 &&
			r163->lejerkundenr==chkundnr) {
			fundet = -1;
		}
	}

	if (fundet<0) {
/* SLET EVT 944 */
		if (specidx>=0) {
			nulstil_spec(specidx);
		}
		return(1);
	}
	rateantal = 0;
	if (r164->antal_maaneder>0) {
		rateantal += (r164->antal_maaneder * 30);
	}
	if (r164->antal_uger>0) {
		rateantal += (r164->antal_uger * 7);
	}
	if (r164->antal_dage>0) {
		rateantal += r164->antal_dage;
	}
	if (r164->antal_timer>0 && r164->antal_timer>=bss->id_opstart[8]) {
		rateantal++;
	}
	if (funk==2) {
		rateantal = var;
	}
/* NYT 110113 MILJODONWEEKEND */
/* TEST RETTET 110330
	if (funk==2 && styrspecnr==196) {
		rateantal++;
	}
*/
	prisdag *= rateantal;
	if (logfil) {
		fprintf(logfil,"adm_mbidrag:rateantal=%ld\n",rateantal);
		fprintf(logfil,"\tprisdag=%.2lf -max=%.2lf\n",
			prisdag,prismax);
		fflush(logfil);
	}
	if (prismax>0 && prisdag>prismax) {
		prisdag = prismax;
	}
	retur = 2;
	*returpris = prisdag;
/*
	if (funk==1 && specidx>=0) {
		r164->rate_antal[specidx] = 1;
		r164->rate_pris[specidx] = prisdag;
	}
	if (funk==1 && specidx<0) {
		specidx = rater_next_idxnr(1);
		if (hent_spec_nr_data(specnr,"ALLE",specidx)>0) {
			r164->rate_antal[specidx] = 1;
			r164->rate_pris[specidx] = prisdag;
		} else {
			retur = 0;
		}
	}
*/
	if (logfil) {
		fprintf(logfil,"adm_mbidrag:RETUR retur=%hd specidx=%hd\n",
			retur,specidx);
		fflush(logfil);
	}
	return(retur);
}


/* **************************************** */
static void ecweb_prisliste(short prisfunk) {
	int wx1 = 0;
	int wx2 = 0;
	int antal = 0;
	int idx = 0;
	int prioidx = 0;
	int varighed = 0;
	int fejlkode = 0;
	short int akkhlgfundet = 0;
	short int hlgaltspecnr = 0;
	short int sortpaiflg = 0;
	short int startf198 = 0;
	short int perprisflag = 0;
	short int pervarighed = 0;
	short int hlgvarighed = 0;
	short int stdprisflag = 0;
	short int exthlgspecnr = 0;
	short int hlgfundet = 0;
	short int hlgspecnr = 0;
	long int hlgminperiode = -1;
	long int hlgstartdato = 0;
	short int testflag = 0;
	short int lufthavnud = 0;
	short int nglindkast = 0;
	short int blokfundet = 0;
	short int funkretur = 0;
	short int nyopretur = 0;
	short int priospecnr = 0;
	short int webspecnr = 671;
	short int sortantal = 0;
	short int sortaltflag = 0;
	long int inclkm = 0;
	long int returdato = 0;
	long int julian = 0;
	long int indjulian = 0;
	long int uddato = 0;
	long int udtid = 0;
	long int inddato = 0;
	long int indtid = 0;
	short int udvslipflag = 0;
	long int minutslip = 0;
	long int minudslip = 0;
	long int minuddato = 0;
	long int minudtid = 0;
	long int minsalgdage = 0;
	long int maxperiode = 31;
	long int maxspcperiode = 0;
	long int kundeperiode = 0;
	long int kundeuddg = 0;
	long int kundeinddg = 0;
	double extkmpris = 1.75;
	long int  prisperiode = 0;
	short int prisextra = 0;
	short int prissmdgn = 0;
	short int prisdgvarighed = 0;
	short int prisafhfratid = 0;
	short int prisafltiltid = 0;
	short int pristill = 0;
	short int nyenhed;
	long int nyantal;
	long int nyinclkm;
	long int totinclkm;
	double totleje;
	double totextkm;
	double nypris;
	double nycdidg;
	double nypaidg;
	double nyextkm;
	double depositum = 3000;
	char tmpgrpliste[81] = "";
	char tmpferienavn[41] = "";
	char tmpdatointerval[41] = "";
	char prisdgstr[41] = "";
	char f198key[41] = "";
	char tmpstr[301] = "";
	char returstr[301] = "";
	char sortgrp[5] = "";
	char sortprod[21] = "";
	char sortbuffer[201] = "";
	char hlgnavn[11] = "";

/* TEST */
	sprintf(dum_str,
		"ecweb_prisliste:prisfunk=%hd",
		prisfunk);
        logfil_put(dum_str);
	sprintf(dum_str,
		"ecweb_prisliste:ws_grp=%s,ws_lang=%s",
		ws_grp,
		ws_langstr);
        logfil_put(dum_str);
	sprintf(dum_str,
		"ecweb_prisliste:dato/tid=%ld %ld - %ld %ld",
		ws_fradato,
		ws_fratid,
		ws_tildato,
		ws_tiltid);
        logfil_put(dum_str);

	if (strcmp(ws_menuid, "zt")==0) {
		testflag = 1;
	}
/* NYT 120427 ECDØGNPRISER */
	ws_dgnprisflag = 0;
	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16666;
	r198->keynum = (double)ws_station;
	egeread(f198,ISEQUAL);
        if (f198_ok && r198->numfelt>0) {
                ws_dgnprisflag = 1;
        }
        sprintf(dum_str, "\tws_dgnprisflag=%hd",
                ws_dgnprisflag);
        logfil_put(dum_str);

	strcpy(returstr,"P7911EC");
	if (retur_f198_def((long int)1002,"MaxPeriode=",returstr)>0) {
		sscanf(returstr,"%ld",&maxperiode);
	}
/* TEST */
	sprintf(dum_str,
		"ecweb_prisliste:maxperiode=%ld",
		maxperiode);
        logfil_put(dum_str);

	strcpy(returstr,"P7911EC");
	sprintf(tmpstr,"MinUdSlip=");
	if (retur_f198_def((long int)1002,tmpstr,returstr)>0) {
		sscanf(returstr,"%ld",&minudslip);
	}
	strcpy(returstr,"P7911EC");
	sprintf(tmpstr,"MinUdSlip%2.2hd=",ws_station);
	if (retur_f198_def((long int)1002,tmpstr,returstr)>0) {
		sscanf(returstr,"%ld",&minudslip);
	}
/* NYT 060925 */
	udvslipflag = check_udvstslip(ws_station,ws_fradato,ws_fratid);

/* TEST */
	sprintf(dum_str,
		"ecweb_prisliste:minudslip=%ld,systemtid=%ld,udvslipflag=%hd",
		minudslip,
		ws_systemtid,
		udvslipflag);
        logfil_put(dum_str);
	minutslip = 0;
	minuddato = ws_systemdato;
	minudtid = ws_systemtid;
	if (minudslip>0) {
		julian = m036_funktion(12, ws_systemdato);
		ege_w_int1 = ws_systemtid/100;
		ege_w_int1 += (minudslip/60);

		ege_w_int2 = ws_systemtid%100;
		ege_w_int2 += (minudslip%60);
		if (ege_w_int2>=60) {
			ege_w_int1++;
			ege_w_int2 -= 60;
		}
/* TEST
		sprintf(dum_str,
		"ecweb_prisliste:MINUDSLIP-1 julian=%ld timer=%ld min=%ld",
			julian,
			ege_w_int1,
			ege_w_int2);
        	logfil_put(dum_str);
*/
		julian += (ege_w_int1/24);
		minuddato = m036_funktion(19, julian);
		minudtid = ege_w_int1%24;
		minudtid *= 100;
		minudtid += ege_w_int2;
/* TEST */
		sprintf(dum_str,
		"ecweb_prisliste:MINUDSLIP-2 minuddato=%ld minudtid=%ld",
			minuddato,
			minudtid);
        	logfil_put(dum_str);
	}
	if (udvslipflag==0 && minudslip>0 &&
		ws_fradato<minuddato) {
		minutslip = 1;
	}
	if (udvslipflag==0 && minudslip>0 &&
		ws_fradato==minuddato && ws_fratid<minudtid) {
		minutslip = 1;
	}
	if (udvslipflag==0 && minudslip>0 &&
		minutslip>0) {
		fejlkode = 1000;
		fejlkode += (int)ws_station;
		fejlkode *= -1;
	}
	if (udvslipflag>0) {
		fejlkode = 1100;
		fejlkode += udvslipflag;
		fejlkode *= -1;
	}

#ifdef egetest
	if (minudslip>0 && ws_systemdato==ws_fradato) {
		ege_w_int1 = (ws_fratid/100) - (ws_systemtid/100);
		ege_w_int1 *= 60;
		if (ws_fradato%100==0 && ws_fratid>ws_systemtid) {
			ege_w_int1 += 60-(ws_systemtid%100);
		}
		if (ws_fradato%100==0 && ws_fratid<=ws_systemtid) {
			ege_w_int1 -= (ws_systemtid%100);
		}
		if (ws_fradato%100!=0) {
			ege_w_int1 += (ws_fratid%100)-(ws_systemtid%100);
		}
/* TEST */
		sprintf(dum_str,
		"ecweb_prisliste:ege_w_int1=%ld",
			ege_w_int1);
        	logfil_put(dum_str);
		minutslip = ege_w_int1;
	}
/* TEST */
	sprintf(dum_str,
		"ecweb_prisliste:minutslip=%ld",
		minutslip);
        logfil_put(dum_str);
	if (minudslip>0 && ws_systemdato==ws_fradato &&
		minutslip<minudslip) {
		fejlkode = 1000;
		fejlkode += (int)ws_station;
		fejlkode *= -1;
	}
#endif
	if (ws_fradato<=0) {
		fejlkode = -10;
	}
	if (ws_tildato<=0) {
		fejlkode = -11;
	}
	if (ws_fratid<=0) {
		fejlkode = -12;
	}
	if (ws_tiltid<=0) {
		fejlkode = -13;
	}
/* TEST */
	sprintf(dum_str,
		"ecweb_prisliste:fejlkode=%hd",
		fejlkode);
        logfil_put(dum_str);
	if (fejlkode!=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)fejlkode);
		sprintf(tmpstr,"%d",(fejlkode*-1));
		web_errormess(0,ws_langstr,tmpstr);
		pack_exchkend();
		send_linie();
		return;
	}
/* NYT 060119 */
	funkretur = check_bssaaben(-1,ws_station,ws_fradato,ws_fratid);
	if (funkretur<=0) {
		(void)check_bssaaben(-1,ws_station,ws_fradato,-1);
	}
/* TEST */
	sprintf(dum_str,
	"ecweb_prisliste:check_bssaaben UD %ld funkretur=%hd ws_alert_txt=%s",
		ws_fradato,
		funkretur,
		ws_alert_txt);
        logfil_put(dum_str);

	if (ws_fradato>0 && ws_tildato>0) {
		julian = m036_funktion(12, ws_tildato);
		kundeperiode = julian - m036_funktion(12,ws_fradato);
        }
        if (kundeperiode<=0) {
                kundeperiode = 1;
        }
	returdato = m036_funktion(11, ws_fradato);
	kundeuddg = (long int)(returdato%10);
	returdato = m036_funktion(11, ws_tildato);
	kundeinddg = (long int)(returdato%10);

/* TEST */
        sprintf(dum_str,
		"ecweb_prisliste:kundeperiode=%ld,kundeuddg=%ld,kundeinddg=%ld",
                kundeperiode,
		kundeuddg,
		kundeinddg);
        logfil_put(dum_str);
	if (kundeperiode>maxperiode) {
/* RETTET 060227
		fejlkode = -9;
*/
		fejlkode = 900;
		fejlkode += (int)ws_station;
		fejlkode *= -1;
	}
/* TEST */
	sprintf(dum_str,
		"ecweb_prisliste:fejlkode=%hd",
		fejlkode);
        logfil_put(dum_str);
	if (fejlkode!=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)fejlkode);
		sprintf(tmpstr,"%d",(fejlkode*-1));
		web_errormess(0,ws_langstr,tmpstr);
		pack_exchkend();
		send_linie();
		return;
	}
/* NYT 091016 CHECK MINLEJEPERIODE BRUGES IKKE */
/*
	minsalgdage = check_minsalg(1,16655,ws_station,ws_grp,ws_fradato,ws_tildato);
	sprintf(dum_str,
	"ecweb_prisliste:UD %ld minsalgdage=%ld %s",
		ws_tildato,
		minsalgdage,
		ws_differrormess);
        logfil_put(dum_str);
*/
/* NYT 110510 CHECK OWBLOK */
	funkretur = 0;
	if (ws_station!=ws_tilstation) {
		funkretur += check_owblok(1,
			ws_station,ws_grp,ws_fradato,ws_tildato);
		funkretur += check_owblok(1,
			ws_tilstation,ws_grp,ws_fradato,ws_tildato);
	}
	if (funkretur>0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-54);
		web_errormess(0,ws_langstr,"54");
		pack_exchkend();
		send_linie();
		return;
	}


/* NYT 061218 CHECK TOTAL STOPSALG */
	funkretur = check_stopsalg(1,0,ws_grp,ws_fradato,ws_tildato);
	if (funkretur>0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-54);
		web_errormess(0,ws_langstr,"54");
		pack_exchkend();
		send_linie();
		return;
	}
	funkretur = check_bssaaben(-1,ws_tilstation,ws_tildato,ws_tiltid);
	if (funkretur<=0) {
		(void)check_bssaaben(-1,ws_tilstation,ws_tildato,-1);
	}
/* TEST */
	sprintf(dum_str,
	"ecweb_prisliste:check_bssaaben IND %ld funkretur=%hd ws_alert_txt=%s",
		ws_tildato,
		funkretur,
		ws_alert_txt);
        logfil_put(dum_str);
/* NYT 110503 LUFTHAVNUDAABEN */
	lufthavnud = 0;
	reclow(r198, R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16620;
	r198->keynum = ws_station;
	egeread(f198, ISEQUAL);
	if (f198_ok) {
		lufthavnud = 1;
	}
/* TEST */
	sprintf(dum_str,
		"ecweb_prisliste:ws_station=%hd lufthavnud=%hd",
		ws_tilstation,
		lufthavnud);
        logfil_put(dum_str);

	nglindkast = 0;
	reclow(r198, R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16623;
	r198->keynum = ws_tilstation;
	egeread(f198, ISEQUAL);
	if (f198_ok) {
		nglindkast = (short int)r198->numfelt;
	}
/* TEST */
	sprintf(dum_str,
		"ecweb_prisliste:ws_tilstation=%hd nglindkast=%hd",
		ws_tilstation,
		nglindkast);
        logfil_put(dum_str);
	if (funkretur<=0 && nglindkast<=0) {
		fejlkode = -17;
	}

	exthlgspecnr = check_f198_hlg(1,0,
		ws_station,ws_grp,ws_fradato,ws_tildato);
/* NYT 081112 HLGTILBUD */
	exthlgspecnr = check_f198_hlghit(1,kundeperiode,
		ws_station,ws_grp,ws_fradato,ws_tildato,hlgnavn);
	if (logfil) {
		fprintf(logfil,
			"ecweb_prisliste:exthlgspecnr=%hd,hlgnavn=%s\n",
			exthlgspecnr,
			hlgnavn);
	}
/* NYT 081204 */
	if (exthlgspecnr>0 &&
		strlen(hlgnavn) && hlgnavn[0]=='X' && hlgnavn[1]=='X') {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-14);
		web_errormess(0,ws_langstr,"14");
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		return;
	}

/* NYT 060510 */
	if (exthlgspecnr>0) {
		funkretur=check_f198_hlgblok(1,exthlgspecnr,ws_station,ws_grp);
	}
	if (funkretur>0 && exthlgspecnr>0) {
		if (logfil) {
			fprintf(logfil,
			"ecweb_prisliste:16626FUNDET\n");
		}
		exthlgspecnr = 0;
	}
	blokfundet = 0;
	funkretur = check_minsalg(2,16625,(double)0,"",ws_fradato,ws_tildato);
/*
	funkretur = check_f198_dato(1,16625,(double)0,"",ws_fradato,ws_tildato);
*/
	if (funkretur>0) {
		if (logfil) {
			fprintf(logfil,
			"ecweb_prisliste:16625FUNDET\n");
			fprintf(logfil,
			"ecweb_prisliste:num=%.0lf,alfa=%s\n",
			r198->numfelt,
			r198->alfafelt);
			fprintf(logfil,
			"ecweb_prisliste:kundeperiode=%ld\n",
			kundeperiode);
		}
	}
	if (funkretur>0) {
		(void)get_alfa_tgn(r198->alfafelt,0,tmpgrpliste,';');
		(void)get_alfa_tgn(r198->alfafelt,1,tmpferienavn,';');
		(void)get_alfa_tgn(r198->alfafelt,2,tmpdatointerval,';');
	}
	if (funkretur>0 && strcmp(tmpgrpliste,"*")==0) {
		blokfundet = 1;
		hlgminperiode = (long int)r198->numfelt;
		hlgstartdato = r198->fradato;
	}
	if (funkretur>0 &&
		blokfundet==0 &&
		strlen(tmpgrpliste) &&
		check_alfa_str(1,tmpgrpliste,ws_grp,44)>0) {
		blokfundet = 1;
		hlgminperiode = (long int)r198->numfelt;
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,
			"ecweb_prisliste:blokfundet=%hd\n",blokfundet);
		fprintf(logfil,
			"ecweb_prisliste:tmpgrpliste=%s\n",tmpgrpliste);
		fprintf(logfil,
			"ecweb_prisliste:tmpferienavn=%s\n",tmpferienavn);
		fprintf(logfil,
			"ecweb_prisliste:tmpdatointerval=%s\n",tmpdatointerval);
		fprintf(logfil,
			"ecweb_prisliste:hlgminperiode=%ld\n",hlgminperiode);
		fprintf(logfil,
			"ecweb_prisliste:hlgstartdato=%ld\n",hlgstartdato);
	}
/* NYT 091029 JUL09 OBS */
	if (funkretur>0 &&
		blokfundet==1 &&
		kundeperiode>=hlgminperiode &&
		ws_fradato==hlgstartdato) {
		blokfundet = 0;
	}
/* NYT 091030 JUL09 OBS */
	if (funkretur>0 &&
		blokfundet==1 &&
		kundeperiode>=hlgminperiode) {
		blokfundet = 0;
	}
/* NYT 091016 */
	if (funkretur>0 &&
		blokfundet==1) {
		fejlkode = -28;
	}
/* RETTET 091016
	if (funkretur>0 &&
		blokfundet==1 &&
		r198->numfelt==0) {
		fejlkode = -28;
	}
	if (funkretur>0 &&
		blokfundet==1 &&
		r198->numfelt>0 &&
		kundeperiode<(long int)r198->numfelt) {
		fejlkode = -28;
	}
	if (funkretur>0 &&
		blokfundet==1 &&
		fejlkode==-28 &&
		ws_tildato==r198->fradato &&
		ws_tiltid<=800) {
		fejlkode = 0;
	}
*/
/* NYT 111115 ECAFLBLOK */
	strcpy(tmpstr,"");
	funkretur = check_ecdon_aflblok(1,
		(short int)0,
		ws_grp,
		ws_fradato,
		ws_tildato,
		tmpstr);
	if (funkretur>0 && !strlen(tmpstr)) {
		blokfundet = 1;
		strcpy(tmpferienavn,"ECAFLBLOK");
		fejlkode = -28;
	}
	if (funkretur>0 && strlen(tmpstr)) {
		blokfundet = 1;
		strcpy(tmpferienavn,tmpstr);
		fejlkode = -28;
	}
	if (funkretur>0 && strncmp(tmpstr,"PAAS",4)==0) {
		blokfundet = 1;
		strcpy(tmpferienavn,"påske");
		fejlkode = -14;
	}
	if (funkretur>0 && strcmp(tmpstr,"INFO2100")==0) {
		blokfundet = 1;
		strcpy(tmpferienavn,"hlg");
		fejlkode = -14;
	}
/* NYT 120308 */
	if (fejlkode==-28 &&
		hlgstartdato>=99999911 &&
		hlgstartdato<=99999918 &&
		blokfundet>0) {
		strcpy(tmpferienavn,"hlg");
		fejlkode = -14;
	}
/* TEST */
	sprintf(dum_str,
		"ecweb_prisliste:fejlkode=%hd tmpferienavn=%s",
		fejlkode,
		tmpferienavn);
        logfil_put(dum_str);
/* NYT 091016 */
	if (fejlkode==-28 && hlgstartdato>99999900 && hlgstartdato<99999999) {
		sprintf(tmpstr,"%s %4.4ld",tmpferienavn,ws_fradato/10000);
		ege_toupper((unsigned char *)tmpstr);
		sprintf(ws_differrormess,
"%s. Der kan ikke bookes enkelte dage i perioden. Kontakt derfor nærmeste udlejningssted på tlf.%s.",
			tmpstr,
			"7011 6699");
	}
/* NYT 111115 */
	if (fejlkode==-28 && strcmp(tmpferienavn,"ECAFLBLOK")==0) {
		sprintf(ws_differrormess,
"Det er ikke muligt at aflevere denne dag. Prøv venligst en anden afleveringsdag eller kontakt os på tlf.%s.",
			"7011 3355");
	}

/* NYT 060504 */
	hlgspecnr = 0;
	if (funkretur>0 &&
		blokfundet==1 &&
		fejlkode==-28) {
		hlgspecnr = check_f198_hlg(1,0,
			ws_station,ws_grp,ws_fradato,ws_tildato);
	}
	if (funkretur>0 &&
		blokfundet==1 &&
		fejlkode==-28 &&
		hlgspecnr>0 &&
		exthlgspecnr>0) {
		fejlkode = 0;
	}
	if (fejlkode==-28 && strncmp(tmpferienavn,"FEJL:",5)==0) {
		sscanf(tmpferienavn+5,"%hd",&fejlkode);
	}
/* NYT 110317 PAASKE 2011 */
	if (fejlkode==-28 && strcmp(tmpferienavn,"påske")==0) {
		fejlkode = -14;
	}
	if (fejlkode==-28 && strcmp(tmpferienavn,"st.bede")==0) {
		fejlkode = -14;
/* RETTET 110317
		fejlkode = -29;
*/
	}
	if (fejlkode==-28 && strcmp(tmpferienavn,"kr.him")==0) {
		fejlkode = -14;
/* RETTET 110317
		fejlkode = -30;
*/
	}
	if (fejlkode==-28 && strcmp(tmpferienavn,"pinse")==0) {
		fejlkode = -14;
/* RETTET 110317
		fejlkode = -31;
*/
	}
/* NYT 061026 */
	if (fejlkode==-28 && strcmp(tmpferienavn,"jul")==0) {
		fejlkode = -32;
	}
/* NYT 081112 HLGTILBUD */
	if (fejlkode==0 && exthlgspecnr>0 && strlen(hlgnavn)) {
		hlgspecnr = exthlgspecnr;
	}
/* NYT 091016 */
	if (fejlkode==-32 && strlen(tmpdatointerval)) {
		sprintf(ws_differrormess,
"Der kan ikke bookes enkelte dage i perioden %s. Kontakt derfor nærmeste udlejningssted på tlf.%s.",
			tmpdatointerval,
			"7011 6699");
	}

/* TEST */
	sprintf(dum_str,
		"ecweb_prisliste:fejlkode=%hd,hlgspecnr=%hd,exthlgspecnr=%hd",
		fejlkode,
		hlgspecnr,
		exthlgspecnr);
        logfil_put(dum_str);
	if (fejlkode!=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)fejlkode);
		sprintf(tmpstr,"%d",(fejlkode*-1));
		web_errormess(0,ws_langstr,tmpstr);
		pack_exchkend();
		send_linie();
		return;
	}
/* NYT 060811 CHECK STOPSALG */
	funkretur = check_stopsalg(1,ws_station,ws_grp,ws_fradato,ws_tildato);
	if (funkretur>0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-54);
		web_errormess(0,ws_langstr,"54");
		pack_exchkend();
		send_linie();
		return;
	}

	reclow(r165,R165);
	f165_start(1,ISGTEQ);
	prioidx = 1;
	stdprisflag = 1;
	if (hlgspecnr>0) {
		stdprisflag--;
	}
	while (prioidx>=1 && stdprisflag>=0) {
		sortaltflag = 0;
		priospecnr = 0;
/* TEST */
		sprintf(dum_str,
			"ecweb_prisliste:WHILE prioidx=%hd,stdprisflag=%hd",
			prioidx,
			stdprisflag);
		logfil_put(dum_str);
		if (stdprisflag==1) {
			strcpy(returstr,"P7911EC");
			sprintf(tmpstr,"PrioSpecnr%3.3d=",prioidx);
/* TEST */
			sprintf(dum_str, "ecweb_prisliste:%s+%s",
				returstr,
				tmpstr);
			logfil_put(dum_str);

			if (retur_f198_def((long int)1002,tmpstr,returstr)>0) {
				sscanf(returstr,"%hd",&priospecnr);
			} else {
				stdprisflag--;
				prioidx = 1;
				continue;
			}
/* TEST */
			sprintf(dum_str, "ecweb_prisliste:returstr=%s",
				returstr);
			logfil_put(dum_str);
		}
		if (stdprisflag==0) {
			if (prioidx>1) {
				break;
			}
			priospecnr = hlgspecnr;
			if (exthlgspecnr>0) {
				priospecnr = exthlgspecnr;
			}
		}
		if (stdprisflag<0) {
			break;
		}

		if (priospecnr<=0) {
			prioidx++;
			continue;
		}
/* TEST */
		sprintf(dum_str, "ecweb_prisliste:prioidx=%d,priospecnr=%hd",
			prioidx,
			priospecnr);
		logfil_put(dum_str);
		reclow(r165,R165);
		r165->spec_nr = priospecnr;
		strcpy(r165->bil_grp,ws_grp);
		egeread(f165,ISEQUAL);
		if (f165_ukendt) {
			prioidx++;
			continue;
		}
		prisextra = 0;
		prissmdgn = 0;
		prisdgvarighed = 0;
		prisafhfratid = 0;
		prisafltiltid = 0;
		strcpy(prisdgstr,"");
		pristill = 0;
		funkretur=find_r198(1,16503,(double)r165->spec_nr,"",0);
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisextra);
			}
			(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prissmdgn);
			}
			(void)get_alfa_tgn(r198->alfafelt,2,prisdgstr,';');
			(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisafhfratid);
			}
			(void)get_alfa_tgn(r198->alfafelt,5,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisafltiltid);
			}
			(void)get_alfa_tgn(r198->alfafelt,6,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisdgvarighed);
			}
		}
/* NYT 081204 WEEKEND HØRSHOLM */
		funkretur = check_f198_spcafhtid(1,
			r165->spec_nr,
			ws_station,
			ws_grp);
		if (funkretur>0) {
			prisafhfratid = funkretur;
		}
		funkretur = 0;
		sprintf(f198key, "%3.3hd%3.3hd%s",
			0,
			r165->spec_nr,
			"*");
		strcpy(r198->alfafelt,"");
		funkretur += find_r198(1,16527,(double)0,f198key,0);
		sprintf(f198key, "%3.3hd%3.3hd%s",
			ws_station,
			r165->spec_nr,
			"*");
		strcpy(r198->alfafelt,"");
		funkretur += find_r198(1,16527,(double)0,f198key,0);
		sprintf(f198key, "%3.3hd%3.3hd%s",
			ws_station,
			r165->spec_nr,
			r165->bil_grp);
		strcpy(r198->alfafelt,"");
		funkretur += find_r198(1,16527,(double)0,f198key,0);
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				strcpy(prisdgstr,tmpstr);
			}
			(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prissmdgn);
			}
			(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &pristill);
			}
		}
		funkretur = check_stdgstr((long int)r165->spec_nr,
                        (long int)ws_fradato,
                        (long int)kundeuddg,
                        prisdgstr);
		if (funkretur<=0) {
			prioidx++;
			continue;
		}
/* NYT 061128 JUL06 */
		strcpy(tmpstr,"");
		funkretur = check_f198_dato(1,
			16589,(double)r165->spec_nr,tmpstr,
			ws_fradato,ws_tildato);
		if (funkretur>0) {
			sprintf(dum_str,
			"ecweb_prisliste:datoblok 16589 fundet numfelt=%.0lf",
				r198->numfelt);
			logfil_put(dum_str);
		}
		if (funkretur>0 && hlgminperiode>0 &&
			kundeperiode<hlgminperiode) {
			sprintf(dum_str,
			"ecweb_prisliste:kundeperiode %ld < hlgminperiode %ld",
				kundeperiode,
				hlgminperiode);
			logfil_put(dum_str);
			prioidx++;
			continue;
		}
/* NYT 070415 */
		if (funkretur>0 && hlgminperiode<0) {
			sprintf(dum_str,
			"ecweb_prisliste:datoblok specnr %hd overspringes",
				r165->spec_nr);
			logfil_put(dum_str);
			prioidx++;
			continue;
		}
		
/* NYT 060116 */
		maxspcperiode = 0;
		strcpy(returstr,"P7911EC");
		sprintf(tmpstr,"Max%3.3hdPeriode=",r165->spec_nr);
		if (retur_f198_def((long int)1002,tmpstr,returstr)>0) {
			sscanf(returstr,"%ld",&maxspcperiode);
		}
/* TEST */
		sprintf(dum_str, "ecweb_prisliste:maxspcperiode=%ld",
			maxspcperiode);
		logfil_put(dum_str);
		if (kundeperiode>maxspcperiode) {
			prioidx++;
			continue;
		}
		ws_altfradato = ws_fradato;
		ws_altfratid = ws_fratid;
		ws_alttildato = 0;
		ws_alttiltid = 0;
		ws_altperiode = 0;
		julian = m036_funktion(12, ws_fradato);
		indjulian = m036_funktion(12, ws_tildato);
/* TEST */
		sprintf(dum_str,
			"ecweb_prisliste:r165 enhed=%hd julian=%ld",
			r165->enhed,
			julian);
		logfil_put(dum_str);
		if (r165->enhed==501 &&
/*
			kundeperiode<=3 &&
*/
			kundeuddg==5 &&
			ws_fratid<prisafhfratid) {
			sortaltflag = 1;
			ws_altfratid = prisafhfratid;
			julian += 3;
			ws_alttildato = m036_funktion(19, julian);
			ws_alttiltid = prisafltiltid;
/* NYT 061128 JUL06 */
			ws_altperiode = 3;
		}
		if (r165->enhed==501 &&
/*
			kundeperiode<=3 &&
*/
			kundeuddg==6) {
			sortaltflag = 1;
			ws_altfratid = prisafhfratid;
			julian -= 1;
			ws_altfradato = m036_funktion(19, julian);
			julian += 3;
			ws_alttildato = m036_funktion(19, julian);
			ws_alttiltid = prisafltiltid;
/* NYT 061128 JUL06 */
			ws_altperiode = 3;
		}
		if (r165->enhed==501 &&
/*
			kundeperiode<=3 &&
*/
			kundeuddg==7) {
			sortaltflag = 1;
			ws_altfratid = prisafhfratid;
			julian -= 2;
			ws_altfradato = m036_funktion(19, julian);
			julian += 3;
			ws_alttildato = m036_funktion(19, julian);
			ws_alttiltid = prisafltiltid;
/* NYT 061128 JUL06 */
			ws_altperiode = 3;
		}
		if (r165->enhed==501 &&
			kundeperiode<=3 &&
			kundeuddg>=5 && kundeuddg<=7 &&
			kundeinddg==5) {
			sortaltflag = 1;
			indjulian += 3;
			ws_alttildato = m036_funktion(19, indjulian);
			ws_alttiltid = prisafltiltid;
			indjulian -= 3;
			ws_altfradato = m036_funktion(19, indjulian);
			ws_altfratid = prisafhfratid;
/* NYT 061128 JUL06 */
			ws_altperiode = 3;
		}
		if (r165->enhed==501 &&
			kundeperiode<=3 &&
			kundeuddg>=5 && kundeuddg<=7 &&
			kundeinddg==6) {
			sortaltflag = 1;
			indjulian += 2;
			ws_alttildato = m036_funktion(19, indjulian);
			ws_alttiltid = prisafltiltid;
			indjulian -= 3;
			ws_altfradato = m036_funktion(19, indjulian);
			ws_altfratid = prisafhfratid;
/* NYT 061128 JUL06 */
			ws_altperiode = 3;
		}
		if (r165->enhed==501 &&
			kundeperiode<=3 &&
			kundeuddg>=5 && kundeuddg<=7 &&
			kundeinddg==7) {
			sortaltflag = 1;
			indjulian += 1;
			ws_alttildato = m036_funktion(19, indjulian);
			ws_alttiltid = prisafltiltid;
			indjulian -= 3;
			ws_altfradato = m036_funktion(19, indjulian);
			ws_altfratid = prisafhfratid;
/* NYT 061128 JUL06 */
			ws_altperiode = 3;
		}
/* NYT 120105 WEBWEEKEND4-6 */
		if (logfil) {
			fprintf(logfil,
	"\tWEBWEEKEND4-6 ws_grp=%s ws_altperiode=%ld kundeperiode=%ld\n",
				ws_grp,
				ws_altperiode,
				kundeperiode);
			fprintf(logfil,
			"\tWEBWEEKEND4-6 ws_altfradato=%ld ws_alttildato=%ld\n",
				ws_altfradato,
				ws_alttildato);
			fflush(logfil);
		}
		if (r165->spec_nr==672 &&
			r165->enhed==501 &&
			kundeperiode>ws_altperiode) {
			funkretur = check_perprisjust(r165->spec_nr,
				ws_station,
				ws_grp,
				ws_altfradato,
				kundeperiode);
		}
		if (r165->spec_nr==672 &&
			r165->enhed==501 &&
			kundeperiode>ws_altperiode &&
			funkretur>0) {
			ws_altperiode = kundeperiode;
			julian = m036_funktion(12, ws_altfradato);
			julian += ws_altperiode;
			ws_alttildato = m036_funktion(19, julian);
		}
		if (logfil) {
			fprintf(logfil,
			"\tWEBWEEKEND4-6 funkretur=%hd ws_altperiode=%ld\n",
				funkretur,
				ws_altperiode);
			fprintf(logfil,
			"\tWEBWEEKEND4-6 ws_altfradato=%ld ws_alttildato=%ld\n",
				ws_altfradato,
				ws_alttildato);
			fflush(logfil);
		}

/* NYT 060504 */
/* OBS 070207 CHECK FOR FAST PERIODE SKAL OPFINDES */
/* NYT SPECNR 070207 */
		if (stdprisflag==0 &&
			r165->spec_nr==679 &&
			check_f198_hlg(1,0,
			ws_station,ws_grp,ws_fradato,ws_tildato)>0) {
			julian = m036_funktion(12, ws_altfradato);
			indjulian = julian + 7;
			ws_alttildato = m036_funktion(19, indjulian);
			ws_alttiltid = prisafltiltid;
			sortaltflag = 1;
			ws_altperiode = 7;
		}

/* NYT 061128 JUL06
		if (stdprisflag==0 &&
			r165->spec_nr==673 &&
			check_f198_hlg(1,0,
			ws_station,ws_grp,ws_fradato,ws_tildato)>0) {
			ws_altfradato = r198->fradato;
			ws_altfratid = prisafhfratid;

			ws_alttildato = r198->tildato;
			ws_alttiltid = prisafltiltid;
			sortaltflag = 1;
			julian = m036_funktion(12, ws_altfradato);
			indjulian = m036_funktion(12, ws_alttildato);
			ws_altperiode = 0;
		}
*/
/* NYT 070308 PAASKE07 */
/* erstattes af check_f198_udvhlg
		if (stdprisflag==0 &&
			r165->spec_nr==673 &&
			check_f198_hlg(1,0,
			ws_station,ws_grp,ws_fradato,ws_tildato)>0) {
			hlgvarighed = 0;
			(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%hd",&hlgvarighed);
			}
			if (hlgvarighed>200 && hlgvarighed<300) {
				hlgvarighed -= 200;
			}
			ws_altfradato = ws_fradato;
			ws_altfratid = prisafhfratid;
			indjulian = julian + hlgvarighed;
			ws_alttildato = m036_funktion(19, indjulian);
			ws_alttiltid = prisafltiltid;
			sortaltflag = 1;
			ws_altperiode = hlgvarighed;
		}
*/
/* NYT 070314 PAASKE07 UDV */
		hlgfundet = 0;
		strcpy(ws_hlgtilbud,"");
		if (stdprisflag==0 &&
			r165->spec_nr==673) {
			hlgfundet = check_f198_udvhlg(0,
				r165->spec_nr,
				ws_station,
				ws_grp,
				ws_fradato,
				ws_tildato,
				tmpstr);
		}
/* NYT 081112 JUL08 HLGTILBUD */
		if (stdprisflag==0 &&
			r165->spec_nr==673 &&
			strlen(hlgnavn)) {
			hlgfundet = check_f198_hlgtilbud(0,hlgnavn,
				kundeperiode,
				ws_station,
				ws_grp,
				ws_fradato,
				ws_tildato,
				tmpstr);
			if (hlgfundet>0) {
				akkhlgfundet++;
			}
		}



/* TEST */
		sprintf(dum_str, "ecweb_prisliste:hlgfundet=%hd,tmpstr=%s",
			hlgfundet,
			tmpstr);
		logfil_put(dum_str);

		if (stdprisflag==0 &&
			r165->spec_nr==673 &&
			hlgfundet>0) {
			ws_altfratid = prisafhfratid;
			ws_alttiltid = prisafltiltid;
			sscanf(tmpstr,"%ld %ld %ld",
				&ws_altfradato,
				&ws_alttildato,
				&ws_altperiode);
			sortaltflag = 1;
		}
		if (stdprisflag==0 &&
			r165->spec_nr==673 &&
			hlgfundet>0 &&
			strlen(hlgnavn)) {
/*
			ws_altfratid = prisafhfratid;
			ws_alttiltid = prisafltiltid;
*/
			sscanf(tmpstr,"%ld %ld %ld %ld %ld %hd",
				&ws_altfradato,
				&ws_alttildato,
				&ws_altperiode,
				&ws_altfratid,
				&ws_alttiltid,
				&ws_altcdipaiflag);
			strcpy(ws_hlgtilbud,hlgnavn);
			sortaltflag = 1;
		}

		if (stdprisflag==0 &&
			r165->spec_nr==673 &&
			hlgfundet<=0) {
			prioidx++;
			continue;
		}

/* TEST */
		sprintf(dum_str, "ecweb_prisliste:ws_altfradato/tid=%ld/%ld",
			ws_altfradato,
			ws_altfratid);
		logfil_put(dum_str);
		sprintf(dum_str, "ecweb_prisliste:ws_alttildato/tid=%ld/%ld",
			ws_alttildato,
			ws_alttiltid);
		logfil_put(dum_str);
		sprintf(dum_str, "ecweb_prisliste:sortaltflag=%hd",
			sortaltflag);
		logfil_put(dum_str);
/* NYT 061128 JUL06 */
		sprintf(dum_str, "ecweb_prisliste:ws_altperiode=%ld",
			ws_altperiode);
		logfil_put(dum_str);
		if (sortaltflag>0 &&
			hlgminperiode>0 &&
			ws_altperiode>0 &&
			ws_altperiode<hlgminperiode) {
			prioidx++;
			continue;
		}
/* NYT 120427 ECDØGNPRISER */
		if (ws_dgnprisflag>0 && r165->spec_nr==672) {
			ws_altfratid = ws_fratid;
			ws_alttiltid = ws_tiltid;
		}
		sprintf(dum_str,
			"ecweb_prislisteDØGN:ws_altfradato/tid=%ld/%ld",
			ws_altfradato,
			ws_altfratid);
		logfil_put(dum_str);
		sprintf(dum_str,
			"ecweb_prislisteDØGN:ws_alttildato/tid=%ld/%ld",
			ws_alttildato,
			ws_alttiltid);
		logfil_put(dum_str);

/* NYT 070503 CHECK AABENTIDER */
		if (ws_altfradato>0 && ws_altfratid>0) {
			funkretur = check_bssaaben(-1,
				ws_station,
				ws_altfradato,
				ws_altfratid);
/* NYT 110503 LUFTHAVNUDAABEN */
			if (lufthavnud>0) {
				funkretur = 1;
			}
		}

/* TEST */
		sprintf(dum_str, "ecweb_prisliste:check_bssaaben funkretur=%hd",
			funkretur);
		logfil_put(dum_str);
		if (ws_altfradato>0 && ws_altfratid>0 && funkretur<=0) {
			prioidx++;
			continue;
		}

		reccpy(&w165,r165,R165);
/* NYT 060109 */
		ws_specnr = r165->spec_nr;
		ws_maxspcperiode = maxspcperiode;

		nyopretur = nyopret_reservation(0,0,1);
		if (nyopretur<=0) {
			prioidx++;
			continue;
		}
		reccpy(r165,&w165,R165);
		inddato = r159->forv_dato_ind;
		indtid = r159->forv_tid_ind;
		if (sortaltflag==0 && inddato!=ws_tildato) {
			inddato = ws_tildato;
		}
		if (sortaltflag==0 && indtid!=ws_tiltid) {
			indtid = ws_tiltid;
		}
		uddato = r159->dato_ud;
		udtid = r159->tid_ud;

		nyantal = kundeperiode;
		if (stdprisflag==0) {
/* OBS TEST */
			nyantal = 4;
		}
		if (sortantal==0) {
			egesort(1, "sort");
		}
		ege_w_dou1 = r159->total;
		totinclkm = r159->rate_incl_km[10];
		totextkm = r159->rate_ekstra_km[10];

		strcpy(sortgrp, r165->bil_grp);
                for (wx1=0;wx1<sizeof(sortgrp);wx1++)  {
                        if (sortgrp[wx1] == ' ') {
                                sortgrp[wx1] = '!';
                        }
                }
                if (!strlen(sortgrp)) {
                        strcpy(sortgrp, "!!!!");
		}
		sortpaiflg = 0;
		if (r159->rate_incl_felt[0][0]=='2') {
			sortpaiflg = 2;
		}

		strcpy(sortprod,"");
		if (strlen(ws_hlgtilbud)) {
			strcpy(sortprod, r159->rate_tekst[0]);
		}
                for (wx1=0;wx1<sizeof(sortprod);wx1++)  {
                        if (sortprod[wx1] == ' ') {
                                sortprod[wx1] = '!';
                        }
                }
                if (!strlen(sortprod)) {
                        strcpy(sortprod, "!!!!!!!!!!!!!!!!!!!!");
                }

		sprintf(sortbuffer,
"%1hd %7.2lf %3hd %3hd %-4s %5ld %5ld %5ld %5.2lf %8ld %4ld %8ld %4ld %7.2lf %7.2lf %7.2lf %1hd %-20s \n \0",
			sortaltflag,
			ege_w_dou1,
			r165->spec_nr,
			r165->stat_nr,
			sortgrp,
			prisperiode,
			nyantal,
			totinclkm,
			totextkm,
			uddato,
			udtid,
			inddato,
			indtid,
			ws_onewaygebyr,
			ws_lufthavnsgebyr,
			ws_nyopret_depos,
			sortpaiflg,
			sortprod);
		egesort(2, sortbuffer);
/* TEST */
		if (logfil) {
			fprintf(logfil,"ecweb_prisliste:sort=%s",sortbuffer);
		}
		sortantal++;
		prioidx++;
	}
/* NYT 091030 CHECK HLGALTERNATIVER TILBUD */
	if (logfil) {
		fprintf(logfil,
		"ecweb_prisliste:HLGALTERNATIVER akkhlgf=%hd\n",akkhlgfundet);
		fflush(logfil);
		fprintf(logfil,
		"ecweb_prisliste:HLGALTERNATIVER hlgf=%hd\n",hlgfundet);
		fflush(logfil);
	}
	if (akkhlgfundet<=0) {
		hlgfundet = 0;
		reclow(r198,R198);
		r198->oplkode = 16570;
		f198_start(1,ISGTEQ);
		if (f198_ukendt) {
			hlgfundet = -1;
		}
	}
	while (akkhlgfundet<=0 && hlgfundet>=0) {
		egeread(f198,ISNEXT);
		if (f198_eof) { break; }
		if (r198->oplkode>16570) { break; }
		if (r198->numfelt<=0) { continue; }
		if (ws_fradato<r198->fradato) { continue; }
		if (ws_fradato>r198->tildato) { continue; }
/* NYT 100312 */
		if (logfil) {
			fprintf(logfil,
			"ecweb_prisliste:HLGALTERNATIVER alfa=%s\n",
				r198->alfafelt);
			fflush(logfil);
		}

		wx1 = 0;
		wx2 = 0;
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		if (strlen(tmpstr)) { sscanf(tmpstr,"%hd",&wx1); }
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) { sscanf(tmpstr,"%hd",&wx2); }
		if (kundeperiode<wx1) { continue; }
		if (kundeperiode>wx2) { continue; }
		(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
		if (strlen(tmpstr)) { sscanf(tmpstr,"%ld",&ws_altfradato); }
		(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
		if (strlen(tmpstr)) { sscanf(tmpstr,"%ld",&ws_alttildato); }
		(void)get_alfa_tgn(r198->alfafelt,4,tmpstr,';');
		if (strlen(tmpstr)) { sscanf(tmpstr,"%ld",&ws_altfratid); }
		(void)get_alfa_tgn(r198->alfafelt,5,tmpstr,';');
		if (strlen(tmpstr)) { sscanf(tmpstr,"%ld",&ws_alttiltid); }
		(void)get_alfa_tgn(r198->alfafelt,6,tmpstr,';');
		if (strlen(tmpstr)) { sscanf(tmpstr,"%ld",&ws_altperiode); }
		strcpy(ws_hlgtilbud,r198->keyalfa);
		reccpy(&x198,r198,R198);
		hlgaltspecnr = check_f198_hlghit(1,ws_altperiode,
			ws_station,ws_grp,
			ws_altfradato,ws_alttildato,ws_hlgtilbud);
		if (logfil) {
			fprintf(logfil,
			"ecweb_prisliste:HLGALTERNATIVER hlgaltspecnr=%hd\n",
				hlgaltspecnr);
			fflush(logfil);
		}
		funkretur = check_f198_hlgtilbud(0,ws_hlgtilbud,
			ws_altperiode,
			ws_station,
			ws_grp,
			ws_altfradato,
			ws_alttildato,
			tmpstr);
		if (logfil) {
			fprintf(logfil,
			"ecweb_prisliste:HLGALTERNATIVER %s %hd\n",
				ws_hlgtilbud,
				funkretur);
			fprintf(logfil,
			"ecweb_prisliste:HLGALTERNATIVER %s\n",
				tmpstr);
			fflush(logfil);
			fprintf(logfil,
			"ecweb_prisliste:HLGALTERNATIVER hlgaltspecnr=%hd\n",
				hlgaltspecnr);
			fflush(logfil);
		}
		sortaltflag = 1;
		ws_specnr = hlgaltspecnr;
		reclow(r165,R165);
		f165_start(1,ISGTEQ);
		r165->spec_nr = ws_specnr;
		r165->stat_nr = 0;
		strcpy(r165->bil_grp,ws_grp);
		egeread(f165,ISEQUAL);

		reccpy(&w165,r165,R165);
		nyopretur = nyopret_reservation(0,0,1);

		if (nyopretur<=0) {
			reccpy(r198,&x198,R198);
			f198_start(1, ISGREAT);
			if (f198_ukendt) {
				break;
			}
			continue;
		}
		reccpy(r165,&w165,R165);
		inddato = r159->forv_dato_ind;
		indtid = r159->forv_tid_ind;
		uddato = r159->dato_ud;
		udtid = r159->tid_ud;

		nyantal = ws_altperiode;
		if (sortantal==0) {
			egesort(1, "sort");
		}
		ege_w_dou1 = r159->total;
		totinclkm = r159->rate_incl_km[10];
		totextkm = r159->rate_ekstra_km[10];

		strcpy(sortgrp, ws_grp);
                for (wx1=0;wx1<sizeof(sortgrp);wx1++)  {
                        if (sortgrp[wx1] == ' ') {
                                sortgrp[wx1] = '!';
                        }
                }
                if (!strlen(sortgrp)) {
                        strcpy(sortgrp, "!!!!");
                }
		sortpaiflg = 0;
		strcpy(sortprod, r159->rate_tekst[0]);
                for (wx1=0;wx1<sizeof(sortprod);wx1++)  {
                        if (sortprod[wx1] == ' ') {
                                sortprod[wx1] = '!';
                        }
                }
                if (!strlen(sortprod)) {
                        strcpy(sortprod, "!!!!!!!!!!!!!!!!!!!!");
                }
		sprintf(sortbuffer,
"%1hd %7.2lf %3hd %3hd %-4s %5ld %5ld %5ld %5.2lf %8ld %4ld %8ld %4ld %7.2lf %7.2lf %7.2lf %1hd %-20s \n \0",
			sortaltflag,
			ege_w_dou1,
			r165->spec_nr,
			r165->stat_nr,
			sortgrp,
			prisperiode,
			nyantal,
			totinclkm,
			totextkm,
			uddato,
			udtid,
			inddato,
			indtid,
			ws_onewaygebyr,
			ws_lufthavnsgebyr,
			ws_nyopret_depos,
			sortpaiflg,
			sortprod);
		egesort(2, sortbuffer);
/* TEST */
		if (logfil) {
			fprintf(logfil,
				"ecweb_prisliste:hlgalt sort=%s",sortbuffer);
		}
		sortantal++;
		reccpy(r198,&x198,R198);
		f198_start(1, ISGREAT);
		if (f198_ukendt) {
			break;
		}
	}
	if (logfil) {
		fprintf(logfil,
			"ecweb_prisliste:akkhlgfundet=%hd,hlgaltspecnr=%hd\n",
			akkhlgfundet,
			hlgaltspecnr);
		fprintf(logfil,
			"ecweb_prisliste:altdato+tid=%ld-%ld %ld-%ld\n",
			ws_altfradato,
			ws_alttildato,
			ws_altfratid,
			ws_alttiltid);
		fflush(logfil);
	}

/* CHECK PERIODE TILBUD */
	perprisflag = 0;
	reclow(r198,R198);
	f198_start(1, ISGTEQ);
	r198->oplkode = 16629;
	r198->keynum = (double)ws_station;
	egeread(f198, ISEQUAL);
	if (f198_ukendt) {
		perprisflag = -1;
	}
	if (f198_ok && r198->numfelt <=0) {
		perprisflag = -1;
	}
	if (perprisflag==0) {
		reclow(r198,R198);
		r198->oplkode = 16581;
		r198->keynum = 674;
		f198_start(1, ISGTEQ);
		if (f198_ukendt) {
			perprisflag = -1;
		}
	}
	sprintf(dum_str,
		"ecweb_prisliste:SOMMER perprisflag=%hd,kundeperiode=%ld",
		perprisflag,
		kundeperiode);
	logfil_put(dum_str);
	startf198 = 0;
	while (perprisflag>=0) {
		if (startf198==1) {
			reccpy(r198, &q198, R198);
			f198_start(1, ISGREAT);
			if (f198_ukendt) {
				break;
			}
			startf198 = 0;
		}
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=16581) {
			break;
		}
		if (r198->keynum>678) {
			break;
		}
		strcpy(sortgrp,r198->keyalfa+5);
		if (strcmp(sortgrp,ws_grp)!=0) {
			continue;
		}

		strcpy(returstr,"");
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		funkretur = 1;
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&funkretur);
		}
		if (kundeperiode<funkretur) {
			continue;
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		funkretur =  999;
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&funkretur);
		}
		if (kundeperiode>funkretur) {
			continue;
		}
		funkretur = 0;
		if (r198->fradato<=ws_fradato &&
			r198->tildato>=ws_fradato &&
			r198->fradato<=ws_tildato &&
			r198->tildato>=ws_tildato) {
			funkretur = (short int)r198->keynum;
			(void)get_alfa_tgn(r198->alfafelt,8,tmpferienavn,';');
		}
/* EVT NYT 110527 SOMMER11
 		if (ws_fradato>r198->tildato) { funkretur = 0; }
 		if (ws_fradato<r198->fradato) { funkretur = 0; }
*/
/* TEST 110527 */
		sprintf(dum_str,
	"\tSOMMER funkretur=%hd 198-fra-til=%ld-%ld kunde-fra-til=%ld-%ld",
			funkretur,
			r198->fradato,
			r198->tildato,
			ws_fradato,
			ws_tildato);
		logfil_put(dum_str);
		if (funkretur<=0) {
			continue;
		}
		pervarighed = 201;
		(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&pervarighed);
		}
		if (pervarighed>200 && pervarighed<300) {
			pervarighed -= 200;
		}
		if (pervarighed==301) {
			pervarighed = 7;
		}
		if (pervarighed==401) {
			pervarighed = 30;
		}
		if (pervarighed==501) {
			pervarighed = 3;
		}
		reccpy(&q198, r198, R198);

		sprintf(dum_str, "ecweb_prisliste:SOMMER funkretur=%hd,%s,%hd dage",
			funkretur,
			tmpferienavn,
			pervarighed);
		logfil_put(dum_str);
		reclow(r165,R165);
		r165->spec_nr = (short int)q198.keynum;
		strcpy(r165->bil_grp,ws_grp);
		egeread(f165,ISEQUAL);
		if (f165_ukendt) {
			continue;
		}
		prisextra = 0;
		prissmdgn = 0;
		prisdgvarighed = 0;
		prisafhfratid = 0;
		prisafltiltid = 0;
		strcpy(prisdgstr,"");
		pristill = 0;
		funkretur=find_r198(1,16503,(double)r165->spec_nr,"",0);
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisextra);
			}
			(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prissmdgn);
			}
			(void)get_alfa_tgn(r198->alfafelt,2,prisdgstr,';');
			(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisafhfratid);
			}
			(void)get_alfa_tgn(r198->alfafelt,5,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisafltiltid);
			}
			(void)get_alfa_tgn(r198->alfafelt,6,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisdgvarighed);
			}
		}
		funkretur = 0;
		sprintf(f198key, "%3.3hd%3.3hd%s",
			0,
			r165->spec_nr,
			"*");
		strcpy(r198->alfafelt,"");
		funkretur += find_r198(1,16527,(double)0,f198key,0);
		sprintf(f198key, "%3.3hd%3.3hd%s",
			ws_station,
			r165->spec_nr,
			"*");
		strcpy(r198->alfafelt,"");
		funkretur += find_r198(1,16527,(double)0,f198key,0);
		sprintf(f198key, "%3.3hd%3.3hd%s",
			ws_station,
			r165->spec_nr,
			r165->bil_grp);
		strcpy(r198->alfafelt,"");
		funkretur += find_r198(1,16527,(double)0,f198key,0);
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				strcpy(prisdgstr,tmpstr);
			}
			(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prissmdgn);
			}
			(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &pristill);
			}
		}
		funkretur = check_stdgstr((long int)r165->spec_nr,
                        (long int)ws_fradato,
                        (long int)kundeuddg,
                        prisdgstr);
		if (funkretur<=0) {
			startf198 = 1;
			continue;
		}
		ws_altfradato = ws_fradato;
		ws_altfratid = ws_fratid;
		julian = m036_funktion(12, ws_fradato);
		indjulian = julian + (long int)pervarighed;
		ws_alttildato = m036_funktion(19, indjulian);
		ws_alttiltid = prisafltiltid;
/* NYT 110808 SOMMERAFLTID */
		if (r165->spec_nr==674 && ws_tiltid!=prisafltiltid) {
			ws_alttiltid = 0;
		}
		if (r165->spec_nr==675 && ws_tiltid!=prisafltiltid) {
			ws_alttiltid = 0;
		}
		if (r165->spec_nr==676 && ws_tiltid!=prisafltiltid) {
			ws_alttiltid = 0;
		}
		if (r165->spec_nr==677 && ws_tiltid!=prisafltiltid) {
			ws_alttiltid = 0;
		}
		if (r165->spec_nr==678 && ws_tiltid!=prisafltiltid) {
			ws_alttiltid = 0;
		}

		sortaltflag = 1;

		reccpy(&w165,r165,R165);
/* NYT 060109 */
		ws_specnr = r165->spec_nr;

		nyopretur = nyopret_reservation(0,0,1);
		if (nyopretur<=0) {
			startf198 = 1;
			continue;
		}
		reccpy(r165,&w165,R165);
		inddato = r159->forv_dato_ind;
		indtid = r159->forv_tid_ind;
		if (sortaltflag==0 && inddato!=ws_tildato) {
			inddato = ws_tildato;
		}
		if (sortaltflag==0 && indtid!=ws_tiltid) {
			indtid = ws_tiltid;
		}
		uddato = r159->dato_ud;
		udtid = r159->tid_ud;

		nyantal = kundeperiode;
		if (sortantal==0) {
			egesort(1, "sort");
		}
		ege_w_dou1 = r159->total;
		totinclkm = r159->rate_incl_km[10];
		totextkm = r159->rate_ekstra_km[10];

		strcpy(sortgrp, r165->bil_grp);
                for (wx1=0;wx1<sizeof(sortgrp);wx1++)  {
                        if (sortgrp[wx1] == ' ') {
                                sortgrp[wx1] = '!';
                        }
                }
                if (!strlen(sortgrp)) {
                        strcpy(sortgrp, "!!!!");
                }
		sortpaiflg = 0;
		strcpy(sortprod,"");
		if (strlen(ws_hlgtilbud)) {
			strcpy(sortprod, r159->rate_tekst[0]);
		}
                for (wx1=0;wx1<sizeof(sortprod);wx1++)  {
                        if (sortprod[wx1] == ' ') {
                                sortprod[wx1] = '!';
                        }
                }
                if (!strlen(sortprod)) {
                        strcpy(sortprod, "!!!!!!!!!!!!!!!!!!!!");
                }

		sprintf(sortbuffer,
"%1hd %7.2lf %3hd %3hd %-4s %5ld %5ld %5ld %5.2lf %8ld %4ld %8ld %4ld %7.2lf %7.2lf %7.2lf %1hd %-20s \n \0",
			sortaltflag,
			ege_w_dou1,
			r165->spec_nr,
			r165->stat_nr,
			sortgrp,
			prisperiode,
			nyantal,
			totinclkm,
			totextkm,
			uddato,
			udtid,
			inddato,
			indtid,
			ws_onewaygebyr,
			ws_lufthavnsgebyr,
			ws_nyopret_depos,
			sortpaiflg,
			sortprod);
		egesort(2, sortbuffer);
/* TEST */
		if (logfil) {
			fprintf(logfil,
				"ecweb_prisliste:SOMMER sort=%s",sortbuffer);
		}
		sortantal++;
		perprisflag++;
		startf198 = 1;
	}

	if (sortantal>0) {
		egesort(3, "sort");
	}
	while (sortantal>0) {
		if (egesort(4, sortbuffer)<=0) {
			break;
		}
		reclow(r165,R165);
		sscanf(sortbuffer,
	"%hd %lf %hd %hd %s %ld %ld %ld %lf %ld %ld %ld %ld %lf %lf %lf %hd %s",
			&sortaltflag,
			&totleje,
			&r165->spec_nr,
			&r165->stat_nr,
			sortgrp,
			&prisperiode,
			&nyantal,
			&totinclkm,
			&totextkm,
			&uddato,
			&udtid,
			&inddato,
			&indtid,
			&ws_onewaygebyr,
			&ws_lufthavnsgebyr,
			&ws_nyopret_depos,
			&sortpaiflg,
			sortprod);
		for (wx1=0;wx1<sizeof(sortgrp);wx1++)  {
                        if (sortgrp[wx1] == '!') {
                                sortgrp[wx1] = ' ';
                        }
                }
		egechartest((unsigned char*)sortgrp);
		for (wx1=0;wx1<sizeof(sortprod);wx1++)  {
                        if (sortprod[wx1] == '!') {
                                sortprod[wx1] = ' ';
                        }
                }
		egechartest((unsigned char*)sortprod);
/* NYT 060502 */
/*
		if (antal==0) {
			alfalow(str);
			pack_init(str);
			pack_alfa("HEADER");
			pack_alfa("Herunder ser du dine valgmuligheder");
			pack_exchkend();
			send_linie();
			if (logfil) {
				fprintf(logfil, "SENDT:str=%s", str);
				fflush(logfil);
			}
		}
*/
/* NYT 070320 */
		if (ws_headeridx>0 && antal==0) {
			alfalow(str);
			pack_init(str);
			pack_alfa("HEADER");
			sprintf(tmpstr,"%s",ws_headertab[ws_headeridx]);
			pack_alfa(tmpstr);
			pack_exchkend();
			send_linie();
			if (logfil) {
				fprintf(logfil, "SENDT:str=%s", str);
				fflush(logfil);
			}
		}
                egechartest((unsigned char *)sortgrp);
		strcpy(r165->bil_grp,sortgrp);
		egeread(f165,ISEQUAL);
		if (f165_ukendt) {
			continue;
		}
		alfalow(str);
		pack_init(str);
		pack_alfa(r165->bil_grp);
		pack_doub(totleje);
		pack_int2((long)totinclkm);
		pack_doub((double)totextkm);

		sprintf(tmpstr,"%8.8ld-%4.4ld",
			uddato,
			udtid);
		pack_alfa(tmpstr);

		sprintf(tmpstr,"%8.8ld-%4.4ld",
			inddato,
			indtid);
		pack_alfa(tmpstr);
		pack_int2((long)r165->spec_nr);
		sprintf(tmpstr, "%s", r165->tekst_1);
/* NYT 060505 */
		if (check_f198_hlg(1,r165->spec_nr,ws_station,ws_grp,ws_fradato,ws_tildato)>0) {
			(void)get_alfa_tgn(r198->alfafelt,8,tmpstr,';');
		}
		if (strlen(sortprod)) {
			strcpy(tmpstr,sortprod);
		}
		if (strcmp(ws_langstr,"DA")!=0) {
			sprintf(f198key, "%5.5ld%5.5hd",
				(long int)16501,r165->spec_nr);
			trans_tekst(ws_langstr,0,f198key,tmpstr);
		}
		pack_alfa(tmpstr);
		julian = m036_funktion(12, inddato);
		nyantal = julian - m036_funktion(12, uddato);
		if (nyantal<=0) {
			nyantal = 1;
		}
/* NYT 061214 */
		depositum = ws_nyopret_depos;
/*
		udregn_depositum((int)nyantal,&depositum);
*/
/* TEST */
		sprintf(dum_str,
		"ecweb_prisliste:depositum=%.2lf,nyantal=%ld,totleje=%.2lf",
			depositum,
			nyantal,
			totleje);
		logfil_put(dum_str);
		ege_w_dou1 = depositum;
		ege_w_dou1 += totleje;

		pack_doub((double)ege_w_dou1);
		pack_int2((long)nyantal);
		pack_alfa("ALTPRISDATA");
/* NYT 101103 KREDITKORTLISTE */
		dan_kredkort_liste(1,ege_w_dou1,sortgrp,tmpstr);
		pack_alfa(tmpstr);
		ege_w_dou1 = totleje;
		ege_w_dou1 -= ws_onewaygebyr;
		ege_w_dou1 -= ws_lufthavnsgebyr;
		pack_doub((double)ege_w_dou1);
		pack_doub((double)ws_onewaygebyr);
		pack_doub((double)ws_lufthavnsgebyr);
/* NYT 060210 */
		strcpy(returstr,"http://www.europcar.dk");
		if (testflag) {
			strcpy(returstr,"http://beta.europcar.dk");
		}
/* NYT 100625 */
		strcpy(dum_str,"forsikring (selvrisiko kr. 2000)");
		if (r165->spec_nr==674) { strcpy(dum_str,"forsikringer"); };
		if (r165->spec_nr==675) { strcpy(dum_str,"forsikringer"); };
		if (r165->spec_nr==676) { strcpy(dum_str,"forsikringer"); };
		if (r165->spec_nr==677) { strcpy(dum_str,"forsikringer"); };
		if (r165->spec_nr==678) { strcpy(dum_str,"forsikringer"); };

		sprintf(tmpstr,
	"<a title=\"Læs mere her\" href=\"%s%s\" target=\"_blank\">%s</a>",
			returstr,
			"/default.aspx?id=559&purge=true",
			dum_str);
/* RETTET 100625
			"forsikring (selvrisiko kr. 2000)");
*/
/* RETTET 090217 HB CS
			"selvrisikoforsikring");
*/
		if (sortpaiflg>0) {
/*
			strcat(tmpstr,", PAI");
*/
			sprintf(tmpstr,
	"<a title=\"Læs mere her\" href=\"%s%s\" target=\"_blank\">%s</a>",
			returstr,
			"/default.aspx?id=559&purge=true",
			"selvrisiko/personskadeforsikring");
		}

		strcat(tmpstr," og moms.<BR>Ekskl. brændstof.");
		pack_alfa(tmpstr);
/*
		pack_alfa("selvrisikoforsikring og moms. Ekskl. brændstof");
*/
/* NYT 060220 */
		pack_doub((double)depositum);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		antal++;
	}
/*
	if (antal>0) {
		alfalow(str);
		pack_init(str);
		pack_alfa("FOOTER");
		pack_alfa("Klik på 'Bestil bil' og du er næsten kørende...");
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
*/
	strcpy(tmpstr,"");
	if (exthlgspecnr>0) {
		sprintf(tmpstr,
"overvej vores specielle helligdagstilbud");
	}
	if (hlgspecnr>0) {
		sprintf(tmpstr,
"i stedet for enkelte dage og weekend i perioden kan vi tilbyde ovenstående tilbud");
	}
	if (perprisflag>0) {
		sprintf(tmpstr,
"overvej vores specielle sæsontilbud");
	}
/*
	if (ws_headeridx>0) {
		sprintf(tmpstr,"%s",ws_headertab[ws_headeridx]);
	}
*/

/* NYT 081204 INGEN PRODUKTER INGEN FOOTER */
	if (antal>0 && strlen(tmpstr)) {
/*
	if (strlen(tmpstr)) {
*/
		alfalow(str);
		pack_init(str);
		if (antal==1) {
			pack_alfa("ALTERNATIVE");
		} else {
			pack_alfa("FOOTER");
		}
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
/* NYT 100630 SOMMER LUFTHAVNE */
	if (antal<=0 && perprisflag==-1) {
		ws_sommerwebfejl = 1;
	}
	if (logfil) {
		fprintf(logfil,
			"ecweb_prislisteSLUT antal=%d ws_sommerwebfejl=%hd",
			antal,
			ws_sommerwebfejl);
		fflush(logfil);
	}
	if (antal<=0 && ws_sommerwebfejl>0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-54);
		web_errormess(0,ws_langstr,"54");
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
	if (antal<=0 && ws_sommerwebfejl<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-14);
		web_errormess(0,ws_langstr,"14");
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
	sprintf(dum_str,
		"ecweb_prisliste SLUT:antal=%d",
		antal);
        logfil_put(dum_str);
	return;
}

/* *********************************************** */
static void dan_kredkort_liste(int ecflag,double total,char *grp,char *returstr) {
	int abfflag = 0;
/* NYT 120418 GRPOVISADK */
	if (strcmp(grp,"O")==0) { abfflag++; }
	if (strcmp(grp,"A")==0) { abfflag++; }
	if (strcmp(grp,"B")==0) { abfflag++; }
	if (strcmp(grp,"F")==0) { abfflag++; }
/*
		sprintf(returstr,
"Mastercard,Eurocard,Diners,Visa International (ikke Visa/DK),Amex,LIC Mastercard,Q8,Veko,Forbrugsforeningen,VisaElectron,Visa/Dankort,Dankort,Kontant");
		if (strcmp(grp,"C")==0 ||
			strcmp(grp,"G")==0) {
			sprintf(returstr,
			"Mastercard,Eurocard,Diners,Visa International (ikke Visa/DK),Amex,LIC Mastercard,Q8,Veko,Forbrugsforeningen");
*/
	strcpy(returstr,"Eurocard");
	strcat(returstr,",JBC");
	strcat(returstr,",Visa International (ikke Visa/DK)");
	strcat(returstr,",Mastercard");
	strcat(returstr,",CUP ChinaUnionPay");
	strcat(returstr,",Diners");
	strcat(returstr,",Discover");
	strcat(returstr,",Amex");
	strcat(returstr,",Forbrugsforeningen");
	if (abfflag>0) { strcat(returstr,",Visa/Dankort"); }
	if (abfflag>0) { strcat(returstr,",Dankort"); }
	strcat(returstr,",LIC Mastercard");
	if (abfflag>0) { strcat(returstr,",VisaElectron"); }
	if (abfflag>0 && total<=5000) { strcat(returstr,",Veko"); }
	if (abfflag>0 && total<=5000) { strcat(returstr,",Q8"); }
	if (abfflag>0) { strcat(returstr,",Kontant"); }
	return;
}

/* NYT 120105 WEBWEEKEND4-6 */
/* ************************************** */
static int check_perprisjust(short spcnr,short stnr,char *grp,long fradato,long antdg) {
	int retur = 0;
	int oplkode = 16586;
	int chkfradag = 0;
	int chktildag = 0;
	short int nuvstnr = 0;
	char kalfa[21] = "";
	char tmpstr[41] = "";

	reclow(r198,R198);
	r198->oplkode = oplkode;
	r198->keynum = (double)spcnr;
	sprintf(kalfa,"%5.5hd%s",nuvstnr,grp);
	sprintf(r198->keyalfa,kalfa);
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		return(-1);
	}
	while(retur==0) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
		if (r198->keynum!=(double)spcnr) {
			break;
		}
		if (strcmp(r198->keyalfa,kalfa)!=0) {
			break;
		}
		if (r198->status<=0) {
			continue;
		}
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&chkfradag);
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&chktildag);
		}
		if (antdg<chkfradag) {
			continue;
		}
		if (antdg>chktildag) {
			continue;
		}
		retur++;
	}
	return(retur);
}

/* *********************************************** */
static int check_minsalg(short funk,long oplkode,short station,char *grp,long fradato,long tildato) {
	short int retur = 0;
	short int okflag = 0;
	short int chkdage = 0;
	short int st00genflag = 0;
	short int st00genkode = 0;
	long int genfradato = 0;
	long int gentildato = 0;
	long int genfrajul = 0;
	long int gentiljul = 0;
	long int nuvjulian = 0;
	long int tmpdato = 0;
	char chkgrp[5] = "";
	char tmpstr[41] = "";

	if (oplkode==16625 && funk==2 && station==0) {
		st00genflag = 1;
	}
	if (logfil) {
		fprintf(logfil,
		"check_minsalg:funk=%hd opl=%ld station=%hd %ld-%ld\n",
			funk,
			oplkode,
			station,
			fradato,
			tildato);
		fprintf(logfil,
		"\tgrp=%s\n",
			grp);
		fprintf(logfil,
		"\tst00genflag=%hd\n",
			st00genflag);
		fprintf(logfil,"\t16625\n");
	}
	reclow(r198,R198);
	r198->oplkode = oplkode;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		retur = -1;
	}
	while (retur>=0 && funk==1) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
/*
	if (logfil) {
		fprintf(logfil,
		"check_minsalg:HERTIL-0 %ld %.0lf %ld-%ld %0.lf %s\n",
			r198->oplkode,
			r198->keynum,
			r198->fradato,
			r198->tildato,
			r198->numfelt,
			r198->alfafelt);
	}
*/
		if (r198->oplkode>oplkode) {
			break;
		}
		if (r198->keynum!=0) {
			continue;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		if (fradato<r198->fradato) {
			continue;
		}
		if (fradato>r198->tildato) {
			continue;
		}
		strcpy(chkgrp,"");
		(void)get_alfa_tgn(r198->alfafelt,0,chkgrp,';');
		if (!strlen(chkgrp)) {
			strcpy(chkgrp,"*");
		}
		if (strcmp(chkgrp,"*")!=0 && strcmp(chkgrp,grp)!=0) {
			continue;
		}
		strcpy(tmpstr,"");
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&chkdage);
		}
	}

	reclow(r198,R198);
	r198->oplkode = oplkode;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		retur = -1;
	}
	while (retur>=0 && funk>=1 && chkdage==0) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode>oplkode) {
			break;
		}
		if (r198->keynum!=station) {
			continue;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		okflag = 0;
		if (fradato>=r198->fradato && fradato<=r198->tildato) {
			okflag++;
		}
/* RETTET 091019
		if (tildato>=r198->fradato && tildato<=r198->tildato) {
			okflag++;
		}
*/
		strcpy(chkgrp,"");
		(void)get_alfa_tgn(r198->alfafelt,0,chkgrp,';');
		if (!strlen(chkgrp)) {
			strcpy(chkgrp,"*");
		}
		if (strcmp(chkgrp,"*")!=0 && strcmp(chkgrp,grp)!=0) {
			okflag = 0;
		}
		if (oplkode==16625 && r198->numfelt<=0) {
			okflag = 0;
		}
		if (logfil) {
			fprintf(logfil,"\t\tchkgrp=%s grp=%s okflag=%hd\n",
				chkgrp,
				grp,
				okflag);
		}
		if (okflag<=0) {
			continue;
		}
		if (oplkode==16625) {
			chkdage = (short int)r198->numfelt;
		}
		if (oplkode==16655) {
			strcpy(tmpstr,"");
			(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		}
		if (oplkode==16655 && strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&chkdage);
		}
/* NYT 111110 9999JUL */
		if (oplkode==16625 && chkdage>0 && station==0) {
				st00genflag = 0;
		}
	}
/* NYT 111110 9999JUL */
	if (st00genflag>0 && chkdage<=0) {
		reclow(r198,R198);
		r198->oplkode = oplkode;
		f198_start(1,ISGTEQ);
		genfradato = fradato%10000;
		genfradato += 99990000;

		gentildato = tildato%10000;
		gentildato += 99990000;
	}
	if (logfil) {
		fprintf(logfil, "\tst00genflag-1=%hd\n", st00genflag);
		fprintf(logfil, "\tgenfradato=%ld\n", genfradato);
		fprintf(logfil, "\tgentildato=%ld\n", gentildato);
		fprintf(logfil, "\tchkdage=%hd\n", chkdage);
		fflush(logfil);
	}
	while (st00genflag>0 && chkdage==0 && genfradato>0 && gentildato>0) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode>oplkode) {
			break;
		}
		if (r198->keynum!=station) {
			continue;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		okflag = 0;
		if (genfradato>=r198->fradato && genfradato<=r198->tildato) {
			okflag++;
		}
		strcpy(chkgrp,"");
		(void)get_alfa_tgn(r198->alfafelt,0,chkgrp,';');
		if (!strlen(chkgrp)) {
			strcpy(chkgrp,"*");
		}
		if (strcmp(chkgrp,"*")!=0 && strcmp(chkgrp,grp)!=0) {
			okflag = 0;
		}
		if (oplkode==16625 && r198->numfelt<=0) {
			okflag = 0;
		}
		if (okflag<=0) {
			continue;
		}
		chkdage = (short int)r198->numfelt;
	}
/* NYT 111110 9999JUL */
	if (st00genflag>0 && chkdage<=0) {
		genfrajul = m036_funktion(12, fradato);
		gentiljul = m036_funktion(12, tildato);
		nuvjulian = genfrajul;
		st00genkode = 0;
		genfradato = 0;
		gentildato = 0;
	}
	if (logfil) {
		fprintf(logfil, "\tst00genflag-2=%hd\n", st00genflag);
		fprintf(logfil, "\tgenfrajul=%ld\n", genfradato);
		fprintf(logfil, "\tgentiljul=%ld\n", gentildato);
		fflush(logfil);
	}
	while (st00genflag>0 && chkdage==0 &&
		genfrajul>0 && gentiljul>0 &&
		nuvjulian<=gentiljul &&
		st00genkode==0) {
		tmpdato = m036_funktion(19, nuvjulian);
		st00genkode = (short int)m036_alfa_funk(2,
			(long int)tmpdato,40,tmpstr);
		nuvjulian++;
	}
	if (logfil) {
		fprintf(logfil, "\tst00genflag-3=%hd\n", st00genflag);
		fprintf(logfil, "\tst00genkode=%hd\n", st00genkode);
		fflush(logfil);
	}
	if (st00genflag>0 && chkdage<=0 && st00genkode>0) {
		reclow(r198,R198);
		r198->oplkode = oplkode;
		f198_start(1,ISGTEQ);
		genfradato = 99999900;
		genfradato += (long int)st00genkode;
		gentildato = genfradato;
	}
	if (logfil) {
		fprintf(logfil, "\tst00genflag-4=%hd\n", st00genflag);
		fprintf(logfil, "\tgenfradato=%ld\n", genfradato);
		fprintf(logfil, "\tgentildato=%ld\n", gentildato);
		fflush(logfil);
	}
	while (st00genflag>0 && chkdage==0 && genfradato>0 && gentildato>0) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode>oplkode) {
			break;
		}
		if (r198->keynum!=station) {
			continue;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		okflag = 0;
		if (genfradato>=r198->fradato && genfradato<=r198->tildato) {
			okflag++;
		}
		strcpy(chkgrp,"");
		(void)get_alfa_tgn(r198->alfafelt,0,chkgrp,';');
		if (!strlen(chkgrp)) {
			strcpy(chkgrp,"*");
		}
		if (strcmp(chkgrp,"*")!=0 && strcmp(chkgrp,grp)!=0) {
			okflag = 0;
		}
		if (oplkode==16625 && r198->numfelt<=0) {
			okflag = 0;
		}
		if (okflag<=0) {
			continue;
		}
		chkdage = (short int)r198->numfelt;
	}
	if (chkdage>0) {
		retur = chkdage;
	}
	if (logfil) {
		fprintf(logfil,"check_minsalg:retur=%hd\n",
			retur);
	}
	return(retur);
}

/* *********************************************** */
static int check_ecdon_aflblok(short funk,short station,char *grp,long fradato,long tildato,char *returstr) {
	short int retur = 0;
	short int videreflag = 0;
	long int oplkode = 16661;
	char chkgrp[21] = "";
	char fejllink[21] = "";

	if (station==0) {
		oplkode = 16660;
	}

/* TEST */
	if (logfil) {
		fprintf(logfil,"check_ecdon_aflblok:funk=%hd,st=%hd %s %ld-%ld\n",
			funk,
			station,
			grp,
			fradato,
			tildato);
		fprintf(logfil,"\toplkode=%ld\n", oplkode);
		fflush(logfil);
	}
	reclow(r198,R198);
	r198->oplkode = oplkode;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		retur = -1;
	}
	while (retur==0) {
/* RETTET 120307
	while (retur>=0) {
*/
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode>oplkode) {
			break;
		}
		if (r198->keynum!=station) {
			continue;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		if (tildato<r198->fradato) {
			continue;
		}
		if (tildato>r198->tildato) {
			continue;
		}
		if (strcmp(r198->alfafelt,"*")==0) {
			retur = 1;
			break;
		}
		if (strcmp(grp,"*")==0) {
			retur = 1;
		}
/* NYT 120307 ALTAFLFEJL */
		(void)get_alfa_tgn(r198->alfafelt,0,chkgrp,';');
		(void)get_alfa_tgn(r198->alfafelt,1,fejllink,';');
		videreflag = 0;
		if (strlen(fejllink) && strlen(chkgrp) &&
			strcmp(chkgrp,"*")!=0 &&
			strcmp(chkgrp,grp)!=0) {
			videreflag = 1;
		}
		if (!strlen(fejllink) && strcmp(r198->alfafelt,"*")!=0 &&
			strcmp(r198->alfafelt,grp)!=0) {
			videreflag = 1;
		}
		if (videreflag>0) {
			continue;
		}
		retur = 1;
		if (strlen(fejllink)) {
			strcpy(returstr,fejllink);
		}
	}
	if (logfil) {
		fprintf(logfil,"check_ecdon_aflblok:retur=%hd <%s>\n",
			retur,
			returstr);
	}
	return(retur);
}

/* *********************************************** */
static int check_owblok(short funk,short station,char *grp,long fradato,long tildato) {
	short int retur = 0;
	long int oplkode = 16658;

/* TEST */
	if (logfil) {
		fprintf(logfil,"check_owblok:funk=%hd,st=%hd %s %ld-%ld\n",
			funk,
			station,
			grp,
			fradato,
			tildato);
		fprintf(logfil,"\toplkode=%ld\n", oplkode);
		fflush(logfil);
	}
	reclow(r198,R198);
	r198->oplkode = oplkode;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		retur = -1;
	}
	while (retur>=0) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode>oplkode) {
			break;
		}
		if (r198->keynum!=station) {
			continue;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		if (tildato<r198->fradato) {
			continue;
		}
		if (fradato>r198->tildato) {
			continue;
		}
		if (strcmp(r198->alfafelt,"*")==0) {
			retur = 1;
			break;
		}
		if (strcmp(grp,"*")==0) {
			retur = 1;
		}
		if (strcmp(r198->alfafelt,"*")!=0 &&
			strcmp(r198->alfafelt,grp)!=0) {
			continue;
		}
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"check_owblok:retur=%hd\n",
			retur);
	}
	return(retur);
}

/* *********************************************** */
static int check_stopsalg(short funk,short station,char *grp,long fradato,long tildato) {
	short int retur = 0;
	long int oplkode = 16632;

	if (ws_udldkflag>0) {
		oplkode = 16654;
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,"check_stopsalg:funk=%hd,st=%hd %s %ld-%ld\n",
			funk,
			station,
			grp,
			fradato,
			tildato);
		fprintf(logfil,"\toplkode=%ld\n", oplkode);
		fflush(logfil);
	}
	reclow(r198,R198);
	r198->oplkode = oplkode;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		retur = -1;
	}
	while (retur>=0) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode>oplkode) {
			break;
		}
		if (r198->keynum!=station) {
			continue;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		if (tildato<r198->fradato) {
			continue;
		}
		if (fradato>r198->tildato) {
			continue;
		}
		if (strcmp(r198->alfafelt,"*")==0) {
			retur = 1;
			break;
		}
		if (strcmp(r198->alfafelt,grp)!=0) {
			continue;
		}
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"check_stopsalg:retur=%hd\n",
			retur);
	}
	return(retur);
}

/* NYT 120306 UDLDKINAKTIVGRP */
/* *********************************************** */
static int check_grpinaktiv(short funk,short station,char *grp,long fradato,long tildato) {
	short int retur = 0;
	long int oplkode = 16664;

	if (ws_udldkflag>0) {
		oplkode = 16664;
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,"check_grpinaktiv:funk=%hd,st=%hd %s %ld-%ld\n",
			funk,
			station,
			grp,
			fradato,
			tildato);
		fprintf(logfil,"\toplkode=%ld\n", oplkode);
		fflush(logfil);
	}
	reclow(r198,R198);
	r198->oplkode = oplkode;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		retur = -1;
	}
	while (retur>=0) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode>oplkode) {
			break;
		}
		if (strcmp(r198->keyalfa,grp)!=0) {
			continue;
		}
		if (r198->numfelt<=0) {
			continue;
		}
/*
		if (tildato<r198->fradato) {
			continue;
		}
		if (fradato>r198->tildato) {
			continue;
		}
		if (strcmp(r198->alfafelt,"*")==0) {
			retur = 1;
			break;
		}
		if (strcmp(r198->alfafelt,grp)!=0) {
			continue;
		}
*/
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"check_grpinaktiv:retur=%hd\n",
			retur);
	}
	return(retur);
}

/* *********************************************** */
static int udregn_depositum(int antdg,double *depositum) {

/* TEST */
	if (logfil) {
		fprintf(logfil, "udregn_depositum:antdg=%d\n",antdg);
	}

	*depositum = 0;
	if (antdg>0 && antdg<=2) {
		*depositum = 1500;
/* RETTET 090828
		*depositum = 1000;
*/
	}
	if (antdg>2 && antdg<=5) {
		*depositum = 1500;
	}
	if (antdg>5 && antdg<=14) {
		*depositum = 2500;
	}
	if (antdg>14) {
		*depositum = 4000;
	}
	return(1);
}

/* *********************************************** */
static int find_f198prisjust(short inpspec,char *grp,short st,long dtud,int antdg,double *pris,short *enhed,long *antal,double *cdi,double *pai,double *extkm,long *inclkm) {
	short int retur = 0;
	short int spec = 0;
	short int chkenhed = 0;
	int chkfradag = 0;
	int chktildag = 0;
	long int oplkode = 16586;
	long int chkinclkm = 0;
	double chkpris = 0;
	double chkcdi = 0;
	double chkpai = 0;
	double chkextkm = 0;
	char tmpstr[41] = "";
	char kalfa[41] = "";

	spec = inpspec;
/* FORDELE 090608 */
	if (ws_udldkflag>0 && spec==924) {
		oplkode = 16596;
	}
/* NYT 110107 VINTERUDL */
	if (ws_udldkflag>0 && spec==910) {
		oplkode = 16596;
	}
/* NYT 110114 UDLDKKAMP */
	if (ws_udldkflag>0 && inpspec>1000) {
		spec -= 1000;
		oplkode = 16548;
	}

/* TEST */
	if (logfil) {
		fprintf(logfil, "find_f198prisjust:st=%hd,dtud=%ld,antdg=%d\n",
			st,
			dtud,
			antdg);
		fprintf(logfil, "\toplkode=%ld, spec=%hd\n",
			oplkode,
			spec);
	}
	reclow(r198,R198);
	r198->oplkode = oplkode;
	r198->keynum = (double)spec;
	sprintf(kalfa,"%5.5hd%s",st,grp);
	sprintf(r198->keyalfa,kalfa);
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		return(-1);
	}
/* TEST */
	if (logfil) {
		fprintf(logfil, "find_f198prisjust:START %.0lf %s\n",
			r198->keynum,
			r198->keyalfa);
	}
	while(retur==0) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
		if (logfil) {
			fprintf(logfil, "find_f198prisjust:%.0lf %s\n",
				r198->keynum,
				r198->keyalfa);
			fprintf(logfil, "find_f198prisjust:%ld-%ld\n",
				r198->fradato,
				r198->tildato);
		}


		if (r198->keynum!=(double)spec) {
			break;
		}
		if (strcmp(r198->keyalfa,kalfa)!=0) {
			break;
		}
		if (dtud<r198->fradato) {
			continue;
		}
		if (dtud>r198->tildato) {
			continue;
		}
		if (r198->status<=0) {
			continue;
		}
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&chkfradag);
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&chktildag);
		}
		(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%lf",&chkpris);
		}
		(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&chkenhed);
		}
		(void)get_alfa_tgn(r198->alfafelt,4,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%lf",&chkcdi);
		}
		(void)get_alfa_tgn(r198->alfafelt,5,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%lf",&chkpai);
		}
		(void)get_alfa_tgn(r198->alfafelt,6,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%lf",&chkextkm);
		}
		(void)get_alfa_tgn(r198->alfafelt,7,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&chkinclkm);
		}


		if (antdg<chkfradag) {
			continue;
		}
		if (antdg>chktildag) {
			continue;
		}
		if (chkcdi>0) {
			*cdi = chkcdi;
		}
		if (chkpai>0) {
			*pai = chkpai;
		}
		if (chkextkm>0) {
			*extkm = chkextkm;
		}
		if (chkinclkm>0) {
			*inclkm = chkinclkm;
		}
		*pris = chkpris;
		if (chkenhed>0 && chkenhed%100==0) {
			*enhed = chkenhed + antdg;
		}
		if (chkenhed>0 && chkenhed%100!=0) {
			*enhed = chkenhed;
		}
		retur++;
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,
	"find_f198prisjust:RETUR retur=%hd,*enhed=%hd,*antal=%ld,pris=%.2lf\n",
			retur,
			*enhed,
			*antal,
			*pris);
	}
/* OBS WEEKEND 090327 */

	if (retur>0 && *enhed>200 && *enhed<300 &&
		*enhed%100==1) {
		*antal = antdg;
	}
	if (retur>0 && *enhed>200 && *enhed<300 &&
		*enhed%100==antdg) {
		*antal = 1;
	}
/* NYT 110509 UDLDKPERIODE */
	if (ws_udldkflag>0 && oplkode==16586 &&
		retur>0 && *enhed>200 && *enhed<300 &&
		*enhed%100==antdg) {
		*enhed = 201;
		*antal = antdg;
		*pris /= antdg;
		afrund2(*pris);
	}

/* TEST */
	if (logfil) {
		fprintf(logfil,
	"find_f198prisjust:RETUR2 retur=%hd,*enhed=%hd,*antal=%ld,pris=%.2lf\n",
			retur,
			*enhed,
			*antal,
			*pris);
	}
	return(retur);
}

/* *********************************************** */
static int find_f198hlgpris(short spec,char *grp,short st,long dtud,long dtind,char *navn,double *pris,short *enhed,long *antal,double *cdi,double *pai,double *extkm,long *inclkm,short *paiflag) {
	short int retur = 0;
	short int chkpaiflag = 0;
	short int chkenhed = 0;
	short int perprisflag = 0;
	short int hlgfundet = 0;
	int chkfradag = 0;
	int chktildag = 0;
	long int chkinclkm = 0;
	long int hlgperiode = 0;
	long int julian1 = 0;
	long int julian2 = 0;
	double chkpris = 0;
	double chkcdi = 0;
	double chkpai = 0;
	double chkextkm = 0;
	char tmpstr[41] = "";
	char kalfa[41] = "";
	char hlgtype[21] = "";

/* OBS NYT SPECNR */
/* PAASKE07 CHECK FOR TILBUDSMARKERING */
	if (spec==673) {
		perprisflag = 2;
		hlgfundet = check_f198_udvhlg(1,
			spec,
                        st,
			grp,
			dtud,
			dtind,
			hlgtype);
		julian1 = m036_funktion(12, dtud);
		julian2 = m036_funktion(12, dtind);
		hlgperiode = julian2 - julian1;
	}
	if (spec==674) {
		perprisflag = 1;
	}
	if (spec==675) {
		perprisflag = 1;
	}
	if (spec==676) {
		perprisflag = 1;
	}
	if (spec==677) {
		perprisflag = 1;
	}
	if (spec==678) {
		perprisflag = 1;
	}
	if (spec==679) {
		perprisflag = 1;
	}
	if (perprisflag==1) {
		julian1 = m036_funktion(12, dtud);
		julian2 = m036_funktion(12, dtind);
		hlgperiode = julian2 - julian1;
	}
	if (logfil) {
		fprintf(logfil,
	"find_f198hlgpris:hlgtype=%s,hlgperiode=%ld(%ld-%ld)\n",
			hlgtype,
			hlgperiode,
			dtud,
			dtind);
		fprintf(logfil,
	"find_f198hlgpris:perprisflag=%hd\n",perprisflag);
	}




	reclow(r198,R198);
	r198->oplkode = 16581;
	r198->keynum = (double)spec;
	sprintf(kalfa,"%5.5hd%s",st,grp);
	sprintf(r198->keyalfa,kalfa);
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		return(-1);
	}
	if (logfil) {
		fprintf(logfil, "find_f198hlgpris:START %.0lf %s\n",
			r198->keynum,
			r198->keyalfa);
	}
	while(retur==0) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=16581) {
			break;
		}
		if (logfil) {
			fprintf(logfil, "find_f198hlgpris:%.0lf %s\n",
				r198->keynum,
				r198->keyalfa);
			fprintf(logfil, "find_f198hlgpris:%ld-%ld\n",
				r198->fradato,
				r198->tildato);
		}
		if (r198->keynum!=(double)spec) {
			break;
		}
		if (strcmp(r198->keyalfa,kalfa)!=0) {
			break;
		}
		if (perprisflag==0 && dtud!=r198->fradato) {
			continue;
		}
		if (perprisflag==0 && dtind!=r198->tildato) {
			continue;
		}
/* NYT 070308 */
		if (perprisflag==2 &&
			strcmp(hlgtype,"UII")==0 &&
			dtud<r198->fradato) {
			continue;
		}
		if (perprisflag==2 &&
			strcmp(hlgtype,"UII")==0 &&
			dtind>r198->tildato) {
			continue;
		}
/* NYT 081110 */


		if (r198->status<=0) {
			continue;
		}
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&chkfradag);
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&chktildag);
		}
/* NYT 070315 */
		if (perprisflag==2 &&
			strcmp(hlgtype,"UII")==0 &&
			hlgperiode<chkfradag) {
			continue;
		}
		if (perprisflag==2 &&
			strcmp(hlgtype,"UII")==0 &&
			hlgperiode>chktildag) {
			continue;
		}
		if (perprisflag==2 &&
			strcmp(hlgtype,"FD")==0 &&
			hlgperiode!=chkfradag) {
			continue;
		}
		if (perprisflag==2 &&
			strcmp(hlgtype,"FD")==0 &&
			hlgperiode!=chktildag) {
			continue;
		}
		if (perprisflag==2 &&
			strcmp(hlgtype,"FD")==0 &&
			dtud!=r198->fradato) {
			continue;
		}
		if (perprisflag==2 &&
			strcmp(hlgtype,"FD")==0 &&
			dtind!=r198->tildato) {
			continue;
		}
/* NYT 100629 */
		if (perprisflag==1 && hlgperiode>0 && hlgperiode<chkfradag) {
			continue;
		}
		if (perprisflag==1 && hlgperiode>0 && hlgperiode>chktildag) {
			continue;
		}


		if (logfil) {
			fprintf(logfil, "find_f198hlgpris:FUNDET\n");
		}
		(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%lf",&chkpris);
		}
		(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&chkenhed);
		}
		(void)get_alfa_tgn(r198->alfafelt,4,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%lf",&chkcdi);
		}
		(void)get_alfa_tgn(r198->alfafelt,5,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%lf",&chkpai);
		}
		(void)get_alfa_tgn(r198->alfafelt,6,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%lf",&chkextkm);
		}
		(void)get_alfa_tgn(r198->alfafelt,7,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&chkinclkm);
		}
		(void)get_alfa_tgn(r198->alfafelt,8,tmpstr,';');
		if (strlen(tmpstr)) {
			strcpy(navn,tmpstr);
		}
		(void)get_alfa_tgn(r198->alfafelt,9,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&chkpaiflag);
		}

		*cdi = chkcdi;
		*pai = chkpai;
		*extkm = chkextkm;
		*inclkm = chkinclkm;
		*pris = chkpris;
		*enhed = chkenhed;
		*paiflag = chkpaiflag;
		retur++;
	}
/*
	if (retur>0 && *enhed>200 && *enhed<300 &&
		*enhed%100==1) {
		*antal = antdg;
	}
	if (retur>0 && *enhed>200 && *enhed<300 &&
		*enhed%100==antdg) {
		*antal = 1;
	}
*/
	if (retur>0 && *enhed>200 && *enhed<300) {
		*antal = 1;
	}
	return(retur);
}

/* *********************************************** */
static int find_f198perpris(short spec,char *grp,short st,long dtud,long dtind,char *navn,double *pris,short *enhed,long *antal,double *cdi,double *pai,double *extkm,long *inclkm,short *paiflag) {
	short int retur = 0;
	short int chkpaiflag = 0;
	short int chkenhed = 0;
	int chkfradag = 0;
	int chktildag = 0;
	long int chkinclkm = 0;
	double chkpris = 0;
	double chkcdi = 0;
	double chkpai = 0;
	double chkextkm = 0;
	char tmpstr[41] = "";
	char kalfa[41] = "";

	reclow(r198,R198);
	r198->oplkode = 16580;
	r198->keynum = (double)spec;
	sprintf(kalfa,"%5.5hd%s",st,grp);
	sprintf(r198->keyalfa,kalfa);
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		return(-1);
	}
	if (logfil) {
		fprintf(logfil, "find_f198perpris:START %.0lf %s\n",
			r198->keynum,
			r198->keyalfa);
	}
	while(retur==0) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=16580) {
			break;
		}
		if (logfil) {
			fprintf(logfil, "find_f198perpris:%.0lf %s\n",
				r198->keynum,
				r198->keyalfa);
			fprintf(logfil, "find_f198perpris:%ld-%ld\n",
				r198->fradato,
				r198->tildato);
		}
		if (r198->keynum!=(double)spec) {
			break;
		}
		if (strcmp(r198->keyalfa,kalfa)!=0) {
			continue;
		}
/*
		if (perprisflag==0 && dtud!=r198->fradato) {
			continue;
		}
		if (perprisflag==0 && dtind!=r198->tildato) {
			continue;
		}
*/
		if (r198->status<=0) {
			continue;
		}
		if (logfil) {
			fprintf(logfil, "find_f198perpris:FUNDET\n");
		}
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&chkfradag);
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&chktildag);
		}
		(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%lf",&chkpris);
		}
		(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&chkenhed);
		}
		(void)get_alfa_tgn(r198->alfafelt,4,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%lf",&chkcdi);
		}
		(void)get_alfa_tgn(r198->alfafelt,5,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%lf",&chkpai);
		}
		(void)get_alfa_tgn(r198->alfafelt,6,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%lf",&chkextkm);
		}
		(void)get_alfa_tgn(r198->alfafelt,7,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&chkinclkm);
		}
		(void)get_alfa_tgn(r198->alfafelt,8,tmpstr,';');
		if (strlen(tmpstr)) {
			strcpy(navn,tmpstr);
		}
		(void)get_alfa_tgn(r198->alfafelt,9,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&chkpaiflag);
		}
		*cdi = chkcdi;
		*pai = chkpai;
		*extkm = chkextkm;
		*inclkm = chkinclkm;
		*pris = chkpris;
		*enhed = chkenhed;
		*paiflag = chkpaiflag;
		retur++;
	}
/*
	if (retur>0 && *enhed>200 && *enhed<300 &&
		*enhed%100==1) {
		*antal = antdg;
	}
	if (retur>0 && *enhed>200 && *enhed<300 &&
		*enhed%100==antdg) {
		*antal = 1;
	}
*/
	if (retur>0 && *enhed>200 && *enhed<300) {
		*antal = 1;
	}
	return(retur);
}

/* ********************************* */
/* funk 1 prisliste person	     */
/*      2 extraprisliste person	     */
/*      0 prisliste firma	     */
static void send_prisliste(funk,langstr,station,kundenr,extrastr)
short int funk;
char * langstr;
short int station;
long int kundenr;
char * extrastr; {
	short int wx1 = 0;
	short int okflag = 0;
	short int aftaleflag = 0;
	short int funkretur = 0;
	short int prisextra = 0;
	long int fradato = 0;
	long int tildato = 0;
	long int julian = 0;
	long int antaldgn = 1;
	long int firmakundenr = 0;
	long int firmaaftfra = 0;
	long int firmaafttil = 0;
	char grp[11] = "";
	char transstr[21] = "";
	char returstr[81] = "";
	char tmpstr[81] = "";
	double niv_pris;
	double niv_cdi;
        double niv_pai;
        double niv_km;
	long int inclkm;

/* TEST */
	sprintf(dum_str,
		"send_prisliste:funk=%hd,stat=%hd,kundenr=%ld,extrastr=%s",
		funk,
		station,
		kundenr,
		extrastr);
        logfil_put(dum_str);
	if (funk==0 && kundenr>0) {
		reclow(r167, R167);
		f167_start(1, ISGTEQ);
		r167->kunde_nr = kundenr;
		egeread(f167, ISEQUAL);
		if (f167_ok) {
			firmakundenr = kundenr;
		}
	}

/* AFTALEFLAG */
	if (kundenr>0 && firmakundenr==0) {
		reclow(r167, R167);
		f167_start(1, ISGTEQ);
		r167->kunde_nr = kundenr;
		egeread(f167, ISEQUAL);
		if (f167_ok) {
			firmakundenr = r167->firma_reference;
		}
	}
	if (firmakundenr>0) {
		if (find_r178(0,16,0,(double)firmakundenr)>0) {
			firmaaftfra = (long int)r178->num_felt;
		}
		if (find_r178(0,4,0,(double)firmakundenr)>0) {
			firmaafttil = (long int)r178->num_felt;
		}
		if (firmaafttil==0) {
			firmaafttil = 99999999;
		}
        }
	if (firmakundenr>0 &&
		firmaaftfra>0 &&
		ws_systemdato>=firmaaftfra && ws_systemdato<=firmaafttil) {
		aftaleflag = 1;
	}
/* TEST */
	sprintf(dum_str, "send_prisliste:firma=%ld aft=%ld-%ld aftaleflag=%hd",
		firmakundenr,
		firmaaftfra,
		firmaafttil,
		aftaleflag);
	logfil_put(dum_str);

	if (funk==2 && strlen(extrastr)) {
		(void)get_alfa_tgn(extrastr,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &fradato);
		}
		(void)get_alfa_tgn(extrastr,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &tildato);
		}
		(void)get_alfa_tgn(extrastr,2,grp,';');
	}
	sprintf(dum_str, "send_prisliste:fradato=%ld,tildato=%ld,grp=%s",
		fradato,
		tildato,
		grp);
        logfil_put(dum_str);
	if (funk==2 && fradato>0 && tildato>0) {
		julian = m036_funktion(12, tildato);
		antaldgn = julian - m036_funktion(12, fradato);
	}
	sprintf(dum_str, "send_prisliste:antaldgn=%ld",
		antaldgn);
        logfil_put(dum_str);
/* OBS måske antaldgn<=0 */
	if (antaldgn<0) {
		antaldgn = 1;
	}
	reclow(r165, R165);
	r165->stat_nr = station;
	f165_start(2, ISGTEQ);
	if (f165_ukendt) {
		okflag = -1;
	}
	while (okflag>=0) {
		egeread(f165, ISNEXT);
		if (f165_eof) {
			break;
		}
		if (r165->stat_nr!=station) {
			break;
		}
		if (r165->slet_mark>0) {
			continue;
		}

/* TEST */
	sprintf(dum_str, "send_prisliste:r165 spec=%hd stat%hd grp=%s",
		r165->spec_nr,
		r165->stat_nr,
		r165->bil_grp);
        logfil_put(dum_str);
/* CHECK FOR EXTRA */
		funkretur = 0;
		prisextra = 0;
                funkretur=find_r198(1,16503,(double)r165->spec_nr,"",0);
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisextra);
			}
		}
		if (funk==0 && prisextra>0) {
			continue;
		}
		if (funk==1 && prisextra>0) {
			continue;
		}
		if (funk==2 && prisextra==0) {
			continue;
		}
		if (funk==2 && strcmp(r165->bil_grp, "ALLE")!=0) {
			continue;
		}
		if ((funk==0||funk==1||funk==3) && strlen(extrastr) &&
			strcmp(r165->bil_grp, extrastr)!=0) {
			continue;
		}
		if (funk==0||funk==1) {
			funkretur=find_r198(1,16522,(double)r165->spec_nr,"",0);
			if (funkretur>0 && r198->numfelt>0 && aftaleflag==0) {
				continue;
			}
		}
		funkretur = 0;

		alfalow(str);
		pack_init(str);
		pack_int2((long)r165->spec_nr);
		pack_alfa(r165->bil_grp);
/* NYT 030117 */
/* RETTET 040514 */
		(void)f198_tekst(langstr,
			16526,(double)0,r165->bil_grp,0,tmpstr);
		pack_alfa(tmpstr);

		if (strcmp(langstr, "DK")==0 ||
			strcmp(langstr,"DA")==0) {
			pack_alfa(r165->tekst_1);
		} else {
			sprintf(transstr, "%5.5ld%5.5hd",
				16507,r165->spec_nr);
			trans_tekst(langstr,0,transstr,tmpstr);
			pack_alfa(tmpstr);
		}
/* specnr beskrivelse */
		(void)f198_tekst(langstr,
			16501,(double)r165->spec_nr,"",0,tmpstr);
		pack_alfa(tmpstr);
		niv_pris = (double)r165->pris;
		niv_cdi = (double)r165->rate_cdw;
		niv_pai = (double)r165->rate_pai;
		niv_km = (double)r165->ekstra_pr_km;
		inclkm = (long int)r165->incl_km;

		wx1 = 0;
		if (aftaleflag>0) {
			wx1 = find_f198_firmaaftale(station,
			r165->spec_nr,
			r165->bil_grp,
			&niv_pris,
			&niv_cdi,
			&niv_pai,
			&niv_km,
			&inclkm);
		}
		if (aftaleflag>0 && wx1>0) {
			r165->pris = (double)niv_pris;
			r165->rate_cdw = (float)niv_cdi;
			r165->rate_pai = (float)niv_pai;
			r165->ekstra_pr_km = (double)niv_km;
			r165->incl_km = inclkm;
		}
		if (funk==0 || funk==1) {
			pack_int2((long)r165->incl_km);
		}
		ege_w_dou1 = r165->pris;
		if (r165->incl_flag[1]>0) {
			udregn_cdipai_beloeb(r165->enhed,
				(short int)antaldgn,
				(double)r165->rate_cdw,
				&ege_w_dou2);
			ege_w_dou1 += ege_w_dou2;
		}
		pack_doub(ege_w_dou1);
		if (funk==0||funk==1) {
                        udregn_cdipai_beloeb(r165->enhed,
				(short int)antaldgn,
				(double)r165->rate_pai,
				&ege_w_dou2);
			pack_doub((double)ege_w_dou2);
/* NYT 040127 */
			trans_tekst(langstr,10101,"",returstr);
			egechartest((unsigned char *)returstr);
			sprintf(tmpstr, "%s %3.2lf",
				returstr,
				r165->ekstra_pr_km);
/*
			sprintf(tmpstr, "Pr extra km. Dkk. %3.2lf",
				r165->ekstra_pr_km);
*/
			pack_alfa(tmpstr);
		}
/* MAX ANTAL */
		if (funk==2) {
			(void)find_r198(0,16505,(double)r165->spec_nr,"",0);
			pack_int2((long)r198->numfelt);
		}
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
	return;
}

/* ********************************** */
static void send_extraliste(short funk,char * langstr,short stnr,long knr,long fradt,long tildt,char * grp) {
	short int wx1 = 0;
	short int okflag = 0;
	short int funkretur = 0;
	short int prisextra = 0;
	short int maxantal = 0;
	char tmpstr[81] = "";
	char transstr[21] = "";
	char returstr[81] = "";
	char extrastr[501] = "";

/* TEST */
	sprintf(dum_str,
	"send_extraliste:funk=%hd,stnt=%hd,knr=%ld,dato=%ld-%ld,grp=%s",
		funk,
		stnr,
		knr,
		fradt,
		tildt,
		grp);
        logfil_put(dum_str);
/* PAI */
	alfalow(str);
	pack_init(str);
	pack_alfa("PAI");
	if (strcmp(langstr,"EN")==0) {
	pack_alfa("Additional insurance: DKK");
	strcpy(extrastr,"<b>Additional insurance, only DKK 35</b><br>");
	strcat(extrastr,"driveon.net offers a favourable bodily injury- and property damage insurance.");
	strcat(extrastr," In case of an accident the insurance covers the driver and up to five passengers.");
	strcat(extrastr," The insurance offers compensation in case of death or disablement. Additionally");
	strcat(extrastr,", it covers personal property damages up to DKK 15.000.<br><br>");
	strcat(extrastr,"<b>Would you like the additional insurance?</b><br>");
	pack_alfa(extrastr);
	pack_alfa("Yes;No");
	pack_alfa("RADIO");
	pack_alfa("Nej");
	} else {
	pack_alfa("Tillægsforsikring: kr.");
	strcpy(extrastr,"<b>Tilllægsforsikring, kun kr. 35,-</b><br>");
	strcat(extrastr,"driveon.net tilbyder en fordelagtig person og godsforsikring.");
	strcat(extrastr," I tilfælde af uheld dækker den bilens fører og op til fem passagerer,");
	strcat(extrastr," forsikringen yder erstatning ved død eller invaliditet. Derudover");
	strcat(extrastr," dækker den gods, op til kr. 15.000,-<br><br>");
	strcat(extrastr,"<b>Ønsker du tillægsforsikring?</b><br>");
	pack_alfa(extrastr);
	pack_alfa("Ja;Nej");
	pack_alfa("RADIO");
	pack_alfa("Nej");
}
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}

	reclow(r165, R165);
	r165->stat_nr = stnr;
	f165_start(2, ISGTEQ);
	if (f165_ukendt) {
		okflag = -1;
	}
	while (okflag>=0) {
		egeread(f165, ISNEXT);
		if (f165_eof) {
			break;
		}
		if (r165->stat_nr!=stnr) {
			break;
		}
		if (r165->slet_mark>0) {
			continue;
		}

/* TEST */
	sprintf(dum_str, "send_extraliste:r165 spec=%hd stat%hd grp=%s",
		r165->spec_nr,
		r165->stat_nr,
		r165->bil_grp);
        logfil_put(dum_str);
/* CHECK FOR EXTRA */
		funkretur = 0;
		prisextra = 0;
                funkretur=find_r198(1,16503,(double)r165->spec_nr,"",0);
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisextra);
			}
		}
		if (prisextra==0) {
			continue;
		}
		if (strcmp(r165->bil_grp, "ALLE")!=0) {
			continue;
		}
		funkretur = 0;

		alfalow(str);
		pack_init(str);
		sprintf(tmpstr,"%3.3hd_%s",r165->spec_nr,r165->bil_grp);
		pack_alfa(tmpstr);

		if (strcmp(langstr, "DK")==0 ||
			strcmp(langstr,"DA")==0) {
			strcpy(extrastr,r165->tekst_1);
		} else {
			sprintf(transstr, "%5.5ld%5.5hd",
				16507,r165->spec_nr);
			trans_tekst(langstr,0,transstr,tmpstr);
			strcpy(extrastr,tmpstr);
		}
/* Korttekst */
		pack_alfa(extrastr);
/* Langtekst */
		pack_alfa(extrastr);

/* MAX ANTAL */
		(void)find_r198(0,16505,(double)r165->spec_nr,"",0);
		maxantal = (short int)r198->numfelt;
		strcpy(tmpstr,"");
		for (wx1=0;wx1<=maxantal;wx1++) {
			if (wx1==0) {
				sprintf(returstr,"%hd",wx1);
			} else {
				sprintf(returstr,";%hd",wx1);
			}
			strcat(tmpstr,returstr);
		}
		pack_alfa(tmpstr);
		pack_alfa("DROPDOWN");
		pack_alfa("0");
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		okflag++;
	}

/* NYT 111014 VINTERDÆK TEST */
/*
	alfalow(str);
	pack_init(str);
	sprintf(tmpstr,"%3.3hd_%s",(short int)910,"ALLE");
	pack_alfa(tmpstr);
	strcpy(extrastr,"vinterdæk");
	pack_alfa(extrastr);
	pack_alfa(extrastr);
	sprintf(tmpstr,"0;1");
	pack_alfa(tmpstr);
	pack_alfa("DROPDOWN");
	pack_alfa("0");
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
*/

/* MEDLEJER */
	alfalow(str);
	pack_init(str);
	pack_alfa("MEDLEJER");
	if (strcmp(langstr,"EN")==0) {
		pack_alfa("Co-driver");
		pack_alfa("<B>Co-driver</B><BR>Would you like a co-driver registered on the contract ?<BR>");
		pack_alfa("Yes;No");
		pack_alfa("RADIO");
		pack_alfa("Nej");
		} else {
		pack_alfa("Medlejer");
		pack_alfa("<B>Medlejer</B><BR>Skal der noteres en medlejer på kontrakten ?<BR>");
		pack_alfa("Ja;Nej");
		pack_alfa("RADIO");
		pack_alfa("Nej");
	}
	pack_exchkend();
	send_linie();



	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	return;
}

/* ******************************************* */
static void don_sendorderid() {

	if (logfil) {
		fprintf(logfil, "don_sendorderid\n");
		fflush(logfil);
	}
	alfalow(str);
	pack_init(str);
	pack_alfa(ws_donorderid);
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	return;
}

/* ******************************************* */
static void don_extraliste() {
	short int nextlinie = 0;
	short int ecflag = 0;
	char idstr[41] = "";
	char datastr[41] = "";

	if (logfil) {
		fprintf(logfil,"don_extraliste\n");
	}
/* extra extra */
	nextlinie = 0;
	while (nextlinie>=0 && ecflag==0) {
/* TEST */
		sprintf(dum_str, "don_extraliste:nextlinie=%hd", nextlinie);
		logfil_put(dum_str);
		if (get_subrecord()<=0) {
/* TEST */
			sprintf(dum_str,
				"don_extraliste:HERTIL:get_subrecord<=0");
			logfil_put(dum_str);
			break;
		}
		get_alfa(idstr);
		ege_toupper((unsigned char *)idstr);
		get_alfa(datastr);
		ege_toupper((unsigned char *)datastr);
/* TEST */
		sprintf(dum_str, "don_extraliste:HERTIL-1:idstr=%s,datastr=%s",
			idstr,
			datastr);
		logfil_put(dum_str);
		strcpy(ws_donidtab[nextlinie],idstr);
		strcpy(ws_dondatatab[nextlinie],datastr);

		nextlinie++;
	}
	ws_donextraidx = nextlinie;
/* PAI */
	ws_paiflag = 0;
	if (strcmp(ws_donidtab[0],"PAI")==0 &&
		strcmp(ws_dondatatab[0],"JA")==0) {
		ws_paiflag = 1;
	}
	if (logfil) {
		fprintf(logfil,"don_extraliste:ws_donextraidx=%hd\n",
			ws_donextraidx);
		fprintf(logfil,"don_extraliste:ws_paiflag=%hd\n",
			ws_paiflag);
	}
	return;
}

/* NYT 150625 WEBAPI30 */
/* inpfunk 100 opretsend_webapi_resnr		*/
/* ******************************************* */
static int ecw_opdaterpris(int inpfunk) {
	int retur = 0;
	int nuvidx = 0;
	int rateidx = 0;
	int funkretur = 0;
	int prisfundet = 0;
	int extraprisfundet = 0;
	int extraspecnr = 0;
	int extralnantal = 0;
	int extraantal = 0;
	int xlsstationnr = ws_station;
	long int varighed = 0;
	double dep_online = 1000;
	double dep_kontant = 2000;
	double dep_kredit = 3000;
	char xlsbrand[11] = "EC";
	char extragrp[11] = "";
	char tmpstr[81] = "";
	char idstr[21] = "";

	if (logfil) {
		fprintf(logfil,"ecw_opdaterpris %d\n",inpfunk);
		fprintf(logfil,"\tws_specnr=%hd\n",ws_specnr);
		fprintf(logfil,"\tws_grp=%s\n",ws_grp);
		fprintf(logfil,"\tws_fradato=%ld\n",ws_fradato);
		fprintf(logfil,"\tws_tildato=%ld\n",ws_tildato);
		fflush(logfil);
	}
	if (inpfunk==100) { goto opdp10; }

	r159->station_ud_nr = ws_station;
	r159->station_ind_nr = ws_tilstation;

	r159->dato_ud = ws_fradato;
	r159->forv_dato_ind = ws_tildato;
	r159->tid_ud = ws_fratid;
	r159->forv_tid_ind = ws_tiltid;

opdp10:
	xlsprismatch->uddato = r159->dato_ud;
	funkretur = nyopret_reservation(0,0,1);
	if (logfil) {
		fprintf(logfil,
		"\tNYOPRET_RESERVATION:funkretur=%hd\n",
			funkretur);
		fprintf(logfil,"\tws_lufthavnsgebyr=%.2lf\n",ws_lufthavnsgebyr);
		fprintf(logfil,"\tws_onewaygebyr=%.2lf\n",ws_onewaygebyr);
		fprintf(logfil,"\tr159->total=%.2lf\n",r159->total);
		fprintf(logfil,"\tr159->antal_dage=%ld\n",r159->antal_dage);
		fprintf(logfil,"\tr159->antal_uger=%ld\n",r159->antal_uger);
		fprintf(logfil,"\tr159->antal_maaneder=%ld\n",
			r159->antal_maaneder);
	}
	ws_lejetotal = r159->total;
	varighed = 0;
	varighed += (int)(r164->antal_maaneder * 30);
	varighed += (int)(r164->antal_uger * 7);
	varighed += (int)(r164->antal_dage);
	if (bss->id_opstart[0]>=0 && r164->antal_timer>bss->id_opstart[8]) {
		varighed++;
	}
	if (logfil) {
		fprintf(logfil,"\tvarighed=%ld\n",
			varighed);
	}
/*
	prisfundet = xlspris_findpris(1010,
		xlsbrand,
		(long)xlsstationnr,
		(long)ws_specnr,
		(int)0,
		ws_grp,
		(long)varighed,
		(long)1,
		tmpstr);
	if (logfil) {
		fprintf(logfil,"\tprisfundet=%d\n",prisfundet);
		fprintf(logfil,"\ttmpstr=%s\n",tmpstr);
	}
*/
	ws_paiflag = 0;
	rateidx = rater_next_idxnr(0);
	while (nuvidx<MAX_EXTRAPRODTAB) {
		if (!strlen(ws_extratab[nuvidx])) {
			break;
		}
		if (logfil) {
			fprintf(logfil,"\t\tws_extratab-%d=%s\n",
				nuvidx,
				ws_extratab[nuvidx]);
		}
		get_alfa_tgn(ws_extratab[nuvidx],0,idstr,59);
		get_alfa_tgn(ws_extratab[nuvidx],1,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&extraantal);
		}
		if (strcmp(idstr,"PAI")==0 && extraantal==1) {
			r159->forsikring_pai = 1;
			ws_paiflag = 1;
			nuvidx++;
			continue;
		}
		extraspecnr = 0;
		if (strlen(idstr)) {
			sscanf(idstr,"%d",&extraspecnr);
		}
		if (extraspecnr<=0) {
			nuvidx++;
			continue;
		}
		if (extraspecnr>0) {
			extraprisfundet = xlspris_findpris(1011,
				xlsbrand,
				(long)xlsstationnr,
				(long)extraspecnr,
				(int)0,
				ws_grp,
				(long)varighed,
				(long)1,
				tmpstr);
		}
		if (extraprisfundet<=0) {
			nuvidx++;
			continue;
		}
		strcpy(extragrp,xlsprissub->gruppe);
		(void)xlspris_sub_r165((long int)extraspecnr,
			(long int)0,extragrp,varighed);
		(void)xlspris_r165_r159(1,rateidx);
		r159->rate_antal[rateidx] = extraantal;
		if (r159->rate_enhed[rateidx] == 201) {
			r159->rate_antal[rateidx] *= varighed;
		}

		rateidx++;
		if (rateidx>=10) { break; }
		extralnantal++;
		nuvidx++;
	}
	if (ws_paiflag>0) {
		opsaet_forsikring(0);
	}
	if (logfil) {
		fprintf(logfil,"\textralnantal=%d\n",extralnantal);
		fprintf(logfil,"\tr159->forsikring_pai=%hd\n",
			r159->forsikring_pai);
		fprintf(logfil,"\tr159->pai_ialt=%.2lf\n",
			r159->pai_ialt);
	}
	udregn_incl();
	udregn_kontrakt((short int)0,
		(short int)0,
		(long int)0,
		(long int)0);
	ws_extratotal = r159->total - ws_lejetotal;
/* PAI */
//	if (r159->forsikring_pai>0) {
//		ws_extratotal += r159->pai_ialt;
//	}

	if (inpfunk==100) { goto opdp99; }

	alfalow(str);
	pack_init(str);
	ege_w_dou1 = r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
/*	pack_doub(ege_w_dou1); */

	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
/* Depositum */
/*	pack_doub(dep_online); */
	xls_char(tmpstr,(double)dep_online,2);
	pack_alfa(tmpstr);
/*	pack_doub(dep_kontant); */
	xls_char(tmpstr,(double)dep_kontant,2);
	pack_alfa(tmpstr);
/*	pack_doub(dep_kredit); */
	xls_char(tmpstr,(double)dep_kredit,2);
	pack_alfa(tmpstr);

/* DEPOSITUM + LEJE */
	ege_w_dou1 = dep_online;
	ege_w_dou1 += r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
/*	pack_doub(ege_w_dou1); */
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

	ege_w_dou1 = dep_kontant;
	ege_w_dou1 += r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
/*	pack_doub(ege_w_dou1); */
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

	ege_w_dou1 = dep_kredit;
	ege_w_dou1 += r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
/*	pack_doub(ege_w_dou1); */
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

	ege_w_dou1 = ws_extratotal;
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

/* NYT 121219 LEJEPRISUDENEXTRA */
	ege_w_dou1 = ws_lejetotal;
/*
	ege_w_dou1 = r159->total;
	ege_w_dou1 -= extratotal;
*/
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);


/* PLIGTOPLYSNINGER */
/*
	(void)retur_pligttekst(tmpstr);
	pack_alfa(tmpstr);
	if (ws_brandtype==0 && inpfunk==0) {
		(void)add_divpligtopl(1,ws_grp);
	}
*/
	pack_exchkend();
/* NYT 130923 DOBBELBOOKCHECK */
	strcpy(ws_dobbelbooksvar,str);
	ws_dobbelbooksvar[strlen(str)-1] = '\0';

	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
opdp99:
	retur = 1;
	return(retur);
}

/* ******************************************* */
static int don2_opdaterpris(int inpfunk) {
	short int wx1 = 0;
	short int wx2 = 0;
	short int funkretur = 0;
	short int nuvindex = 0;
	short int ptabindex = 0;
	short int ecflag = 0;
	short int okflag = 0;
	short int donleasing = 0;
	short int extratabtype = 6;
	short int idxnr = 0;
	short int xlsmainflag = 0;
	int nuvantal = 0;
	int springtgn = 0;
	double dep_online = 0;
	double dep_kontant = 0;
	double dep_kredit = 0;
	double extratotal = 0;
	double totalexclpromo = 0;
	long int keynum = 0;
	long int keynumv = 0;
	long int varighed = 0;
	long int kundevarighed = 0;
	long int xlsvarighed = 0;
	long int returvarighed = 0;
	long int julian = 0;
	char idstr[41] = "";
	char datastr[41] = "";
	char tmpstr[301] = "";

/* TEST */
	if (logfil) {
		fprintf(logfil,"don2_opdaterpris:inpfunk=%d\n",inpfunk);
		fprintf(logfil,"\tws_specnr=%hd\n",ws_specnr);
		fprintf(logfil,"\tws_extspcstr=%s\n",ws_extspcstr);
		fprintf(logfil,"\tws_grp=%s\n",ws_grp);
		fprintf(logfil,"\tws_fradato=%ld\n",ws_fradato);
		fprintf(logfil,"\tws_tildato=%ld\n",ws_tildato);
		fflush(logfil);
	}
/* NYT 141021 PSWEEKENDVARIGHEDJUSTERING */
	julian = m036_funktion(12, ws_fradato);
	kundevarighed = m036_funktion(12, ws_tildato);
	kundevarighed -= julian;

        varighed = beregn_varighed(ws_station,
		ws_grp,
		ws_specnr,
		ws_extspcstr);
	if (inpfunk==0 && ws_funktion==5) {
		extratabtype = 2;
	}
/* NYT 130107 */
	if (inpfunk==0 && ws_funktion==21) {
		extratabtype = 2;
	}
/* NYT 121105 */
	if (inpfunk==1) {
		extratabtype = 2;
	}
	if (logfil) {
		fprintf(logfil,"\tvarighed=%ld\n",varighed);
		fprintf(logfil,"\textratabtype=%hd\n",extratabtype);
	}
/* NYT 141010 PSWEEKENDVARIGHEDSNYD */
/*
	if (inpfunk==0 && ws_brandtype==4 && ws_funktion==5) {
		sprintf(tmpstr,"PS%5.5ld%5.5ldSTD.main",
			(long int)ws_station,
			(long int)ws_specnr);
		xlsmainflag = xlspris_udpakmain(tmpstr);
	}
	if (logfil) {
		fprintf(logfil,"\txlsmainflag=%d\n",xlsmainflag);
	}
	if (xlsmainflag>0 && varighed<xlsprismain->varighed_ival[0]) {
		xlsvarighed = xlsprismain->varighed_ival[0];
	}
	if (xlsvarighed>0 && xlsvarighed>varighed) {
		varighed = xlsvarighed;
	}
	if (logfil) {
		fprintf(logfil,"\txlsvarighed=%ld\n",xlsvarighed);
		fprintf(logfil,"\tvarighed=%ld\n",varighed);
	}
*/

/*
	for (wx1=0;wx1<2;wx1++) {
		wx2 = get_alfa_tgn(ws_donspcstr,wx1,tmpstr,';');
		if (wx2<=0) {
			break;
		}
		if (wx1==0 && strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&ws_specnr);
		}
		if (wx1==1 && strlen(tmpstr)) {
			strcpy(ws_extspcstr,tmpstr);
		}
	}
*/
	nuvindex = 0;
	while (logfil && nuvindex<MAX_EXTRAPRODTAB) {
		fprintf(logfil,"\tws_extratab-%hd <%s>\n",
			nuvindex,ws_extratab[nuvindex]);
		nuvindex++;
	}
	nuvindex = 0;
	while (logfil && nuvindex<MAX_EXTRAPRODTAB) {
		if (!strlen(extraptab[nuvindex].id)) {
			nuvindex++;
			continue;
		}
		fprintf(logfil,
	"\textraptab-%hd .id=%s .nuvantal=%d .enhpris=%.2lf .totpris=%.2lf\n",
			nuvindex,
			extraptab[nuvindex].id,
			extraptab[nuvindex].nuvantal,
			extraptab[nuvindex].enhedpris,
			extraptab[nuvindex].totalpris);
		nuvindex++;
	}
	if (logfil) {
		fprintf(logfil,"\tOPDATER\n");
		fflush(logfil);
	}
	ws_paiflag = 0;
	nuvindex = 0;
	while (nuvindex<MAX_EXTRAPRODTAB) {
		if (!strlen(ws_extratab[nuvindex])) {
			nuvindex++;
			continue;
		}
/* NYT 121017 */
		if (extratabtype==2) {
			idxnr = 0;
		}
		(void)get_alfa_tgn(ws_extratab[nuvindex],idxnr,idstr,';');
		if (strlen(idstr)) {
			ptabindex = retur_ptabmatch(idstr);
		}
		if (logfil) {
			fprintf(logfil,"\t\tnuvindex=%hd ptabindex=%hd\n",
				nuvindex,ptabindex);
			fflush(logfil);
		}
		if (ptabindex<0) {
			nuvindex++;
			continue;
		}

		strcpy(tmpstr,"");
		nuvantal = extraptab[ptabindex].nuvantal;
		idxnr = 4;
		if (extratabtype==2) {
			idxnr = 1;
		}
		(void)get_alfa_tgn(ws_extratab[nuvindex],idxnr,tmpstr,';');
		springtgn = 0;
/* NYT 140430 KMPAKKE */
		if (strlen(tmpstr) && strncmp(tmpstr,"KM",2)==0) {
			springtgn = 2;
			strcpy(extraptab[ptabindex].dropdownextra,tmpstr);
		}
		if (strlen(tmpstr) && strncmp(tmpstr,"SRN",3)==0) {
			springtgn = 3;
			strcpy(extraptab[ptabindex].dropdownextra,tmpstr);
		}
/* NYT 140822 FLYTTEKASSERXLS */
		if (strlen(tmpstr) && strncmp(tmpstr,"FLK",3)==0) {
			springtgn = 3;
			strcpy(extraptab[ptabindex].dropdownextra,tmpstr);
		}

		if (strlen(tmpstr)) {
			sscanf(tmpstr+springtgn,"%d",&nuvantal);
		}
		if (nuvantal>extraptab[ptabindex].maxantal) {
			nuvantal = extraptab[ptabindex].maxantal;
		}
		extraptab[ptabindex].nuvantal = nuvantal;
		if (strcmp(extraptab[ptabindex].id,"980")==0) {
			(void)juster_extraptab(2,ptabindex,varighed);
		}
		(void)beregn_extraptab((int)ptabindex,varighed);
		if (strcmp(extraptab[ptabindex].id,"PAI")==0 &&
			extraptab[ptabindex].nuvantal>0) {
                	ws_paiflag = 1;
		}
/* NYT 140306 CO996MAX180 */
/*
		if (strcmp(extraptab[ptabindex].id,"996")==0 &&
			ws_brandtype==3) {

		}
*/
		nuvindex++;
	}

	nuvindex = 0;
	while (logfil && nuvindex<MAX_EXTRAPRODTAB) {
		if (!strlen(extraptab[nuvindex].id)) {
			nuvindex++;
			continue;
		}
		fprintf(logfil,
"\textraptab-%hd .id=%s .nuvantal=%d .enhpris=%.2lf .totpris=%.2lf .dropdownextra=%s\n",
			nuvindex,
			extraptab[nuvindex].id,
			extraptab[nuvindex].nuvantal,
			extraptab[nuvindex].enhedpris,
			extraptab[nuvindex].totalpris,
			extraptab[nuvindex].dropdownextra);
		nuvindex++;
	}
	if (logfil) {
		fprintf(logfil,"\tws_paiflag=%hd\n",ws_paiflag);
	}
	funkretur = nyopret_reservation(inpfunk,0,0);
	if (logfil) {
		fprintf(logfil,
		"\tdon2_opdaterpris:NYOPRET_RESERVATION:funkretur=%hd\n",
			funkretur);
		fprintf(logfil,
		"\tdon2_opdaterpris:r159->total=%.2lf\n",
			r159->total);
		fprintf(logfil,
		"\tdon2_opdaterpris:r159->pai_ialt=%.2lf\n",
			r159->pai_ialt);
	}
	if (inpfunk==1 && funkretur<=0) {
		return(0);
	}
/* DONWEB DON_WEB */
	if (inpfunk==1) {
/* NYT 130124 KONTROLGODK */
		opdat_don_wgk(1,r159->record_x);

		sprintf(ws_donorderid,"%ld",r159->record_x);
		sprintf(ws_tmppara,"don_%8.8ld.web",r159->record_x);
		tmpfil = fopen(ws_tmppara,"w");
		if (tmpfil) {
			fprintf(tmpfil,"%lu\n",ws_startsek);
			fprintf(tmpfil,"%hd\n",ege_pid);
			fprintf(tmpfil,"%s\n",ws_donorderid);
			fclose(tmpfil);
			(void)chmod(ws_tmppara,0777);
		}
		tmpfil = (FILE*)0;
	}
	nuvindex = 0;
	while (logfil && nuvindex<MAX_EXTRAPRODTAB) {
		if (!strlen(extraptab[nuvindex].id)) {
			nuvindex++;
			continue;
		}
		fprintf(logfil,
"\textraptab-%hd .id=%s .nuvantal=%d .enhpris=%.2lf .totpris=%.2lf\n",
			nuvindex,
			extraptab[nuvindex].id,
			extraptab[nuvindex].nuvantal,
			extraptab[nuvindex].enhedpris,
			extraptab[nuvindex].totalpris);
		nuvindex++;
	}

/* DON2DEPOSITUM */
	dep_online = 0;
	dep_kontant = 0;
	dep_kredit = 0;
	keynum = (long int)r159->rate_spec_nr[0];
	keynum *= 1000;
	keynum += (long int)r159->station_ud_nr;
/* NYT 101007 DEPOSITUM VAREVOGN */
	keynumv = 0;
	if (strcmp(ws_grp,"3")==0) {
		keynumv = (long int)r159->rate_spec_nr[0];
		keynumv *= (long int)1000;
		keynumv += (long int)r159->station_ud_nr;
		keynumv *= (long int)100;
		keynumv += (long int)3;
	}
	if (r159->rate_spec_nr[0]==199) { donleasing = 1; }
	if (r159->rate_spec_nr[0]==656) { donleasing = 1; }
/* TEST */
	if (logfil) {
		fprintf(logfil,"\tkeynum=%ld\n",
			keynum);
		fprintf(logfil,"\tkeynumv=%ld,donleasing=%hd\n",
			keynumv,
			donleasing);
		fflush(logfil);
	}

	ege_w_dou1 = 0;
	funkretur = find_r198(1,16523,(double)keynum,"",0);
	if (funkretur>0 && r198->numfelt>0) {
		ege_w_dou1 = r198->numfelt;
	}
	if (keynumv>0) {
		funkretur = find_r198(1,16523,(double)keynumv,"",0);
		if (funkretur>0 && r198->numfelt>0) {
			ege_w_dou1 = r198->numfelt;
		}
	}
	dep_online = ege_w_dou1;
/* NYT 131210 DEPONLINEOBS */
	if (ws_brandtype==4 && dep_online==0) {
		dep_online = 1000;
	}
	if (logfil) {
		fprintf(logfil,"\tdep_online=%.2lf\n",
			dep_online);
		fflush(logfil);
	}
	ege_w_dou1 = 0;
/* NYT 071003 KREDITKORT */
	ege_w_dou1 = 2000;
	if (donleasing>0) {
		ege_w_dou1 = dep_online;
	}
/* AKTIVERET 131104 DEPOSITUM */
	funkretur = find_r198(1,16524,(double)keynum,"",0);
	if (funkretur>0 && r198->numfelt>0) {
		ege_w_dou1 = r198->numfelt;
	}
	if (keynumv>0) {
		funkretur = find_r198(1,16524,(double)keynumv,"",0);
		if (funkretur>0 && r198->numfelt>0) {
			ege_w_dou1 = r198->numfelt;
		}
	}
	dep_kredit = ege_w_dou1;
	if (logfil) {
		fprintf(logfil,"\tdep_kredit=%.2lf\n",
			dep_kredit);
		fflush(logfil);
	}
	ege_w_dou1 = 0;
/* NYT 071003 KONTANT */
	ege_w_dou1 = 3000;
	if (donleasing>0) {
		ege_w_dou1 = dep_online;
	}

/* AKTIVERET 131104 DEPOSITUM */
	funkretur = find_r198(1,16525,(double)keynum,"",0);
	if (funkretur>0 && r198->numfelt>0) {
		ege_w_dou1 = r198->numfelt;
	}
	if (keynumv>0) {
		funkretur = find_r198(1,16525,(double)keynumv,"",0);
		if (funkretur>0 && r198->numfelt>0) {
			ege_w_dou1 = r198->numfelt;
		}
	}
	dep_kontant = ege_w_dou1;
	if (logfil) {
		fprintf(logfil,"\tdep_kontant=%.2lf\n",
			dep_kontant);
		fflush(logfil);
	}
/* NYT 140929 PSWEEKENDPRISFEJL 50003 */
	if (r159->total<=0) {
		ws_don2errno = DON2STP5PRODUK;
	}
	if (logfil) {
		fprintf(logfil,
			"\tws_don2errno=%ld\n",ws_don2errno);
	}
/*
	if (ws_don2errno>0) {
		ws_funkretur2 = frankly_err(ws_funktion,
			"fejl",ws_don2errno);
		return(0);
	}
*/
	if (ws_don2errno>0) {
		return(0);
	}

	alfalow(str);
	pack_init(str);
	if (inpfunk==1) {
		pack_alfa(ws_donorderid);
	}
	ege_w_dou1 = r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
/*	pack_doub(ege_w_dou1); */

/* OBS PROMODKK */
	totalexclpromo = ege_w_dou1;
/* NYT 140121 PSPROMO */
	if (ws_funktion==21 && ws_brandtype==4 && ws_promotype==1) {
		ws_promobeloeb = ws_promotabel[ws_promotype];
		ege_w_dou1 -= ws_promobeloeb;
	}
/* NYT 140428 PSPROMOSUBMIT */
	if (ws_funktion==10 && ws_brandtype==4 && ws_promotype==1) {
		ws_promobeloeb = ws_promotabel[ws_promotype];
		ege_w_dou1 -= ws_promobeloeb;
	}
/* NYT 140825 PSPROMOPCT */
	if (ws_funktion==21 && ws_brandtype==4 && ws_donpromotype==1) {
		ws_promobeloeb = ws_donpromototalbeloeb;
		ege_w_dou1 -= ws_promobeloeb;
	}
	if (ws_funktion==10 && ws_brandtype==4 && ws_donpromotype==1) {
		ws_promobeloeb = ws_donpromototalbeloeb;
/*
		ege_w_dou1 -= ws_promobeloeb;
*/
	}

	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
/* Depositum */
/*	pack_doub(dep_online); */
	xls_char(tmpstr,(double)dep_online,2);
	pack_alfa(tmpstr);
/*	pack_doub(dep_kontant); */
	xls_char(tmpstr,(double)dep_kontant,2);
	pack_alfa(tmpstr);
/*	pack_doub(dep_kredit); */
	xls_char(tmpstr,(double)dep_kredit,2);
	pack_alfa(tmpstr);

/* DEPOSITUM + LEJE */
	ege_w_dou1 = dep_online;
	ege_w_dou1 += r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
/*	pack_doub(ege_w_dou1); */
/* NYT 140121 PSPROMO */
	if (ws_funktion==21 && ws_brandtype==4 && ws_promotype==1) {
		ege_w_dou1 -= ws_promobeloeb;
	}
/* NYT 140428 PSPROMOSUBMIT */
	if (ws_funktion==10 && ws_brandtype==4 && ws_promotype==1) {
		ege_w_dou1 -= ws_promobeloeb;
	}
/* NYT 140825 PSPROMOPCT */
	if (ws_funktion==21 && ws_brandtype==4 && ws_donpromotype==1) {
		ege_w_dou1 -= ws_promobeloeb;
	}
	if (ws_funktion==10 && ws_brandtype==4 && ws_donpromotype==1) {
		ege_w_dou1 -= ws_promobeloeb;
	}

	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

	ege_w_dou1 = dep_kontant;
	ege_w_dou1 += r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
/*	pack_doub(ege_w_dou1); */
/* NYT 140121 PSPROMO */
	if (ws_funktion==21 && ws_brandtype==4 && ws_promotype==1) {
		ege_w_dou1 -= ws_promobeloeb;
	}
/* NYT 140428 PSPROMOSUBMIT */
	if (ws_funktion==10 && ws_brandtype==4 && ws_promotype==1) {
		ege_w_dou1 -= ws_promobeloeb;
	}
/* NYT 140825 PSPROMOPCT */
	if (ws_funktion==21 && ws_brandtype==4 && ws_donpromotype==1) {
		ege_w_dou1 -= ws_promobeloeb;
	}
/*
	if (ws_funktion==10 && ws_brandtype==4 && ws_donpromotype==1) {
		ege_w_dou1 -= ws_promobeloeb;
	}
*/

	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

	ege_w_dou1 = dep_kredit;
	ege_w_dou1 += r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
/*	pack_doub(ege_w_dou1); */
/* NYT 140121 PSPROMO */
	if (ws_funktion==21 && ws_brandtype==4 && ws_promotype==1) {
		ege_w_dou1 -= ws_promobeloeb;
	}
/* NYT 140428 PSPROMOSUBMIT */
	if (ws_funktion==10 && ws_brandtype==4 && ws_promotype==1) {
		ege_w_dou1 -= ws_promobeloeb;
	}
/* NYT 140825 PSPROMOPCT */
	if (ws_funktion==21 && ws_brandtype==4 && ws_donpromotype==1) {
		ege_w_dou1 -= ws_promobeloeb;
	}
/*
	if (ws_funktion==10 && ws_brandtype==4 && ws_donpromotype==1) {
		ege_w_dou1 -= ws_promobeloeb;
	}
*/

	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

	nuvindex = 0;
	ege_w_dou1 = 0;
/*
	if (r159->forsikring_pai>0) {
		ege_w_dou1 = r159->pai_ialt;
	}
*/
	while (nuvindex<MAX_EXTRAPRODTAB) {
		if (logfil) {
			fprintf(logfil,"\t\textraptab-%hd=%s\n",
				nuvindex,
				extraptab[nuvindex].id,
				extraptab[nuvindex].totalpris);
		}
		if (!strlen(extraptab[nuvindex].id)) {
			nuvindex++;
			continue;
		}
		ege_w_dou1 += extraptab[nuvindex].totalpris;
		nuvindex++;
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,"\tEXTRATOTALege_w_dou1=%.2lf\n",ege_w_dou1);
	}
	extratotal = ege_w_dou1;
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

/* RETTET 121018
	nuvindex = 0;
	while (nuvindex<MAX_EXTRAPRODTAB) {
		if (!strlen(extraptab[nuvindex].id)) {
			nuvindex++;
			continue;
		}
		pack_alfa(extraptab[nuvindex].id);
		pack_alfa(extraptab[nuvindex].beskrivelse);
		pack_alfa(extraptab[nuvindex].enhedtxt);
		ege_w_dou1 = extraptab[nuvindex].enhedpris;
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);
		pack_int2((long)extraptab[nuvindex].nuvantal);
		pack_int2((long)extraptab[nuvindex].minantal);
		pack_int2((long)extraptab[nuvindex].maxantal);
		pack_alfa(extraptab[nuvindex].valgtype);
		ege_w_dou1 = extraptab[nuvindex].totalpris;
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);
		nuvindex++;
	}
*/
/* NYT 121121 PROMOTION */
	if (ws_funktion==21 && ws_brandtype==3) {
		sprintf(tmpstr, "Tillykke...Promotionkode accepteret");
/* NYT 140306 PROMOSTYR */
		if (strlen(ws_donpromoretur)) {
			strcpy(tmpstr,ws_donpromoretur);
		}
		pack_alfa(tmpstr);
/* NYT 121121 PLIGTTEKST */
		(void)retur_pligttekst(tmpstr);
/* NYT 140307 PROMOSTYR2 */
		if (strlen(ws_donpromoretur)) {
			sprintf(dum_str," (%s)",ws_donpromoretur);
			strcat(tmpstr,dum_str);
		}
		pack_alfa(tmpstr);
	}
/* NYT 131219 PSPROMO */
	if (ws_funktion==21 && ws_brandtype==4 && ws_promotype==1) {
		xls_char(tmpstr,(double)ws_promobeloeb,2);
		sprintf(ws_promotxt,"Gavekort...tillykke...DKK %s",tmpstr);
	}
/* NYT 140825 PSPROMOPCT */
	if (ws_funktion==21 && ws_brandtype==4 && ws_donpromotype==1) {
		xls_char(tmpstr,(double)ws_promobeloeb,2);
		sprintf(ws_promotxt,"%s...DKK %s",ws_donpromoretur,tmpstr);
	}

	if (logfil) {
		fprintf(logfil,"\textratotal=%.2lf\n",extratotal);
		fprintf(logfil,"\tws_promotype=%d\n",ws_promotype);
		fprintf(logfil,"\tws_promobeloeb=%.2lf\n",ws_promobeloeb);
		fprintf(logfil,"\tws_promotxt=%s\n",ws_promotxt);
	}
/* NYT 121219 LEJEPRISUDENEXTRA */
	ege_w_dou1 = r159->total;
	ege_w_dou1 -= extratotal;
/* NYT 131219 PSPROMO */
	if (ws_funktion==21 && ws_brandtype==4 && ws_promobeloeb>0) {
		ege_w_dou1 -= ws_promobeloeb;
	}
/* NYT 140428 PSPROMOSUBMIT */
/*
	if (ws_funktion==10 && ws_brandtype==4 && ws_promobeloeb>0) {
		ege_w_dou1 -= ws_promobeloeb;
	}
*/

	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

/* NYT 131206 PSUPDATE */
	okflag = 0;
	if (ws_funktion==5) { okflag++; }
	if (ws_funktion==21) { okflag++; }
/* NYT 140401 PSBOOKSTATUS PSREQUEST */
	ws_psbookstatus = 1;
	if (ws_brandtype==4 && inpfunk==0 && okflag>0) {
		ws_requestflag = check_requestflag(1,varighed);
	}
	if (ws_brandtype==4 && inpfunk==0 && okflag>0 && ws_requestflag>0) {
		ws_psbookstatus = 2 + ws_requestflag;
	}
/* NYT 140508 REQUESTMNR TEST SNYD J9D
	if (strcmp(ws_grp,"J9D")==0) {
		ws_psbookstatus = 4;
	}
*/
	if (logfil) {
		fprintf(logfil,
		"\tPSREQUEST ws_requestflag=%d ws_psbookstatus=%d\n",
			ws_requestflag,
			ws_psbookstatus);
	}
/* NYT 140512 */
	if (ws_brandtype==4 && inpfunk==0 && okflag>0) {
		ws_requestflag = check_requeststyr(1,
			ws_station,
			ws_biltype,
			ws_grp,
			r159->dato_ud);
		if (ws_requestflag>0) {
			ws_psbookstatus = 2 + ws_requestflag;
		}
	}
	if (logfil) {
		fprintf(logfil,
	"\tPSREQUEST check_requeststyr ws_requestflag=%d ws_psbookstatus=%d\n",
			ws_requestflag,
			ws_psbookstatus);
	}

	if (ws_brandtype==4 && inpfunk==0 && okflag>0) {
/* PSBOOKSTATUS Bookstatus */
		pack_int2((long)ws_psbookstatus);
		strcpy(tmpstr,"Ok");
		if (ws_psbookstatus==3) {
			strcpy(tmpstr,"Request");
		}
		if (ws_psbookstatus==4) {
			strcpy(tmpstr,"Request m. nr");
		}
		pack_alfa(tmpstr);

		sprintf(idstr,"%hd",ws_specnr);
		(void)add_psbetalinginfo(2,idstr,varighed);
/* NYT 131211 PSPRDAG */
/* pris pr dag PrisPrDag */
		ege_w_dou1 = r159->total;
/*		ege_w_dou1 -= r159->pai_ialt; */
		if (ws_funktion==21 && ws_brandtype==4 && ws_promobeloeb>0) {
			ege_w_dou1 -= ws_promobeloeb;
		}
		ege_w_dou1 /= (double)varighed;
/*		pack_doub(ege_w_dou1); */
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);
	}
	if (ws_brandtype==4 && inpfunk==0 && ws_funktion==21) {
/* NYT 140121 PSPROMO */
		ege_w_dou1 = ws_promobeloeb;
		ege_w_dou1 *= -1;

		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);
		pack_alfa(ws_promotxt);
/* NYT 140121 PSPROMO */
		ege_w_dou1 = totalexclpromo;
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);
	}
/* NYT 140411 PLIGTTEKSTFUNK_5_21 */
	if (ws_brandtype==4 && inpfunk==0) {
		(void)retur_pligttekst(tmpstr);
		pack_alfa(tmpstr);
	}
/* NYT 140430 PLIGTOPLOPDAT */
	if (ws_brandtype==4 && inpfunk==0) {
		(void)add_divpligtopl(1,ws_grp);
	}
/* NYT 141021 PSWEEKENDVARIGHEDJUSTERING */
	returvarighed = varighed;
	if (kundevarighed<varighed) {
		returvarighed = kundevarighed;
	}
	if (logfil) {
		fprintf(logfil,
	"\tPSVARIGHED varighed=%ld kundevarighed=%ld\n",
			varighed,
			kundevarighed);
	}
/* NYT 140709 PSDAGEKMANTAL */
	if (ws_brandtype==4 && inpfunk==0 && ws_funktion==5) {
		sprintf(tmpstr,"%ld",returvarighed);
/* RETTET 141021
		sprintf(tmpstr,"%ld",varighed);
*/
		pack_alfa(tmpstr);
		ege_w_int1 = r159->rate_incl_km[10];
		sprintf(tmpstr,"%ld",ege_w_int1);
		pack_alfa(tmpstr);
	}
/* NYT 140819 PSUPDATEPRODNAVN */
	if (ws_brandtype==4 && inpfunk==0 && ws_funktion==5) {
		strcpy(tmpstr,"Produktnavn");
		sprintf(idstr,"%hd",ws_specnr);
		(void)opbyg_psproduktnavn(-1,idstr,tmpstr);
		pack_alfa(tmpstr);
	}

	pack_exchkend();
/* NYT 130923 DOBBELBOOKCHECK */
	strcpy(ws_dobbelbooksvar,str);
	ws_dobbelbooksvar[strlen(str)-1] = '\0';
	send_linie();
	if (logfil) {
		fprintf(logfil, "SENDT:str=%s", str);
		fflush(logfil);
	}
	return(1);
}

/* NYT 140430 PLIGTOPLOPDAT */
/* ************************************************************ */
/* inpfunk 1 selvrisiko + udv					*/
static int add_divpligtopl(int inpfunk,char *inpgrp) {
	int retur = 0;
	int idx = 0;
	char tmpstr[301] = "";
	char udvstr[201] = "";
	char prisstr[21] = "";
	double selvrisiko = 3500;
	double udvselvrisiko = 0;

	idx = 0;
	while (idx<10) {
		if (r159->rate_spec_nr[idx]==947 && r159->rate_antal>0) {
			selvrisiko = 1000;
		}
		idx++;
	}
	ege_w_dou1 = selvrisiko;
	egeedit(ege_w_dou1,"z.zz9",prisstr);
/*
	xls_char(prisstr,(double)ege_w_dou1,2);
*/
        sprintf(tmpstr,"Selvrisiko %s kr.",prisstr);
/* RETTET 140514
        sprintf(tmpstr,"Selvrisiko DKK %s.",prisstr);
*/
/* NYT 140509 UDVSELVRISIKO */
	if (strcmp(inpgrp,"4")==0) { udvselvrisiko = 7000; }
	if (strcmp(inpgrp,"4+")==0) { udvselvrisiko = 7000; }
	if (strcmp(inpgrp,"5+")==0) { udvselvrisiko = 7000; }
	if (strcmp(inpgrp,"7")==0) { udvselvrisiko = 7000; }
	if (strcmp(inpgrp,"8")==0) { udvselvrisiko = 7000; }
	if (udvselvrisiko>0) {
		ege_w_dou1 = udvselvrisiko;
		egeedit(ege_w_dou1,"z.zz9",prisstr);
        	sprintf(udvstr," Udvidet selvrisiko %s kr. (skader på forhøjet tagkonstruktion, alukasse eller lift).",prisstr);
		strcat(tmpstr,udvstr);
	}
	pack_alfa(tmpstr);

	return(retur);
}

/* ******************************************************** */
/* inpfunk 1 don2_opdaterpris(0)			*/
static int check_requestflag(int inpfunk,long inpvarighed) {
	int retur = 0;
	int funkretur = 0;
	int nuvindex = 0;
	int styrprodukt = 0;
	int styrstation = 0;
	int requestfundet = 0;
	long int varighed = 0;
	char gruppe[21] = "";
	char brandid[21] = "";
	char xlsfilid[41] = "";

	if (logfil) {
		fprintf(logfil,"check_requestflag %d %ld\n",
			inpfunk,
			inpvarighed);
	}
	nuvindex = 0;
	while (nuvindex<10 && logfil) {
		fprintf(logfil,
	"\t\trate_spec_nr-%d=%hd _station=%hd _enhed=%hd _gruppe=<%s>\n",
			nuvindex,
			r159->rate_spec_nr[nuvindex],
			r159->rate_station[nuvindex],
			r159->rate_enhed[nuvindex],
			r159->rate_gruppe[nuvindex]);
		nuvindex++;
	}
	if (ws_brandtype==4) {
		strcpy(brandid,"PS");
	}
	nuvindex = 0;
	while (nuvindex<10) {
		if (styrprodukt==0 && r159->rate_spec_nr[nuvindex]>0) {
			styrprodukt = r159->rate_spec_nr[nuvindex];
		}
		if (styrstation==0 && r159->rate_station[nuvindex]>0) {
			styrstation = r159->rate_station[nuvindex];
		}
		if (r159->rate_antal[nuvindex]<=0) {
			nuvindex++;
			continue;
		}
		xlsprismatch->xtraantal = 0;
		xlsprismatch->lbnr = 0;
		xlsprismatch->xtraflag = 0;
		xlsprismatch->specnr = r159->rate_spec_nr[nuvindex];
		varighed = inpvarighed;
		strcpy(gruppe,"");
		if (r159->rate_enhed[nuvindex]<200) {
			xlsprismatch->xtraantal = r159->rate_antal[nuvindex];
			varighed = 0;
		}
		if (r159->rate_spec_nr[nuvindex]>=900) {
			xlsprismatch->xtraflag = 1;
		}
		if (styrprodukt>0 && styrstation>0 &&
			xlsprismatch->xtraflag<=0) {
			strcpy(gruppe,r159->rate_gruppe[nuvindex]);
		}
		if (styrprodukt>0 && styrstation>0 &&
			xlsprismatch->xtraflag<=0) {
			sprintf(xlsfilid,"%s%5.5d%5.5dSTD.spec",
				brandid,
				styrstation,
				styrprodukt);
		}
		if (styrprodukt>0 && styrstation>0 &&
			xlsprismatch->xtraflag>0) {
			sprintf(xlsfilid,"%s%5.5d%5.5dSTD.xtra",
				brandid,
				styrstation,
				styrprodukt);
		}
		if (styrprodukt>0 && styrstation>0) {
			funkretur = xlspris_udpaksub(xlsfilid,
				gruppe,
				(long int)varighed);
		}
		if (styrprodukt>0 && styrstation>0 &&
			funkretur>0 &&
			xlsprissub->frgspgflag>requestfundet) {
			requestfundet=xlsprissub->frgspgflag;
		}
		nuvindex++;
	}
	if (logfil) {
		fprintf(logfil,"\trequestfundet=%d\n",
			requestfundet);
	}
	if (requestfundet>0) {
		retur = requestfundet;
	}
/* RETTET 140416
	nuvindex = 0;
	while (nuvindex<MAX_EXTRAPRODTAB) {
		if (!strlen(extraptab[nuvindex].id)) {
			nuvindex++;
			continue;
		}
		if (strcmp(extraptab[nuvindex].id,"901")==0 &&
			extraptab[nuvindex].nuvantal>0) {
			retur = 1;
		}
		nuvindex++;
	}
*/
	if (logfil) {
		fprintf(logfil,"check_requestflag retur=%d\n",retur);
	}
	return(retur);
}

/* **************************************** */
static int check_requeststyr(int inpfunk,int inpstnr,char *inptype,char *inpgrp,long inpdatoud) {
	int retur = 0;
	int lnnr = 0;
	int weekendfraflag = 0;
	int weekendtilflag = 0;
	int dtudweekendflag = 0;
	char chkgrp[21] = "";
	char chktype[21] = "";
	int chkstation = 0;
	int oktabel[10] = {0,0,0,0,0,0,0,0,0,0};
	char felttab[10][21] = {"","","","","","","","","",""};
	long int chkfradtud = 0;
	long int chktildtud = 0;
	long int returdato = 0;
	char tmpstr[81] = "";
	char inpstr[81] = "";
	FILE *tmpfil;

	tmpfil = (FILE*)0;
	if (logfil) {
		fprintf(logfil,"check_requeststyr %d %d %s %s %ld\n",
			inpfunk,
			inpstnr,
			inptype,
			inpgrp,
			inpdatoud);
	}
	dtudweekendflag = 0;
	returdato = m036_funktion(11, inpdatoud);
	if (returdato%10==5) { dtudweekendflag = 1; }
	if (returdato%10==6) { dtudweekendflag = 1; }
	if (returdato%10==7) { dtudweekendflag = 1; }
	if (logfil) {
		fprintf(logfil,"\tdtudweekendflag=%d\n",dtudweekendflag);
	}
	strcpy(inpstr,"");
	if (inpfunk==1) {
		sprintf(inpstr,"requeststyr.ps");
	}
	if (!strlen(inpstr)) {
		goto afslut;
	}
	tmpfil = fopen(inpstr,"r");
	if (!tmpfil) {
		tmpfil = (FILE*)0;
		goto afslut;
	}
	while (tmpfil && retur==0) {
		lnnr++;
		if (!fgets(inpstr,80,tmpfil)) { break; }
		if (inpstr[0]=='#') { continue; }
		sscanf(inpstr,"%s %s %s %s %s",
			felttab[0],
			felttab[1],
			felttab[2],
			felttab[3],
			felttab[4]);
		ege_toupper((unsigned char *)felttab[1]);
		ege_toupper((unsigned char *)felttab[2]);
		ege_toupper((unsigned char *)felttab[3]);
		ege_toupper((unsigned char *)felttab[4]);
		chkstation = 0;
		strcpy(chktype,"");
		strcpy(chkgrp,"");
		chkfradtud = -1;
		chktildtud = -1;
		oktabel[0] = 0;
		oktabel[1] = 0;
		oktabel[2] = 0;
		oktabel[3] = 0;
		oktabel[4] = 0;
		oktabel[5] = 0;
		oktabel[6] = 0;
		oktabel[7] = 0;
		oktabel[8] = 0;
		oktabel[9] = 0;
		weekendfraflag = 0;
		weekendtilflag = 0;

		if (strcmp(felttab[0],"*")==0) { oktabel[0]=1; }
		if (strcmp(felttab[0],"0")==0) { oktabel[0]=1; }
		if (strcmp(felttab[1],"*")==0) { oktabel[1]=1; }
		if (strcmp(felttab[2],"*")==0) { oktabel[2]=1; }
		if (strcmp(felttab[3],"*")==0) { oktabel[3]=1; }
		if (strcmp(felttab[4],"*")==0) { oktabel[4]=1; }
		if (oktabel[0]==0 && strlen(felttab[0])) {
			sscanf(felttab[0],"%d",&chkstation);
		}
		if (chkstation==inpstnr) {
			oktabel[0] = 1;
		}
		if (oktabel[1]==0 && strlen(felttab[1])) {
			strcpy(chktype,felttab[1]);
		}
		if (!strlen(inptype)) {
			oktabel[1] = 1;
		}
		if (strcmp(inptype,chktype)==0) {
			oktabel[1] = 1;
		}
		if (oktabel[2]==0 && strlen(felttab[2])) {
			strcpy(chkgrp,felttab[2]);
		}
		if (strcmp(inpgrp,chkgrp)==0) {
			oktabel[2] = 1;
		}
/* NYT 140519 REQUESTSTYRWEEKEND */
		if (strncmp(felttab[3],"WEEKEND",7)==0) {
			weekendfraflag = 1;
		}
		if (oktabel[3]==0 && strlen(felttab[3]) && weekendfraflag<=0) {
			sscanf(felttab[3],"%ld",&chkfradtud);
		}
		if (oktabel[3]==0 && strlen(felttab[3]) && weekendfraflag>0) {
			sscanf(felttab[3]+7,"%ld",&chkfradtud);
		}
/* NYT 140519 REQUESTSTYRWEEKEND */
		if (strncmp(felttab[4],"WEEKEND",7)==0) {
			weekendtilflag = 1;
		}
		if (oktabel[4]==0 && strlen(felttab[4]) && weekendtilflag<=0) {
			sscanf(felttab[4],"%ld",&chktildtud);
		}
		if (oktabel[4]==0 && strlen(felttab[4]) && weekendtilflag>0) {
			sscanf(felttab[4]+7,"%ld",&chktildtud);
		}

		if (inpdatoud>=chkfradtud && inpdatoud<=chktildtud) {
			oktabel[3] = 1;
			oktabel[4] = 1;
		}
/* NYT 140519 REQUESTSTYRWEEKEND */
		if (weekendfraflag>0 && dtudweekendflag<=0) {
			oktabel[3] = 0;
		}
		if (weekendtilflag>0 && dtudweekendflag<=0) {
			oktabel[4] = 0;
		}

		if (logfil) {
			fprintf(logfil,"\t\tlnnr=%d\n",lnnr);
			fprintf(logfil,"\t\tweekend fra=%d til=%d\n",
				weekendfraflag,
				weekendtilflag);
			fprintf(logfil,"\t\toktabel=%d %d %d %d %d\n",
				oktabel[0],
				oktabel[1],
				oktabel[2],
				oktabel[3],
				oktabel[4]);
			fprintf(logfil,"\t\tfelttab=%s %s %s %s %s\n",
				felttab[0],
				felttab[1],
				felttab[2],
				felttab[3],
				felttab[4]);
			fprintf(logfil,"\t\tchk=%d %s %s %ld %ld\n",
				chkstation,
				chktype,
				chkgrp,
				chkfradtud,
				chktildtud);
		}
		if (oktabel[0]>=1 &&
			oktabel[1]>=1 &&
			oktabel[2]>=1 &&
			oktabel[3]>=1 &&
			oktabel[4]>=1) {
			retur = 1;
		}
	}
	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}
afslut:
	if (logfil) {
		fprintf(logfil,"check_requeststyr retur=%d\n",retur);
	}
	return(retur);
}

/* *********************************** */
static int retur_ptabmatch(char *inpidstr) {
	int retur = -1;
	int idx = 0;

	while (idx<MAX_EXTRAPRODTAB && retur==-1) {
		if (strcmp(extraptab[idx].id,inpidstr)==0) {
			retur = idx;
		}
		idx++;
	}
	return(retur);
}

/* **************************************************** */
static int nulstil_psextraprio() {
	int retur = 0;
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil,"nulstil_psextraprio\n");
		fprintf(logfil,"\tws_station=%hd\n",ws_station);
	}
	strcpy(ws_donextraprio[0],"SPC905");
/* NYT 141217 ADMDIVFLAG */
	sprintf(tmpstr,"ps%hdspc%hd",ws_station,(short int)905);
	if (access(tmpstr,0)!=0) {
		strcpy(ws_donextraprio[0],"");
	}
	strcpy(ws_donextraprio[1],"SPC906");
/* NYT 141217 ADMDIVFLAG */
	sprintf(tmpstr,"ps%hdspc%hd",ws_station,(short int)906);
	if (access(tmpstr,0)!=0) {
		strcpy(ws_donextraprio[1],"");
	}
	strcpy(ws_donextraprio[2],"SPC907");
/* NYT 141217 ADMDIVFLAG */
	sprintf(tmpstr,"ps%hdspc%hd",ws_station,(short int)907);
	if (access(tmpstr,0)!=0) {
		strcpy(ws_donextraprio[2],"");
	}
	strcpy(ws_donextraprio[3],"");
	strcpy(ws_donextraprio[4],"");
	strcpy(ws_donextraprio[5],"");
	strcpy(ws_donextraprio[6],"PAI");
	strcpy(ws_donextraprio[7],"SPC996");
	strcpy(ws_donextraprio[8],"");
	strcpy(ws_donextraprio[9],"");
	strcpy(ws_donextraprio[10],"");
	strcpy(ws_donextraprio[11],"");
	strcpy(ws_donextraprio[12],"");
	strcpy(ws_donextraprio[13],"");
	strcpy(ws_donextraprio[14],"");
	strcpy(ws_donextraprio[15],"");
	strcpy(ws_donextraprio[16],"");
	strcpy(ws_donextraprio[17],"");
	strcpy(ws_donextraprio[18],"");
	strcpy(ws_donextraprio[19],"");
	retur = 1;
	if (logfil) {
		fprintf(logfil,"nulstil_psextraprio retur=%d\n",retur);
	}
	return(retur);
}

/* **************************************************** */
static int add_donextraprio(int inpspcnr) {
	int retur = 0;
	int idx = 0;

	if (logfil) {
		fprintf(logfil,"add_donextraprio inpspcnr=%d\n",
			inpspcnr);
	}
	while (idx<MAX_EXTRAPRODTAB && retur==0) {
		if (strlen(ws_donextraprio[idx])) {
			idx++;
			continue;
		}
		sprintf(ws_donextraprio[idx],"SPC%3.3d",inpspcnr);
		idx++;
		retur++;
	}
	if (logfil) {
		fprintf(logfil,"add_donextraprio retur=%d\n",
			retur);
	}
	return(retur);
}

/* ********************************* */
static int init_extraptab(int inpfunk) {
	int retur = 0;
	int maxindex = 0;
	int prioindex = 0;
	int nuvindex = 0;
	int minantal = 0;
	int maxantal = 0;
	int nuvantal = 0;
	int funkretur = 0;
	int xlsprisretur = 0;
	int wx1 = 0;
	int pssortflag = 0;
	short int nuvspecnr = 0;
	short int fundet = 0;
	short int vdaekflag = 0;
	short int traekflag = 0;
	short int flytteflag = 0;
	short int gpsflag = 0;
	short int youngflag = 0;
	short int kmpakkeflag = 0;
	short int kmpakkespecnr = 0;
	short int srnflag = 0;
	short int mljflag = 0;
	long int varighed = 0;
	double paiprdag = 0;
	char chkgrp[21] = "";
	char returstr[81] = "";
	char sortextprod[30][41] = {"","","","","","","","","","",
					"","","","","","","","","","",
					"","","","","","","","","",""};

	if (logfil) {
		fprintf(logfil,
			"init_extraptab:inpfunk=%d\n",
			inpfunk);
		fprintf(logfil,
			"\tws_grpidx=%hd\n",
			ws_grpidx);
	}
/* NYT 131206 */
	if (ws_brandtype==4 && inpfunk==1 && ws_grpidx<=0) {
		funkretur = dan_psgrptab(1,ws_langstr,ws_station);
	}
/* NYT 131216 */
	if (ws_brandtype==4 && inpfunk==1) {
		(void)nulstil_psextraprio();
	}
	if (logfil) {
		fprintf(logfil, "\tws_biltype=%s\n",ws_biltype);
		fprintf(logfil, "\tws_grp=%s\n",ws_grp);
		fprintf(logfil, "\tws_grpidx=%hd\n",ws_grpidx);
	}
	wx1 = 0;
	while (ws_brandtype==4 && wx1<ws_grpidx && !strlen(ws_biltype)) {
		sscanf(ws_grptab[wx1]+8,"%s",chkgrp);
		if (strcmp(chkgrp,ws_grp)==0) {
			sscanf(ws_grptab[wx1]+2,"%s",ws_biltype);
		}
		wx1++;
	}
	if (logfil) {
		fprintf(logfil, "\tws_biltype=%s\n",ws_biltype);
		fprintf(logfil, "\tws_grp=%s\n",ws_grp);
	}
/* NYT 131210 GRPMANGLER */
	if (ws_brandtype==4 && inpfunk==1 && !strlen(ws_biltype)) {
		ws_don2errno = DON2UPGRPUK;
	}
	if (logfil) {
		fprintf(logfil, "\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		retur = 0;
		goto afslut;
	}
	varighed = beregn_varighed(ws_station,
		ws_grp,
		ws_specnr,
		ws_extspcstr);
	if (ws_fradato%10000>=1001 && ws_fradato%10000<=1231) {
		vdaekflag++;
	}
	if (ws_fradato%10000>=0101 && ws_fradato%10000<401) {
		vdaekflag++;
	}
/* NYT 121022 */
	if (ws_tildato%10000>=1001 && ws_tildato%10000<=1231) {
		vdaekflag++;
	}
	if (ws_tildato%10000>=0101 && ws_tildato%10000<401) {
		vdaekflag++;
	}
/* NYT 121105 */
	if (strlen(ws_grp) && strcmp(ws_grp,"3")==0 &&
		ws_brandtype==3) {
		traekflag = 1;
	}
/* NYT 131204 PSEXTRA */
	if (strlen(ws_biltype) && strcmp(ws_biltype,"VAR")==0 &&
		ws_brandtype==4) {
		traekflag = 1;
	}

/* NYT 121108 */
	if (access("donflyttekok",0)==0 &&
		strlen(ws_grp) && strcmp(ws_grp,"3")==0 &&
		ws_brandtype==3) {
/* RETTET 1401007 DONFLYTTEKASSE
	if (strlen(ws_grp) && strcmp(ws_grp,"3")==0 &&
		ws_brandtype==3) {
*/
		flytteflag = 1;
	}
/* NYT 141113 DONMILJOMAERKE */
	if (access("donmljok",0)==0 &&
		strlen(ws_grp) && strcmp(ws_grp,"3")==0 &&
		ws_brandtype==3) {
		mljflag = 1;
	}
	if (access("donmljok",0)==0 &&
		strlen(ws_grp) && strcmp(ws_grp,"A")==0 &&
		ws_brandtype==3) {
		mljflag = 1;
	}

/* NYT 131204 PSEXTRA */
	if (strlen(ws_biltype) && strcmp(ws_biltype,"VAR")==0 &&
		ws_brandtype==4) {
		traekflag = 1;
	}
	if (strlen(ws_biltype) && strcmp(ws_biltype,"LST")==0 &&
		ws_brandtype==4) {
		traekflag = 1;
	}

/* NYT 131202 GPS */
	if (access("don2gpsok",0)==0 &&
		strlen(ws_grp) && strcmp(ws_grp,"A")==0 &&
		ws_brandtype==3) {
		gpsflag = 1;
	}
/* NYT 150304 DONGPSGRP3 */
	if (access("don2gpsok",0)==0 &&
		strlen(ws_grp) && strcmp(ws_grp,"3")==0 &&
		ws_brandtype==3) {
		gpsflag = 1;
	}

/* NYT 131204 GPS */
	if (access("psgpsok",0)==0 &&
		strlen(ws_biltype) && strcmp(ws_biltype,"PRS")==0 &&
		ws_brandtype==4) {
		gpsflag = 1;
	}
	if (access("psgpsok",0)==0 &&
		strlen(ws_biltype) && strcmp(ws_biltype,"BUS")==0 &&
		ws_brandtype==4) {
		gpsflag = 1;
	}
/* NYT 140305 YOUNG997EXTRA */
/* OBS 140306
	if (ws_brandtype==3) {
		youngflag = 1;
	}
*/
/* NYT 140424 KMPAKKE KMPAKKEXLS */
	if (strlen(ws_biltype) && strcmp(ws_biltype,"PRS")==0 &&
		ws_brandtype==4) {
		kmpakkeflag = 1;
	}
	if (strlen(ws_biltype) && strcmp(ws_biltype,"BUS")==0 &&
		ws_brandtype==4) {
		kmpakkeflag = 1;
	}
	if (strlen(ws_biltype) && strcmp(ws_biltype,"VAR")==0 &&
		ws_brandtype==4) {
		kmpakkeflag = 1;
	}
	if (strlen(ws_biltype) && strcmp(ws_biltype,"LST")==0 &&
		ws_brandtype==4) {
		kmpakkeflag = 1;
	}
/* NYT 140428 SRNXLS */
	if (strlen(ws_biltype) && strcmp(ws_biltype,"PRS")==0 &&
		ws_brandtype==4) {
		srnflag = 1;
	}
	if (strlen(ws_biltype) && strcmp(ws_biltype,"BUS")==0 &&
		ws_brandtype==4) {
		srnflag = 1;
	}
	if (strlen(ws_biltype) && strcmp(ws_biltype,"VAR")==0 &&
		ws_brandtype==4) {
		srnflag = 1;
	}
	if (strlen(ws_biltype) && strcmp(ws_biltype,"LST")==0 &&
		ws_brandtype==4) {
		srnflag = 1;
	}
/* NYT 140822 FLYTTEKASSERXLS */
	if (access("psflyttekok",0)==0 &&
/* NYT 140825 FLYTTEKASSERXLS */
		access("psflyttekprsok",0)==0 &&
		strlen(ws_biltype) && strcmp(ws_biltype,"PRS")==0 &&
		ws_brandtype==4) {
		flytteflag = 1;
	}
	if (access("psflyttekok",0)==0 &&
/* NYT 140825 FLYTTEKASSERXLS */
		access("psflyttekbusok",0)==0 &&
		strlen(ws_biltype) && strcmp(ws_biltype,"BUS")==0 &&
		ws_brandtype==4) {
		flytteflag = 1;
	}
	if (access("psflyttekok",0)==0 &&
/* NYT 140825 FLYTTEKASSERXLS */
		access("psflyttekvarok",0)==0 &&
		strlen(ws_biltype) && strcmp(ws_biltype,"VAR")==0 &&
		ws_brandtype==4) {
		flytteflag = 1;
	}
	if (access("psflyttekok",0)==0 &&
/* NYT 140825 FLYTTEKASSERXLS */
		access("psflytteklstok",0)==0 &&
		strlen(ws_biltype) && strcmp(ws_biltype,"LST")==0 &&
		ws_brandtype==4) {
		flytteflag = 1;
	}

/* NYT 140904 PSVDAEK */
	if (access("psvdaektestok",0)==0 &&
		ws_brandtype==4) {
		vdaekflag++;
	}
/* NYT 141007 PSVDAEKPROD */
	if (access("psvdaekprodok",0)!=0 &&
		ws_brandtype==4) {
		vdaekflag = 0;
	}

	if (logfil) {
		fprintf(logfil, "\tvarighed=%ld\n",
			varighed);
		fprintf(logfil, "\tvdaekflag=%hd\n",
			vdaekflag);
		fprintf(logfil, "\ttraekflag=%hd\n",
			traekflag);
		fprintf(logfil, "\tflytteflag=%hd\n",
			flytteflag);
		fprintf(logfil, "\tgpsflag=%hd\n",
			gpsflag);
		fprintf(logfil, "\tmljflag=%hd\n",
			mljflag);
		fprintf(logfil, "\tyoungflag=%hd\n",
			youngflag);
		fprintf(logfil, "\tkmpakkeflag=%hd\n",
			kmpakkeflag);
		fprintf(logfil, "\tsrnflag=%hd\n",
			srnflag);
		fprintf(logfil, "\tws_specnr=%hd\n",
			ws_specnr);
		fprintf(logfil, "\tws_grp=%s\n",
			ws_grp);
		fprintf(logfil, "\tws_biltype=%s\n",
			ws_biltype);
		fprintf(logfil, "\tws_firmaloginflag=%hd\n",
			ws_firmaloginflag);
	}
/* NYT 121105 */
	if (vdaekflag>0) {
		add_donextraprio(910);
	}
/* NYT 131102 GPS */
	if (gpsflag>0) {
		add_donextraprio(924);
	}
/* NYT 141113 DONMILJOMAERKE */
	if (mljflag>0) {
		add_donextraprio(928);
	}
	if (traekflag>0) {
		add_donextraprio(901);
	}
/* NYT 140305 YOUNG997EXTRA */
	if (youngflag>0) {
		add_donextraprio(997);
	}
/* NYT 140424 KMPAKKE KMPAKKEXLS */
	if (kmpakkeflag>0) {
		kmpakkespecnr = 969;
/* NYT 140904 KMPKSPECNR PSKMPK840 */
		if (access("pskmpkspecnr840",0)==0) {
			kmpakkespecnr = 840;
		}
		add_donextraprio(kmpakkespecnr);
	}
/* NYT 140428 SRNXLS */
	if (srnflag>0) {
		add_donextraprio(947);
	}

/* NYT 121108 */
	if (flytteflag>0) {
		add_donextraprio(980);
	}
	maxindex = MAX_EXTRAPRODTAB;
	nuvindex = 0;
	while (inpfunk==1 && nuvindex<maxindex) {
		strcpy(extraptab[nuvindex].id,"");
		strcpy(extraptab[nuvindex].beskrivelse,"");
		strcpy(extraptab[nuvindex].enhedtxt,"");
		strcpy(extraptab[nuvindex].valgtype,"");
		strcpy(extraptab[nuvindex].rategruppe,"");
		extraptab[nuvindex].ratespecnr = 0;
		extraptab[nuvindex].ratestatnr = 0;
		extraptab[nuvindex].nuvantal = 0;
		extraptab[nuvindex].minantal = 0;
		extraptab[nuvindex].maxantal = 0;
		extraptab[nuvindex].enhedpris = 0;
		extraptab[nuvindex].totalpris = 0;
		nuvindex++;
	}
	reclow(r165,R165);
	f165_start(1,ISGTEQ);
	r165->spec_nr = ws_specnr;
	r165->stat_nr = ws_station;
	strcpy(r165->bil_grp,ws_grp);
	egeread(f165,ISEQUAL);
	if (f165_ok) {
		paiprdag = (double)r165->rate_pai;
	}
/* NYT 121022 PAIDEFAULT35 */
	if (f165_ukendt && ws_brandtype==4) {
/* NYT 140402 FINDXLSPAIPRISPRDAG */
		xlsprisretur = find_psxlspris(1,
			"PS",
			ws_station,
			ws_specnr,
			ws_grp,
			varighed,
			returstr);
/*
		paiprdag = (double)35;
*/
	}
/* NYT 140618 XLSF165SLETMARK */
	if (f165_ok && r165->slet_mark>0 && ws_brandtype==4) {
		xlsprisretur = find_psxlspris(1,
			"PS",
			ws_station,
			ws_specnr,
			ws_grp,
			varighed,
			returstr);
	}

	if (xlsprisretur>0 && strlen(returstr)) {
		sscanf(returstr,"%lf",&paiprdag);
	}
	if (logfil) {
		fprintf(logfil, "\txlsprisretur=%d\n",
			xlsprisretur);
		fprintf(logfil, "\tpaiprdag=%.2lf\n",
			paiprdag);
		fprintf(logfil, "\treturstr=%s\n",
			returstr);
	}
	pssortflag = 1;
/* NYT 140422 TILVALGSORTERING */
	if (logfil) {
		fprintf(logfil,"\tTILVALGSORTERING pssortflag=%hd\n",
			pssortflag);
	}
	prioindex = 0;
	while (logfil && ws_brandtype==4 && inpfunk==1 && prioindex<maxindex) {
		fprintf(logfil,"\t\tprioindex=%d <%s>\n",
			prioindex,
			ws_donextraprio[prioindex]);
		prioindex++;
	}
	prioindex = 0;
	while (ws_brandtype==4 && inpfunk==1 && prioindex<maxindex) {
		if (strcmp(ws_donextraprio[prioindex],"PAI")==0) {
			strcpy(sortextprod[0],ws_donextraprio[prioindex]);
		}
		if (strcmp(ws_donextraprio[prioindex],"SPC969")==0) {
			strcpy(sortextprod[3],ws_donextraprio[prioindex]);
		}
/* NYT 140904 KMPKSPECNR */
		if (strcmp(ws_donextraprio[prioindex],"SPC888")==0) {
			strcpy(sortextprod[3],ws_donextraprio[prioindex]);
		}
/* NYT 141111 PSKMPK840 */
		if (strcmp(ws_donextraprio[prioindex],"SPC840")==0) {
			strcpy(sortextprod[3],ws_donextraprio[prioindex]);
		}

		if (strcmp(ws_donextraprio[prioindex],"SPC947")==0) {
			strcpy(sortextprod[2],ws_donextraprio[prioindex]);
		}
/* NYT 140822 FLYTTEKASSERXLS */
		if (strcmp(ws_donextraprio[prioindex],"SPC980")==0) {
			strcpy(sortextprod[4],ws_donextraprio[prioindex]);
		}

		if (strcmp(ws_donextraprio[prioindex],"SPC905")==0) {
			strcpy(sortextprod[6],ws_donextraprio[prioindex]);
		}
		if (strcmp(ws_donextraprio[prioindex],"SPC906")==0) {
			strcpy(sortextprod[7],ws_donextraprio[prioindex]);
		}
		if (strcmp(ws_donextraprio[prioindex],"SPC907")==0) {
			strcpy(sortextprod[8],ws_donextraprio[prioindex]);
		}
		if (strcmp(ws_donextraprio[prioindex],"SPC908")==0) {
			strcpy(sortextprod[9],ws_donextraprio[prioindex]);
		}
		if (strcmp(ws_donextraprio[prioindex],"SPC996")==0) {
			strcpy(sortextprod[12],ws_donextraprio[prioindex]);
		}
		if (strcmp(ws_donextraprio[prioindex],"SPC901")==0) {
			strcpy(sortextprod[15],ws_donextraprio[prioindex]);
		}
		if (strcmp(ws_donextraprio[prioindex],"SPC910")==0) {
			strcpy(sortextprod[18],ws_donextraprio[prioindex]);
		}
		if (strcmp(ws_donextraprio[prioindex],"SPC924")==0) {
			strcpy(sortextprod[21],ws_donextraprio[prioindex]);
		}
		prioindex++;
	}
	prioindex = 0;
	nuvindex = 0;
	while (pssortflag>0 && ws_brandtype==4 && inpfunk==1 && nuvindex<30) {
		if (!strlen(sortextprod[nuvindex])) {
			nuvindex++;
			continue;
		}
		strcpy(ws_donextraprio[prioindex],sortextprod[nuvindex]);
		prioindex++;
		nuvindex++;
	}
	while (pssortflag>0 && ws_brandtype==4 && inpfunk==1 &&
		prioindex<maxindex) {
		strcpy(ws_donextraprio[prioindex],"");
		prioindex++;
	}
	if (logfil) {
		fprintf(logfil,"\tEFTERTILVALGSORTERING\n");
	}
	prioindex = 0;
	while (logfil && ws_brandtype==4 && inpfunk==1 && prioindex<maxindex) {
		fprintf(logfil,"\t\tprioindex=%d <%s>\n",
			prioindex,
			ws_donextraprio[prioindex]);
		prioindex++;
	}
	nuvindex = -1;
	prioindex = 0;
	while (inpfunk==1 && prioindex<maxindex) {
		if (logfil) {
			fprintf(logfil,"\t\tprioindex=%d <%s>\n",
				prioindex,
				ws_donextraprio[prioindex]);
		}
		nuvspecnr = 0;
		fundet = 0;
		if (strncmp(ws_donextraprio[prioindex],"SPC",3)==0) {
			sscanf(ws_donextraprio[prioindex]+3,"%hd",&nuvspecnr);
		}
/*
		if (vdaekflag<=0 && nuvspecnr==910) {
			prioindex++;
			continue;
		}
		if (traekflag<=0 && nuvspecnr==901) {
			prioindex++;
			continue;
		}
*/
		if (strncmp(ws_donextraprio[prioindex],"PAI",3)==0) {
			nuvindex++;
			nuvspecnr = -1;
			strcpy(extraptab[nuvindex].id,"PAI");
			extraptab[nuvindex].ratespecnr = -1;
			extraptab[nuvindex].ratestatnr = 0;
			extraptab[nuvindex].nuvantal = 0;
			extraptab[nuvindex].minantal = 0;
			extraptab[nuvindex].maxantal = 1;
			strcpy(extraptab[nuvindex].beskrivelse,
				"Person- og godsforsikring");
/* NYT 121129 PAIPRDAG
			if (ws_funktion==4) {
				strcpy(extraptab[nuvindex].beskrivelse,
					"Person- og godsforsikring pr.dag");
			}
*/
			extraptab[nuvindex].enhedpris = paiprdag;
			strcpy(extraptab[nuvindex].valgtype,"RADIOJANEJ");
/* NYT 140508 PSPAICHECKBOX */
			if (ws_brandtype==4) {
				strcpy(extraptab[nuvindex].valgtype,
					"CHECKBOX");
			}
			strcpy(extraptab[nuvindex].enhedtxt,"pr. dag");
/* NYT 140809 PSPAIUDREGNLM */
			if (ws_brandtype==4) {
				strcpy(extraptab[nuvindex].enhedtxt,
					".");
			}
			fundet = 1;
		}
		if (nuvspecnr>0) {
			nuvindex++;
			r165->spec_nr = nuvspecnr;
			r165->stat_nr = ws_station;
			strcpy(r165->bil_grp,ws_grp);
			egeread(f165,ISEQUAL);
		}
		if (nuvspecnr>0 && f165_ok && fundet<=0) {
			fundet = 1;
			strcpy(extraptab[nuvindex].rategruppe,r165->bil_grp);
			extraptab[nuvindex].ratespecnr = r165->spec_nr;
			extraptab[nuvindex].ratestatnr = r165->stat_nr;
			strcpy(extraptab[nuvindex].beskrivelse,r165->tekst_1);
			extraptab[nuvindex].enhedpris = r165->pris;
			sprintf(extraptab[nuvindex].id,"%3.3hd",nuvspecnr);
		}
		if (nuvspecnr>0 && fundet<=0) {
			r165->spec_nr = nuvspecnr;
			r165->stat_nr = ws_station;
			strcpy(r165->bil_grp,"ALLE");
/* NYT 131202 GPS */
			if (nuvspecnr==924) {
				strcpy(r165->bil_grp,"GPS");
			}
			egeread(f165,ISEQUAL);
		}
		if (nuvspecnr>0 && f165_ok && fundet<=0) {
			fundet = 1;
			strcpy(extraptab[nuvindex].rategruppe,r165->bil_grp);
			extraptab[nuvindex].ratespecnr = r165->spec_nr;
			extraptab[nuvindex].ratestatnr = r165->stat_nr;
			strcpy(extraptab[nuvindex].beskrivelse,r165->tekst_1);
			extraptab[nuvindex].enhedpris = r165->pris;
			sprintf(extraptab[nuvindex].id,"%3.3hd",nuvspecnr);
		}
		if (nuvspecnr>0 && fundet<=0) {
			r165->spec_nr = nuvspecnr;
			r165->stat_nr = 0;
			strcpy(r165->bil_grp,"ALLE");
			egeread(f165,ISEQUAL);
		}
		if (nuvspecnr>0 && f165_ok && fundet<=0) {
			fundet = 1;
			strcpy(extraptab[nuvindex].rategruppe,r165->bil_grp);
			extraptab[nuvindex].ratespecnr = r165->spec_nr;
			extraptab[nuvindex].ratestatnr = r165->stat_nr;
			strcpy(extraptab[nuvindex].beskrivelse,r165->tekst_1);
			extraptab[nuvindex].enhedpris = r165->pris;
			sprintf(extraptab[nuvindex].id,"%3.3hd",nuvspecnr);
		}
/* NYT 140430 KMPAKKE */
		if (nuvspecnr==969) {
			extraptab[nuvindex].maxantal = 500;
		}
/* NYT 140904 KMPKSPECNR */
		if (nuvspecnr==888) {
			extraptab[nuvindex].maxantal = 500;
		}
/* NYT 141111 PSKMPK840 */
		if (nuvspecnr==840) {
			extraptab[nuvindex].maxantal = 500;
		}

		if (nuvspecnr==947) {
			extraptab[nuvindex].maxantal = 1000;
		}

		if (nuvspecnr>0 && fundet<=0) {
			prioindex++;
			continue;
		}

/* NYT 131204 PSEXTRA */
		if (nuvspecnr>0 && fundet>0 && inpfunk==1 && nuvspecnr==905) {
			extraptab[nuvindex].nuvantal = 0;
			extraptab[nuvindex].minantal = 0;
			extraptab[nuvindex].maxantal = 3;
			if (strcmp(ws_biltype,"VAR")==0) {
				extraptab[nuvindex].maxantal = 2;
			}
			if (strcmp(ws_biltype,"LST")==0) {
				extraptab[nuvindex].maxantal = 2;
			}
			strcpy(extraptab[nuvindex].valgtype,"DROPDOWN");
			strcpy(extraptab[nuvindex].enhedtxt,"pr. stk pr. dag");
/* NYT 140506 BARNESTOLLM */
			if (ws_brandtype==4) {
				strcpy(extraptab[nuvindex].enhedtxt,"pr. stk");
				(void)juster_extraptab(1,nuvindex,varighed);
			}
		}
		if (nuvspecnr>0 && fundet>0 && inpfunk==1 && nuvspecnr==906) {
			extraptab[nuvindex].nuvantal = 0;
			extraptab[nuvindex].minantal = 0;
			extraptab[nuvindex].maxantal = 3;
			if (strcmp(ws_biltype,"VAR")==0) {
				extraptab[nuvindex].maxantal = 2;
			}
			if (strcmp(ws_biltype,"LST")==0) {
				extraptab[nuvindex].maxantal = 2;
			}
			strcpy(extraptab[nuvindex].valgtype,"DROPDOWN");
			strcpy(extraptab[nuvindex].enhedtxt,"pr. stk pr. dag");
/* NYT 140506 BARNESTOLLM */
			if (ws_brandtype==4) {
				strcpy(extraptab[nuvindex].enhedtxt,"pr. stk");
				(void)juster_extraptab(1,nuvindex,varighed);
			}
		}
		if (nuvspecnr>0 && fundet>0 && inpfunk==1 && nuvspecnr==907) {
			extraptab[nuvindex].nuvantal = 0;
			extraptab[nuvindex].minantal = 0;
			extraptab[nuvindex].maxantal = 3;
			if (strcmp(ws_biltype,"VAR")==0) {
				extraptab[nuvindex].maxantal = 2;
			}
			if (strcmp(ws_biltype,"LST")==0) {
				extraptab[nuvindex].maxantal = 2;
			}
			strcpy(extraptab[nuvindex].valgtype,"DROPDOWN");
			strcpy(extraptab[nuvindex].enhedtxt,"pr. stk pr. dag");
/* NYT 140506 BARNESTOLLM */
			if (ws_brandtype==4) {
				strcpy(extraptab[nuvindex].enhedtxt,"pr. stk");
				(void)juster_extraptab(1,nuvindex,varighed);
			}
		}
		if (nuvspecnr>0 && fundet>0 && inpfunk==1 && nuvspecnr==908) {
			extraptab[nuvindex].nuvantal = 0;
			extraptab[nuvindex].minantal = 0;
			extraptab[nuvindex].maxantal = 3;
			if (strcmp(ws_biltype,"VAR")==0) {
				extraptab[nuvindex].maxantal = 2;
			}
			if (strcmp(ws_biltype,"LST")==0) {
				extraptab[nuvindex].maxantal = 2;
			}
			strcpy(extraptab[nuvindex].valgtype,"DROPDOWN");
			strcpy(extraptab[nuvindex].enhedtxt,"pr. stk pr. dag");
/* NYT 140506 BARNESTOLLM */
			if (ws_brandtype==4) {
				strcpy(extraptab[nuvindex].enhedtxt,"pr. stk");
				(void)juster_extraptab(1,nuvindex,varighed);
			}
		}


		if (nuvspecnr>0 && fundet>0 && inpfunk==1 && nuvspecnr==932) {
			extraptab[nuvindex].nuvantal = 0;
			extraptab[nuvindex].minantal = 0;
			extraptab[nuvindex].maxantal = 3;
/* NYT 121214 VAREBILMAXBSTOL */
			if (strcmp(ws_grp,"3")==0) {
				extraptab[nuvindex].maxantal = 2;
			}
			strcpy(extraptab[nuvindex].valgtype,"DROPDOWN");
			strcpy(extraptab[nuvindex].enhedtxt,"pr. stk pr. dag");
/* NYT 121129 BSTOLPRDAG */
/*
			(void)juster_extraptab(1,nuvindex,varighed);
*/
		}
		if (nuvspecnr>0 && fundet>0 && inpfunk==1 && nuvspecnr==933) {
			extraptab[nuvindex].nuvantal = 0;
			extraptab[nuvindex].minantal = 0;
			extraptab[nuvindex].maxantal = 3;
/* NYT 121214 VAREBILMAXBSTOL */
			if (strcmp(ws_grp,"3")==0) {
				extraptab[nuvindex].maxantal = 2;
			}
			strcpy(extraptab[nuvindex].valgtype,"DROPDOWN");
			strcpy(extraptab[nuvindex].enhedtxt,"pr. stk pr. dag");
/* NYT 121129 BSTOLPRDAG */
/*
			(void)juster_extraptab(1,nuvindex,varighed);
*/
		}
		if (nuvspecnr>0 && fundet>0 && inpfunk==1 && nuvspecnr==934) {
			extraptab[nuvindex].nuvantal = 0;
			extraptab[nuvindex].minantal = 0;
			extraptab[nuvindex].maxantal = 3;
/* NYT 121214 VAREBILMAXBSTOL */
			if (strcmp(ws_grp,"3")==0) {
				extraptab[nuvindex].maxantal = 2;
			}
			strcpy(extraptab[nuvindex].valgtype,"DROPDOWN");
			strcpy(extraptab[nuvindex].enhedtxt,"pr. stk pr. dag");
/* NYT 121129 BSTOLPRDAG */
/*
			(void)juster_extraptab(1,nuvindex,varighed);
*/
		}
		if (nuvspecnr>0 && fundet>0 && inpfunk==1 && nuvspecnr==980) {
			extraptab[nuvindex].nuvantal = 0;
			extraptab[nuvindex].minantal = 0;
			extraptab[nuvindex].maxantal = 100;
			strcpy(extraptab[nuvindex].valgtype,"DROPDOWN");
			sprintf(extraptab[nuvindex].enhedtxt,"pr. stk");
			sprintf(extraptab[nuvindex].beskrivelse,"Flyttekasse");
		}
		if (nuvspecnr>0 && fundet>0 && inpfunk==1 && nuvspecnr==910) {
			extraptab[nuvindex].nuvantal = 0;
			extraptab[nuvindex].minantal = 0;
			extraptab[nuvindex].maxantal = 1;
			strcpy(extraptab[nuvindex].valgtype,"CHECKBOX");
			sprintf(extraptab[nuvindex].enhedtxt,"pr. dag");
/* NYT 140905 PSVDAEK */
			if (ws_brandtype==4) {
				sprintf(extraptab[nuvindex].enhedtxt,".");
			}
			sprintf(extraptab[nuvindex].beskrivelse,"Vinterdæk");
			(void)juster_extraptab(1,nuvindex,varighed);
		}
/* NYT 121022 */
		if (nuvspecnr>0 && fundet>0 && inpfunk==1 && nuvspecnr==901) {
			extraptab[nuvindex].nuvantal = 0;
			extraptab[nuvindex].minantal = 0;
			extraptab[nuvindex].maxantal = 1;
			strcpy(extraptab[nuvindex].valgtype,"CHECKBOX");
			sprintf(extraptab[nuvindex].enhedtxt,"pr. dag");
/* NYT 140416 */
			if (ws_brandtype==4) {
				sprintf(extraptab[nuvindex].enhedtxt,".");
/* RETTET 140509
				sprintf(extraptab[nuvindex].enhedtxt,"pr.lejemål");
*/
			}
			sprintf(extraptab[nuvindex].beskrivelse,"Anhængertræk");
			(void)juster_extraptab(1,nuvindex,varighed);
		}
/* NYT 140305 YOUNG997EXTRA */
		if (nuvspecnr>0 && fundet>0 && inpfunk==1 && nuvspecnr==997) {
			extraptab[nuvindex].nuvantal = 0;
			extraptab[nuvindex].minantal = 0;
			extraptab[nuvindex].maxantal = 1;
			strcpy(extraptab[nuvindex].valgtype,"CHECKBOX");
			sprintf(extraptab[nuvindex].enhedtxt,"pr. stk");
			sprintf(extraptab[nuvindex].beskrivelse,"Young driver");
			(void)juster_extraptab(1,nuvindex,varighed);
		}

/* NYT 121023 */
		if (nuvspecnr>0 && fundet>0 && inpfunk==1 && nuvspecnr==924) {
			extraptab[nuvindex].nuvantal = 0;
			extraptab[nuvindex].minantal = 0;
			extraptab[nuvindex].maxantal = 1;
			strcpy(extraptab[nuvindex].valgtype,"CHECKBOX");
			sprintf(extraptab[nuvindex].enhedtxt,"pr. dag");
			sprintf(extraptab[nuvindex].beskrivelse,"GPS");
			(void)juster_extraptab(1,nuvindex,varighed);
		}
		if (nuvspecnr>0 && fundet>0 && inpfunk==1 && nuvspecnr==928) {
			extraptab[nuvindex].nuvantal = 0;
			extraptab[nuvindex].minantal = 0;
			extraptab[nuvindex].maxantal = 1;
			strcpy(extraptab[nuvindex].valgtype,"CHECKBOX");
			sprintf(extraptab[nuvindex].enhedtxt,"pr. stk");
			sprintf(extraptab[nuvindex].beskrivelse,"Miljømærke");
			(void)juster_extraptab(1,nuvindex,varighed);
		}
		if (nuvspecnr>0 && fundet>0 && inpfunk==1 && nuvspecnr==996) {
			extraptab[nuvindex].nuvantal = 0;
			extraptab[nuvindex].minantal = 0;
			extraptab[nuvindex].maxantal = 1;
			strcpy(extraptab[nuvindex].valgtype,"DROPDOWN");
/* NYT 141119 PSCODRIVERCHECKBOX */
			if (ws_brandtype==4) {
				strcpy(extraptab[nuvindex].valgtype,"CHECKBOX");
			}
			sprintf(extraptab[nuvindex].enhedtxt,"pr. stk");
			if (ws_brandtype==3) {
				sprintf(extraptab[nuvindex].enhedtxt,"pr. dag");
			}
			if (ws_firmaloginflag>0) {
				sprintf(extraptab[nuvindex].beskrivelse,
					"Chauffør(er)");
			}
/* NYT 140305 CO996EJGRATIS */
			if (ws_firmaloginflag<=0) {
				sprintf(extraptab[nuvindex].beskrivelse,
					"Ekstra chauffør/Co-Driver");
			}
/* NYT 140410 */
			extraptab[nuvindex].enhedpris = 0;
/* NYT 140305 CO996EJGRATIS */
			if (ws_brandtype==3) {
				(void)juster_extraptab(1,nuvindex,varighed);
			}
			if (ws_brandtype==4) {
				(void)juster_extraptab(1,nuvindex,varighed);
			}
		}
		prioindex++;
	}
	nuvindex = 0;
	while (logfil && nuvindex<maxindex) {
		fprintf(logfil,
	"\t%2.2d %-10s n%3.3d-m%2.2d-x%3.3d %-10s %5.2lf %5.2lf %s",
			nuvindex,
			extraptab[nuvindex].id,
			extraptab[nuvindex].nuvantal,
			extraptab[nuvindex].minantal,
			extraptab[nuvindex].maxantal,
			extraptab[nuvindex].valgtype,
			extraptab[nuvindex].enhedpris,
			extraptab[nuvindex].totalpris,
			extraptab[nuvindex].beskrivelse);

		fprintf(logfil,"\n");
		nuvindex++;
	}
afslut:
	if (logfil) {
		fprintf(logfil,
			"init_extraptab:retur=%d\n",
			retur);
		fflush(logfil);
	}
	return(retur);
}

/* ******************************************************************* */
/* XLS */
static int find_psxlspris(int inpfunk,char * inpbrand,int inpstation,int inpspecnr,char * inpgrp,int inpvarighed,char * returstr) {
	int retur = 0;
	int funkretur = 0;
	int xlsmainflag = 0;
	long int xlsvarighed = 0;
	char prisfilid[51] =  "";
	char tmpstr[81] =  "";

	strcpy(returstr,"");
	xlsvarighed = inpvarighed;
	if (logfil) {
		fprintf(logfil,"find_psxlspris inpfunk=%d\n",inpfunk);
		fprintf(logfil,"\tinpbrand=%s\n",inpbrand);
		fprintf(logfil,"\tinpvarighed=%d\n",inpstation);
		fprintf(logfil,"\tinpvarighed=%d\n",inpspecnr);
		fprintf(logfil,"\tinpbrand=%s\n",inpgrp);
		fprintf(logfil,"\tinpvarighed=%d\n",inpvarighed);
	}
/* NYT 141010 PSWEEKENDVARIGHEDSNYD */
	sprintf(tmpstr,"PS%5.5ld%5.5ldSTD.main",
		(long int)inpstation,
		(long int)inpspecnr);
	xlsmainflag = xlspris_udpakmain(tmpstr);
	if (logfil) {
		fprintf(logfil,"\txlsmainflag=%d\n",xlsmainflag);
	}
	if (xlsmainflag>0 && xlsvarighed<xlsprismain->varighed_ival[0]) {
		xlsvarighed = xlsprismain->varighed_ival[0];
	}

/* NYT 140416 */
	xlsprismatch->xtraantal = 0;
	xlsprismatch->lbnr = 0;
	xlsprismatch->xtraflag = 0;
	xlsprismatch->specnr = inpspecnr;
/* NYT 150519 PSSÆSONPRISER */
	if (ws_fradato>0) {
		xlsprismatch->uddato = ws_fradato;
	}

	sprintf(prisfilid,"PS%5.5ld%5.5ldSTD.spec",
		(long int)inpstation,
		(long int)inpspecnr);
	funkretur = xlspris_udpaksub(prisfilid,
		inpgrp,
		(long int)xlsvarighed);
	if (logfil) {
		fprintf(logfil,"\tfunkretur=%d\n",funkretur);
		fprintf(logfil,"\txlsprissub->enhed=%ld\n",
			xlsprissub->enhed);
	}
	if (funkretur>0 && inpfunk==1) {
		sprintf(returstr,"%lf",xlsprissub->paiprdag);
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"find_psxlspris retur=%d\n",retur);
	}
	return(retur);
}

/* ******************************************************************* */
static int juster_extraptab(int inpfunk,int inpindex,long inpvarighed) {
	int retur = 0;
	int xlsprisretur = 0;
	int nuvspecnr = 0;
	int nuvantal = 0;
	int faktor = -1;
	int specialudregn = -1;
	double nuvpris = 0;
	int okflag = 0;
	int prdagflag = 0;
	int pjretur = 0;
/* NYT 131202 GPS */
	short int nypaiflag = 0;
	short int nycdiflag = 0;
	short int nyenhed = 0;
	long int nyantal = 0;
	long int nyinclkm = 0;
	long int varighed = 0;
	double nypris = 0;
	double nycdidg = 0;
	double nypaidg = 0;
	double nyextkm = 0;
	char xlsfilid[41] = "";
	char xlsgruppe[41] = "";

	if (logfil) {
		fprintf(logfil,
		"juster_extraptab:inpfunk=%d inpindex=%d inpvarighed=%ld\n",
			inpfunk,
			inpindex,
			inpvarighed);
	}
	if (!strlen(extraptab[inpindex].id)) {
		return(0);
	}
	if (logfil) {
		fprintf(logfil,"\tws_specnr=%hd\n",ws_specnr);
		fprintf(logfil,"\tws_station=%hd\n",ws_station);
	}
	if (ws_brandtype==4) {
		sprintf(xlsfilid,"PS%5.5hd%5.5hdSTD.xtra",
			ws_station,
			ws_specnr);
	}
	if (logfil) {
		fprintf(logfil,"\txlsfilid=%s\n",xlsfilid);
	}
	if (strlen(xlsfilid)) {
		nuvspecnr = extraptab[inpindex].ratespecnr;
		nuvpris = extraptab[inpindex].enhedpris;
		nuvantal = extraptab[inpindex].nuvantal;

		xlsprismatch->xtraantal = 0;
		xlsprismatch->lbnr = 0;
		xlsprismatch->xtraflag = 1;
		xlsprismatch->specnr = nuvspecnr;

		varighed = inpvarighed;
		if (nuvspecnr==901) {
			strcpy(xlsgruppe,"ALLE");
		}
/* NYT 140506 BARNESTOLLM */
		if (nuvspecnr==905) { varighed = 0; }
		if (nuvspecnr==906) { varighed = 0; }
		if (nuvspecnr==907) { varighed = 0; }
		if (nuvspecnr==908) { varighed = 0; }
		if (nuvspecnr==996) { varighed = 0; }

		xlsprisretur = xlspris_udpaksub(xlsfilid,
			"",
			(long int)varighed);
	}
	if (logfil) {
		fprintf(logfil,"\t%hdxlsprisretur=%d nuvspecnr=%d\n",
			nuvspecnr,
			xlsprisretur,
			nuvspecnr);
	}
	if (inpfunk==1 && strlen(xlsfilid) && xlsprisretur>0) {
		nuvpris = xlsprissub->prisprenhed;
		okflag = 1;
		goto afslut;
	}

	nuvspecnr = extraptab[inpindex].ratespecnr;
	nuvpris = extraptab[inpindex].enhedpris;
	nuvantal = extraptab[inpindex].nuvantal;
	reclow(r165,R165);
	f165_start(1,ISGTEQ);
/* NYT 131202 GPS */
	if (inpfunk==1 && nuvspecnr==924 && inpvarighed>0) {
		faktor = 1;
		r165->spec_nr = (short int)nuvspecnr;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"GPS");
	}

	if (inpfunk==1 && nuvspecnr==910 && inpvarighed<7) {
		faktor = 1;
		r165->spec_nr = (short int)nuvspecnr;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
	}
	if (inpfunk==1 && nuvspecnr==910 && inpvarighed>=7 && inpvarighed<=23) {
		faktor = 7;
		r165->spec_nr = (short int)911;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
	}
	if (inpfunk==1 && nuvspecnr==910 && inpvarighed>23) {
		faktor = 30;
		r165->spec_nr = (short int)912;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
	}

/* NYT 140313 ANHÆNGERTRÆK */
	specialudregn = 0;
	if (inpfunk==1 && nuvspecnr==901 && inpvarighed<3) {
		faktor = 1;
		r165->spec_nr = (short int)nuvspecnr;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
	}
	if (inpfunk==1 && nuvspecnr==901 && inpvarighed>=3 && inpvarighed<=7) {
		faktor = 1;
		specialudregn = 1;
		r165->spec_nr = (short int)903;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
	}
	if (inpfunk==1 && nuvspecnr==901 && inpvarighed>7 && inpvarighed<=18) {
		faktor = 7;
		r165->spec_nr = (short int)903;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
	}
	if (inpfunk==1 && nuvspecnr==901 && inpvarighed>18) {
		faktor = 1;
		specialudregn = 1;
		r165->spec_nr = (short int)904;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
	}

/* RETTET 140313 ANHÆNGERTRÆK
	if (inpfunk==1 && nuvspecnr==901 && inpvarighed<7) {
		faktor = 1;
		r165->spec_nr = (short int)nuvspecnr;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
	}
	if (inpfunk==1 && nuvspecnr==901 && inpvarighed>=7 && inpvarighed<=23) {
		faktor = 7;
		r165->spec_nr = (short int)903;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
	}
	if (inpfunk==1 && nuvspecnr==901 && inpvarighed>23) {
		faktor = 30;
		r165->spec_nr = (short int)904;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
	}
*/

/* NYT 121022 OBS WEEKEND */



/* NYT 131210 PSCODRIVER */
	if (inpfunk==1 && nuvspecnr==996 && inpvarighed>0) {
		faktor = 1;
		r165->spec_nr = (short int)996;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
	}
/* NYT 140305 YOUNG997EXTRA */
	if (inpfunk==1 && nuvspecnr==997 && inpvarighed>0) {
		faktor = 1;
		r165->spec_nr = (short int)997;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
	}

/* NYT 121129 BSTOLPRDAG */
/*
	if (inpfunk==1 && nuvspecnr==932 && inpvarighed>1) {
		faktor = 1;
		r165->spec_nr = (short int)nuvspecnr;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
	}
	if (inpfunk==1 && nuvspecnr==933 && inpvarighed>1) {
		faktor = 1;
		r165->spec_nr = (short int)nuvspecnr;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
	}
	if (inpfunk==1 && nuvspecnr==934 && inpvarighed>1) {
		faktor = 1;
		r165->spec_nr = (short int)nuvspecnr;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
	}
*/

/* NYT 121112 */
/*
	if (nuvspecnr==910) { prdagflag = 1; }
	if (nuvspecnr==901) { prdagflag = 1; }
	if (nuvspecnr==932) { prdagflag = 1; }
	if (nuvspecnr==933) { prdagflag = 1; }
	if (nuvspecnr==934) { prdagflag = 1; }
*/
	if (logfil) {
		fprintf(logfil, "\tnuvspecnr=%d\n", nuvspecnr);
		fprintf(logfil, "\tnuvantal=%d\n", nuvantal);
		fprintf(logfil, "\tnuvpris=%.2lf\n", nuvpris);
		fprintf(logfil, "\tfaktor=%d\n", faktor);
		fprintf(logfil, "\tspecialudregn=%d\n", specialudregn);
		fprintf(logfil, "\tprdagflag=%d\n", prdagflag);
	}
	if (inpfunk==1 && faktor>0 && r165->spec_nr>0) {
		egeread(f165,ISEQUAL);
	}
	if (inpfunk==1 && faktor>0 && r165->spec_nr>0 && f165_ok) {
		nuvpris = (double)r165->pris;
		nuvpris /= (double)faktor;
		okflag = 1;
	}

/* NYT 140313 ANHÆNGERTRÆK */
	if (inpfunk==1 && specialudregn==1 && r165->spec_nr==903 && f165_ok) {
		nuvpris = (double)r165->pris;
		okflag = 1;
	}
	if (inpfunk==1 && specialudregn==1 && r165->spec_nr==904 && f165_ok) {
		nuvpris = (double)r165->pris;
		okflag = 1;
	}

/* NYT 131202 GPS */
	if (inpfunk==1 && faktor>0 && r165->spec_nr>0 && f165_ok &&
		r165->spec_nr==924) {
		pjretur = find_f198prisjust(924,
			"GPS",
			(short int)ws_station,
			ws_fradato,
			(int)inpvarighed,
			&nypris,
			&nyenhed,
			&nyantal,
			&nycdidg,
			&nypaidg,
			&nyextkm,
			&nyinclkm);
	}
	if (inpfunk==1 && faktor>0 && r165->spec_nr>0 && f165_ok &&
		r165->spec_nr==924 && pjretur>0 && nypris>0) {
		nuvpris = (double)nypris;
/* NYT 131209 GPSWEEKEND */
		if (nyenhed==201 && nyantal==3 && ws_specnr==196) {
			nuvpris = 30;
		}
		if (nyenhed==201 && nyantal>0) {
			nuvpris *= (double)nyantal;
			nuvpris /= (double)inpvarighed;
		}
		if (nyenhed>201 && nyantal>0) {
			nuvpris *= (double)nyantal;
		}
/* NYT 131209 */
		if (nyenhed==200 && nyantal==1) {
			nuvpris *= (double)nyantal;
			nuvpris /= (double)inpvarighed;
		}
		if (nyenhed==(long int)(200+inpvarighed) && nyantal==1) {
			nuvpris /= (double)inpvarighed;
		}
	}
/* NYT 140306 DONCO996PRDAG */
	if (inpfunk==1 && faktor>0 && r165->spec_nr>0 && f165_ok &&
		r165->spec_nr==996 && r165->enhed==201 && ws_brandtype==3) {
		nuvpris *= inpvarighed;
/* NYT 130407 CO996FIRMA1NUL */
		if (ws_firmaloginflag>0) {
			nuvpris = 0;
		}
		if (nuvpris>180) {
			nuvpris = 180;
		}
	}

	if (logfil) {
		fprintf(logfil, "\tpjretur=%d\n", pjretur);
		fprintf(logfil, "\t\tnyenhed=%hd\n", nyenhed);
		fprintf(logfil, "\t\tnyantal=%ld\n", nyantal);
		fprintf(logfil, "\t\tnypris=%lf\n", nypris);
		fprintf(logfil, "\t\tnuvpris=%lf\n", nuvpris);
	}
/* NYT 130304 FLYTTEKASSEX10 */
	if (inpfunk==2 && nuvspecnr==980 && nuvantal>=10) {
		nuvpris = (double)25;
/* NYT 140828 FLYTTEKASSEX10RETTELSE */
		nuvpris = (double)28.8;
		okflag = 1;
	}
afslut:


	if (logfil) {
		fprintf(logfil, "\tprdagflag=%d\n", prdagflag);
		fprintf(logfil, "\tokflag=%d\n", okflag);
		fprintf(logfil, "\tnuvpris=%.2lf\n", nuvpris);
	}
/* NYT 121112 */
	if (inpfunk>0 && okflag>0 && prdagflag>0 && inpvarighed>0) {
		nuvpris *= inpvarighed;
	}
	if (logfil) {
		fprintf(logfil, "\tnuvpris=%.2lf\n", nuvpris);
	}
	if (okflag>0) {
		extraptab[inpindex].enhedpris = nuvpris;
		retur++;
	}
	if (logfil) {
		fprintf(logfil,
		"\t%d nuvantal=%d enhedspris=%.2lf totalpris=%.2lf\n",
			inpindex,
			extraptab[inpindex].nuvantal,
			extraptab[inpindex].enhedpris,
			extraptab[inpindex].totalpris);
	}
	if (logfil) {
		fprintf(logfil,
		"juster_extraptab:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************ */
/* type 1 antal * pris						*/
/* type 2 varighed * pris					*/
/* type 3 varighed * antal * pris				*/
static int beregn_extraptab(int inpindex,long inpvarighed) {
	int retur = 0;
	int funkretur = 0;
	int type = 0;
	char xlsfilid[41] = "";

	if (!strlen(extraptab[inpindex].id)) {
		return(-1);
	}
	if (logfil) {
		fprintf(logfil,"beregn_extraptab inpndex=%d inpvarighed=%ld\n",
			inpindex,
			inpvarighed);
		fprintf(logfil,"\tid=%s\n",extraptab[inpindex].id);
		fprintf(logfil,"\tnuvantal=%d\n",extraptab[inpindex].nuvantal);
		fflush(logfil);
	}
	if (strcmp(extraptab[inpindex].id,"PAI")==0) { type = 3; }
/* NYT 131204 PSEXTRA */
	if (strcmp(extraptab[inpindex].id,"905")==0) { type = 3; }
	if (strcmp(extraptab[inpindex].id,"906")==0) { type = 3; }
	if (strcmp(extraptab[inpindex].id,"907")==0) { type = 3; }
	if (strcmp(extraptab[inpindex].id,"908")==0) { type = 3; }
/* NYT 140507 BARNESTOLANTALPS */
	if (ws_brandtype==4 &&
		strcmp(extraptab[inpindex].id,"905")==0) { type = 5; }
	if (ws_brandtype==4 &&
		strcmp(extraptab[inpindex].id,"906")==0) { type = 5; }
	if (ws_brandtype==4 &&
		strcmp(extraptab[inpindex].id,"907")==0) { type = 5; }
	if (ws_brandtype==4 &&
		strcmp(extraptab[inpindex].id,"908")==0) { type = 5; }

	if (strcmp(extraptab[inpindex].id,"932")==0) { type = 3; }
	if (strcmp(extraptab[inpindex].id,"933")==0) { type = 3; }
	if (strcmp(extraptab[inpindex].id,"934")==0) { type = 3; }
	if (strcmp(extraptab[inpindex].id,"980")==0) { type = 1; }
	if (strcmp(extraptab[inpindex].id,"910")==0) { type = 3; }
/* NYT 140905 PSVDAEK */
	if (ws_brandtype==4 &&
		strcmp(extraptab[inpindex].id,"910")==0) { type = 5; }

/* NYT 131202 GPS */
	if (strcmp(extraptab[inpindex].id,"924")==0) { type = 3; }

/* NYT 121022 */
	if (strcmp(extraptab[inpindex].id,"901")==0) { type = 3; }
/* NYT 140513 ANHTRÆK */
	if (ws_brandtype==4 &&
		strcmp(extraptab[inpindex].id,"901")==0) { type = 5; }

	if (strcmp(extraptab[inpindex].id,"996")==0) { type = 1; }
/* NYT 140306 */
	if (strcmp(extraptab[inpindex].id,"996")==0 &&
		ws_brandtype==3) { type = 3; }

/* NYT 140305 YOUNG997EXTRA */
	if (strcmp(extraptab[inpindex].id,"997")==0) { type = 1; }
/* NYT 140430 KMPAKKE */
	if (strcmp(extraptab[inpindex].id,"969")==0) { type = 4; }
/* NYT 140904 KMPKSPECNR */
	if (strcmp(extraptab[inpindex].id,"888")==0) { type = 4; }
/* NYT 141111 PSKMPK840 */
	if (strcmp(extraptab[inpindex].id,"840")==0) { type = 4; }

	if (strcmp(extraptab[inpindex].id,"947")==0) { type = 4; }
/* NYT 140822 FLYTTEKASSERXLS */
	if (strcmp(extraptab[inpindex].id,"980")==0 &&
		ws_brandtype==4) { type = 6; }

	ege_w_dou1 = extraptab[inpindex].enhedpris;
	if (type==1) {
		ege_w_dou1 *= (double)extraptab[inpindex].nuvantal;
	}
	if (type==2) {
		ege_w_dou1 *= (double)inpvarighed;
	}
/* BRUGES IKKE
	if (type==3 && strcmp(extraptab[inpindex].id,"924")==0) {
		pjretur = find_f198prisjust(924,
			"GPS",
			(short int)ws_station,
			ws_fradato,
			(int)inpvarighed,
			&nypris,
			&nyenhed,
			&nyantal,
			&nycdidg,
			&nypaidg,
			&nyextkm,
			&nyinclkm);
	}
	if (type==3 && strcmp(extraptab[inpindex].id,"924")==0 &&
		pjretur>0) {
		extraptab[inpindex].enhedpris = nypris;
		ege_w_dou1 = extraptab[inpindex].enhedpris;
	}
*/
	if (type==3) {
		ege_w_dou1 *= (double)extraptab[inpindex].nuvantal;
/* NYT 150223 DONANHFEJL */
		ege_w_int1 = inpvarighed;
		if (ws_brandtype==3 &&
			strcmp(extraptab[inpindex].id,"901")==0) {
			ege_w_int1 = 1;
		}
		ege_w_dou1 *= (double)ege_w_int1;
/* RETTET 150223 DONANHFEJL
		ege_w_dou1 *= (double)inpvarighed;
*/
	}
/* NYT 140306 CO996MAX180 */
	if (type==3 && strcmp(extraptab[inpindex].id,"996")==0 &&
		ws_brandtype==3) {
		ege_w_dou1 = extraptab[inpindex].enhedpris;
		ege_w_dou1 *= (double)extraptab[inpindex].nuvantal;
	}
	if (type==3 && strcmp(extraptab[inpindex].id,"996")==0 &&
		ws_brandtype==3 && ege_w_dou1>180) {
		ege_w_dou1 = (double)180;
		ege_w_dou1 *= (double)extraptab[inpindex].nuvantal;
	}
/* NYT 140430 KMPAKKE */
	funkretur = 0;
	if (type==4 && strcmp(extraptab[inpindex].id,"969")==0 &&
		extraptab[inpindex].nuvantal>0 &&
		ws_brandtype==4) {
		xlsprismatch->xtraantal = 0;
		xlsprismatch->lbnr = 0;
                xlsprismatch->xtraflag = 1;
		xlsprismatch->srnselvrisiko = 0;
		xlsprismatch->specnr = (long int)ws_specnr;
                sprintf(xlsprismatch->pakketxt,"KM%d",
			extraptab[inpindex].nuvantal);
/* RETTET 140618 KMPAKKE500
		if (extraptab[inpindex].nuvantal==500) {
                	sprintf(xlsprismatch->pakketxt,"KM%d+",
				extraptab[inpindex].nuvantal);
		}
*/
		sprintf(xlsfilid,"PS%5.5hd%5.5hdSTD.kmpk",
			ws_station,
			ws_specnr);
		funkretur = xlspris_udpakkmpk(xlsfilid,ws_grp,ws_station);
	}
/* NYT 140904 KMPKSPECNR */
	if (type==4 && strcmp(extraptab[inpindex].id,"888")==0 &&
		extraptab[inpindex].nuvantal>0 &&
		ws_brandtype==4) {
		xlsprismatch->xtraantal = 0;
		xlsprismatch->lbnr = 0;
                xlsprismatch->xtraflag = 1;
		xlsprismatch->srnselvrisiko = 0;
		xlsprismatch->specnr = (long int)ws_specnr;
                sprintf(xlsprismatch->pakketxt,"KM%d",
			extraptab[inpindex].nuvantal);
		sprintf(xlsfilid,"PS%5.5hd%5.5hdSTD.kmpk",
			ws_station,
			ws_specnr);
		funkretur = xlspris_udpakkmpk(xlsfilid,ws_grp,ws_station);
	}
/* NYT 141111 PSKMPK840 */
	if (type==4 && strcmp(extraptab[inpindex].id,"840")==0 &&
		extraptab[inpindex].nuvantal>0 &&
		ws_brandtype==4) {
		xlsprismatch->xtraantal = 0;
		xlsprismatch->lbnr = 0;
                xlsprismatch->xtraflag = 1;
		xlsprismatch->srnselvrisiko = 0;
		xlsprismatch->specnr = (long int)ws_specnr;
                sprintf(xlsprismatch->pakketxt,"KM%d",
			extraptab[inpindex].nuvantal);
		sprintf(xlsfilid,"PS%5.5hd%5.5hdSTD.kmpk",
			ws_station,
			ws_specnr);
		funkretur = xlspris_udpakkmpk(xlsfilid,ws_grp,ws_station);
	}

	if (type==4 && strcmp(extraptab[inpindex].id,"947")==0 &&
		extraptab[inpindex].nuvantal>0 &&
		ws_brandtype==4) {
		xlsprismatch->xtraantal = 0;
		xlsprismatch->lbnr = 0;
                xlsprismatch->xtraflag = 1;
		xlsprismatch->srnselvrisiko = 0;
		xlsprismatch->specnr = (long int)947;
		xlsprismatch->srnselvrisiko =
			(double)extraptab[inpindex].nuvantal;
		sprintf(xlsfilid,"PS%5.5hd%5.5hdSTD.xtra",
			ws_station,
			ws_specnr);
		funkretur = xlspris_udpaksub(xlsfilid,"",inpvarighed);
		xlsprismatch->srnselvrisiko = 0;
	}
/* NYT 140822 FLYTTEKASSERXLS */
	if (type==6 && strcmp(extraptab[inpindex].id,"980")==0 &&
		extraptab[inpindex].nuvantal>0 &&
		ws_brandtype==4) {
		xlsprismatch->lbnr = 0;
                xlsprismatch->xtraflag = 1;
		xlsprismatch->srnselvrisiko = 0;
		xlsprismatch->specnr = (long int)980;
		xlsprismatch->srnselvrisiko = 0;
		xlsprismatch->xtraantal =
			extraptab[inpindex].nuvantal;
		sprintf(xlsfilid,"PS%5.5hd%5.5hdSTD.xtra",
			ws_station,
			ws_specnr);
		funkretur = xlspris_udpaksub(xlsfilid,"",0);
	}

/* NYT 140507 BARNESTOLANTAL */
	if (type==5 && strcmp(extraptab[inpindex].id,"905")==0 &&
		extraptab[inpindex].nuvantal>0 &&
		ws_brandtype==4) {
		funkretur = 1;
		xlsprissub->prisprenhed = extraptab[inpindex].enhedpris;
	}
	if (type==5 && strcmp(extraptab[inpindex].id,"906")==0 &&
		extraptab[inpindex].nuvantal>0 &&
		ws_brandtype==4) {
		funkretur = 1;
		xlsprissub->prisprenhed = extraptab[inpindex].enhedpris;
	}
	if (type==5 && strcmp(extraptab[inpindex].id,"907")==0 &&
		extraptab[inpindex].nuvantal>0 &&
		ws_brandtype==4) {
		funkretur = 1;
		xlsprissub->prisprenhed = extraptab[inpindex].enhedpris;
	}
	if (type==5 && strcmp(extraptab[inpindex].id,"908")==0 &&
		extraptab[inpindex].nuvantal>0 &&
		ws_brandtype==4) {
		funkretur = 1;
		xlsprissub->prisprenhed = extraptab[inpindex].enhedpris;
	}
/* NYT 140513 ANHTRÆK */
	if (type==5 && strcmp(extraptab[inpindex].id,"901")==0 &&
		extraptab[inpindex].nuvantal>0 &&
		ws_brandtype==4) {
		funkretur = 1;
		xlsprissub->prisprenhed = extraptab[inpindex].enhedpris;
	}
/* NYT 140905 PSVDAEK */
	if (type==5 && strcmp(extraptab[inpindex].id,"910")==0 &&
		extraptab[inpindex].nuvantal>0 &&
		ws_brandtype==4) {
		funkretur = 1;
		xlsprissub->prisprenhed = extraptab[inpindex].enhedpris;
	}


	if (type==4 && funkretur>0) {
		ege_w_dou1 = xlsprissub->prisprenhed;
		extraptab[inpindex].nuvantal = 1;
		extraptab[inpindex].enhedpris = ege_w_dou1;
	}
/* NYT 140507 BARNESTOLANTAL */
	if (type==5 && funkretur>0) {
		ege_w_dou1 = xlsprissub->prisprenhed;
		extraptab[inpindex].enhedpris = ege_w_dou1;
		ege_w_dou1 *= extraptab[inpindex].nuvantal;
	}
/* NYT 140822 FLYTTEKASSERXLS */
	if (type==6 && funkretur>0) {
		ege_w_dou1 = xlsprissub->prisprenhed;
		extraptab[inpindex].enhedpris = ege_w_dou1;
		ege_w_dou1 *= extraptab[inpindex].nuvantal;
	}

	if (logfil) {
		fprintf(logfil,"\txlsfilid=%s\n",xlsfilid);
		fprintf(logfil,"\tfunkretur=%d\n",funkretur);
	}
	if (type>0 && ws_brandtype==3) {
		extraptab[inpindex].totalpris = ege_w_dou1;
		retur++;
	}
	if (type>0 && ws_brandtype==4 && extraptab[inpindex].nuvantal>0) {
		extraptab[inpindex].totalpris = ege_w_dou1;
	}
	if (type>0 && ws_brandtype==4) {
		retur++;
	}
	if (logfil) {
		fprintf(logfil,
			"\t%d nuvantal=%d enhedpris=%.2lf totalpris=%.2lf\n",
			inpindex,
			extraptab[inpindex].nuvantal,
			extraptab[inpindex].enhedpris,
			extraptab[inpindex].totalpris);
	}
	if (logfil) {
		fprintf(logfil,"beregn_extraptab retur=%d\n",
			retur);
	}
	return(retur);
}

/* ********************************* */
static int send_extraptab(int inpfunk, long inpvarighed) {
	int retur = 0;
	int nuvindex = 0;
	int maxindex = 0;
	int specialudregn = 0;
	long int varighed = 0;
	short int funkretur = 0;
	short int promoflag = 0;
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil,"send_extraptab:inpfunk=%d inpvarighed=%ld\n",
			inpfunk,inpvarighed);
		fprintf(logfil,"\tws_promokode=%s\n",ws_promokode);
	}
/* NYT 121108 */
        ws_paiflag = 1;
	if (ws_brandtype==4 && inpfunk==2) {
		varighed = inpvarighed;
		goto send2;
	}
        (void)log_stopur(60);
        funkretur = nyopret_reservation(0,0,0);
        (void)log_stopur(60);
	varighed = r159->pai_antal_dage;
        if (logfil) {
                fprintf(logfil,
                        "\tNYOPRET_RESERVATION:funkretur=%hd\n",
                        funkretur);
		fprintf(logfil,"\tvarighed=%ld\n",varighed);
        }
send2:
	maxindex = MAX_EXTRAPRODTAB;
	nuvindex = 0;
	while (nuvindex<maxindex) {
		if (!strlen(extraptab[nuvindex].id)) {
/*
			alfalow(str);
			pack_init(str);
			pack_alfa("");
			pack_alfa("");
			pack_alfa("");
			pack_alfa("");
			pack_alfa("");
			pack_alfa("");
			pack_alfa("");
*/
			nuvindex++;
			continue;
		}
		promoflag = check_promokode(extraptab[nuvindex].id);
		if (logfil) {
			fprintf(logfil, "\tpromoflag=%hd\n",promoflag);
			fprintf(logfil, "\tnuvindex=%d\n",nuvindex);
			fprintf(logfil, "\tid=%s\n",extraptab[nuvindex].id);
			fprintf(logfil, "\tbeskr=%s\n",extraptab[nuvindex].beskrivelse);
			fflush(logfil);
		}
		if (promoflag>0) {
			extraptab[nuvindex].nuvantal = (int)promoflag;
		}
/* NYT 131204 PSEXTRA */
		if (inpfunk==1) {
			alfalow(str);
			pack_init(str);
		}
/* NYT 140424 KMPAKKE KMPAKKEXLS */
		if (ws_brandtype==4 &&
			inpfunk==2 &&
			strcmp(extraptab[nuvindex].id,"969")==0) {
			funkretur = add_xlskmpk(1,
				ws_station,
				ws_specnr,
				ws_grp,
				varighed);
		}
		if (ws_brandtype==4 &&
			inpfunk==2 &&
			strcmp(extraptab[nuvindex].id,"969")==0 &&
			funkretur>0) {
			nuvindex++;
			retur++;
			continue;
		}
/* NYT 140904 KMPKSPECNR */
		if (ws_brandtype==4 &&
			inpfunk==2 &&
			strcmp(extraptab[nuvindex].id,"888")==0) {
			funkretur = add_xlskmpk(1,
				ws_station,
				ws_specnr,
				ws_grp,
				varighed);
		}
		if (ws_brandtype==4 &&
			inpfunk==2 &&
			strcmp(extraptab[nuvindex].id,"888")==0 &&
			funkretur>0) {
			nuvindex++;
			retur++;
			continue;
		}
/* NYT 141111 PSKMPK840 */
		if (ws_brandtype==4 &&
			inpfunk==2 &&
			strcmp(extraptab[nuvindex].id,"840")==0) {
			funkretur = add_xlskmpk(1,
				ws_station,
				ws_specnr,
				ws_grp,
				varighed);
		}
		if (ws_brandtype==4 &&
			inpfunk==2 &&
			strcmp(extraptab[nuvindex].id,"840")==0 &&
			funkretur>0) {
			nuvindex++;
			retur++;
			continue;
		}

/* NYT 140428 SRNXLS */
		if (ws_brandtype==4 &&
			inpfunk==2 &&
			strcmp(extraptab[nuvindex].id,"947")==0) {
			funkretur = add_xlssrn(1,
				ws_station,
				ws_specnr,
				ws_grp,
				varighed);
		}
		if (ws_brandtype==4 &&
			inpfunk==2 &&
			strcmp(extraptab[nuvindex].id,"947")==0 &&
			funkretur>0) {
			nuvindex++;
			retur++;
			continue;
		}
/* NYT 140822 FLYTTEKASSERXLS */
		if (ws_brandtype==4 &&
			inpfunk==2 &&
			strcmp(extraptab[nuvindex].id,"980")==0) {
			funkretur = add_xls980(1,
				ws_station,
				ws_specnr,
				ws_grp,
				varighed);
		}
		if (ws_brandtype==4 &&
			inpfunk==2 &&
			strcmp(extraptab[nuvindex].id,"980")==0 &&
			funkretur>0) {
			nuvindex++;
			retur++;
			continue;
		}

		pack_alfa(extraptab[nuvindex].id);
/* NYT 131210 EXTRATEKSTER */
		strcpy(tmpstr,extraptab[nuvindex].beskrivelse);
		if (ws_brandtype==4 &&
			strcmp(extraptab[nuvindex].id,"905")==0) {
			strcpy(tmpstr, "Barnesæde 0-12 måneder");
		}
		if (ws_brandtype==4 &&
			strcmp(extraptab[nuvindex].id,"906")==0) {
			strcpy(tmpstr, "Barnesæde 1-3 år");
		}
		if (ws_brandtype==4 &&
			strcmp(extraptab[nuvindex].id,"907")==0) {
			strcpy(tmpstr, "Barnesæde 4-7 år");
		}
		if (ws_brandtype==4 &&
			strcmp(extraptab[nuvindex].id,"PAI")==0) {
			strcpy(tmpstr, "Person- og tyveriforsikring");
		}

		pack_alfa(tmpstr);
/* RETTET 131210 EXTRATEKSTER
		pack_alfa(extraptab[nuvindex].beskrivelse);
*/
		pack_alfa(extraptab[nuvindex].enhedtxt);
		ege_w_dou1 = extraptab[nuvindex].enhedpris;
/* NYT 140509 PSPAIUDREGNLM */
		if (ws_brandtype==4 && inpfunk==2 &&
			strcmp(extraptab[nuvindex].id,"PAI")==0 &&
			r159->pai_antal_dage>1) {
			ege_w_dou1 *= (double)r159->pai_antal_dage;
		}
/* NYT 121129 PAIPRDAG */
		if (ws_funktion==4 &&
			strcmp(extraptab[nuvindex].id,"PAI")==0 &&
			r159->pai_antal_dage>1) {
			ege_w_dou1 *= (double)r159->pai_antal_dage;
		}
/* NYT 121129 BSTOLPRDAG */
		if (ws_funktion==4 &&
			strcmp(extraptab[nuvindex].id,"932")==0 &&
			r159->pai_antal_dage>1) {
			ege_w_dou1 *= (double)r159->pai_antal_dage;
		}
		if (ws_funktion==4 &&
			strcmp(extraptab[nuvindex].id,"933")==0 &&
			r159->pai_antal_dage>1) {
			ege_w_dou1 *= (double)r159->pai_antal_dage;
		}
		if (ws_funktion==4 &&
			strcmp(extraptab[nuvindex].id,"934")==0 &&
			r159->pai_antal_dage>1) {
			ege_w_dou1 *= (double)r159->pai_antal_dage;
		}
/* NYT 121214 VDÆK ANH */
		if (ws_funktion==4 &&
			strcmp(extraptab[nuvindex].id,"910")==0 &&
			r159->pai_antal_dage>1) {
			ege_w_dou1 *= (double)r159->pai_antal_dage;
		}
		specialudregn = 0;
/* RETTET 130313 ANHÆNGERTRÆK
		if (ws_funktion==4 &&
			strcmp(extraptab[nuvindex].id,"901")==0 &&
			r159->pai_antal_dage>1) {
			ege_w_dou1 *= (double)r159->pai_antal_dage;
		}
*/
		if (ws_funktion==4 &&
			strcmp(extraptab[nuvindex].id,"901")==0 &&
			r159->pai_antal_dage>2 &&
			r159->pai_antal_dage<=7) {
			specialudregn = 1;
		}
		if (ws_funktion==4 &&
			strcmp(extraptab[nuvindex].id,"901")==0 &&
			r159->pai_antal_dage>18) {
			specialudregn = 1;
		}
		if (ws_funktion==4 &&
			strcmp(extraptab[nuvindex].id,"901")==0 &&
			r159->pai_antal_dage>1 &&
			specialudregn==0) {
			ege_w_dou1 *= (double)r159->pai_antal_dage;
		}

/* NYT 131202 GPS */
		if (ws_funktion==4 &&
			strcmp(extraptab[nuvindex].id,"924")==0 &&
			r159->pai_antal_dage>1) {
			ege_w_dou1 *= (double)r159->pai_antal_dage;
		}
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);
		pack_int2((long)extraptab[nuvindex].nuvantal);
		pack_int2((long)extraptab[nuvindex].minantal);
		pack_int2((long)extraptab[nuvindex].maxantal);
		pack_alfa(extraptab[nuvindex].valgtype);
/* NYT 131204 PSEXTRA */
		if (inpfunk==1) {
			pack_exchkend();
			send_linie();
			if (logfil) {
				fprintf(logfil, "SENDT:str=%s", str);
				fflush(logfil);
			}
		}
		nuvindex++;
		retur++;
	}
/* NYT 140424 KMPAKKEXLS */
/*
	if (ws_brandtype==4 && inpfunk==2) {
		funkretur = add_xlskmpk(1,ws_station,ws_specnr,ws_grp,varighed);
	}
	if (ws_brandtype==4 && inpfunk==2 && funkretur>0) {
		retur++;
	}
*/
/* TEST 140424 SRNXLS
	if (ws_brandtype==4 && inpfunk==2) {
		funkretur = add_xlssrn(1,ws_station,ws_specnr,ws_grp,varighed);
	}
	if (ws_brandtype==4 && inpfunk==2 && funkretur>0) {
		retur++;
	}
*/

	if (logfil) {
		fprintf(logfil,
			"send_extraptab:retur=%d\n",
			retur);
		fflush(logfil);
	}
	return(retur);
}

/* NYT 140424 KMPAKKEXLS */
/* ************************************************************** */
static int add_xlskmpk(int inpfunk,short inpstation,short inpspec,char * inpgrp,long inpvarighed) {
	int retur = 0;
	int nuvidx = 0;
	int xlsprisflag = 0;
	long int varighed = 0;
	char prisfilid[41] = "";
	char tmpstr[81] = "";
	char tmpstr2[81] = "";
	char prisstr[21] = "";
	int matchidx = 0;
	char matchtabel[10][81] = {"","","","","","","","","",""};

	if (logfil) {
		fprintf(logfil,"add_xlskmpk %d %hd %hd %s %ld\n",
			inpfunk,
			inpstation,
			inpspec,
			inpgrp,
			inpvarighed);
	}
	varighed = inpvarighed;
	sprintf(prisfilid,"PS%5.5hd%5.5hdSTD",
		inpstation,
		inpspec);
	sprintf(tmpstr,"%s.kmpk",prisfilid);
	xlsprismatch->specnr = (long int)inpspec;
	xlsprismatch->xtraflag = 1;
	xlsprismatch->lbnr = 0;
	xlsprismatch->xtraantal = 0;
	while (xlsprismatch->lbnr<100) {
		xlsprismatch->lbnr++;
		if (logfil) {
			fprintf(logfil,"\t\txlsprismatch _lbnr=%d\n",
				xlsprismatch->lbnr);
		}
		xlsprisflag = xlspris_udpakkmpk(tmpstr,inpgrp,inpstation);
		if (logfil) {
			fprintf(logfil,"\t\txlsprisflag=%d (%s)\n",
				xlsprisflag,ws_prisfilid);
			fprintf(logfil,"\t\txlsprissub _prisprenhed=%lf\n",
				xlsprissub->prisprenhed);
			fprintf(logfil,"\t\txlsprissub _xtratxt=%s\n",
				xlsprissub->xtratxt);
			fprintf(logfil,"\t\txlsprissub _pristxt=%s\n",
				xlsprissub->pristxt);
			fprintf(logfil,"\t\txlsprissub _xtraspecnr=%ld\n",
				xlsprissub->xtraspecnr);
		}
		if (xlsprisflag<=0) {
			break;
		}
		if (xlsprismatch->lbnr==1) {
/* NYT 140430 DROPDOWNEXTRAPRIS */
			ege_w_dou1 = 0;
			xls_char(prisstr,(double)ege_w_dou1,2);
			sprintf(matchtabel[matchidx],"%s;%s;%s",
				"KM0",
				"Ingen valgt",
				prisstr);
			matchidx++;
		}
		strcpy(tmpstr2,xlsprissub->pristxt+2);
		tmpstr2[4] = '\0';
		if (tmpstr2[3]=='+') {
			strcat(tmpstr2," km - DKK ");
		} else {
			strcat(tmpstr2,"km - DKK ");
		}
		ege_w_dou1 = xlsprissub->prisprenhed;
		xls_char(prisstr,(double)ege_w_dou1,2);
		strcat(tmpstr2,prisstr);
		sprintf(matchtabel[matchidx],"%s;%s;%s",
			xlsprissub->xtratxt,
			tmpstr2,
			prisstr);
		matchidx++;
	}
	nuvidx = 0;
	while (logfil && nuvidx<matchidx) {
		fprintf(logfil,"\t(%d)matchtabel-%d=<%s>\n",
			matchidx,
			nuvidx,
			matchtabel[nuvidx]);
		nuvidx++;
	}
	nuvidx = 0;
	if (matchidx>0) {
		retur = 1;
		strcpy(tmpstr2,"969");
		if (access("pskmpkspecnr888",0)==0) {
			strcpy(tmpstr2,"888");
		}
/* NYT 141111 PSKMPK840 */
		if (access("pskmpkspecnr840",0)==0) {
			strcpy(tmpstr2,"840");
		}

		pack_alfa(tmpstr2);
/* NYT 140904 KMPKSPECNR 888
		pack_alfa("969");
*/
		pack_alfa("Km-pakke");
		pack_int((long int)matchidx);
		pack_alfa("KM0");
	}
	while (nuvidx<matchidx) {
		(void)get_alfa_tgn(matchtabel[nuvidx],0,tmpstr2,';');
		pack_alfa(tmpstr2);
		(void)get_alfa_tgn(matchtabel[nuvidx],1,tmpstr2,';');
		pack_alfa(tmpstr2);
/* NYT 140430 DROPDOWNEXTRAPRIS */
		(void)get_alfa_tgn(matchtabel[nuvidx],2,tmpstr2,';');
		pack_alfa(tmpstr2);
		nuvidx++;
	}
	if (matchidx>0) {
		pack_alfa("DROPDOWNEXTRA");
	}
	if (logfil) {
		fprintf(logfil,"add_xlskmpk retur=%d\n",retur);
	}
	return(retur);
}

/* NYT 140428 SRNXLS */
/* ************************************************************** */
static int add_xlssrn(int inpfunk,short inpstation,short inpspec,char * inpgrp,long inpvarighed) {
	int retur = 0;
	int nuvidx = 0;
	int xlsprisflag = 0;
	long int varighed = 0;
	char prisfilid[41] = "";
	char tmpstr[81] = "";
	char tmpstr2[81] = "";
	char prisstr[21] = "";
	char xtragrp[21] = "";
	int matchidx = 0;
	char matchtabel[10][81] = {"","","","","","","","","",""};

	if (logfil) {
		fprintf(logfil,"add_xlssrn %d %hd %hd %s %ld\n",
			inpfunk,
			inpstation,
			inpspec,
			inpgrp,
			inpvarighed);
	}
	varighed = inpvarighed;
	sprintf(prisfilid,"PS%5.5hd%5.5hdSTD",
		inpstation,
		inpspec);
	sprintf(tmpstr,"%s.xtra",prisfilid);
	xlsprismatch->specnr = (long int)947;
	xlsprismatch->xtraflag = 1;
	xlsprismatch->lbnr = 0;
	xlsprismatch->xtraantal = 0;
	xlsprismatch->srnselvrisiko = 1000;

	varighed = inpvarighed;
	strcpy(xtragrp,"ALLE");
        xlsprisflag = xlspris_udpaksub(tmpstr,
                xtragrp,
                (long int)varighed);
	if (logfil) {
		fprintf(logfil,"\txlsprisflag=%d\n",
			xlsprisflag);
		fprintf(logfil,"\txlsprissub _prisprenhed=%lf\n",
			xlsprissub->prisprenhed);
	}
	xlsprismatch->srnselvrisiko = 0;
	if (xlsprisflag>0) {
/* NYT 140430 DROPDOWNEXTRAPRIS */
		ege_w_dou1 = 0;
		xls_char(prisstr,(double)ege_w_dou1,2);

		sprintf(matchtabel[matchidx],"%s;%s;%s",
			"SRN0",
			"Ingen valgt",
			prisstr);
		matchidx++;

		strcpy(tmpstr2,"Selvrisiko DKK 1000 - DKK ");
		ege_w_dou1 = xlsprissub->prisprenhed;
		xls_char(prisstr,(double)ege_w_dou1,2);
		strcat(tmpstr2,prisstr);
		sprintf(matchtabel[matchidx],"%s;%s;%s",
			"SRN1000",
			tmpstr2,
			prisstr);
		matchidx++;
	}
	nuvidx = 0;
	while (logfil && nuvidx<matchidx) {
		fprintf(logfil,"\t(%d)matchtabel-%d=<%s>\n",
			matchidx,
			nuvidx,
			matchtabel[nuvidx]);
		nuvidx++;
	}
	nuvidx = 0;
	if (matchidx>0) {
		retur = 1;
		pack_alfa("947");
		pack_alfa("Selvrisikonedsættelse");
		pack_int((long int)matchidx);
		pack_alfa("SRN0");
	}
	while (nuvidx<matchidx) {
		(void)get_alfa_tgn(matchtabel[nuvidx],0,tmpstr2,';');
		pack_alfa(tmpstr2);
		(void)get_alfa_tgn(matchtabel[nuvidx],1,tmpstr2,';');
		pack_alfa(tmpstr2);
/* NYT 140430 DROPDOWNEXTRAPRIS */
		(void)get_alfa_tgn(matchtabel[nuvidx],2,tmpstr2,';');
		pack_alfa(tmpstr2);

		nuvidx++;
	}
	if (matchidx>0) {
		pack_alfa("DROPDOWNEXTRA");
	}
	if (logfil) {
		fprintf(logfil,"add_xlssrn retur=%d\n",retur);
	}
	return(retur);
}

/* NYT 140822 FLYTTEKASSERXLS */
/* ************************************************************** */
static int add_xls980(int inpfunk,short inpstation,short inpspec,char * inpgrp,long inpvarighed) {
	int retur = 0;
	int nuvidx = 0;
	int xlsprisflag = 0;
	long int varighed = 0;
	char prisfilid[41] = "";
	char tmpstr[81] = "";
	char tmpstr2[81] = "";
	char tmpstr3[81] = "";
	char prisstr[21] = "";
	char xtragrp[21] = "";
	int antalidx = 0;
	int antaltabel[20] = {10,20,30,40,50,0,0,0,0,0,
				0,0,0,0,0,0,0,0,0,0};
	int matchidx = 0;
	char matchtabel[20][81] = {"","","","","","","","","","",
				"","","","","","","","","",""};

	if (logfil) {
		fprintf(logfil,"add_xls980 %d %hd %hd %s %ld\n",
			inpfunk,
			inpstation,
			inpspec,
			inpgrp,
			inpvarighed);
	}
	varighed = inpvarighed;
	antalidx = 0;
	while (antalidx<20) {
		if (logfil) {
			fprintf(logfil,"\t\tantalidx=%d=%d\n",
				antalidx,
				antaltabel[antalidx]);
		}
		if (antaltabel[antalidx]<=0) {
			antalidx++;
			continue;
		}
		sprintf(prisfilid,"PS%5.5hd%5.5hdSTD",
			inpstation,
			inpspec);
		sprintf(tmpstr,"%s.xtra",prisfilid);
		xlsprismatch->specnr = (long int)980;
		xlsprismatch->xtraflag = 1;
		xlsprismatch->lbnr = 0;
		xlsprismatch->xtraantal = antaltabel[antalidx];
		xlsprismatch->srnselvrisiko = 0;

		varighed = inpvarighed;
		strcpy(xtragrp,"ALLE");
		xlsprisflag = xlspris_udpaksub(tmpstr,
			xtragrp,
			(long int)0);
		if (logfil) {
			fprintf(logfil,"\t\txlsprisflag=%d\n",
			xlsprisflag);
			fprintf(logfil,"\t\txlsprissub _prisprenhed=%lf\n",
				xlsprissub->prisprenhed);
		}
		if (xlsprisflag>0 && antalidx==0) {
			ege_w_dou1 = 0;
			xls_char(prisstr,(double)ege_w_dou1,2);
			sprintf(matchtabel[matchidx],"%s;%s;%s",
				"FLK0",
				"Ingen valgt",
				prisstr);
			matchidx++;
		}
		sprintf(tmpstr2,"1 flyttekasse - DKK ");
		if (antaltabel[antalidx]>1) {
			sprintf(tmpstr2,"%d flyttekasser - DKK ",
				antaltabel[antalidx]);
		}
		ege_w_dou1 = xlsprissub->prisprenhed;
/* NYT 140910 PSFLKTOTALPRIS */
		ege_w_dou1 *= (double)antaltabel[antalidx];

		xls_char(prisstr,(double)ege_w_dou1,2);
		strcat(tmpstr2,prisstr);
/* RETTET 140910 PSFLKTOTALPRIS
		ege_w_dou1 *= (double)antaltabel[antalidx];
*/
		xls_char(prisstr,(double)ege_w_dou1,2);

		sprintf(tmpstr3,"FLK%d",antaltabel[antalidx]);

		sprintf(matchtabel[matchidx],"%s;%s;%s",
			tmpstr3,
			tmpstr2,
			prisstr);
		matchidx++;

		antalidx++;
	}

	nuvidx = 0;
	while (logfil && nuvidx<matchidx) {
		fprintf(logfil,"\t(%d)matchtabel-%d=<%s>\n",
			matchidx,
			nuvidx,
			matchtabel[nuvidx]);
		nuvidx++;
	}

	nuvidx = 0;
	if (matchidx>0) {
		retur = 1;
		pack_alfa("980");
		pack_alfa("Flyttekasse(r)");
		pack_int((long int)matchidx);
		pack_alfa("FLK0");
	}
	while (nuvidx<matchidx) {
		(void)get_alfa_tgn(matchtabel[nuvidx],0,tmpstr2,';');
		pack_alfa(tmpstr2);
		(void)get_alfa_tgn(matchtabel[nuvidx],1,tmpstr2,';');
		pack_alfa(tmpstr2);
		(void)get_alfa_tgn(matchtabel[nuvidx],2,tmpstr2,';');
		pack_alfa(tmpstr2);
		nuvidx++;
	}
	if (matchidx>0) {
		pack_alfa("DROPDOWNEXTRA");
	}
afslut:
	if (logfil) {
		fprintf(logfil,"add_xls980 retur=%d\n",retur);
	}
	return(retur);
}

/* ********************************* */
static int send_match_prodliste(funk,langstr,station,kundenr,grp,fradt,tildt)
short int funk;
char * langstr;
short int station;
long int kundenr;
char * grp;
long int fradt;
long int tildt; {
	short int retur = 0;
	short int fejlkode = 0;
	short int dondafolo = 0;
	short int sendflag = 0;
	short int wx1 = 0;
	short int wx2 = 0;
	short int blokfundet = 0;
	short int funkretur = 0;
	short int funkretur2 = 0;
	short int specantal = 0;
	short int prisspecnr = 0;
	short int prisenhed = 0;
	short int prisextra = 0;
	short int prissmdgn = 0;
	short int prisdgvarighed = 0;
	short int pristmvarighed = 0;
	short int pristill = 0;
	short int prisafhfratid = 0;
	short int prisafltiltid = 0;
	short int stationafhtiltid = 0;
	short int stationaflfratid = 0;
	short int saesonextspc = 0;
	short int saesonextant = 0;

	short int tillspecnr = 0;
	short int tillantal = 0;
	short int nytillantal = 0;

	short int mintolerance = 0;
	short int maxtolerance = 1;
	short int gemmintol = 0;
	short int gemmaxtol = 1;
	short int forskelvarighed = 0;
	short int kundenrtype = 0;

	short int koblenhed = 0;
	short int koblfra = 0;
	short int kobltil = 0;
	short int koblspecnr = 0;
	short int koblfyraftenext = 0;
	long int tilbtvgafldato = 0;
	short int tilbtvgextspc = 0;
	short int tilbtvgextant = 0;

	long int minperiode = 0;
	long int evttildato = 0;
	long int kundevarighed = 0;
	long int chkantaldg = 0;
	long int chkfradgnr = 0;
	long int julian = 0;
	long int returdato = 0;
	long int udregndato = 0;
	long int udregnvar = 0;
	long int returaud = 0;
	long int specialfradato = 0;
	long int specialtildato = 0;
	long int altdato = 0;
	long int extfdato = 0;
	long int exttdato = 0;
	long int nytildt = 0;

	long int firmakundenr = 0;
	long int firmaaftfra = 0;
	long int firmaafttil = 0;
	short int aftaleflag = 0;
	short int weekendflag = 0;
	short int tvungenextspecnr = 0;

	char tmpstr[81] = "";
	char tmpgrpliste[81] = "";
	char tmpferienavn[41] = "";
	char tmpdatointerval[101] = "";
	char tmpfelt[81] = "";
	char stdgstr[81] = "";
	char f198key[21] = "";
	char transstr[21] = "";
	char weekenddtstr[31] = "";
	short int pgaabenflag = 0;
	char pgfilsti[81] = "";

/* OBS */
	if (ws_funktion==3) {
		dondafolo = 1;
		mintolerance = -1;
		ws_prodsortflag = 1;
	}
	log_stopur(80);

	if (logfil) {
		fprintf(logfil,
			"send_match_prodliste:fradt=%ld,tildt=%ld\n",
			fradt,
			tildt);
		fprintf(logfil,
			"send_match_prodliste:kundenr=%ld\n",
			kundenr);
		fprintf(logfil,
			"send_match_prodliste:dondafolo=%hd\n",
			dondafolo);
		fprintf(logfil,
			"send_match_prodliste:ws_prodsortflag=%hd\n",
			ws_prodsortflag);
		fprintf(logfil,
			"send_match_prodliste:ws_fratid=%ld\n",
			ws_fratid);
		fprintf(logfil,
			"send_match_prodliste:ws_sttlfnr=%s\n",
			ws_sttlfnr);
		fprintf(logfil,
			"send_match_prodliste:ws_inputspecnr=%hd\n",
			ws_inputspecnr);
		fprintf(logfil,
			"send_match_prodliste:ws_stepnr=%d\n",
			ws_stepnr);
	}

/* NYT 140227 PGAABEN */
/*
	if (ws_pgflag>0) {
		pgaabenflag = dan_pgaaben(1,station,pgfilsti);
	}
	if (ws_pgflag>0 && pgaabenflag>0) {
		strcpy(ws_pgaabenfilsti,pgfilsti);
	}
*/
	if (logfil) {
		fprintf(logfil,"\tpgaabenflag=%d\n",pgaabenflag);
		fprintf(logfil,"\tpgfilsti=%s\n",pgfilsti);
	}

/* NYT 111020 STTLF */
	if (station>0) {
		strcpy(ws_sttlfnr,"N/A");
		reclow(r166,R166);
		f166_start(1,ISGTEQ);
		r166->stat_nr = station;
		egeread(f166,ISEQUAL);
		if (f166_ok) {
			strcpy(ws_sttlfnr,r166->tlf);
		}
	}
/* AFTALEFLAG */
        if (kundenr>0 && firmakundenr==0) {
		reclow(r167, R167);
		f167_start(1, ISGTEQ);
		r167->kunde_nr = kundenr;
		egeread(f167, ISEQUAL);
		if (f167_ok) {
			kundenrtype = r167->type;
			firmakundenr = r167->firma_reference;
		}
	}
/* NYT 130319 ERHVERVSPRISER */
	if (logfil) {
		fprintf(logfil,"\tkundenrtype=%hd\n",kundenrtype);
	}
        if (kundenr>0 && firmakundenr==0 && kundenrtype==2) {
		firmakundenr = kundenr;
	}
	if (firmakundenr>0) {
		if (find_r178(0,16,0,(double)firmakundenr)>0) {
			firmaaftfra = (long int)r178->num_felt;
		}
		if (find_r178(0,4,0,(double)firmakundenr)>0) {
			firmaafttil = (long int)r178->num_felt;
		}
		if (firmaafttil==0) {
			firmaafttil = 99999999;
		}
	}
	if (firmakundenr>0 &&
		firmaaftfra>0 &&
		ws_systemdato>=firmaaftfra && ws_systemdato<=firmaafttil) {
		aftaleflag = 1;
	}
/* NYT 130122 FIRMAAFTALEOFF */
	if (kundenrtype==1) {
		aftaleflag = 0;
	}

	if (logfil) {
		fprintf(logfil, "send_match_prodliste:firmakundenr=%ld\n",
			firmakundenr);
		fprintf(logfil, "send_match_prodliste:aftaleflag=%hd\n",
			aftaleflag);
	}

	returdato = m036_funktion(11, fradt);
	chkfradgnr = returdato%10;
	julian = m036_funktion(12, fradt);
        chkantaldg = m036_funktion(12, tildt);
	chkantaldg -= julian;
	kundevarighed = chkantaldg;

	if (dondafolo>0 && chkantaldg>14) {
		mintolerance = -2;
		maxtolerance = 2;
	}
	if (logfil) {
		fprintf(logfil, "send_match_prodliste:kundevarighed=%ld\n",
			kundevarighed);
		fprintf(logfil, "send_match_prodliste:chkantaldg=%ld\n",
			chkantaldg);
		fprintf(logfil, "send_match_prodliste:chkfradgnr=%ld\n",
			chkfradgnr);
		fprintf(logfil,
			"send_match_prodliste:mintolerance=%hd\n",
			mintolerance);
		fprintf(logfil,
			"send_match_prodliste:maxtolerance=%hd\n",
			maxtolerance);
	}
	gemmintol = mintolerance;
	gemmaxtol = maxtolerance;
/* NYT 081124 TILBUD
	if (ws_testkreds<=0 &&
		tilbud_paa_vej(station,fradt,tildt,chkantaldg)>0) {
		return(0);
	}
*/
/*
	if (chkantaldg<=0) {
		return(0);
	}
*/
	log_stopur(81);
/* NYT 091016 */
	blokfundet = 0;

	funkretur = check_minsalg(2,16625,station,ws_grp,fradt,tildt);
/* RETTET 131127 JUL2013
	funkretur = check_minsalg(2,16625,station,"",fradt,tildt);
*/
/*
	funkretur = check_f198_dato(1,16625,(double)station,"",fradt,tildt);
*/
	if (funkretur>0) {
		if (logfil) {
			fprintf(logfil,
			"send_match_prodliste:16625FUNDET %hd\n",funkretur);
			fprintf(logfil,
			"send_match_prodliste:num=%.0lf,alfa=%s\n",
			r198->numfelt,
			r198->alfafelt);
			fprintf(logfil,
			"send_match_prodliste:chkantaldg=%ld\n",
			chkantaldg);
		}
	}
	if (funkretur>0) {
		(void)get_alfa_tgn(r198->alfafelt,0,tmpgrpliste,';');
		(void)get_alfa_tgn(r198->alfafelt,1,tmpferienavn,';');
		(void)get_alfa_tgn(r198->alfafelt,2,tmpdatointerval,';');
	}
	if (funkretur>0 && strcmp(tmpgrpliste,"*")==0) {
		blokfundet = 1;
		minperiode = (long int)r198->numfelt;
	}
/* NYT 131128 JUL2013 */
	if (funkretur>0 && strcmp(ws_grp,tmpgrpliste)==0) {
		blokfundet = 1;
		minperiode = (long int)r198->numfelt;
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,
			"send_prod_matchliste:blokfundet=%hd\n",blokfundet);
		fprintf(logfil,
			"send_prod_matchliste:tmpgrpliste=%s\n",tmpgrpliste);
		fprintf(logfil,
			"send_prod_matchliste:tmpferienavn=%s\n",tmpferienavn);
		fprintf(logfil,
			"send_prod_matchliste:tmpdatointerval=%s\n",tmpdatointerval);
		fprintf(logfil,
			"send_prod_matchliste:minperiode=%ld\n",minperiode);
	}
/* NYT 091102 */
	if (funkretur>0 && blokfundet==1 &&
		chkantaldg>=minperiode) {
		blokfundet = 0;
	}
	if (funkretur>0 && blokfundet==1) {
		fejlkode = -28;
	}
/*
	if (funkretur>0 &&
		blokfundet==1 &&
		r198->numfelt>0 &&
		chkantaldg<minperiode) {
		fejlkode = -28;
	}
*/
	log_stopur(82);
/* NYT 111110 DONAFLBLOK */
	if (blokfundet<=0) {
		funkretur = check_ecdon_aflblok(1,
			station,
			grp,
			fradt,
			tildt,
			tmpfelt);
	}
	if (blokfundet<=0 && funkretur>0) {
		fejlkode = -28;
		blokfundet = 1;
		strcpy(tmpferienavn,"DONAFLBLOK");
	}
	if (logfil) {
		fprintf(logfil,
			"AFLBLOK blokfundet=%hd\n",blokfundet);
		fprintf(logfil,
			"\ttmpferienavn=%s\n",tmpferienavn);
	}
/* NYT 111114 DONPRODHENVIS */
	if (strcmp(grp,"3")==0 &&
		chkantaldg>=21 && chkantaldg<30) {
		fejlkode = -28;
		strcpy(tmpferienavn,"DONPRODHENV01");
	}
/* NYT 111114 DONPRODHENVIS */
	if (strcmp(grp,"A")==0 &&
		chkantaldg>=19 && chkantaldg<30) {
		fejlkode = -28;
		strcpy(tmpferienavn,"DONPRODHENV01");
	}
	if (chkantaldg>=81) {
		fejlkode = -28;
		strcpy(tmpferienavn,"DONPRODHENV02");
	}
/* NYT 120120 CHECK STOPSALG */
        funkretur = check_stopsalg(1,ws_station,ws_grp,ws_fradato,ws_tildato);
        if (funkretur>0) {
		fejlkode = -28;
		strcpy(tmpferienavn,"DONSTOPSALG");
        }

	if (fejlkode==-28 && strcmp(tmpferienavn,"st.bede")==0) {
		fejlkode = -29;
	}
	if (fejlkode==-28 && strcmp(tmpferienavn,"kr.him")==0) {
		fejlkode = -30;
	}
	if (fejlkode==-28 && strcmp(tmpferienavn,"pinse")==0) {
		fejlkode = -31;
	}
	if (fejlkode==-28 && strcmp(tmpferienavn,"jul")==0) {
		fejlkode = -32;
	}
	if (logfil) {
		fprintf(logfil,
			"\ttmpferienavn=%s\n",tmpferienavn);
		fprintf(logfil,
			"\tfejlkode=%hd\n",fejlkode);
	}
	if (fejlkode!=0 && strlen(tmpdatointerval)) {
		sprintf(ws_differrormess,
"Der kan ikke bookes enkelte dage i perioden %s.",
			tmpdatointerval);
	}
/* RETTET 140508 DONHLGTLF
	if (fejlkode!=0 && strlen(tmpdatointerval)) {
		sprintf(ws_differrormess,
"Der kan ikke bookes enkelte dage i perioden %s. Kontakt derfor nærmeste udlejningssted på tlf.%s.",
			tmpdatointerval,
			"7011 4455");
	}
*/
/* NYT 131128 JUL2013 */
	if (fejlkode!=0 && strlen(tmpdatointerval) && fejlkode==-32) {
		sprintf(ws_differrormess,
			"Julen %4.4ld: %s.",
			(long)(ws_fradato/10000),
			tmpdatointerval);
/* RETTET 141118 DONJUL2014
		sprintf(ws_differrormess,
			"Julen 2013: %s.",
			tmpdatointerval);
*/
/*
		sprintf(ws_differrormess,
			"Julen 2013: Enkelte dage kan ikke bookes %s.",
			tmpdatointerval);
*/
	}
/* NYT 111110 DONAFLBLOK */
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONAFLBLOK")==0) {
		sprintf(ws_differrormess,
"Det er ikke muligt at aflevere denne dag. Prøv venligst en anden afleveringsdag eller kontakt os på tlf.%s.",
			"7011 4455");
	}
/* NYT 111114 DONPRODHENVIS */
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONPRODHENV01")==0 &&
		strcmp(langstr,"EN")!=0) {
		sprintf(ws_differrormess,
"Ved billeje på denne periode (%ld dage) er det prisen på 30 dage som bedst kan betale sig. Ret dato til 30 dage og prøv venligst igen.",chkantaldg);
	}
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONPRODHENV01")==0 &&
		strcmp(langstr,"EN")==0) {
		sprintf(ws_differrormess,
"The price for 30 days is cheaper than the chosen rental period (%ld days). Please change the period to 30 days.",chkantaldg);
	}
/* NYT 120119 DONPRODHENVIS */
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONPRODHENV02")==0 &&
		strcmp(langstr,"EN")!=0) {
		sprintf(ws_differrormess,
			"Ring %s for et leasing-tilbud.",ws_sttlfnr);
	}
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONPRODHENV02")==0 &&
		strcmp(langstr,"EN")==0) {
		sprintf(ws_differrormess,
			"Please call %s for a long term offer.",ws_sttlfnr);
	}
/* NYT 120120 DONSTOPSALG */
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONSTOPSALG")==0 &&
		strcmp(langstr,"EN")!=0) {
		sprintf(ws_differrormess,
			"Problemer med at booke. Ring evt. til %s.",
				ws_sttlfnr);
	}
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONSTOPSALG")==0 &&
		strcmp(langstr,"EN")==0) {
		sprintf(ws_differrormess,
			"Booking error. Please call %s.",ws_sttlfnr);
	}

	if (fejlkode!=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)fejlkode);
		web_errormess(0,ws_langstr,"28");
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		return(0);
	}

	reclow(r165,R165);
	r165->stat_nr = station;
	f165_start(2, ISGTEQ);
	if (f165_ukendt) {
		specantal = -1;
	}
listeigen:
	if (logfil) {
		fprintf(logfil,
		"send_match_prodliste:LISTEIGEN\n");
	}
	reccpy(&w165, r165, R165);
	while (specantal>=0) {
		log_stopur(70);
		reccpy(r165,&w165,R165);
		f165_start(2,ISGREAT);
		if (f165_ukendt) {
			break;
		}
		egeread(f165, ISNEXT);
		if (f165_eof) {
			break;
		}
		if (r165->stat_nr>station) {
			break;
		}
		reccpy(&w165,r165,R165);
/* NYT 120910 ProductId Input */
		if (ws_inputspecnr>0 && r165->spec_nr!=ws_inputspecnr) {
			continue;
		}
/* NYT 130321 TVUNGENMAANED */
		if (tvungenextspecnr>0 && r165->spec_nr!=tvungenextspecnr) {
			continue;
		}
		if (r165->slet_mark>0) {
			continue;
		}
		if (strcmp(r165->bil_grp,grp)!=0) {
			continue;
		}
/* NYT 080620 */
		if (logfil) {
			fprintf(logfil,
	"send_match_prodliste:TOPLOOP r165 SPEC%hd,stat=%hd,grp=<%s>\n",
				r165->spec_nr,
				r165->stat_nr,
				r165->bil_grp);
		}


/* NYT 051115 */
		if (check_webspecnr(r165->spec_nr,
			r165->stat_nr,	
			r165->bil_grp)<=0) {
			continue;
		}
/* NYT 070328 CHECK ST 56 SPECNR BLOK */
		funkretur = check_f198_spcstgrpblok(1,
			r165->spec_nr,
			station,
			r165->bil_grp,
			fradt,
			tildt);
		if (funkretur>0 && logfil) {
			fprintf(logfil,
			"send_match_prodliste:spcstgrpblok 16578 fundet\n");
		}
		if (funkretur>0) {
			continue;
		}
		if (logfil) {
			fprintf(logfil,
			"send_match_prodliste:SPECNR=%hd,%s\n",
				r165->spec_nr,
				r165->bil_grp);
			fprintf(logfil,
			"send_match_prodliste:ws_fratid=%ld\n",
				ws_fratid);
		}
		mintolerance = gemmintol;
		maxtolerance = gemmaxtol;
		prisextra = 0;
/* NYT 060323 SÆSONTILBUD */
		ws_donsaesonflag = 0;
		saesonextspc = 0;
		saesonextant = 0;
		extfdato = 0;
		exttdato = 0;
		funkretur = check_don_tilbud(chkantaldg,
			ws_station,
			r165->spec_nr,
			ws_grp,
			r165->enhed,
			fradt,
			tildt,
			tmpstr);
		if (funkretur>0) {
			ws_donsaesonflag = 1;
			mintolerance = -7;
			maxtolerance = 7;
			fprintf(logfil,
			"send_match_prodliste:saesontilbud 16584 fundet\n");
			fprintf(logfil,
			"send_match_prodliste:%s\n",
				tmpstr);
		}
		if (funkretur>0 && strlen(tmpstr)) {
			(void)get_alfa_tgn(tmpstr,0,tmpfelt,';');
			if (strlen(tmpfelt)) {
				sscanf(tmpfelt,"%ld",&extfdato);
			}
			(void)get_alfa_tgn(tmpstr,1,tmpfelt,';');
			if (strlen(tmpfelt)) {
				sscanf(tmpfelt,"%ld",&exttdato);
			}
			(void)get_alfa_tgn(tmpstr,2,tmpfelt,';');
			if (strlen(tmpfelt)) {
				sscanf(tmpfelt,"%hd",&prisafhfratid);
			}
			(void)get_alfa_tgn(tmpstr,3,tmpfelt,';');
			if (strlen(tmpfelt)) {
				sscanf(tmpfelt, "%hd", &prisafltiltid);
			}
			(void)get_alfa_tgn(tmpstr,4,tmpfelt,';');
			if (strlen(tmpfelt)) {
				sscanf(tmpfelt, "%hd", &saesonextspc);
			}
			(void)get_alfa_tgn(tmpstr,5,tmpfelt,';');
			if (strlen(tmpfelt)) {
				sscanf(tmpfelt, "%hd", &saesonextant);
			}
		}
		if (funkretur==4 && strlen(tmpstr)) {
			tilbtvgafldato = exttdato;
			tilbtvgextspc = saesonextspc;
			tilbtvgextant = saesonextant;
		}
/* OBS 070308 PAASKE 2007 SPEC 650 MAX 6 DAGE
LØST VED AT SLETTE f198 16514 650 201;1;3;186;extradag
		if (funkretur>0 && r165->spec_nr==650 && chkantaldg>=7) {

		}
*/
/* OBS PAASKE 2009 090326 */
		if (funkretur<=0 && r165->spec_nr==650) {
			continue;
		}
		if (funkretur<=0 && r165->spec_nr==651) {
			continue;
		}
/* OBS PAASKE11 110323 */
		if (funkretur<=0 && r165->spec_nr==645) {
			continue;
		}
		if (funkretur<=0 && r165->spec_nr==646) {
			continue;
		}
		if (funkretur<=0 && r165->spec_nr==647) {
			continue;
		}
		if (funkretur<=0 && r165->spec_nr==648) {
			continue;
		}
		if (funkretur<=0 && r165->spec_nr==649) {
			continue;
		}

		if (logfil) {
			fprintf(logfil,
			"send_match_prodliste:extfdato=%ld,exttdato=%ld\n",
				extfdato,
				exttdato);
			fprintf(logfil,
		"send_match_prodliste:prisafhfratid=%hd,prisafltiltid=%hd\n",
				prisafhfratid,
				prisafltiltid);
			fprintf(logfil,
	"send_match_prodliste:ws_donsaesonflag=%hd,-extspc=%hd,-extant=%hd\n",
				ws_donsaesonflag,
				saesonextspc,
				saesonextant);
		}

/* NYT 051117 TVUNGEN */
		strcpy(tmpstr,"");
		funkretur = check_f198_datointerval(1,
			16585,(double)r165->spec_nr,tmpstr,fradt,tildt);
		if (funkretur<=0) {
			if (logfil) {
				fprintf(logfil,
		"send_match_prodliste:tv.datointerval 16585 chkantaldg=%ld\n",
				chkantaldg);
			}
		}
		if (funkretur<=0 && extfdato==0 && exttdato==0) {
			continue;
		}


/* FIRMAFTALE */
		funkretur=find_r198(1,16522,(double)r165->spec_nr,"",0);
		if (logfil) {
			fprintf(logfil,
		"send_match_prodliste:FIRMAAFTALE 16522 funkretur=%hd\n",
			funkretur);
			fprintf(logfil,"\t\tr198->numfelt=%lf\n",
				r198->numfelt);
			fprintf(logfil,"\t\taftaleflag=%hd\n",
				aftaleflag);
		}
		if (funkretur>0 && r198->numfelt>0 && aftaleflag==0) {
			continue;
		}

		specialfradato = 0;
		specialtildato = 99999999;
		funkretur = find_r198_special(1,1,16590,
			(double)r165->spec_nr,r165->bil_grp,100,tmpstr);
		if (funkretur>0 && strlen(tmpstr)) {
			(void)get_alfa_tgn(tmpstr,0,tmpfelt,';');
			if (strlen(tmpfelt)) {
				sscanf(tmpfelt,"%ld",&specialfradato);
			}
			(void)get_alfa_tgn(tmpstr,1,tmpfelt,';');
			if (strlen(tmpfelt)) {
				sscanf(tmpfelt,"%ld",&specialtildato);
			}
		}
		if (logfil) {
			fprintf(logfil,
		"send_match_prodliste:SPECIAL 16590 funkretur=%hd+%s\n",
			funkretur,
			tmpstr);
		}
		if (ws_donsaesonflag<=0 && fradt<specialfradato) {
			continue;
		}
		if (ws_donsaesonflag<=0 && fradt>specialtildato) {
			continue;
		}

		prisspecnr = r165->spec_nr;
		prisenhed = r165->enhed;
		prisextra = 0;
		prisdgvarighed = 0;
		prissmdgn = 0;
		pristmvarighed = 0;
		pristill = 0;
		if (ws_donsaesonflag<=0) {
			prisafhfratid = 0;
			prisafltiltid = 0;
			strcpy(stdgstr,"");
		}
		funkretur=find_r198(1,16503,(double)r165->spec_nr,"",0);
		if (funkretur>0 && ws_donsaesonflag<=0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisextra);
			}
			(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prissmdgn);
			}
			(void)get_alfa_tgn(r198->alfafelt,2,stdgstr,';');
			(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisafhfratid);
			}
			(void)get_alfa_tgn(r198->alfafelt,5,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisafltiltid);
			}
			(void)get_alfa_tgn(r198->alfafelt,6,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisdgvarighed);
			}
		}
/* NYT 130304 WEEKENDVARETID1600 */
		if (r165->spec_nr==196 &&
			strcmp(r165->bil_grp,"3")==0 &&
			prisafhfratid==1200) {
			prisafhfratid = 1600;
		}
/* NYT 071016 */
		if (logfil) {
			fprintf(logfil,
		"send_match_prodliste:find_r198 16503 funkretur=%hd\n",
				funkretur);
			fprintf(logfil,
		"send_match_prodliste:find_r198 16503 prisafhfratid=%hd\n",
				prisafhfratid);
			fprintf(logfil,
		"send_match_prodliste:find_r198 16503 ws_fratid=%ld\n",
				ws_fratid);
			fprintf(logfil,
		"send_match_prodliste:find_r198 16503 stdgstr=%s\n",
				stdgstr);
		}

/* NYT 070502 */
		if (dondafolo>0 &&
			fradt<ws_systemdato) {
			continue;
		}
		if (dondafolo>0 &&
			fradt==ws_systemdato &&
			ws_fratid<=ws_systemtid) {
			continue;
		}
		if (dondafolo>0 &&
			fradt==ws_systemdato) {
			ege_w_int1 = retur_minantal(ws_systemtid);
			ege_w_int2 = retur_minantal(ws_fratid);
			if (ege_w_int2-ege_w_int1<=60) {
				continue;
			}
		}
		if (dondafolo>0 &&
			fradt>=ws_systemdato &&
			prisafhfratid<ws_fratid) {
			prisafhfratid = ws_fratid;
		}
/* NYT OBS 090824 LØRDAG SØNDAG */
		if (dondafolo>0 && station==56 && r165->spec_nr==195) {
			strcpy(stdgstr,"6,7");
		}
		if (dondafolo>0 && station==56 && r165->spec_nr==180 &&
			strcmp(r165->bil_grp,"3")==0) {
			strcpy(stdgstr,"1,2,3,4,5");
		}

		if (dondafolo>0 && station==57 && r165->spec_nr==195) {
			strcpy(stdgstr,"6,7");
		}
		if (dondafolo>0 && station==57 && r165->spec_nr==180 &&
			strcmp(r165->bil_grp,"3")==0) {
			strcpy(stdgstr,"1,2,3,4,5");
		}


/* CHECK EXTRA */
		if (logfil) {
			fprintf(logfil,
		"send_match_prodliste:CHECK EXTRA prisextra=%hd\n",
				prisextra);
			fprintf(logfil,
		"send_match_prodliste:OBS 090824 stdgstr=%s\n",
				stdgstr);
		}



		if (prisextra>0) {
			continue;
		}
		if (prisdgvarighed==0 && prisenhed>200&&prisenhed<300) {
			prisdgvarighed = (prisenhed%200);
		}
		if (prisdgvarighed==0 && prisenhed>300&&prisenhed<400) {
			prisdgvarighed = (prisenhed%300);
			prisdgvarighed *= 7;
		}
		if (prisdgvarighed==0 && prisenhed>400&&prisenhed<500) {
			prisdgvarighed = (prisenhed%400);
			prisdgvarighed *= 30;
		}
		if (prisdgvarighed==0 && prisenhed==501) {
			prisdgvarighed = 3;
		}
		if (prisenhed>100&&prisenhed<200) {
			prisdgvarighed = 0;
			pristmvarighed = (prisenhed%100);
		}
/* NYT 051220 DATOBLOKERING */
		strcpy(tmpstr,"");
		julian = m036_funktion(12, fradt);
		julian += (long int)prisdgvarighed;
		returdato = m036_funktion(19, julian);
		if (logfil) {
			fprintf(logfil,
			"send_match_prodliste:datoblokering 16589 %ld-%ld\n",
				fradt,returdato);
		}
		funkretur = check_don_specblok(1,r165->spec_nr,ws_station,grp,fradt,returdato);
/* RETTET 081209
		funkretur = check_f198_dato(1,
			16589,(double)r165->spec_nr,tmpstr,fradt,returdato);
*/
		if (funkretur>0) {
			if (logfil) {
				fprintf(logfil,
			"send_match_prodliste:datoblokering 16571\n");
			}
		}
/* OBS 070308 PAASKE 2007 UGEPRIS IKKE JUL08
		if (funkretur>0 && prisdgvarighed>=7) {
			funkretur = 0;
		}
*/
		if (funkretur>0) {
			if (logfil) {
				fprintf(logfil,
			"send_match_prodliste:datoblokering overspring\n");
			}
			continue;
		}

/* NYT 060317 */
		blokfundet = 0;


/* NYT 091016 */
/*
		blokfundet = check_minsalg(2,16625,station,"",fradt,returdato);
		if (blokfundet>0) {
			if (logfil) {
				fprintf(logfil,
			"send_match_prodliste:blokfundet check_minsalg overspring\n");
			}
			continue;
		}
*/
		if (logfil) {
			fprintf(logfil,
			"send_match_prodliste:blokfundet=%hd\n",
			blokfundet);
			fprintf(logfil,
			"send_match_prodliste:prisspecnr=%hd\n",
			prisspecnr);
			fprintf(logfil,
			"send_match_prodliste:prisenhed=%hd\n",
			prisenhed);
			fprintf(logfil,
			"send_match_prodliste:prisdgvarighed=%hd\n",
			prisdgvarighed);
			fprintf(logfil,
			"send_match_prodliste:pristmvarighed=%hd\n",
			pristmvarighed);
			fprintf(logfil,
			"send_match_prodliste:prisafhfratid=%hd\n",
			prisafhfratid);
			fprintf(logfil,
			"send_match_prodliste:prisafltiltid=%hd\n",
			prisafltiltid);
		}
		sprintf(f198key, "%3.3hd%3.3hd%s",
			0,
			r165->spec_nr,
			"*");
		strcpy(r198->alfafelt,"");
		funkretur = find_r198(1,16527,(double)0,f198key,0);
		if (logfil) {
			fprintf(logfil,
			"send_match_prodliste:16527:f198key=%s,funkretur=%hd\n",
			f198key,
			funkretur);
		}
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				strcpy(stdgstr,tmpstr);
			}
			(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prissmdgn);
			}
			(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &pristill);
			}
		}
		sprintf(f198key, "%3.3hd%3.3hd%s",
			station,
			r165->spec_nr,
			"*");
		strcpy(r198->alfafelt,"");
		funkretur = find_r198(1,16527,(double)0,f198key,0);
		if (logfil) {
			fprintf(logfil,
			"send_match_prodliste:16527:f198key=%s,funkretur=%hd\n",
			f198key,
			funkretur);
		}
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				strcpy(stdgstr,tmpstr);
			}
			(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prissmdgn);
			}
			(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &pristill);
			}
/* NYT 111116 16527AFHAFL */
                        (void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
                        if (strlen(tmpstr)) {
                                sscanf(tmpstr, "%hd", &prisafhfratid);
                        }
                        (void)get_alfa_tgn(r198->alfafelt,4,tmpstr,';');
                        if (strlen(tmpstr)) {
                                sscanf(tmpstr, "%hd", &prisafltiltid);
                        }
		}
		sprintf(f198key, "%3.3hd%3.3hd%s",
			station,
			r165->spec_nr,
			r165->bil_grp);
		strcpy(r198->alfafelt,"");
		funkretur = find_r198(1,16527,(double)0,f198key,0);
		if (logfil) {
			fprintf(logfil,
			"send_match_prodliste:16527:f198key=%s,funkretur=%hd\n",
			f198key,
			funkretur);
		}
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				strcpy(stdgstr,tmpstr);
			}
			(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prissmdgn);
			}
			(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &pristill);
			}
		}
		if (logfil) {
			fprintf(logfil,
			"send_match_prodliste:prissmdgn=%hd\n",
			prissmdgn);
			fprintf(logfil,
			"send_match_prodliste:pristill=%hd\n",
			pristill);
		}

		if (prissmdgn>0 && fradt!=ws_systemdato) {
			continue;
		}
/* NYT 081208 JUL SAESON */
		if (ws_donsaesonflag>0 && saesonextspc<=0) {
			pristill = 0;
		}
		if (ws_donsaesonflag>0 && saesonextspc>0) {
			pristill = 1;
		}


/* find evt.altprod */
		julian = 0;
		altdato = 0;
		wx1 = 0;
/* NYT 060323 SÆSONTILBUD GAMMEL 081208 */
		returdato = fradt;
		if (extfdato>0) {
			returdato = m036_funktion(11, extfdato);
			chkfradgnr = returdato%10;
			returdato = extfdato;
		}
		funkretur = check_stdgstr((long int)prisspecnr,
			(long int)returdato,
			(long int)chkfradgnr,
			stdgstr);
		if (funkretur<=0) {
			julian = m036_funktion(12, returdato);
		}
/*
		funkretur = check_stdgstr((long int)prisspecnr,
			(long int)fradt,
			(long int)chkfradgnr,
			stdgstr);
		if (funkretur<=0) {
			julian = m036_funktion(12, fradt);
		}
*/
		if (logfil) {
			fprintf(logfil,
	"\tALTPROD spec=%hd,funkretur=%hd,altdato=%ld,ws_donsaesonflag=%hd\n",
			prisspecnr,
			funkretur,
			altdato,
			ws_donsaesonflag);
		}

		while (ws_donsaesonflag<=0 &&
			funkretur<=0 &&
			altdato<=0 &&
			wx1<chkantaldg) {
			wx1++;
			julian++;
			returdato = m036_funktion(19, julian);
			returaud = m036_funktion(11, returdato);
			returaud %= 10;
			if (logfil) {
				fprintf(logfil,
		"send_match_prodliste:spc=%hd,wx1=%hd,altdato=%ld,aud=%ld\n",
				prisspecnr,
				wx1,
				altdato,
				returaud);
			}
			funkretur2 = check_stdgstr((long int)prisspecnr,
				(long int)returdato,
				(long int)returaud,
				stdgstr);
			if (funkretur2>0) {
				altdato = returdato;
			}
		}
/* NYT 130121 WEEKENDCHECK */
		if (logfil) {
			fprintf(logfil,
	"\tBUNDCHECK SPEC%hd,ws_donsaesonflag=%hd,funkretur=%hd,altdato=%ld\n",
				prisspecnr,
				ws_donsaesonflag,
				funkretur,
				altdato);
		}
		weekendflag = -1;
		strcpy(weekenddtstr,"");
		if (ws_donsaesonflag<=0 && funkretur<=1 && altdato<=0 &&
			prisspecnr==196) {
			weekendflag =
			check_don2_weekendok(prisspecnr,
				fradt,
				tildt,
				prisafhfratid,
				prisdgvarighed,
				stdgstr,
				weekenddtstr);
		}
		if (logfil) {
			fprintf(logfil,
	"\tBUNDCHECK2 SPEC%hd,weekendflag=%hd\n",
				prisspecnr,
				weekendflag);
		}
		if (ws_donsaesonflag<=0 && funkretur<=0 &&
			prisspecnr==196 &&
			weekendflag==-1) {
			continue;
		}
/* NYT 130125 */
		if (ws_donsaesonflag<=0 && funkretur<=0 &&
			prisspecnr==196 &&
			weekendflag>0 && strlen(weekenddtstr)) {
			sscanf(weekenddtstr,"%ld",&altdato);
		}
		if (ws_donsaesonflag<=0 && funkretur<=0 && altdato<=0) {
			continue;
		}


		tillantal = 0;
		tillspecnr = 0;
/* KOBL EXTRA DAGE */
		koblfyraftenext = 0;
		koblenhed = 201;
		koblfra = 0;
		kobltil = 0;
		koblspecnr = 0;
		funkretur = 0;
		if (pristill>0 && ws_donsaesonflag>0 &&
			saesonextspc>0 && saesonextant>0) {
			koblspecnr = saesonextspc;
			koblfra = saesonextant;
			kobltil = saesonextant;
			koblspecnr = saesonextspc;
		}
		if (pristill>0 && ws_donsaesonflag<=0) {
			funkretur=find_r198(1,16514,
				(double)r165->spec_nr,"",(long int)0);
		}
		if (pristill>0 && ws_donsaesonflag<=0 && funkretur>0 &&
			strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &koblenhed);
			}
			(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &koblfra);
			}
			(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &kobltil);
			}
			(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &koblspecnr);
			}
		}
		if (logfil) {
			fprintf(logfil,
				"\tFYRAFTENEXTRApristill=%hd\n",pristill);
			fprintf(logfil,
				"\t\ttillantal=%hd\n",tillantal);
			fprintf(logfil,
				"\t\tfunkretur=%hd\n",funkretur);
			fprintf(logfil,
				"\t\tchkantaldg=%ld\n",chkantaldg);
			fprintf(logfil,
				"\t\tr165->spec_nr=%hd\n",r165->spec_nr);
			fprintf(logfil,
				"\t\tkoblspecnr=%hd\n",koblspecnr);
		}
		if (logfil) {
			fprintf(logfil,
	"send_match_prodliste:kobl-enh=%hd,-fra=%hd,-til=%hd,-specnr=%hd\n",
			koblenhed,
			koblfra,
			kobltil,
			koblspecnr);
			fprintf(logfil,
				"\tprisdgvarighed=%hd\n", prisdgvarighed);
			fprintf(logfil,
				"\tchkantaldg=%hd\n",chkantaldg);
			fprintf(logfil,
				"\ttillspecnr=%hd\n",tillspecnr);
			fprintf(logfil,
				"\ttillantal=%hd\n",tillantal);
			fprintf(logfil,
				"\ttildt=%ld\n",tildt);
			fprintf(logfil,
				"\tpristill=%hd\n",pristill);
			fprintf(logfil,
				"\tkoblfyraftenext=%hd\n",koblfyraftenext);
		}
		tillspecnr = 0;
		tillantal = 0;
		if (koblspecnr>0) {
			sendflag = 1;
			forskelvarighed = (short int)chkantaldg-prisdgvarighed;
			forskelvarighed -= tillantal;

			if (logfil) {
				fprintf(logfil,
			"send_match_prodliste:KOBLforskelvarighed=%hd\n",
				forskelvarighed);
			}
/* NYT 070423 */
			if (dondafolo==0 && forskelvarighed<mintolerance) {
				continue;
			}
			if (dondafolo==1 && forskelvarighed<mintolerance) {
				sendflag = 0;
			}
			if (dondafolo==1 && forskelvarighed>maxtolerance) {
				sendflag = 0;
			}
			returdato = fradt;
			if (altdato>0) {
				returdato = altdato;
			}
			if (extfdato>0) {
				returdato = extfdato;
			}
/* NYT 110323 */
/*
			if (tilbtvgafldato>0) {
				tillspecnr = tilbtvgextspc;
				tillantal = tilbtvgextant;
			}
*/
			funkretur = 0;
			if (sendflag>0) {
				funkretur = chksend_prod(station,
					grp,
					langstr,
					returdato,
					chkantaldg,
					prisspecnr,
					prisdgvarighed,
					prisafhfratid,
					prisafltiltid,
					w165.tekst_1,
					tillspecnr,
					tillantal,
					tildt,
					forskelvarighed);
			}
			if (funkretur>0) {
				specantal++;
				ws_prodlisteantal++;
			}
			tillspecnr = koblspecnr;
/* NYT 071016 */
			ws_fratid = ws_kundetdfra;
			ws_fradato = ws_kundedtfra;
		}
		for (tillantal=koblfra;tillantal<=kobltil;tillantal++) {
			forskelvarighed = (short int)chkantaldg-prisdgvarighed;
			forskelvarighed -= tillantal;
			if (logfil) {
				fprintf(logfil,
			"send_match_prodliste:KOBL2forskelvarighed=%hd\n",
				forskelvarighed);
				fprintf(logfil,
			"send_match_prodliste:KOBL2tillantal=%hd\n",
				tillantal);
			}
/* NYT 070601 */
			if (dondafolo==1 && forskelvarighed>maxtolerance &&
				weekendflag<=0) {
				continue;
			}
/* RETTET 130121 WEEKENDCHECK
			if (dondafolo==1 && forskelvarighed>maxtolerance) {
				continue;
			}
*/
			if (dondafolo!=1 && forskelvarighed<mintolerance) {
				continue;
			}
			if (dondafolo==1 && forskelvarighed<mintolerance &&
				weekendflag<=0) {
				continue;
			}
/* RETTET 130121 WEEKENDCHECK
			if (forskelvarighed<mintolerance) {
				continue;
			}
*/
			returdato = fradt;
			if (altdato>0) {
				returdato = altdato;
			}
/* NYT 060323 SÆSONTILBUD */
			if (extfdato>0) {
				returdato = extfdato;
			}
/* 081208 JUL */
			evttildato = chkantaldg;
			if (ws_donsaesonflag>0 && exttdato>0) {
				evttildato = exttdato;
			}
/* NYT 091016 */
			udregnvar = (long int)prisdgvarighed;
			udregnvar += (long int)tillantal;
			julian = m036_funktion(12, returdato);
			julian += udregnvar;
			udregndato = m036_funktion(19, julian);
			if (logfil) {
				fprintf(logfil,
			"send_match_prodliste:KOBL2fra-til=%ld-%ld\n",
				returdato,
				udregndato);
				fprintf(logfil,
			"send_match_prodliste:KOBL2weekendflag=%hd\n",
				weekendflag);
			}
/* NYT 130104 FYRAFTENEXTRA OPL16514 */
			koblfyraftenext = 0;
			if (prisdgvarighed==1 && chkantaldg==2 &&
				tillantal==1 &&
				r165->spec_nr==185 && tillspecnr==186) {
				tillspecnr = 180;
				koblfyraftenext = 1;
			}
			if (prisdgvarighed==1 && chkantaldg==3 &&
				tillantal==2 &&
				r165->spec_nr==185 && tillspecnr==186) {
				tillspecnr = 181;
				koblfyraftenext = 1;
			}
			if (prisdgvarighed==1 && chkantaldg==4 &&
				tillantal==3 &&
				r165->spec_nr==185 && tillspecnr==186) {
				tillspecnr = 182;
				koblfyraftenext = 1;
			}
			if (prisdgvarighed==1 && chkantaldg==5 &&
				tillantal==4 &&
				r165->spec_nr==185 && tillspecnr==186) {
				tillspecnr = 183;
				koblfyraftenext = 1;
			}
			if (prisdgvarighed==1 && chkantaldg==6 &&
				tillantal==5 &&
				r165->spec_nr==185 && tillspecnr==186) {
				tillspecnr = 184;
				koblfyraftenext = 1;
			}
			if (prisdgvarighed==1 && chkantaldg==7 &&
				tillantal==6 &&
				r165->spec_nr==185 && tillspecnr==186) {
				tillspecnr = 666;
				koblfyraftenext = 1;
			}

/* NYT 130121 WEEKENDCHECK */
			nytildt = tildt;
			if (dondafolo==1 && weekendflag>0) {
				nytildt = udregndato;
				forskelvarighed = -1;
			}
			funkretur = check_minsalg(2,16625,
				station,"",returdato,udregndato);
			if (funkretur>0 && udregnvar<funkretur) {
				fprintf(logfil,
			"send_match_prodliste:funkretur check_minsalg overspring\n");
				continue;
			}
			nytillantal = tillantal;
			if (koblfyraftenext>0) {
				nytillantal = koblfyraftenext;
			}
			funkretur = chksend_prod(station,
				grp,
				langstr,
				returdato,
				evttildato,
				prisspecnr,
				prisdgvarighed,
				prisafhfratid,
				prisafltiltid,
				w165.tekst_1,
				tillspecnr,
				nytillantal, /* 130123 tillantal */
				nytildt, /* RETTET 130121 tildt */
				forskelvarighed);
			if (funkretur>0) {
				specantal++;
				ws_prodlisteantal++;
			}
/* NYT 071016 */
			ws_fratid = ws_kundetdfra;
			ws_fradato = ws_kundedtfra;
		}
	}
	if (logfil) {
		fprintf(logfil, "send_match_prodliste:specantal=%hd\n",
			specantal);
		fprintf(logfil, "send_match_prodliste:ws_prodlisteantal=%hd\n",
			ws_prodlisteantal);
	}
/* NYT 130321 TVUNGENMAANED */
	funkretur = 0;
	if (tvungenextspecnr==0 &&
		ws_prodlisteantal==1 && kundevarighed>=14 && kundevarighed<30) {
		tvungenextspecnr = 194;
		funkretur = 1;
		chkantaldg = 30;
	}
	if (tvungenextspecnr==0 &&
		ws_prodlisteantal==1 && kundevarighed>=7 && kundevarighed<14) {
		tvungenextspecnr = 193;
		funkretur = 1;
		chkantaldg = 14;
	}
	if (logfil) {
		fprintf(logfil,
		"send_match_prodliste:TVUNGENMAANEDtvungenextspecnr=%hd\n",
			tvungenextspecnr);
		fprintf(logfil,"\tfunkretur=%hd\n",funkretur);
	}
	if (tvungenextspecnr>0 && funkretur>0) {
		reclow(r165,R165);
		r165->stat_nr = station;
		r165->spec_nr = tvungenextspecnr;
		r165->spec_nr--;
		f165_start(2, ISGTEQ);
		if (f165_ukendt) {
			tvungenextspecnr = -1;
		}
	}
	if (tvungenextspecnr>0 && funkretur>0) {
		goto listeigen;
	}

/* NYT 070601 */
	if (dondafolo>0 && ws_prodsortflag>0 && ws_prodsortidx>0) {
		sortsend_prod(langstr);
	}
	if (specantal>0) {
		retur = specantal;
	}
/* NYT 071107 */
/* RETTET 121121
	if (specantal<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-14);
		web_errormess(0,ws_langstr,"14");
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
*/
/* PGAABEN */
	if (pgaabenflag>0) {
		(void)dan_pgaaben(-1,ws_station,pgfilsti);
		strcpy(ws_pgaabenfilsti,"");
	}

	if (logfil) {
		fprintf(logfil, "send_match_prodliste:retur=%hd\n",
			retur);
	}
	return(retur);
}

/* ********************************* */
static int send_psmatch_prodliste(funk,langstr,station,kundenr,fradt,tildt)
short int funk;
char * langstr;
short int station;
long int kundenr;
long int fradt;
long int tildt; {
	short int retur = 0;
	int xlsprisflag = 0;
	short int aabenflag = 0;
	short int fejlkode = 0;
	short int dondafolo = 0;
	short int sendflag = 0;
	short int wx1 = 0;
	short int wx2 = 0;
	short int blokfundet = 0;
	short int funkretur = 0;
	short int funkretur2 = 0;
	short int specantal = 0;
	short int prisspecnr = 0;
	short int prisenhed = 0;
	short int prisextra = 0;
	short int prissmdgn = 0;
	short int prisdgvarighed = 0;
	short int pristmvarighed = 0;
	short int pristill = 0;
	short int prisafhfratid = 0;
	short int prisafltiltid = 0;
	short int stationafhtiltid = 0;
	short int stationaflfratid = 0;
	short int saesonextspc = 0;
	short int saesonextant = 0;

	short int tillspecnr = 0;
	short int tillantal = 0;
	short int nytillantal = 0;

	short int mintolerance = 0;
	short int maxtolerance = 1;
	short int gemmintol = 0;
	short int gemmaxtol = 1;
	short int forskelvarighed = 0;
	short int kundenrtype = 0;
	short int altproduktvarighed = 0;

	short int koblenhed = 0;
	short int koblfra = 0;
	short int kobltil = 0;
	short int koblspecnr = 0;
	short int koblfyraftenext = 0;
	long int tilbtvgafldato = 0;
	short int tilbtvgextspc = 0;
	short int tilbtvgextant = 0;

	short int kundealder = 0;
	long int minperiode = 0;
	long int evttildato = 0;
	long int kundevarighed = 0;
	long int produktvarighed = 0;
	long int chkantaldg = 0;
	long int chkfradgnr = 0;
	long int julian = 0;
	long int returdato = 0;
	long int udregndato = 0;
	long int udregnvar = 0;
	long int returaud = 0;
	long int specialfradato = 0;
	long int specialtildato = 0;
	long int produktfradato = 0;
	long int produkttildato = 0;
	long int produktfratid = 0;
	long int produkttiltid = 0;
	long int kundefratid = 0;
	long int kundetiltid = 0;
	long int altdato = 0;
	long int extfdato = 0;
	long int exttdato = 0;
	long int nytildt = 0;
	double kundefdatotid = 0;
	double kundetdatotid = 0;
	double prodfdatotid = 0;
	double prodtdatotid = 0;

	long int firmakundenr = 0;
	long int firmaaftfra = 0;
	long int firmaafttil = 0;
	short int aftaleflag = 0;
	short int weekendflag = 0;
	short int tvungenextspecnr = 0;
	short int starttypeidx = -1;
	short int sluttypeidx = -1;
	short int mainloopidx = -1;
	short int xlsprodidx = -1;
	short int extraretur = 0;
	short int chkalderfra = 0;
	short int chkaldertil = 0;

	char tmpstr[81] = "";
	char tmpgrpliste[81] = "";
	char tmpferienavn[41] = "";
	char tmpdatointerval[101] = "";
	char tmpfelt[81] = "";
	char stdgstr[81] = "";
	char f198key[21] = "";
	char transstr[21] = "";
	char weekenddtstr[31] = "";
	char psbiltype[31] = "";
	char psgrp[31] = "";
	char produktkode[31] = "";
	char produkttekst[81] = "";
	char produktincl[201] = "";

/* OBS */
	if (ws_funktion==3) {
		dondafolo = 1;
		mintolerance = -1;
		ws_prodsortflag = 1;
		ws_alderblok = 0;
	}
	log_stopur(80);
	if (station>0) {
		strcpy(ws_sttlfnr,"N/A");
		reclow(r166,R166);
		f166_start(1,ISGTEQ);
		r166->stat_nr = station;
		egeread(f166,ISEQUAL);
		if (f166_ok) {
			strcpy(ws_sttlfnr,r166->tlf);
		}
	}
	if (logfil) {
		fprintf(logfil,
			"send_psmatch_prodliste:fradt=%ld,tildt=%ld\n",
			fradt,
			tildt);
		fprintf(logfil,
			"send_psmatch_prodliste:kundenr=%ld\n",
			kundenr);
		fprintf(logfil,
			"send_psmatch_prodliste:dondafolo=%hd\n",
			dondafolo);
		fprintf(logfil,
			"send_psmatch_prodliste:ws_prodsortflag=%hd\n",
			ws_prodsortflag);
		fprintf(logfil,
			"send_psmatch_prodliste:ws_fradato=%ld\n",
			ws_fradato);
		fprintf(logfil,
			"send_psmatch_prodliste:ws_fratid=%ld\n",
			ws_fratid);
		fprintf(logfil,
			"send_psmatch_prodliste:ws_sttlfnr=%s\n",
			ws_sttlfnr);
		fprintf(logfil,
			"send_psmatch_prodliste:ws_inputspecnr=%hd\n",
			ws_inputspecnr);
		fprintf(logfil,
			"send_psmatch_prodliste:ws_stepnr=%d\n",
			ws_stepnr);
		fprintf(logfil,
			"send_psmatch_prodliste:ws_alderstr=%s\n",
			ws_alderstr);
	}
/* NYT 141010 PSFREDAGDEFAULTUDTID */
	aabenflag = check_bssaaben(-1,ws_station,ws_fradato,ws_fratid);
	if (logfil) {
		fprintf(logfil, "\taabenflag=%hd\n", aabenflag);
	}
	if (aabenflag<=0) {
		ws_don2errno = DON2PSLUKKET;
	}
	if (logfil) {
		fprintf(logfil,
			"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		ws_funkretur2 = frankly_err(ws_funktion,
			"fejl",ws_don2errno);
		retur = 0;
		goto mainloopstop;
	}

	funkretur = dan_psgrptab(1,langstr,station);
	starttypeidx = -1;
	sluttypeidx = -1;
	wx1 = 0;
	while (wx1<ws_grpidx) {
		if (strncmp(ws_grptab[wx1]+2,ws_grp,3)==0 && starttypeidx==-1) {
			starttypeidx = wx1;
			sluttypeidx = wx1;
			strcpy(ws_biltype,ws_grp);
			strcpy(ws_grp,"");
		}
		if (strlen(ws_biltype) &&
			strncmp(ws_grptab[wx1]+2,ws_biltype,3)==0) {
			sluttypeidx = wx1;
		}
		wx1++;
	}
	wx1 = 0;
	while (wx1<ws_grpidx && !strlen(ws_biltype)) {
		sscanf(ws_grptab[wx1]+8,"%s",tmpstr);
		if (strcmp(tmpstr,ws_grp)==0 && starttypeidx==-1) {
			starttypeidx = wx1;
			sluttypeidx = wx1;
			sscanf(ws_grptab[wx1]+2,"%s",ws_biltype);
			break;
		}
		wx1++;
	}
	if (logfil) {
		fprintf(logfil,
			"\tfunkretur=%hd\n",funkretur);
		fprintf(logfil,
			"\tws_grp=%s\n",ws_grp);
		fprintf(logfil,
			"\tws_biltype=%s\n",ws_biltype);
		fprintf(logfil,
			"\tstarttypeidx=%hd\n",starttypeidx);
		fprintf(logfil,
			"\tsluttypeidx=%hd\n",sluttypeidx);
	}
/* NYT 131209 BILTYPEFEJL */
	if (starttypeidx==-1 || sluttypeidx==-1) {
		ws_don2errno = DON2TPGRPUK;
	}
	if (logfil) {
		fprintf(logfil,
			"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		ws_funkretur2 = frankly_err(ws_funktion,
			"fejl",ws_don2errno);
		retur = 0;
		goto mainloopstop;
	}

	returdato = m036_funktion(11, fradt);
	chkfradgnr = returdato%10;
	julian = m036_funktion(12, fradt);
        chkantaldg = m036_funktion(12, tildt);
	chkantaldg -= julian;
	kundevarighed = chkantaldg;

	if (dondafolo>0 && chkantaldg>14) {
		mintolerance = -2;
		maxtolerance = 2;
	}
	if (logfil) {
		fprintf(logfil, "send_psmatch_prodliste:kundevarighed=%ld\n",
			kundevarighed);
		fprintf(logfil, "send_psmatch_prodliste:chkantaldg=%ld\n",
			chkantaldg);
		fprintf(logfil, "send_psmatch_prodliste:chkfradgnr=%ld\n",
			chkfradgnr);
		fprintf(logfil,
			"send_psmatch_prodliste:mintolerance=%hd\n",
			mintolerance);
		fprintf(logfil,
			"send_psmatch_prodliste:maxtolerance=%hd\n",
			maxtolerance);
	}
/* NYT 140327 PSMAXVARIGHED29 */
	if (kundevarighed>29) {
		ws_don2errno = DON2MAXVAR29;
	}
/* NYT 140327 PSLANGTIDTLF */
	if (kundevarighed>29 && ws_station==52) {
		ws_don2errno = DON2LANGST52;
	}
	if (kundevarighed>29 && ws_station==53) {
		ws_don2errno = DON2LANGST53;
	}
	if (kundevarighed>29 && ws_station==61) {
		ws_don2errno = DON2LANGST61;
	}

	if (logfil) {
		fprintf(logfil,
			"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		ws_funkretur2 = frankly_err(ws_funktion,
			"fejl",ws_don2errno);
		retur = 0;
		goto mainloopstop;
	}

	gemmintol = mintolerance;
	gemmaxtol = maxtolerance;
	blokfundet = 0;

	funkretur = check_minsalg(2,16625,station,ws_grp,fradt,tildt);
	if (funkretur>0) {
		if (logfil) {
			fprintf(logfil,
			"send_psmatch_prodliste:16625FUNDET %hd\n",funkretur);
			fprintf(logfil,
			"send_psmatch_prodliste:num=%.0lf,alfa=%s\n",
			r198->numfelt,
			r198->alfafelt);
			fprintf(logfil,
			"send_psmatch_prodliste:chkantaldg=%ld\n",
			chkantaldg);
		}
	}
	if (funkretur>0) {
		(void)get_alfa_tgn(r198->alfafelt,0,tmpgrpliste,';');
		(void)get_alfa_tgn(r198->alfafelt,1,tmpferienavn,';');
		(void)get_alfa_tgn(r198->alfafelt,2,tmpdatointerval,';');
	}
	if (funkretur>0 && strcmp(tmpgrpliste,"*")==0) {
		blokfundet = 1;
		minperiode = (long int)r198->numfelt;
	}
/* NYT 131128 JUL2013 */
	if (funkretur>0 && strcmp(ws_grp,tmpgrpliste)==0) {
		blokfundet = 1;
		minperiode = (long int)r198->numfelt;
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,
			"send_psmatch_prodliste:blokfundet=%hd\n",blokfundet);
		fprintf(logfil,
			"send_psmatch_prodliste:tmpgrpliste=%s\n",tmpgrpliste);
		fprintf(logfil,
			"send_psmatch_prodliste:tmpferienavn=%s\n",tmpferienavn);
		fprintf(logfil,
			"send_psmatch_prodliste:tmpdatointerval=%s\n",tmpdatointerval);
		fprintf(logfil,
			"send_psmatch_prodliste:minperiode=%ld\n",minperiode);
	}
/* NYT 091102 */
	if (funkretur>0 && blokfundet==1 &&
		chkantaldg>=minperiode) {
		blokfundet = 0;
	}
	if (funkretur>0 && blokfundet==1) {
		fejlkode = -28;
	}
/*
	if (funkretur>0 &&
		blokfundet==1 &&
		r198->numfelt>0 &&
		chkantaldg<minperiode) {
		fejlkode = -28;
	}
*/
	log_stopur(82);
/* NYT 111110 DONAFLBLOK */
	if (blokfundet<=0) {
		funkretur = check_ecdon_aflblok(1,
			station,
			psgrp,
			fradt,
			tildt,
			tmpfelt);
	}
	if (blokfundet<=0 && funkretur>0) {
		fejlkode = -28;
		blokfundet = 1;
		strcpy(tmpferienavn,"DONAFLBLOK");
	}
	if (logfil) {
		fprintf(logfil,
			"AFLBLOK blokfundet=%hd\n",blokfundet);
		fprintf(logfil,
			"\ttmpferienavn=%s\n",tmpferienavn);
	}
/* NYT 111114 DONPRODHENVIS */
	if (strcmp(psgrp,"3")==0 &&
		chkantaldg>=21 && chkantaldg<30) {
		fejlkode = -28;
		strcpy(tmpferienavn,"DONPRODHENV01");
	}
/* NYT 111114 DONPRODHENVIS */
	if (strcmp(psgrp,"A")==0 &&
		chkantaldg>=19 && chkantaldg<30) {
		fejlkode = -28;
		strcpy(tmpferienavn,"DONPRODHENV01");
	}
	if (chkantaldg>=81) {
		fejlkode = -28;
		strcpy(tmpferienavn,"DONPRODHENV02");
	}
/* NYT 120120 CHECK STOPSALG */
        funkretur = check_stopsalg(1,ws_station,ws_grp,ws_fradato,ws_tildato);
        if (funkretur>0) {
		fejlkode = -28;
		strcpy(tmpferienavn,"DONSTOPSALG");
        }

	if (fejlkode==-28 && strcmp(tmpferienavn,"st.bede")==0) {
		fejlkode = -29;
	}
	if (fejlkode==-28 && strcmp(tmpferienavn,"kr.him")==0) {
		fejlkode = -30;
	}
	if (fejlkode==-28 && strcmp(tmpferienavn,"pinse")==0) {
		fejlkode = -31;
	}
	if (fejlkode==-28 && strcmp(tmpferienavn,"jul")==0) {
		fejlkode = -32;
	}
	if (logfil) {
		fprintf(logfil,
			"\ttmpferienavn=%s\n",tmpferienavn);
		fprintf(logfil,
			"\tfejlkode=%hd\n",fejlkode);
	}
	if (fejlkode!=0 && strlen(tmpdatointerval)) {
		sprintf(ws_differrormess,
"Der kan ikke bookes enkelte dage i perioden %s. Kontakt derfor nærmeste udlejningssted på tlf.%s.",
			tmpdatointerval,
			"7011 4455");
	}
/* NYT 131128 JUL2013 */
	if (fejlkode!=0 && strlen(tmpdatointerval) && fejlkode==-32) {
		sprintf(ws_differrormess,
			"Julen 2013: %s.",
			tmpdatointerval);
/*
		sprintf(ws_differrormess,
			"Julen 2013: Enkelte dage kan ikke bookes %s.",
			tmpdatointerval);
*/
	}
/* NYT 111110 DONAFLBLOK */
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONAFLBLOK")==0) {
		sprintf(ws_differrormess,
"Det er ikke muligt at aflevere denne dag. Prøv venligst en anden afleveringsdag eller kontakt os på tlf.%s.",
			"7011 4455");
	}
/* NYT 111114 DONPRODHENVIS */
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONPRODHENV01")==0 &&
		strcmp(langstr,"EN")!=0) {
		sprintf(ws_differrormess,
"Ved billeje på denne periode (%ld dage) er det prisen på 30 dage som bedst kan betale sig. Ret dato til 30 dage og prøv venligst igen.",chkantaldg);
	}
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONPRODHENV01")==0 &&
		strcmp(langstr,"EN")==0) {
		sprintf(ws_differrormess,
"The price for 30 days is cheaper than the chosen rental period (%ld days). Please change the period to 30 days.",chkantaldg);
	}
/* NYT 120119 DONPRODHENVIS */
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONPRODHENV02")==0 &&
		strcmp(langstr,"EN")!=0) {
		sprintf(ws_differrormess,
			"Ring %s for et leasing-tilbud.",ws_sttlfnr);
	}
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONPRODHENV02")==0 &&
		strcmp(langstr,"EN")==0) {
		sprintf(ws_differrormess,
			"Please call %s for a long term offer.",ws_sttlfnr);
	}
/* NYT 120120 DONSTOPSALG */
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONSTOPSALG")==0 &&
		strcmp(langstr,"EN")!=0) {
		sprintf(ws_differrormess,
			"Problemer med at booke. Ring evt. til %s.",
				ws_sttlfnr);
	}
	if (fejlkode!=0 && strlen(tmpferienavn) &&
		strcmp(tmpferienavn,"DONSTOPSALG")==0 &&
		strcmp(langstr,"EN")==0) {
		sprintf(ws_differrormess,
			"Booking error. Please call %s.",ws_sttlfnr);
	}
	if (fejlkode!=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)fejlkode);
		web_errormess(0,ws_langstr,"28");
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		return(0);
	}
/* NYT 140323 XLSPRODMATCH */
	funkretur = dan_xlsprodmatchtabel(1,kundevarighed);
	if (logfil) {
		fprintf(logfil,"\tXLSPRODMATCH funkretur=%d\n",funkretur);
	}
	if (funkretur<=0) {
		ws_don2errno = DON2PRODUK;
	}
	if (funkretur<=0 && ws_tiltid>700) {
		ws_don2errno = DON2PRODUKTID;
	}

	if (logfil) {
		fprintf(logfil,
			"\tws_don2errno=%ld\n",ws_don2errno);
	}
	if (ws_don2errno>0) {
		ws_funkretur2 = frankly_err(ws_funktion,
			"fejl",ws_don2errno);
		retur = 0;
		goto mainloopstop;
	}
	xlsprodidx = -1;
mainprodukt:
	xlsprodidx++;
	if (logfil) {
		fprintf(logfil,"MAINPRODUKT xlsprodidx=%hd\n",xlsprodidx);
	}
	if (xlsprodidx>MAXXLSPRODMATCH) {
		goto mainprodstop;
	}
	if (ws_xlsprodmatchtabel[xlsprodidx]<=0) {
		goto mainprodstop;
	}
/* NYT 140425 WEEKENDKONTRADAG DEAKTIVERET
	if (ws_xlsprodmatchtabel[xlsprodidx]==800 &&
		chkfradgnr==5 &&
		kundevarighed==3 &&
		ws_fratid>=1600 &&
		ws_tiltid<=800) {
		if (logfil) {
			fprintf(logfil,"\tWEEKENDKONTRADAG FUNDET\n");
		}
		goto mainprodukt;
	}
*/
	reclow(r165,R165);
	f165_start(1,ISGTEQ);
	mainloopidx = starttypeidx;
mainloop00:
	if (mainloopidx>=ws_grpidx) {
		goto mainloopstop;
	}
	if (mainloopidx>sluttypeidx) {
		goto mainloopstop;
	}
	sscanf(ws_grptab[mainloopidx]+8,"%s",ws_grp);
mainloop01:
	chkalderfra = -1;
	chkaldertil = -1;
	if (strlen(ws_grpaldertab[mainloopidx])) {
		sscanf(ws_grpaldertab[mainloopidx],"%hd",&chkalderfra);
		chkaldertil = 999;
	}
	if (strlen(ws_alderstr)) {
		sscanf(ws_alderstr,"%hd",&kundealder);
	}
	if (logfil) {
		fprintf(logfil,"MAINLOOP01 mainloopidx=%hd\n",mainloopidx);
		fprintf(logfil,"\t\tws_grp=%s\n",ws_grp);
		fprintf(logfil,"\t\tws_biltype=%s\n",ws_biltype);
		fprintf(logfil,"\t\tws_specnr=%hd\n",ws_specnr);
		fprintf(logfil,"\t\tws_grpxtab=%s\n",
			ws_grpxtab[mainloopidx]);
		fprintf(logfil,"\t\tws_grpaldertab=%s\n",
			ws_grpaldertab[mainloopidx]);
		fprintf(logfil,"\t\tchkalderfra-til=%hd-%hd\n",
			chkalderfra,chkaldertil);
		fprintf(logfil,"\t\tws_alderstr=%s\n",
			ws_alderstr);
		fprintf(logfil,"\t\tkundealder=%hd\n",
			kundealder);
		fprintf(logfil,"\t\tws_paiflag=%hd\n",
			ws_paiflag);
	}
	wx1 = 0;
	if (kundealder>=chkalderfra && kundealder<=chkaldertil) {
		wx1 = 1;
	}
	if (logfil) {
		fprintf(logfil,"\t\tALDERCHECK wx1=%hd\n",
			wx1);
	}
	if (wx1<=0) {
		ws_alderblok++;
		mainloopidx++;
		goto mainloop00;
	}

/* NYT 131216 PSPRISER */
	strcpy(produktkode,"810");
	ws_specnr = 810;
	if (strcmp(ws_biltype,"VAR")==0) {
		strcpy(produktkode,"820");
		ws_specnr = 820;
	}
	if (strcmp(ws_biltype,"LST")==0) {
		strcpy(produktkode,"820");
		ws_specnr = 820;
	}
/* NYT 140218 XLSPRIS */
	xlsprisflag = 0;
	if (ws_station==53) {
		strcpy(produktkode,"800");
		ws_specnr = 800;
		xlsprisflag = 1;
	}
/* NYT 140310 XLSPRIS2 */
	if (ws_station==52) {
		strcpy(produktkode,"800");
		ws_specnr = 800;
		xlsprisflag = 1;
	}
	if (ws_station==61) {
		strcpy(produktkode,"800");
		ws_specnr = 800;
		xlsprisflag = 1;
	}
/* NYT 140423 XLSPRODMATCH */
	if (xlsprisflag>0) {
		ws_specnr = (short int)ws_xlsprodmatchtabel[xlsprodidx];
/* NYT 140513 PSSENEREAFLTID */
		ws_maxindtid = (long int)ws_xlsprodmatchindtidtabel[xlsprodidx];
		sprintf(produktkode,"%hd",ws_specnr);
	}
/* NYT 140513 PSSENEREAFLTID */
	ws_psextradag = 0;
	kundefratid = ws_fratid;
	kundetiltid = ws_tiltid;
/*
	if (ws_maxindtid>0 && kundetiltid>ws_maxindtid) {
		ws_psextradag = 1;
	}
*/

	produktfradato = ws_fradato;
	produkttildato = ws_tildato;
	produktfratid = ws_fratid;
	produkttiltid = ws_tiltid;
	produktvarighed = kundevarighed;
/* NYT 141022 */
	ws_altfradato = 0;
	ws_altfratid = 0;
	ws_alttildato = 0;
	ws_alttiltid = 0;
/* NYT 140724 PSWEEKENDMATCH */
	if (xlsprisflag>0 && strlen(ws_xlsprodmatchtidopl[xlsprodidx])) {
               	get_alfa_tgn(ws_xlsprodmatchtidopl[xlsprodidx],0,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&produktfradato);
		}
               	get_alfa_tgn(ws_xlsprodmatchtidopl[xlsprodidx],1,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&produktfratid);
		}
               	get_alfa_tgn(ws_xlsprodmatchtidopl[xlsprodidx],2,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&produkttildato);
		}
               	get_alfa_tgn(ws_xlsprodmatchtidopl[xlsprodidx],3,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&produkttiltid);
		}
               	get_alfa_tgn(ws_xlsprodmatchtidopl[xlsprodidx],4,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&produktvarighed);
		}
		ws_altfradato = produktfradato;
		ws_altfratid = produktfratid;
		ws_alttildato = produkttildato;
		ws_alttiltid = produkttiltid;
	}
	if (xlsprisflag>0 && !strlen(ws_xlsprodmatchtidopl[xlsprodidx])) {
		ws_altfratid = ws_fratid;
	}

	sprintf(produkttekst,"Testrate grp.%s - %ld dage",
		ws_grp,
		produktvarighed);
	if (produktvarighed==1) {
		sprintf(produkttekst,"Testrate grp.%s - %ld dag",
			ws_grp,
			produktvarighed);
	}
	sprintf(produktincl,"incl. xxxx");
/* NYT 140306 PSPRODUKTINKL */
	sprintf(produktincl,"inkl. moms, forsikring (selvrisiko) og");

	if (logfil) {
		fprintf(logfil,"MAINBUND mainloopidx=%hd\n",mainloopidx);
		fprintf(logfil,"\t\tproduktfradato=%ld\n",produktfradato);
		fprintf(logfil,"\t\tprodukttildato=%ld\n",produkttildato);
		fprintf(logfil,"\t\tproduktvarighed=%ld\n",produktvarighed);
		fprintf(logfil,"\t\tkundevarighed=%ld\n",kundevarighed);
		fprintf(logfil,"\t\tkundefratid=%ld\n",kundefratid);
		fprintf(logfil,"\t\tkundetiltid=%ld\n",kundetiltid);
		fprintf(logfil,"\t\txlsprisflag=%d\n",xlsprisflag);
		fprintf(logfil,"\t\tws_maxindtid=%ld\n",ws_maxindtid);
		fprintf(logfil,"\t\tws_altfradato=%ld\n",ws_altfradato);
		fprintf(logfil,"\t\tws_altfratid=%ld\n",ws_altfratid);
		fprintf(logfil,"\t\tws_alttildato=%ld\n",ws_alttildato);
		fprintf(logfil,"\t\tws_alttiltid=%ld\n",ws_alttiltid);
		fprintf(logfil,"\t\tws_psextradag=%d\n",ws_psextradag);
	}
	r159->station_ud_nr = ws_station;
	r159->station_ind_nr = ws_station;

	r159->dato_ud = produktfradato;
	r159->forv_dato_ind = produkttildato;
	r159->tid_ud = produktfratid;
	r159->forv_tid_ind = produkttiltid;

	funkretur = nyopret_reservation(0,0,0);
	if (logfil) {
		fprintf(logfil,
		"\t\tNYOPRET_RESERVATION:funkretur=%hd\n",
			funkretur);
		fprintf(logfil,
		"\t\tr159->total=%.2lf\n",
			r159->total);
	}
/* NYT 140218 XLSPRIS */
	if (xlsprisflag>0) {
		sprintf(produkttekst,"%s-%ld dage",
			r159->rate_tekst[0],
			produktvarighed);
	}
	if (xlsprisflag>0 && produktvarighed==1) {
		sprintf(produkttekst,"%s-%ld dag",
			r159->rate_tekst[0],
			produktvarighed);
	}
/*
	add_prislinie(0,
		produktvarighed,
		0,
		ws_station,
		810,
		ws_grp,
		1,
		0);

	udregn_kontrakt((short int)0,
		(short int)0,
		(long int)0,
		(long int)0);
*/
/* NYT 131211 PSSNYDTID */
	r159->forv_tid_ind = produkttiltid;

/* NYT 140425 XLSMAINCHECK UDTID TIDUD */
	sprintf(tmpstr, "PS%5.5hd%5.5hdSTD.main",
		ws_station,
		r159->rate_spec_nr[0]);
	funkretur = xlspris_udpakmain(tmpstr);
	if (logfil) {
		fprintf(logfil,"\t\tXLSMAINCHECK funkretur=%d\n",funkretur);
		fprintf(logfil,"\t\t\txlsprismain->udtid=%ld",
			xlsprismain->udtid);
	}
/* OBS 140724 PSWEEKENDMATCH PSUDTID
	if (funkretur>0 && r159->rate_spec_nr[0]==800 &&
		ws_fratid>xlsprismain->udtid) {
		r159->tid_ud = xlsprismain->udtid;
	}
*/
	if (logfil) {
		fprintf(logfil,"\t\trate_spec_nr-0=%hd\n",
			r159->rate_spec_nr[0]);
		fprintf(logfil,"\t\trate_gruppe-0=%s\n",
			r159->rate_gruppe[0]);
		fprintf(logfil,"\t\trate_antal-0=%ld\n",
			r159->rate_antal[0]);
		fprintf(logfil,"\t\trate_pris-0=%lf\n",
			r159->rate_pris[0]);
		fprintf(logfil,"\t\ttotal=%lf\n",r159->total);
		fprintf(logfil,"\t\tpai_ialt=%lf\n",r159->pai_ialt);
		fprintf(logfil,"\t\tforv_tid_ind=%ld\n",r159->forv_tid_ind);
		fprintf(logfil,"\t\ttid_ud=%ld\n",r159->tid_ud);
	}
/* NYT 140901 PSMBIDRAGPRODUKTINKL */
	ege_w_int1 = 0;
	wx1 = 0;
	while (wx1<10) {
		if (r159->rate_spec_nr[wx1]==944) { ege_w_int1++; }
		wx1++;
	}
	if (ege_w_int1>0) {
		sprintf(produktincl,
		"inkl. moms, miljøbidrag, forsikring (selvrisiko) og");
	}
	if (logfil) {
		fprintf(logfil,"\t\tproduktincl=<%s>\n",produktincl);
	}

/* TESTSEND */
	alfalow(str);
	pack_init(str);
	pack_int2((long)r159->station_ud_nr);
	pack_alfa(ws_biltype);
	pack_alfa(ws_grp);
	pack_int2((long)r159->station_ind_nr);

	ege_w_int1 = m036_funktion(17,(long int)r159->dato_ud);
	sprintf(tmpstr,"%8.8ld",ege_w_int1);
	pack_alfa(tmpstr);

	ege_w_int1 = m036_funktion(17,(long int)r159->forv_dato_ind);
	sprintf(tmpstr,"%8.8ld",ege_w_int1);
	pack_alfa(tmpstr);

	sprintf(tmpstr,"%4.4ld",r159->tid_ud);
	pack_alfa(tmpstr);

	sprintf(tmpstr,"%4.4ld",r159->forv_tid_ind);
	pack_alfa(tmpstr);

/* varighed */
	ege_w_int1 = produktvarighed;
	if (ws_psextradag>0) {
		ege_w_int1++;
	}
/* NYT 141021 PSWEEKENDVARIGHEDJUSTERING */
/* OBS CHECK OM FULD WEEKENDPRODUKT */
	altproduktvarighed = 0;

	if (ws_fradato>0) {
		kundefdatotid = (double)ws_fradato;
		kundefdatotid *= 10000;
		kundefdatotid += (double)ws_fratid;
	}
	if (ws_tildato>0) {
		kundetdatotid = (double)ws_tildato;
		kundetdatotid *= 10000;
		kundetdatotid += (double)ws_tiltid;
	}
	if (ws_altfradato>0) {
		prodfdatotid =(double) ws_altfradato;
		prodfdatotid *= 10000;
		prodfdatotid += (double)ws_altfratid;
	}
	if (ws_alttildato>0) {
		prodtdatotid = (double)ws_alttildato;
		prodtdatotid *= 10000;
		prodtdatotid += (double)ws_alttiltid;
	}
	if (logfil) {
		fprintf(logfil,
			"\t\tPSVARIGHED-1 kundedatotid %12.0lf-%12.0lf\n",
			kundefdatotid,
			kundetdatotid);
		fprintf(logfil,
			"\t\tproddatotid %12.0lf-%12.0lf\n",
			prodfdatotid,
			prodtdatotid);
		fprintf(logfil,
			"\t\taltproduktvarighed=%hd\n",altproduktvarighed);
	}

/*
		ws_altfradato = produktfradato;
		ws_altfratid = produktfratid;
		ws_alttildato = produkttildato;
		ws_alttiltid = produkttiltid;
*/
	if (altproduktvarighed>0 && kundevarighed<produktvarighed) {
		ege_w_int1 = kundevarighed;
	}
	pack_int2((long)ege_w_int1);
/* prodid */
	pack_alfa(produktkode);
/* prodtekst */
/* NYT 140423 PRODUKTNAVN */
/*
	strcpy(tmpstr,produkttekst);
*/
/* NYT 140820 PSUPDATEPRODNAVN */
	(void)opbyg_psproduktnavn(mainloopidx,produktkode,tmpstr);

/* RETTET 140820 PSUPDATEPRODNAVN
	(void)get_alfa_tgn(ws_grpxtab[mainloopidx],0,tmpstr,';');
	if (strcmp(produktkode,"801")==0) {
		strcat(tmpstr,"-weekend");
	}
	if (ws_psextradag>0) {
		strcat(tmpstr,"(+1)");
	}
*/

	pack_alfa(tmpstr);
/* prodincl */
	pack_alfa(produktincl);
/* prodfilref */
	sprintf(tmpstr,"stdbil.jpg");
/* NYT 140409 */
/*
	sprintf(tmpstr,"./Bilgrupper/grp%s.jpg",ws_grp);
	sprintf(tmpstr,"./Bilgrupper/%s.jpg",ws_grp);
	sprintf(tmpstr,"%s.jpg",ws_grp);
*/
	sprintf(tmpstr,"grp%s.jpg",ws_grp);
/* NYT 140411 GRPPLUS */
	if (ws_grp[1]=='+') {
		tmpstr[4] = '\0';
		strcat(tmpstr,"plus.jpg");
	}
	ege_tolower((unsigned char *)tmpstr);
	pack_alfa(tmpstr);

/* Incl.Km */
	pack_int2((long)r159->rate_incl_km[10]);
/* Pris.Extra.Km */
/*	pack_doub(r159->rate_ekstra_km[10]); */
	ege_w_dou1 = r159->rate_ekstra_km[10];
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
/* selvrisiko */
	(void)add_divpligtopl(1,ws_grp);
/* RETTET 140509
	sprintf(tmpstr,"Selvrisiko DKK 3.500.");
	pack_alfa(tmpstr);
*/

/* afhtekst */
	sprintf(tmpstr,"Medbring kørekort ved afhentning og evt.booknr.");
	pack_alfa(tmpstr);
/* afltekst */
	sprintf(tmpstr,"Spar omk. ved at aflevere med fuld tank.");
	pack_alfa(tmpstr);
/* lokketekst TEASER */
	sprintf(tmpstr,"Dagsprisen falder, når perioden stiger...");
/* TEST 140327 */
	if (produktvarighed==1) {
		strcpy(tmpstr,"");
	}
/* NYT 140723 PSNOTEASER */
	strcpy(tmpstr,"");
/* NYT 140725 PSWEEKENDMATCH */
	(void)opbyg_teasertekst(xlsprodidx,tmpstr);

	pack_alfa(tmpstr);

/* NYT 140401 OBS PSREQUEST */
	ws_requestflag = 0;
/* RETTET 140416
	if (strcmp(ws_grp,"F")==0) {
		ws_requestflag = 1;
	}
*/
/* NYT 140416 PSREQUESTKON */
	ws_psbookstatus = 1;
	ws_requestflag = check_requestflag(0,produktvarighed);
	if (ws_requestflag>0) {
		ws_psbookstatus = 2 + ws_requestflag;
	}
/* NYT 140508 REQUESTMNR TEST SNYD J9D
	if (strcmp(ws_grp,"J9D")==0) {
		ws_psbookstatus = 4;
	}
*/
	if (logfil) {
		fprintf(logfil,
	"\tPSREQUEST check_requestflag ws_requestflag=%d ws_psbookstatus=%d\n",
			ws_requestflag,
			ws_psbookstatus);
	}
	ws_requestflag = check_requeststyr(1,
		ws_station,
		ws_biltype,
		ws_grp,
		r159->dato_ud);
	if (ws_requestflag>0) {
		ws_psbookstatus = 2 + ws_requestflag;
	}
	if (logfil) {
		fprintf(logfil,
	"\tPSREQUEST check_requeststyr ws_requestflag=%d ws_psbookstatus=%d\n",
			ws_requestflag,
			ws_psbookstatus);
	}

/* PSBOOKSTATUS PSREQUEST Bookstatus BookStatus */
	pack_int2((long)ws_psbookstatus);
	sprintf(tmpstr,"Ok");
/* PSBOOKSTATUS PSREQUEST Bookstatus BookStatus */
	if (ws_psbookstatus==3) {
		sprintf(tmpstr,"Request");
	}
	if (ws_psbookstatus==4) {
		sprintf(tmpstr,"Request m. nr");
	}
	pack_alfa(tmpstr);

/* pris pr dag PrisPrDag */
	ege_w_int1 = produktvarighed;
/* NYT 141021 PSWEEKENDVARIGHEDJUSTERING */
/* OBS CHECK OM FULD WEEKENDPRODUKT */


	if (altproduktvarighed>0 && kundevarighed<produktvarighed) {
		ege_w_int1 = kundevarighed;
	}
	if (logfil) {
		fprintf(logfil,
	"\tPSVARIGHED-2 produktvarighed=%ld kundevarighed=%ld ege_w_int1=%ld\n",
			produktvarighed,
			kundevarighed,
			ege_w_int1);
	}
	ege_w_dou1 = r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
	ege_w_dou1 /= (double)ege_w_int1;
/*	pack_doub(ege_w_dou1); */
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);

	(void)add_psbetalinginfo(1,produktkode,produktvarighed);

/* Ekstra */
	sprintf(tmpstr,"Ekstraudstyrsliste");
	pack_alfa(tmpstr);
	sscanf(produktkode,"%hd",&ws_specnr);
	(void)init_extraptab(1);
 	pack_del();
	extraretur = send_extraptab(2,produktvarighed);

	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil,"SENDT:%s",str);
		fflush(logfil);
	}
	retur++;
/* NULSTIL DIV FELTER */
	ws_paiflag = 0;

	if (logfil) {
		fprintf(logfil,"\tMAINLOOPBUND\n");
		fprintf(logfil,"\t\tws_paiflag=%hd\n",ws_paiflag);
	}

	mainloopidx++;
	goto mainloop00;
mainloopstop:
	if (logfil) {
		fprintf(logfil, "\tMAINLOOPSTOP\n");
	}
	if (mainloopidx>0) {
		goto mainprodukt;
	}
mainprodstop:
	if (logfil) {
		fprintf(logfil, "\tws_alderblok=%d\n", ws_alderblok);
		fprintf(logfil, "send_psmatch_prodliste:retur=%hd\n", retur);
	}
	return(retur);
}

/* ************************************************************ */
static void opbyg_teasertekst(int inpnuvxlsidx,char *returstr) {
	int idx = 0;
	int weekendflag = 0;
	char nytekststr[201] = "";

	if (logfil) {
		fprintf(logfil,"opbyg_teasertekst %d\n",inpnuvxlsidx);
	}
	idx = 0;
	while (idx<=ws_xlsprodmatchidx) {
		weekendflag = 0;
		if (idx!=inpnuvxlsidx &&
			ws_xlsprodmatchtabel[idx]==801 &&
			strlen(ws_xlsprodmatchtidopl[idx])) {
			weekendflag = 1;
		}
		if (idx>inpnuvxlsidx &&
			ws_xlsprodmatchtabel[idx]==801 &&
			strlen(ws_xlsprodmatchtidopl[idx])) {
			weekendflag = 2;
		}
		if (idx!=inpnuvxlsidx &&
			ws_xlsprodmatchtabel[idx]==832 &&
			strlen(ws_xlsprodmatchtidopl[idx])) {
			weekendflag = 1;
		}
		if (idx>inpnuvxlsidx &&
			ws_xlsprodmatchtabel[idx]==832 &&
			strlen(ws_xlsprodmatchtidopl[idx])) {
			weekendflag = 2;
		}
		if (idx!=inpnuvxlsidx &&
			ws_xlsprodmatchtabel[idx]==833 &&
			strlen(ws_xlsprodmatchtidopl[idx])) {
			weekendflag = 1;
		}
		if (idx>inpnuvxlsidx &&
			ws_xlsprodmatchtabel[idx]==833 &&
			strlen(ws_xlsprodmatchtidopl[idx])) {
			weekendflag = 2;
		}

/* RETTET 141114 PSGLNYKATALOG 
		if (idx!=inpnuvxlsidx &&
			ws_xlsprodmatchtabel[idx]==801 &&
			strlen(ws_xlsprodmatchtidopl[idx])) {
			strcpy(nytekststr,
			"Overvej vores weekendtilbud");
		}
		if (idx>inpnuvxlsidx &&
			ws_xlsprodmatchtabel[idx]==801 &&
			strlen(ws_xlsprodmatchtidopl[idx])) {
			strcat(nytekststr,
			" (herunder)");
		}
*/
/* NYT 141114 PSGLNYKATALOG */
		if (weekendflag>=1) {
			strcpy(nytekststr,
			"Overvej vores weekendtilbud");
		}
		if (weekendflag==2) {
			strcat(nytekststr,
			" (herunder)");
		}
		idx++;
	}
	if (strlen(nytekststr)) {
		strcpy(returstr,nytekststr);
	}
	if (logfil) {
		fprintf(logfil,"opbyg_teasertekst returstr=<%s>\n",returstr);
	}
	return;
}

/* NYT 140820 PSUPDATEPRODNAVN */
/* ************************************************* */
static void opbyg_psproduktnavn(int inpgrpidx,char *inpprodkode,char *returstr) {
	int nuvgrpidx = -1;
	int chkgrpidx = -1;
	char tmpstr[81] = "";
	char chkgrp[81] = "";

	if (logfil) {
		fprintf(logfil,"opbyg_psproduktnavn %d %s\n",
			inpgrpidx,inpprodkode);
		fprintf(logfil,"\tws_psextradag=%d\n",ws_psextradag);
		fprintf(logfil,"\tws_grp=%s\n",ws_grp);
		fprintf(logfil,"\txlsprismain->produktnavn=%s\n"
			,xlsprismain->produktnavn);
	}

	if (inpgrpidx>=0) {
		nuvgrpidx = inpgrpidx;
	}
	chkgrpidx = 0;
	while (inpgrpidx<0 && ws_grpidx>=0 && chkgrpidx<ws_grpidx) {
		if (logfil) {
			fprintf(logfil,"\t\tchkgrpidx=%d ws_grptab=<%s>\n",
				chkgrpidx,
				ws_grptab[chkgrpidx]);
		}
		sscanf(ws_grptab[chkgrpidx]+8,"%s",chkgrp);
		if (strcmp(chkgrp,ws_grp)==0) {
			nuvgrpidx = chkgrpidx;
			break;
		}
		chkgrpidx++;
	}

	if (logfil) {
		fprintf(logfil,"\tnuvgrpidx=%d\n",nuvgrpidx);
	}

	if (nuvgrpidx>=0) {
		(void)get_alfa_tgn(ws_grpxtab[nuvgrpidx],0,tmpstr,';');
		if (strcmp(inpprodkode,"801")==0) {
			strcat(tmpstr,"-weekend");
		}
/* NYT 141114 PSGLNYKATALOG */
		if (strcmp(inpprodkode,"832")==0) {
			strcat(tmpstr,"-weekend");
		}
		if (strcmp(inpprodkode,"833")==0) {
			strcat(tmpstr,"-weekend");
		}
		if (strcmp(inpprodkode,"837")==0) {
			strcat(tmpstr,"-weekend");
		}
		if (strcmp(inpprodkode,"838")==0) {
			strcat(tmpstr,"-weekend");
		}
		if (strcmp(inpprodkode,"834")==0) {
			strcat(tmpstr,"-lør/søn");
		}
		if (strcmp(inpprodkode,"839")==0) {
			strcat(tmpstr,"-lør/søn");
		}
/* NYT 150216 PSPAASKE */
		if (strcmp(inpprodkode,"847")==0) {
			strcat(tmpstr,"-påske");
		}

/* NYT 140513 PSSENEREAFLTID */
		if (ws_psextradag>0) {
			strcat(tmpstr,"(+1)");
		}
	}
/* NYT 141117 PSGLNYKATALOG */
/* RETTET 150216 PSPAASKE
	if (ws_testkreds>0 && access("psnyprod",0)==0) {
		strcat(tmpstr,"-NyT");
	}
*/
	if (strlen(tmpstr)) {
		strcpy(returstr,tmpstr);
	}
	if (logfil) {
		fprintf(logfil,"opbyg_psproduktnavn returstr=<%s>\n",
			returstr);
		fflush(logfil);
	}
	return;
}

/* NYT 150512 WEBAPI27 */
/* ************************************************************ */
static int dan_ecxlsprodmatchtabel(int inpfunk,long inpvarighed) {
	int retur = 0;
	int wx1 = 0;
	int blackoutantal = 0;
	int matchantal = 0;
	int xlsmainflag = 0;
	int weekendmatch = 0;
	int produktok = 0;
	int xlsbiltypekode = 0;
	long int weekendstartdato = 0;
	long int weekendstarttid = 0;
	long int weekendslutdato = 0;
	int weekendvarighed = 0;
	long int julian = 0;
	int igenflag = 0;
	int antal = 0;
	int tabelidx = 0;
	int idx = 0;
	int sortfunk = 0;
	long int returdato = 0;
	char tmpstr[81] = "";
	char filsti1[81] = "";
	char returstr[201] = "";
	FILE * matchfil;

	matchfil = (FILE*)0;
        if (logfil) {
                fprintf(logfil,"dan_ecxlsprodmatchtabel %d %ld\n",
			inpfunk,inpvarighed);
                fprintf(logfil,"\tws_grp=%s\n",ws_grp);
                fprintf(logfil,"\tws_biltype=%s\n",ws_biltype);
                fprintf(logfil,"\tws_grpidx=%hd\n",ws_grpidx);
        }
	wx1 = 0;
	while (logfil && wx1<ws_grpidx) {
                fprintf(logfil,"\tws_grptab-%d=%s\n",wx1,ws_grptab[wx1]);
		wx1++;
	}
	xlsbiltypekode = -1;
/*
	if (strlen(ws_biltype) && strcmp(ws_biltype,"PRS")==0) {
		xlsbiltypekode = 0;
	}
	if (strlen(ws_biltype) && strcmp(ws_biltype,"BUS")==0) {
		xlsbiltypekode = 0;
	}
	if (strlen(ws_biltype) && strcmp(ws_biltype,"VAR")==0) {
		xlsbiltypekode = 1;
	}
	if (strlen(ws_biltype) && strcmp(ws_biltype,"LST")==0) {
		xlsbiltypekode = 1;
	}
*/
	if (logfil) {
		fprintf(logfil,"\txlsbiltypekode=%d\n",xlsbiltypekode);
	}

	strcpy(xlsprismatch->brand,"EC");
	xlsprismatch->uddato = ws_fradato;
	xlsprismatch->inddato = ws_tildato;
	xlsprismatch->udtid = ws_fratid;
	xlsprismatch->indtid = 0;
/* RETTET 150513
	xlsprismatch->indtid = ws_tiltid;
*/
	xlsprismatch->stationnr = ws_station;
	xlsprismatch->dgvarighed = inpvarighed;
	returdato = m036_funktion(11, xlsprismatch->uddato);
	xlsprismatch->uddagnr = (int)(returdato%10);
	xlsprismatch->maxindtid = 0;
	tabelidx = 0;
igen00:
	sprintf(filsti1,"/tmp/p7912xls_%hd.res",ege_pid);
        if (logfil) {
                fprintf(logfil,"\tfilsti1=%s\n",filsti1);
                fprintf(logfil,"\tigenflag=%d\n",igenflag);
        }
        xlsprismatch->funktion = 1;
	matchantal = xlspris_produkt(filsti1,returstr);
	if (logfil) {
		fprintf(logfil,"\tmatchantal=%d\n",matchantal);
		fprintf(logfil,"\tfilsti1=%s returstr=%s\n",filsti1,returstr);
	}
	if (matchantal<=0) {
		goto afslut;
	}
        matchfil = fopen(filsti1,"rb");
	if (!matchfil) {
		matchfil = (FILE*)0;
		goto afslut;
	}
	antal = 0;
/* UDENSORTERING */
        while (sortfunk==0 && matchfil && antal<matchantal) {
                fread(xlsprismain,sizeof(XLSPRISMAIN),1,matchfil);
/* NYT 141114 PSGLNYKATALOG */
		if (logfil) {
			fprintf(logfil,"\t\tantal=%d specnr=%ld\n",
				antal,
				xlsprismain->specnr);
			fprintf(logfil,"\t\tblackout=%ld-%ld\n",
				xlsprismain->blackout_ival[0],
				xlsprismain->blackout_ival[1]);
			fflush(logfil);
		}
		produktok = 0;
		if (xlsprismain->specnr==10) {
			produktok++;
		}
		if (xlsprismain->specnr==20) {
			produktok++;
		}

/* ECPAASKE
		sprintf(tmpstr,"ps%2.2hdspc%ld",ws_station,xlsprismain->specnr);
		if (access("psnyprod",0)==0 && access(tmpstr,0)==0) {
			produktok++;
		}
*/
		if (check_ecxlsmainprodukt_grptab()<=0) {
			produktok = -1;
		}
		if (logfil) {
			fprintf(logfil,"\t\tproduktok01=%d\n",
				produktok);
			fflush(logfil);
		}
		if (produktok<=0) {
                	antal++;
			continue;
		}
/* ECVL
		sprintf(tmpstr,"ps%2.2hdvls",ws_station);
		if (access(tmpstr,0)!=0 && xlsprismain->specnr==834) {
			produktok = -2;
		}
		sprintf(tmpstr,"ps%2.2hdvls",ws_station);
		if (access(tmpstr,0)!=0 && xlsprismain->specnr==839) {
			produktok = -2;
		}
*/
		if (logfil) {
			fprintf(logfil,"\t\tproduktok02=%d\n",
				produktok);
			fflush(logfil);
		}
		if (produktok<=0) {
                	antal++;
			continue;
		}
/* PSPAASKE
		if (xlsprismain->specnr==847) {
			ws_xlsprodmatchsorting[tabelidx] = 1;
		}
		if (xlsprismain->specnr==847 &&
			access("pswebblackout",0)==0 &&
			xlsprismain->blackout_ival[0]>0 &&
			xlsprismain->blackout_ival[1]>0 &&
			ws_fradato>=xlsprismain->blackout_ival[0] &&
			ws_fradato<=xlsprismain->blackout_ival[1]) {
			ws_xlsprodmatchsorting[tabelidx] = 0;
		}
*/
		ws_xlsprodmatchtabel[tabelidx] = (int)xlsprismain->specnr;
		ws_xlsprodmatchindtidtabel[tabelidx] = (int)xlsprismain->indtid;
/* NYT 140724 PSWEEKENDMATCH */
		if (weekendmatch>0 &&
			xlsprismatch->uddato==0 &&
			xlsprismatch->inddato==0 &&
			xlsprismatch->udtid==0 &&
			xlsprismatch->indtid==0) {
			sprintf(ws_xlsprodmatchtidopl[tabelidx],
				"%ld;%ld;%ld;%ld;%d",
				weekendstartdato,
				weekendstarttid,
				weekendslutdato,
				xlsprismain->indtid,
				weekendvarighed);
		}
		ws_xlsprodmatchidx = tabelidx;
/* PSWEEKENDMATCH
		if (xlsprismain->specnr==801 && igenflag==0) {
			weekendmatch = -1;
		}
		if (xlsprismain->specnr==832 && igenflag==0) {
			weekendmatch = -1;
		}
		if (xlsprismain->specnr==833 && igenflag==0) {
			weekendmatch = -1;
		}
		if (xlsprismain->specnr==837 && igenflag==0) {
			weekendmatch = -1;
		}
		if (xlsprismain->specnr==838 && igenflag==0) {
			weekendmatch = -1;
		}
*/
		tabelidx++;
                antal++;
		retur++;
	}
	if (matchfil) {
		fclose(matchfil);
		matchfil = (FILE*)0;
	}
	(void)unlink(filsti1);
	if (igenflag>0) {
		weekendmatch = -1;
	}

	if (logfil) {
		fprintf(logfil,"\tws_xlsprodmatchidx=%d\n",ws_xlsprodmatchidx);
		fprintf(logfil,"\tweekendmatch-00=%d\n",weekendmatch);
	}
/* NYT 140724 PSWEEKENDMATCH */
#ifdef egetest
	if (weekendmatch==0 &&
		access("psglprod",0)==0 &&
		xlsprismatch->uddagnr==5 && xlsprismatch->dgvarighed<5) {
		weekendmatch++;
		julian = m036_funktion(12, ws_fradato);
		weekendstartdato = m036_funktion(19, julian);
		julian += 3;
		weekendslutdato = m036_funktion(19, julian);
		sprintf(tmpstr,"PS%5.5hd%5.5hdSTD.main",
			ws_station,
			(short int)801);
		xlsmainflag = xlspris_udpakmain(tmpstr);
		weekendstarttid = xlsprismain->udtid;
		if (ws_fratid>xlsprismain->udtid) {
			weekendstarttid = ws_fratid;
		}
		weekendvarighed = (int)xlsprismain->varighed_ival[0];
	}
	if (weekendmatch==0 &&
		access("psglprod",0)==0 &&
		xlsprismatch->uddagnr==6 && xlsprismatch->dgvarighed<5) {
		weekendmatch++;
		julian = m036_funktion(12, ws_fradato);
		julian -= 1;
		weekendstartdato = m036_funktion(19, julian);
		julian += 3;
		weekendslutdato = m036_funktion(19, julian);
		sprintf(tmpstr,"PS%5.5hd%5.5hdSTD.main",
			ws_station,
			(short int)801);
		xlsmainflag = xlspris_udpakmain(tmpstr);
		weekendstarttid = xlsprismain->udtid;
		if (ws_fratid>xlsprismain->udtid) {
			weekendstarttid = ws_fratid;
		}
		weekendvarighed = (int)xlsprismain->varighed_ival[0];
	}
	if (weekendmatch==0 &&
		access("psglprod",0)==0 &&
		xlsprismatch->uddagnr==7 && xlsprismatch->dgvarighed<5) {
		weekendmatch++;
		julian = m036_funktion(12, ws_fradato);
		julian -= 2;
		weekendstartdato = m036_funktion(19, julian);
		julian += 3;
		weekendslutdato = m036_funktion(19, julian);
		sprintf(tmpstr,"PS%5.5hd%5.5hdSTD.main",
			ws_station,
			(short int)801);
		xlsmainflag = xlspris_udpakmain(tmpstr);
		weekendstarttid = xlsprismain->udtid;
		if (ws_fratid>xlsprismain->udtid) {
			weekendstarttid = ws_fratid;
		}
		weekendvarighed = (int)xlsprismain->varighed_ival[0];
	}
/* NYT 141114 PSGLNYKATALOG */
	if (weekendmatch==0 &&
		access("psnyprod",0)==0 &&
		xlsprismatch->uddagnr==5 && xlsprismatch->dgvarighed<5) {
		weekendmatch++;
		julian = m036_funktion(12, ws_fradato);
		weekendstartdato = m036_funktion(19, julian);
		julian += 3;
		weekendslutdato = m036_funktion(19, julian);
	}
	if (weekendmatch==0 &&
		access("psnyprod",0)==0 &&
		xlsprismatch->uddagnr==6 && xlsprismatch->dgvarighed<5) {
		weekendmatch++;
		julian = m036_funktion(12, ws_fradato);
		julian -= 1;
		weekendstartdato = m036_funktion(19, julian);
		julian += 3;
		weekendslutdato = m036_funktion(19, julian);
	}
	if (weekendmatch==0 &&
		access("psnyprod",0)==0 &&
		xlsprismatch->uddagnr==7 && xlsprismatch->dgvarighed<5) {
		weekendmatch++;
		julian = m036_funktion(12, ws_fradato);
		julian -= 2;
		weekendstartdato = m036_funktion(19, julian);
		julian += 3;
		weekendslutdato = m036_funktion(19, julian);
	}
	if (weekendmatch==1 &&
		access("psnyprod",0)==0) {
		sprintf(tmpstr,"PS%5.5hd%5.5hdSTD.main",
			ws_station,
			(short int)832 + xlsbiltypekode);
		xlsmainflag = xlspris_udpakmain(tmpstr);
	}
	if (weekendmatch==1 &&
		access("psnyprod",0)==0 &&
		xlsmainflag>0) {
		weekendstarttid = xlsprismain->udtid;
		if (ws_fratid>xlsprismain->udtid) {
			weekendstarttid = ws_fratid;
		}
		weekendvarighed = (int)xlsprismain->varighed_ival[0];
	}
#endif

	returdato = m036_funktion(11, ws_systemdato);
	if (weekendmatch==1 && returdato%10==7) { weekendmatch = 0; }
	if (weekendmatch==1 && returdato%10==6) { weekendmatch = 0; }
	if (weekendmatch==1 && returdato%10==5 && ws_fratid>=1700) {
		weekendmatch = 0;
	}
/* NYT 150212 FREDAGWEEKENDAABEN */
	wx1 = 1;
	if (weekendmatch==1 && weekendstartdato>0 && weekendstarttid>0) {
		wx1 = check_bssaaben(-1,
			ws_station,
			weekendstartdato,
			weekendstarttid);
	}
	if (wx1<=0) { weekendmatch = 0; }

	if (logfil) {
		fprintf(logfil,"\tweekendmatch-01=%d\n",weekendmatch);
		fprintf(logfil,"\twx1=%d\n",wx1);
		fprintf(logfil,"\txlsmainflag=%d\n",xlsmainflag);
		fprintf(logfil,"\tweekendstartdato=%ld\n",weekendstartdato);
		fprintf(logfil,"\tweekendstarttid=%ld\n",weekendstarttid);
		fprintf(logfil,"\tweekendslutdato=%ld\n",weekendslutdato);
		fprintf(logfil,"\tweekendvarighed=%ld\n",weekendvarighed);
	}
#ifdef egetest
	if (access("psweekaltok",0)==0 &&
		access("psglprod",0)==0 &&
		weekendmatch>0) {
		xlsprismatch->uddagnr = 5;
		xlsprismatch->dgvarighed = 3;
		xlsprismatch->specnr = 801;
		xlsprismatch->uddato = 0;
		xlsprismatch->inddato = 0;
		xlsprismatch->udtid = 0;
		xlsprismatch->indtid = 0;
		igenflag++;
		goto igen00;
	}
	if (access("psweekaltok",0)==0 &&
		access("psnyprod",0)==0 &&
		xlsbiltypekode>=0 &&
		weekendmatch>0) {
		xlsprismatch->uddagnr = 5;
		xlsprismatch->dgvarighed = 3;
		xlsprismatch->specnr = 832 + xlsbiltypekode;
		xlsprismatch->uddato = 0;
		xlsprismatch->inddato = 0;
		xlsprismatch->udtid = 0;
		xlsprismatch->indtid = 0;
		igenflag++;
		goto igen00;
	}
#endif
	if (logfil) {
		fprintf(logfil,"\tws_xlsprodmatchidx=%d\n",ws_xlsprodmatchidx);
	}
	idx = 0;
	while (logfil && idx<=ws_xlsprodmatchidx) {
		fprintf(logfil,"\t\tws_xlsprodmatchtabel-%d=%d\n",
			idx,
			ws_xlsprodmatchtabel[idx]);
		fprintf(logfil,"\t\tws_xlsprodmatchsorting-%d=%d\n",
			idx,
			ws_xlsprodmatchsorting[idx]);
		fprintf(logfil,"\t\tws_xlsprodmatchindtidtabel-%d=%ld\n",
			idx,
			ws_xlsprodmatchindtidtabel[idx]);
		fprintf(logfil,"\t\tws_xlsprodmatchtidopltabel-%d=%s\n",
			idx,
			ws_xlsprodmatchtidopl[idx]);
		idx++;
	}
afslut:	
/* NYT 150216 PSPAASKE SORTERING */
	blackoutantal = 0;
	idx = ws_xlsprodmatchidx;
	while (idx>0) {
		for (wx1=1;wx1<=idx;wx1++) {
			if (ws_xlsprodmatchsorting[wx1]<
				ws_xlsprodmatchsorting[wx1-1]) {
			ws_xlsprodmatchtabel[MAXXLSPRODMATCH-1] =
				ws_xlsprodmatchtabel[wx1];
			ws_xlsprodmatchsorting[MAXXLSPRODMATCH-1] =
				ws_xlsprodmatchsorting[wx1];
			ws_xlsprodmatchindtidtabel[MAXXLSPRODMATCH-1] = 
				ws_xlsprodmatchindtidtabel[wx1];
			strcpy(ws_xlsprodmatchtidopl[MAXXLSPRODMATCH-1],
				ws_xlsprodmatchtidopl[wx1]);

			ws_xlsprodmatchtabel[wx1] =
				ws_xlsprodmatchtabel[wx1-1];
			ws_xlsprodmatchsorting[wx1] =
				ws_xlsprodmatchsorting[wx1-1];
			ws_xlsprodmatchindtidtabel[wx1] = 
				ws_xlsprodmatchindtidtabel[wx1-1];
			strcpy(ws_xlsprodmatchtidopl[wx1],
				ws_xlsprodmatchtidopl[wx1-1]);
			if (ws_xlsprodmatchsorting[MAXXLSPRODMATCH-1]==0) {
				blackoutantal++;
				ws_xlsprodmatchtabel[wx1] = 0;
				ws_xlsprodmatchsorting[wx1] = 0;
				ws_xlsprodmatchindtidtabel[wx1] = 0;
				strcpy(ws_xlsprodmatchtidopl[wx1],"");
			}
			ws_xlsprodmatchtabel[wx1-1] =
				ws_xlsprodmatchtabel[MAXXLSPRODMATCH-1];
			ws_xlsprodmatchsorting[wx1-1] =
				ws_xlsprodmatchsorting[MAXXLSPRODMATCH-1];
			ws_xlsprodmatchindtidtabel[wx1-1] = 
				ws_xlsprodmatchindtidtabel[MAXXLSPRODMATCH-1];
			strcpy(ws_xlsprodmatchtidopl[wx1-1],
				ws_xlsprodmatchtidopl[MAXXLSPRODMATCH-1]);
			ws_xlsprodmatchtabel[MAXXLSPRODMATCH-1] = 0;
			ws_xlsprodmatchsorting[MAXXLSPRODMATCH-1] = 0;
			ws_xlsprodmatchindtidtabel[MAXXLSPRODMATCH-1] = 0;
			strcpy(ws_xlsprodmatchtidopl[MAXXLSPRODMATCH-1],"");

			}
/* NYT 150306 BLACKOUTJUSTERING */
			if (ws_xlsprodmatchsorting[wx1]>=
				ws_xlsprodmatchsorting[wx1-1] &&
				ws_xlsprodmatchsorting[wx1-1]==0 &&
				blackoutantal==0) {
				blackoutantal++;
				ws_xlsprodmatchtabel[wx1] = 0;
				ws_xlsprodmatchsorting[wx1] = 0;
				ws_xlsprodmatchindtidtabel[wx1] = 0;
				strcpy(ws_xlsprodmatchtidopl[wx1],"");
			}
		}
		idx--;
	}
	ws_xlsprodmatchidx -= blackoutantal;
	retur -= blackoutantal;
	if (logfil) {
		fprintf(logfil,"\tblackoutantal=%d\n",blackoutantal);
		fprintf(logfil,"\tws_xlsprodmatchidx=%d\n",ws_xlsprodmatchidx);
		fprintf(logfil,"dan_xlsprodmatchtabel retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************ */
static int dan_xlsprodmatchtabel(int inpfunk,long inpvarighed) {
	int retur = 0;
	int wx1 = 0;
	int blackoutantal = 0;
	int matchantal = 0;
	int xlsmainflag = 0;
	int weekendmatch = 0;
	int produktok = 0;
	int xlsbiltypekode = 0;
	long int weekendstartdato = 0;
	long int weekendstarttid = 0;
	long int weekendslutdato = 0;
	int weekendvarighed = 0;
	long int julian = 0;
	int igenflag = 0;
	int antal = 0;
	int tabelidx = 0;
	int idx = 0;
	int sortfunk = 0;
	long int returdato = 0;
	char tmpstr[81] = "";
	char filsti1[81] = "";
	char returstr[201] = "";
	FILE * matchfil;

	matchfil = (FILE*)0;
        if (logfil) {
                fprintf(logfil,"dan_xlsprodmatchtabel %d %ld\n",
			inpfunk,inpvarighed);
                fprintf(logfil,"\tws_grp=%s\n",ws_grp);
                fprintf(logfil,"\tws_biltype=%s\n",ws_biltype);
                fprintf(logfil,"\tws_grpidx=%hd\n",ws_grpidx);
        }
	wx1 = 0;
	while (logfil && wx1<ws_grpidx) {
                fprintf(logfil,"\tws_grptab-%d=%s\n",wx1,ws_grptab[wx1]);
		wx1++;
	}
	xlsbiltypekode = -1;
	if (strlen(ws_biltype) && strcmp(ws_biltype,"PRS")==0) {
		xlsbiltypekode = 0;
	}
	if (strlen(ws_biltype) && strcmp(ws_biltype,"BUS")==0) {
		xlsbiltypekode = 0;
	}
	if (strlen(ws_biltype) && strcmp(ws_biltype,"VAR")==0) {
		xlsbiltypekode = 1;
	}
	if (strlen(ws_biltype) && strcmp(ws_biltype,"LST")==0) {
		xlsbiltypekode = 1;
	}
	if (logfil) {
		fprintf(logfil,"\txlsbiltypekode=%d\n",xlsbiltypekode);
	}

	strcpy(xlsprismatch->brand,"PS");
	xlsprismatch->uddato = ws_fradato;
	xlsprismatch->inddato = ws_tildato;
	xlsprismatch->udtid = ws_fratid;
	xlsprismatch->indtid = ws_tiltid;
	xlsprismatch->stationnr = ws_station;
	xlsprismatch->dgvarighed = inpvarighed;
	returdato = m036_funktion(11, xlsprismatch->uddato);
	xlsprismatch->uddagnr = (int)(returdato%10);
	xlsprismatch->maxindtid = 0;
/* NYT 140513 PSSENEREAFLTID
	xlsprismatch->maxindtid = 2300;
*/
	xlsprismatch->maxindtid = 0;
	tabelidx = 0;
igen00:
	sprintf(filsti1,"/tmp/p7912xls_%hd.res",ege_pid);
        if (logfil) {
                fprintf(logfil,"\tfilsti1=%s\n",filsti1);
                fprintf(logfil,"\tigenflag=%d\n",igenflag);
        }
        xlsprismatch->funktion = 1;
	matchantal = xlspris_produkt(filsti1,returstr);
	if (logfil) {
		fprintf(logfil,"\tmatchantal=%d\n",matchantal);
		fprintf(logfil,"\tfilsti1=%s returstr=%s\n",filsti1,returstr);
	}
	if (matchantal<=0) {
		goto afslut;
	}
        matchfil = fopen(filsti1,"rb");
	if (!matchfil) {
		matchfil = (FILE*)0;
		goto afslut;
	}
	antal = 0;
/* UDENSORTERING */
        while (sortfunk==0 && matchfil && antal<matchantal) {
                fread(xlsprismain,sizeof(XLSPRISMAIN),1,matchfil);
/* NYT 141114 PSGLNYKATALOG */
		if (logfil) {
			fprintf(logfil,"\t\tantal=%d specnr=%ld\n",
				antal,
				xlsprismain->specnr);
			fprintf(logfil,"\t\tblackout=%ld-%ld\n",
				xlsprismain->blackout_ival[0],
				xlsprismain->blackout_ival[1]);
			fflush(logfil);
		}
		produktok = 0;
		if (access("psglprod",0)==0 && xlsprismain->specnr==800) {
			produktok++;
		}
		if (access("psglprod",0)==0 && xlsprismain->specnr==801) {
			produktok++;
		}
		if (access("psnyprod",0)==0 && xlsprismain->specnr==830) {
			produktok++;
		}
		if (access("psnyprod",0)==0 && xlsprismain->specnr==831) {
			produktok++;
		}
		if (access("psnyprod",0)==0 && xlsprismain->specnr==832) {
			produktok++;
		}
		if (access("psnyprod",0)==0 && xlsprismain->specnr==833) {
			produktok++;
		}
		if (access("psnyprod",0)==0 && xlsprismain->specnr==834) {
			produktok++;
		}
/* NYT 150216 PSPAASKE */
		sprintf(tmpstr,"ps%2.2hdspc%ld",ws_station,xlsprismain->specnr);
		if (access("psnyprod",0)==0 && access(tmpstr,0)==0) {
			produktok++;
		}

		if (check_xlsmainprodukt_bilgrp()<=0) {
			produktok = -1;
		}
		if (logfil) {
			fprintf(logfil,"\t\tproduktok01=%d\n",
				produktok);
			fflush(logfil);
		}
		if (produktok<=0) {
                	antal++;
			continue;
		}
/* NYT 141117 PSGLNYKATALOG */
/* RETTET 141209 PSGLNYKATALOGVL
		sprintf(tmpstr,"ps%2.2hdpls",ws_station);
		if (access(tmpstr,0)==0 && xlsprismain->specnr==830) {
			produktok = -2;
		}
		sprintf(tmpstr,"ps%2.2hdvls",ws_station);
		if (access(tmpstr,0)==0 && xlsprismain->specnr==831) {
			produktok = -2;
		}
*/
		sprintf(tmpstr,"ps%2.2hdvls",ws_station);
		if (access(tmpstr,0)!=0 && xlsprismain->specnr==834) {
			produktok = -2;
		}
		sprintf(tmpstr,"ps%2.2hdvls",ws_station);
		if (access(tmpstr,0)!=0 && xlsprismain->specnr==839) {
			produktok = -2;
		}

		if (logfil) {
			fprintf(logfil,"\t\tproduktok02=%d\n",
				produktok);
			fflush(logfil);
		}
		if (produktok<=0) {
                	antal++;
			continue;
		}


/* NYT 150216 PSPAASKE */
		if (xlsprismain->specnr==847) {
			ws_xlsprodmatchsorting[tabelidx] = 1;
		}
		if (xlsprismain->specnr==847 &&
			access("pswebblackout",0)==0 &&
			xlsprismain->blackout_ival[0]>0 &&
			xlsprismain->blackout_ival[1]>0 &&
			ws_fradato>=xlsprismain->blackout_ival[0] &&
			ws_fradato<=xlsprismain->blackout_ival[1]) {
			ws_xlsprodmatchsorting[tabelidx] = 0;
		}
		ws_xlsprodmatchtabel[tabelidx] = (int)xlsprismain->specnr;
		ws_xlsprodmatchindtidtabel[tabelidx] = (int)xlsprismain->indtid;
/* NYT 140724 PSWEEKENDMATCH */
		if (weekendmatch>0 &&
			xlsprismatch->uddato==0 &&
			xlsprismatch->inddato==0 &&
			xlsprismatch->udtid==0 &&
			xlsprismatch->indtid==0) {
			sprintf(ws_xlsprodmatchtidopl[tabelidx],
				"%ld;%ld;%ld;%ld;%d",
				weekendstartdato,
				weekendstarttid,
/* RETTET 141010 PSWEEKENDVARIGHEDSNYD xlsprismain->udtid, */
				weekendslutdato,
				xlsprismain->indtid,
				weekendvarighed);
/* RETTET 141022 PSWEEKENDVARIGHEDSNYD xlsprismain->varighed_ival[0]); */
		}
		ws_xlsprodmatchidx = tabelidx;
/* NYT 140724 PSWEEKENDMATCH */
		if (xlsprismain->specnr==801 && igenflag==0) {
			weekendmatch = -1;
		}
		if (xlsprismain->specnr==832 && igenflag==0) {
			weekendmatch = -1;
		}
		if (xlsprismain->specnr==833 && igenflag==0) {
			weekendmatch = -1;
		}
		if (xlsprismain->specnr==837 && igenflag==0) {
			weekendmatch = -1;
		}
		if (xlsprismain->specnr==838 && igenflag==0) {
			weekendmatch = -1;
		}

		tabelidx++;
                antal++;
		retur++;
	}
	if (matchfil) {
		fclose(matchfil);
		matchfil = (FILE*)0;
	}
	(void)unlink(filsti1);
	if (igenflag>0) {
		weekendmatch = -1;
	}

	if (logfil) {
		fprintf(logfil,"\tws_xlsprodmatchidx=%d\n",ws_xlsprodmatchidx);
		fprintf(logfil,"\tweekendmatch-00=%d\n",weekendmatch);
	}
/* NYT 140724 PSWEEKENDMATCH */
	if (weekendmatch==0 &&
		access("psglprod",0)==0 &&
		xlsprismatch->uddagnr==5 && xlsprismatch->dgvarighed<5) {
		weekendmatch++;
		julian = m036_funktion(12, ws_fradato);
		weekendstartdato = m036_funktion(19, julian);
		julian += 3;
		weekendslutdato = m036_funktion(19, julian);
/* NYT 141010 PSWEEKENDVARIGHEDSNYD */
		sprintf(tmpstr,"PS%5.5hd%5.5hdSTD.main",
			ws_station,
			(short int)801);
		xlsmainflag = xlspris_udpakmain(tmpstr);
		weekendstarttid = xlsprismain->udtid;
		if (ws_fratid>xlsprismain->udtid) {
			weekendstarttid = ws_fratid;
		}
		weekendvarighed = (int)xlsprismain->varighed_ival[0];
	}
	if (weekendmatch==0 &&
		access("psglprod",0)==0 &&
		xlsprismatch->uddagnr==6 && xlsprismatch->dgvarighed<5) {
		weekendmatch++;
		julian = m036_funktion(12, ws_fradato);
		julian -= 1;
		weekendstartdato = m036_funktion(19, julian);
		julian += 3;
		weekendslutdato = m036_funktion(19, julian);
/* NYT 141010 PSWEEKENDVARIGHEDSNYD */
		sprintf(tmpstr,"PS%5.5hd%5.5hdSTD.main",
			ws_station,
			(short int)801);
		xlsmainflag = xlspris_udpakmain(tmpstr);
//		weekendstarttid = ws_fratid;
		weekendstarttid = xlsprismain->udtid;
		if (ws_fratid>xlsprismain->udtid) {
			weekendstarttid = ws_fratid;
		}
		weekendvarighed = (int)xlsprismain->varighed_ival[0];
	}
	if (weekendmatch==0 &&
		access("psglprod",0)==0 &&
		xlsprismatch->uddagnr==7 && xlsprismatch->dgvarighed<5) {
		weekendmatch++;
		julian = m036_funktion(12, ws_fradato);
		julian -= 2;
		weekendstartdato = m036_funktion(19, julian);
		julian += 3;
		weekendslutdato = m036_funktion(19, julian);
/* NYT 141010 PSWEEKENDVARIGHEDSNYD */
		sprintf(tmpstr,"PS%5.5hd%5.5hdSTD.main",
			ws_station,
			(short int)801);
		xlsmainflag = xlspris_udpakmain(tmpstr);
//		weekendstarttid = ws_fratid;
		weekendstarttid = xlsprismain->udtid;
		if (ws_fratid>xlsprismain->udtid) {
			weekendstarttid = ws_fratid;
		}
		weekendvarighed = (int)xlsprismain->varighed_ival[0];
	}
/* NYT 141114 PSGLNYKATALOG */
	if (weekendmatch==0 &&
		access("psnyprod",0)==0 &&
		xlsprismatch->uddagnr==5 && xlsprismatch->dgvarighed<5) {
		weekendmatch++;
		julian = m036_funktion(12, ws_fradato);
		weekendstartdato = m036_funktion(19, julian);
		julian += 3;
		weekendslutdato = m036_funktion(19, julian);
	}
	if (weekendmatch==0 &&
		access("psnyprod",0)==0 &&
		xlsprismatch->uddagnr==6 && xlsprismatch->dgvarighed<5) {
		weekendmatch++;
		julian = m036_funktion(12, ws_fradato);
		julian -= 1;
		weekendstartdato = m036_funktion(19, julian);
		julian += 3;
		weekendslutdato = m036_funktion(19, julian);
	}
	if (weekendmatch==0 &&
		access("psnyprod",0)==0 &&
		xlsprismatch->uddagnr==7 && xlsprismatch->dgvarighed<5) {
		weekendmatch++;
		julian = m036_funktion(12, ws_fradato);
		julian -= 2;
		weekendstartdato = m036_funktion(19, julian);
		julian += 3;
		weekendslutdato = m036_funktion(19, julian);
	}
	if (weekendmatch==1 &&
		access("psnyprod",0)==0) {
		sprintf(tmpstr,"PS%5.5hd%5.5hdSTD.main",
			ws_station,
			(short int)832 + xlsbiltypekode);
		xlsmainflag = xlspris_udpakmain(tmpstr);
	}
	if (weekendmatch==1 &&
		access("psnyprod",0)==0 &&
		xlsmainflag>0) {
		weekendstarttid = xlsprismain->udtid;
		if (ws_fratid>xlsprismain->udtid) {
			weekendstarttid = ws_fratid;
		}
		weekendvarighed = (int)xlsprismain->varighed_ival[0];
	}

/* NYT 141022 */
	returdato = m036_funktion(11, ws_systemdato);
	if (weekendmatch==1 && returdato%10==7) { weekendmatch = 0; }
	if (weekendmatch==1 && returdato%10==6) { weekendmatch = 0; }
	if (weekendmatch==1 && returdato%10==5 && ws_fratid>=1700) {
		weekendmatch = 0;
	}
/* NYT 150212 FREDAGWEEKENDAABEN */
	wx1 = 1;
	if (weekendmatch==1 && weekendstartdato>0 && weekendstarttid>0) {
		wx1 = check_bssaaben(-1,
			ws_station,
			weekendstartdato,
			weekendstarttid);
	}
	if (wx1<=0) { weekendmatch = 0; }

	if (logfil) {
		fprintf(logfil,"\tweekendmatch-01=%d\n",weekendmatch);
		fprintf(logfil,"\twx1=%d\n",wx1);
		fprintf(logfil,"\txlsmainflag=%d\n",xlsmainflag);
		fprintf(logfil,"\tweekendstartdato=%ld\n",weekendstartdato);
		fprintf(logfil,"\tweekendstarttid=%ld\n",weekendstarttid);
		fprintf(logfil,"\tweekendslutdato=%ld\n",weekendslutdato);
		fprintf(logfil,"\tweekendvarighed=%ld\n",weekendvarighed);
	}
	if (access("psweekaltok",0)==0 &&
		access("psglprod",0)==0 &&
		weekendmatch>0) {
		xlsprismatch->uddagnr = 5;
		xlsprismatch->dgvarighed = 3;
		xlsprismatch->specnr = 801;
		xlsprismatch->uddato = 0;
		xlsprismatch->inddato = 0;
		xlsprismatch->udtid = 0;
		xlsprismatch->indtid = 0;
		igenflag++;
		goto igen00;
	}
	if (access("psweekaltok",0)==0 &&
		access("psnyprod",0)==0 &&
		xlsbiltypekode>=0 &&
		weekendmatch>0) {
		xlsprismatch->uddagnr = 5;
		xlsprismatch->dgvarighed = 3;
		xlsprismatch->specnr = 832 + xlsbiltypekode;
		xlsprismatch->uddato = 0;
		xlsprismatch->inddato = 0;
		xlsprismatch->udtid = 0;
		xlsprismatch->indtid = 0;
		igenflag++;
		goto igen00;
	}
	if (logfil) {
		fprintf(logfil,"\tws_xlsprodmatchidx=%d\n",ws_xlsprodmatchidx);
	}
	idx = 0;
	while (logfil && idx<=ws_xlsprodmatchidx) {
		fprintf(logfil,"\t\tws_xlsprodmatchtabel-%d=%d\n",
			idx,
			ws_xlsprodmatchtabel[idx]);
		fprintf(logfil,"\t\tws_xlsprodmatchsorting-%d=%d\n",
			idx,
			ws_xlsprodmatchsorting[idx]);
		fprintf(logfil,"\t\tws_xlsprodmatchindtidtabel-%d=%ld\n",
			idx,
			ws_xlsprodmatchindtidtabel[idx]);
		fprintf(logfil,"\t\tws_xlsprodmatchtidopltabel-%d=%s\n",
			idx,
			ws_xlsprodmatchtidopl[idx]);
		idx++;
	}
afslut:	
/* NYT 150216 PSPAASKE SORTERING */
	blackoutantal = 0;
	idx = ws_xlsprodmatchidx;
	while (idx>0) {
		for (wx1=1;wx1<=idx;wx1++) {
			if (ws_xlsprodmatchsorting[wx1]<
				ws_xlsprodmatchsorting[wx1-1]) {
			ws_xlsprodmatchtabel[MAXXLSPRODMATCH-1] =
				ws_xlsprodmatchtabel[wx1];
			ws_xlsprodmatchsorting[MAXXLSPRODMATCH-1] =
				ws_xlsprodmatchsorting[wx1];
			ws_xlsprodmatchindtidtabel[MAXXLSPRODMATCH-1] = 
				ws_xlsprodmatchindtidtabel[wx1];
			strcpy(ws_xlsprodmatchtidopl[MAXXLSPRODMATCH-1],
				ws_xlsprodmatchtidopl[wx1]);

			ws_xlsprodmatchtabel[wx1] =
				ws_xlsprodmatchtabel[wx1-1];
			ws_xlsprodmatchsorting[wx1] =
				ws_xlsprodmatchsorting[wx1-1];
			ws_xlsprodmatchindtidtabel[wx1] = 
				ws_xlsprodmatchindtidtabel[wx1-1];
			strcpy(ws_xlsprodmatchtidopl[wx1],
				ws_xlsprodmatchtidopl[wx1-1]);
			if (ws_xlsprodmatchsorting[MAXXLSPRODMATCH-1]==0) {
				blackoutantal++;
				ws_xlsprodmatchtabel[wx1] = 0;
				ws_xlsprodmatchsorting[wx1] = 0;
				ws_xlsprodmatchindtidtabel[wx1] = 0;
				strcpy(ws_xlsprodmatchtidopl[wx1],"");
			}
			ws_xlsprodmatchtabel[wx1-1] =
				ws_xlsprodmatchtabel[MAXXLSPRODMATCH-1];
			ws_xlsprodmatchsorting[wx1-1] =
				ws_xlsprodmatchsorting[MAXXLSPRODMATCH-1];
			ws_xlsprodmatchindtidtabel[wx1-1] = 
				ws_xlsprodmatchindtidtabel[MAXXLSPRODMATCH-1];
			strcpy(ws_xlsprodmatchtidopl[wx1-1],
				ws_xlsprodmatchtidopl[MAXXLSPRODMATCH-1]);
			ws_xlsprodmatchtabel[MAXXLSPRODMATCH-1] = 0;
			ws_xlsprodmatchsorting[MAXXLSPRODMATCH-1] = 0;
			ws_xlsprodmatchindtidtabel[MAXXLSPRODMATCH-1] = 0;
			strcpy(ws_xlsprodmatchtidopl[MAXXLSPRODMATCH-1],"");

			}
/* NYT 150306 BLACKOUTJUSTERING */
			if (ws_xlsprodmatchsorting[wx1]>=
				ws_xlsprodmatchsorting[wx1-1] &&
				ws_xlsprodmatchsorting[wx1-1]==0 &&
				blackoutantal==0) {
				blackoutantal++;
				ws_xlsprodmatchtabel[wx1] = 0;
				ws_xlsprodmatchsorting[wx1] = 0;
				ws_xlsprodmatchindtidtabel[wx1] = 0;
				strcpy(ws_xlsprodmatchtidopl[wx1],"");
			}
		}
		idx--;
	}
	ws_xlsprodmatchidx -= blackoutantal;
	retur -= blackoutantal;
	if (logfil) {
		fprintf(logfil,"\tblackoutantal=%d\n",blackoutantal);
		fprintf(logfil,"\tws_xlsprodmatchidx=%d\n",ws_xlsprodmatchidx);
		fprintf(logfil,"dan_xlsprodmatchtabel retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************************ */
static int check_ecxlsmainprodukt_grptab() {
	int retur = 0;
	int wx1 = 0;
	int maingrpidx = 0;
	int starttypeidx = -1;
	int sluttypeidx = -1;
	char tmptype[11] = "";
	char tmpgrp[11] = "";

	wx1 = 0;
	maingrpidx = 0;
	starttypeidx = 0;
	sluttypeidx = ws_grpidx;
	while (retur==0 &&
		starttypeidx>-1 && sluttypeidx>-1 &&
		maingrpidx<100) {
		if (!strlen(xlsprismain->gruppetabel[maingrpidx])) {
			break;
		}
		for (wx1=starttypeidx;wx1<=sluttypeidx;wx1++) {
			sscanf(ws_grptab[wx1],"%s %s",tmptype,tmpgrp);
			if (strcmp(tmpgrp,
				xlsprismain->gruppetabel[maingrpidx])==0) {
				retur = 1;
			}
		}			
		maingrpidx++;
	}
	return(retur);
}

/* ************************************************************ */
static int check_xlsmainprodukt_bilgrp() {
	int retur = 0;
	int wx1 = 0;
	int maingrpidx = 0;
	int starttypeidx = -1;
	int sluttypeidx = -1;
	char tmpgrp[11] = "";

	wx1 = 0;
	while (wx1<ws_grpidx && strlen(ws_biltype) && !strlen(ws_grp)) {
		if (strncmp(ws_grptab[wx1]+2,ws_biltype,3)==0 &&
			starttypeidx==-1) {
			starttypeidx = wx1;
			sluttypeidx = wx1;
		}
		if (strlen(ws_biltype) &&
			strncmp(ws_grptab[wx1]+2,ws_biltype,3)==0) {
			sluttypeidx = wx1;
		}
		wx1++;
	}
	maingrpidx = 0;
	while (retur==0 && strlen(ws_biltype) && 
		starttypeidx>-1 && sluttypeidx>-1 &&
		maingrpidx<100) {
		for (wx1=starttypeidx;wx1<=sluttypeidx;wx1++) {
			strcpy(tmpgrp,ws_grptab[wx1]+8);
			if (strcmp(tmpgrp,
				xlsprismain->gruppetabel[maingrpidx])==0) {
				retur = 1;
			}
		}			
		maingrpidx++;
	}
	maingrpidx = 0;
	while (retur==0 && strlen(ws_grp) && maingrpidx<100) {
		if (strlen(xlsprismain->gruppetabel[maingrpidx])>0 &&
			strcmp(ws_grp,
				xlsprismain->gruppetabel[maingrpidx])==0) {
			retur = 1;
		}
		maingrpidx++;
	}
afslut:
	return(retur);
}

/* ************************************************************ */
static int add_psbetalinginfo(int inpfunk,char *inpprodkode,long prodvar) {
	int retur = 0;
	char tmpstr[201] = "";
	char tmpstr2[81] = "";
	char tmpstr3[81] = "";
	double dep_kontant = 3000;
	double dep_kort = 2000;
	double dep_online = 1000;

	if (logfil) {
		fprintf(logfil,"add_psbetalinginfo %d %s %ld\n",
			inpfunk,
			inpprodkode,
			prodvar);
		fprintf(logfil,"\ttotal=%lf\n",r159->total);
		fprintf(logfil,"\tpai_ialt=%lf\n",r159->pai_ialt);
	}

	if (inpfunk==2) { goto styrfunk2; }
/*pris */
	ege_w_dou1 = r159->total;
/*	ege_w_dou1 -= r159->pai_ialt; */
/*	pack_doub(ege_w_dou1); */
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
	retur++;

	pack_int2((long)1);
	retur++;
/*DepAfhKontant */
	ege_w_dou1 = dep_kontant;
/*	pack_doub(ege_w_dou1); */
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
	retur++;

	pack_int2((long)1);
	retur++;
/*DepAfhKort */
	ege_w_dou1 = dep_kort;
/*	pack_doub(ege_w_dou1); */
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
	retur++;

	pack_int2((long)1);
	retur++;
/*DepOnline */
	ege_w_dou1 = dep_online;
/*	pack_doub(ege_w_dou1); */
	xls_char(tmpstr,(double)ege_w_dou1,2);
	pack_alfa(tmpstr);
	retur++;

styrfunk2:

/* NYT 131218 DepositumBeskrivelse DEPTXT */
	ege_w_dou1 = dep_kontant;
	xls_char(tmpstr2,(double)ege_w_dou1,2);
	sprintf(tmpstr,"Afhængig af betalingsmetoden vil der blive opkrævet følgende depositum: Ved kontant(afhentning) DKK %s.",tmpstr2);
	ege_w_dou1 = dep_kort;
	xls_char(tmpstr2,(double)ege_w_dou1,2);
	sprintf(tmpstr3," Ved kort(afhentning) DKK %s.",tmpstr2);
	strcat(tmpstr,tmpstr3);
	ege_w_dou1 = dep_online;
	xls_char(tmpstr2,(double)ege_w_dou1,2);
	sprintf(tmpstr3," Ved online betaling DKK %s.",tmpstr2);
	strcat(tmpstr,tmpstr3);
	pack_alfa(tmpstr);
	retur++;
	if (inpfunk==1) { goto afslut; }

styrfunk2videre:
	pack_int2((long)1);
	retur++;
	pack_int2((long)1);
	retur++;
	pack_int2((long)1);
	retur++;
	goto afslut;

	if (logfil) {
		fprintf(logfil,"\tHERTIL\n");
	}
afslut:
	if (logfil) {
		fprintf(logfil,"add_psbetalinginfo retur=%d\n",
			retur);
	}
	return(retur);
}

/* ************************************************ */
static int check_don2_weekendok(short inpspec,long inpfradt,long inptildt,short inpafhfra,short inpdgvar,char *inpdgstr,char *returdtstr) {
	int retur = 0;
	int funkretur = 0;
	int funkretur2 = 0;
	int okflag = 0;
	int antal = 0;
	long int julian = 0;
	long int returdato = 0;
	long int returaud = 0;
	long int nuvdato = 0;
	char stdgstr[41] = "";

	strcpy(returdtstr,"");
        if (logfil) {
                fprintf(logfil,
			"check_don2_weekendok:%hd %ld %ld %hd %hd <%s>\n",
			inpspec,
                        inpfradt,
			inptildt,
			inpafhfra,
			inpdgvar,
			inpdgstr);
	}
	strcpy(stdgstr,inpdgstr);
	returaud = m036_funktion(11, inpfradt);
	returaud %= 10;
        if (logfil) {
                fprintf(logfil, "\treturaud=%ld\n",
			returaud);
	}
	okflag = 0;
	if (returaud>=5 && returaud<=7) { okflag = 1; }
        if (logfil) {
                fprintf(logfil, "\tokflag=%d\n",
			okflag);
	}
	if (okflag<1) { goto afslut; }
	julian = m036_funktion(12, inpfradt);
	returdato = m036_funktion(12, inptildt);
	returdato -= julian;
        if (logfil) {
                fprintf(logfil, "\treturdato=%ld\n",
			returdato);
	}
	if (returdato>=7) { goto afslut; }
	antal = 6;
	julian = m036_funktion(12, inptildt);
	while (okflag>0 && antal>0) {
		nuvdato = m036_funktion(19, julian);
		returaud = m036_funktion(11, nuvdato);
		returaud %= 10;
		funkretur2 = check_stdgstr((long int)inpspec,
			(long int)nuvdato,
			(long int)returaud,
			stdgstr);
        	if (logfil) {
			fprintf(logfil, "\t\tantal=%d\n",
				antal);
			fprintf(logfil, "\t\tnuvdato=%ld\n",
				nuvdato);
			fprintf(logfil, "\t\treturaud=%ld\n",
				returaud);
			fprintf(logfil, "\t\tfunkretur2=%d\n",
				funkretur2);
		}
		if (funkretur2<=0) {
			julian--;
			antal--;
			continue;
		}
		funkretur = check_bssaaben(-1,ws_station,nuvdato,inpafhfra);
/*
			funkretur = check_bssaaben(-1,
				ws_station,nuvdato,-1);
*/
        	if (logfil) {
			fprintf(logfil, "\t\tfunkretur=%d\n",
				funkretur);
		}
		if (funkretur<=0) {
			okflag = 0;
		}
		break;
	}
	if (okflag>0) {
		julian += (long int)inpdgvar;
		returdato = m036_funktion(19, julian);
		sprintf(returdtstr,"%8.8ld %8.8ld",nuvdato,returdato);
		retur = 1;
	}
afslut:
	if (logfil) {
		fprintf(logfil, "check_don2_weekendok:retur=%d <%s>\n",
			retur,
			returdtstr);
	}
	return(retur);
}

/* *************************************** */
static int tilbud_paa_vej(short stnr,long fradt,long tildt,long antaldg) {
	short int retur = 0;
	short int type = 0;

	if (stnr==56) {
		return(0);
	}
	if (stnr==57) {
		return(0);
	}
	if (fradt>=20081223 && fradt<20090201) {
		type = 1;
		retur++;
	}
	if (tildt>=20081223 && tildt<20090201) {
		type = 1;
		retur++;
	}
	if (retur>0) {
		f166_start(1,ISGTEQ);
		r166->stat_nr = stnr;
		egeread(f166,ISEQUAL);
		
		alfalow(str);
		pack_init(str);
		pack_int2((long)-319);
/*
		web_errormess(0,ws_langstr,"319");
*/
		sprintf(dum_str,"Juletilbud på vej. Kontakt %s for mere info.",
			r166->tlf);
		pack_alfa(dum_str);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil,"SENDT:%s",str);
		}
	}
	if (logfil)  {
		fprintf(logfil,"tilbud_paa_vej:retur=%hd\n",retur);
	}
	return(retur);
}

/* *********************************** */
static int check_alfa_str(short funk,char *listestr,char *chkstr,short sktgn) {
	short int wx1 = 0;
	short int funkretur = 0;
	short int retur = 0;
	char fundetstr[41] = "";

	if (logfil) {
		fprintf(logfil,"check_alfa_str:listestr=%s\n",listestr);
		fprintf(logfil,"check_alfa_str:chkstr=%s\n",chkstr);
	}
	wx1 = 0;
	while (wx1<10 && retur==0) {
               	funkretur = get_alfa_tgn(listestr,wx1,fundetstr,sktgn);
		if (funkretur<=0) {
			break;
		}
		if (strcmp(fundetstr,chkstr)==0) {
			retur = 1;
		}
		wx1++;
	}
	if (logfil) {
		fprintf(logfil,"check_alfa_str:retur=%hd\n", retur);
	}
	return(retur);
}

/* *********************************** */
static int check_stdgstr(specnr,fradato,fradagnr,tmpstr)
long int specnr;
long int fradato;
long int fradagnr;
char * tmpstr; {
	short int retur = 1;
	short int wx1 = 0;
	short int spcdgnrflag = 0;
	long int spcdgnrfra = 0;
	long int spcdgnrtil = 0;
	long int spcdgnrtab[8] = {1,1,1,1,1,1,1,1};
	long int returdato = 0;
	char intstr[7][41] = {"","","","","","",""};

        if (logfil) {
                fprintf(logfil, "\tcheck_stdgstr:specnr=%ld\n",
                        specnr);
                fprintf(logfil, "\tcheck_stdgstr:fradato=%ld\n",
                        fradato);
                fprintf(logfil, "\tcheck_stdgstr:fradagnr=%ld\n",
                        fradagnr);
	}
	if (strlen(tmpstr) && spcdgnrflag==0) {
		(void)get_alfa_tgn(tmpstr,1,intstr[1],',');
		if (strlen(intstr[1])) {
			spcdgnrflag = 2;
		}
	}
	if (strlen(tmpstr) && spcdgnrflag==0) {
		(void)get_alfa_tgn(tmpstr,1,intstr[1],'-');
		if (strlen(intstr[1])) {
			spcdgnrflag = 1;
		}
	}
/* X,Y,Z... */
	if (strlen(tmpstr) && spcdgnrflag==2) {
		spcdgnrtab[0] = 0;
		spcdgnrtab[1] = 0;
		spcdgnrtab[2] = 0;
		spcdgnrtab[3] = 0;
		spcdgnrtab[4] = 0;
		spcdgnrtab[5] = 0;
		spcdgnrtab[6] = 0;
		spcdgnrtab[7] = 0;
		(void)get_alfa_tgn(tmpstr,0,intstr[0],',');
		(void)get_alfa_tgn(tmpstr,2,intstr[2],',');
		(void)get_alfa_tgn(tmpstr,3,intstr[3],',');
		(void)get_alfa_tgn(tmpstr,4,intstr[4],',');
		(void)get_alfa_tgn(tmpstr,5,intstr[5],',');
		(void)get_alfa_tgn(tmpstr,6,intstr[6],',');
	}
	wx1 = 0;
	if (strlen(tmpstr) && spcdgnrflag==2 && strlen(intstr[wx1])) {
		sscanf(intstr[wx1], "%ld", &returdato);
		if (returdato>0 && returdato<8) {
			spcdgnrtab[returdato] = 1;
		}
	}
	wx1++;
	if (strlen(tmpstr) && spcdgnrflag==2 && strlen(intstr[wx1])) {
		sscanf(intstr[wx1], "%ld", &returdato);
		if (returdato>0 && returdato<8) {
			spcdgnrtab[returdato] = 1;
		}
	}
	wx1++;
	if (strlen(tmpstr) && spcdgnrflag==2 && strlen(intstr[wx1])) {
		sscanf(intstr[wx1], "%ld", &returdato);
		if (returdato>0 && returdato<8) {
			spcdgnrtab[returdato] = 1;
		}
	}
	wx1++;
	if (strlen(tmpstr) && spcdgnrflag==2 && strlen(intstr[wx1])) {
		sscanf(intstr[wx1], "%ld", &returdato);
		if (returdato>0 && returdato<8) {
			spcdgnrtab[returdato] = 1;
		}
	}
	wx1++;
	if (strlen(tmpstr) && spcdgnrflag==2 && strlen(intstr[wx1])) {
		sscanf(intstr[wx1], "%ld", &returdato);
		if (returdato>0 && returdato<8) {
			spcdgnrtab[returdato] = 1;
		}
	}
	wx1++;
	if (strlen(tmpstr) && spcdgnrflag==2 && strlen(intstr[wx1])) {
		sscanf(intstr[wx1], "%ld", &returdato);
		if (returdato>0 && returdato<8) {
			spcdgnrtab[returdato] = 1;
		}
	}
	wx1++;
	if (strlen(tmpstr) && spcdgnrflag==2 && strlen(intstr[wx1])) {
		sscanf(intstr[wx1], "%ld", &returdato);
		if (returdato>0 && returdato<8) {
			spcdgnrtab[returdato] = 1;
		}
	}
/* X-Y */
	if (strlen(tmpstr) && spcdgnrflag==1) {
		(void)get_alfa_tgn(tmpstr,0,intstr[0],'-');
	}
	if (strlen(tmpstr) && spcdgnrflag==1 && strlen(intstr[0])) {
		sscanf(intstr[0], "%ld", &spcdgnrfra);
		spcdgnrtil = spcdgnrfra;
	}
	if (strlen(tmpstr) && spcdgnrflag==1 && strlen(intstr[1])) {
		sscanf(intstr[1], "%ld", &spcdgnrtil);
	}
/* X */
	if (strlen(tmpstr) && spcdgnrflag==0) {
		sscanf(tmpstr, "%ld", &spcdgnrfra);
		spcdgnrtil = spcdgnrfra;
	}

	if (logfil) {
		fprintf(logfil, "\tcheck_stdgstr:spcdgnrfra-til=%ld-%ld\n",
			spcdgnrfra,
			spcdgnrtil);
		fprintf(logfil,
		"\tcheck_stdgstr:spcdgnrtab=%ld,%ld,%ld,%ld,%ld,%ld,%ld\n",
			spcdgnrtab[1],
			spcdgnrtab[2],
			spcdgnrtab[3],
			spcdgnrtab[4],
			spcdgnrtab[5],
			spcdgnrtab[6],
			spcdgnrtab[7]);
		fflush(logfil);
	}




	if (spcdgnrfra>=1 &&
		spcdgnrfra<=7 &&
		spcdgnrtil>=1 &&
		spcdgnrtil<=7 &&
		(fradagnr<spcdgnrfra||fradagnr>spcdgnrtil)) {
		retur = 0;
	}
	if (spcdgnrfra==0 &&
		spcdgnrtil==0 &&
		spcdgnrtab[fradagnr]==0) {
		retur = 0;
	}

	if (logfil) {
		fprintf(logfil, "\tcheck_stdgstr:retur=%hd\n",
			retur);
	}
	return(retur);
}

/* **************************************************** */
/* funk 1 == antaldage					*/
/* funk 2 <= antaldage					*/
static int find_tillaeg_antal(funk,antaldage,prisdage,tillmin,tillmax)
short int funk;
long int antaldage;
long int prisdage;
long int tillmin;
long int tillmax; {
	short int retur = 0;
	long int nuvantal = 0;

	nuvantal = tillmin;
	while (retur==0 && nuvantal<=tillmax) {
		if (funk==1 && prisdage+nuvantal==antaldage) {
			retur = (short int)nuvantal;
		}
		if (funk==2 && prisdage+nuvantal<=antaldage) {
			retur = (short int)nuvantal;
		}
		nuvantal++;
	}
	return(retur);
}

/* ************************************************** */
static int chksend_prod(st,grp,lang,fradt,var,spc,spcvar,afh,afl,txt,tspc,tant,tildt,fvar)
short int st;
char * grp;
char * lang;
long int fradt;
long int var;
short int spc;
long int spcvar;
short int afh;
short int afl;
char * txt;
short int tspc;
short int tant;
long int tildt;
short int fvar; {
	short int dondafolo = 0;
	short int donleasing = 0;
	short int funkretur = 0;
	short int blokfundet = 0;
	short int afhflag = 0;
	short int stationafhtiltid = 0;
	short int stationaflfratid = 0;
	long int lejedage = 0;
	long int julian = 0;
	long int returdato = 0;
	long int snyddato = 0;
	long int keynum = 0;
	long int keynumv = 0;
	double depositum = 0;
	double dep_online = 0;
	double dep_kontant = 0;
	double dep_kredit = 0;
	char transstr[81] = "";
	char vdkstr[81] = "";
	char tmpstr[301] = "";
	char tillspcstr[81] = "";
	char tillantstr[5] = "";
	char tmpgrpliste[81] = "";
	char tmpbloknavn[41] = "";
	char prodfilnavn[41] = "";
	FILE * prodfil;

	prodfil = (FILE*)0;
/* NYT 070209 */
	if (ws_funktion==210) {
		dondafolo = 1;
	}
/* NYT 070326 */
	if (ws_funktion==3) {
		dondafolo = 1;
	}
/* NYT 130524 */
	if (ws_funktion==22) {
		dondafolo = 1;
	}
	if (logfil) {
		fprintf(logfil,
		"chksend_prod:spc=%hd,dondafolo=%hd,ws_prodlisteantal=%hd\n",
			spc,
			dondafolo,
			ws_prodlisteantal);
		fprintf(logfil,
		"chksend_prod:ws_prodsortflag=%hd (%s)\n",
			ws_prodsortflag,
			PRODSORTTP);
		fprintf(logfil,
		"chksend_prod:ws_mbidrag=%lf\n", ws_mbidrag);
		fprintf(logfil,
		"chksend_prod:ws_prodsortidx=%hd\n", ws_prodsortidx);
		fprintf(logfil,
		"chksend_prod:ws_donsaesonflag=%hd\n", ws_donsaesonflag);
		fprintf(logfil,
		"chksend_prod:fradt=%ld,tildt=%ld,var=%ld\n",fradt,tildt,var);
		fprintf(logfil,
		"chksend_prod:ws_kundedtfra-til=%ld-%ld\n",
			ws_kundedtfra,ws_kundedttil);
		fprintf(logfil,
		"chksend_prod:ws_fradato-til=%ld-%ld\n",
			ws_fradato,ws_tildato);
		fprintf(logfil,
		"chksend_prod:spc=%hd,spcvar=%ld\n",
			spc,spcvar);
		fprintf(logfil,
		"chksend_prod:afh=%hd,afl=%hd\n",
			afh,afl);
		fprintf(logfil,
		"chksend_prod:tspc=%hd,tant=%hd\n",
			tspc,tant);
		fprintf(logfil,
		"chksend_prod:fvar=%hd\n",
			fvar);
		fprintf(logfil,
		"chksend_prod:lang=%s\n", lang);
		fflush(logfil);
	}
/* NYT 110921 PRODIKKERELEVANT */
	funkretur = 1;
	if (ws_kundedtfra!=ws_kundedttil &&
		fradt>=ws_kundedttil) {
		funkretur = 0;
	}
/* TEST 141007 */
	if (logfil) {
		fprintf(logfil,"\t\tPRODIKKERELEVANT-1 funkretur=%hd\n",
			funkretur);
	}
	julian = m036_funktion(12, fradt);
	returdato = m036_funktion(12, ws_kundedtfra);
	if (ws_kundedtfra!=ws_kundedttil &&
		julian-returdato>=2) {
		funkretur = 0;
	}
/* TEST 141007 */
	if (logfil) {
		fprintf(logfil,"\t\tPRODIKKERELEVANT-2 funkretur=%hd\n",
			funkretur);
	}
/* NYT 111021 */
	if (ws_kundedtfra!=fradt) {
		funkretur = 0;
	}
/* TEST 141007 */
	if (logfil) {
		fprintf(logfil,"\t\tPRODIKKERELEVANT-3 funkretur=%hd\n",
			funkretur);
	}
	if (ws_kundedttil!=tildt) {
		funkretur = 0;
	}
/* TEST 141007 */
	if (logfil) {
		fprintf(logfil,"\t\tPRODIKKERELEVANT-4 funkretur=%hd\n",
			funkretur);
	}
	if (ws_kundedtfra!=ws_fradato) {
		funkretur = 0;
	}
/* TEST 141007 */
	if (logfil) {
		fprintf(logfil,"\t\tPRODIKKERELEVANT-5 funkretur=%hd\n",
			funkretur);
	}
	if (ws_kundedttil!=ws_tildato && ws_donsaesonflag<=0) {
/* RETTET 141007 EFTERAAR644
	if (ws_kundedttil!=ws_tildato) {
*/
		funkretur = 0;
	}
/* TEST 141007 */
	if (logfil) {
		fprintf(logfil,"\t\tPRODIKKERELEVANT-6 funkretur=%hd\n",
			funkretur);
	}
	if (fvar!=0) {
		funkretur = 0;
	}
/* TEST 141007 */
	if (logfil) {
		fprintf(logfil,"\t\tPRODIKKERELEVANT-7 funkretur=%hd\n",
			funkretur);
	}

/* WEEKSPEC */
	if (funkretur==0 && spc==196 && fvar==-1) {
		funkretur = 1;
	}
	if (funkretur==0 && spc==198 && fvar==-1) {
		funkretur = 1;
	}
/* 130123 6DAGE */
	if (funkretur==0 && spc==666 && fvar==0 &&
		ws_kundedtfra==fradt && ws_kundedttil==tildt) {
		funkretur = 1;
	}
/* 131227 JUL2013 */
	if (funkretur==0 && spc==650 && fvar==0 &&
		ws_kundedtfra==fradt && ws_kundedttil==tildt) {
		funkretur = 1;
	}
/* 140207 PAASKE2014 */
	if (funkretur==0 && spc==645 && fvar==0 &&
		ws_kundedtfra==fradt && ws_kundedttil==tildt) {
		funkretur = 1;
	}
	if (funkretur==0 && spc==647 && fvar==0 &&
		ws_kundedtfra==fradt && ws_kundedttil==tildt) {
		funkretur = 1;
	}
	if (funkretur==0 && spc==648 && fvar==0 &&
		ws_kundedtfra==fradt && ws_kundedttil==tildt) {
		funkretur = 1;
	}
	if (funkretur==0 && spc==649 && fvar==0 &&
		ws_kundedtfra==fradt && ws_kundedttil==tildt) {
		funkretur = 1;
	}

	if (logfil) {
		fprintf(logfil,
	"\tchksend_prod:PRODIKKERELEVANT funkretur=%hd k%ld-%ld %ld-%ld\n",
			funkretur,
			ws_kundedtfra,
			ws_kundedttil,
			fradt,
			tildt);
	}
	if (funkretur<=0) {
		return(0);
	}

/* AABEN */
	funkretur = check_bssaaben(-1,st,fradt,-1);
	if (logfil) {
		fprintf(logfil,
		"\tchksend_prod:CHECK_BSSAABEN %ld:funkretur=%hd ws_alert_txt=%s\n",
			fradt,
			funkretur,
			ws_alert_txt);
	}
/* NYT 130524 OBSDON2KAMPAGNE */
	if (funkretur==0 && st==66 && fradt==20131222 && ws_stepnr>=3) {
		funkretur = 1;
		stationafhtiltid = 1200;
	}

	if (funkretur<=0) {
		return(0);
	}
	if (strlen(ws_alert_txt)) {
               	(void)get_alfa_tgn(ws_alert_txt,1,tmpstr,';');
               	if (strlen(tmpstr)) {
			sscanf(tmpstr, "%hd", &stationafhtiltid);
		}
	}
	if (logfil) {
		fprintf(logfil,
			"\tchksend_prod:stationafhtiltid=%hd,afh=%hd\n",
			stationafhtiltid,
			afh);
	}
	if (afh>=stationafhtiltid) {
		return(0);
	}
/* NYT 050420 */
	afhflag = 0;
	if (afhflag==0 && stationafhtiltid>0 && stationafhtiltid%100==0) {
		stationafhtiltid -= 100;
		stationafhtiltid += AFHLUKSLIP;
		afhflag++;
	}
	if (afhflag==0 && stationafhtiltid>0 && stationafhtiltid%100==30) {
		stationafhtiltid -= AFHLUKSLIP;
		afhflag++;
	}

	if (logfil) {
		fprintf(logfil,
			"\tchksend_prod:NY stationafhtiltid=%hd\n",
			stationafhtiltid);
	}

	julian = m036_funktion(12, fradt);
	if (logfil) {
		fprintf(logfil,
			"\tchksend_prod:fradt=%ld,julian=%ld\n",fradt,julian);
	}
	julian += (long int)spcvar;
	if (logfil) {
		fprintf(logfil,
			"\tchksend_prod:fradt=%ld,julian=%ld\n",fradt,julian);
	}
	julian += (long int)tant;
/* NYT 130123 FYRAFTENEXTRA */
	if (tspc==181) { julian += 1; }
	if (tspc==182) { julian += 2; }
	if (tspc==183) { julian += 3; }
	if (tspc==184) { julian += 4; }
	if (tspc==666) { julian += 5; }

	if (logfil) {
		fprintf(logfil,
			"\tchksend_prod:fradt=%ld,julian=%ld\n",fradt,julian);
	}
	returdato = m036_funktion(19, julian);
	if (var>20000000) {
		returdato = var;
	}
/* NYT 060323 CHECK BLOKERING 16625 */
	lejedage = (long int)spcvar;
	lejedage += (long int)tant;
/* NYT 130123 FYRAFTENEXTRA */
	if (tspc==181) { lejedage += 1; }
	if (tspc==182) { lejedage += 2; }
	if (tspc==183) { lejedage += 3; }
	if (tspc==184) { lejedage += 4; }
	if (tspc==666) { lejedage += 5; }
	if (logfil) {
		fprintf(logfil,
			"\tchksend_prod:returdato=%ld\n",
			returdato);
		fprintf(logfil,
			"\tchksend_prod:lejedage=%ld\n",
			lejedage);
	}

	blokfundet = 0;
	funkretur = check_f198_dato(1,16625,(double)st,"",fradt,returdato);
	if (funkretur>0) {
		if (logfil) {
			fprintf(logfil,
			"chksend_prod:16625FUNDET\n");
			fprintf(logfil,
			"chksend_prod:num=%.0lf,alfa=%s\n",
			r198->numfelt,
			r198->alfafelt);
			fprintf(logfil,
			"chksend_prod:lejedage=%ld\n",
			lejedage);
		}
	}
	if (funkretur>0) {
		(void)get_alfa_tgn(r198->alfafelt,0,tmpgrpliste,';');
		(void)get_alfa_tgn(r198->alfafelt,1,tmpbloknavn,';');
	}
	if (funkretur>0 && strcmp(tmpgrpliste,"*")==0) {
		blokfundet = 1;
	}
	if (funkretur>0 &&
		blokfundet==0 &&
		strlen(tmpgrpliste) &&
		check_alfa_str(1,tmpgrpliste,grp,44)>0) {
		blokfundet = 1;
	}
/* NYT 091030 JUL09 */
	if (funkretur>0 && 
		blokfundet>0 &&
		strcmp(tmpbloknavn,"jul")==0 &&
		r198->numfelt<=0) {
		blokfundet = 0;
	}

/* TEST */
	if (logfil) {
		fprintf(logfil,
			"chksend_prod:blokfundet=%hd\n",blokfundet);
	}
	if (funkretur>0 &&
		blokfundet==1 &&
		r198->numfelt==0) {
		return(0);
	}
	if (funkretur>0 &&
		blokfundet==1 &&
		r198->numfelt>0 &&
		lejedage<(long int)r198->numfelt) {
		return(0);
	}

	funkretur = check_bssaaben(-1,st,returdato,-1);
	if (logfil) {
		fprintf(logfil,
		"\tchksend_prod:CHECK_BSSAABEN %ld:funkretur=%hd\n",
		returdato,
		funkretur);
	}
	if (funkretur<=0) {
		return(0);
	}
	if (strlen(ws_alert_txt)) {
               	(void)get_alfa_tgn(ws_alert_txt,0,tmpstr,';');
               	if (strlen(tmpstr)) {
			sscanf(tmpstr, "%hd", &stationaflfratid);
		}
	}
	strcpy(ws_extspcstr,"");
	if (tspc>0 && tant>0) {
		sprintf(ws_extspcstr, "%hdx%hd",
			tspc,
			tant);
	}
	funkretur = check_ressourcer(CHKRESFUNK,
		st,
		grp,
		spc,
		ws_extspcstr,
		fradt,
		0);
	if (logfil) {
		fprintf(logfil,
		"\tchksend_prod:CHECK_RESSOURCER:funkretur=%hd\n",
			funkretur);
		fprintf(logfil,
		"\tchksend_prod:CHECK_RESSOURCER:CHKRESMINIMUM=%hd\n",
			CHKRESMINIMUM);
	}
/* NYT 081009 */
	if (funkretur<=CHKRESMINIMUM) {
		return(0);
	}
	if (logfil) {
		fprintf(logfil,
			"\tchksend_prod:lejedage=%ld\n",
			lejedage);
	}
	ws_fradato = fradt;
	ws_fratid = afh;
	ws_specnr = spc;
/* NYT 050222 PAI */
	ws_paiflag = 1;
	(void)log_stopur(60);
	funkretur = nyopret_reservation(0,0,0);
	(void)log_stopur(60);
	if (logfil) {
		fprintf(logfil,
			"\tchksend_prod:NYOPRET_RESERVATION:funkretur=%hd\n",
			funkretur);
	}
	if (funkretur<=0) {
		return(0);
	}
/* NYT 050912 SNYD DATO LEASING */
/*
	if (spc==199 || spc==656) {
		snyddato = tildt;
	}
*/
/* DON2OBS
	if (dondafolo>0 && ws_prodlisteantal==0 && ws_prodsortflag==0) {
		alfalow(str);
		pack_init(str);
		pack_alfa("HEADER");
		pack_alfa("Der findes følgende produkter");
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil,"SENDT=%s\n",str);
			fflush(logfil);
		}
	}
	if (dondafolo>0 && ws_prodlisteantal==1 && ws_prodsortflag==0) {
		alfalow(str);
		pack_init(str);
		pack_alfa("ALTERNATIVE");
		pack_alfa("Vi har også alternativ(er)");
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil,"SENDT=%s\n",str);
			fflush(logfil);
		}
	}
*/
	alfalow(str);
	pack_init(str);
	if (dondafolo==0) {
		pack_int2((long)spc);
		if (strcmp(lang, "DK")==0 ||
			strcmp(lang,"DA")==0) {
			strcpy(tmpstr,txt);
		} else {
			sprintf(transstr, "%5.5ld%5.5hd",(long int)16507,spc);
			trans_tekst(lang,0,transstr,tmpstr);
		}
		pack_alfa(tmpstr);
		(void)f198_tekst(lang,16501,(double)spc,"",0,tmpstr);
		pack_alfa(tmpstr);
		pack_int2((long)tant);
		pack_int2((long)tspc);
		strcpy(tmpstr,"");
		funkretur = 0;
		if (tspc>0) {
			reclow(r165,R165);
			f165_start(1,ISGTEQ);
			r165->spec_nr = tspc;
			strcpy(r165->bil_grp, grp);
			egeread(f165, ISEQUAL);
			if (f165_ok) {
				funkretur = 1;
			}
		}
		if (tspc>0 && funkretur==0) {
			r165->spec_nr = tspc;
			r165->stat_nr = st;
			strcpy(r165->bil_grp, grp);
			egeread(f165, ISEQUAL);
			if (f165_ok) {
				funkretur = 1;
			}
		}
		if (tspc>0 && funkretur==0) {
			r165->spec_nr = tspc;
			r165->stat_nr = st;
			strcpy(r165->bil_grp, "ALLE");
			egeread(f165, ISEQUAL);
			if (f165_ok) {
				funkretur = 1;
			}
		}
		if (tspc>0 && funkretur==0) {
			r165->spec_nr = tspc;
			r165->stat_nr = 0;
			strcpy(r165->bil_grp, "ALLE");
			egeread(f165, ISEQUAL);
			if (f165_ok) {
				funkretur = 1;
			}
		}
		if (tspc>0 && funkretur==1) {
			if (strcmp(lang, "DK")==0 ||
				strcmp(lang,"DA")==0) {
				strcpy(tmpstr,r165->tekst_1);
			} else {
				sprintf(transstr, "%5.5ld%5.5hd",
					(long int)16507,r165->spec_nr);
				trans_tekst(lang,0,transstr,tmpstr);
			}
		}
		pack_alfa(tmpstr);
		ege_w_dou1 = r159->total;
/* NYT 050222 PAI */
		ege_w_dou1 -= r159->pai_ialt;
		pack_doub(ege_w_dou1);
		pack_int2((long)r159->rate_incl_km[10]);
		pack_doub(r159->rate_ekstra_km[10]);
/* NYT 20050118 */
		sprintf(tmpstr,"%8.8ld%4.4hd",fradt,afh);
		pack_alfa(tmpstr);
		sprintf(tmpstr,"%8.8ld%4.4hd",fradt,stationafhtiltid);
		pack_alfa(tmpstr);
/* NYT 050912 LEASING */
		if (snyddato>0) {
			sprintf(tmpstr,"%8.8ld%4.4hd",
				snyddato,stationaflfratid);
			pack_alfa(tmpstr);
			sprintf(tmpstr,"%8.8ld%4.4hd",
				snyddato,afl);
			pack_alfa(tmpstr);
		} else {
			sprintf(tmpstr,"%8.8ld%4.4hd",
				returdato,stationaflfratid);
			pack_alfa(tmpstr);
			sprintf(tmpstr,"%8.8ld%4.4hd",
				returdato,afl);
			pack_alfa(tmpstr);
		}
/* NYT 050222 PAI */
		ege_w_dou1 = r159->pai_ialt;
		pack_doub(ege_w_dou1);
/* NYT 050228 DEPOSITUM */
		ege_w_dou1 = 0;
		funkretur = 0;
		keynum = (long int)r159->rate_spec_nr[0];
		keynum *= 1000;
		keynum += (long int)r159->station_ud_nr;
		funkretur = find_r198(1,16524,(double)keynum,"",0);
		if (funkretur>0 && r198->numfelt>0) {
			ege_w_dou1 = r198->numfelt;
		}
		pack_doub(ege_w_dou1);

		ege_w_dou1 = 0;
		funkretur = 0;
		funkretur = find_r198(1,16525,(double)keynum,"",0);
		if (funkretur>0 && r198->numfelt>0) {
			ege_w_dou1 = r198->numfelt;
		}
		depositum = ege_w_dou1;
		pack_doub(ege_w_dou1);

		ege_w_dou1 = 0;
		funkretur = 0;
		funkretur = find_r198(1,16523,(double)keynum,"",0);
		if (funkretur>0 && r198->numfelt>0) {
			ege_w_dou1 = r198->numfelt;
		}
		pack_doub(ege_w_dou1);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil,"SENDT=%s\n",str);
			fflush(logfil);
		}
	}
	if (dondafolo==1) {
/* DON2DEPOSITUM */
		dep_online = 0;
		dep_kontant = 0;
		dep_kredit = 0;
		keynum = (long int)r159->rate_spec_nr[0];
		keynum *= (long int)1000;
		keynum += (long int)r159->station_ud_nr;
		ege_w_dou1 = 0;
		funkretur = find_r198(1,16523,(double)keynum,"",0);
		if (funkretur>0 && r198->numfelt>0) {
			ege_w_dou1 = r198->numfelt;
		}
/* NYT 101007 */
		keynumv = 0;
		if (strcmp(grp,"3")==0) {
			keynumv = (long int)r159->rate_spec_nr[0];
			keynumv *= (long int)1000;
			keynumv += (long int)r159->station_ud_nr;
			keynumv *= (long int)100;
			keynumv += (long int)3;
		}
		if (logfil) {
			fprintf(logfil,
				"\t\tchksend_prod:DEPOSITUM:keynum=%ld\n",
				keynum);
			fprintf(logfil,
				"\t\tchksend_prod:DEPOSITUM:keynumv=%ld\n",
				keynumv);
		}
		donleasing = 0;
		if (r159->rate_spec_nr[0]==199) { donleasing = 1; }
		if (r159->rate_spec_nr[0]==656) { donleasing = 1; }
/* NYT 140122 DONLEASING */
		if (r159->rate_spec_nr[0]==658) { donleasing = 1; }
		if (r159->rate_spec_nr[0]==670) { donleasing = 1; }
		if (keynumv>0) {
			funkretur = find_r198(1,16523,(double)keynumv,"",0);
			if (funkretur>0 && r198->numfelt>0) {
				ege_w_dou1 = r198->numfelt;
			}
		}
		dep_online = ege_w_dou1;
		ege_w_dou1 = 0;
/* NYT 071003 KREDITKORT */
		ege_w_dou1 = 2000;
		if (donleasing==1) {
			ege_w_dou1 = dep_online;
		}
/* AKTIVERET 131104 DEPOSITUM */
		funkretur = find_r198(1,16524,(double)keynum,"",0);
		if (funkretur>0 && r198->numfelt>0) {
			ege_w_dou1 = r198->numfelt;
		}
		if (keynumv>0) {
			funkretur = find_r198(1,16524,(double)keynumv,"",0);
			if (funkretur>0 && r198->numfelt>0) {
				ege_w_dou1 = r198->numfelt;
			}
		}
		dep_kredit = ege_w_dou1;
		ege_w_dou1 = 0;
/* NYT 071003 KONTANT */
		ege_w_dou1 = 3000;
		if (donleasing==1) {
			ege_w_dou1 = dep_online;
		}
/* AKTIVERET 131104 DEPOSITUM */
		funkretur = find_r198(1,16525,(double)keynum,"",0);
		if (funkretur>0 && r198->numfelt>0) {
			ege_w_dou1 = r198->numfelt;
		}
		if (keynumv>0) {
			funkretur = find_r198(1,16525,(double)keynumv,"",0);
			if (funkretur>0 && r198->numfelt>0) {
				ege_w_dou1 = r198->numfelt;
			}
		}
		dep_kontant = ege_w_dou1;
/* NYT 130524 DON2KAMPAGNE */
/* RETTET 130606
		if (ws_funktion==22 && ws_stepnr>0) {
			pack_int2((long)ws_stepnr);
		}
*/

/* NYT 120904 GetAvailabiltyList */
/* LocationId */
		pack_int2((long)ws_station);
/* ProductId */	
		sprintf(tmpstr,"%hd",spc);	
		if (tspc>0) {
			sprintf(tmpstr,"%hd;%hdx%hd",spc,tspc,tant);	
		}
		pack_alfa(tmpstr);
/* ProductName */	
		if (strcmp(lang, "DK")==0 ||
			strcmp(lang,"DA")==0) {
			strcpy(tmpstr,txt);
		} else {
			sprintf(transstr, "%5.5ld%5.5hd",(long int)16507,spc);
			trans_tekst(lang,0,transstr,tmpstr);
		}
		strcpy(tillantstr,"");
		strcpy(tillspcstr,"");
		funkretur = 0;
		if (tspc>0) {
			reclow(r165,R165);
			f165_start(1,ISGTEQ);
			r165->spec_nr = tspc;
			strcpy(r165->bil_grp, grp);
			egeread(f165, ISEQUAL);
			if (f165_ok) {
				funkretur = 1;
			}
		}
		if (tspc>0 && funkretur==0) {
			r165->spec_nr = tspc;
			r165->stat_nr = st;
			strcpy(r165->bil_grp, grp);
			egeread(f165, ISEQUAL);
			if (f165_ok) {
				funkretur = 1;
			}
		}
		if (tspc>0 && funkretur==0) {
			r165->spec_nr = tspc;
			r165->stat_nr = st;
			strcpy(r165->bil_grp, "ALLE");
			egeread(f165, ISEQUAL);
			if (f165_ok) {
				funkretur = 1;
			}
		}
		if (tspc>0 && funkretur==0) {
			r165->spec_nr = tspc;
			r165->stat_nr = 0;
			strcpy(r165->bil_grp, "ALLE");
			egeread(f165, ISEQUAL);
			if (f165_ok) {
				funkretur = 1;
			}
		}
		if (tspc>0 && funkretur==1) {
			if (strcmp(lang, "DK")==0 ||
				strcmp(lang,"DA")==0) {
				strcpy(tillspcstr,r165->tekst_1);
			} else {
				sprintf(transstr, "%5.5ld%5.5hd",
					(long int)16507,r165->spec_nr);
				trans_tekst(lang,0,transstr,tillspcstr);
			}
		}
		if (tspc>0 && funkretur==1) {
			sprintf(tillantstr, " + %hd ",tant);
		}
/* NYT 130104 FYRAFTENEXTRA */
		if (tspc>0 && funkretur==1 && spc==185 && tspc==180) {
			sprintf(tillantstr, "+%hd* ",(short int)1);
		}
		if (tspc>0 && funkretur==1 && spc==185 && tspc==181) {
			sprintf(tillantstr, "+%hd* ",(short int)2);
		}
		if (tspc>0 && funkretur==1 && spc==185 && tspc==182) {
			sprintf(tillantstr, "+%hd* ",(short int)3);
		}
		if (tspc>0 && funkretur==1 && spc==185 && tspc==183) {
			sprintf(tillantstr, "+%hd* ",(short int)4);
		}
		if (tspc>0 && funkretur==1 && spc==185 && tspc==184) {
			sprintf(tillantstr, "+%hd* ",(short int)5);
		}
		if (tspc>0 && funkretur==1 && spc==185 && tspc==666) {
			sprintf(tillantstr, "+%hd* ",(short int)6);
		}
		if (tspc>0 && funkretur==1) {
			strcat(tmpstr, tillantstr);
			strcat(tmpstr, tillspcstr);
		}
		if (tmpstr[0]>=97 && tmpstr[0]<=122) {
			tmpstr[0] -= 32;
		}
/* NYT 111019 DONVDK */
		if (dondafolo>0 &&
			grp[0]=='A' &&
			DONVDKFLAG &&
			strcmp(ws_langstr,"EN")!=0 &&
			ws_fradato>=DONVDKFRA && ws_fradato<=DONVDKTIL) {
			strcat(tmpstr, " uden vinterdæk");
		}
		if (dondafolo>0 &&
			grp[0]=='A' &&
			DONVDKFLAG &&
			strcmp(ws_langstr,"EN")==0 &&
			ws_fradato>=DONVDKFRA && ws_fradato<=DONVDKTIL) {
			strcat(tmpstr, " without wintertyres");
		}
		egechartest((unsigned char *)tmpstr);
		pack_alfa(tmpstr);
/* CategoryId */
		pack_alfa(grp);
/* Varighed */
		pack_int2((long)lejedage);
/* Total.Incl.Moms */
		ege_w_dou1 = r159->total;
		ege_w_dou1 -= r159->pai_ialt;
/*		pack_doub(ege_w_dou1); */
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);
/* Incl.Km */
		pack_int2((long)r159->rate_incl_km[10]);
/* Pris.Extra.Km */
/*		pack_doub(r159->rate_ekstra_km[10]); */
		ege_w_dou1 = r159->rate_ekstra_km[10];
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);

/* 130118 PRODUKTAFHAFL */
/* Afh.Dato DDMMAAAA */
                ege_w_int1 = m036_funktion(17, fradt);
		sprintf(tmpstr,"%8.8ld", ege_w_int1);
		pack_alfa(tmpstr);
/* Afh.Tid.Fra */
		sprintf(tmpstr,"%4.4hd",afh);
/* 130118 PRODUKTAFHAFL TESTTID
		if (spc==185) {
			sprintf(tmpstr,"%4.4hd",1200);
		}
*/
		pack_alfa(tmpstr);
/* Afh.Tid.Til */
		sprintf(tmpstr,"%4.4hd",afh);
/* 130118 PRODUKTAFHAFL TESTTID
		if (spc==185) {
			sprintf(tmpstr,"%4.4hd",1300);
		}
*/
		pack_alfa(tmpstr);
/* Afl.Dato DDMMAAAA */
                ege_w_int1 = m036_funktion(17, returdato);
		sprintf(tmpstr,"%8.8ld", ege_w_int1);
		pack_alfa(tmpstr);
/* Afl.Tid.Fra */
		sprintf(tmpstr,"%4.4hd",afl);


/* 130118 PRODUKTAFHAFL TESTTID
		if (spc==185) {
			sprintf(tmpstr,"%4.4hd",1400);
		}
*/
		pack_alfa(tmpstr);
/* Afl.Tid.Til */
		sprintf(tmpstr,"%4.4hd",afl);
/* 130118 PRODUKTAFHAFL TESTTID
		if (spc==185) {
			sprintf(tmpstr,"%4.4hd",1500);
		}
*/
		pack_alfa(tmpstr);
/* Depositum */
/*		pack_doub(dep_online); */
		xls_char(tmpstr,(double)dep_online,2);
		pack_alfa(tmpstr);
/*		pack_doub(dep_kontant); */
		xls_char(tmpstr,(double)dep_kontant,2);
		pack_alfa(tmpstr);
/*		pack_doub(dep_kredit); */
		xls_char(tmpstr,(double)dep_kredit,2);
		pack_alfa(tmpstr);

/* DEPOSITUM + LEJE */
		ege_w_dou1 = dep_online;
		ege_w_dou1 += r159->total;
		ege_w_dou1 -= r159->pai_ialt;
/*		pack_doub(ege_w_dou1); */
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);

		ege_w_dou1 = dep_kontant;
		ege_w_dou1 += r159->total;
		ege_w_dou1 -= r159->pai_ialt;
/*		pack_doub(ege_w_dou1); */
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);

		ege_w_dou1 = dep_kredit;
		ege_w_dou1 += r159->total;
		ege_w_dou1 -= r159->pai_ialt;
/*		pack_doub(ege_w_dou1); */
		xls_char(tmpstr,(double)ege_w_dou1,2);
		pack_alfa(tmpstr);

/* Betalingskortliste */
		sprintf(tmpstr,
"Dankort,VISA/Dankort,American Express,MasterCard,VISA International,Diners Club,Eurocard");
/* RETTET 130828 BETALINGSKORTLISTE
"Mastercard,Eurocard,Diners,Visa International (ikke Visa/DK),Amex,Visa/Dankort,Dankort,Kontant");
*/
		pack_alfa(tmpstr);

/* AdditionalInfo */
/*
		trans_tekst(lang,10153,"",tmpstr);
*/
/* NYT 121121 PLIGTTEKST */
		(void)retur_pligttekst(tmpstr);

#ifdef egetest
/* NYT 121106 INKLKM */
		ege_w_int1 = (long int)r159->rate_incl_km[10];
		sprintf(tmpstr,"Inkl. %ld km.", ege_w_int1);

/* NYT 100407 MILJØ 944 */
		if (ws_dkflag>0) {
			strcat(tmpstr,", moms");
		} else {
			strcat(tmpstr,", VAT");
		}
		if (DONMBIDRAG>0 && ws_mbidrag>0 && ws_dkflag>0) {
			strcat(tmpstr,", ");
			strcat(tmpstr,ws_mbidragtxt);
		}
		if (DONMBIDRAG>0 && ws_mbidrag>0 && ws_dkflag<=0) {
			strcat(tmpstr,", ");
			strcat(tmpstr,"environment fee");
		}
		if (ws_dkflag>0) {
			strcpy(transstr,
		", forsikring med en selvrisiko på 3.500 kr.");
		} else {
			strcpy(transstr,
		", forsikring med en selvrisiko på 3.500 kr.");
		}
/* RETTET 130405 DKKKR
		if (ws_dkflag>0) {
			strcpy(transstr,
		", forsikring med en selvrisiko på DKK 3.500.");
		} else {
			strcpy(transstr,
		", forsikring med en selvrisiko på DKK 3.500.");
		}
*/
		strcat(tmpstr,transstr);
/* NYT 121112 */
		strcpy(transstr, " Pr. ekstra km. ");
		strcat(tmpstr,transstr);
		ege_w_dou1 = r159->rate_ekstra_km[10];
		xls_char(transstr,(double)ege_w_dou1,2);
		strcat(tmpstr,transstr);
		strcat(tmpstr," kr.");
/*
		trans_tekst(lang,10154,"",transstr);
		strcat(tmpstr,transstr);
		trans_tekst(lang,10155,"",transstr);
		strcat(tmpstr,transstr);
		trans_tekst(lang,10156,"",transstr);
		strcat(tmpstr,transstr);
*/
/* NYT 111019 DONVDK */
/*
		if (dondafolo>0 &&
			grp[0]=='A' &&
			DONVDKFLAG &&
			strcmp(ws_langstr,"EN")!=0 &&
			ws_fradato>=DONVDKFRA && ws_fradato<=DONVDKTIL) {
			sprintf(vdkstr,
			" For bestilling af vinterdæk, kontakt os på tlf. %s.",
				ws_sttlfnr);
			strcat(tmpstr, vdkstr);
		}
		if (dondafolo>0 &&
			grp[0]=='A' &&
			DONVDKFLAG &&
			strcmp(ws_langstr,"EN")==0 &&
			ws_fradato>=DONVDKFRA && ws_fradato<=DONVDKTIL) {
			sprintf(vdkstr,
			" Ordering of wintertyres, please contact us. Phone %s.",
				ws_sttlfnr);
			strcat(tmpstr, vdkstr);
		}
*/
#endif
		pack_alfa(tmpstr);
/* Tvungen.Dibs DIBSSTYR 0=ALLE 1=DIBSONLY 2=DIBSOFF */
		ege_w_int1 = 0;
/* NYT 130227 DIBSSTYR */
		sprintf(tmpstr, "dondibs.only");
		if (access(tmpstr,0)==0) {
			ege_w_int1 = 1;
		}
		sprintf(tmpstr, "dondibs.off");
		if (access(tmpstr,0)==0) {
			ege_w_int1 = 2;
		}
		if (logfil) {
			fprintf(logfil,"\t\tDIBSSTYR=%ld\n",ege_w_int1);
			fflush(logfil);
		}
/*
		if (spc==180) {
			ege_w_int1 = 1;
		}
		if (spc==185) {
			ege_w_int1 = 2;
		}
*/
		pack_int2((long)ege_w_int1);
/* 120918 AdditionalInfoLink */
/* NYT 121128 PRODUKTPNG */
		strcpy(tmpstr,"/Files/Images/noproduct.png");
		strcpy(prodfilnavn,"");
		if (strcmp(grp,"3")==0 && spc==185) {
			strcpy(prodfilnavn,"v_fyraften.png");
		}
		if (strcmp(grp,"3")==0 && spc==185 && tspc>0) {
			strcpy(prodfilnavn,"v_fyraften_plus.png");
		}
		if (strcmp(grp,"3")!=0 && spc==185) {
			strcpy(prodfilnavn,"p_fyraften.png");
		}
		if (strcmp(grp,"3")!=0 && spc==185 && tspc>0) {
			strcpy(prodfilnavn,"p_fyraften_plus.png");
		}
		if (strcmp(grp,"3")==0 && spc>=180 && spc<=184) {
			strcpy(prodfilnavn,"v_dag.png");
		}
		if (strcmp(grp,"3")!=0 && spc>=180 && spc<=184) {
			strcpy(prodfilnavn,"p_dag.png");
		}
/* NYT 130321 ERHVERVPNG */
		if (strcmp(grp,"3")==0 && spc>=187 && spc<=191) {
			strcpy(prodfilnavn,"v_dag.png");
		}
		if (strcmp(grp,"3")==0 && spc==668) {
			strcpy(prodfilnavn,"v_dag.png");
		}
		if (strcmp(grp,"3")!=0 && spc>=187 && spc<=191) {
			strcpy(prodfilnavn,"p_dag.png");
		}
		if (strcmp(grp,"3")!=0 && spc==668) {
			strcpy(prodfilnavn,"p_dag.png");
		}

		if (strcmp(grp,"3")==0 && spc==666) {
			strcpy(prodfilnavn,"v_dag.png");
		}
		if (strcmp(grp,"3")!=0 && spc==666) {
			strcpy(prodfilnavn,"p_dag.png");
		}
		if (strcmp(grp,"3")==0 && spc==195) {
			strcpy(prodfilnavn,"v_loerdag.png");
		}
		if (strcmp(grp,"3")!=0 && spc==195) {
			strcpy(prodfilnavn,"p_loerdag.png");
		}
		if (strcmp(grp,"3")==0 && spc==196) {
			strcpy(prodfilnavn,"v_weekend.png");
		}
		if (strcmp(grp,"3")!=0 && spc==196) {
			strcpy(prodfilnavn,"p_weekend.png");
		}
		if (strcmp(grp,"3")==0 && spc>=197 && spc<=198) {
			strcpy(prodfilnavn,"v_weekend_lang.png");
		}
		if (strcmp(grp,"3")!=0 && spc>=197 && spc<=198) {
			strcpy(prodfilnavn,"p_weekend_lang.png");
		}
		if (strcmp(grp,"3")==0 && spc>=192 && spc<=193) {
			strcpy(prodfilnavn,"v_uge.png");
		}
		if (strcmp(grp,"3")!=0 && spc>=192 && spc<=193) {
			strcpy(prodfilnavn,"p_uge.png");
		}
		if (strcmp(grp,"3")==0 && spc==194) {
			strcpy(prodfilnavn,"v_maaned1500.png");
		}
		if (strcmp(grp,"3")!=0 && spc==194) {
			strcpy(prodfilnavn,"p_maaned1500.png");
		}
		if (strcmp(grp,"3")==0 && spc==663) {
			strcpy(prodfilnavn,"v_maaned2500.png");
		}
		if (strcmp(grp,"3")!=0 && spc==663) {
			strcpy(prodfilnavn,"p_maaned2500.png");
		}
		if (strcmp(grp,"3")==0 && spc==664) {
			strcpy(prodfilnavn,"v_maaned3000.png");
		}
		if (strcmp(grp,"3")!=0 && spc==664) {
			strcpy(prodfilnavn,"p_maaned3000.png");
		}
/* NYT 131003 EFTERAAR */
		if (strcmp(grp,"3")==0 && spc==644) {
			strcpy(prodfilnavn,"v_efteraar.png");
		}
		if (strcmp(grp,"3")!=0 && spc==644) {
			strcpy(prodfilnavn,"p_efteraar.png");
		}
/* NYT 141017 641MAANED1000 */
		if (strcmp(grp,"3")==0 && spc==641) {
			strcpy(prodfilnavn,"v_efteraar.png");
		}
		if (strcmp(grp,"3")!=0 && spc==641) {
			strcpy(prodfilnavn,"p_efteraar.png");
		}
/* NYT 131004 MAANEDKAMPAGNE */
		if (strcmp(grp,"3")==0 && spc==642) {
			strcpy(prodfilnavn,"v_maaned1200.png");
		}
		if (strcmp(grp,"3")!=0 && spc==642) {
			strcpy(prodfilnavn,"p_maaned1200.png");
		}
/* NYT 131128 JUL2013 */
		if (strcmp(grp,"3")!=0 && spc==650) {
			strcpy(prodfilnavn,"p_jul2013.png");
		}
/* NYT 140317 PAASKE2014 */
		if (strcmp(grp,"3")!=0 && spc==645) {
			strcpy(prodfilnavn,"p_paaske.png");
		}

/* RETTET 130110
		if (spc>=190 && spc<200) {
			strcpy(tmpstr,"/Files/Images/prod2.png");
		}
		if (spc>=200) {
			strcpy(tmpstr,"/Files/Images/daek.png");
		}
		if (spc==185) {
			strcpy(tmpstr,"/Files/Images/prod2.png");
		}
*/
		if (strlen(prodfilnavn)) {
			sprintf(tmpstr,"/Files/Images/Produkter/%s",
				prodfilnavn);
		} else {
			sprintf(tmpstr,"/Files/Images/Produkter/%s",
				"noproduct.png");
		}
		pack_alfa(tmpstr);
/* FLYTTET 130606 */
/*
		if (ws_funktion==22 && ws_stepnr>0) {
			pack_int2((long)ws_stepnr);
		}
*/
		pack_exchkend();
	}
	if (dondafolo>0 && ws_prodsortflag==0) {
		send_linie();
		if (logfil) {
			fprintf(logfil,"SENDT=%s\n",str);
			fflush(logfil);
		}
	}
	if (dondafolo>0 && ws_prodsortflag>0 && ws_prodsortidx==0) {
		sprintf(tmpstr,"/tmp/p7912_%hd.srt",ege_pid);
		(void)unlink(tmpstr);
	}
	if (strcmp(PRODSORTTP,"ege")==0 &&
		dondafolo>0 && ws_prodsortflag>0 && ws_prodsortidx==0) {
		egesort(1, "sort");
		if (logfil) {
			fprintf(logfil,"chksend_prod:egesort_1\n");
			fflush(logfil);
		}
	}
	if (dondafolo>0 && ws_prodsortflag==1) {
		ege_w_dou1 = r159->total;
		ege_w_dou1 -= r159->pai_ialt;
		ege_w_int1 = 100000;
		if (r159->dato_ud==ws_kundedtfra &&
			r159->forv_dato_ind==ws_kundedttil) {
			ege_w_int1 = 000000;
		}
		if (r159->dato_ud==ws_kundedtfra &&
			r159->tid_ud>ws_kundetdfra) {
			ege_w_int1 += 400000;
/* NYT 090326 PAASKE 09 */
			if (ws_donsaesonflag>0) {
				ege_w_int1 -= 200000;
			}
		}
		if (fvar!=0) {
			ege_w_int1 += 200000;
		}
/* NYT 131128 JUL2013 */
		if (spc==650) {
			ege_w_int1 -= 200000;
		}

		ege_w_int2 = (long int)ege_w_dou1;
		ege_w_int1 += ege_w_int2;
		sprintf(dum_str,"%7ld %2hd \n \0",
			ege_w_int1,
			ws_prodsortidx);
	}
	if (dondafolo>0 && ws_prodsortflag==2) {
		ege_w_int1 = (long int)fvar;
		sprintf(dum_str,"%7ld %2hd \n \0",
			ege_w_int1,
			ws_prodsortidx);
	}
	if (ws_prodsortflag>0 && logfil) {
		fprintf(logfil,
		"\tchksend_prod_%s:spc=%hd,ege_w_int1=%ld\n",
			PRODSORTTP,
			spc,
			ege_w_int1);
		fprintf(logfil,
		"\tchksend_prod:ege_w_int2=%ld\n", ege_w_int2);
		fprintf(logfil,
		"\tchksend_prod:ud=%ld %ld %ld %ld\n",
			ws_kundedtfra,
			ws_fradato,
			r159->dato_ud,
			fradt);
		fprintf(logfil,
		"\tchksend_prod:ind=%ld %ld %ld %ld\n",
			ws_kundedttil,
			ws_tildato,
			r159->forv_dato_ind,
			returdato);
		fprintf(logfil,
		"\tchksend_prod:tud=%ld %ld %ld\n",
			ws_kundetdfra,
			ws_fratid,
			r159->tid_ud);
		fprintf(logfil,
		"\tchksend_prod:tind=%ld %ld %ld\n",
			ws_kundetdtil,
			ws_tiltid,
			r159->forv_tid_ind);

	}
	if (strcmp(PRODSORTTP,"sort")==0 && dondafolo>0 && ws_prodsortflag>0) {
		sprintf(tmpstr,"/tmp/p7912_%hd.srt",ege_pid);
		prodfil = fopen(tmpstr,"a");
		if (prodfil) {
			fprintf(prodfil,"%7ld %s",ege_w_int1,str);
			fclose(prodfil);
		}
		prodfil = (FILE*)0;
		ws_prodsortidx++;
	}
	if (strcmp(PRODSORTTP,"ege")==0 && dondafolo>0 && ws_prodsortflag>0) {
		egesort(2, dum_str);
		if (logfil) {
			fprintf(logfil,"chksend_prod:egesort_2 %s",
				dum_str);
			fflush(logfil);
		}
		sprintf(tmpstr,"/tmp/p7912_%hd.srt",ege_pid);
		prodfil = fopen(tmpstr,"a");
		if (prodfil) {
			fprintf(prodfil,"%s",str);
			fclose(prodfil);
		}
		prodfil = (FILE*)0;
		ws_prodsortidx++;
	}

	if (ws_prodsortflag==0 && logfil) {
		fprintf(logfil,
		"\tchksend_prod:produktlinie=%s\n", str);
	}
	return(1);
}

/* PLIGTTEKST */
/* *********************************************************************** */
static int retur_pligttekst(char * returstr) {
	int retur = 0;
	int idx = 0;
	char transstr[81] = "";
	char tmpstr[201] = "";
	char prisstr[41] = "";
	double selvrisiko = 3500;

	idx = 0;
	while (idx<10) {
		if (r159->rate_spec_nr[idx]==947 && r159->rate_antal>0) {
			selvrisiko = 1000;
		}
		idx++;
	}
/* NYT 141017 641MAANED1000 */
	if (r159->rate_spec_nr[0]==641) {
		selvrisiko = 5000;
	}

/* 130528 KMPUNKTUM */
	strcpy(returstr,"");
	ege_w_int1 = (long int)r159->rate_incl_km[10];
	sprintf(tmpstr,"Inkl. %ld km.", ege_w_int1);

/* NYT 100407 MILJØ 944 */
	if (ws_dkflag>0) {
		strcat(tmpstr,", moms");
	} else {
		strcat(tmpstr,", VAT");
	}
	if (DONMBIDRAG>0 && ws_mbidrag>0 && ws_dkflag>0) {
		strcat(tmpstr,", ");
		strcat(tmpstr,ws_mbidragtxt);
	}
	if (DONMBIDRAG>0 && ws_mbidrag>0 && ws_dkflag<=0) {
		strcat(tmpstr,", ");
		strcat(tmpstr,"environment fee");
	}
	egeedit(ege_w_dou1=selvrisiko,"zz.zz9",prisstr);
	if (ws_dkflag>0) {
		sprintf(transstr,
		", forsikring med en selvrisiko på DKK %s.",prisstr);
	} else {
		sprintf(transstr,
		", forsikring med en selvrisiko på DKK %s.",prisstr);
	}
/* RETTET 130405 DKKKR
	if (ws_dkflag>0) {
		strcpy(transstr,
		", forsikring med en selvrisiko på DKK 3.500.");
	} else {
		strcpy(transstr,
		", forsikring med en selvrisiko på DKK 3.500.");
	}
*/
	strcat(tmpstr,transstr);
/* NYT 121112 */
	strcpy(transstr, " Pr. ekstra km. ");
	strcat(tmpstr,transstr);
	ege_w_dou1 = r159->rate_ekstra_km[10];
	xls_char(transstr,(double)ege_w_dou1,2);
	strcat(tmpstr,transstr);
	strcat(tmpstr," kr.");
	strcpy(returstr,tmpstr);

	retur = 1;
	return(retur);
}

/* *************************************** */
static int sortsend_prod(char *langstr) {
	short int antal = 0;
	short int okflag = 1;
	long int sort_styr = 0;
	short int sort_idx = 0;
	short int funkretur = 0;
	short int exaktflag = 1;
	long int chkdtfra = 0;
	long int chkdttil = 0;
	long int chktdfra = 0;
	long int chktdtil = 0;
	char tmpstr[501] = "";
	char chkstr[41] = "";
	FILE * prodfil;

	prodfil = (FILE*)0;
	if (logfil) {
		fprintf(logfil,"sortsend_prod:ws_prodsortidx=%hd,%s\n",
			ws_prodsortidx,
			PRODSORTTP);
		fprintf(logfil,"sortsend_prod:langstr=%s\n",
			langstr);
		fflush(logfil);
	}
	if (strcmp(PRODSORTTP,"sort")==0 && ws_prodsortidx>0) {
		sprintf(tmpstr,"/tmp/p7912_%hd.srt",ege_pid);
		sprintf(dum_str,"sort %s -o %s",
			tmpstr,
			tmpstr);
		system(dum_str);
		prodfil = fopen(tmpstr,"r");
	}
	while (strcmp(PRODSORTTP,"sort")==0 && ws_prodsortidx>0 && prodfil) {
		if (!fgets(tmpstr,500,prodfil)) {
			break;
		}
/* NYT 080903 check exakt match EXAKT */
		alfalow(str);
		strcpy(str,tmpstr+8);
		nuv = 0;
		get_alfa(chkstr);
		get_alfa(chkstr);
		get_alfa(chkstr);
		get_alfa(chkstr);
		get_alfa(chkstr);
		rens_datotidstr(chkstr);
		sscanf(chkstr+8,"%ld",&chktdfra);
		chkstr[8] = '\0';
		sscanf(chkstr,"%ld",&chkdtfra);
		get_alfa(chkstr);
		rens_datotidstr(chkstr);
		sscanf(chkstr+8,"%ld",&chktdtil);
		chkstr[8] = '\0';
		sscanf(chkstr,"%ld",&chkdttil);
		if (ws_kundedtfra!=chkdtfra) { exaktflag = 0; }
		if (ws_kundetdfra!=chktdfra) { exaktflag = 0; }
		if (ws_kundedttil!=chkdttil) { exaktflag = 0; }
		if (ws_kundetdtil!=chktdtil) { exaktflag = 0; }
/* DON2OBS
		if (antal==0 && exaktflag!=1) {
			alfalow(str);
			pack_init(str);
			pack_alfa("HEADER");
			if (strcmp(langstr,"EN")==0) {
				pack_alfa("NOTICE RENTAL PERIOD");
			} else {
				pack_alfa("BEMÆRK PERIODE");
			}
			pack_exchkend();
			send_linie();
		}
		if (antal==0 && exaktflag==1) {
			alfalow(str);
			pack_init(str);
			pack_alfa("HEADER");
			if (strcmp(langstr,"EN")==0) {
				pack_alfa("Your choice");
			} else {
				pack_alfa("Dit valg");
			}
			pack_exchkend();
			send_linie();
		}
		if (antal==1) {
			alfalow(str);
			pack_init(str);
			pack_alfa("ALTERNATIVE");
			if (strcmp(langstr,"EN")==0) {
				pack_alfa("Other options - notice rental period");
			} else {
				pack_alfa("Andre muligheder - bemærk periode");
			}
			pack_exchkend();
			send_linie();
		}
*/
		alfalow(str);
		strcpy(str,tmpstr+8);
		sscanf(tmpstr,"%ld",&sort_styr);
		send_linie();
		if (logfil) {
			fprintf(logfil,
			"\tsortsend_prod:produktlinie=%ld SENDT=%s\n",
				sort_styr,
				str);
		}
		antal++;
	}
	if (strcmp(PRODSORTTP,"sort")==0) {
		if (prodfil) {
			fclose(prodfil);
		}
		prodfil = (FILE*)0;
	}

	if (strcmp(PRODSORTTP,"ege")==0 && ws_prodsortidx>0) {
		egesort(3, "sort");
		if (logfil) {
			fprintf(logfil,"sortsend_prod:egesort_3 KALDT\n");
			fflush(logfil);
		}
	}
	while (strcmp(PRODSORTTP,"ege")==0 &&
		ws_prodsortidx>0 &&
		antal>=0 &&
		okflag) {
		if (logfil) {
			fprintf(logfil,"sortsend_prod:egesort_4 IKKEKALDT\n");
			fflush(logfil);
		}
		if (egesort(4, dum_str)<=0) {
			okflag = 0;
			break;
		}
		if (logfil) {
			fprintf(logfil,"sortsend_prod:egesort_4 KALDT\n");
			fflush(logfil);
		}
		if (logfil) {
			fprintf(logfil,
			"\tsortsend_prod:egesort_4 dum_str=%s",
				dum_str);
			fflush(logfil);
		}
		sscanf(dum_str, "%ld %hd",&sort_styr,&sort_idx);
		if (logfil) {
			fprintf(logfil,
			"\tsortsend_prod:sort_styr=%ld sort_idx=%hd\n",
				sort_styr,
				sort_idx);
		}
/* DON2OBS
		if (antal==0) {
			alfalow(str);
			pack_init(str);
			pack_alfa("HEADER");
			if (strcmp(langstr,"EN")==0) {
				pack_alfa("Your choice");
			} else {
				pack_alfa("Dit valg");
			}
			pack_exchkend();
			send_linie();
		}
		if (antal==1) {
			alfalow(str);
			pack_init(str);
			pack_alfa("ALTERNATIVE");
			if (strcmp(langstr,"EN")==0) {
				pack_alfa("Other options - notice rental period");
			} else {
				pack_alfa("Andre muligheder - bemærk periode");
			}
			pack_exchkend();
			send_linie();
		}
*/
		alfalow(str);
		funkretur = 0;
		sprintf(dum_str,"/tmp/p7912_%hd.srt",ege_pid);
		prodfil = fopen(dum_str,"r");
		if (prodfil) {
			funkretur = find_prod_str(sort_idx,prodfil);
			fclose(prodfil);
		}
		prodfil = (FILE*)0;
		if (logfil) {
			fprintf(logfil,
			"\tsortsend_prod:funkretur=%hd,str=%s",
				sort_idx,
				str);
		}
		send_linie();
		if (logfil) {
			fprintf(logfil,
			"\tsortsend_prod:produktlinie=%hd %s\n",
				sort_idx,
				str);
		}
		antal++;
	}
	if (logfil) {
		fprintf(logfil,"sortsend_prod:antal=%hd\n",antal);
		fflush(logfil);
	}
	sprintf(tmpstr,"/tmp/p7912_%hd.srt",ege_pid);
	(void)unlink(tmpstr);
	return(antal);
}

/* ************************************** */
static int find_prod_str(short idx,FILE *filptr) {
	short int retur = 0;
	short int fil_idx = 0;

	if (!filptr) {
		return(0);
	}
	while (filptr && idx<fil_idx) {
		if (!fgets(str,5000,filptr)) {
			break;
		}
		fil_idx++;
	}
	if (fil_idx==idx) {
		retur = 1;
	}
	return(retur);
}

/* **************************************************** */
/* funk 1 aaben						*/
/*      2 luk						*/
/*      3 1+2						*/
static int send_aabentider(subfunk,langstr,st,fradato,tildato)
short int subfunk;
char * langstr;
short int st;
long int fradato;
long int tildato; {
	short int retur = 0;
	short int funkretur = 0;
	long int startjulian = 0;
	long int dgantal = 0;
	long int maxdage = -1;
	long int nuvamd = 0;
	long int returamd = 0;
	long int returdato = 0;
	long int frakl = 0;
	long int tilkl = 0;
	long int tmpnum = 0;
	char tmpstr[81] = "";
	char ddstr[31] = "";
	char mmstr[31] = "";
	char datostr[81] = "";

	if (logfil) {
		fprintf(logfil, "send_aabentider:sub=%hd\n",
			subfunk);
		fprintf(logfil, "send_aabentider:fradato=%ld\n",
			fradato);
		fprintf(logfil, "send_aabentider:tildato=%ld\n",
			tildato);
	}

	returdato = fradato;
	if (fradato<=0) {
		returdato = ws_systemdato;
	}
	startjulian = m036_funktion(12, returdato);
	if (tildato==99999999) {
		maxdage = 360;
	}
	if (tildato==0) {
		maxdage = 0;
	}
	if (maxdage==-1) {
		returdato = m036_funktion(12, tildato);
		maxdage = returdato-startjulian;
	}
	if (logfil) {
		fprintf(logfil, "send_aabentider:returdato=%ld\n",
			returdato);
		fprintf(logfil, "send_aabentider:startjulian=%ld\n",
			startjulian);
		fprintf(logfil, "send_aabentider:maxdage=%ld\n",
			maxdage);
	}
	while (maxdage>=0 && dgantal<=maxdage) {
        	nuvamd = m036_funktion(19, startjulian+dgantal);
		returamd = nuvamd%10000;
		returamd /= 100;
		sprintf(mmstr, "måned %ld", returamd%100);
		if (returamd%100>=1 && returamd%100<=12) {
			sprintf(mmstr, "%s", ws_mmtab[returamd%100]);
		}
		if (returamd%100>=1 && returamd%100<=12 &&
			strcmp(langstr,"DK")!=0 &&
			strcmp(langstr,"DA")!=0) {
			tmpnum = 10300;
			tmpnum += (returamd%100);
			trans_tekst(langstr,tmpnum,"",mmstr);
		}
		returamd = m036_funktion(11, nuvamd);
		returamd %= 10;
		sprintf(ddstr, "dag %ld", returamd);
		if (returamd>=1 && returamd<=7) {
			sprintf(ddstr, "%s", ws_ddtab[returamd]);
		}
		if (returamd>=1 && returamd<=7 &&
			strcmp(langstr,"DK")!=0 &&
			strcmp(langstr,"DA")!=0) {
			tmpnum = 10000;
			tmpnum += returamd;
			trans_tekst(langstr,tmpnum,"",ddstr);
		}
		funkretur = check_bssaaben(-1,st,nuvamd,-1);
		if (funkretur<=0 &&
			subfunk==1) {
			dgantal++;
			continue;
		}
		if (funkretur>0 &&
			subfunk==2) {
			dgantal++;
			continue;
		}
		if (funkretur<=0 &&
			(subfunk==2 || subfunk==3)) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)nuvamd);
			pack_int2((long)-1);
			pack_int2((long)-1);
/*
			pack_alfa(ddstr);
			pack_alfa(mmstr);
*/
			pack_exchkend();
			send_linie();
			dgantal++;
			retur++;
			continue;
		}
		(void)get_alfa_tgn(ws_alert_txt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &frakl);
		}
		(void)get_alfa_tgn(ws_alert_txt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &tilkl);
		}
		alfalow(str);
		pack_init(str);
		pack_int2((long)nuvamd);
		pack_int2((long)frakl);
		pack_int2((long)tilkl);
/*
		pack_alfa(ddstr);
		pack_alfa(mmstr);
*/
		pack_exchkend();
		send_linie();

		dgantal++;
		retur++;
	}
	if (logfil) {
		fprintf(logfil, "send_aabentider:retur=%hd\n",
			retur);
	}
	return(retur);
}

/* ********************************* */
static void send_book_extrapriser(funk,langstr,st,kndnr,grp,spc,extspc,dt,td)
short int funk;
char * langstr;
short int st;
long int kndnr;
char * grp;
short int spc; 
char * extspc;
long int dt;
long int td; {
	short int okflag = 0;
	short int funkretur = 0;
	short int aftaleflag = 0;
	short int prisextra = 0;
	long int dgantal = 0;
	long int firmakundenr = 0;
	long int firmaaftfra = 0;
	long int firmaafttil = 0;
	char tmpstr[81] = "";
	char transstr[21] = "";

/* TEST */
	if (logfil) {
		fprintf(logfil,
"send_book_extrapriser:funk=%hd,st=%hd,grp=%s,spc=%hd,ext=%s,dt=%ld,td=%ld\n",
		funk,
		st,
		grp,
		spc,
		extspc,
		dt,
		td);
		fflush(logfil);
	}
	dgantal = beregn_varighed(st,grp,spc,extspc);
/* TEST */
	sprintf(dum_str, "send_book_extrapriser:dgantal=%ld",
		dgantal);
	logfil_put(dum_str);
/* AFTALEFLAG */
	if (kndnr>0) {
		reclow(r167, R167);
		f167_start(1, ISGTEQ);
		r167->kunde_nr = kndnr;
		egeread(f167, ISEQUAL);
		if (f167_ok) {
			firmakundenr = r167->firma_reference;
		}
	}
	if (firmakundenr>0) {
		if (find_r178(0,16,0,(double)firmakundenr)>0) {
			firmaaftfra = (long int)r178->num_felt;
		}
		if (find_r178(0,4,0,(double)firmakundenr)>0) {
			firmaafttil = (long int)r178->num_felt;
		}
		if (firmaafttil==0) {
			firmaafttil = 99999999;
		}
        }
	if (firmakundenr>0 &&
		firmaaftfra>0 &&
		ws_systemdato>=firmaaftfra && ws_systemdato<=firmaafttil) {
		aftaleflag = 1;
	}
/* TEST */
	sprintf(dum_str, "send_prisliste:firma=%ld aft=%ld-%ld aftaleflag=%hd",
		firmakundenr,
		firmaaftfra,
		firmaafttil,
		aftaleflag);
	logfil_put(dum_str);

	reclow(r165, R165);
	r165->stat_nr = st;
	f165_start(2, ISGTEQ);
	if (f165_ukendt) {
		okflag = -1;
	}
	while (okflag>=0) {
		egeread(f165, ISNEXT);
		if (f165_eof) {
			break;
		}
		if (r165->stat_nr!=st) {
			break;
		}
		if (r165->slet_mark>0) {
			continue;
		}
		funkretur = 0;
		prisextra = 0;
                funkretur=find_r198(1,16503,(double)r165->spec_nr,"",0);
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisextra);
			}
		}
		if (prisextra==0) {
			continue;
		}
		if (strcmp(r165->bil_grp, "ALLE")!=0) {
			continue;
		}
		funkretur=find_r198(1,16522,(double)r165->spec_nr,"",0);
		if (funkretur>0 && r198->numfelt>0 && aftaleflag==0) {
			continue;
		}
		funkretur = 0;
		alfalow(str);
		pack_init(str);
		pack_int2((long)r165->spec_nr);
		pack_alfa(r165->bil_grp);
/* RETTET 040514 */
		(void)f198_tekst(langstr,
			16526,(double)0,r165->bil_grp,0,tmpstr);
		pack_alfa(tmpstr);
/* NAVN */

		if (strcmp(langstr, "DK")==0 ||
			strcmp(langstr,"DA")==0) {
			pack_alfa(r165->tekst_1);
		} else {
			sprintf(transstr, "%5.5ld%5.5hd",
				16507,r165->spec_nr);
			trans_tekst(langstr,0,transstr,tmpstr);
			pack_alfa(tmpstr);
		}
/* BESKRIVELSE */
		strcpy(tmpstr,"");
/* pr. dag
		(void)f198_tekst(langstr,
			16501,(double)r165->spec_nr,"",0,tmpstr);
*/
		pack_alfa(tmpstr);
		if (r165->enhed==0) {
			ege_w_dou1 = r165->pris;
		}
/* NYT 050113 DON BARNESTOL */
		if (r165->enhed==0 && r165->spec_nr==932) {
			ege_w_dou1 = dgantal;
			ege_w_dou1 *= r165->pris;
		}
		if (r165->enhed==0 && r165->spec_nr==933) {
			ege_w_dou1 = dgantal;
			ege_w_dou1 *= r165->pris;
		}
		if (r165->enhed==0 && r165->spec_nr==934) {
			ege_w_dou1 = dgantal;
			ege_w_dou1 *= r165->pris;
		}
		if (r165->enhed==201) {
			ege_w_dou1 = dgantal;
			ege_w_dou1 *= r165->pris;
		}
		pack_doub(ege_w_dou1);
/* MAX ANTAL */
		(void)find_r198(0,16505,(double)r165->spec_nr,"",0);
		pack_int2((long)r198->numfelt);
		pack_exchkend();
		send_linie();
	}
	return;
}

/* ********************************* */
static void send_pristyper(funk,langstr,station,kundenr,extrastr)
short int funk;
char * langstr;
short int station;
long int kundenr;
char * extrastr; {
	short int prisextra = 0;
	short int smdgn = 0;
	short int aftaleflag = 0;
	short int funkretur = 0;
	short int okflag = 0;
	long int	maxafh = 0;
	long int	firmakundenr = 0;
	long int	firmaaftfra = 0;
	long int	firmaafttil = 0;
	long int	specialfradato = 0;
	long int	specialtildato = 99999999;
	char transstr[21] = "";
	char tmpstr[81] = "";
	char tmpfelt[81] = "";

	sprintf(dum_str, "send_pristyper:funk=%hd,stat=%hd,extrastr=%s",
		funk,
		station,
		extrastr);
        logfil_put(dum_str);
/* AFTALEFLAG */
	if (kundenr>0) {
		reclow(r167, R167);
		f167_start(1, ISGTEQ);
		r167->kunde_nr = kundenr;
		egeread(f167, ISEQUAL);
		if (f167_ok) {
			firmakundenr = r167->firma_reference;
		}
	}
	if (firmakundenr>0) {
		if (find_r178(0,16,0,(double)firmakundenr)>0) {
			firmaaftfra = (long int)r178->num_felt;
		}
		if (find_r178(0,4,0,(double)firmakundenr)>0) {
			firmaafttil = (long int)r178->num_felt;
		}
		if (firmaafttil==0) {
			firmaafttil = 99999999;
		}
        }
	if (firmakundenr>0 &&
		firmaaftfra>0 &&
		ws_systemdato>=firmaaftfra && ws_systemdato<=firmaafttil) {
		aftaleflag = 1;
	}
/* TEST */
	sprintf(dum_str, "send_pristyper:firma=%ld aft=%ld-%ld aftaleflag=%hd",
		firmakundenr,
		firmaaftfra,
		firmaafttil,
		aftaleflag);
	logfil_put(dum_str);

	reclow(r165, R165);
	r165->stat_nr = station;
	f165_start(2, ISGTEQ);
	if (f165_ukendt) {
		okflag = -1;
	}
	while (okflag>=0) {
		egeread(f165, ISNEXT);
		if (f165_eof) {
			break;
		}
		if (r165->stat_nr!=station) {
			break;
		}
		if (r165->slet_mark>0) {
			continue;
		}
		if (funk==1 && strlen(extrastr) &&
			strcmp(r165->bil_grp, extrastr)!=0) {
			continue;
		}
		prisextra = 0;
		funkretur = find_r198(1,16503,(double)r165->spec_nr,"",0);
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &prisextra);
			}
			(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%hd", &smdgn);
			}
			(void)get_alfa_tgn(r198->alfafelt,5,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%ld", &maxafh);
			}
		}
		if (funk==1 && prisextra==1) {
			continue;
		}
		funkretur=find_r198(1,16522,(double)r165->spec_nr,"",0);
		if (funk==1&&funkretur>0&&r198->numfelt>0&&aftaleflag==0) {
			continue;
		}
		funkretur = 1;
		if (smdgn>0 && r165->enhed<200 && r165->enhed>100) {
/* check evt aabningstider */
			funkretur = check_timepriser(r165->enhed,maxafh);
		}
		if (funkretur<=0) {
			continue;
		}
/* NYT 041130 */
		specialfradato = 0;
		specialtildato = 99999999;
		funkretur =
                find_r198_special(1,1,16590,
			(double)r165->spec_nr,r165->bil_grp,100,tmpstr);
		if (funkretur>0 && strlen(tmpstr)) {
			(void)get_alfa_tgn(tmpstr,0,tmpfelt,';');
			if (strlen(tmpfelt)) {
				sscanf(tmpfelt,"%ld",&specialfradato);
			}
			(void)get_alfa_tgn(tmpstr,1,tmpfelt,';');
			if (strlen(tmpfelt)) {
				sscanf(tmpfelt,"%ld",&specialtildato);
			}
		}
		if (funkretur>0 && specialtildato<99999999 &&
			ws_systemdato>specialtildato) {
			continue;
		}

		alfalow(str);
		pack_init(str);
		pack_int2((long)r165->spec_nr);
		if (strcmp(langstr, "DK")==0 ||
			strcmp(langstr, "DA")==0) {
			pack_alfa(r165->tekst_1);
		} else {
			sprintf(transstr, "%5.5ld%5.5hd",
				16507,r165->spec_nr);
			trans_tekst(langstr,0,transstr,tmpstr);
			pack_alfa(tmpstr);
		}
/*
		(void)f198_tekst(langstr,
			16501,(double)r165->spec_nr,"",0,tmpstr);
		pack_alfa(tmpstr);
*/
		pack_exchkend();
		send_linie();
		sprintf(dum_str, "send_pristyper:spec=%hd",
			r165->spec_nr);
        	logfil_put(dum_str);
	}
	return;
}

/* ********************************** */
static int check_timepriser(enh,maxafh)
short int enh;
long int maxafh; {
	short int retur = 1;
	long int tmantal = 0;
	long int afltid = 0;

	tmantal = (long int)(enh-100);
	afltid = ws_systemtid + (tmantal*100);
	if (afltid>=maxafh) {
		retur = 0;
	}
	return(retur);
}

/* ********************************* */
static void send_extrapristyper(funk,langstr,station,kundenr,grp,spcnr)
short int funk;
char * langstr;
short int station;
long int kundenr;
char * grp;
short int spcnr; {
	short int wx1 = 0;
	short int extraflag = 0;
	short int koblenhed = 0;
	short int koblspecnr = 0;
	short int koblfra = 0;
	short int kobltil = 0;
	short int funkretur = 0;
	short int okflag = 0;
	long int	ledigdato = 0;
	char transstr[21] = "";
	char tmpstr[81] = "";
	char udvstr[81] = "";
	char f198key[81] = "";
	char returstr[81] = "";

	sprintf(dum_str,
	"send_extrapristyper:funk=%hd,stat=%hd,knr=%ld,grp=%s,spcnr=%hd",
		funk,
		station,
		kundenr,
		grp,
		spcnr);
        logfil_put(dum_str);
/* RETTET 040510
	ledigdato = find_ledigdato(1,station,grp,spcnr,"",ws_systemdato);
	sprintf(dum_str, "send_extrapristyper:ledigdato=%ld", ledigdato);
        logfil_put(dum_str);
*/
/* NYT 041004 */
	strcpy(udvstr,"");
	sprintf(f198key, "%3.3hd%3.3hd%s",
		0,
		spcnr,
		"*");
	strcpy(r198->alfafelt,"");
	if (find_r198(1,16527,(double)0,f198key,0)>0 &&
		strlen(r198->alfafelt)) {
		(void)get_alfa_tgn(r198->alfafelt,2,udvstr,';');
	}
	if (strlen(udvstr)) {
		sscanf(udvstr, "%hd", &wx1);
		extraflag += wx1;
	}
	strcpy(udvstr,"");
	sprintf(f198key, "%3.3hd%3.3hd%s",
		station,
		spcnr,
		"*");
	strcpy(r198->alfafelt,"");
	if (find_r198(0,16527,(double)0,f198key,0)>0 &&
		strlen(r198->alfafelt)) {
		(void)get_alfa_tgn(r198->alfafelt,2,udvstr,';');
	}
	if (strlen(udvstr)) {
		sscanf(udvstr, "%hd", &wx1);
		extraflag += wx1;
	}
	strcpy(udvstr,"");
	sprintf(f198key, "%3.3hd%3.3hd%s",
		station,
		spcnr,
		grp);
	strcpy(r198->alfafelt,"");
	if (find_r198(0,16527,(double)0,f198key,0)>0 &&
		strlen(r198->alfafelt)) {
		(void)get_alfa_tgn(r198->alfafelt,2,udvstr,';');
	}
	if (strlen(udvstr)) {
		sscanf(udvstr, "%hd", &wx1);
		extraflag += wx1;
	}
	if (extraflag<=0) {
		okflag = -1;
	}
	sprintf(dum_str,
	"send_extrapristyper:extraflag=%hd,okflag=%hd",
		extraflag,
		okflag);
        logfil_put(dum_str);

	while (okflag>=0) {
		funkretur=find_r198(1,16514,(double)spcnr,"",(long int)okflag);
		if (funkretur<=0) {
			break;
		}
		koblenhed = 201;
		koblspecnr = 0;
		koblfra = 0;
		kobltil = 0;
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%hd", &koblenhed);
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%hd", &koblfra);
		}
		(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%hd", &kobltil);
		}
		(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%hd", &koblspecnr);
		}
		reclow(r165, R165);
		r165->spec_nr = koblspecnr;
		r165->stat_nr = station;
		strcpy(r165->bil_grp, grp);
		egeread(f165, ISEQUAL);
		if (f165_ukendt) {
			okflag++;
			continue;
		}
		alfalow(str);
		pack_init(str);
		pack_int2((long)0);
		pack_alfa("ingen");
		pack_exchkend();
		send_linie();
		for (wx1=koblfra;wx1<=kobltil;wx1++) {
			alfalow(str);
			pack_init(str);
			sprintf(tmpstr, "%3.3hdx%hd",
				koblspecnr,
				wx1);
			pack_alfa(tmpstr);
/*
			if (koblenhed==201) {
				sprintf(tmpstr, "%hd dag(e)", wx1);
			}
			if (koblenhed==301) {
				sprintf(tmpstr, "%hd uge(r)", wx1);
			}
*/
			strcpy(returstr, "???");
			sprintf(tmpstr, "%hd %s", wx1, returstr);
			if (wx1==1 && koblenhed==201) {
				trans_tekst(langstr,10140,"",returstr);
			}
			if (wx1>1 && koblenhed==201) {
				trans_tekst(langstr,10141,"",returstr);
			}
			sprintf(tmpstr, "%hd %s", wx1, returstr);
			pack_alfa(tmpstr);
			pack_exchkend();
			send_linie();
		}
		okflag++;
	}
	if (okflag==0 || okflag==-1) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)0);
		pack_alfa("ingen");
		pack_exchkend();
		send_linie();
	}
	return;
}

/* ********************************* */
static void send_amdtabel(funk,langstr,st,grp,spc,extspc,nuvamd)
short int funk;
char * langstr;
short int st;
char * grp;
short int spc; 
char * extspc;
long int nuvamd; {
	int funkretur;
	short int returantal = 0;
	short int wx1 = 0;
	short int blokfundet = 0;
	long int returdato;
	long int julian;
	long int fradato;
	long int tildato;
	long int returamd;
	long int fraamd;
	long int tilamd;
	long int ledigdato = 0;
	long int initdato = 0;
	short int spcsmdgn = 0;
	short int spcdgnrflag = 0;
	short int specialflag = 0;
	long int specialfradato = 0;
	long int specialtildato = 99999999;
	long int spcdgnrfra = 0;
	long int spcdgnrtil = 0;
	long int spcdgnrtab[8] = {1,1,1,1,1,1,1,1};
	long int spcsttid = 0;
	long int spcsltid = 0;
	long int chkdgnr = 0;
	long int tmpnum = 0;
	long int lejevar = 0;
	long int lejetimer = 0;
	long int aabenfra = 0;
	long int aabentil = 0;
	char tmpstr[81] = "";
	char tmpfelt[81] = "";
	char udvstr[81] = "";
	char f198key[21] = "";
	char intstr[7][41] = {"","","","","","",""};

	if (logfil) {
		fprintf(logfil,
	"send_amdtabel:funk=%hd,st=%hd,grp=%s,spc=%hd,extspc=%s,nuvamd=%ld\n",
		funk,
		st,
		grp,
		spc,
		extspc,
		nuvamd);
		fflush(logfil);
	}
	if (funk==1) {
		initdato = ws_systemdato;
	}
	if (funk==2) {
		if (nuvamd>ws_systemdato/10000) {
			initdato = nuvamd;
			initdato *= 10000;
			initdato += 101;
		} else {
			initdato = ws_systemdato;
		}
	}
/* IKKE NØDVENDIGT
	if (funk==3) {
		if (nuvamd>ws_systemdato/100) {
			initdato = nuvamd;
			initdato *= 100;
			initdato += 1;
		} else {
			initdato = ws_systemdato;
		}
	}
*/
/* RETTET 040510
	if (initdato>0) {
		ledigdato = find_ledigdato(1,st,grp,spc,extspc,initdato);
		sprintf(dum_str, "send_amdtabel:ledigdato=%ld", ledigdato);
		logfil_put(dum_str);
	}
*/
	fraamd = ws_systemdato / 10000;
	julian = m036_funktion(12, ws_systemdato);
	julian += 360;
	tildato = m036_funktion(19, julian);
	tilamd = tildato / 10000;
/* NYT 041130 */
	funkretur = 0;
	strcpy(tmpstr, "");
	if (funk==1||funk==2||funk==3) {
		funkretur =
		find_r198_special(1,1,16590,(double)spc,grp,100,tmpstr);
	}
	if (logfil) {
		fprintf(logfil, "send_amdtabel:funkretur=%d,tmpstr=%s\n",
			funk,
			tmpstr);
		fflush(logfil);
	}
	if (funkretur>0 && strlen(tmpstr)) {
		specialfradato = 0;
		specialtildato = 99999999;
		(void)get_alfa_tgn(tmpstr,0,tmpfelt,';');
		if (strlen(tmpfelt)) {
			sscanf(tmpfelt,"%ld",&specialfradato);
		}
		(void)get_alfa_tgn(tmpstr,1,tmpfelt,';');
		if (strlen(tmpfelt)) {
			sscanf(tmpfelt,"%ld",&specialtildato);
		}
	}
	if (funk==1 && funkretur>0 && strlen(tmpstr) &&
		specialfradato>0) {
		specialflag = 1;
		fraamd = specialfradato / 10000;
	}
	if (funk==1 && funkretur>0 && strlen(tmpstr) &&
		specialtildato<99999999) {
		specialflag = 1;
		tilamd = specialtildato / 10000;
	}
	if (funk==1 && specialflag==1 &&
		ws_systemdato>specialtildato) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-1);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "send_amdtabel:str=%s",
				str);
			fflush(logfil);
		}
		return;
	}
	if (funk==2 && funkretur>0 && strlen(tmpstr) &&
		specialfradato>0) {
		specialflag = 1;
	}
	if (funk==2 && funkretur>0 && strlen(tmpstr) &&
		specialtildato<99999999) {
		specialflag = 1;
	}
	if (funk==3 && funkretur>0 && strlen(tmpstr) &&
		specialfradato>0) {
		specialflag = 1;
	}
	if (funk==3 && funkretur>0 && strlen(tmpstr) &&
		specialtildato<99999999) {
		specialflag = 1;
	}
	if (logfil) {
		fprintf(logfil,
	"send_amdtabel:specialflag=%hd,specialfradato-tildato=%ld-%ld\n",
			specialflag,
			specialfradato,
			specialtildato);
		fflush(logfil);
	}

	funkretur = find_r198(1,16503,(double)spc,"",0);
	if (funkretur>0 && strlen(r198->alfafelt)) {
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%hd", &spcsmdgn);
		}
/* FLYTTET 040630 */
		(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &spcsttid);
		}
		(void)get_alfa_tgn(r198->alfafelt,5,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &spcsltid);
		}
		(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
/* NYT 040630 */
		sprintf(f198key, "%3.3hd%3.3hd%s",
			st,
			spc,
			grp);
		strcpy(r198->alfafelt,"");
		if (logfil) {
			fprintf(logfil, "send_amdtabel:f198key=%s\n",
				f198key);
		}
		strcpy(udvstr,"");
		if (find_r198(0,16527,(double)0,f198key,0)>0 &&
			strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,0,udvstr,';');
/* RETTET 041001
			strcpy(tmpstr, r198->alfafelt);
*/
		}
		if (strlen(udvstr)) {
			strcpy(tmpstr,udvstr);
		}
/* NYT 041001 */
		if (find_r198(0,16527,(double)0,f198key,0)>0 &&
			strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,1,udvstr,';');
		}
		if (strlen(udvstr)) {
			sscanf(udvstr, "%hd", &spcsmdgn);
		}


		if (strlen(tmpstr) && spcdgnrflag==0) {
			(void)get_alfa_tgn(tmpstr,1,intstr[1],',');
			if (strlen(intstr[1])) {
				spcdgnrflag = 2;
			}
		}
		if (strlen(tmpstr) && spcdgnrflag==0) {
			(void)get_alfa_tgn(tmpstr,1,intstr[1],'-');
			if (strlen(intstr[1])) {
				spcdgnrflag = 1;
			}
		}
/* X,Y,Z... */
		if (strlen(tmpstr) && spcdgnrflag==2) {
			spcdgnrtab[0] = 0;
			spcdgnrtab[1] = 0;
			spcdgnrtab[2] = 0;
			spcdgnrtab[3] = 0;
			spcdgnrtab[4] = 0;
			spcdgnrtab[5] = 0;
			spcdgnrtab[6] = 0;
			spcdgnrtab[7] = 0;
			(void)get_alfa_tgn(tmpstr,0,intstr[0],',');
			(void)get_alfa_tgn(tmpstr,2,intstr[2],',');
			(void)get_alfa_tgn(tmpstr,3,intstr[3],',');
			(void)get_alfa_tgn(tmpstr,4,intstr[4],',');
			(void)get_alfa_tgn(tmpstr,5,intstr[5],',');
			(void)get_alfa_tgn(tmpstr,6,intstr[6],',');
		}
		wx1 = 0;
		if (strlen(tmpstr) && spcdgnrflag==2 && strlen(intstr[wx1])) {
			sscanf(intstr[wx1], "%ld", &returdato);
			if (returdato>0 && returdato<8) {
				spcdgnrtab[returdato] = 1;
			}
		}
		wx1++;
		if (strlen(tmpstr) && spcdgnrflag==2 && strlen(intstr[wx1])) {
			sscanf(intstr[wx1], "%ld", &returdato);
			if (returdato>0 && returdato<8) {
				spcdgnrtab[returdato] = 1;
			}
		}
		wx1++;
		if (strlen(tmpstr) && spcdgnrflag==2 && strlen(intstr[wx1])) {
			sscanf(intstr[wx1], "%ld", &returdato);
			if (returdato>0 && returdato<8) {
				spcdgnrtab[returdato] = 1;
			}
		}
		wx1++;
		if (strlen(tmpstr) && spcdgnrflag==2 && strlen(intstr[wx1])) {
			sscanf(intstr[wx1], "%ld", &returdato);
			if (returdato>0 && returdato<8) {
				spcdgnrtab[returdato] = 1;
			}
		}
		wx1++;
		if (strlen(tmpstr) && spcdgnrflag==2 && strlen(intstr[wx1])) {
			sscanf(intstr[wx1], "%ld", &returdato);
			if (returdato>0 && returdato<8) {
				spcdgnrtab[returdato] = 1;
			}
		}
		wx1++;
		if (strlen(tmpstr) && spcdgnrflag==2 && strlen(intstr[wx1])) {
			sscanf(intstr[wx1], "%ld", &returdato);
			if (returdato>0 && returdato<8) {
				spcdgnrtab[returdato] = 1;
			}
		}
		wx1++;
		if (strlen(tmpstr) && spcdgnrflag==2 && strlen(intstr[wx1])) {
			sscanf(intstr[wx1], "%ld", &returdato);
			if (returdato>0 && returdato<8) {
				spcdgnrtab[returdato] = 1;
			}
		}
/* X-Y */
		if (strlen(tmpstr) && spcdgnrflag==1) {
			(void)get_alfa_tgn(tmpstr,0,intstr[0],'-');
		}
		if (strlen(tmpstr) && spcdgnrflag==1 && strlen(intstr[0])) {
			sscanf(intstr[0], "%ld", &spcdgnrfra);
			spcdgnrtil = spcdgnrfra;
		}
		if (strlen(tmpstr) && spcdgnrflag==1 && strlen(intstr[1])) {
			sscanf(intstr[1], "%ld", &spcdgnrtil);
		}
/* X */
		if (strlen(tmpstr) && spcdgnrflag==0) {
			sscanf(tmpstr, "%ld", &spcdgnrfra);
			spcdgnrtil = spcdgnrfra;
		}
	}
	if (logfil) {
		fprintf(logfil, "send_amdtabel:spcsmdgn=%hd\n",
			spcsmdgn);
		fprintf(logfil, "send_amdtabel:spcdgnrfra=%ld\n",
			spcdgnrfra);
		fprintf(logfil, "send_amdtabel:spcdgnrtil=%ld\n",
			spcdgnrtil);
		fprintf(logfil,
		"send_amdtabel:spcdgnrtab=%ld,%ld,%ld,%ld,%ld,%ld,%ld\n",
			spcdgnrtab[1],
			spcdgnrtab[2],
			spcdgnrtab[3],
			spcdgnrtab[4],
			spcdgnrtab[5],
			spcdgnrtab[6],
			spcdgnrtab[7]);
		fprintf(logfil, "send_amdtabel:spcsttid=%ld\n",
			spcsttid);
		fprintf(logfil, "send_amdtabel:spcsltid=%ld\n",
			spcsltid);
		fflush(logfil);
	}
	if (funk==1 &&
		spcdgnrfra>20000000 &&
		spcdgnrtil>20000000) {
		fraamd = spcdgnrfra / 10000;
		tilamd = spcdgnrtil / 10000;
	}
	if (funk==2 && specialflag==1) {
		fraamd = specialfradato / 100;
		tilamd = specialtildato / 100;
		if (ws_systemdato/100>tilamd) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-1);
			pack_exchkend();
			send_linie();
			if (logfil) {
				fprintf(logfil, "send_amdtabel:str=%s",
					str);
				fflush(logfil);
			}
			return;
		}
		if (ws_systemdato/100>fraamd) {
			fraamd = ws_systemdato/100;
		}
	}
	if (funk==2 && specialflag==0) {
		if (nuvamd == ws_systemdato / 10000) {
			fradato = ws_systemdato;
			tildato = nuvamd;
			tildato = (nuvamd * 10000);
			tildato += 1231;
		} else {
			fradato = nuvamd;
			fradato = (nuvamd * 10000);
			fradato += 101;
		}
		fraamd = fradato / 100;
		tilamd = tildato / 100;
	}
	if (funk==2 && specialflag==0 &&
		spcdgnrfra>20000000 &&
		spcdgnrtil>20000000) {
		fraamd = spcdgnrfra/100;
		tilamd = spcdgnrtil/100;
		if (logfil) {
			fprintf(logfil,
				"send_amdtabel:tilbud fra-tilamd=%ld-%ld\n",
				fraamd,
				tilamd);
			fprintf(logfil,
				"send_amdtabel:tilbud nuvamd=%ld\n",
				nuvamd);
			fflush(logfil);
		}
		if (nuvamd>fraamd/100) {
			fraamd = tilamd / 100;
			fraamd *= 100;
			fraamd += 1;
		}
		if (nuvamd<tilamd/100) {
			tilamd = fraamd / 100;
			tilamd *= 100;
			tilamd += 12;
		}
		if (logfil) {
			fprintf(logfil, "send_amdtabel:hertil tilamd=%ld\n",
				tilamd);
			fflush(logfil);
		}
	}
	if (funk==3 && specialflag==1) {
		fraamd = specialfradato;
		tilamd = specialtildato;
		if (ws_systemdato>fraamd) {
			fraamd = ws_systemdato;
		}
		if (nuvamd>fraamd/100) {
			fraamd = nuvamd;
			fraamd *= 100;
			fraamd += 01;
		}
		if (tilamd/100>nuvamd) {
			tildato = nuvamd;
			tildato *= 100;
			tildato += 1;
			returdato = m036_funktion(16, tildato);
			tilamd = nuvamd;
			tilamd *= 100;
			tilamd += (returdato%1000)/10;
		}
		lejevar = beregn_varighed(st,grp,spc,extspc);
	}
	if (funk==3 && specialflag==0) {
		if (nuvamd == ws_systemdato / 100) {
			fradato = ws_systemdato;
		} else {
			fradato = nuvamd;
			fradato *= 100;
			fradato += 01;
		}
		tildato = nuvamd;
		tildato *= 100;
		returdato = m036_funktion(16, fradato);
		tildato += (returdato%1000)/10;
		fraamd = fradato;
		tilamd = tildato;
		lejevar = beregn_varighed(st,grp,spc,extspc);
	}
	if (funk==3 &&
		specialflag==0 &&
		spcdgnrfra>20000000 &&
		spcdgnrtil>20000000) {
		tilamd = spcdgnrtil;
	}
	if (funk<4 && spcsmdgn>0) {
		tilamd = fraamd;
	}
	if (funk==4) {
		funkretur = check_bssaaben(-1,st,nuvamd,-1);
		if (funkretur<=0) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-1);
			pack_exchkend();
			send_linie();
			return;
		}
		(void)get_alfa_tgn(ws_alert_txt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &fraamd);
		}
		(void)get_alfa_tgn(ws_alert_txt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &tilamd);
		}
		funkretur = find_r198(1,16503,(double)spc,"",0);
		if (funkretur>0 && strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
			if (strlen(tmpstr)) {
				sscanf(tmpstr, "%ld", &fraamd);
			}
		}
/* timepriser beregn afhentning her */
		lejetimer = beregn_timeantal(st,grp,spc);
		if (lejetimer>0) {
			tilamd -= (lejetimer*100);
		}
	}
	if (logfil) {
		fprintf(logfil, "send_amdtabel:fraamd=%ld,tilamd=%ld\n",
			fraamd,
			tilamd);
		fflush(logfil);
	}
	returamd = fraamd;
	if (funk==3) {
		julian = m036_funktion(12, returamd);
	}
	while(returamd<=tilamd) {
		alfalow(str);
		pack_init(str);
		if (funk==1) {
			sprintf(tmpstr, "%ld", returamd);
		}
		if (funk==2) {
			sprintf(tmpstr, "%2.2ld", returamd%100);
			pack_alfa(tmpstr);
			sprintf(tmpstr, "måned %ld", returamd%100);
			if (returamd%100>=1 && returamd%100<=12) {
				sprintf(tmpstr, "%s", ws_mmtab[returamd%100]);
			}
			if (returamd%100>=1 && returamd%100<=12 &&
				strcmp(langstr,"DK")!=0 &&
				strcmp(langstr,"DA")!=0) {
				tmpnum = 10300;
				tmpnum += (returamd%100);
				trans_tekst(langstr,tmpnum,"",tmpstr);
			}
		}
		if (funk==3) {
/* NYT 041203 */
			sprintf(tmpstr,"%5.5hd%s",st,grp);
			funkretur = check_f198_dato(1,
				16589,(double)spc,tmpstr,returamd,returamd);
			if (funkretur>0) {
				returamd++;
				julian++;
				continue;
			}
/* NYT 060317 */
			sprintf(tmpstr,"");
			blokfundet = 0;
			funkretur = check_f198_dato(1,
				16625,(double)st,tmpstr,returamd,returamd);
/* CHECK */

			if (funkretur>0) {
				returamd++;
				julian++;
				continue;
			}
			funkretur = check_bssaaben(-1,st,returamd,-1);
			if (funkretur<=0) {
				returamd++;
				julian++;
				continue;
			}
/* TEST */
			if (logfil) {
				fprintf(logfil,
				"send_amdtabel:ws_alert_txt=%s\n",
					ws_alert_txt);
				fflush(logfil);
			}
/* NYT 040220 */
			strcpy(intstr[0],"");
			strcpy(intstr[1],"");
			aabenfra = 0;
			aabenfra = 2400;
			if (funkretur>0 && strlen(ws_alert_txt)) {
				(void)get_alfa_tgn(ws_alert_txt,
					0,intstr[0],';');
				(void)get_alfa_tgn(ws_alert_txt,
					1,intstr[1],';');
			}
			if (funkretur>0 && strlen(intstr[0])) {
				sscanf(intstr[0], "%ld", &aabenfra);
			}
			if (funkretur>0 && strlen(intstr[1])) {
				sscanf(intstr[1], "%ld", &aabentil);
			}
			if (aabenfra>=0 && aabentil<=2400 &&
				spcsttid>aabentil) {
				returamd++;
				julian++;
				continue;
			}
			if (aabenfra>=0 && aabentil<=2400 &&
				spcsttid<aabenfra) {
				returamd++;
				julian++;
				continue;
			}
			returdato = m036_funktion(19, julian+lejevar);
/* TEST */
			if (logfil) {
				fprintf(logfil,
				"send_amdtabel:returdato=%ld\n",
					returdato);
				fflush(logfil);
			}
			funkretur = check_bssaaben(-1,st,returdato,-1);
			if (funkretur<=0) {
				returamd++;
				julian++;
				continue;
			}
/* TEST */
			if (logfil) {
				fprintf(logfil,
				"send_amdtabel:ws_alert_txt=%s\n",
					ws_alert_txt);
				fflush(logfil);
			}
/* NYT 040220 */
			strcpy(intstr[0],"");
			strcpy(intstr[1],"");
			aabenfra = 0;
			aabenfra = 2400;
			if (funkretur>0 && strlen(ws_alert_txt)) {
				(void)get_alfa_tgn(ws_alert_txt,
					0,intstr[0],';');
				(void)get_alfa_tgn(ws_alert_txt,
					1,intstr[1],';');
			}
			if (funkretur>0 && strlen(intstr[0])) {
				sscanf(intstr[0], "%ld", &aabenfra);
			}
			if (funkretur>0 && strlen(intstr[1])) {
				sscanf(intstr[1], "%ld", &aabentil);
			}
			if (aabenfra>=0 && aabentil<=2400 &&
				spcsltid>aabentil) {
				returamd++;
				julian++;
				continue;
			}
			if (aabenfra>=0 && aabentil<=2400 &&
				spcsltid<aabenfra) {
				returamd++;
				julian++;
				continue;
			}
			sprintf(tmpstr, "%2.2ld", returamd%100);
			pack_alfa(tmpstr);
			returdato = m036_funktion(11, returamd);
			chkdgnr = returdato%10;
			if (spcdgnrfra>=1 &&
				spcdgnrfra<=7 &&
				spcdgnrtil>=1 &&
				spcdgnrtil<=7 &&
				(chkdgnr<spcdgnrfra||chkdgnr>spcdgnrtil)) {
				returamd++;
				julian++;
				continue;
			}
			if (spcdgnrfra==0 &&
				spcdgnrtil==0 &&
				spcdgnrtab[chkdgnr]==0) {
				returamd++;
				julian++;
				continue;
			}
/* RESSOURCER */
/* RETTET 040528 fra funk 1 */
			funkretur = check_ressourcer(CHKRESFUNK,
				st,
				grp,
				0,
				"",
				returamd,
				(long int)lejevar);
			if (funkretur<=0) {
				returamd++;
				julian++;
				continue;
			}
/* TEST */
			if (logfil) {
				fprintf(logfil,
		"send_amdtabel: OK returamd=%ld,returdato=%ld,chkdgnr=%ld\n",
					returamd,
					returdato,
					chkdgnr);
				fflush(logfil);
			}
			sprintf(tmpstr, "dag %ld", chkdgnr);
			if (chkdgnr>=1 && chkdgnr<=7) {
				sprintf(tmpstr, "%s", ws_ddtab[chkdgnr]);
			}
			if (chkdgnr>=1 && chkdgnr<=7 &&
				strcmp(langstr,"DK")!=0 &&
				strcmp(langstr,"DA")!=0) {
				tmpnum = 10000;
				tmpnum += chkdgnr;
				trans_tekst(langstr,tmpnum,"",tmpstr);
			}
		}
		if (funk==4) {
/* NYT 040322 */
			if (ws_systemdato==nuvamd &&
				returamd<=ws_systemtid) {
				returamd += 100;
				continue;
			}
			sprintf(tmpstr, "%2.2ld:%2.2ld",
				returamd/100,returamd%100);
		}
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (funk==4) {
			returamd += 100;
		} else {
			returamd++;
		}
		if (funk==3) {
			julian++;
		}
		returantal++;
	}
	if (logfil) {
		fprintf(logfil, "send_amdtabel:returantal=%hd",
			returantal);
		fflush(logfil);
	}
	if (returantal<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-1);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "send_amdtabel:str=%s",
				str);
			fflush(logfil);
		}
	}
	return;
}

/* ************************************************ */
static int check_don_specblok(short funk,short spcnr,short stnr,char *grp,long fra,long til) {
	short int retur = 0;
	short int chkstnr = 0;
	long int oplkode = 16571;
	long int inddtfra = 0;
	long int inddttil = 0;
	char tmpstr[81] = "";
	char chkgrp[5] = "";

	if (logfil) {
		fprintf(logfil,
		"check_don_specblok:funk=%hd,opl=%ld,stnr=%hd,spc=%hd,grp=%s\n",
			funk,
			oplkode,
			stnr,
			spcnr,
			grp);
		fprintf(logfil,
		"check_don_specblok:%ld-%ld\n",
			fra,
			til);
		fflush(logfil);
	}

	reclow(r198,R198);
	r198->oplkode = oplkode;
	r198->keynum = (double)spcnr;
	sprintf(r198->keyalfa,"%5.5hd%s",stnr,grp);
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		return(-1);
	}
	while (retur==0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
		if (r198->keynum!=spcnr) {
			break;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		strcpy(tmpstr,r198->keyalfa);
		strcpy(chkgrp,tmpstr+5);
		if (strcmp(chkgrp,"*")!=0 && strcmp(chkgrp,grp)!=0) {
			continue;
		}
		tmpstr[5] = '\0';
		sscanf(tmpstr,"%hd",&chkstnr);
		if (chkstnr!=0 && chkstnr!=stnr) {
			continue;
		}
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&inddtfra);
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&inddttil);
		}
		if (logfil) {
			fprintf(logfil,
			"\tfra-tildato=%ld-%ld %ld-%ld\n",
				r198->fradato,
				r198->tildato,
				inddtfra,
				inddttil);
		}
		if (fra>=r198->fradato && fra<=r198->tildato &&
			til>=inddtfra && til<=inddttil) {
			retur++;
		}
	}
	if (logfil) {
		fprintf(logfil,
			"check_don_specblok:retur=%hd\n",
			retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************ */
static int check_f198_dato(funk,oplkode,keynum,keyalfa,fra,til)
short int funk;
long int oplkode;
double keynum;
char * keyalfa;
long int fra;
long int til; {
	short int retur = 0;
	short int indcheck = 1;
	long int fradato = 0;
	long int tildato = 0;

	if (logfil) {
		fprintf(logfil,
			"check_f198_dato:funk=%hd,opl=%ld,key=%.0lf+%s\n",
			funk,
			oplkode,
			keynum,
			keyalfa);
	}
/* NYT 110527 SOMMER11
	if (oplkode==16589 && keynum==671 && til%10000>615 && til%10000<901) {
		indcheck = 0;
	}
	if (oplkode==16589 && keynum==672 && til%10000>615 && til%10000<901) {
		indcheck = 0;
	}
*/
	if (logfil) {
		fprintf(logfil,
			"check_f198_dato:%ld-%ld\n",
			fra,
			til);
		fflush(logfil);
	}
	reclow(r198,R198);
	r198->oplkode = oplkode;
	r198->keynum = keynum;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		return(-1);
	}
	while (retur==0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
		if (r198->keynum!=keynum) {
			break;
		}
/* NYT 110527 SOMMER11 */
		indcheck = 1;
		if (r198->numfelt==1) {
			indcheck = 0;
		}
		if (oplkode==16589) {
			fradato = 0;
			tildato = 0;
		}
		if (oplkode==16625) {
			fradato = r198->fradato;
			tildato = r198->tildato;
		}
		if (r198->fradato>fradato) {
			fradato = r198->fradato;
		}
		if (r198->tildato<99999999 && tildato==0) {
			tildato = r198->tildato;
		}
		if (r198->tildato<tildato) {
			tildato = r198->tildato;
		}
		if (fra>=fradato && fra<=tildato) {
			retur++;
		}
		if (indcheck>0 && til>=fradato && til<=tildato) {
			retur++;
		}
/* OBS RETTET 071124
		if (oplkode==16589 && fra<=fradato && til>=tildato) {
			retur++;
		}
*/
	}
	if (logfil) {
		fprintf(logfil,
		"check_f198_dato:fra-til=%ld-%ld,indcheck=%hd,retur=%hd\n",
			fradato,
			tildato,
			indcheck,
			retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************ */
static int check_f198_datointerval(funk,oplkode,keynum,keyalfa,fra,til)
short int funk;
long int oplkode;
double keynum;
char * keyalfa;
long int fra;
long int til; {
	short int retur = 0;
	short int fundet = 0;
	long int fradato = 0;
	long int tildato = 0;
	long int chkaar = 0;

	chkaar = fra/10000;
	if (logfil) {
		fprintf(logfil,
		"check_f198_datointerval:funk=%hd,opl=%ld,key=%.0lf+%s\n",
			funk,
			oplkode,
			keynum,
			keyalfa);
		fprintf(logfil,
		"check_f198_datointerval:%ld-%ld,chkaar=%ld\n",
			fra,
			til,
			chkaar);
		fflush(logfil);
	}
	reclow(r198,R198);
	r198->oplkode = oplkode;
	r198->keynum = keynum;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		return(-1);
	}
	while (retur==0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
		if (r198->keynum!=keynum) {
			break;
		}
		if (logfil) {
			fprintf(logfil,
			"\tfra-tildato=%ld-%ld\n",
				r198->fradato,
				r198->tildato);
		}
		if (oplkode==16585 &&
			chkaar != r198->fradato/10000) {
			continue;
		}
		fundet++;
		if (r198->fradato>fra && r198->tildato<til) {
			retur = 1;
		}
	}
	if (fundet<=0) {
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,
			"check_f198_datointerval:fundet=%hd,retur=%hd\n",
			fundet,
			retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************ */
static int check_don_tilbud(long varigh,short stnr,short spcnr,char *grp,short enh,long fra,long til,char *returstr) {
	short int retur = 0;
	short int fundet = 0;
	short int chkstnr = 0;
	short int minextdg = 0;
	short int maxextdg = 0;
	short int extspcnr = 0;
	short int extspcant = 0;
	short int rettdfra = 0;
	short int rettdtil = 0;
	short int ratedgantal = 0;
	short int minafldtflag = 0;
	long int oplkode = 16584;
	long int julian = 0;
	long int mindttil = 0;
	long int nydttil = 0;
	long int retdtfra = 0;
	long int retdttil = 0;
	long int extfra = 0;
	long int exttil = 0;
	long int extvarighed = 0;
	char tmpstr[81] = "";
	char chkgrp[5] = "";

	strcpy(returstr,"");
	if (enh==301) {
		ratedgantal = 7;
	}
	if (enh>200 && enh<299) {
		ratedgantal = enh % 200;
	}
	if (spcnr>=645 && spcnr<=649) {
		minafldtflag = 1;
	}

	if (logfil) {
		fprintf(logfil,
	"check_don_tilbud:varigh=%ld,stnr=%hd,spc=%hd,grp=%s,enh=%hd\n",
			varigh,
			stnr,
			spcnr,
			grp,
			enh);
		fprintf(logfil,
		"check_don_tilbud:%ld-%ld\n",
			fra,
			til);
		fprintf(logfil,
		"check_don_tilbud:ratedgantal=%hd,minaftdtflag=%hd\n",
			ratedgantal,
			minafldtflag);
		fflush(logfil);
	}

	reclow(r198,R198);
	r198->oplkode = oplkode;
	r198->keynum = (double)spcnr;
	sprintf(r198->keyalfa,"%5.5hd%s",stnr,grp);
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		return(-1);
	}
	while (retur==0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
		if (r198->keynum!=spcnr) {
			break;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		strcpy(tmpstr,r198->keyalfa);
		strcpy(chkgrp,tmpstr+5);
		if (strcmp(chkgrp,"*")!=0 && strcmp(chkgrp,grp)!=0) {
			continue;
		}
		tmpstr[5] = '\0';
		sscanf(tmpstr,"%hd",&chkstnr);
		if (chkstnr!=0 && chkstnr!=stnr) {
			continue;
		}
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&retdtfra);
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&retdttil);
		}
		(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&rettdfra);
		}
		(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&rettdtil);
		}
		mindttil = 0;
		minextdg = 0;
		maxextdg = 0;
		extspcnr = 0;
		extspcant = 0;
		(void)get_alfa_tgn(r198->alfafelt,4,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&minextdg);
		}
		(void)get_alfa_tgn(r198->alfafelt,5,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&maxextdg);
		}
		(void)get_alfa_tgn(r198->alfafelt,6,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&extspcnr);
		}
		if (logfil) {
			fprintf(logfil,
			"\tmin max extspcnr=%hd %hd %hd\n",
				minextdg,
				maxextdg,
				extspcnr);
		}

		if (minextdg>0 && varigh<minextdg) {
			extspcnr = 0;
			julian = m036_funktion(12, fra);
			julian += (long int)minextdg;
			mindttil = m036_funktion(19, julian);
		}
		if (maxextdg>0 && varigh>maxextdg) {
			extspcnr = 0;
		}
		if (logfil) {
			fprintf(logfil,
			"\tfra-tildato=%ld-%ld %s\n",
				r198->fradato,
				r198->tildato,
				r198->alfafelt);
			fprintf(logfil,
			"\tmin var max extspcnr=%hd %ld %hd %hd\n",
				minextdg,
				varigh,
				maxextdg,
				extspcnr);
		}
		if (fra>=r198->fradato && fra<=r198->tildato) {
			retur++;
		}
		if (retur>0 && varigh<minextdg && mindttil<=0) {
			retur = 0;
		}
/* NYT 110510 TILBUD */
		if (retur>0 && varigh>maxextdg && mindttil<=0) {
			retur = 0;
		}


		if (retur>0) {
			sprintf(returstr,"%ld;%ld;%hd;%hd",
				retdtfra,
				retdttil,
				rettdfra,
				rettdtil);
		}
/* NYT 091030 */
		if (retur>0 && varigh<minextdg && mindttil>0) {
			julian = m036_funktion(12, fra);
			julian += (long int)minextdg;
			nydttil = m036_funktion(19, julian);
			sprintf(returstr,"%ld;%ld;%hd;%hd",
				fra,
				nydttil,
				rettdfra,
				rettdtil);
			if (logfil) {
				fprintf(logfil, "\tJUST-1\n");
			}
		}
/* NYT 091102 */
		if (retur>0 && varigh==minextdg) {
			sprintf(returstr,"%ld;%ld;%hd;%hd",
				fra,
				til,
				rettdfra,
				rettdtil);
			if (logfil) {
				fprintf(logfil, "\tJUST-2\n");
			}
		}
/* NYT 091102 */
		if (retur>0 && varigh>minextdg && varigh<=maxextdg &&
			extspcnr>0) {
			extspcant = (short int)varigh;
			extspcant -= ratedgantal;
			extfra = fra;
			julian = m036_funktion(12, extfra);
			julian += (long int)varigh;
			exttil = m036_funktion(19, julian);
		}
		if (retur>0 && extspcnr>0 && extspcant>0) {
			retdttil = til;
			sprintf(returstr,"%ld;%ld;%hd;%hd;%hd;%hd",
				extfra,
				exttil,
				rettdfra,
				rettdtil,
				extspcnr,
				extspcant);
			if (logfil) {
				fprintf(logfil, "\tJUST-3\n");
			}
		}
/* NYT 110323 */
		if (retur>0 && minafldtflag>0 && til<retdtfra &&
			varigh>=minextdg && varigh<=maxextdg &&
			extspcnr>0) {
			extfra = fra;
			exttil = retdtfra;
			extvarighed = m036_funktion(12, exttil);
			julian = m036_funktion(12, extfra);
			extvarighed -= julian;
			extspcant = (short int)extvarighed;
			extspcant -= ratedgantal;
			sprintf(returstr,"%ld;%ld;%hd;%hd;%hd;%hd",
				extfra,
				exttil,
				rettdfra,
				rettdtil,
				extspcnr,
				extspcant);
			if (logfil) {
				fprintf(logfil, "\tJUST-4 %ld\n",extvarighed);
			}
			retur = 4;
		}
	}
	if (logfil) {
		fprintf(logfil,
			"check_don_tilbud:retur=%hd+%s\n",
			retur,
			returstr);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************ */
static int check_f198_per(short funk,short varighed,short stnr,char *grp,long fra,long til,char *returstr) {
	short int retur = 0;
	short int fundet = 0;
	short int chkvarfra = 0;
	short int chkvartil = 0;
	long int oplkode = 16581;
	char chkgrp[11] = "";
	char chkstr[41] = "";
	char tmpstr[41] = "";

	if (logfil) {
		fprintf(logfil,
	"check_f198_per:funk=%hd,stnr=%hd,var=%hd,grp=%s,fra-til=%ld-%ld\n",
			funk,
			stnr,
			varighed,
			grp,
			fra,
			til);
	}
	strcpy(returstr,"");
	reclow(r198,R198);
	r198->oplkode = oplkode;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		return(-1);
	}
	while (retur==0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
/*
		if (spcnr>0 && r198->keynum!=spcnr) {
			continue;
		}
*/
		strcpy(chkgrp,r198->keyalfa+5);
		if (strcmp(chkgrp,grp)!=0) {
			continue;
		}
		chkvarfra = 0;
		chkvartil = 999;
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			(void)get_alfa_tgn(tmpstr,0,chkstr,'-');
		}
		if (strlen(tmpstr) && strlen(chkstr)) {
			sscanf(chkstr,"%hd",&chkvarfra);
		}
		if (strlen(tmpstr)) {
			(void)get_alfa_tgn(tmpstr,1,chkstr,'-');
		}
		if (strlen(tmpstr) && strlen(chkstr)) {
			sscanf(chkstr,"%hd",&chkvartil);
		}
		if (varighed<chkvarfra) {
			continue;
		}
		if (varighed>chkvartil) {
			continue;
		}
		fundet++;
		if (r198->fradato<=fra && r198->tildato>=fra &&
			r198->fradato<=til && r198->tildato>=til) {
			retur = (short int)r198->keynum;
		}
		if (retur>0) {
			(void)get_alfa_tgn(r198->alfafelt,8,returstr,';');
		}
	}
	if (logfil) {
		fprintf(logfil,
			"check_f198_per:retur=%hd,fundet=%hd,returstr=%s\n",
			retur,
			fundet,
			returstr);
		fflush(logfil);
	}
	return(retur);
}

/* HLGTILBUD */
/* ************************************************ */
static int check_f198_hlgtilbud(short funk,char *hlgnavn,long varigh,short stnr,char *grp,long fra,long til,char *returstr) {
	short int retur = 0;
	short int fundet = 0;
	short int lntype = 0;
	long int oplkode = 16573;
	short int afhtid = 0;
	short int afltid = 0;
	short int paiflag = 0;
	short int cdiflag = 0;
	short int enhed = 0;
	short int spcantal = 0;
	long int inclkm = 0;
	long int periode = 0;
	double grundpris = 0;
	double tillpris = 0;
	double cdidag = 0;
	double paidag = 0;
	double extkmpris = 0;
	char navn[21] = "?";


	char chkgrp[11] = "";
	char tmpstr[41] = "";

	if (logfil) {
		fprintf(logfil,
"check_f198_hlgtilbud:%s,f=%hd,st=%hd,v=%ld,grp=%s,fra-til=%ld-%ld\n",
			hlgnavn,
			funk,
			stnr,
			varigh,
			grp,
			fra,
			til);
	}
	strcpy(returstr,"");

	reclow(r198,R198);
	r198->oplkode = oplkode;
	strcpy(r198->keyalfa,hlgnavn);
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		return(-1);
	}
	while (retur>=0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
		if (strncmp(r198->keyalfa,hlgnavn,strlen(hlgnavn))!=0) {
			break;
		}
		lntype = -2;
		if (r198->numfelt==0 || r198->numfelt==varigh) {
			lntype = -1;
		}
		if (lntype==-2) {
			continue;
		}
		strcpy(chkgrp,r198->keyalfa+strlen(hlgnavn));
/* TEST */
		if (logfil) {
			fprintf(logfil,
			"check_f198_hlgtilbud:FUNDET %s %.0lf cgrp=%s %s\n",
				r198->keyalfa,
				r198->numfelt,
				chkgrp,
				r198->alfafelt);
		}


		if (strcmp(chkgrp,"*")==0) {
			lntype = 0;
		}
		if (strcmp(chkgrp,grp)==0) {
			lntype = 1;
		}
/* TEST */
		if (logfil) {
			fprintf(logfil,
				"check_f198_hlgtilbud:FUNDET-1 lntype=%hd\n",
				lntype);
		}
		if (lntype<0) {
			continue;
		}
		if (lntype==0) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,59);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%hd",&afhtid);
			}
			(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,59);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%hd",&afltid);
			}
			(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,59);
			if (strcmp(tmpstr,"CDIPAIPAKKE")==0) {
				cdiflag = 2;
				paiflag = 2;
			}
			(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,59);
			if (strlen(tmpstr)) {
				strcpy(navn,tmpstr);
			}
		}
		if (lntype==1) {
			(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,59);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%lf",&grundpris);
			}
			(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,59);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%lf",&tillpris);
			}
			(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,59);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%lf",&cdidag);
			}
			(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,59);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%lf",&paidag);
			}
			(void)get_alfa_tgn(r198->alfafelt,4,tmpstr,59);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%lf",&extkmpris);
			}
			(void)get_alfa_tgn(r198->alfafelt,5,tmpstr,59);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%hd",&enhed);
			}
			(void)get_alfa_tgn(r198->alfafelt,6,tmpstr,59);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%ld",&inclkm);
			}
			(void)get_alfa_tgn(r198->alfafelt,7,tmpstr,59);
			if (strlen(tmpstr)) {
				sscanf(tmpstr,"%hd",&spcantal);
			}
			if (varigh==r198->numfelt) {
				periode = (long int)r198->numfelt;
				retur++;
			}
		}
	}
	if (retur>0 && funk==0) {
		sprintf(returstr,"%ld %ld %ld %hd %hd %hd",
				fra,
				til,
				periode,
				afhtid,
				afltid,
				cdiflag);
	}
	if (retur>0 && funk==1) {
		sprintf(returstr,
			"%.2lf %hd %hd %.2lf %.2lf %.2lf %ld %hd %hd %s",
				(grundpris+tillpris),
				enhed,
				spcantal,
				cdidag,
				paidag,
				extkmpris,
				inclkm,
				paiflag,
				cdiflag,
				navn);
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,"check_f198_hlgtilbud:RETUR retur=%hd str=%s\n",
			retur,returstr);
		fprintf(logfil,"\tafh-afl=%hd-%hd\n",afhtid,afltid);
		fprintf(logfil,"\tcdi-pai=%hd-%hd\n",cdiflag,paiflag);
		fprintf(logfil,"\tenhed=%hd\n",enhed);
		fprintf(logfil,"\tgrundp=%.2lf\n",grundpris);
		fprintf(logfil,"\ttillp=%.2lf\n",tillpris);
		fprintf(logfil,"\tpris cdi-pai=%.2lf-%.2lf\n",cdidag,paidag);
		fprintf(logfil,"\textkm=%.2lf\n",extkmpris);
		fprintf(logfil,"\tinclkm=%ld\n",inclkm);
	}

	return(retur);
}

/* **************************************************** */
/* funk 1 check parametre				*/
static int check_f198_hlghit(short funk,long varigh,short stnr,char *grp,long fra,long til,char *hlgnavn) {
	short int retur = 0;
	short int fundet = 0;
	short int okflag = 0;
	short int  minvar = 0;
	short int  maxvar = 0;
	short int  nuvhitscore = 0;
	short int  chkhitscore = 0;
	long int mininddt = 0;
	long int maxinddt = 0;
	long int oplkode = 16574;
	char chkgrp[11] = "";
	char chknavn[11] = "";
	char tmpstr[11] = "";


/* OBS HLGTILBUD HLGHIT KUN I TESTKREDS
	if (ws_testkreds<=0) {
		return(0);
	}
*/

	if (logfil) {
		fprintf(logfil,
"check_f198_hlghit:funk=%hd,stnr=%hd,varigh=%ld,grp=%s,fra-til=%ld-%ld\n",
			funk,
			stnr,
			varigh,
			grp,
			fra,
			til);
	}
	strcpy(hlgnavn,"");

	reclow(r198,R198);
	r198->oplkode = oplkode;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		return(-1);
	}
	while (retur>=0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		strcpy(chkgrp,r198->keyalfa+5);
		okflag = 0;
		if (strcmp(chkgrp,"*")==0) {
			okflag++;
		}
		if (strcmp(chkgrp,grp)==0) {
			okflag++;
		}
		if (okflag<=0) {
			continue;
		}
		(void)get_alfa_tgn(r198->alfafelt,0,chknavn,59);
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&minvar);
		}
		(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&maxvar);
		}
		(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&mininddt);
			if (mininddt>10000 && mininddt<999999) {
				mininddt += 20000000;
			}
		}
		(void)get_alfa_tgn(r198->alfafelt,4,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&maxinddt);
			if (maxinddt>10000 && maxinddt<999999) {
				maxinddt += 20000000;
			}
		}
		(void)get_alfa_tgn(r198->alfafelt,5,tmpstr,59);
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&chkhitscore);
		}
		if (logfil) {
			fprintf(logfil,
			"\t%s\n",chknavn);
			fprintf(logfil,
			"\tuddato=%ld-%ld,inddato=%ld-%ld\n",
				r198->fradato,r198->tildato,
				mininddt,maxinddt);
			fprintf(logfil,
			"\tmin,v,max=%hd,%hd,%hd,chkhitsc=%hd,nuvhtsc=%hd\n",
				minvar,varigh,maxvar,chkhitscore,nuvhitscore);
		}
		if (varigh<minvar) {
			continue;
		}
		if (varigh>maxvar) {
			continue;
		}
		if (chkhitscore<nuvhitscore) {
			continue;
		}
		if (r198->fradato<=fra && r198->tildato>=fra &&
			mininddt<=til && maxinddt>=til) {
			retur = (short int)r198->keynum;
			strcpy(hlgnavn,chknavn);
			nuvhitscore = chkhitscore;
			fundet++;
		}
/*
		if (r198->fradato<=til && r198->tildato>=til) {
			retur = (short int)r198->keynum;
			strcpy(hlgnavn,chknavn);
		}
*/
	}
	if (logfil) {
		fprintf(logfil,
			"check_f198_hlghit:retur=%hd,fundet=%hd,hlgnavn=%s\n",
			retur,
			fundet,
			hlgnavn);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************ */
static int check_f198_hlg(short funk,short spcnr,short stnr,char *grp,long fra,long til) {
	short int retur = 0;
	short int fundet = 0;
	long int oplkode = 16581;
	char chkgrp[11] = "";

	if (logfil) {
		fprintf(logfil,
	"check_f198_hlg:funk=%hd,stnr=%hd,spcnr=%hd,grp=%s,fra-til=%ld-%ld\n",
			funk,
			stnr,
			spcnr,
			grp,
			fra,
			til);
	}

	reclow(r198,R198);
	r198->oplkode = oplkode;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		return(-1);
	}
	while (retur==0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
		if (spcnr>0 && r198->keynum!=spcnr) {
			continue;
		}
		strcpy(chkgrp,r198->keyalfa+5);
		if (strcmp(chkgrp,grp)!=0) {
			continue;
		}
/*
		if (r198->keynum!=keynum) {
			break;
		}
*/
		fundet++;
		if (r198->fradato<=fra && r198->tildato>=fra) {
			retur = (short int)r198->keynum;
		}
		if (r198->fradato<=til && r198->tildato>=til) {
			retur = (short int)r198->keynum;
		}
	}
	if (logfil) {
		fprintf(logfil,
			"check_f198_hlg:retur=%hd,fundet=%hd\n",
			retur,
			fundet);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************ */
static int check_f198_hlgblok(short funk,short spcnr,short stnr,char *grp) {
	short int retur = 0;
	long int oplkode = 16626;
	char chkgrp[11] = "";

	reclow(r198,R198);
	r198->oplkode = oplkode;
	r198->keynum = stnr;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		return(-1);
	}
	while (retur==0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
		if (stnr>0 && r198->keynum!=stnr) {
			break;
		}
		if (spcnr>0 && r198->numfelt!=spcnr) {
			continue;
		}
		retur++;
	}
	if (logfil) {
		fprintf(logfil,
			"check_f198_hlgblok:retur=%hd\n",
			retur);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************ */
static int check_f198_udvhlg(short funk,short spcnr,short stnr,char *grp,long fra,long til,char *returstr) {
	short int retur = 0;
	short int fundet = 0;
	short int okflag = 0;
	long int oplkode = 16579;
	short int chkstnr = 0;
	long int kundevarighed = 0;
	long int returfradato = 0;
	long int returtildato = 0;
	long int returvarighed = 0;
	long int julian1 = 0;
	long int julian2 = 0;
	long int chkjulian = 0;
	long int chkdato = 0;
	long int skiftvarighed = 0;
	char chkgrp[11] = "";
	char tmpstr[81] = "";
	char tmpinterval[2][21] = {"",""};
	char tilbudtype[21] = "";
	char fundetstr[81] = "";
	long int fundetfra = 0;
	long int fundettil = 0;
	long int fundetblkfra = 0;
	long int fundetblktil = 0;
	long int fundetminvar = 0;
	long int fundetmaxvar = 0;

	strcpy(returstr,"");
	if (logfil) {
		fprintf(logfil,
"check_f198_udvhlg:funk=%hd,stnr=%hd,spcnr=%hd,grp=%s,fra-til=%ld-%ld\n",
			funk,
			stnr,
			spcnr,
			grp,
			fra,
			til);
	}

	reclow(r198,R198);
	r198->oplkode = oplkode;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		return(-1);
	}
	while (fundet>=0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
		if (spcnr>0 && r198->keynum!=spcnr) {
			continue;
		}
		strcpy(chkgrp,r198->keyalfa+5);
		if (strcmp(chkgrp,"*")!=0 && strcmp(chkgrp,grp)!=0) {
			continue;
		}
		strcpy(tmpstr,r198->keyalfa);
		tmpstr[5] = '\0';
		sscanf(tmpstr,"%hd",&chkstnr);
		if (chkstnr>0 && chkstnr!=stnr) {
			continue;
		}
		okflag = 0;
		if (r198->fradato<=fra && r198->tildato>=fra) {
			okflag++;
		}
		if (r198->fradato<=til && r198->tildato>=til) {
			okflag++;
		}
		if (okflag<=0) {
			continue;
		}
		fundet++;
		if (r198->numfelt>0) {
			strcpy(fundetstr,r198->alfafelt);
			fundetfra = r198->fradato;
			fundettil = r198->tildato;
		}
	}
	if (logfil) {
		fprintf(logfil,
			"check_f198_udvhlg:fundetstr=%s\n",
			fundetstr);
		fflush(logfil);
	}
	if (!strlen(fundetstr)) {
		return(0);
	}
	if (funk>0) {
		(void)get_alfa_tgn(fundetstr,funk-1,returstr,';');
		return(1);
	}
	retur = 0;
	julian1 = m036_funktion(12, fra);
	julian2 = m036_funktion(12, til);
	kundevarighed = julian2 - julian1;
	(void)get_alfa_tgn(fundetstr,0,tilbudtype,';');
	if (retur==0 && strcmp(tilbudtype,"FD")==0) {
		returfradato = fundetfra;
		returtildato = fundettil;
/*
		julian1 = m036_funktion(12, returfradato);
		julian2 = m036_funktion(12, returtildato);
		returvarighed = julian2-julian1;
*/
		retur = 1;
	}
	if (retur==0 && strcmp(tilbudtype,"UI")==0 && fra<fundetfra) {
		returfradato = fundetfra;
		julian1 = m036_funktion(12, returfradato);
		julian2 = julian1 + kundevarighed;
		returtildato = m036_funktion(19, julian2);
		returvarighed = julian2-julian1;
		retur = 2;
	}
	if (retur==0 && strcmp(tilbudtype,"UI")==0 && fra>=fundetfra) {
		returfradato = fra;
		julian1 = m036_funktion(12, returfradato);
		julian2 = julian1 + kundevarighed;
		returtildato = m036_funktion(19, julian2);
		returvarighed = julian2-julian1;
		retur = 2;
	}
	if (retur==0 && strcmp(tilbudtype,"II")==0 && til>fundettil) {
		returtildato = fundettil;
		julian2 = m036_funktion(12, returtildato);
		julian1 = julian2 - kundevarighed;
		returfradato = m036_funktion(19, julian1);
		returvarighed = julian2-julian1;
		retur = 3;
	}
	if (retur==0 && strcmp(tilbudtype,"II")==0 && til<=fundettil) {
		returtildato = til;
		julian2 = m036_funktion(12, returtildato);
		julian1 = julian2 - kundevarighed;
		returfradato = m036_funktion(19, julian1);
		returvarighed = julian2-julian1;
		retur = 3;
	}
	if (retur==0 && strcmp(tilbudtype,"UII")==0 && fra<fundetfra) {
		returfradato = fundetfra;
		julian1 = m036_funktion(12, returfradato);
		julian2 = julian1 + kundevarighed;
		returtildato = m036_funktion(19, julian2);
		returvarighed = julian2-julian1;
		retur = 4;
	}
	if (retur==0 && strcmp(tilbudtype,"UII")==0 && fra>=fundetfra) {
		returfradato = fra;
		julian1 = m036_funktion(12, returfradato);
		julian2 = julian1 + kundevarighed;
		returtildato = m036_funktion(19, julian2);
		returvarighed = julian2-julian1;
		retur = 4;
	}
	fundetmaxvar = 0;
	(void)get_alfa_tgn(fundetstr,2,tmpstr,';');
	if (strlen(tmpstr)) {
		sscanf(tmpstr,"%ld",&fundetmaxvar);
	}
	fundetminvar = 0;
	(void)get_alfa_tgn(fundetstr,3,tmpstr,';');
	if (strlen(tmpstr)) {
		sscanf(tmpstr,"%ld",&fundetminvar);
	}
	fundetblkfra = 0;
	fundetblktil = 0;
	(void)get_alfa_tgn(fundetstr,4,tmpstr,';');
	if (strlen(tmpstr)) {
		(void)get_alfa_tgn(tmpstr,0,tmpinterval[0],'-');
		(void)get_alfa_tgn(tmpstr,1,tmpinterval[1],'-');
	}
	if (strlen(tmpinterval[0])) {
		sscanf(tmpinterval[0],"%ld",&fundetblkfra);
	}
	if (strlen(tmpinterval[1])) {
		sscanf(tmpinterval[1],"%ld",&fundetblktil);
	}
	if (logfil) {
		fprintf(logfil,
	"check_f198_udvhlg:retur=%hd,returfra-tildato=%ld-%ld\n",
			retur,
			returfradato,
			returtildato);
		fprintf(logfil,
	"check_f198_udvhlg:fundetfra-til=%ld-%ld\n",
			fundetfra,
			fundettil);
		fprintf(logfil,
	"check_f198_udvhlg:fundet-maxvar=%ld,minvar=%ld,blkfra-til=%ld-%ld\n",
			fundetmaxvar,
			fundetminvar,
			fundetblkfra,
			fundetblktil);
		fflush(logfil);
	}
/* CHECK MINVARIGHED */
/* hvis returtildato = fundettil juster returfradato ned */
/* ellers juster returtildato op			*/
	okflag = 1;
	chkdato = returfradato;
	while (retur==4 && returtildato>=fundettil && okflag==1) {
		skiftvarighed = 0;
		julian1 = m036_funktion(12, chkdato);
		julian2 = m036_funktion(12, returtildato);
		chkjulian = julian2 - julian1;
		if (chkjulian<fundetminvar) {
			skiftvarighed = -1;
		}
		julian1 += skiftvarighed;
		chkdato = m036_funktion(19, julian1);
		if (chkdato<fundetfra) {
			okflag = -1;
		}
		if (skiftvarighed==0) {
			okflag = 2;
		}
	}
	if (okflag>0) {
		returfradato = chkdato;
	}
	if (logfil) {
		fprintf(logfil,
	"check_f198_udvhlg:HERTIL-1=okflag=%hd,returfra-tildato=%ld-%ld\n",
			okflag,
			returfradato,
			returtildato);
		fflush(logfil);
	}
	if (retur==4 && okflag<0) {
		returfradato = fundetblkfra;
		returtildato = fundetblktil;
		ws_headeridx = 1;
		okflag = 1;
		goto udvhlg_exit;
	}
	okflag = 1;
	chkdato = returtildato;
	while (retur==4 && returtildato<fundettil && okflag==1) {
		skiftvarighed = 0;
		julian1 = m036_funktion(12, returfradato);
		julian2 = m036_funktion(12, chkdato);
		chkjulian = julian2 - julian1;
		if (chkjulian<fundetminvar) {
			skiftvarighed = 1;
		}
		julian2 += skiftvarighed;
		chkdato = m036_funktion(19, julian2);
		if (chkdato>fundettil) {
			okflag = -1;
		}
		if (skiftvarighed==0) {
			okflag = 2;
		}
	}
	if (okflag>0) {
		returtildato = chkdato;
	}
	if (logfil) {
		fprintf(logfil,
	"check_f198_udvhlg:HERTIL-2=okflag=%hd,returfra-tildato=%ld-%ld\n",
			okflag,
			returfradato,
			returtildato);
		fflush(logfil);
	}
	if (retur==4 && okflag<0) {
/*
		returfradato = fundetblkfra;
		returtildato = fundetblktil;
*/
		julian1 = m036_funktion(12, returtildato);
		julian1 -= fundetminvar;
		returfradato = m036_funktion(19, julian1);
/* EVT indføre okigen og goto check igen */
		ws_headeridx = 1;
		okflag = 1;
		goto udvhlg_exit;
	}
/* UII CHECK BLOKIND */
	okflag = 1;
	chkdato = returtildato;
	while (retur==4 && okflag==1) {
		skiftvarighed = 0;
		if (chkdato>fundetblkfra &&
			chkdato<fundetblktil) {
			skiftvarighed = 1;
		}
		chkjulian = m036_funktion(12, chkdato);
		chkjulian += skiftvarighed;
		chkdato = m036_funktion(19, chkjulian);
		if (chkdato>fundettil) {
			okflag = -1;
		}
		if (skiftvarighed==0) {
			okflag = 2;
		}
	}
	if (okflag>0) {
		returtildato = chkdato;
	}
	if (logfil) {
		fprintf(logfil,
	"check_f198_udvhlg:HERTIL-3=okflag=%hd,returfra-tildato=%ld-%ld\n",
			okflag,
			returfradato,
			returtildato);
		fflush(logfil);
	}
	if (retur==4 && okflag<0) {
		returfradato = fundetblkfra;
		returtildato = fundetblktil;
		ws_headeridx = 1;
		okflag = 1;
		goto udvhlg_exit;
	}
/* UII CHECK FUNDETTIL */
	okflag = 1;
	if (retur==4 && returtildato>fundettil) {
		okflag = -1;
	}
	if (logfil) {
		fprintf(logfil,
	"check_f198_udvhlg:HERTIL-4=okflag=%hd,returfra-tildato=%ld-%ld\n",
			okflag,
			returfradato,
			returtildato);
		fflush(logfil);
	}
	if (retur==4 && okflag<0) {
		returfradato = fundetblkfra;
		returtildato = fundetblktil;
		ws_headeridx = 1;
		okflag = 1;
/*
		retur = 0;
*/
		goto udvhlg_exit;
	}
/* UII CHECK FUNDETFRA */
	okflag = 1;
	if (retur==4 && returfradato<fundetfra) {
		okflag = -1;
	}
	if (logfil) {
		fprintf(logfil,
	"check_f198_udvhlg:HERTIL-5=okflag=%hd,returfra-tildato=%ld-%ld\n",
			okflag,
			returfradato,
			returtildato);
		fflush(logfil);
	}
	if (retur==4 && okflag<0) {
/*
		returfradato = fundetblkfra;
		returtildato = fundetblktil;
		ws_headeridx = 1;
		okflag = 1;
*/
		retur = 0;
		goto udvhlg_exit;
	}

	if (logfil) {
		fprintf(logfil,
	"check_f198_udvhlg:HERTIL-X=okflag=%hd,returfra-tildato=%ld-%ld\n",
			okflag,
			returfradato,
			returtildato);
		fflush(logfil);
	}
udvhlg_exit:
	if (retur>0 && okflag>0) {
		julian1 = m036_funktion(12, returfradato);
		julian2 = m036_funktion(12, returtildato);
		sprintf(returstr,"%ld %ld %ld",
			returfradato,
			returtildato,
			julian2-julian1);
		ws_headeridx = 1;
	}
	if (ws_headeridx>0 &&
		(fra>fundetblktil || til<fundetblkfra)) {
		ws_headeridx = 0;
	}	
	if (logfil) {
		fprintf(logfil,
		"check_f198_udvhlg:ws_headeridx=%hd,retur=%hd,returstr=%s\n",
			ws_headeridx,
			retur,
			returstr);
		fflush(logfil);
	}
	return(retur);
}

/* ************************************************ */
static int check_f198_spcstgrpblok(short funk,short spcnr,short stnr,char *grp,long fra,long til) {
	short int retur = 0;
	short int fundet = 0;
	short int okflag = 0;
	short int chkstnr = 0;
	long int oplkode = 16578;
	char chkgrp[11] = "";
	char tmpstr[81] = "";

	reclow(r198,R198);
	r198->oplkode = oplkode;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		return(-1);
	}
	while (fundet>=0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
		if (spcnr>0 && r198->keynum!=spcnr) {
			continue;
		}
		strcpy(chkgrp,r198->keyalfa+5);
		if (strcmp(chkgrp,"*")!=0 && strcmp(chkgrp,grp)!=0) {
			continue;
		}
		strcpy(tmpstr,r198->keyalfa);
		tmpstr[5] = '\0';
		sscanf(tmpstr,"%hd",&chkstnr);
		if (chkstnr>0 && chkstnr!=stnr) {
			continue;
		}
		okflag = 0;
		if (r198->fradato<=fra && r198->tildato>=fra) {
			okflag++;
		}
		if (okflag<=0) {
			continue;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		fundet++;
	}
	if (fundet>0) {
		retur++;
	}
	return(retur);
}

/* ************************************************ */
static int check_f198_spcafhtid(short funk,short spcnr,short stnr,char *grp) {
	short int retur = -1;
	short int chkstnr = 0;
	long int oplkode = 16572;
	char chkgrp[11] = "";
	char tmpstr[81] = "";

	reclow(r198,R198);
	r198->oplkode = oplkode;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		return(-1);
	}
	while (retur>=-1) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
		if (spcnr>0 && r198->keynum!=spcnr) {
			continue;
		}
		strcpy(chkgrp,r198->keyalfa+5);
		if (strcmp(chkgrp,"*")!=0 && strcmp(chkgrp,grp)!=0) {
			continue;
		}
		strcpy(tmpstr,r198->keyalfa);
		tmpstr[5] = '\0';
		sscanf(tmpstr,"%hd",&chkstnr);
		if (chkstnr>0 && chkstnr!=stnr) {
			continue;
		}
		retur = (short int)r198->numfelt;
	}
	if (logfil) {
		fprintf(logfil,"check_f198_spcafhtid:retur=%hd\n",retur);
	}
	return(retur);
}

/* ********************************* */
static void check_amdspec(funk,langstr,st,grp,spc,extspc,nuvamd,nuvtid)
short int funk;
char * langstr;
short int st;
char * grp;
short int spc; 
char * extspc;
long int nuvamd;
long int nuvtid; {
	short int funkretur;
	short int smdgn = 0;
	long int returdato;
	long int dgantal;
	long int julian;
	long int fraamd;
	long int tilamd;
	long int afltid;
	long int tmantal;
	long int tmpnum;
	char transstr[21] = "";
	char f198key[21] = "";
	char tmpstr[81] = "";
	char udvstr[81] = "";

	if (logfil) {
		fprintf(logfil,
"check_amdspec:funk=%hd,st=%hd,grp=%s,spc=%hd,extspc=%s,nuvamd=%ld,nuvtid=%ld\n",
		funk,
		st,
		grp,
		spc,
		extspc,
		nuvamd,
		nuvtid);
	}
	fraamd = nuvamd;
	funkretur = check_bssaaben(-1,st,fraamd,-1);
	if (funkretur<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-2);
		pack_exchkend();
		send_linie();
		return;
	}

	dgantal = beregn_varighed(st,grp,spc,extspc);
	if (dgantal<0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-3);
		pack_exchkend();
		send_linie();
		return;
	}

	julian = m036_funktion(12, fraamd);
	julian += dgantal;
	tilamd = m036_funktion(19, julian);
	if (logfil) {
		fprintf(logfil, "check_amdspec:tilamd=%ld\n",
			tilamd);
		fflush(logfil);
	}
	funkretur = check_bssaaben(-1,st,tilamd,-1);
	if (funkretur<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-1);
		pack_exchkend();
		send_linie();
		return;
	}
	alfalow(str);
	pack_init(str);
	pack_int2((long)tilamd/10000);
/* RETTET 20040127
	pack_int2((long)(tilamd%10000)/100);
*/
	sprintf(tmpstr, "%2.2ld",(tilamd%10000)/100);
	pack_alfa(tmpstr);
	if ((tilamd%10000)/100>=1 && (tilamd%10000)/100<=12) {
		sprintf(tmpstr, "%s", ws_mmtab[(tilamd%10000)/100]);
/* ENG */
		if (strcmp(langstr,"DK")!=0 &&
			strcmp(langstr,"DA")!=0) {
			tmpnum = 10300;
			tmpnum += ((tilamd%10000)/100);
			trans_tekst(langstr,tmpnum,"",tmpstr);
		}
	} else {
		sprintf(tmpstr, "måned %ld", (tilamd%10000)/100);
	}
	pack_alfa(tmpstr);
	sprintf(tmpstr, "%2.2ld", tilamd%100);
	pack_alfa(tmpstr);
	returdato = m036_funktion(11, tilamd);
	if (returdato%10>=1 && returdato%10<=7) {
		sprintf(tmpstr, "%s", ws_ddtab[returdato%10]);
/* ENG */
		if (strcmp(langstr,"DK")!=0 &&
			strcmp(langstr,"DA")!=0) {
			tmpnum = 10000;
			tmpnum += (returdato%10);
			trans_tekst(langstr,tmpnum,"",tmpstr);
		}
	} else {
		sprintf(tmpstr, "dag %ld", returdato%10);
	}
	pack_alfa(tmpstr);
	afltid = 0;
	funkretur = find_r198(1,16503,(double)r165->spec_nr,"",0);
	if (funkretur>0 && strlen(r198->alfafelt)) {
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%hd", &smdgn);
		}
		(void)get_alfa_tgn(r198->alfafelt,5,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &afltid);
		}
/* NYT 041001 */
		strcpy(udvstr,"");
		sprintf(f198key, "%3.3hd%3.3hd%s",
			st,
			spc,
			grp);
		strcpy(r198->alfafelt,"");
		if (find_r198(0,16527,(double)0,f198key,0)>0 &&
			strlen(r198->alfafelt)) {
			(void)get_alfa_tgn(r198->alfafelt,1,udvstr,';');
		}
		if (strlen(udvstr)) {
			sscanf(udvstr, "%hd", &smdgn);
		}
	}
/* check for timepriser */
	if (smdgn>0 && r165->enhed<200 && r165->enhed>100) {
		tmantal = (long int)(r165->enhed - 100);
		afltid = nuvtid;
		afltid += (long int)(tmantal*100);
	}
	sprintf(tmpstr, "%2.2ld:%2.2ld", afltid/100,afltid%100);
	pack_alfa(tmpstr);
	ege_w_dou1 = r159->total;
	pack_doub(ege_w_dou1);
	if (strcmp(langstr,"DK")==0 ||
		strcmp(langstr,"DA")==0) {
		strcpy(tmpstr, r165->tekst_1);
	} else {
		sprintf(transstr, "%5.5ld%5.5hd",
			16507,r165->spec_nr);
		trans_tekst(langstr,0,transstr,tmpstr);
	}
	pack_alfa(tmpstr);
	pack_int2((long)r159->rate_incl_km[10]);
	pack_doub(r159->rate_ekstra_km[10]);
	ege_w_dou2 = r159->pai_ialt;
	pack_doub((double)ege_w_dou2);

/* DEPOSITUM */
	ege_w_dou1 = 1500;
	funkretur = find_r198(1,16608,(double)st,"",0);
	if (funkretur>0 && r198->numfelt>0) {
		ege_w_dou1 = r198->numfelt;
	}
/* NYT 051013 */
	tmpnum = (long int)spc;
	tmpnum *= 1000;
	tmpnum += (long int)st;
	funkretur = find_r198(1,16523,(double)tmpnum,"",0);
	if (funkretur>0 && r198->numfelt>0) {
		ege_w_dou1 = r198->numfelt;
	}
	if (logfil) {
		fprintf(logfil, "check_amdspec:DEPOSITUM=%.0lf",
			ege_w_dou1);
		fflush(logfil);
	}

	pack_doub(ege_w_dou1);
	pack_exchkend();
	send_linie();
	if (logfil) {
		fprintf(logfil, "check_amdspec:str=%s",
			str);
		fflush(logfil);
	}
	return;
}

/* ******************************************* */
static int weekend_komp(short st,char *grp,short spc,char *extspc) {
	short int retur = 0;

	if (logfil) {
		fprintf(logfil,
		"weekend_komp:st=%hd,grp=%s,spc=%hd,extspc=%s\n",
		st,
		grp,
		spc,
		extspc);
		fflush(logfil);
	}
	reclow(r165, R165);
	f165_start(1, ISGTEQ);
	r165->spec_nr = spc;
	r165->stat_nr = st;
	strcpy(r165->bil_grp, grp);
	egeread(f165, ISEQUAL);
	if (f165_ukendt) {
		return(-1);
	}
	if (r165->enhed > 500 &&
		r165->enhed < 600) {
		retur = (r165->enhed - 500);
	}
	if (logfil) {
		fprintf(logfil, "weekend_komp:retur=%hd\n",
			retur);
		fflush(logfil);
	}
	return(retur);
}

/* ******************************************* */
static int beregn_varighed(st,grp,spc,extspc)
short int st;
char * grp;
short int spc; 
char * extspc; {
	short int funkretur = 0;
	int dgantal = 0;
	int xlsprisflag = 0;
	int xlsmainflag = 0;
	int xlsweekendflag = 0;
	long int returdato = 0;
	long int julian = 0;
	long int chkantaldg = 0;
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil,
		"beregn_varighed:st=%hd,grp=%s,spc=%hd,extspc=%s\n",
		st,
		grp,
		spc,
		extspc);
	}
	reclow(r165, R165);
	f165_start(1, ISGTEQ);
/* NYT 140218 XLSPRIS */
	if (spc==800) {
		xlsprisflag = 1;
		r165->enhed = 201;
	}
	if (spc==801) {
		xlsprisflag = 1;
		r165->enhed = 201;
	}
/* NYT 141114 PSGLNYKATALOG */
	if (spc>=830 && spc<=839) {
		xlsprisflag = 1;
		r165->enhed = 201;
	}
/* NYT 150216 PSPAASKE */
	if (spc==847) {
		xlsprisflag = 1;
		r165->enhed = 201;
	}

	if (xlsprisflag>0) {
		goto videre;
	}

	r165->spec_nr = spc;
	r165->stat_nr = st;
	strcpy(r165->bil_grp, grp);
	egeread(f165, ISEQUAL);
	if (f165_ukendt) {
		return(-1);
	}
	if (r165->enhed > 200 &&
		r165->enhed < 300) {
		dgantal = (r165->enhed - 200);
		dgantal *= 1;
	}
	if (r165->enhed > 300 &&
		r165->enhed < 400) {
		dgantal = (r165->enhed - 300);
		dgantal *= 7;
	}
	if (r165->enhed > 400 &&
		r165->enhed < 500) {
		dgantal = (r165->enhed - 400);
		dgantal *= 30;
	}
	if (r165->enhed > 500 &&
		r165->enhed < 600) {
		dgantal = (r165->enhed - 500);
		dgantal *= 2;
	}
videre:
	strcpy(tmpstr, "");
	if (strlen(extspc)) {
		(void)get_alfa_tgn(extspc,1,tmpstr,'x');
	}
	funkretur = 0;
	if (strlen(tmpstr)) {
		sscanf(tmpstr, "%hd", &funkretur);
	}
/* NYT 130123 FYRAFTENEXTRA */
	strcpy(tmpstr, "");
	if (strlen(extspc)) {
		(void)get_alfa_tgn(extspc,0,tmpstr,'x');
	}
	if (strlen(tmpstr) && strcmp(tmpstr,"180")==0 && funkretur==1) {
		funkretur = 1;
	}
	if (strlen(tmpstr) && strcmp(tmpstr,"181")==0 && funkretur==1) {
		funkretur = 2;
	}
	if (strlen(tmpstr) && strcmp(tmpstr,"182")==0 && funkretur==1) {
		funkretur = 3;
	}
	if (strlen(tmpstr) && strcmp(tmpstr,"183")==0 && funkretur==1) {
		funkretur = 4;
	}
	if (strlen(tmpstr) && strcmp(tmpstr,"184")==0 && funkretur==1) {
		funkretur = 5;
	}
	if (strlen(tmpstr) && strcmp(tmpstr,"666")==0 && funkretur==1) {
		funkretur = 6;
	}
/* NYT 131211 PSVARIGHED */
	xlsweekendflag = 0;
	if (ws_brandtype==4 && spc==801 && ws_fradato>0 && ws_tildato>0) {
		xlsweekendflag++;
	}
	if (ws_brandtype==4 && spc==832 && ws_fradato>0 && ws_tildato>0) {
		xlsweekendflag++;
	}
	if (ws_brandtype==4 && spc==833 && ws_fradato>0 && ws_tildato>0) {
		xlsweekendflag++;
	}
	if (ws_brandtype==4 && spc==837 && ws_fradato>0 && ws_tildato>0) {
		xlsweekendflag++;
	}
	if (ws_brandtype==4 && spc==838 && ws_fradato>0 && ws_tildato>0) {
		xlsweekendflag++;
	}
	if (ws_brandtype==4 && xlsweekendflag>0) {
		julian = m036_funktion(12, ws_fradato);
		chkantaldg = m036_funktion(12, ws_tildato);
		chkantaldg -= julian;
		dgantal = (int)chkantaldg;
	}

/* RETTET 141114 PSGLNYKATALOG 
	if (ws_brandtype==4 && spc==801 && ws_fradato>0 && ws_tildato>0) {
		julian = m036_funktion(12, ws_fradato);
		chkantaldg = m036_funktion(12, ws_tildato);
		chkantaldg -= julian;
		dgantal = (int)chkantaldg;
	}
*/


/* NYT 140218 XLSPRIS */
	if (ws_brandtype==4 && xlsprisflag>0 &&
		ws_fradato>0 && ws_tildato>0) {
		julian = m036_funktion(12, ws_fradato);
		chkantaldg = m036_funktion(12, ws_tildato);
		chkantaldg -= julian;
		dgantal = (int)chkantaldg;
	}
/* NYT 140725 PSWEEKENDMATCH */
	if (ws_brandtype==4 && xlsprisflag>0 &&
		ws_altfradato>0 && ws_alttildato>0) {
		julian = m036_funktion(12, ws_altfradato);
		chkantaldg = m036_funktion(12, ws_alttildato);
		chkantaldg -= julian;
		dgantal = (int)chkantaldg;
	}
	dgantal += (long int)funkretur;
/* NYT 141010 PSWEEKENDVARIGHEDSNYD */
	if (ws_brandtype==4 && xlsprisflag>0) {
		sprintf(tmpstr,"PS%5.5hd%5.5hdSTD.main",
			st,
			spc);
		xlsmainflag = xlspris_udpakmain(tmpstr);
	}
	if (logfil) {
		fprintf(logfil,"\txlsmainflag=%d\n",xlsmainflag);
	}
	if (xlsmainflag>0 && dgantal<xlsprismain->varighed_ival[0]) {
		dgantal = (int)xlsprismain->varighed_ival[0];
	}
	if (logfil) {
		fprintf(logfil,"\txlsweekendflag=%d\n",
			xlsweekendflag);
		fprintf(logfil,"beregn_varighed:dgantal=%d\n",
			dgantal);
		fflush(logfil);
	}
	return(dgantal);
}

/* ******************************************* */
static int beregn_timeantal(st,grp,spc)
short int st;
char * grp;
short int spc; {
	short int funkretur = 0;
	int tmantal = 0;

	if (logfil) {
		fprintf(logfil,
		"beregn_timeantal:st=%hd,grp=%s,spc=%hd\n",
		st,
		grp,
		spc);
		fflush(logfil);
	}
	reclow(r165, R165);
	f165_start(1, ISGTEQ);
	r165->spec_nr = spc;
	r165->stat_nr = st;
	strcpy(r165->bil_grp, grp);
	egeread(f165, ISEQUAL);
	if (f165_ukendt) {
		return(-1);
	}
	if (r165->enhed > 100 &&
		r165->enhed < 200) {
		tmantal = (r165->enhed - 100);
		tmantal *= 1;
	}
	if (logfil) {
		fprintf(logfil, "beregn_timeantal:tmantal=%d\n",
			tmantal);
		fflush(logfil);
	}
	return(tmantal);
}

/* ******************************* */
static int find_tid_fra_til(short st,char * grp,short spc,char * extspc,long * ftid,long * ttid) {
	short int retur = 0;
	short int funkretur = 0;
	long int chknum = 0;
	char tmpstr[41];
	*ftid = (long int)800;
	*ttid = (long int)800;

	funkretur = find_r198(1,16503,(double)spc,"",0);
        if (funkretur>0 && get_alfa_tgn(r198->alfafelt,3,tmpstr,';')>0) {
                sscanf(tmpstr, "%ld", &chknum);
		*ftid = chknum;
		retur++;
        }
        if (funkretur>0 && get_alfa_tgn(r198->alfafelt,5,tmpstr,';')>0) {
                sscanf(tmpstr, "%ld", &chknum);
		*ttid = chknum;
		retur++;
        }
	return(retur);
}

/* ******************************* */
static void send_lastmedl(funk,knr)
short int funk;
long int knr; {
	short int retur = 0;
	char tmpstr[81];

	if (logfil) {
		fprintf(logfil, "send_lastmedl:funk=%hd,knr=%ld\n",
			funk,
			knr);
		fflush(logfil);
	}
	reclow(r159, R159);
	r159->lejerkundenr = knr+1;
	f159_start(10, ISGTEQ);
	if (f159_ukendt) {
		f159_start(1, ISLAST);
		if (f159_ukendt) {
			retur = -1;
		}
	}
	if (logfil) {
		fprintf(logfil, "send_lastmedl:HERTIL\n");
		fflush(logfil);
	}
	while (retur==0) {
		egeread(f159, ISPREV);
		if (f159_eof) {
			break;
		}
		if (r159->lejerkundenr!=knr) {
			break;
		}
		if (logfil) {
			fprintf(logfil, "send_lastmedl:record_x=%ld\n",
				r159->record_x);
			fflush(logfil);
		}
		if (!strlen(r159->medlfornavn)) {
			continue;
		}
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil, "send_lastmedl:retur=%hd\n",
			retur);
		fflush(logfil);
	}
	alfalow(str);
	pack_init(str);
	if (retur<=0) {
		pack_alfa("");
		pack_alfa("");
		pack_alfa("00000000");
		pack_alfa("");
	} else {
		pack_alfa(r159->medlfornavn);
		pack_alfa(r159->medlefternavn);
		sprintf(tmpstr, "%8.8ld", r159->medlfoedselsdato);
		pack_alfa(tmpstr);
		pack_alfa(r159->medlkkortnr);
	}
	pack_exchkend();
	send_linie();
	return;
}

/* ******************************* */
static void check_betaling(funk,knr,spc)
short int funk;
long int knr;
short int spc; {
	short int retur = 0;
	char tmpstr[81];

	if (logfil) {
		fprintf(logfil, "check_betaling:funk=%hd,knr=%ld,spc=%hd\n",
			funk,
			knr,
			spc);
		fflush(logfil);
	}
	alfalow(str);
	pack_init(str);
	pack_int2((long)0);
	pack_exchkend();
	send_linie();
	return;
}

/* ********************** */
static int nyopret_reservation(short funk,short sendflag,short ecflag) {
	short int dondafolo = 0;
	short int ecwflag = 0;
	short int wx1 = 0;
	short int paraidx = 0;
	short int nextlinie = 1;
	char extragrp[5] = "";
	short int udldkaltiata = 0;
	short int udldkfrgspg = 0;
	short int weekendflag = 0;
	short int extrastnr = 0;
	short int extraantal = 0;
	short int extraspecnr = 0;
	short int extraidx = 0;
	short int specnr = 0;
	short int funkretur = 0;
	short int medlok = 0;
	short int lejerok = 0;
	short int firmaok = 0;
	short int aftaleflag = 0;
	short int resstnr = 0;
	short int resstud = 0;
	short int fatalnrfejl = 0;
	short int produktdatotidstyr = 0;
	int dagnr = 0;
	long int nuvnotelbnr = 0;
	long int nextnotelbnr = 0;
	long int chknum = 0;
	long int resnr = 0;
	long int dgnindtid = 0;
	long int julian = 0;
	long int varighed = 0;
	long int altvarighed = 0;
	long int timeantal = 0;
	long int returdato = 0;
	long int nuvdato = 0;
	long int firmakundenr = 0;
	long int firmaaftfra = 0;
	long int firmaafttil = 0;
	long int lejerfdato = 0;
	long int kundeinddato = 0;
	long int kundeindtid = 0;
	long int lejeralder = 0;
	long int minalder = 23;
	long int grpminalder = 23;
	long int gwkundeid = 0;
	long int lejerkundenr = 0;
	long int medlkundenr = 0;
	short int perprisretur = 0;
	short int pjretur = 0;
	short int hpretur = 0;
	short int htretur = 0;
	short int nypaiflag = 0;
	short int nycdiflag = 0;
	short int nyenhed = 0;
	long int nyantal = 0;
	long int nyinclkm = 0;
	double nypris = 0;
	double nycdidg = 0;
	double nypaidg = 0;
	double nyextkm = 0;
	double depositum = 0;
	double donextradep = 0;
	double promoprisned = 0;

	double totalpris = 0;
	char tmpstr[81] = "";
	char rekvstr[81] = "";
	char nynavn[81] = "";

	tmpfil = (FILE*)0;
	if (strcmp(ws_grp,"C")==0) {
		grpminalder = 26;
	}
/* NYT 081013 D=26 */
	if (strcmp(ws_grp,"D")==0) {
		grpminalder = 26;
	}
	if (strcmp(ws_grp,"F")==0) {
		grpminalder = 23;
	}
	if (strcmp(ws_grp,"G")==0) {
		grpminalder = 26;
	}

/* TEST */
	sprintf(dum_str,
	"nyopret_res:funk=%hd,send=%hd,ec=%hd,%s,%hd,%s,%hd,%s,%ld,%hd,%ld",
		funk,
		sendflag,
		ecflag,
		ws_langstr,
		ws_station,
		ws_grp,
		ws_specnr,
		ws_extspcstr,
		ws_fradato,
		ws_paiflag,
		ws_kundenr);
	logfil_put(dum_str);
	sprintf(dum_str,
	"nyopret_res:ws_donsaesonflag=%hd",
		ws_donsaesonflag);
	logfil_put(dum_str);
	sprintf(dum_str, "nyopret_res:ws_udldkland=%s", ws_udldkland);
	logfil_put(dum_str);
/* TEST 20110808 */
	sprintf(dum_str, "\tTID1 ws_fratid=%ld ws_tiltid=%ld",
		ws_fratid,
		ws_tiltid);
	logfil_put(dum_str);
	sprintf(dum_str, "\tws_altfratid=%ld ws_alttiltid=%ld",
		ws_altfratid,
		ws_alttiltid);
	logfil_put(dum_str);
/* NYT 120427 ECDØGNPRISER */
	ws_dgnprisflag = 0;
	if (ecflag==1) {
		reclow(r198,R198);
		f198_start(1,ISGTEQ);
		r198->oplkode = 16666;
		r198->keynum = (double)ws_station;
		egeread(f198,ISEQUAL);
	}
	if (ecflag==1 && f198_ok && r198->numfelt>0) {
		ws_dgnprisflag = 1;
	}
	sprintf(dum_str, "\tws_dgnprisflag=%hd",
		ws_dgnprisflag);
	logfil_put(dum_str);
/* NYT 120427 */
	if (ecflag==1 && ws_dgnprisflag>0 && ws_specnr==672) {
		ws_altfratid = ws_fratid;
		ws_alttiltid = ws_tiltid;
	}
	sprintf(dum_str, "\tALTTID1ws_altfratid=%ld ws_alttiltid=%ld",
		ws_altfratid,
		ws_alttiltid);
	logfil_put(dum_str);

/* NYT 070328 */
	if (ecflag==0 && ws_funktion>=300) {
		dondafolo = 1;
	}
/* NYT 121018 */
	if (ecflag==0 && ws_funktion>0) {
		dondafolo = 1;
	}
/* NYT 150623 */
	if (ecflag==1 && ws_funktion>=24 && ws_funktion<=50) { ecwflag = 1; }
	if (ecflag==0 && ws_funktion>=24 && ws_funktion<=50) { ecwflag = 1; }
	if (logfil) {
		fprintf(logfil,"\tdondafolo=%hd\n",dondafolo);
		fprintf(logfil,"\tecwflag=%hd\n",ecwflag);
	}
/* REKV 081104 */
	if (funk==1 && ecflag==0 && dondafolo==0) {
		get_alfa(rekvstr);
	}
	if (funk==1 && ecflag==0 && dondafolo>0) {
		strcpy(rekvstr,ws_donrekvstr);
	}

	sprintf(dum_str, "nyopret_reservation:rekvstr=%s", rekvstr);
	logfil_put(dum_str);
	sprintf(dum_str, "nyopret_reservation:ws_udldkflag=%hd", ws_udldkflag);
	logfil_put(dum_str);
	if (funk==1 && ecflag==1 &&
		ws_kundenr>=10000000 &&
		ws_kundenr<=99999999) {
		gwkundeid = ws_kundenr;
		reclow(r167, R167);
		r167->gw_id = gwkundeid;
		f167_start(11, ISGTEQ);
		if (f167_ukendt) {
			gwkundeid = 0;
		}
	}
	while (funk==1 && ecflag==1 && gwkundeid>0) {
		egeread(f167, ISNEXT);
		if (f167_eof) {
			break;
		}
		if (r167->gw_id!=gwkundeid) {
			break;
		}
		if (r167->type!=1) {
			continue;
		}
		if (check_sy_kundenr(r167->kunde_nr)>0) {
			continue;
		}
		ws_kundenr = r167->kunde_nr;
		break;
	}

/* AFTALEFLAG */
	if (ws_kundenr>0) {
		reclow(r167, R167);
		f167_start(1, ISGTEQ);
		r167->kunde_nr = ws_kundenr;
		egeread(f167, ISEQUAL);
/* NYT 121108 */
		if (f167_ok && r167->type==1) {
			lejerkundenr = r167->kunde_nr;
		}
/*
		if (f167_ok && r167->type==1 && r167->firma_reference>0) {
			firmakundenr = r167->firma_reference;
		}
*/
		if (f167_ok && r167->type==2) {
			firmakundenr = r167->kunde_nr;
		}
	}
/* OBS DAFOLO 342 KUNDENR */
	if (dondafolo==1 &&
		ws_funktion==342 &&
		ws_kundenr<=0 && ws_aftalenr>0) {
		firmakundenr = ws_aftalenr;
	}
	if (firmakundenr>0) {
		if (find_r178(0,16,0,(double)firmakundenr)>0) {
			firmaaftfra = (long int)r178->num_felt;
		}
		if (find_r178(0,4,0,(double)firmakundenr)>0) {
			firmaafttil = (long int)r178->num_felt;
		}
		if (firmaafttil==0) {
			firmaafttil = 99999999;
		}
        }
	if (firmakundenr>0 &&
		firmaaftfra>0 &&
		ws_systemdato>=firmaaftfra && ws_systemdato<=firmaafttil) {
		aftaleflag = 1;
	}
	if (logfil) {
		fprintf(logfil,"\taftaleflag=%hd\n",aftaleflag);
	}
/* NYT 110323 HLGAFTALEBLOK */
	if (firmakundenr>0 &&
		aftaleflag>0 && 
		check_hlg_firmaaft_blok(1,ws_fradato,ws_tildato)>0) {
		aftaleflag = 0;
	}
/* NYT 130306 DATOAFTBLOK */
	if (firmakundenr>0 &&
		aftaleflag>0 && 
		check_grp_firmaaft_blok(1,ws_fradato,ws_tildato,ws_grp)>0) {
		aftaleflag = 0;
	}
	if (logfil) {
		fprintf(logfil,"nyopret_res:lejerkundenr=%ld\n",lejerkundenr);
		fprintf(logfil,"nyopret_res:firmakundenr=%ld\n",firmakundenr);
	}
/* TEST */
	sprintf(dum_str, "nyopret_res:aft=%ld-%ld aftaleflag=%hd",
		firmaaftfra,
		firmaafttil,
		aftaleflag);
	logfil_put(dum_str);

/* NYT 040127 */
	reclow(r167, R167);
	r167->kunde_nr = ws_kundenr;
	if (funk==1 && ws_kundenr>0) {
		egeread(f167, ISEQUAL);
	}
/* NYT 150623 WEBAPI31 */
	if (ecwflag>0 && ws_kundenr>0) {
		egeread(f167, ISEQUAL);
	}
	if (funk==1 && ws_kundenr>0 && f167_ukendt) {
		if (sendflag && ecflag==0) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)0);
			pack_alfa("KUNDEUKENDT");
			pack_exchkend();
			send_linie();
		}
		if (sendflag && ecflag==1) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-16);
			web_errormess(0,ws_langstr,"16");
/* RETTET 061206	pack_alfa("KUNDEUKENDT"); */
			pack_exchkend();
			send_linie();
		}
		return(0);
	}
	if (funk==1 && ws_kundenr>0 && ecflag==1 &&
		f167_ok && check_sy_kundenr(r167->kunde_nr)>0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-16);
		web_errormess(0,ws_langstr,"16");
/*
		pack_alfa("KUNDEUKENDT");
*/
		pack_exchkend();
		send_linie();
		return(0);
	}
/* NYT 121109 DON2FIRMALEJER */
	if (logfil) {
		fprintf(logfil,"nyopret_res:ws_medlknr=%ld\n",ws_medlknr);
		fprintf(logfil,"nyopret_res:ws_lejerknr=%ld\n",ws_lejerknr);
		fprintf(logfil,"nyopret_res:ws_medlknr=%ld\n",ws_medlknr);
	}

	if (funk==1 && ecflag==0 && lejerkundenr>0) {
		lejerok = 1;
	}
	if (funk==1 && ecflag==0 && lejerkundenr<=0 && ws_lejerknr>0) {
		reclow(r167, R167);
		f167_start(1,ISGTEQ);
		r167->kunde_nr = ws_lejerknr;
		egeread(f167, ISEQUAL);
	}
	if (funk==1 && ecflag==0 && lejerkundenr<=0 && ws_lejerknr>0 &&
		f167_ok) {
		lejerok = 1;
		lejerkundenr = ws_lejerknr;
	}
	if (logfil) {
		fprintf(logfil,"nyopret_res:LEJEROPL1 lejerok=%hd %ld\n",
			lejerok,
			lejerkundenr);
	}
	if (funk==1 && ecflag==1 && ws_kundenr>0 && f167_ok) {
		lejerok = 1;
	}
/* NYT 150623 WEBAPI31 */
	if (ecwflag>0 && ecflag==1 && ws_kundenr>0 && f167_ok) {
		lejerok = 1;
	}
	if (funk==1 && lejerok==1 && ecflag==1) {
		lejerfdato = 0;
		if (strlen(ws_paratab[9])) {
			sscanf(ws_paratab[9], "%ld", &lejerfdato);
		}
/* TEST */
		sprintf(dum_str, "nyopret_res:lejerfdato=%ld",
			lejerfdato);
		logfil_put(dum_str);

/* OBS 090330 */
		if (lejerfdato!=r167->foedselsdato && ws_udldkflag==0) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-16);
			web_errormess(0,ws_langstr,"16");
/* RETTET 061206
			pack_alfa("KUNDEFDATOUKENDT");
*/
			pack_exchkend();
			send_linie();
			return(0);
		}
	}
	if (funk==1 && lejerok!=1 && ecflag==1) {
		lejerfdato = 0;
		if (strlen(ws_paratab[9])) {
			sscanf(ws_paratab[9], "%ld", &lejerfdato);
		}
	}
/* NYT 060227 CHECK ALDER */
	if (funk==1 && ecflag==1 && lejerfdato>0) {
		lejeralder = ws_systemdato - lejerfdato;
		lejeralder /= 10000;
/* TEST */
		sprintf(dum_str, "nyopret_res:lejeralder=%ld",
			lejeralder);
		logfil_put(dum_str);
	}
/* TEST */
	sprintf(dum_str, "nyopret_res:minalder=%ld",
		minalder);
	logfil_put(dum_str);
	sprintf(dum_str, "nyopret_res:grpminalder=%ld",
		grpminalder);
	logfil_put(dum_str);

	if (funk==1 &&
		ecflag==1 &&
		lejerfdato>0 &&
		lejeralder>0 &&
		lejeralder<minalder) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-33);
		web_errormess(0,ws_langstr,"33");
/* RETTET 061206
		pack_alfa("ALDERIKKEOK");
*/
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil,"SENDT=%s\n",str);
			fflush(logfil);
		}
		return(0);
	}
	if (funk==1 &&
		ecflag==1 &&
		lejerfdato>0 &&
		lejeralder>0 &&
		lejeralder<grpminalder) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-25);
		web_errormess(0,ws_langstr,"25");
/* RETTET 061206
		pack_alfa("ALDERIKKEOK2");
*/
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil,"SENDT=%s\n",str);
			fflush(logfil);
		}
		return(0);
	}
	resstnr = ws_station;
	resstud = ws_station;
	reclow(r198,R198);
	if (funk==1 && ecflag==1) {
		funkretur = find_r198(1,16624,(double)ws_station,"",0);
	}
	if (funk==1 && ecflag==1 && funkretur>0 &&
		r198->numfelt>0) {
		resstnr = (short int)r198->numfelt;
	}
	if (funk==1 && ecflag==1 && funkretur>0 &&
		strncmp(r198->alfafelt,"StUdNr=",7)==0) {
		sscanf(r198->alfafelt+7,"%hd",&resstud);
	}
	if (funk==1 && ecflag==1) {
		resstnr = 84;
	}
/* NYT 090331 UDLDK */
	if (funk==1 && ecflag==1 && ws_udldkflag>0) {
		resstnr = 82;
	}
/* NYT 120413 TXBCBOOK */
	if (funk==1 && ecflag==1 && ws_udldkflag==2) {
		resstnr = 88;
	}
	if (funk==1 && ecflag==1 && ws_udldkflag==3) {
		resstnr = 87;
	}

/* TEST */
	sprintf(dum_str, "nyopret_res:resstnr=%hd,resstud=%hd,ws_paiflag=%hd",
		resstnr,resstud,ws_paiflag);
	logfil_put(dum_str);
/* NYT 130124 KONTROLGODK */
	ege_w_int1 = 0;
	if (funk==1 && ecflag==0) {
		ege_w_int1 = check_don_wgk(0);
	}
	if (funk==1 && ecflag==0 && ege_w_int1>0) {
		ws_resnr = ege_w_int1;
	}
	if (logfil) {
		fprintf(logfil,"\tKONTROLGODK\n");
		fprintf(logfil,"\tws_resnr=%ld\n",ws_resnr);
		fprintf(logfil,"\tege_w_int1=%ld\n",ege_w_int1);
	}
/* nyt nummer */
	if (funk==1 && ws_resnr<=0) {
		resnr = resnrfind(resstnr);
	}
	if (funk==1 && ws_resnr>0) {
		resnr = ws_resnr;
	}
/* FATAL NYT NR */
	if (funk==1 && resnr<=20000000) {
		fatalnrfejl = 2;
	}
	if (funk==1 && resnr>29999999) {
		fatalnrfejl = 2;
	}
	if (funk==1 && resnr<=0) {
		fatalnrfejl = 1;
	}
	sprintf(dum_str, "nyopret_res:ws_resnr=%ld,resnr=%ld,fatalnrfejl=%hd",
		ws_resnr,
		resnr,
		fatalnrfejl);
	logfil_put(dum_str);


/* EVT TEST BETA */
	if (funk==1 && fatalnrfejl>0) {
		sprintf(dum_str,"%sfatalnr.log",ws_kreds);
		tmpfil = fopen(dum_str,"a");
	}
	if (funk==1 && fatalnrfejl>0 && tmpfil) {
		fprintf(tmpfil,"resnrfind %ld %ld %ld\n",
			ege_date(),ege_time(),resnr);
		fprintf(tmpfil,"%s\n",str);
		fclose(tmpfil);
	}
	if (funk==1 && fatalnrfejl>0) {
		tmpfil = (FILE*)0;
	}

	if (funk==1 && fatalnrfejl>0) {
		if (sendflag && ecflag==0 && dondafolo==0) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)0);
			pack_exchkend();
			send_linie();
		}
		if (sendflag && ecflag==0 && dondafolo==1) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-315);
			web_errormess(0,ws_langstr,"315");
			pack_exchkend();
			send_linie();
		}
		if (sendflag && ecflag==1) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-4);
			web_errormess(0,ws_langstr,"4");
			pack_exchkend();
			send_linie();
		}
		return(0);
	}
/* TEST */
	sprintf(dum_str, "resnr=%ld", resnr);
	logfil_put(dum_str);

	if (ecwflag<=0) {
		reclow(r159, R159);
		r159->record_x = resnr;
		r159->status = 2;
		r159->kontrakttype_kode = 3;
	}
	strcpy(r159->bil_grp, ws_grp);

/* station ud ind */
	reclow(r166, R166);
	r166->stat_nr = ws_station;
	if (ecflag==1) {
		r166->stat_nr = resstud;
	}
	egeread(f166, ISEQUAL);
	if (f166_ok && ecflag==0) {
		r159->station_ud_nr = r166->stat_nr;
		strcpy(r159->station_ud_navn, r166->navn);
		strcpy(r159->station_ud_adr, r166->adr);
		strcpy(r159->station_ud_postkode, r166->postkode);
		strcpy(r159->station_ud_by, r166->by);
		strcpy(r159->station_ud_land, r166->land);
		strcpy(r159->station_ud_tlf, r166->tlf);

		r159->station_ind_nr = r166->stat_nr;
		strcpy(r159->station_ind_navn, r166->navn);
		strcpy(r159->station_ind_adr, r166->adr);
		strcpy(r159->station_ind_postkode, r166->postkode);
		strcpy(r159->station_ind_by, r166->by);
		strcpy(r159->station_ind_land, r166->land);
		strcpy(r159->station_ind_tlf, r166->tlf);
	}
	if (f166_ukendt && ecflag==1 && sendflag) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-5);
		web_errormess(0,ws_langstr,"5");
		pack_exchkend();
		send_linie();
		return(0);
	}
	if (f166_ok && ecflag==1) {
		r159->station_ud_nr = r166->stat_nr;
		strcpy(r159->station_ud_navn, r166->navn);
		strcpy(r159->station_ud_adr, r166->adr);
/* OBS BORNHOLM */
		if (ws_station==10) {
			strcpy(r159->station_ud_navn, "LUFTHAVN");
			strcpy(r159->station_ud_adr, "BORNHOLM LUFTHAVN");
		}
		strcpy(r159->station_ud_postkode, r166->postkode);
		strcpy(r159->station_ud_by, r166->by);
		strcpy(r159->station_ud_land, r166->land);
		strcpy(r159->station_ud_tlf, r166->tlf);
	}
	if (ecflag==1) {
		r166->stat_nr = ws_tilstation;
		egeread(f166, ISEQUAL);
	}
	if (f166_ukendt && ecflag==1 && sendflag) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-6);
		web_errormess(0,ws_langstr,"6");
		pack_exchkend();
		send_linie();
		return(0);
	}
	if (f166_ok && ecflag==1) {
		r159->station_ind_nr = r166->stat_nr;
		strcpy(r159->station_ind_navn, r166->navn);
		strcpy(r159->station_ind_adr, r166->adr);
		strcpy(r159->station_ind_postkode, r166->postkode);
		strcpy(r159->station_ind_by, r166->by);
		strcpy(r159->station_ind_land, r166->land);
		strcpy(r159->station_ind_tlf, r166->tlf);
	}

/* forsikring */
	r159->forsikring_cdw = 1;
	if (ws_paiflag) {
		r159->forsikring_pai = 1;
	}
/* NYT 150623 WEBAPI31 MAKE */
	if (ecwflag>0) {
		r159->forsikring_cdw = 0;
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,"\tforsikring_pai=%hd\n",r159->forsikring_pai);
		fprintf(logfil,"\tforsikring_cdw=%hd\n",r159->forsikring_cdw);
	}
/* dato */
	if (logfil) {
		fprintf(logfil,
			"\tNYOPRETRES_DATO ws_fradato=%ld ws_tildato=%ld\n",
			ws_fradato,
			ws_tildato);
		fprintf(logfil,
			"\t\tws_altfradato=%ld ws_alttildato=%ld\n",
			ws_altfradato,
			ws_alttildato);
	}
	r159->dato_ud = ws_fradato;
	if (ecflag==1 && ws_altfradato>0) {
		r159->dato_ud = ws_altfradato;
	}
	if (ecflag==0) {
		julian = m036_funktion(12, ws_fradato);
/* NYT 140725 PSWEEKENDMATCH */
		if (ws_brandtype==4 && ws_altfradato>0) {
			julian = m036_funktion(12, ws_altfradato);
		}
		varighed = beregn_varighed(ws_station,
			ws_grp,
			ws_specnr,
			ws_extspcstr);
		julian += varighed;
		ws_tildato = m036_funktion(19, julian);
		r159->forv_dato_ind = ws_tildato;
	}
/* NYT 141022 PSWEEKENDMATCH 801 832 833 837 838 */
	produktdatotidstyr = 0;
	if (ecflag==0 && ws_brandtype==4 && ws_altfradato>0 && ws_specnr==801){
		produktdatotidstyr = 1;
	}
	if (ecflag==0 && ws_brandtype==4 && ws_altfradato>0 && ws_specnr==832){
		produktdatotidstyr = 1;
	}
	if (ecflag==0 && ws_brandtype==4 && ws_altfradato>0 && ws_specnr==833){
		produktdatotidstyr = 1;
	}
	if (ecflag==0 && ws_brandtype==4 && ws_altfradato>0 && ws_specnr==837){
		produktdatotidstyr = 1;
	}
	if (ecflag==0 && ws_brandtype==4 && ws_altfradato>0 && ws_specnr==838){
		produktdatotidstyr = 1;
	}
	if (produktdatotidstyr>0) {
		returdato = m036_funktion(11, ws_fradato);
		dagnr = (int)(returdato%10);
	}
	if (produktdatotidstyr>0 && dagnr==6) {
		r159->dato_ud = ws_altfradato;
	}
	if (produktdatotidstyr>0 && dagnr==7) {
		r159->dato_ud = ws_altfradato;
	}
	if (logfil) {
		fprintf(logfil,"\t\tproduktdatotidstyr=%hd\n",
			produktdatotidstyr);
		fprintf(logfil,"\t\tdagnr=%d\n",
			dagnr);
		fprintf(logfil,"\t\tdato_ud=%ld forv_dato_ind=%ld\n",
			r159->dato_ud,
			r159->forv_dato_ind);
	}

/* NYT 140513 PSSENEREAFLTID */
	if (ecflag==0 && ws_psextradag>0) {
		varighed++;
	}

	if (ecflag==1 && ws_udldkflag<=0 && ws_alttildato==0) {
		julian = m036_funktion(12, ws_tildato);
		varighed = julian - m036_funktion(12,r159->dato_ud);
		if (varighed<=0) {
			varighed = 1;
		}
		r159->forv_dato_ind = ws_tildato;
	}
	if (ecflag==1 && ws_udldkflag<=0 && ws_alttildato>0) {
		julian = m036_funktion(12, ws_alttildato);
		varighed = julian - m036_funktion(12,r159->dato_ud);
		if (varighed<=0) {
			varighed = 1;
		}
		r159->forv_dato_ind = ws_alttildato;
	}
	if (ecflag==1 && ws_udldkflag>0) {
		julian = m036_funktion(12, ws_fradato);
		varighed = (long int)(m036_funktion(12, ws_tildato)-julian);
/* UDLDKDØGNPRISER 090402 */
        	dgnindtid = ws_fratid;
        	dgnindtid += 100;
        	if (ws_tiltid>dgnindtid && ws_tildato>ws_fradato) {
			varighed++;
		}
		if (ws_tildato==ws_fradato) {
			varighed++;
		}
		r159->forv_dato_ind = ws_tildato;
	}
	if (logfil) {
		fprintf(logfil,"\tTID01 dato_ud=%ld forv_dato_ind=%ld\n",
			r159->dato_ud,
			r159->forv_dato_ind);
	}

/* NYT 081118 HLGTILBUD alternativt ALTPRISDATA */
	if (funk==1 && sendflag==1 && ecflag==1 && ws_udldkflag<=0) {
		funkretur = check_f198_hlghit(1,varighed,
			ws_station,ws_grp,ws_fradato,ws_tildato,tmpstr);
	}
	if (funk==1 && sendflag==1 && ecflag==1 && funkretur==ws_specnr) {
		strcpy(ws_hlgtilbud,tmpstr);
	}

/* tid */
/* TEST 20110721 */
	sprintf(dum_str, "\tTID2 ws_fratid=%ld ws_tiltid=%ld",
		ws_fratid,
		ws_tiltid);
	logfil_put(dum_str);
	sprintf(dum_str, "\tws_altfratid=%ld ws_alttiltid=%ld",
		ws_altfratid,
		ws_alttiltid);
	logfil_put(dum_str);
	sprintf(dum_str, "\t159->tid_ud=%ld r159->forv_tid_ind=%ld",
		r159->tid_ud,
		r159->forv_tid_ind);
	logfil_put(dum_str);
	if (logfil) {
		fprintf(logfil,"\tdato_ud=%ld tid_ud=%ld\n",
			r159->dato_ud,r159->tid_ud);
		fprintf(logfil,"\tforv_dato_ind=%ld forv_tid_ind=%ld\n",
			r159->forv_dato_ind,
			r159->forv_tid_ind);

		fprintf(logfil,"\tvarighed=%ld\n",varighed);
		fprintf(logfil,"\tws_psextradag=%d\n",ws_psextradag);
	}

	r159->tid_ud = ws_fratid;
	if (ecflag==1 && ws_altfratid>0) {
		r159->tid_ud = ws_altfratid;
	}
/* NYT 140724 PSWEEKENDMATCH */
	if (ws_brandtype==4 && ws_specnr==800 && ws_altfratid>0) {
		r159->tid_ud = ws_altfratid;
	}
	if (ws_brandtype==4 && ws_specnr==801 && ws_altfratid>0) {
		r159->tid_ud = ws_altfratid;
	}
	if (ws_brandtype==4 && ws_specnr==801 && ws_alttiltid>0) {
		chknum = ws_alttiltid;
	}
/* NYT 141117 PSGLNYKATALOG */
	if (ws_brandtype==4 && ws_specnr==832 && ws_altfratid>0) {
		r159->tid_ud = ws_altfratid;
	}
	if (ws_brandtype==4 && ws_specnr==833 && ws_altfratid>0) {
		r159->tid_ud = ws_altfratid;
	}
	if (ws_brandtype==4 && ws_specnr==837 && ws_altfratid>0) {
		r159->tid_ud = ws_altfratid;
	}
	if (ws_brandtype==4 && ws_specnr==838 && ws_altfratid>0) {
		r159->tid_ud = ws_altfratid;
	}

	if (ws_brandtype==4 && ws_specnr==832 && ws_alttiltid>0) {
		chknum = ws_alttiltid;
	}
	if (ws_brandtype==4 && ws_specnr==833 && ws_alttiltid>0) {
		chknum = ws_alttiltid;
	}
	if (ws_brandtype==4 && ws_specnr==837 && ws_alttiltid>0) {
		chknum = ws_alttiltid;
	}
	if (ws_brandtype==4 && ws_specnr==838 && ws_alttiltid>0) {
		chknum = ws_alttiltid;
	}

	chknum = 0;
	funkretur = find_r198(1,16503,(double)ws_specnr,"",0);
	if (funkretur>0 && get_alfa_tgn(r198->alfafelt,5,tmpstr,';')>0) {
		sscanf(tmpstr, "%ld", &chknum);
	}
/* NYT 140526 PSAFLTID */
	if (ws_brandtype==4 && ws_funktion==10) {
		chknum = ws_tiltid;
	}


/* NYT 120427 ECDØGNPRISER */
	if (ecflag==1 && ws_dgnprisflag>0) {
		chknum = ws_fratid;
	}

	if (ecflag==0) {
		r159->forv_tid_ind = chknum;
/* timepriser beregn afltid her */
		timeantal = beregn_timeantal(ws_station,ws_grp,ws_specnr);
		if (timeantal>0) {
			r159->forv_tid_ind = r159->tid_ud;
			r159->forv_tid_ind += (timeantal*100);
		}
	}
	if (ecflag==1 && ws_alttiltid==0) {
		r159->forv_tid_ind = ws_tiltid;
	}
	if (ecflag==1 && ws_alttiltid>0) {
		r159->forv_tid_ind = ws_alttiltid;
	}
/* TEST 20110721 */
	sprintf(dum_str, "\t159->tid_ud=%ld r159->forv_tid_ind=%ld",
		r159->tid_ud,
		r159->forv_tid_ind);
	logfil_put(dum_str);
/* UDLDK TID */
	if (ecflag==1 && ws_udldkflag>0 && ws_specnr==227) {
		weekendflag = 1;
	}
	if (ecflag==1 && ws_udldkflag==2 && ws_specnr==110) {
		weekendflag = 1;
	}
	if (ecflag==1 && ws_udldkflag==3 && ws_specnr==112) {
		weekendflag = 1;
	}
/* NYT 150623 WEBAPI31 */
	if (ecwflag>0) { goto nyopr20; }

/* NYT 090924 */
	if (ecflag==1 && ws_udldkflag>0) {
		ws_udldkjul=udldk_checkjul(ws_fradato,
			ws_tildato,
			weekendflag,
			varighed);
	}
/* TEST */
	sprintf(dum_str,
		"nyopret_res:chknum=%ld forv_tid_ind=%ld, weekendflag=%hd",
		chknum, r159->forv_tid_ind,weekendflag);
	logfil_put(dum_str);
	sprintf(dum_str,
		"nyopret_res:ws_udldkjul=%hd ecflag=%hd", ws_udldkjul,ecflag);
	logfil_put(dum_str);

	if (ecflag==1 && ws_udldkflag<=0) {
/* afl overskridelse checkes her */
/* check for ws_hlgtilbud */
		if (r159->forv_tid_ind>chknum &&
			r159->dato_ud!=r159->forv_dato_ind &&
			r159->forv_dato_ind==ws_tildato &&
			!strlen(ws_hlgtilbud)) {
			kundeinddato = r159->forv_dato_ind;
			kundeindtid = r159->forv_tid_ind;
			r159->forv_tid_ind = chknum;
			varighed++;
			julian = m036_funktion(12, r159->dato_ud);
			julian += varighed;
			r159->forv_dato_ind = m036_funktion(19, julian);
		}
	}
nyopr10:

/* NYT 110808 SOMMERAFLTID */
	wx1 = 0;
	if (ws_specnr==674) { wx1++; }
	if (ws_specnr==675) { wx1++; }
	if (ws_specnr==676) { wx1++; }
	if (ws_specnr==677) { wx1++; }
	if (ws_specnr==678) { wx1++; }
	if (ecflag==1 && ws_udldkflag<=0 &&
		r159->forv_tid_ind>chknum &&
		r159->dato_ud!=r159->forv_dato_ind &&
		r159->forv_dato_ind==ws_tildato &&
		!strlen(ws_hlgtilbud) &&
		wx1>0) {
		kundeinddato = r159->forv_dato_ind;
		kundeindtid = r159->forv_tid_ind;
		r159->forv_tid_ind = chknum;
		varighed++;
		julian = m036_funktion(12, r159->dato_ud);
		julian += varighed;
		r159->forv_dato_ind = m036_funktion(19, julian);
	}

nyopr20:
/* NYT 080221 */
	if (funk==0 && sendflag==0 && ecflag==1 &&
		ws_maxspcperiode>0 && varighed>ws_maxspcperiode) {
		return(0);
	}

	udregn_tid();

/* TEST */
	sprintf(dum_str, "nyopret_res:ws_hlgtilbud=%s",
		ws_hlgtilbud);
	logfil_put(dum_str);
	sprintf(dum_str, "nyopret_res:dato_ud=%ld tid_ud=%ld",
		r159->dato_ud, r159->tid_ud);
	logfil_put(dum_str);
	sprintf(dum_str, "nyopret_res:forv_dato_ind=%ld forv_tid_ind=%ld",
		r159->forv_dato_ind, r159->forv_tid_ind);
	logfil_put(dum_str);
	sprintf(dum_str,
		"nyopret_res:antal tm=%ld,dg=%ld,ug=%ld,md=%ld",
		r159->antal_timer,
		r159->antal_dage,
		r159->antal_uger,
		r159->antal_maaneder);
	logfil_put(dum_str);
	if (logfil) {
		fprintf(logfil,"nyopret_res:lejerok=%hd %ld\n",
			lejerok,
			lejerkundenr);
		fprintf(logfil, "nyopret_res:varighed=%ld\n",
			varighed);
	}

/* lejer */
	if (lejerok && lejerkundenr>0) {
		r167->kunde_nr = lejerkundenr;
		egeread(f167,ISEQUAL);
	}
	if (lejerok && lejerkundenr>0 && f167_ok) {
		r159->lejerkundenr = r167->kunde_nr;
		strcpy(r159->lejerfornavn, r167->navn_1);
		strcpy(r159->lejerefternavn, r167->navn_2);
		strcpy(r159->lejerconavn, r167->adr_1);
		strcpy(r159->lejeradr, r167->adr_2);
		strcpy(r159->lejerpostkode, r167->postkode);
		strcpy(r159->lejerby, r167->by);
		strcpy(r159->lejerland, r167->land);
		strcpy(r159->lejertlf, r167->tlf);
		r159->lejerfoedselsdato = r167->foedselsdato;
		r159->lejercheckcif = r167->checkcif;
		strcpy(r159->lejerkkortnr, r167->kkortnr);
		strcpy(r159->lejerkkort_udstedt_af, r167->kkort_ud_af);
		r159->lejerkkort_udstedt_den = r167->kkort_ud_den;
		strcpy(r159->lejerpasnr, r167->pasnr);
		strcpy(r159->lejerpas_udstedt_af, r167->pas_ud_af);
		r159->lejerpas_udstedt_den = r167->pas_ud_den;
		r159->lejerpas_gyldig_til = r167->pas_gyldig_til;
		strcpy(r159->lejer_rabat_betingelse, r167->rabat_bet);
		r159->lejer_rabat_pct[0] = r167->rabat_lok;
		r159->lejer_rabat_pct[1] = r167->rabat_serv;
		r159->lejer_rabat_pct[2] = r167->rabat_int;
		r159->lejerstatus = r167->status;
		strcpy(r159->lejerbem, r167->bem);
		r159->lejer_firma_ref = r167->firma_reference;
		strcpy(r159->lejer_foede_sted, r167->foede_sted);
		r159->sprog_kode = r167->dk_ja_nej;
		r159->lejer_kto_nr = r167->debitor_reference;
		r159->lejer_gwid = r167->gw_id;
		if (strlen(r167->recap_nr)) {
			sscanf(r167->recap_nr, "%lf", &r159->lejer_recap);
		} else {
			r159->lejer_recap = 0;
		}
	}
/* NYT 121109 DON2FIRMALEJER */
	if (firmakundenr>0) {
		r167->kunde_nr = firmakundenr;
		egeread(f167,ISEQUAL);
		if (f167_ok && r167->type==2) {
			firmaok = 1;
		}
	}
	if (logfil) {
		fprintf(logfil,"nyopret_res:firmaok=%hd %ld\n",
			firmaok,
			firmakundenr);
	}
/*
	if (lejerok && r167->firma_reference>0) {
		r167->kunde_nr = r167->firma_reference;
		egeread(f167, ISEQUAL);
		if (f167_ok) {
			firmaok = 1;
		}
	}
*/
	if (firmaok && firmakundenr>0) {
		r159->firma_ja_nej = 1;
		r159->firmakundenr = r167->kunde_nr;
		strcpy(r159->firmanavn, r167->navn_2);
		r167->adr_1[20] = '\0';
		strcpy(r159->firmaatt, r167->adr_1);
		strcpy(r159->firmaadr, r167->adr_2);
		strcpy(r159->firmapostkode, r167->postkode);
		strcpy(r159->firmaby, r167->by);
		strcpy(r159->firmaland, r167->land);
		strcpy(r159->firmatlf, r167->tlf);
		strcpy(r159->firma_rabat_betingelse, r167->rabat_bet);
		r159->firma_rabat_pct[0] = r167->rabat_lok;
		r159->firma_rabat_pct[1] = r167->rabat_serv;
		r159->firma_rabat_pct[2] = r167->rabat_int;
		r159->firmastatus = r167->status;
		strcpy(r159->firmabem, r167->bem);
		r159->firma_kto_nr = r167->debitor_reference;
		strcpy(r159->recap_nr, r167->recap_nr);
		if (r159->status==2 || r159->status==10) {
			r159->rabat_pct_lok = r159->firma_rabat_pct[0];
			r159->rabat_pct_serv = r159->firma_rabat_pct[1];
			r159->rabat_pct_int = r159->firma_rabat_pct[2];
		}
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,"\tLEJEROPL:lejerok=%hd\n",lejerok);
	}


/* NYT 121111 MEDLEJER */
/*
			get_long(&ws_medlknr);
			get_alfa(ws_medlfornavn);
			get_alfa(ws_medleftnavn);
			get_alfa(ws_medlkkortnr);
			get_alfa(ws_medlfdato);
                bss_konv_txt(2,r167->navn_1);
                bss_konv_txt(3,r167->navn_2);
                bss_konv_txt(8,r167->kkortnr);

*/
	wx1 = 0;
	if (ws_medlknr<=0 && strlen(ws_medlfornavn)) {
                bss_konv_txt(2,ws_medlfornavn);
		strcpy(r159->medlfornavn, ws_medlfornavn);
		wx1++;
	}
	if (ws_medlknr<=0 && strlen(ws_medleftnavn)) {
                bss_konv_txt(3,ws_medleftnavn);
		strcpy(r159->medlefternavn, ws_medleftnavn);
		wx1++;
	}
	if (ws_medlknr<=0 && strlen(ws_medlkkortnr)) {
                bss_konv_txt(8,ws_medlkkortnr);
		strcpy(r159->medlkkortnr, ws_medlkkortnr);
		wx1++;
	}
	if (ws_medlknr<=0 && strlen(ws_medlfdato)) {
		strcpy(tmpstr,ws_medlfdato);
		rens_datotidstr(tmpstr);
		sscanf(tmpstr,"%ld",&ege_w_int1);
		r159->medlfoedselsdato = m036_funktion(18, ege_w_int1);
		wx1++;
	}
	if (logfil) {
		fprintf(logfil,"\tMEDLOPL:wx1=%hd ws_medlknr=%ld\n",
			wx1,
			ws_medlknr);
	}
	if (ws_medlknr<=0 && wx1>0) {
		r159->medl_ja_nej = 1;
	}
	if (ws_medlknr>0) {
		r167->kunde_nr = ws_medlknr;
		egeread(f167,ISEQUAL);
	}
	if (ws_medlknr>0 && f167_ok) {
		medlkundenr = r167->kunde_nr;
		medlok = 1;
	}
	if (medlok==1 && medlkundenr>0 && f167_ok) {
		r159->medlkundenr = r167->kunde_nr;
		strcpy(r159->medlfornavn, r167->navn_1);
		strcpy(r159->medlefternavn, r167->navn_2);
		strcpy(r159->medlconavn, r167->adr_1);
		strcpy(r159->medladr, r167->adr_2);
		strcpy(r159->medlpostkode, r167->postkode);
		strcpy(r159->medlby, r167->by);
		strcpy(r159->medlland, r167->land);
		strcpy(r159->medltlf, r167->tlf);
		r159->medlfoedselsdato = r167->foedselsdato;
		r159->medlcheckcif = r167->checkcif;
		strcpy(r159->medlkkortnr, r167->kkortnr);
		strcpy(r159->medlkkort_udstedt_af, r167->kkort_ud_af);
		r159->medlkkort_udstedt_den = r167->kkort_ud_den;
		strcpy(r159->medlpasnr, r167->pasnr);
		strcpy(r159->medlpas_udstedt_af, r167->pas_ud_af);
		r159->medlpas_udstedt_den = r167->pas_ud_den;
		r159->medlpas_gyldig_til = r167->pas_gyldig_til;
		r159->medl_ja_nej = 1;
	}
	if (logfil) {
		fprintf(logfil,"\tMEDLOPL:medl_ja_nej=%hd %ld\n",
			r159->medl_ja_nej,
			r159->medlkundenr);
	}
/* ECWEB */
/* WEBAPI ecwflag */
	if (lejerok<1 && ecflag==1 && ecwflag<=0) {
		paraidx = 0;
		ws_paratab[paraidx][20] = '\0';
		strcpy(r159->lejerfornavn, ws_paratab[paraidx]);
		paraidx++;
		ws_paratab[paraidx][30] = '\0';
		strcpy(r159->lejerefternavn, ws_paratab[paraidx]);
		paraidx++;
		ws_paratab[paraidx][30] = '\0';
		strcpy(r159->lejerconavn, ws_paratab[paraidx]);
		paraidx++;
		ws_paratab[paraidx][15] = '\0';
		strcpy(r159->lejerpostkode, ws_paratab[paraidx]);
		paraidx++;
		ws_paratab[paraidx][20] = '\0';
		strcpy(r159->lejerby, ws_paratab[paraidx]);
		paraidx++;
		ws_paratab[paraidx][25] = '\0';
		strcpy(r159->lejerkkortnr, ws_paratab[paraidx]);
		paraidx++;
/* email */
		ws_paratab[paraidx][60] = '\0';
		egechartest((unsigned char *)ws_paratab[paraidx]);
/* RETTET 081107
		strcpy(r159->skade[2],ws_paratab[paraidx]+30);
		ws_paratab[paraidx][30] = '\0';
		strcpy(r159->skade[1],ws_paratab[paraidx]);
*/
		if (funk>0) {
			opdat_f359_alfa(21,ws_paratab[paraidx],r159->record_x);
		}

		paraidx++;
		ws_paratab[paraidx][20] = '\0';
		strcpy(r159->lejertlf, ws_paratab[paraidx]);
		paraidx++;
/* mobil */
		ws_paratab[paraidx][20] = '\0';
/*
		sprintf(r159->skade[3],"MOBIL:%s",ws_paratab[paraidx]);
*/

		paraidx++;
/* f.dato */
		sscanf(ws_paratab[paraidx], "%ld", &r159->lejerfoedselsdato);
		paraidx++;
/* payment */
		ws_paratab[paraidx][20] = '\0';
		sprintf(r159->forud_4_opl[4],"%s",ws_paratab[paraidx]);
/* RETTET 060626
		sprintf(r159->bem[4],"PAYMENT:%s",ws_paratab[paraidx]);
*/

		ege_toupper((unsigned char *)r159->lejerfornavn);
		ege_toupper((unsigned char *)r159->lejerefternavn);
		ege_toupper((unsigned char *)r159->lejerconavn);
		ege_toupper((unsigned char *)r159->lejeradr);
		bss_konv_txt(5,r159->lejerpostkode);
		bss_konv_txt(4,r159->lejerby);
		bss_konv_txt(4,r159->lejerland);
		bss_konv_txt(8,r159->lejerkkortnr);
	}
	if (lejerok==1 && ecflag==1 && ecwflag<=0) {
		paraidx = 0;
/*
		ws_paratab[paraidx][20] = '\0';
		strcpy(r159->lejerfornavn, ws_paratab[paraidx]);
*/
		paraidx++;
/*
		ws_paratab[paraidx][30] = '\0';
		strcpy(r159->lejerefternavn, ws_paratab[paraidx]);
*/
		paraidx++;
/*
		ws_paratab[paraidx][30] = '\0';
		strcpy(r159->lejerconavn, ws_paratab[paraidx]);
*/
		paraidx++;
/*
		ws_paratab[paraidx][15] = '\0';
		strcpy(r159->lejerpostkode, ws_paratab[paraidx]);
*/
		paraidx++;
/*
		ws_paratab[paraidx][20] = '\0';
		strcpy(r159->lejerby, ws_paratab[paraidx]);
*/
		paraidx++;
/*
		ws_paratab[paraidx][25] = '\0';
		strcpy(r159->lejerkkortnr, ws_paratab[paraidx]);
*/
		paraidx++;
/* email */
		ws_paratab[paraidx][60] = '\0';
		egechartest((unsigned char *)ws_paratab[paraidx]);
/* RETTET 081107
		strcpy(r159->skade[2],ws_paratab[paraidx]+30);
		ws_paratab[paraidx][30] = '\0';
		strcpy(r159->skade[1],ws_paratab[paraidx]);
*/
		if (funk>0) {
			opdat_f359_alfa(21,ws_paratab[paraidx],r159->record_x);
		}

		paraidx++;
/*
		ws_paratab[paraidx][20] = '\0';
		strcpy(r159->lejertlf, ws_paratab[paraidx]);
*/
		paraidx++;
/* mobil */
		ws_paratab[paraidx][20] = '\0';
/*
		sprintf(r159->skade[3],"MOBIL:%s",ws_paratab[paraidx]);
*/

		paraidx++;
/* f.dato */
/*
		sscanf(ws_paratab[paraidx], "%ld", &r159->lejerfoedselsdato);
*/
		paraidx++;
/* payment */
		ws_paratab[paraidx][20] = '\0';
		sprintf(r159->forud_4_opl[4],"%s",ws_paratab[paraidx]);
/* RETTET 060626
		sprintf(r159->bem[4],"PAYMENT:%s",ws_paratab[paraidx]);
*/
/*
		ege_toupper((unsigned char *)r159->lejerfornavn);
		ege_toupper((unsigned char *)r159->lejerefternavn);
		ege_toupper((unsigned char *)r159->lejerconavn);
		ege_toupper((unsigned char *)r159->lejeradr);
		bss_konv_txt(5,r159->lejerpostkode);
		bss_konv_txt(4,r159->lejerby);
		bss_konv_txt(4,r159->lejerland);
		bss_konv_txt(8,r159->lejerkkortnr);
*/
	}
/* NYT 140504 SUBMITPSLEJEROPL */
	if (ws_funktion==10 && ws_brandtype==4) {
		if (strlen(ws_pslejeropl[0])) {
			sscanf(ws_pslejeropl[0],"%s",
				ws_tmppara);
		}
		if (strlen(ws_pslejeropl[0])) {
			strcpy(ws_tmpstr,ws_pslejeropl[0]+strlen(ws_tmppara)+1);
		}
		ws_tmppara[20] = '\0';
		egechartest((unsigned char *)ws_tmppara);
		strcpy(r159->lejerfornavn, ws_tmppara);
		ege_toupper((unsigned char *)r159->lejerfornavn);
		ws_tmpstr[30] = '\0';
		egechartest((unsigned char *)ws_tmpstr);
		strcpy(r159->lejerefternavn, ws_tmpstr);
		ege_toupper((unsigned char *)r159->lejerefternavn);

		ws_pslejeropl[4][20] = '\0';
		strcpy(r159->lejertlf, ws_pslejeropl[4]);
	}
/* NYT 140509 SUBMITPSDEPOSITUMOPL */
	if (ws_funktion==10 && ws_brandtype==4) {
		depositum = 0;
	}
	if (ws_funktion==10 && ws_brandtype==4 &&
		strcmp(ws_betalingstype,"2")==0) {
		depositum = 2000;
	}
	if (ws_funktion==10 && ws_brandtype==4 &&
		strcmp(ws_betalingstype,"3")==0) {
		depositum = 3000;
	}
	if (ws_funktion==10 && ws_brandtype==4 && depositum>0) {
		sprintf(r159->forud_4_opl[4],"Aftalt dep. %.0lf",depositum);
	}

/* specnr */
	extraidx = 0;
/* NYT 090924 UDLDKJUL */
	altvarighed = varighed;
	if (ws_udldkflag>0 && ws_udldkjul>0) {
		altvarighed += (long int)ws_udldkjul;
	}
	sprintf(dum_str, "nyopret_res:altvarighed=%ld",
		altvarighed);
	logfil_put(dum_str);

	funkretur = add_prislinie(0,
		altvarighed,
		0,
		ws_station,
		ws_specnr,
		ws_grp,
		1,
		aftaleflag);
	sprintf(dum_str, "nyopret_res:add_prislinie%hd funkretur=%hd",
		ws_specnr,
		funkretur);
	logfil_put(dum_str);

/* ECWEB check prisjust */
	pjretur = 0;
	hpretur = 0;
	strcpy(nynavn,"");
	if (ecflag==1 && funkretur>0) {
		nypris = r159->rate_pris[extraidx];
		nyenhed = r159->rate_enhed[extraidx];
		nyantal = altvarighed;
/* RETTET 090924
		nyantal = varighed;
*/
		nycdidg = (double)r159->rate_cdw[extraidx];
		nypaidg = (double)r159->rate_pai[extraidx];
		nyextkm = (double)r159->rate_ekstra_km[extraidx];
		nyinclkm = r159->rate_incl_km[extraidx];
	}
	sprintf(dum_str, "nyopret_res:add_prislinie nyenhed=%hd",
		nyenhed);
	logfil_put(dum_str);
/* NYT 150625 */
	if (ws_ecwebapiflag>0) {
		goto nor10;
	}

/* NYT 110511 STATIONWEBPRIS */
	if (ecflag==1 && funkretur>0 && ws_station>0 && ws_udldkflag<=0) {
		pjretur = find_f198prisjust(ws_specnr,
			ws_grp,
			(short int)ws_station,
                        ws_fradato,
			(int)altvarighed,
                        &nypris,
                        &nyenhed,
                        &nyantal,
			&nycdidg,
			&nypaidg,
			&nyextkm,
			&nyinclkm);
	}
	if (ecflag==1 && funkretur>0 && pjretur<=0) {
/* RETTET 110511 STATIONWEBPRIS
	if (ecflag==1 && funkretur>0) {
*/
		pjretur = find_f198prisjust(ws_specnr,
			ws_grp,
			(short int)0,
                        ws_fradato,
			(int)altvarighed,
/* RETTET 090924        (int)varighed, */
                        &nypris,
                        &nyenhed,
                        &nyantal,
			&nycdidg,
			&nypaidg,
			&nyextkm,
			&nyinclkm);
	}


/* UDLDK */
	if (ecflag==1 && funkretur>0 && ws_udldkflag>0 && weekendflag>0 &&
		nyenhed==501) {
		nyantal = 1;
	}
/* RETTET 110510 UDLDKPERIODE
	if (ecflag==1 && funkretur>0 && ws_udldkflag>0 && weekendflag>0) {
		nyantal = 1;
	}
*/

/* TEST */
	sprintf(dum_str, "nyopret_res:pjretur=%hd,nyantal=%ld",
		pjretur,
		nyantal);
	logfil_put(dum_str);
	if (ecflag==1 && funkretur>0 && ws_udldkflag<=0) {
		hpretur = find_f198hlgpris(ws_specnr,
			ws_grp,
			(short int)0,
			r159->dato_ud,
                        r159->forv_dato_ind,
			nynavn,
                        &nypris,
                        &nyenhed,
                        &nyantal,
			&nycdidg,
			&nypaidg,
			&nyextkm,
			&nyinclkm,
			&nypaiflag);
	}
/* TEST */
	sprintf(dum_str, "nyopret_res:hpretur=%hd,nyantal=%ld nyenhed=%hd",
		pjretur,
		nyantal,
		nyenhed);
	logfil_put(dum_str);

/* NYT 081117 HLGTILBUD */
	strcpy(tmpstr,"");
/* NYT 090626 */
	htretur = 0;
	if (ecflag==1 && funkretur>0 && ws_udldkflag<=0) {
		htretur = check_f198_hlgtilbud(1,ws_hlgtilbud,
				varighed,
				ws_station,
				ws_grp,
				r159->dato_ud,
				r159->forv_dato_ind,
				tmpstr);
	}
	if (ecflag==1 && funkretur>0 &&
		htretur>0 &&
		strlen(ws_hlgtilbud) &&
		strlen(tmpstr)) {
		sscanf(tmpstr,"%lf %hd %ld %lf %lf %lf %ld %hd %hd %s",
                        &nypris,
                        &nyenhed,
                        &nyantal,
			&nycdidg,
			&nypaidg,
			&nyextkm,
			&nyinclkm,
			&nypaiflag,
			&nycdiflag,
			nynavn);
		hpretur = 1;
	}
	sprintf(dum_str, "nyopret_res:htretur=%hd,nynavn=%s",
		htretur,
		nynavn);
	logfil_put(dum_str);
	sprintf(dum_str, "nyopret_res:nypaiflag-1=%hd,nycdiflag-1=%hd",
		nypaiflag,
		nycdiflag);
	logfil_put(dum_str);

/* NYT 060629 check */
	if (ecflag==1 && funkretur>0 && ws_udldkflag<=0) {
		(void)find_f198perpris(ws_specnr,
			ws_grp,
			ws_station,
			r159->dato_ud,
                        r159->forv_dato_ind,
			nynavn,
                        &nypris,
                        &nyenhed,
                        &nyantal,
			&nycdidg,
			&nypaidg,
			&nyextkm,
			&nyinclkm,
			&nypaiflag);
	}
nor10:
	sprintf(dum_str, "nyopret_res:nypaiflag-2=%hd,nycdiflag-2=%hd",
		nypaiflag,
		nycdiflag);
	logfil_put(dum_str);
	sprintf(dum_str, "nyopret_res:nyenhed=%hd",
		nyenhed);
	logfil_put(dum_str);

/*
		reclow(r198,R198);
		f198_start(1,ISGTEQ);
		r198->oplkode = 16580;
		r198->keynum = (double)ws_specnr;
		sprintf(r198->keyalfa,"%5.5hd%s",ws_station,ws_grp);
		egeread(f198,ISEQUAL);
		if (f198_ok) {
			nypris = r198->numfelt;
		}
	}
*/
/* TEST 090805 */
	sprintf(dum_str,
		"nyopret_reservationPAIXX:ws_paiflag=%hd,forsikring_pai=%hd",
		ws_paiflag,r159->forsikring_pai);
	logfil_put(dum_str);
/* NYT 081118 HLGTILBUD */
	if (ecflag==1 && funkretur>0 && hpretur>0 && nypaiflag>0) {
		r159->forsikring_pai = 1;
	}
	if (ecflag==1 && funkretur>0 &&
		(pjretur>0||hpretur>0)) {
		if (strlen(nynavn)) {
			strcpy(r159->rate_tekst[extraidx],nynavn);
		}
		r159->rate_pris[extraidx] = nypris;
		r159->rate_enhed[extraidx] = nyenhed;
		r159->rate_antal[extraidx] = nyantal;
		r159->rate_cdw[extraidx] = (float)nycdidg;
		r159->rate_pai[extraidx] = (float)nypaidg;
		r159->rate_ekstra_km[extraidx] = nyextkm;
		r159->rate_incl_km[extraidx] = nyinclkm;
		if (nypaiflag>0) {
			r159->pris_pai_pr_dag = nypaidg;
			r159->rate_incl_felt[extraidx][0] = 48+3;
			r159->rate_incl_felt[extraidx][1] = 48+3;
		}
/* NYT 081118 */
		if (nypaiflag==2) {
			r159->rate_incl_felt[extraidx][0] = 48+2;
		}
		if (nycdiflag==2) {
			r159->rate_incl_felt[extraidx][1] = 48+2;
		}

		if (extraidx==0) {
			r159->rate_ekstra_km[10] = r159->rate_ekstra_km[0];
			r159->rate_pris[10]     = r159->rate_ekstra_km[0];
			strcpy(r159->rate_incl_felt[10],
				r159->rate_incl_felt[0]);
/*
			udregn_ratejustering(1,extraidx);
*/
		}
		opsaet_forsikring(extraidx);
	}
/* TEST 090805 */
	sprintf(dum_str,
		"nyopret_reservationPAI00:ws_paiflag=%hd,forsikring_pai=%hd",
		ws_paiflag,r159->forsikring_pai);
	logfil_put(dum_str);


/* TEST */
	sprintf(dum_str, "nyopret_res:pjretur=%hd,hpretur=%hd",
		pjretur,hpretur);
	logfil_put(dum_str);
	sprintf(dum_str, "nyopret_res:nypris=%lf,nynavn=%s",
		nypris,
		nynavn);
	logfil_put(dum_str);
	sprintf(dum_str, "nyopret_res:nyenhed=%hd",
		nyenhed);
	logfil_put(dum_str);
	sprintf(dum_str, "nyopret_res:nyantal=%ld",
		nyantal);
	logfil_put(dum_str);
	sprintf(dum_str, "nyopret_res:nyinclkm=%ld",
		nyinclkm);
	logfil_put(dum_str);
	sprintf(dum_str, "nyopret_res:nycdidg=%lf",
		nycdidg);
	logfil_put(dum_str);
	sprintf(dum_str, "nyopret_res:nypaidg=%lf",
		nypaidg);
	logfil_put(dum_str);
	sprintf(dum_str, "nyopret_res:funkretur=%hd sendflag=%hd",
		funkretur,sendflag);
	logfil_put(dum_str);

	if (funkretur<=0 && ecflag==0) {
		if (sendflag && dondafolo==0) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)0);
			pack_exchkend();
			send_linie();
		}
		if (sendflag && dondafolo==1) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-315);
			web_errormess(0,ws_langstr,"315");
			pack_exchkend();
			send_linie();
		}
		sprintf(dum_str, "nyopret_res:RETUR 0");
		logfil_put(dum_str);
		return(0);
	}
	if (funkretur<=0 && ecflag==1) {
		if (sendflag) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-7);
			web_errormess(0,ws_langstr,"7");
			pack_exchkend();
			send_linie();
		}
		sprintf(dum_str, "nyopret_res:RETUR 0");
		logfil_put(dum_str);
		return(0);
	}
	sprintf(dum_str, "nyopret_res:ws_extspcstr=%s",
		ws_extspcstr);
	logfil_put(dum_str);
	extraidx = 1;
/* extra specnr */
	extraantal = 0;
	extraspecnr = 0;
	strcpy(extragrp,ws_grp);
	extrastnr = ws_station;
	if (strlen(ws_extspcstr)) {
		(void)get_alfa_tgn(ws_extspcstr,1,tmpstr,'x');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%hd", &extraantal);
		}
		(void)get_alfa_tgn(ws_extspcstr,0,tmpstr,'x');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%hd", &extraspecnr);
		}
	}
	if (ecflag==1) {
		reclow(r198, R198);
		r198->oplkode = 16620;
		r198->keynum = ws_station;
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			extraspecnr = (short int)r198->numfelt;
			extraantal = 1;
		}
		strcpy(extragrp,"ALLE");
		extrastnr = ws_station;
/* TEST */
		sprintf(dum_str, "Lufthavnsgebyr specnr=%hd,st=%hd,grp=%s",
			extraspecnr,
			extrastnr,
			extragrp);
		logfil_put(dum_str);
	}
	funkretur = 0;
	ws_lufthavnsgebyr = 0;
	if (extraantal>0 && extraspecnr>0) {
		funkretur = add_prislinie(0,
			varighed,
			extraidx,
			extrastnr,
			extraspecnr,
			extragrp,
			extraantal,
			aftaleflag);
		ws_lufthavnsgebyr = r159->rate_pris[extraidx];
/* MOMS */
		if (rate_incl(extraidx, 3)==0) {
			ws_lufthavnsgebyr *= 1.25;
/* NYT 090526 */
/* SLETTET 090811
			r159->rate_pris[extraidx] *= 1.25;
*/
/* TEST */
			sprintf(dum_str,
				"ws_lufthavnsgebyr=%.2lf rate_pris=%.2lf",
				ws_lufthavnsgebyr,
				r159->rate_pris[extraidx]);
			logfil_put(dum_str);
		}
		ws_lufthavnsgebyr *= (double)r159->rate_antal[extraidx];
	}
	if (funkretur>0) {
		extraidx++;
	}
	extraantal = 0;
	extraspecnr = 0;
/* ecweb onewaycharge */
	if (ecflag==1 && ws_station!=ws_tilstation) {
/* RETTET 080408
		reclow(r198, R198);
		r198->oplkode = 16621;
		r198->keynum = ws_station;
		egeread(f198, ISEQUAL);
		if (f198_ok) {
			extraspecnr = (short int)r198->numfelt;
			extraantal = 1;
		}
*/
		extraspecnr = ONEWAYSPCNR;
		extraantal = 1;
		strcpy(extragrp,"ALLE");
		extrastnr = 0;
/* TEST */
		sprintf(dum_str, "OneWayCharge specnr=%hd,st=%hd,grp=%s",
			extraspecnr,
			extrastnr,
			extragrp);
		logfil_put(dum_str);

	}
	funkretur = 0;
	ws_onewaygebyr = 0;
	if (ecflag==1 && extraantal>0 && extraspecnr>0) {
		funkretur = add_prislinie(0,
			varighed,
			extraidx,
			extrastnr,
			extraspecnr,
			extragrp,
			extraantal,
			aftaleflag);
		ws_onewaygebyr = r159->rate_pris[extraidx];
/* NYT 100306 ONEWAYGEBYR MOMS */
		if (extraspecnr==920 &&
			rate_incl(extraidx,3)==0 &&
			rate_incl(extraidx,5)==1) {
			ws_onewaygebyr *= 1.25;
		}
		ws_onewaygebyr *= (double)r159->rate_antal[extraidx];
	}
	if (funkretur>0) {
		extraidx++;
	}
/* NYT 121108 DON2PROMO */
	if (logfil) {
		fprintf(logfil,"DON2PROMO ws_promokode=%s\n",ws_promokode);
	}
	if (strlen(ws_promokode) && ecflag==0) {
		funkretur = styr_promokode(extraidx);
	}
	if (strlen(ws_promokode) && ecflag==0 && funkretur>0) {
		extraidx += funkretur;
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,"nyopret_res:extraidx=%hd",
			extraidx);
	}
/* NYT 140306 PROMOSTYR */
	if (strlen(ws_promokode) && ecflag==0 && funkretur<=0 &&
		check_promotion()>0) {
		funkretur = 10;
	}
	if (logfil) {
		fprintf(logfil,"DON2PROMO PROMOSTYR funkretur=%d\n",
			funkretur);
		fprintf(logfil,"DON2PROMO PROMOSTYR ws_donpromofunk=%d\n",
			ws_donpromofunk);
		fprintf(logfil,"DON2PROMO PROMOSTYR ws_donpromoretur=%s\n",
			ws_donpromoretur);
	}
	if (strlen(ws_promokode) && ecflag==0 && funkretur==10 &&
		ws_donpromofunk==1) {
		sprintf(dum_str,"%s/%s",ws_promokode,ws_donpromoretur);
		dum_str[30] = '\0';
		strcpy(r159->bem[3],dum_str);
/* RETTET 140307 PROMOSTYR3
		strcpy(r159->bem[4],dum_str);
*/
	}
/* NYT 140422 PROMOPRISJUSTBEM */
	if (strlen(ws_promokode) && ecflag==0 && funkretur==10 &&
		ws_donpromofunk==3) {
		sprintf(dum_str,"%s/%s",ws_promokode,ws_donpromoretur);
		dum_str[30] = '\0';
		strcpy(r159->bem[3],dum_str);
	}

/* NYT 100407 MBIDRAG MILJØ BIDRAG 944 */
	funkretur = 0;
	ws_mbidrag = 0;
	strcpy(ws_mbidragtxt,"");
	if (DONMBIDRAG>0 && ecflag==0) {
		funkretur = adm_mbidrag(2,
			DONMBIDRAG,
			varighed,
			&ws_mbidrag);
		if (funkretur>0) {
			extraspecnr = DONMBIDRAG;
			extraantal = 1;
			strcpy(extragrp,"ALLE");
			extrastnr = 0;
			(void)add_prislinie(0,
				varighed,
				extraidx,
				extrastnr,
				extraspecnr,
				extragrp,
				extraantal,
				aftaleflag);
			r159->rate_pris[extraidx] = ws_mbidrag;
			r159->rate_antal[extraidx] = 1;
/*
			udregn_incl();
			udregn_ekstra();
			opsaet_forsikring(extraidx);
*/
		}
		if (funkretur>0 && rate_incl(extraidx,3)==0) {
			ws_mbidrag *= 1.25;
		}
		if (funkretur>0) {
			ws_mbidrag *= (double)r159->rate_antal[extraidx];
			strcpy(ws_mbidragtxt,r159->rate_tekst[extraidx]);
			ege_tolower((unsigned char *)ws_mbidragtxt);
			extraidx++;
		}
		if (logfil) {
			fprintf(logfil,
			"nyopret_res:DONMBIDRAG=%hd funkretur=%hd %.2lf\n",
				(short int)DONMBIDRAG,
				funkretur,
				ws_mbidrag);
			fprintf(logfil,
				"\t%s\n",
				ws_mbidragtxt);
			fflush(logfil);
		}
	}
/* TEST */
	sprintf(dum_str, "nyopret_res:extraidx=%hd",
		extraidx);
	logfil_put(dum_str);
/* TEST 090805 */
	sprintf(dum_str,
		"nyopret_reservationPAI01:ws_paiflag=%hd,forsikring_pai=%hd",
		ws_paiflag,r159->forsikring_pai);
	logfil_put(dum_str);

/* extra extra */
	nextlinie = 1;
/* ECUDLBOOK 090326 */
	if (nextlinie==1 && ecflag==1 && ws_udldkflag>0) {
/* TEST */
		sprintf(dum_str, "HERTIL:NOTAT ws_udldkidtab-%hd=%s",
			nextlinie,
			ws_udldkidtab[nextlinie]);
		logfil_put(dum_str);
		sprintf(dum_str, "\tNOTAT=%s",
			ws_udldkdatatab[nextlinie]);
		logfil_put(dum_str);
		nextlinie++;
	}

/* ECUDLBOOK 090320 */
	funkretur = 0;
	if (ws_udldkflag>0 && ws_udldkvinter>0) {
		funkretur = 8;
	}
	if (ws_udldkflag>0 && ws_udldkvinter<=0) {
		funkretur = 7;
	}
	if (logfil) {
		fprintf(logfil,"VINTER funkretur=%hd nextlinie=%hd\n",
			funkretur,nextlinie);
		fflush(logfil);
	}

	while (nextlinie>=2 && nextlinie<=funkretur &&
		ecflag==1 && ws_udldkflag>0) {
/* RETTET 110107 VINTERUDL
	while (nextlinie>=2 && nextlinie<=7 && ecflag==1 && ws_udldkflag==1) {
*/
/* TEST */
		sprintf(dum_str, "HERTIL:ws_udldkidtab-%hd=%s",
			nextlinie,
			ws_udldkidtab[nextlinie]);
		logfil_put(dum_str);
		sprintf(dum_str, "HERTIL:ws_udldkdatatab-%hd=%s",
			nextlinie,
			ws_udldkdatatab[nextlinie]);
		logfil_put(dum_str);
		sprintf(dum_str, "HERTIL:ws_udldkexttxt-%hd=%s",
			nextlinie,
			ws_udldkexttxt[nextlinie]);
		logfil_put(dum_str);


		extraantal = 0;
		specnr = 0;
		(void)get_alfa_tgn(ws_udldkidtab[nextlinie],1,ws_paratab[0],'_');
		(void)get_alfa_tgn(ws_udldkidtab[nextlinie],2,ws_paratab[2],'_');
		if (strlen(ws_paratab[0])) {
			sscanf(ws_paratab[0], "%hd", &specnr);
		}
/* NYT 090401 */
		strcpy(ws_udldkspectxt,"");
		if (nextlinie==2 && specnr==905) {
			strcpy(ws_udldkspectxt,ws_udldkexttxt[1]);
		}
		if (nextlinie==3 && specnr==905) {
			strcpy(ws_udldkspectxt,ws_udldkexttxt[2]);
		}
		if (nextlinie==4 && specnr==905) {
			strcpy(ws_udldkspectxt,ws_udldkexttxt[3]);
		}
/* NYT 101107 */
		if (nextlinie==8 && specnr==910) {
			strcpy(ws_udldkspectxt,ws_udldkexttxt[7]);
		}
		if (logfil) {
			fprintf(logfil,"SPECTXT-ws_udldkspectxt<%s> %hd\n",
				ws_udldkspectxt,
				nextlinie);
			fflush(logfil);
		}

		extraantal = -1;
		if (strcmp(ws_udldkdatatab[nextlinie],"NEJ")==0) {
			extraantal = 0;
		}
		if (strcmp(ws_udldkdatatab[nextlinie],"JA")==0) {
			extraantal = 1;
		}
		if (extraantal==-1 && strlen(ws_udldkdatatab[nextlinie])) {
			sscanf(ws_udldkdatatab[nextlinie],"%hd",&extraantal);
		}
		if (extraantal<=0) {
			nextlinie++;
			continue;
		}
		if (specnr<=0) {
			nextlinie++;
			continue;
		}
		add_prislinie(1,
			varighed,
			extraidx,
			ws_station,
			specnr,
			ws_paratab[2],
			extraantal,
			aftaleflag);
		ws_udldkdatapris[nextlinie]=(double)r159->rate_pris[extraidx];
		ws_udldkdatapris[nextlinie]*=(double)r159->rate_antal[extraidx];
		extraidx++;
		nextlinie++;
	}
/* TEST 110108 */
	sprintf(dum_str,
		"nyopret_reservationPAIFORDELE:nextlinie=%hd",
		nextlinie);
	logfil_put(dum_str);

/* FORDELE 090609 PAI */
	funkretur = 0;
	if (ws_udldkvinter>0 && nextlinie==9) {
		funkretur = 1;
	}
	if (ws_udldkvinter<=0 && nextlinie==8) {
		funkretur = 1;
	}
	if (funkretur>0 && ecflag==1 && ws_udldkflag>0) {
/* RETTET 110107 VINTERUDL
	if (nextlinie==8 && ecflag==1 && ws_udldkflag==1) {
*/
/* TEST */
		sprintf(dum_str, "HERTIL FORDELE:ws_udldkidtab-%hd=%s",
			nextlinie,
			ws_udldkidtab[nextlinie]);
		logfil_put(dum_str);
		extraantal = 0;
		(void)get_alfa_tgn(ws_udldkidtab[nextlinie],1,ws_paratab[0],'_');
		(void)get_alfa_tgn(ws_udldkidtab[nextlinie],2,ws_paratab[2],'_');
		extraantal = -1;
		if (strcmp(ws_udldkdatatab[nextlinie],"NEJ")==0) {
			extraantal = 0;
		}
		if (strcmp(ws_udldkdatatab[nextlinie],"JA")==0) {
			extraantal = 1;
		}
		ws_udldkdatapris[nextlinie]=(double)0;
		if (extraantal==1) {
/* RETTET 090924 altvarighed i stedet for varighed */
			udldk_udregn_pai((int)altvarighed,&ws_paidag);
			ws_udldkdatapris[nextlinie] = ws_paidag;
			ws_udldkdatapris[nextlinie] *= altvarighed;
		}
		nextlinie++;
	}
	while (nextlinie && ecflag==0 && dondafolo==0) {
/* TEST */
		sprintf(dum_str, "nextlinie=%hd", nextlinie);
		logfil_put(dum_str);
		if (get_subrecord()<=0) {
/* TEST */
			sprintf(dum_str, "HERTIL:get_subrecord<=0");
			logfil_put(dum_str);
			break;
		}
		if (nextlinie==1) {
			get_alfa(ws_paratab[0]);
			ws_paratab[0][20] = '\0';
			get_alfa(ws_paratab[1]);
			ws_paratab[0][30] = '\0';
			get_alfa(ws_paratab[2]);
			get_alfa(ws_paratab[3]);
			ws_paratab[3][25] = '\0';
			if (strlen(ws_paratab[0])) {
				r159->medl_ja_nej = 1;
				strcpy(r159->medlfornavn, ws_paratab[0]);
			}
			if (strlen(ws_paratab[1])) {
				r159->medl_ja_nej = 1;
				strcpy(r159->medlefternavn, ws_paratab[1]);
			}
			if (strlen(ws_paratab[2])) {
				sscanf(ws_paratab[2], "%ld",
					&r159->medlfoedselsdato);
			}
			if (strlen(ws_paratab[3])) {
				strcpy(r159->medlkkortnr, ws_paratab[3]);
			}
/* TEST */
			sprintf(dum_str, "medlejer=%s,%s,%s,%s",
				ws_paratab[0],
				ws_paratab[1],
				ws_paratab[2],
				ws_paratab[3]);
			logfil_put(dum_str);
		}
		if (nextlinie>1) {
			get_alfa(ws_paratab[0]);
			get_alfa(ws_paratab[1]);
			strcpy(ws_paratab[2], "ALLE");
			if (strlen(ws_paratab[0])) {
				sscanf(ws_paratab[0], "%hd", &specnr);
			}
			if (strlen(ws_paratab[1])) {
				sscanf(ws_paratab[1], "%hd", &extraantal);
			}
			add_prislinie(1,
				varighed,
				extraidx,
				ws_station,
				specnr,
				ws_paratab[2],
				extraantal,
				aftaleflag);
			extraidx++;
/*
			sprintf(dum_str, "spec=%s,%s",
				ws_paratab[0],
				ws_paratab[1]);
			logfil_put(dum_str);
*/
		}
		nextlinie++;
	}
/* NYT DON2 */
	if (logfil) {
		fprintf(logfil,"\tADDPRISLINIE\n");
	}
	ws_extrapidx = 0;
	while (ws_extrapidx<MAX_EXTRAPRODTAB) {
		if (!strlen(extraptab[ws_extrapidx].id)) {
			ws_extrapidx++;
			continue;
		}
		if (strcmp(extraptab[ws_extrapidx].id,"PAI")==0) {
			ws_extrapidx++;
			continue;
		}
/* RETTET 140305 CO996EJGRATIS
		if (strcmp(extraptab[ws_extrapidx].id,"996")==0 &&
			ws_brandtype==3) {
			ws_extrapidx++;
			continue;
		}
*/
		if (extraptab[ws_extrapidx].nuvantal<=0) {
			ws_extrapidx++;
			continue;
		}
		strcpy(ws_paratab[2],extraptab[ws_extrapidx].rategruppe);
		specnr = (short int)extraptab[ws_extrapidx].ratespecnr;
		extraantal = (short int)extraptab[ws_extrapidx].nuvantal;
/* NYT 140430 */
		if (specnr==969) {
			strcpy(ws_paratab[2],
				extraptab[ws_extrapidx].dropdownextra);
		}
/* NYT 140904 KMPKSPECNR */
		if (specnr==888) {
			strcpy(ws_paratab[2],
				extraptab[ws_extrapidx].dropdownextra);
		}
/* NYT 141111 PSKMPK840 */
		if (specnr==840) {
			strcpy(ws_paratab[2],
				extraptab[ws_extrapidx].dropdownextra);
		}
		add_prislinie(1,
			varighed,
			extraidx,
			ws_station,
			specnr,
			ws_paratab[2],
			extraantal,
			aftaleflag);
		ege_w_dou1 = r159->rate_pris[extraidx];
		r159->rate_pris[extraidx] = extraptab[ws_extrapidx].enhedpris;
		if (specnr==924) {
			r159->rate_pris[extraidx] = ege_w_dou1;
		}
		if (logfil) {
			fprintf(logfil,"\t\textraidx=%hd\n",extraidx);
			fprintf(logfil,"\t\tr159->rate_antal=%ld\n",
				r159->rate_antal[extraidx]);
			fprintf(logfil,"\t\tr159->rate_pris=%.2lf\n",
				r159->rate_pris[extraidx]);
			fprintf(logfil,"\t\tr159->rate_incl_felt=%s\n",
				r159->rate_incl_felt[extraidx]);
			fprintf(logfil,"\t\tr159->rate_station=%hd\n",
				r159->rate_station[extraidx]);
		}
/*
                ws_dondatapris[nextlinie] = (double)r159->rate_pris[extraidx];
                ws_dondatapris[nextlinie] *= (double)r159->rate_antal[extraidx];
                donextradep += ws_dondatapris[nextlinie];
*/
                extraidx++;
		ws_extrapidx++;
	}

/* GLDON
	while (nextlinie>=1 && nextlinie<=3 && ecflag==0 && dondafolo==1) {
		sprintf(dum_str, "HERTIL:ws_donidtab-%hd=%s",
			nextlinie,
			ws_donidtab[nextlinie]);
		logfil_put(dum_str);
		extraantal = 0;
		specnr = 0;
		(void)get_alfa_tgn(ws_donidtab[nextlinie],0,ws_paratab[0],'_');
		(void)get_alfa_tgn(ws_donidtab[nextlinie],1,ws_paratab[2],'_');
		if (strlen(ws_paratab[0])) {
			sscanf(ws_paratab[0], "%hd", &specnr);
		}
		if (strlen(ws_dondatatab[nextlinie])) {
			sscanf(ws_dondatatab[nextlinie],"%hd",&extraantal);
		}
		if (extraantal<=0) {
			nextlinie++;
			continue;
		}
		if (specnr<=0) {
			nextlinie++;
			continue;
		}
		add_prislinie(1,
			varighed,
			extraidx,
			ws_station,
			specnr,
			ws_paratab[2],
			extraantal,
			aftaleflag);
		ws_dondatapris[nextlinie] = (double)r159->rate_pris[extraidx];
		ws_dondatapris[nextlinie] *= (double)r159->rate_antal[extraidx];
		donextradep += ws_dondatapris[nextlinie];
		extraidx++;
		nextlinie++;
	}
	if (nextlinie==4 && ecflag==0 && dondafolo==1 &&
		strcmp(ws_donidtab[nextlinie],"MEDLEJER")==0 &&
		strcmp(ws_dondatatab[nextlinie],"JA")==0) {
		r159->medl_ja_nej = 1;
		ws_doncoforn[20] = '\0';
		strcpy(r159->medlfornavn,ws_doncoforn);
		ws_doncoeftn[30] = '\0';
		strcpy(r159->medlefternavn,ws_doncoeftn);
		r159->medlfoedselsdato = ws_doncofdato;
		ws_doncokkort[25] = '\0';
		strcpy(r159->medlkkortnr,ws_doncokkort);
		ege_toupper((unsigned char *)r159->medlfornavn);
		ege_toupper((unsigned char *)r159->medlefternavn);
		bss_konv_txt(8,r159->medlkkortnr);
	}
*/
/* TEST */
	sprintf(dum_str, "nextlinie=%hd",nextlinie);
	logfil_put(dum_str);
	sprintf(dum_str, "extraidx=%hd",extraidx);
	logfil_put(dum_str);
	sprintf(dum_str, "varighed=%ld",varighed);
	logfil_put(dum_str);
/* OBS NYT 040312 */
	r159->cdw_antal_dage = altvarighed;
/* RETTET 090924
	r159->cdw_antal_dage = varighed;
*/
/* RETTET 040615 */
	if (r159->cdw_antal_dage==0) {
		r159->cdw_antal_dage = 1;
	}
	r159->pai_antal_dage = altvarighed;
/* RETTET 090924
	r159->pai_antal_dage = varighed;
*/
/* RETTET 040615 */
	if (r159->pai_antal_dage==0) {
		r159->pai_antal_dage = 1;
	}
/* REKVNR 041108 */
	rekvstr[20] = '\0';
	if (r159->firma_ja_nej==1) {
		strcpy(r159->firma_rekv,rekvstr);
	} else {
		strcpy(r159->skade[0],rekvstr);
	}
/* FLYNR 060210 */
	if (ecflag==1 && strlen(ws_flynr)) {
		ws_flynr[30] = '\0';
		strcpy(r159->bem[0],ws_flynr);
	}
/* DEPOSITUM */
	depositum = 0;
/* OBS CHECK FOR FULDKREDIT evt ws_aftalefuldkredit */
	if (ecflag==1 && !strlen(ws_paratab[10]) && ws_aftalenr<=0) {
		udregn_depositum((int)varighed,&depositum);
	}
	if (ecflag==1 && strcmp(ws_paratab[10],"Kontant")==0) {
		udregn_depositum((int)varighed,&depositum);
	}
	if (ecflag==1 && strcmp(ws_paratab[10],"Dankort")==0) {
		udregn_depositum((int)varighed,&depositum);
	}
	if (ecflag==1 && strcmp(ws_paratab[10],"Visa/Dankort")==0) {
		udregn_depositum((int)varighed,&depositum);
	}
	if (ecflag==1 && strcmp(ws_paratab[10],"VisaElectron")==0) {
		udregn_depositum((int)varighed,&depositum);
	}
	sprintf(dum_str,
		"nyopret_reservation:paratab-10=%s,depositum=%.2lf",
		ws_paratab[10],
		depositum);
	logfil_put(dum_str);
	ws_nyopret_varigh = varighed;
	ws_nyopret_depos = depositum;

/* NYT 071129 */
	sprintf(dum_str,
		"nyopret_reservation:1:donextradep=%.2lf",
		donextradep);
	logfil_put(dum_str);
/* NYT 090609 FORDELE PAI */
	if (ecflag==1 && ws_udldkflag>0 && ws_paiflag>0) {
		r159->pris_pai_pr_dag = ws_paidag;
		r159->rate_pai[0] = ws_paidag;
	}
/* TEST 090805 */
	sprintf(dum_str,
		"nyopret_reservationPAI02:ws_paiflag=%hd,forsikring_pai=%hd",
		ws_paiflag,r159->forsikring_pai);
	logfil_put(dum_str);
/* OBS PAI UDLDK FORDELE 090805 */
	if (ecflag==1 && ws_udldkflag>0 && ws_paiflag<=0) {
		r159->forsikring_pai = 0;
	}
/* NYT 110527 BONUS SPECNR 946 */
	if (ecflag>0 && ws_udldkflag<=0 &&
		r159->rate_spec_nr[0]>=674 &&
		r159->rate_spec_nr[0]<=678) {
		funkretur = check_bonus(1,
			r159->rate_spec_nr[0],
			r159->rate_tekst[0],
			r159->dato_ud);
	}
/* NYT 120307 673 BONUS SPECNR 946 */
	if (ecflag>0 && ws_udldkflag<=0 &&
		r159->rate_spec_nr[0]==673) {
		funkretur = check_bonus(2,
			r159->rate_spec_nr[0],
			r159->rate_tekst[0],
			r159->dato_ud);
	}
	sprintf(dum_str,
		"nyopret_reservationBONUS:funkretur=%hd extraidx=%hd",
		funkretur,
		extraidx);
	logfil_put(dum_str);
	if (ecflag>0 && ws_udldkflag<=0 &&
		r159->rate_spec_nr[0]>=674 &&
		r159->rate_spec_nr[0]<=678 &&
		funkretur==1) {
		add_prislinie(1,
			varighed,
			extraidx,
			0,
			946,
			"ALLE",
			1,
			0);
		extraidx++;
	}
/* NYT 120307 673 BONUS SPECNR 946 */
	if (ecflag>0 && ws_udldkflag<=0 &&
		r159->rate_spec_nr[0]==673 &&
		funkretur==1) {
		add_prislinie(1,
			varighed,
			extraidx,
			0,
			946,
			"ALLE",
			1,
			0);
		extraidx++;
	}

/* NYT 060116 */
	if (ecflag==1) {
		udregn_incl();
	}
/* NYT 140411 PROMOPRISJUST */
	wx1 = -1;
	funkretur = 0;
	promoprisned = 0;
	if (ws_brandtype==3 && ws_donpromofunk==3 &&
		varighed<=ws_donpromomaxvarighed &&
		ws_donpromojustering>0) {
		funkretur = 1;
		wx1 = 0;
	}
/* NYT 140825 PSPROMOPCT */
	if (ws_brandtype==4 && ws_donpromofunk==3 &&
		ws_donpromomaxvarighed>0 &&
		varighed<=ws_donpromomaxvarighed &&
		ws_donpromojustering>0) {
		funkretur = 2;
		wx1 = 0;
	}
	if (logfil) {
		fprintf(logfil,
			"\tPROMOPRISJUST-0 rate_pris-0=%lf\n",
			r159->rate_pris[0]);
	}
	while (funkretur==1 && wx1>=0 && wx1<10) {
		if (r159->rate_spec_nr[wx1]==944 &&
			r159->rate_pris[wx1]>0) {
			ege_w_dou2 = 100;
			ege_w_dou2 -= ws_donpromojustering;
			ege_w_dou2 /= 100;
			ege_w_dou1 = r159->rate_pris[wx1];
			if (r159->rate_antal[wx1]==1 &&
				r159->rate_enhed[wx1]==0) {
				ege_w_dou1 /= varighed;
			}
			if (rate_incl(wx1,3)==0) {
				ege_w_dou1 *= 1.25;
			}
			ege_w_dou1 *= ege_w_dou2;
			promoprisned += ege_w_dou1;
		}
		wx1++;
	}
/* NYT 140825 PSPROMOPCT */
	while (funkretur==2 && wx1>=0 && wx1<10) {
		if (r159->rate_spec_nr[wx1]==944 &&
			r159->rate_pris[wx1]>0) {
			ege_w_dou2 = ws_donpromojustering;
			ege_w_dou2 /= 100;
			ege_w_dou1 = r159->rate_pris[wx1];
			if (r159->rate_antal[wx1]==1 &&
				r159->rate_enhed[wx1]==0) {
				ege_w_dou1 /= varighed;
			}
			if (rate_incl(wx1,3)==0) {
				ege_w_dou1 *= 1.25;
			}
			ege_w_dou1 *= ege_w_dou2;
			promoprisned += ege_w_dou1;
		}
		wx1++;
	}
	if (logfil) {
		fprintf(logfil,
			"\tPROMOPRISJUST-1 promoprisned=%lf\n",
			promoprisned);
	}
	if (funkretur==1) {
		if (r159->forsikring_cdw>0 && r159->pris_cdw_pr_dag>0) {
			ege_w_dou2 = 100;
			ege_w_dou2 -= ws_donpromojustering;
			ege_w_dou2 /= 100;
			ege_w_dou1 = r159->pris_cdw_pr_dag;
			ege_w_dou1 *= ege_w_dou2;
			promoprisned += ege_w_dou1;
		}
		wx1 = 0;
	}
/* NYT 140825 PSPROMOPCT */
	if (funkretur==2) {
		if (r159->forsikring_cdw>0 && r159->pris_cdw_pr_dag>0) {
			ege_w_dou2 = ws_donpromojustering;
			ege_w_dou2 /= 100;
			ege_w_dou1 = r159->pris_cdw_pr_dag;
			ege_w_dou1 *= ege_w_dou2;
			promoprisned += ege_w_dou1;
		}
		wx1 = 0;
	}
	if (logfil) {
		fprintf(logfil,
			"\tPROMOPRISJUST-2 promoprisned=%lf\n",
			promoprisned);
	}
	while (funkretur==1 && wx1>=0 && wx1<10) {
		if (r159->rate_spec_nr[wx1]>0 &&
			r159->rate_spec_nr[wx1]<900 &&
			r159->rate_pris[wx1]>0) {
			ege_w_dou2 = 100;
			ege_w_dou2 -= ws_donpromojustering;
			ege_w_dou2 /= 100;
			r159->rate_pris[wx1] *= ege_w_dou2;
		}
		if (r159->rate_spec_nr[wx1]>0 &&
			r159->rate_spec_nr[wx1]<900 &&
			r159->rate_pris[wx1]>0 &&
			wx1==0) {
			ege_w_int1 = r159->rate_enhed[wx1];
			ege_w_int1 %= 200;
			ege_w_dou1 = promoprisned;
			ege_w_dou1 *= ege_w_int1;
			r159->rate_pris[wx1] -= ege_w_dou1;
		}
		wx1++;
	}
/* NYT 140825 PSPROMOPCT */
	while (funkretur==2 && wx1>=0 && wx1<10) {
		if (r159->rate_spec_nr[wx1]>0 &&
			r159->rate_spec_nr[wx1]<900 &&
			r159->rate_pris[wx1]>0 &&
			r159->rate_enhed[wx1]>200 &&
			r159->rate_enhed[wx1]<300 &&
			wx1==0) {
			ege_w_dou2 = ws_donpromojustering;
			ege_w_dou2 /= 100;
			ege_w_dou1 = r159->rate_pris[wx1];
			if (rate_incl(wx1,3)==0) {
				ege_w_dou1 *= 1.25;
			}
			ege_w_dou1 *= ege_w_dou2;
			promoprisned += ege_w_dou1;
		}
		wx1++;
	}
	if (funkretur==2 && ws_funktion==10) {
		r159->rate_pris[0] -= promoprisned;
	}
/* NYT 140825 PSPROMOPCT */
	if (funkretur==2) {
		ws_donpromodagbeloeb = promoprisned;
		ws_donpromototalbeloeb = ws_donpromodagbeloeb;
		ws_donpromototalbeloeb *= (double)varighed;
	}
	if (logfil) {
		fprintf(logfil,
			"\tPROMOPRISJUST funkretur=%hd promoprisned=%lf\n",
			funkretur,
			promoprisned);
		fprintf(logfil,
			"\t\tws_donpromodagbeloeb=%lf\n",
			ws_donpromodagbeloeb);
		fprintf(logfil,
			"\t\tws_donpromototalbeloeb=%lf\n",
			ws_donpromototalbeloeb);
		fprintf(logfil, "\t\tforsikring_cdw=%hd\n",
			r159->forsikring_cdw);
		fprintf(logfil, "\t\tpris_cdw_pr_dag=%lf\n",
			r159->pris_cdw_pr_dag);
		fprintf(logfil, "\t\trate_pris-0=%lf\n",
			r159->rate_pris[0]);
	}

/* TEST 090805 */
	sprintf(dum_str,
		"nyopret_reservationPAI03:ws_paiflag=%hd,forsikring_pai=%hd",
		ws_paiflag,r159->forsikring_pai);
	logfil_put(dum_str);
	udregn_kontrakt((short int)0,
		(short int)0,
		(long int)0,
		(long int)0);
/* TEST 090805 */
	sprintf(dum_str,
		"nyopret_reservationPAI04:ws_paiflag=%hd,forsikring_pai=%hd",
		ws_paiflag,r159->forsikring_pai);
	logfil_put(dum_str);

/* NYT 090331 */
	if (ecflag==1 && ws_udldkflag>0 && varighed>UDLDKMAXFRGSPG) {
		r159->total = 99999;
	}

	if (r159->pai_ialt>0 && r159->forsikring_pai>0) {
		donextradep += r159->pai_ialt;
	}
/* NYT 071205 */
	sprintf(dum_str,
		"nyopret_reservation:2:donextradep=%.2lf",
		donextradep);
	logfil_put(dum_str);
/* NYT 090325 */
	sprintf(dum_str,
		"nyopret_reservation:3:depositum=%.2lf",
		depositum);
	logfil_put(dum_str);
	sprintf(dum_str,
		"nyopret_reservation:3:total=%.2lf",
		r159->total);
	logfil_put(dum_str);

	if (ecflag==1 && depositum>0) {
		ege_w_dou1 = r159->total;
		ege_w_dou1 += depositum;
		sprintf(r159->forud_4_opl[4],"%s:%.2lf",
			ws_paratab[10],
			ege_w_dou1);
	}
/* NYT 110511 UDLDKRESOPL */
	if (ecflag==1 && depositum>0 && ws_udldkflag>0) {
		sprintf(r159->forud_4_opl[4],"CC el. følg KundeKvalifikation");
	}

	if (ecflag==1 && ws_udldkflag<=0) {
		r159->iata_nr = 7;
	}

/* OBS BORNHOLM */
	if (ecflag==1 && r159->station_ind_nr==10) {
		r159->station_ind_nr = 8;
		strcpy(r159->station_ind_navn,"LUFTHAVN");
	}
/* FATAL GEM */
	if (funk==1 && resnr<=20000000) {
		fatalnrfejl = 2;
	}
	if (funk==1 && resnr>29999999) {
		fatalnrfejl = 2;
	}
	if (funk==1 && resnr<=0) {
		fatalnrfejl = 1;
	}
	if (funk==1 && r159->record_x<=20000000) {
		fatalnrfejl = 4;
	}
	if (funk==1 && r159->record_x>29999999) {
		fatalnrfejl = 4;
	}
	if (funk==1 && r159->record_x<=0) {
		fatalnrfejl = 3;
	}
	sprintf(dum_str,
		"nyopret_reservation:1:fatalnrfejl=%hd",
		fatalnrfejl);
	logfil_put(dum_str);


/* EVT TEST BETA */
	if (funk==1 && fatalnrfejl>0) {
		sprintf(dum_str,"%sfatalnr.log",ws_kreds);
		tmpfil = fopen(dum_str,"a");
	}
	if (funk==1 && fatalnrfejl>0 && tmpfil) {
		fprintf(tmpfil,"resgem %ld %ld %ld %ld\n",
			ege_date(),ege_time(),resnr,r159->record_x);
		fprintf(tmpfil,"%s\n",str);
		fclose(tmpfil);
	}
	if (funk==1 && fatalnrfejl>0) {
		tmpfil = (FILE*)0;
	}

	if (funk==1 && fatalnrfejl>0) {
		if (sendflag && ecflag==0 && dondafolo==1) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-315);
			web_errormess(0,ws_langstr,"315");
			pack_exchkend();
			send_linie();
		}
		if (sendflag && ecflag==1) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-4);
			web_errormess(0,ws_langstr,"4");
			pack_exchkend();
			send_linie();
		}
		return(0);
	}
/* TEST */
	sprintf(dum_str,
		"nyopret_reservation:data_sti=%s",
		bss->data_sti);
	logfil_put(dum_str);
	sprintf(dum_str,
		"nyopret_reservation:ws_udldkfrgspg=%hd",
		ws_udldkfrgspg);
	logfil_put(dum_str);
/* UDLDKBOOK 090327 UDLDKEXTRA */
	if (ecflag==1 && ws_udldkflag>0 && ws_udldkfrgspg<0) {
		udldkfrgspg = udldk_checkfrgspg(1,
			"",
			r159->bil_grp,
			varighed,
			ws_systemdato,
			ws_systemtid);
	}
/* TEST */
	sprintf(dum_str,
	"nyopret_reservation:FRGSPG1 udldkfrgspg=%hd(%hd)",
		udldkfrgspg,
		ws_udldkfrgspg);
	logfil_put(dum_str);
	if (ecflag==1 && ws_udldkflag>0 && ws_udldkfrgspg>=0) {
		udldkfrgspg = ws_udldkfrgspg;
	}
/* TEST */
	sprintf(dum_str,
	"nyopret_reservation:FRGSPG2 udldkfrgspg=%hd(%hd)",
		udldkfrgspg,
		ws_udldkfrgspg);
	logfil_put(dum_str);

/* NYT 110107 VINTERUDL */
	funkretur = 0;
	for (wx1=0;wx1<10;wx1++) {
		if (ecflag==1 &&
			ws_udldkflag>0 &&
			r159->rate_spec_nr[wx1]==910) {
			funkretur = 1;
		}
	}
	if (ecflag==1 && ws_udldkflag>0 && funkretur>0) {
/* NYT 110217 VINTER FRGSPG */
		udldkfrgspg = udldk_checkfrgspg(2,
			"",
			r159->bil_grp,
			varighed,
			ws_systemdato,
			ws_systemtid);
	}
	if (ecflag==1 && ws_udldkflag>0 && funkretur>0 && udldkfrgspg<=0) {
		udldkfrgspg = 2;
	}
/* TEST */
	sprintf(dum_str,
	"nyopret_reservation:FRGSPG3 udldkfrgspg=%hd(%hd) funkretur=%hd",
		udldkfrgspg,
		ws_udldkfrgspg,
		funkretur);
	logfil_put(dum_str);
	if (ecflag==1 && ws_udldkflag>0 && udldkfrgspg>0) {
		r159->status = 10;
	}
	if (ecflag==1 && ws_udldkflag>0) {
		r159->bil_k_fri = 2;
		r159->iata_nr = (double)UDLDKIATA;
/* NYT 090514 */
		strcpy(r159->vou_navn,UDLDKNAVN);
	}
/* NYT 120413 TXBCBOOK */
	if (ecflag==1 && ws_udldkflag==2) {
		r159->iata_nr = (double)UDLTXIATA;
		strcpy(r159->vou_navn,UDLTXNAVN);
	}
	if (ecflag==1 && ws_udldkflag==3) {
		r159->iata_nr = (double)UDLBCIATA;
		strcpy(r159->vou_navn,UDLBCNAVN);
	}

/* NYT 091208 */
	udldkaltiata = 0;
	if (ecflag==1 && ws_udldkflag>0) {
		udldkaltiata = check_udldk_altiata();
	}
	if (ecflag==1 && ws_udldkflag>0 && udldkaltiata>0) {
		r159->iata_nr = (double)udldkaltiata;
	}


	if (ecflag==1 && ws_udldkflag>0 && strlen(ws_paratab[6])) {
		strcpy(tmpstr,ws_paratab[6]);
		tmpstr[60] = '\0';
		egechartest((unsigned char *)tmpstr);
		strcpy(r159->skade[2],tmpstr+30);
		tmpstr[30] = '\0';
		strcpy(r159->skade[1],tmpstr);
	}
	if (logfil) {
		fprintf(logfil,"nyopret_reservation:UDLDKEXTRA\n");
		fprintf(logfil,"\tws_flynr=%s\n", ws_flynr);
	}
	for (wx1=0;wx1<20;wx1++) {
		if (logfil) {
			fprintf(logfil,"\t%hd %s\n",wx1,ws_udldkbemtab[wx1]);
		}
	}
	if (ecflag==1 && ws_udldkflag>0) {
		opdater_udldkresdata();
	}
/* NYT 090505 UDLDK TLF */
	if (ecflag==1 && funk==1 && ws_udldkflag>0 && r159->record_x>0 &&
		strlen(ws_paratab[7])) {
		strcpy(r159->lejertlf,ws_paratab[7]);
	}
/* NYT 100108 CODRIVER */
	if (ecflag==1 && funk==1 && ws_udldkflag>0 && r159->record_x>0 &&
		strlen(ws_udldkbemtab[9])) {
		sscanf(ws_udldkbemtab[9],"%s %s",
			ws_udldkmedlfor,
			ws_udldkmedleft);
	}
	if (ecflag==1 && funk==1 && ws_udldkflag>0 && r159->record_x>0 &&
		strlen(ws_udldkmedlfor)) {
		ws_udldkmedlfor[20] = '\0';
		egechartest((unsigned char *)ws_udldkmedlfor);
		strcpy(r159->medlfornavn,ws_udldkmedlfor);
		r159->medl_ja_nej = 1;
	}
	if (ecflag==1 && funk==1 && ws_udldkflag>0 && r159->record_x>0 &&
		strlen(ws_udldkmedleft)) {
		ws_udldkmedleft[30] = '\0';
		egechartest((unsigned char *)ws_udldkmedleft);
		strcpy(r159->medlefternavn,ws_udldkmedleft);
		r159->medl_ja_nej = 1;
	}
/* EVT OPD KUNDEDATA */

/* NYT 110530 SPECNR0FEJL IKKE AKTIVT */
/*
	if (logfil) {
		fprintf(logfil,"nyopret_reservation:SPECLINIEMANGLER\n");
		fprintf(logfil,
	"\tfunk=%hd,resnr=%ld,ws_udldkflag=%hd,spec-0=%hd,pris-0=%.2lf\n",
			funk,
			resnr,
			ws_udldkflag,
			r159->rate_spec_nr[0],
			r159->rate_pris[0]);
	}
	if (funk==1 && resnr>0 && r159->rate_spec_nr[0]<=0) {
		fatalnrfejl = 10;
	}
	if (funk==1 && resnr>0 && r159->rate_pris[0]<=0) {
		fatalnrfejl = 11;
	}
	if (funk==1 && fatalnrfejl>0) {
		sprintf(dum_str,"%sfatalnr.log",ws_kreds);
		tmpfil = fopen(dum_str,"a");
	}
	if (funk==1 && fatalnrfejl>0 && tmpfil) {
		fprintf(tmpfil,"resgem %ld %ld %ld %ld specnr-0\n",
			ege_date(),ege_time(),resnr,r159->record_x);
		fprintf(tmpfil,"%s\n",str);
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}
	if (funk==1 && fatalnrfejl>0) {
		if (sendflag && ecflag==0 && dondafolo==1) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-315);
			web_errormess(0,ws_langstr,"315");
			pack_exchkend();
			send_linie();
		}
		if (sendflag && ecflag==1) {
			alfalow(str);
			pack_init(str);
			pack_int2((long)-4);
			web_errormess(0,ws_langstr,"4");
			pack_exchkend();
			send_linie();
		}
		return(0);
	}
*/
	if (funk==1 && resnr>0) {
/* NYT 130321 FIRMALEJERMEDL */
		(void)styr_lejermedlopl(1);
		if (ecflag==1 && kundeinddato>0) {
			r159->forv_dato_ind = kundeinddato;
		}
		if (ecflag==1 && kundeindtid>0) {
			r159->forv_tid_ind = kundeindtid;
		}
		r159->opdat_dato = ws_systemdato;
		resdatagem(bss->data_sti);
/* NYT 051110 */
		reclow(r145,R145);
		if (r159->status==5) {
			r145->opdfunk = 5;
		}
		if (r159->status==2 ||
			r159->status==10) {
			r145->opdfunk = 1;
		}
		r145->rec_x = r159->record_x;
		r145->rec_tp = r159->kontrakttype_kode;
		r145->lbnr = (ULI)time(0);
		r145->kundenr = r159->lejerkundenr;
		r145->dato = ws_systemdato;
		r145->klslet = ws_systemtid;
		r145->statnr = r159->station_ud_nr;
		r145->pcnr = -1;
		r145->status = 1;
		r145->prognr = 7912;
		r145->progfunk = ws_funktion;
/* NYT 080229 */
		r145->dato_ud = r159->dato_ud;
		r145->tid_ud = (short int)r159->tid_ud;

		egewrite(f145);
		if (f145_ukendt) {
			console_err("bss.log ikke gemt");
		}
	}
/* FATAL LOG */
	if (funk==1 && r145->rec_x<=20000000) {
		fatalnrfejl = 6;
	}
	if (funk==1 && r145->rec_x>29999999) {
		fatalnrfejl = 6;
	}
	if (funk==1 && r145->rec_x<=0) {
		fatalnrfejl = 5;
	}
	sprintf(dum_str,
		"nyopret_reservation:2:fatalnrfejl=%hd",
		fatalnrfejl);
	logfil_put(dum_str);

/* EVT TEST BETA */
	if (funk==1 && fatalnrfejl>0) {
		sprintf(dum_str,"%sfatalnr.log",ws_kreds);
		tmpfil = fopen(dum_str,"a");
	}
	if (funk==1 && fatalnrfejl>0 && tmpfil) {
		fprintf(tmpfil,"reslog %ld %ld %ld %ld\n",
			ege_date(),ege_time(),resnr,r145->rec_x);
		fprintf(tmpfil,"%s\n",str);
		fclose(tmpfil);
	}
	if (funk==1 && fatalnrfejl>0) {
		tmpfil = (FILE*)0;
	}

/* NYT 060821 MAIL */
	funkretur = 0;
	for (wx1=0;wx1<strlen(r159->skade[1]);wx1++) {
		if (r159->skade[1][wx1]==64) {
			funkretur++;
		}
	}
	for (wx1=0;wx1<strlen(r159->skade[2]);wx1++) {
		if (r159->skade[2][wx1]==64) {
			funkretur++;
		}
	}
	if (ecflag==1 && funk==1 &&
		ws_udldkflag<=0 &&
		funkretur==1 &&
		r159->record_x>0 &&
		r159->lejerkundenr>0 &&
		strlen(r159->skade[1])) {
		sprintf(dum_str,"nyopret_reservation:mailadropdat %ld,%ld %s%s",
			r159->lejerkundenr,
			r159->record_x,
			r159->skade[1],
			r159->skade[2]);
		logfil_put(dum_str);
		reclow(r178,R178);
		f178_start(1,ISGTEQ);
		sprintf(r178->alfa_felt,"%s%s",r159->skade[1],r159->skade[2]);
                opdat_r178(10,(double)r159->lejerkundenr);
	}
/* UDLDK OPDATER KUNDEDATA UDLDKNOTER */
	nuvnotelbnr = 0;
	if (ecflag==1 && funk==1 && ws_udldkflag>0 && r159->record_x>0) {
		opdat_f359_alfa(21,ws_paratab[6],r159->record_x);
	}
	if (ecflag==1 && funk==1 && ws_udldkflag>0 && r159->record_x>0) {
		opdat_f359_alfa(31,ws_flynr,r159->record_x);
	}
	if (ecflag==1 && funk==1 && ws_udldkflag>0 && r159->record_x>0 &&
		r159->lejerkundenr>0 && strlen(ws_paratab[6])) {
		reclow(r178,R178);
		f178_start(1,ISGTEQ);
		sprintf(r178->alfa_felt,"%s",ws_paratab[6]);
                opdat_r178(10,(double)r159->lejerkundenr);
	}
	if (ecflag==1 && funk==1 && ws_udldkflag>0 && r159->record_x>0 &&
		r159->lejerkundenr>0 && strlen(ws_udldkbemtab[8])) {
		reclow(r178,R178);
		f178_start(1,ISGTEQ);
		sprintf(r178->alfa_felt,"%s",ws_udldkbemtab[8]);
                opdat_r178(9,(double)r159->lejerkundenr);
	}
	if (ecflag==1 && funk==1 && ws_udldkflag>0 && r159->record_x>0) {
		nextnotelbnr = (int)add_extra_f183(r159->record_x,
			(short int)1159,
			(long int)nuvnotelbnr);
		nuvnotelbnr = nextnotelbnr;
	}
/*
	if (ecflag==1 && funk==1 && ws_udldkflag>0 && r159->record_x>0 &&
		strlen(ws_paratab[6])) {
		nextnotelbnr = (int)add_noter_f183(r159->record_x,
			(short int)1159,
			(long int)nuvnotelbnr,
			ws_paratab[6],
			"bookingmailadr:");
		nuvnotelbnr = nextnotelbnr;
	}
*/
/* NYT 090406 */
	if (ecflag==1 && funk==1 && ws_udldkflag>0 && r159->record_x>0 &&
		udldkfrgspg>0) {
		ege_w_int1 = m036_funktion(17, ws_systemdato),
		sprintf(tmpstr,"%2.2ld.%2.2ld.%4.4ld-%4.4ld - %hd timer",
			ege_w_int1 / 1000000,
			(ege_w_int1 % 1000000) / 10000,
			ege_w_int1 % 10000,
			ws_systemtid,
			udldkfrgspg);
		tmpstr[2] = '.';
		tmpstr[5] = '.';
		nextnotelbnr = (int)add_noter_f183(r159->record_x,
			(short int)1159,
			(long int)nuvnotelbnr,
			tmpstr,
			"forespørgsel:");
		nuvnotelbnr = nextnotelbnr;
	}
	if (ecflag==1 && funk==1 && ws_udldkflag>0 && r159->record_x>0 &&
		strcmp(ws_udldkidtab[1],"00_NOTAT")==0 &&
		strlen(ws_udldkdatatab[1])) {
		if (logfil) {
			fprintf(logfil,"nyopret_reservation:NOTER=%s\n",
				ws_udldkdatatab[1]);
		}
		ws_udldkdatatab[1][70] = '\0';
		nextnotelbnr = (int)add_noter_f183(r159->record_x,
			(short int)1159,
			(long int)nuvnotelbnr,
			ws_udldkdatatab[1],
			"ønsker:");
		nuvnotelbnr = nextnotelbnr;
	}
	if (ecflag==1 && funk==1 && ws_udldkflag>0 && r159->record_x>0 &&
		strlen(ws_udldkbemtab[9])) {
		nextnotelbnr = (int)add_noter_f183(r159->record_x,
			(short int)1159,
			(long int)nuvnotelbnr,
			ws_udldkbemtab[9],
			"codrivere:");
		nuvnotelbnr = nextnotelbnr;
	}

	if (ecflag==1 && funk==1 && ws_udldkflag>0 && r159->record_x>0 &&
		strlen(ws_udldkbemtab[10])) {
		nextnotelbnr = (int)add_noter_f183(r159->record_x,
			(short int)1159,
			(long int)nuvnotelbnr,
			ws_udldkbemtab[10],
			"bemærkninger:");
		nuvnotelbnr = nextnotelbnr;
	}
/* NYT 090501 FAX */

/* NYT 090430 */
	if (ecflag==1 && funk==1 && ws_udldkflag>0 && r159->record_x>0) {
        	reclow(r155, R155);
		f155_start(1,ISGTEQ);
        	reclow(r155, R155);
		r155->funktion = 1;
		strcpy(r155->sign, "web");
		r155->lb_nr = (ULI)time(0);
		r155->dato = ws_systemdato;
		r155->kl_slet = ws_systemtid;
		r155->statnr = bss->id_stat_nr;
		r155->pcnr = 0;
		r155->type = 3;
		r155->statud = r159->station_ud_nr;
		r155->record_x = resnr;
		egewrite(f155);
	}
/* TEST */
	sprintf(dum_str,
		"nyopret_reservation:nuvnotelbnr=%ld",
		nuvnotelbnr);
	logfil_put(dum_str);
	if (logfil) {
		fprintf(logfil,"DON2RATELISTE\n");
	}
	wx1 = 0;
	while (wx1<10 && logfil) {
		fprintf(logfil,
	"\t%hd=%s inclfelt=%s\n",
			wx1,
			r159->rate_tekst[wx1],
			r159->rate_incl_felt[wx1]);
		fprintf(logfil,
	"\t%hd ant=%ld spc=%hd grp=%s enh=%hd pris=%.2lf incl=%ld ialt=%.2lf\n",
			wx1,
			r159->rate_antal[wx1],
			r159->rate_spec_nr[wx1],
			r159->rate_gruppe[wx1],
			r159->rate_enhed[wx1],
				r159->rate_pris[wx1],
			r159->rate_incl_km[wx1],
			r159->rate_ialt[wx1]);
		wx1++;
	}
	sprintf(dum_str,
		"nyopret_reservation:cdi(%hd) antal=%ld dag=%.2lf ialt=%.2lf",
		r159->forsikring_cdw,
		r159->cdw_antal_dage,
		r159->pris_cdw_pr_dag,
		r159->cdw_ialt);
	logfil_put(dum_str);
	sprintf(dum_str,
		"nyopret_reservation:pai(%hd) antal=%ld dag=%.2lf ialt=%.2lf",
		r159->forsikring_pai,
		r159->pai_antal_dage,
		r159->pris_pai_pr_dag,
		r159->pai_ialt);
	logfil_put(dum_str);
	sprintf(dum_str,
		"nyopret_reservation:%ld-navn=%s %s",
		r159->lejerkundenr,
		r159->lejerfornavn,
		r159->lejerefternavn);
	logfil_put(dum_str);
	sprintf(dum_str,
		"nyopret_reservation:%ld-tlf=%s (paratab-7=%s)",
		r159->lejerkundenr,
		r159->lejertlf,
		ws_paratab[7]);
	logfil_put(dum_str);
	sprintf(dum_str,
		"nyopret_reservation:%ld-mail=? (paratab-6=%s)",
		r159->lejerkundenr,
		ws_paratab[6]);
	logfil_put(dum_str);
	sprintf(dum_str,
		"nyopret_reservation:skade-1+2=%s%s",
		r159->skade[1],
		r159->skade[2]);
	logfil_put(dum_str);
	sprintf(dum_str,
		"nyopret_reservation:medlejer=(%hd)%s %s",
		r159->medl_ja_nej,
		r159->medlfornavn,
		r159->medlefternavn);
	logfil_put(dum_str);
	totalpris = r159->total;
	

	if (funk==0) {
		return(1);
	}
/* TEST OBS
	resnr = -1;
*/
/* NYT 100407 */
	if (funk==1 && sendflag>0 && ecflag>0 && ws_udldkflag>0 && resnr<=0) {
		fatalnrfejl++;
	}
	if (funk==1 && fatalnrfejl>0) {
		sprintf(dum_str,"%sfatalnr.log",ws_kreds);
		tmpfil = fopen(dum_str,"a");
	}
	if (funk==1 && fatalnrfejl>0 && tmpfil) {
		fprintf(tmpfil,"sendnr %ld %ld %ld %s %s\n",
			ege_date(),ege_time(),resnr,
			r159->lejerfornavn,
			r159->lejerefternavn);
		fprintf(tmpfil,"%s\n",str);
		fclose(tmpfil);
	}
	if (funk==1 && fatalnrfejl>0) {
		tmpfil = (FILE*)0;
	}
/* NYT 070413 */
	if (sendflag && fatalnrfejl<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)resnr);
		if (ecflag==1) {
			sprintf(dum_str,"%s %s",
				r159->lejerfornavn,
				r159->lejerefternavn);
			pack_alfa(dum_str);
		}
/* NYT 110107 VINTERUDL */
		if (ecflag==1 && ws_udldkflag>0) {
			pack_int2((long)udldkfrgspg);
		}
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil,"SENDT=%s\n",str);
			fflush(logfil);
		}
	}
	if (sendflag && fatalnrfejl>0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-4);
		sprintf(dum_str,"BOOKNR FATAL FEJL-PRØV IGEN");
		pack_alfa(dum_str);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil,"SENDT=%s\n",str);
			fflush(logfil);
		}
	}

/* OBS UDLDKBOOK 090326 */
	if (ecflag==1 && r159->dato_ud==ws_systemdato && ws_udldkflag>0) {
/* TEST */
		sprintf(dum_str,"nyopret_reservation send_station_mail KALDES");
		logfil_put(dum_str);
		send_station_mail(r159->station_ud_nr);
	}
	if (ecflag==1 && r159->dato_ud==ws_systemdato && ws_udldkflag<=0) {
/* TEST */
		sprintf(dum_str,"nyopret_reservation send_station_mail KALDES");
		logfil_put(dum_str);
		send_station_mail(r159->station_ud_nr);
	}
/* NYT 090408 AFVENTER MB */
/*
	if (ecflag==1) {
		sprintf(dum_str,"nyopret_reservation chksend_vagtmail KALDES");
		logfil_put(dum_str);
		chksend_vagtmail(r159->station_ud_nr,
			ws_systemdato,
			ws_systemtid,
			r159->dato_ud,
			r159->tid_ud);
	}
*/
/* NYT 110210 AGENTPRINT */
	if (ecflag==1 && ws_udldkflag>0) {
		styr_resprint(r159->station_ud_nr);
	}

	if (ecflag==1) {
/* TEST */
		sprintf(dum_str, "nyopret_reservation ECWEB SLUT");
		logfil_put(dum_str);
		return(1);
	}
	if (resnr>0 && ws_kundenr>0 && dondafolo==0) {
		(void)find_r178(0,10,0,(double)ws_kundenr);
	}
	if (resnr>0 && ws_kundenr>0 && dondafolo==0 &&
		strlen(r178->alfa_felt)) {
		(void)send_reservation(2,
			ws_langstr,
			r178->alfa_felt,
			"",
			ws_kontantflag,
			varighed);
	}
/* TEST */
	sprintf(dum_str, "nyopret_reservation DON2SLUT");
	logfil_put(dum_str);
	return(1);
}

/* ***************************************************************** */
static int check_promoextdage() {
	int retur = 0;
	int nuvidx = 1;
	int maxidx = 9;
	short int checkspcnr = 0;

	if (logfil) {
		fprintf(logfil,"check_promoextdage\n");
	}
	checkspcnr = 186;
	while (nuvidx<=maxidx && retur==0) {
		if (r159->rate_spec_nr[nuvidx]<=0) {
			nuvidx++;
			continue;
		}
		if (r159->rate_spec_nr[nuvidx]!=checkspcnr) {
			nuvidx++;
			continue;
		}
		if (r159->rate_antal[nuvidx]<=0) {
			nuvidx++;
			continue;
		}
		if (strncmp(r159->rate_tekst[nuvidx],"PROMO",5)!=0) {
			nuvidx++;
			continue;
		}
		retur = (int)r159->rate_antal[nuvidx];
	}
afslut:
	if (logfil) {
		fprintf(logfil,"check_promoextdage:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ***************************************************************** */
static int check_promokode(char *inpid) {
	int retur = 0;
	int nuvidx = 1;
	int maxidx = 9;
	short int checkspcnr = 0;

	if (logfil) {
		fprintf(logfil,"check_promokode: inpid=%s\n",
			inpid);
	}
	if (strlen(inpid)) {
		sscanf(inpid,"%hd",&checkspcnr);
	}
	if (logfil) {
		fprintf(logfil,"\tcheckspcnr=%hd\n",
			checkspcnr);
	}
	if (checkspcnr<0) { goto afslut; }
	if (checkspcnr>999) { goto afslut; }
	while (nuvidx<=maxidx && retur==0) {
		if (r159->rate_spec_nr[nuvidx]<=0) {
			nuvidx++;
			continue;
		}
		if (r159->rate_spec_nr[nuvidx]!=checkspcnr) {
			nuvidx++;
			continue;
		}
		if (r159->rate_antal[nuvidx]<=0) {
			nuvidx++;
			continue;
		}
		if (strncmp(r159->rate_tekst[nuvidx],"PROMO",5)!=0) {
			nuvidx++;
			continue;
		}
		retur = (int)r159->rate_antal[nuvidx];
	}
afslut:
	if (logfil) {
		fprintf(logfil,"check_promokode:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* ***************************************************************** */
static int styr_promokode(short inpextidx) {
	int retur = 0;
	short int promospecnr = 0;
	long int promoantal = 0;
	short int promostnr = 0;
	short int promoidx = 0;
	short int aftaleflag = 0;
	char promogrp[11] = "";
	char promotxt[41] = "";

	if (logfil) {
		fprintf(logfil,"styr_promokode: inpextidx=%hd %s\n",
			inpextidx,
			ws_promokode);
	}
	promoidx = inpextidx;
	if (strcmp(ws_promokode,"PROMO1")==0) {
		promospecnr = 950;
		promoantal = 1;
		strcpy(promogrp,"ALLE");
		promostnr = ws_station;
		(void)add_prislinie(0,
			0, /* varighed */
			promoidx,
			promostnr,
			promospecnr,
			promogrp,
			promoantal,
			aftaleflag);
		r159->rate_pris[promoidx] = -80;
		r159->rate_antal[promoidx] = 1;
		r159->rate_incl_km[promoidx] = 0;
		sprintf(r159->rate_tekst[promoidx],"%s-100kr",ws_promokode);
/*
		udregn_incl();
		udregn_ekstra();
		opsaet_forsikring(promoidx);
*/
		promoidx++;
		retur++;
	}
	if (strcmp(ws_promokode,"PROMO2")==0) {
		promospecnr = 950;
		promoantal = 1;
		strcpy(promogrp,"ALLE");
		promostnr = ws_station;
		(void)add_prislinie(0,
			0, /* varighed */
			promoidx,
			promostnr,
			promospecnr,
			promogrp,
			promoantal,
			aftaleflag);
		r159->rate_pris[promoidx] = 0;
		r159->rate_antal[promoidx] = 1;
		r159->rate_incl_km[promoidx] = 100;
		sprintf(r159->rate_tekst[promoidx],"%s-100km",ws_promokode);
		udregn_incl();
/*
		udregn_ekstra();
		opsaet_forsikring(promoidx);
*/
		promoidx++;
		retur++;
	}
	if (strcmp(ws_promokode,"PROMO3")==0) {
		promospecnr = 932;
		promoantal = 1;
		strcpy(promogrp,"ALLE");
		promostnr = ws_station;
		(void)add_prislinie(0,
			0, /* varighed */
			promoidx,
			promostnr,
			promospecnr,
			promogrp,
			promoantal,
			aftaleflag);
		r159->rate_pris[promoidx] = 0;
		r159->rate_antal[promoidx] = 1;
		r159->rate_incl_km[promoidx] = 0;
		strcpy(promotxt,r159->rate_tekst[promoidx]);
		promotxt[10] = '\0';
		sprintf(r159->rate_tekst[promoidx],"%s-%s",
			ws_promokode,
			promotxt);
/*
		udregn_incl();
		udregn_ekstra();
		opsaet_forsikring(promoidx);
*/
		promoidx++;
		retur++;
	}
/* NYT 121111 */
	if (strcmp(ws_promokode,"PROMO4")==0) {
		promospecnr = 186;
		promoantal = 1;
		strcpy(promogrp,ws_grp);
		promostnr = ws_station;
		(void)add_prislinie(0,
			0, /* varighed */
			promoidx,
			promostnr,
			promospecnr,
			promogrp,
			promoantal,
			aftaleflag);
		r159->rate_pris[promoidx] = 0;
		r159->rate_antal[promoidx] = 1;
		r159->rate_incl_km[promoidx] = 0;
		strcpy(promotxt,r159->rate_tekst[promoidx]);
		promotxt[10] = '\0';
		sprintf(r159->rate_tekst[promoidx],"%s","PROMOEXTDAG");
/*
		sprintf(r159->rate_tekst[promoidx],"%s-%s",
			ws_promokode,
			promotxt);
*/
/*
		udregn_incl();
		udregn_ekstra();
		opsaet_forsikring(promoidx);
*/
		promoidx++;
		retur++;
	}
	if (logfil) {
		fprintf(logfil,"\nstyr_promokode:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* NYT 130321 */
/* ***************************************************************** */
static int styr_lejermedlopl(int inpfunk) {
	int retur = 0;
	int idxnr = -1;
	int antal = 0;
	int sletmedlflag = 0;
	long int nuvknr = 0;
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil,"styr_lejermedlopl:%d\n",inpfunk);
		fprintf(logfil,"\tws_kundenr=%ld\n",ws_kundenr);
		fflush(logfil);
	}
	if (ws_kundenr<=0) { goto afslut; }
	reclow(r167,R167);
	f167_start(1,ISGTEQ);
	r167->kunde_nr = ws_kundenr;
	egeread(f167,ISEQUAL);
	if (f167_ok && r167->type==2) {
		idxnr = 0;
	}
	if (logfil) {
		fprintf(logfil,"\tidxnr=%d\n",idxnr);
	}
	if (idxnr<0) { goto afslut; }
	while (idxnr>=0 && idxnr<10) {
		if (logfil) {
			fprintf(logfil,"\t\tLOOPTOP antal=%d\n",antal);
			fprintf(logfil,"\t\tLOOPTOP idxnr=%d\n",idxnr);
		}
		nuvknr = 0;
		if (antal>=4) {
			break;
		}
		if (!strlen(ws_drivertab[idxnr])) {
			idxnr++;
			continue;
		}
		sscanf(ws_drivertab[idxnr],"%ld",&nuvknr);
		if (nuvknr<=0) {
			idxnr++;
			continue;
		}
		if (logfil) {
			fprintf(logfil,"\t\tnuvknr=%ld\n",nuvknr);
		}
		r167->kunde_nr = nuvknr;
		egeread(f167,ISEQUAL);
		if (f167_ukendt) {
			idxnr++;
			continue;
		}
		if (r167->type!=1) {
			idxnr++;
			continue;
		}
		if (logfil) {
			fprintf(logfil,"\t\t%ld<%s> <%s>\n",
				r167->kunde_nr,
				r167->navn_1,
				r167->navn_2);
		}
		if (antal==0) {
			r159->lejerkundenr = r167->kunde_nr;
			strcpy(r159->lejerfornavn, r167->navn_1);
			strcpy(r159->lejerefternavn, r167->navn_2);
			strcpy(r159->lejerconavn, r167->adr_1);
			strcpy(r159->lejeradr, r167->adr_2);
			strcpy(r159->lejerpostkode, r167->postkode);
			strcpy(r159->lejerby, r167->by);
			strcpy(r159->lejerland, r167->land);
			strcpy(r159->lejertlf, r167->tlf);
			r159->lejerfoedselsdato = r167->foedselsdato;
			r159->lejercheckcif = r167->checkcif;
			strcpy(r159->lejerkkortnr, r167->kkortnr);
			strcpy(r159->lejerkkort_udstedt_af, r167->kkort_ud_af);
			r159->lejerkkort_udstedt_den = r167->kkort_ud_den;
			strcpy(r159->lejerpasnr, r167->pasnr);
			strcpy(r159->lejerpas_udstedt_af, r167->pas_ud_af);
			r159->lejerpas_udstedt_den = r167->pas_ud_den;
			r159->lejerpas_gyldig_til = r167->pas_gyldig_til;
			strcpy(r159->lejer_rabat_betingelse, r167->rabat_bet);
			r159->lejer_rabat_pct[0] = r167->rabat_lok;
			r159->lejer_rabat_pct[1] = r167->rabat_serv;
			r159->lejer_rabat_pct[2] = r167->rabat_int;
			r159->lejerstatus = r167->status;
			strcpy(r159->lejerbem, r167->bem);
			r159->lejer_firma_ref = r167->firma_reference;
			strcpy(r159->lejer_foede_sted, r167->foede_sted);
			r159->sprog_kode = r167->dk_ja_nej;
			r159->lejer_kto_nr = r167->debitor_reference;
			r159->lejer_gwid = r167->gw_id;
			r159->lejer_recap = 0;
			if (strlen(r167->recap_nr)) {
				sscanf(r167->recap_nr,"%lf",&r159->lejer_recap);
			}
		}
/* NYT 131128 MEDLEJERSLET */
		if (antal==0 &&
			strcmp(r159->lejerfornavn,r159->medlfornavn)==0) {
			sletmedlflag++;
		}
		if (antal==0 &&
			strcmp(r159->lejerefternavn,r159->medlefternavn)==0) {
			sletmedlflag++;
		}
		if (antal==0 &&
			strcmp(r159->lejerkkortnr,r159->medlkkortnr)==0) {
			sletmedlflag++;
		}
		if (antal==0 &&
			r159->lejerfoedselsdato==r159->medlfoedselsdato) {
			sletmedlflag++;
		}
		if (antal==0 && sletmedlflag==4) {
			strcpy(r159->medlfornavn,"");
			strcpy(r159->medlefternavn,"");
			strcpy(r159->medlkkortnr,"");
			r159->medlfoedselsdato = 0;
			r159->medl_ja_nej = 0;
		}
		if (antal==1) {
			r159->medlkundenr = r167->kunde_nr;
			strcpy(r159->medlfornavn, r167->navn_1);
			strcpy(r159->medlefternavn, r167->navn_2);
			strcpy(r159->medlconavn, r167->adr_1);
			strcpy(r159->medladr, r167->adr_2);
			strcpy(r159->medlpostkode, r167->postkode);
			strcpy(r159->medlby, r167->by);
			strcpy(r159->medlland, r167->land);
			strcpy(r159->medltlf, r167->tlf);
			r159->medlfoedselsdato = r167->foedselsdato;
			r159->medlcheckcif = r167->checkcif;
			strcpy(r159->medlkkortnr, r167->kkortnr);
			strcpy(r159->medlkkort_udstedt_af, r167->kkort_ud_af);
			r159->medlkkort_udstedt_den = r167->kkort_ud_den;
			strcpy(r159->medlpasnr, r167->pasnr);
			strcpy(r159->medlpas_udstedt_af, r167->pas_ud_af);
			r159->medlpas_udstedt_den = r167->pas_ud_den;
			r159->medlpas_gyldig_til = r167->pas_gyldig_til;
			r159->medl_ja_nej = 1;
		}
		if (antal==2) {
			sprintf(tmpstr,"Medl:%s,%s",r167->navn_2,r167->navn_1);
			tmpstr[30] = '\0';
			strcpy(r159->skade[0],tmpstr);
			sprintf(tmpstr,"Medl:KK=%s FD=%8.8ld",
				r167->kkortnr,
				r167->foedselsdato);
			tmpstr[30] = '\0';
			strcpy(r159->skade[1],tmpstr);
		}
		if (antal==3) {
			sprintf(tmpstr,"Medl:%s,%s",r167->navn_2,r167->navn_1);
			tmpstr[30] = '\0';
			strcpy(r159->skade[2],tmpstr);
			sprintf(tmpstr,"Medl:KK=%s FD=%8.8ld",
				r167->kkortnr,
				r167->foedselsdato);
			tmpstr[30] = '\0';
			strcpy(r159->skade[3],tmpstr);
		}
		idxnr++;
		antal++;
		retur++;
	}
	if (logfil) {
		fprintf(logfil,"\tSLUTLOOPidxnr=%d\n",idxnr);
		fprintf(logfil,"\tantal=%d\n",antal);
	}
afslut:
	if (logfil) {
		fprintf(logfil,"\tsletmedlflag=%d\n",sletmedlflag);
		fprintf(logfil,"\tmedlfornavn=%s\n",r159->medlfornavn);
		fprintf(logfil,"\tmedlefternavn=%s\n",r159->medlefternavn);
		fprintf(logfil,"styr_lejermedlopl:retur=%d\n",retur);
		fflush(logfil);
	}
	return(retur);
}

/* **************************************************** */
static int check_bonus(short funk,short inpspecnr,char *inpspctxt,long inpuddato) {
	int retur = 0;
	long int julian = 0;
	long int bonusuddato = 0;
	long int dgantal = 0;
	long int oplkode = 0;
	char keyalfa[21] = "";
	char chkstr[41] = "";

	if (logfil) {
		fprintf(logfil,"check_bonus:funk=%hd %hd %s %ld\n",
			funk,
			inpspecnr,
			inpspctxt,
			inpuddato);
		fflush(logfil);
	}
	if (funk==1 && inpspecnr>=674 && inpspecnr<=678) { dgantal = 14; }
	if (funk==2 && inpspecnr==673) {
		strcpy(chkstr,inpspctxt);
		ege_toupper((unsigned char *)chkstr);
		oplkode = 16665;
		strcpy(keyalfa,"BONUSKM");
		reclow(r198,R198);
		r198->oplkode = oplkode;
		strcpy(r198->keyalfa,keyalfa);
		f198_start(1,ISGTEQ);
	}
	while (oplkode>0 && dgantal==0) {
		egeread(f198,ISNEXT);
		if (f198_eof) { break; }
		if (r198->oplkode!=oplkode) { break; }
		if (strcmp(r198->keyalfa,keyalfa)!=0) { break; }
		ege_toupper((unsigned char *)r198->alfafelt);
		if (strncmp(chkstr,r198->alfafelt,strlen(r198->alfafelt))!=0) {
			continue;
		}
		dgantal = (long int)r198->numfelt;
	}
	if (logfil) {
		fprintf(logfil,"\tdgantal=%ld\n",dgantal);
		fflush(logfil);
	}
	julian = m036_funktion(12, ws_systemdato);
	julian += dgantal;
	bonusuddato = m036_funktion(19, julian);
	if (funk==1 && dgantal>0 &&
		inpuddato>bonusuddato && r159->rate_antal[0]==1) {
		retur = 1;
	}
	if (funk==2 && dgantal>0 &&
		inpuddato>bonusuddato && r159->rate_antal[0]==1) {
		retur = 1;
	}
/*
	if (retur==1) {
		r159->rate_incl_km[10] += 100;
	}
*/
	if (logfil) {
		fprintf(logfil,"check_bonus:retur %d\n",
			retur);
		fflush(logfil);
	}
	return(retur);
}

/* ******************************************************************** */
/* 16669 Ax110B								*/
static int check_grp_firmaaft_blok(int funk,long fradato,long tildato,char *grp) {
	int retur = 0;
	int grpok = 0;

	if (logfil) {
		fprintf(logfil,
			"check_grp_firmaaft_blok:funk=%d %ld-%ld grp=%s\n",
			funk,
			fradato,
			tildato,
			grp);
		fflush(logfil);
	}
	reclow(r198,R198);
	r198->oplkode = 16669;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		retur = -1;
	}
	while (retur==0) {
		egeread(f198,ISNEXT);
		if (f198_eof) { break; }
		if (r198->oplkode!=16669) { break; }
		if (r198->numfelt<=0) { continue; }
		grpok = 0;
		if (strcmp(r198->alfafelt,"*")==0) {
			grpok = 1;
		}
		if (strlen(grp) && strcmp(r198->alfafelt,grp)==0) {
			grpok = 1;
		}
		if (grpok<=0) {
			continue;
		}
		if (fradato>=r198->fradato && fradato<=r198->tildato) {
			retur = 1;
		}
	}
	if (logfil) {
		fprintf(logfil,"check_grp_firmaaft_blok:retur=%d\n", retur);
		fflush(logfil);
	}
	return(retur);
}

/* ***************************************** */
static int check_hlg_firmaaft_blok(int funk,long fradato,long tildato) {
	int retur = 0;

	if (logfil) {
		fprintf(logfil,"check_hlg_firmaaft_blok:funk=%d %ld-%ld\n",
			funk,
			fradato,
			tildato);
		fflush(logfil);
	}
	reclow(r198,R198);
	r198->oplkode = 16550;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		retur = -1;
	}
	while (retur==0) {
		egeread(f198,ISNEXT);
		if (f198_eof) { break; }
		if (r198->oplkode!=16550) { break; }
		if (r198->numfelt<=0) { continue; }
		if (fradato>=r198->fradato && fradato<=r198->tildato) {
			retur = 1;
		}
	}
	if (logfil) {
		fprintf(logfil,"check_hlg_firmaaft_blok:retur=%d\n", retur);
		fflush(logfil);
	}
	return(retur);
}

/* ***************************************************** */
static int styr_resprint(short inpstud) {
	int retur = 0;
	int printflag = 0;

	if (logfil) {
		fprintf(logfil,"styr_resprint:inpstud=%hd\n",
			inpstud);
		fflush(logfil);
	}
	reclow(r198,R198);
	f198_start(1,ISGTEQ);
	r198->oplkode = 16652;
	r198->keynum = (double)inpstud;
	egeread(f198,ISEQUAL);
	if (f198_ok && r198->numfelt>0) {
		printflag = 1;
	}
	if (logfil) {
		fprintf(logfil,"\tHERTIL-1 printflag=%d\n",
			printflag);
		fflush(logfil);
	}
	reclow(r166, R166);
	r166->stat_nr = inpstud;
	egeread(f166, ISEQUAL);
	if (f166_ok && r166->res_frist!=0) {
		printflag = 0;
        }
	if (logfil) {
		fprintf(logfil,"\tHERTIL-2 printflag=%d\n",
			printflag);
		fflush(logfil);
	}
	if (printflag>0) {
		bsslp_type(2);
	}
	if (printflag>0 && bsslp_aaben()==0) {
		printflag = -1;
	}
	if (printflag>0) {
		udskriv_res(0,"");
		bsslp_luk();
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"styr_resprint:retur=%d,printflag=%d\n",
			retur,printflag);
		fflush(logfil);
	}
	return(retur);
}

/* **************************************** */
static void opdater_udldkresdata() {
	char tmpstr[81] = "";

/* LOKAL */
	if (strlen(ws_udldkbemtab[1])) {
		ws_udldkbemtab[1][30] = '\0';
		r159->lokal_ja_nej = 1;
		strcpy(r159->lokal_navn,ws_udldkbemtab[1]);
	}
	if (strlen(ws_udldkbemtab[4])) {
		ws_udldkbemtab[4][15] = '\0';
		r159->lokal_ja_nej = 1;
		strcpy(r159->lokal_postnr,ws_udldkbemtab[4]);
	}
	if (strlen(ws_udldkbemtab[5])) {
		ws_udldkbemtab[5][15] = '\0';
		r159->lokal_ja_nej = 1;
		strcpy(r159->lokal_by,ws_udldkbemtab[5]);
	}
	if (strlen(ws_udldkbemtab[11])) {
		ws_udldkbemtab[11][30] = '\0';
		r159->lokal_ja_nej = 1;
		strcpy(r159->lokal_adr,ws_udldkbemtab[11]);
	}
/* LEJER */
	if (strlen(ws_udldkbemtab[2])) {
		ws_udldkbemtab[2][30] = '\0';
		strcpy(r159->lejeradr,ws_udldkbemtab[2]);
	}
	if (strlen(ws_udldkbemtab[6])) {
		ws_udldkbemtab[6][15] = '\0';
		strcpy(r159->lejerpasnr,ws_udldkbemtab[6]);
	}
	if (strlen(ws_udldkbemtab[7])) {
		ws_udldkbemtab[7][20] = '\0';
		sprintf(tmpstr,"%s/%s",r159->lejertlf,ws_udldkbemtab[7]);
		tmpstr[20] = '\0';
		strcpy(r159->lejertlf,tmpstr);
	}
/* NYT 091217 */
	if (strlen(ws_udldkland)) {
		strcpy(tmpstr,ws_udldkland);
		tmpstr[20] = '\0';
		strcpy(r159->lejerland,tmpstr);
	}
	return;
}

/* **************************************** */
static int add_extra_f183(long konnr,short type,long lbnr) {
	short int wx1 = 0;
	short int wx2 = 0;
	int nextlbnr = (int)lbnr;

/* TEST */
	if (logfil) {
		fprintf(logfil,"add_extra_f183:\n");
		fprintf(logfil,"\tnextlbnr=%d\n",nextlbnr);
	}
	reclow(r183, R183);
	f183_start(1,ISGTEQ);
	if (nextlbnr==0) {
		r183->ref_type = type;
		r183->ref_num = (double)konnr;
		r183->medd_id = 0;
		r183->lb_nr = (long int)nextlbnr;
		r183->status = 1;
		r183->user_id = 0;
		r183->unix_tid = (ULI) time(0);
		strcpy(r183->alfa_felt,"<!noter>");
		opdat_r183();
		nextlbnr++;
	}
	wx1 = 1;
	wx2 = 0;
	while (wx1<10) {
		if (r159->rate_spec_nr[wx1]<=0) {
			wx1++;
			continue;
		}
		if (r159->rate_spec_nr[wx1]==990) {
			wx1++;
			continue;
		}
		if (r159->rate_antal[wx1]<=0) {
			wx1++;
			continue;
		}
		if (wx2==0) {
			r183->ref_type = type;
			r183->ref_num = (double)konnr;
			r183->medd_id = 0;
			r183->lb_nr = (long int)nextlbnr;
			r183->status = 1;
			r183->user_id = 0;
			r183->unix_tid = (ULI) time(0);
			strcpy(r183->alfa_felt,"EKSTRAUDSTYR");
			opdat_r183();
			nextlbnr++;
		}
		r183->ref_type = type;
		r183->ref_num = (double)konnr;
		r183->medd_id = 0;
		r183->lb_nr = (long int)nextlbnr;
		r183->status = 1;
		r183->user_id = 0;
		r183->unix_tid = (ULI) time(0);
		strcpy(r183->alfa_felt,r159->rate_tekst[wx1]);
/* NYT 100107 */
		if (ws_udldkflag>0 && r159->rate_spec_nr[wx1]==996) {
			strcat(r183->alfa_felt,"-GRATIS");
		}
		opdat_r183();
		nextlbnr++;
		wx2++;
		wx1++;
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,"add_extra_f183:nextlbnr=%d\n",nextlbnr);
	}
	return(nextlbnr);
}

/* **************************************** */
static int add_noter_f183(long konnr,short type,long lbnr,char *inpstr,char *infostr) {
	short int wx1 = 0;
	short int wx2 = 0;
	int nextlbnr = (int)lbnr;
	char gemstr[201] = "";

/* TEST */
	if (logfil) {
		fprintf(logfil,"add_noter_f183:inpstr=%s\n",inpstr);
		fprintf(logfil,"\tinfo=%s\n",infostr);
		fprintf(logfil,"\tnextlbnr=%d\n",nextlbnr);
	}
	for (wx1=0;wx1<strlen(inpstr);wx1++) {
		if (logfil) {
			fprintf(logfil,"+%hd",inpstr[wx1]);
		}
	}
	if (logfil) {
		fprintf(logfil,"\n");
	}
	reclow(r183, R183);
	f183_start(1,ISGTEQ);
	wx1 = 0;
	wx2 = 0;
	while (wx1<strlen(inpstr)) {
		if (inpstr[wx1]==30 && strlen(gemstr)) {
			r183->ref_type = type;
			r183->ref_num = (double)konnr;
			r183->medd_id = 0;
			r183->lb_nr = (long int)nextlbnr;
			r183->status = 1;
			r183->user_id = 0;
			r183->unix_tid = (ULI) time(0);
			if (lbnr==nextlbnr) {
				gemstr[60] = '\0';
				sprintf(r183->alfa_felt,"%s%s",infostr,gemstr);
			} else {
				strcpy(r183->alfa_felt, gemstr);
			}
			opdat_r183();
			nextlbnr++;
		}
		if (inpstr[wx1]==30) {
			strcpy(gemstr,"");
			wx2 = 0;
			wx1++;
			continue;
		}
		gemstr[wx2] = inpstr[wx1];
		wx2++;
		gemstr[wx2] = '\0';
		wx1++;
	}
	if (strlen(gemstr)) {
		r183->ref_type = type;
		r183->ref_num = (double)konnr;
		r183->medd_id = 0;
		r183->lb_nr = (long int)nextlbnr;
		r183->status = 1;
		r183->user_id = 0;
		r183->unix_tid = (ULI) time(0);
		if (lbnr==nextlbnr) {
			gemstr[60] = '\0';
			sprintf(r183->alfa_felt,"%s%s",infostr,gemstr);
		} else {
			strcpy(r183->alfa_felt, gemstr);
		}
		opdat_r183();
		nextlbnr++;
	}
/* TEST */
	if (logfil) {
		fprintf(logfil,"add_noter_f183:nextlbnr=%d\n",nextlbnr);
	}
	return(nextlbnr);
}

/* ********************************************** */
static void opdat_r183() {

	egewrite(f183);
	if (f183_ukendt) {
		reccpy(&w183, r183, R183);
		egeread(f183, ISEQUAL + ISLOCK);
		reccpy(r183, &w183, R183);
		egerew(f183);
		egerel(f183);
	}
	return;
}

/* ********************************************** */
static void opdat_f359_alfa(short oplkode,char *inpstr,long konnr) {

	if (konnr<=0) {
		return;
	}
	reclow(r359,R359);
	f359_start(1,ISGTEQ);
	r359->keynum = (double)konnr;
	r359->oplkode = (long int)oplkode;
	r359->status = 1;
	r359->unixtid = (ULI)time(0);
	strcpy(r359->alfafelt,inpstr);
	egewrite(f359);
	if (f359_ukendt) {
		reccpy (&q359,r359,R359);
		egeread(f359, ISEQUAL + ISLOCK);
		reccpy (r359,&q359,R359);
		egerew(f359);
		egerel(f359);
	}
	return;
}

/* ******************************* */
static void send_billiste(funk,station,langstr,grp)
short int funk;
short int station;
char * langstr;
char * grp; {
	short int wx1 = 0;
	short int antal = 0;
	short int okflag = 0;
	short int brudflag = 0;
	char tmpstr[81];
	char sort_buffer[201];
	char sort_biltype[16];
	char last_biltype[16] = "";

/* TEST */
	sprintf(dum_str,
		"send_billiste:funk=%hd,langstr=%s,grp=%s,stat=%hd",
		funk,
		langstr,
		grp,
		station);
        logfil_put(dum_str);

	reclow(r198, R198);
	r198->oplkode = 16803;
	f198_start(1, ISGTEQ);
	while (antal>=0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode != 16803) {
			break;
		}
		if (strcmp(r198->alfafelt, grp)!=0) {
			continue;
		}
		if (!strlen(r198->keyalfa)) {
			continue;
		}
		if (antal==0) {
			egesort(1, "sort");
		}
		strcpy(sort_biltype, r198->keyalfa);
		for (wx1=0;wx1<sizeof(sort_biltype);wx1++)  {
			if (sort_biltype[wx1] == ' ') {
				sort_biltype[wx1] = '!';
			}
		}
		if (!strlen(sort_biltype)) {
			strcpy(sort_biltype, "!!!!!!!!!!!!!!!");
		}
		sprintf(sort_buffer,"%-15s \n \0",
			sort_biltype);
		egesort(2, sort_buffer);
		antal++;
	}
/* TEST */
	sprintf(dum_str,
		"send_billiste:antal=%hd",
		antal);
        logfil_put(dum_str);

	if (antal<=0) {
		return;
	}
	okflag = 1;
	egesort(3, "sort");
	while (okflag==1) {
		if (egesort(4, sort_buffer) <= 0) {
			okflag = 0;
		}
/* ingen brud */
		if (okflag==0) {
			break;
		}
		sscanf(sort_buffer, "%s",sort_biltype);
		for (wx1=0;wx1<sizeof(sort_biltype);wx1++)  {
			if (sort_biltype[wx1] == '!') {
				sort_biltype[wx1] = ' ';
			}
		}
		egechartest((unsigned char *)sort_biltype);
		ege_toupper((unsigned char *)sort_biltype);
		brudflag = 0;
		if (strcmp(last_biltype, sort_biltype)!=0) {
			brudflag++;
		}
		if (!brudflag) {
			continue;
		}
		alfalow(str);
		pack_init(str);
		pack_alfa(grp);
/* RETTET 040514 */
		(void)f198_tekst(langstr,16526,(double)0,grp,0,tmpstr);
		pack_alfa(tmpstr);
		pack_alfa(sort_biltype);
		(void)f198_tekst(langstr,16801,(double)0,sort_biltype,0,tmpstr);
		pack_alfa(tmpstr);
		(void)f198_tekst(langstr,16802,(double)0,sort_biltype,0,tmpstr);
		pack_alfa(tmpstr);
		(void)f198_tekst(langstr,16804,(double)0,sort_biltype,0,tmpstr);
		pack_alfa(tmpstr);
		(void)f198_tekst(langstr,16806,(double)0,sort_biltype,0,tmpstr);
		pack_alfa(tmpstr);
		(void)f198_tekst(langstr,16807,(double)0,sort_biltype,0,tmpstr);
		pack_alfa(tmpstr);
		(void)f198_tekst(langstr,16808,(double)0,sort_biltype,0,tmpstr);
		pack_alfa(tmpstr);
		(void)f198_tekst(langstr,16809,(double)0,sort_biltype,0,tmpstr);
		pack_alfa(tmpstr);
		(void)f198_tekst(langstr,16810,(double)0,sort_biltype,0,tmpstr);
		pack_alfa(tmpstr);
		(void)f198_tekst(langstr,16811,(double)0,sort_biltype,0,tmpstr);
		pack_alfa(tmpstr);
		(void)f198_tekst(langstr,16812,(double)0,sort_biltype,0,tmpstr);
		pack_alfa(tmpstr);
		(void)f198_tekst(langstr,16813,(double)0,sort_biltype,0,tmpstr);
		pack_alfa(tmpstr);
/* NYT 040416 */
		(void)f198_tekst(langstr,16815,(double)0,sort_biltype,0,tmpstr);
		pack_alfa(tmpstr);
		(void)f198_tekst(langstr,16814,(double)0,sort_biltype,0,tmpstr);
		pack_alfa(tmpstr);

/* RETTET 030619
		pack_alfa(sort_biltype);
		pack_alfa(grp);
		(void)f198_tekst(langstr,16526,(double)0,grp,0,tmpstr);
		pack_alfa(tmpstr);
		(void)f198_tekst(langstr,16801,(double)0,sort_biltype,0,tmpstr);
		pack_alfa(tmpstr);
		(void)f198_tekst(langstr,16802,(double)0,sort_biltype,0,tmpstr);
		pack_alfa(tmpstr);
*/
		pack_exchkend();
		send_linie();
		strcpy(last_biltype, sort_biltype);
	}
	return;
}

/* ************************* */
static void send_biltype(funk,langstr,biltype)
short int funk;
char * langstr;
char * biltype; {
	char gruppe[21] = "";
	short int funkretur;

/* TEST */
	sprintf(dum_str,
		"send_biltype:funk=%hd,langstr=%s,biltype=%s",
		funk,
		langstr,
		biltype);
        logfil_put(dum_str);

	reclow(r198, R198);
	f198_start(1,ISGTEQ);

	alfalow(str);
	pack_init(str);
	funkretur = find_r198(0,16803,(double)0,biltype,0);
	if (funkretur<=0) {
		pack_alfa("UKENDT");
		pack_exchkend();
		send_linie();
		return;
	}
	ege_toupper((unsigned char *)r198->alfafelt);
	pack_alfa(r198->alfafelt);
/* TEST */
	sprintf(dum_str, "send_biltype:hertil:alfafelt=%s",
		r198->alfafelt);
        logfil_put(dum_str);

	strcpy(gruppe, r198->alfafelt);
/* RETTET 040514 */
	funkretur = find_r198(0,16526,(double)0,gruppe,0);
	if (funkretur>0) {
		pack_alfa(r198->alfafelt);
	} else {
		pack_alfa("");
	}
/* TEST */
	sprintf(dum_str, "send_biltype:hertil1:alfafelt=%s",
		r198->alfafelt);
        logfil_put(dum_str);

	funkretur = find_r198(0,16801,(double)0,biltype,0);
	if (funkretur>0) {
		pack_alfa(r198->alfafelt);
	} else {
		pack_alfa("");
	}
	funkretur = find_r198(0,16802,(double)0,biltype,0);
	if (funkretur>0) {
		pack_alfa(r198->alfafelt);
	} else {
		pack_alfa("");
	}
	funkretur = find_r198(0,16804,(double)0,biltype,0);
	if (funkretur>0) {
		pack_alfa(r198->alfafelt);
	} else {
		pack_alfa("");
	}
	funkretur = find_r198(0,16805,(double)0,biltype,0);
	if (funkretur>0) {
		pack_alfa(r198->alfafelt);
	} else {
		pack_alfa("");
	}
	funkretur = find_r198(0,16806,(double)0,biltype,0);
	if (funkretur>0) {
		pack_alfa(r198->alfafelt);
	} else {
		pack_alfa("");
	}
	funkretur = find_r198(0,16807,(double)0,biltype,0);
	if (funkretur>0) {
		pack_alfa(r198->alfafelt);
	} else {
		pack_alfa("");
	}
	funkretur = find_r198(0,16808,(double)0,biltype,0);
	if (funkretur>0) {
		pack_alfa(r198->alfafelt);
	} else {
		pack_alfa("");
	}
	funkretur = find_r198(0,16809,(double)0,biltype,0);
	if (funkretur>0) {
		pack_alfa(r198->alfafelt);
	} else {
		pack_alfa("");
	}
	funkretur = find_r198(0,16810,(double)0,biltype,0);
	if (funkretur>0) {
		pack_alfa(r198->alfafelt);
	} else {
		pack_alfa("");
	}
	funkretur = find_r198(0,16811,(double)0,biltype,0);
	if (funkretur>0) {
		pack_alfa(r198->alfafelt);
	} else {
		pack_alfa("");
	}
	funkretur = find_r198(0,16812,(double)0,biltype,0);
	if (funkretur>0) {
		pack_alfa(r198->alfafelt);
	} else {
		pack_alfa("");
	}
	funkretur = find_r198(0,16813,(double)0,biltype,0);
	if (funkretur>0) {
		pack_alfa(r198->alfafelt);
	} else {
		pack_alfa("");
	}
	pack_exchkend();
	send_linie();

/* sikkerhedsudstyr */
	alfalow(str);
	pack_init(str);
	pack_del();
	(void)add_tekstdata(16814,(double)0,biltype);
	pack_exchkend();
	send_linie();

/* extraudstyr */
	alfalow(str);
	pack_init(str);
	pack_del();
	(void)add_tekstdata(16815,(double)0,biltype);
	pack_exchkend();
	send_linie();

	return;
}

/* ******************** */
static int add_tekstdata(oplkode,keynum,keyalfa)
long int oplkode;
double keynum;
char * keyalfa; {
	short int antal = 0;

	reclow(r198, R198);
	r198->oplkode = oplkode;
	r198->keynum = keynum;
	strcpy(r198->keyalfa, keyalfa);
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		antal = -1;
	}
	while (antal>=0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
		if (r198->keynum!=keynum) {
			break;
		}
		if (strcmp(r198->keyalfa, keyalfa)!=0) {
			break;
		}
		pack_alfa(r198->alfafelt);
		antal++;
	}
	if (antal<=0) {
		pack_alfa("");
	}
/* TEST */
	sprintf(dum_str, "add_tekstdata:oplkode=%ld,antal=%hd",
		oplkode,antal);
        logfil_put(dum_str);

	return(antal);
}

/* ************************* */
static void opdat_biltypedata(oplkode,biltype,datastr)
long int oplkode;
char * biltype;
char * datastr; {
	short int funkretur;

/* TEST */
	sprintf(dum_str,
		"opdat_biltypedata:oplkode=%ld,biltype=%s,datastr=%s",
		oplkode,
		biltype,
		datastr);
        logfil_put(dum_str);

	reclow(r198, R198);
	f198_start(1, ISGTEQ);
	reclow(r198, R198);
	strcpy(r198->alfafelt, datastr);
	opdat_r198(oplkode,(double)0,biltype,0);

	alfalow(str);
	pack_init(str);
	funkretur = find_r198(0,oplkode,(double)0,biltype,0);
	if (funkretur<=0) {
		pack_int2((long)0);
		pack_alfa("UKENDT");
	} else {
		pack_int2((long)1);
		pack_alfa("OK");
	}
	pack_exchkend();
	send_linie();
	return;
}

/* ************************* */
static void opdat_stationdata(oplkode,station,datastr)
long int oplkode;
short int station;
char * datastr; {
	short int funkretur;

/* TEST */
	sprintf(dum_str,
		"opdat_stationdata:oplkode=%ld,station=%hd,datastr=%s",
		oplkode,
		station,
		datastr);
        logfil_put(dum_str);

	reclow(r198, R198);
	f198_start(1, ISGTEQ);
	reclow(r198, R198);
	strcpy(r198->alfafelt, datastr);
	opdat_r198(oplkode,(double)station,"",0);

	alfalow(str);
	pack_init(str);
	funkretur = find_r198(0,oplkode,(double)station,"",0);
	if (funkretur<=0) {
		pack_int2((long)0);
		pack_alfa("UKENDT");
	} else {
		pack_int2((long)1);
		pack_alfa("OK");
	}
	pack_exchkend();
	send_linie();
	return;
}

/* ********************************************** */
static void opdat_password(funk,langstr,kundenr,password)
short int funk;
char * langstr;
long int kundenr;
char * password; {
	short int retur = 0;
	short int dondafolo = 0;
	short int funkretur = 0;
	char emailadr[81] = "";

	if (ws_funktion>=300) {
		dondafolo = 1;
	}
/*
	reclow(r198, R198);
	f198_start(1, ISGTEQ);
	reclow(r198, R198);
	strcpy(r198->alfafelt, password);
	opdat_r198(16701,(double)kundenr,"",0);
*/
/*
	if (dondafolo>0) {
		reclow(r178, R178);
		f178_start(1, ISGTEQ);
		funkretur = find_r178(0,10,0,(double)kundenr);
	}


	if (dondafolo>0 && funkretur>0 &&
		strlen(r178->alfa_felt) &&
		strcmp(r178->alfa_felt,ws_gl_password)!=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-306);
		web_errormess(0,ws_langstr,"306");
		pack_exchkend();
		send_linie();
		return;
	}
	if (dondafolo>0 && funkretur<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-306);
		web_errormess(0,ws_langstr,"306");
		pack_exchkend();
		send_linie();
		return;
	}
*/
	reclow(r178, R178);
	f178_start(1, ISGTEQ);
	strcpy(r178->alfa_felt, password);
	opdat_r178(45,(double)kundenr);

	reclow(r178, R178);
	(void)find_r178(0,10,0,(double)kundenr);
	if (strlen(r178->alfa_felt)) {
		strcpy(emailadr, r178->alfa_felt);
		retur = 1;
		(void)find_r178(0,45,0,(double)kundenr);
		strcpy(password, r178->alfa_felt);
		(void)send_password(2,langstr,emailadr,password,0);
	}
	alfalow(str);
	pack_init(str);
	if (dondafolo==0) {
		pack_int2((long)retur);
	}
	if (dondafolo==1 && retur<=0) {
		pack_int2((long)-306);
		web_errormess(0,ws_langstr,"306");
	}
	if (dondafolo==1 && retur>0) {
		pack_int2((long)1);
	}	
	pack_exchkend();
	send_linie();
	return;
}

/* ********************************************** */
static void opret_nyhed(funk,langstr,station)
short int funk;
char * langstr;
short int station; {
	short int funkretur = 0;
	long int opretdato = 0;
	long int lbnr = 0;
	double keynum = 0;
	char filsti[81];
	char datostr[21];

/* TEST */
	sprintf(dum_str,
		"opret_nyhed:funk=%hd,langstr=%s,station=%hd",
		funk,
		langstr,
		station);
        logfil_put(dum_str);

	reclow(r198, R198);
	f198_start(1, ISGTEQ);

	tmpfil = (FILE*)0;
	sprintf(filsti, "/tmp/nyhed7912.%hd", ege_pid);
/*	strcpy(filsti, (char*)tempnam("/tmp", "7912")); */
/* TEST */
	sprintf(dum_str,
		"opret_nyhed:filsti=%s",
		filsti);
        logfil_put(dum_str);

	tmpfil =  fopen(filsti, "w");
	if (!tmpfil) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)0);
		pack_exchkend();
		send_linie();
		return;
	}
	funkretur = get_alfafil(tmpfil);
/* TEST */
	sprintf(dum_str,
		"opret_nyhed:funkretur=%hd",
		funkretur);
        logfil_put(dum_str);

	if (tmpfil) {
		fclose(tmpfil);
		tmpfil = (FILE*)0;
	}
/*
	get_alfa(datostr);
	sprintf(dum_str,
		"opret_nyhed:datostr=%s",
		datostr);
        logfil_put(dum_str);
	opretdato = 0;
*/
	get_long(&opretdato);
/* TEST */
	sprintf(dum_str, "opret_nyhed:opretdato=%ld", opretdato);
        logfil_put(dum_str);

	keynum = (double)nyt_f198_keynum(1999);

	lbnr = 0;
	reclow(r198, R198);
	sprintf(r198->alfafelt, "!station=%hd", station);
	opdat_r198(1999,keynum,"",lbnr);
	lbnr++;

	reclow(r198, R198);
	sprintf(r198->alfafelt, "!sprog=%s", langstr);
	opdat_r198(1999,keynum,"",lbnr);
	lbnr++;

	reclow(r198, R198);
	sprintf(r198->alfafelt, "!opretdato=%ld", opretdato);
	opdat_r198(1999,keynum,"",lbnr);
	lbnr++;

	lbnr += opdat_f198_alfafelt(1,filsti,1999,keynum,"",lbnr);

	alfalow(str);
	pack_init(str);
	pack_int2((long)1);
	pack_exchkend();
	send_linie();

	(void)unlink(filsti);
	return;
}

/* ********************************************** */
static void opret_nyhedsmodtager(oplkode,langstr,station,navn,email)
long int oplkode;
char * langstr;
short int station; 
char * navn;
char * email; {
	short int funkretur = 0;
	short int retur = 0;
	short int wx1 = 0;
	short int dondafolo = 0;
	double keynum = 0;
	char tmpstr[201] = "";

	if (ws_funktion>=300 && oplkode==1998) {
		dondafolo = 1;
	}

/* TEST */
	sprintf(dum_str,
	"opret_nyhedsmodtager:oplkode=%ld,lang=%s,station=%hd,navn=%s,email=%s",
		oplkode,
		langstr,
		station,
		navn,
		email);
        logfil_put(dum_str);


/* NYT 051010 */
	funkretur = 0;
	for (wx1=0;wx1<strlen(email);wx1++) {
		if (email[wx1]==64) {
			funkretur++;
		}
	}
/* TEST */
	sprintf(dum_str,
	"opret_nyhedsmodtager:funkretur=%hd",
		funkretur);
        logfil_put(dum_str);

	if (oplkode==1998 && funkretur!=1 && dondafolo==0)  {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-1);
		pack_exchkend();
		send_linie();
		return;
	}
	if (oplkode==1998 && funkretur!=1 && dondafolo==1)  {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-318);
		web_errormess(0,ws_langstr,"318");
		pack_exchkend();
		send_linie();
		return;
	}

	if (oplkode==1997 && funkretur!=1) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-15);
		pack_exchkend();
		send_linie();
		return;
	}
/* NYT 051013 */
	keynum = (double)check_nyhedsmodtager(oplkode,station,email);
	sprintf(dum_str,
		"opret_nyhedsmodtager:check_nyhedsmodtager keynum=%.0lf",
		keynum);
        logfil_put(dum_str);
/*
	if (check_nyhedsmodtager(oplkode,station,email)>0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)0);
		pack_exchkend();
		send_linie();
		return;
	}
*/
	reclow(r198, R198);
	f198_start(1, ISGTEQ);
	if (keynum<=0) {
		keynum = (double)nyt_f198_keynum(oplkode);
	}
	reclow(r198, R198);
	sprintf(tmpstr, "%s,%s,%s",email,langstr,navn);
	tmpstr[80] = '\0';
	strcpy(r198->alfafelt, tmpstr);
	r198->numfelt = (double)station;
	opdat_r198(oplkode,(double)keynum,"",0);

	alfalow(str);
	pack_init(str);
	pack_int2((long)1);
	pack_exchkend();
	send_linie();
/* TEST */
	sprintf(dum_str,
		"opret_nyhedsmodtager:OPRET OK (%.0lf)",keynum);
        logfil_put(dum_str);
	return;
}

/* ********************************************** */
static void slet_nyhedsmodtager(oplkode,langstr,station,navn,email)
long int oplkode;
char * langstr;
short int station; 
char * navn;
char * email; {
	short int retur = 0;
	short int dondafolo = 0;
	double keynum = 0;

	if (ws_funktion>=300 && oplkode==1998) {
		dondafolo = 1;
	}

/* TEST */
	sprintf(dum_str,
	"slet_nyhedsmodtager:oplkode=%ld,lang=%s,station=%hd,navn=%s,email=%s",
		oplkode,
		langstr,
		station,
		navn,
		email);
        logfil_put(dum_str);

	keynum = (double)check_nyhedsmodtager(oplkode,station,email);
	sprintf(dum_str,
	"slet_nyhedsmodtager:keynum=%.0lf",
		keynum);
        logfil_put(dum_str);
	if (oplkode==1998 && keynum<=0 && dondafolo==0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)0);
		pack_exchkend();
		send_linie();
		return;
	}
	if (oplkode==1998 && keynum<=0 && dondafolo==1) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-318);
		web_errormess(0,ws_langstr,"318");
		pack_exchkend();
		send_linie();
		return;
	}




	if (oplkode==1997 && keynum<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-15);
		pack_exchkend();
		send_linie();
		return;
	}
	retur = -1;
	if (oplkode==1997) {
		retur = -15;
	}
	reclow(r198, R198);
	f198_start(1, ISGTEQ);
	r198->oplkode = oplkode;
	r198->keynum = keynum;
	egeread(f198, ISEQUAL+ISLOCK);
	if (f198_ok) {
		egedelete(f198);
		retur = 1;
	}
	egerel(f198);
	alfalow(str);
	pack_init(str);
	pack_int2((long)retur);
	pack_exchkend();
	send_linie();
	return;
}

/* ********************************************** */
static long int check_nyhedsmodtager(long oplkode,short station,char *email) {
	long int retur = 0;
	char chkstr[81] = "";

	sprintf(dum_str,
	"check_nyhedsmodtager:station=%hd,email=%s",
		station,
		email);
        logfil_put(dum_str);

	reclow(r198, R198);
	r198->oplkode = oplkode;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		retur = -1;
	}
	while (retur==0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=oplkode) {
			break;
		}
/*
		if (r198->numfelt!=station) {
			continue;
		}
*/
		(void)get_alfa_tgn(r198->alfafelt,0,chkstr,',');
		egechartest((unsigned char *)chkstr);
		ege_tolower((unsigned char *)chkstr);
		if (strlen(chkstr) &&
			strcmp(email,chkstr)==0) {
			retur = (long int)r198->keynum;
			break;
		}
		(void)get_alfa_tgn(r198->alfafelt,1,chkstr,',');
		egechartest((unsigned char *)chkstr);
		ege_tolower((unsigned char *)chkstr);
		if (strlen(chkstr) &&
			strcmp(email,chkstr)==0) {
			retur = (long int)r198->keynum;
			break;
		}
		(void)get_alfa_tgn(r198->alfafelt,2,chkstr,',');
		egechartest((unsigned char *)chkstr);
		ege_tolower((unsigned char *)chkstr);
		if (strlen(chkstr) &&
			strcmp(email,chkstr)==0) {
			retur = (long int)r198->keynum;
			break;
		}
	}
	return((long int)retur);
}

#ifdef egetest
/* ****************** */
static void opdater_f198() {
	long int kode = 0;
	double keynum = 0;

	reclow(r198, R198);
	kode = 15900;
	kode += (long int)r159->kontrakttype_kode;
	keynum = (double)r159->record_x;

	strcpy(r198->alfafelt,r159->bil_grp);
	if (kode==15901 || kode==15902) {
		strcpy(r198->alfafelt,r159->bil_reg_nr);
	}
/* OBS */
	if (!strlen(r198->alfafelt)) {
		return;
	}
	r198->numfelt = r159->station_ud_nr;
	r198->fradato = r159->dato_ud;
	r198->tildato = r159->dato_ind;
	r198->fratid = (short int)r159->tid_ud;
	r198->tiltid = (short int)r159->tid_ind;

	if (r159->status==2||r159->status==10) {
		r198->tildato = r159->forv_dato_ind;
		r198->tiltid = (short int)r159->forv_tid_ind;
	}
	if (r198->tildato==0) {
		r198->tildato = 99999999;
	}
	r198->status = r159->status;
	(void)opdat_r198(kode,(double)keynum,"",0);
	return;
}
#endif

/* **************************************************** */
/* type 0=leje						*/
/*      1=extraudstyr					*/
/* **************************************************** */
static int add_prislinie(type,var,idx,station,specnr,grp,antal,aftaleflag)
short int type;
long int var;
short int idx;
short int station;
short int specnr;
char * grp;
short int antal;
short int aftaleflag; {
	long int niveau = 0;
	int funkretur = 0;
	int xlsfunk = 0;
	short int ecwflag = 0;
	short int retur = 0;
	short int wx1 = 0;
	double niv_pris = 0;
	double niv_cdi = 0;
	double niv_pai = 0;
	double niv_km = 0;
	double nyextkm = 0;
/* NYT 140325 DONGASPEDAL */
	double gaspedalpris = 0;
	long int inclkm = 0;
	long int uddato = 0;
	long int nyantal = 0;
	long int xlsvarighed = 0;
	short int nyenhed = 0;
	int xlsprisflag = 0;
	int xlsmainflag = 0;
	int xlsweekkorr = 0;
	char xlsgruppe[41] = "";
	char tmpstr[81] = "";

	uddato = ws_fradato;
	if (logfil) {
		fprintf(logfil,"add_prislinie:%hd,%hd,%hd,%hd,%s,%hd\n",
			type,
			idx,
			station,
			specnr,
			grp,
			antal);
		fprintf(logfil,"\tvar=%ld\n",var);
		fprintf(logfil,"\tws_funktion=%hd\n",ws_funktion);
	}
/* NYT 141010 PSWEEKENDVARIGHEDSNYD */
	sprintf(tmpstr,"PS%5.5hd%5.5hdSTD.main",
		station,
		ws_specnr);
/* NYT 150512 ECXLSFUNK */
	if (ws_funktion>=24) {
		ecwflag = 1;
		sprintf(tmpstr,"EC%5.5hd%5.5hdSTD.main",
			station,
			ws_specnr);
	}
	xlsmainflag = xlspris_udpakmain(tmpstr);
	if (logfil) {
		fprintf(logfil,"\txlsmainflag=%d\n",xlsmainflag);
	}
	xlsprismatch->xtraantal = 0;
	xlsprismatch->lbnr = 0;
	xlsprismatch->xtraflag = 0;
	xlsprismatch->specnr = 0;
	if (type==0) {
		xlsprismatch->specnr = ws_specnr;
	}
	if (type>0) {
		xlsfunk = 1;
		xlsprismatch->specnr = specnr;
		xlsprismatch->xtraflag = 1;
	}
	sprintf(ws_prisfilid,"PS%5.5hd%5.5hdSTD",
		station,
		ws_specnr);
/* NYT 150512 ECXLSFUNK */
	if (ws_funktion>=24) {
		sprintf(ws_prisfilid,"EC%5.5hd%5.5hdSTD",
			station,
			ws_specnr);
	}
	sprintf(tmpstr,"%s.spec",ws_prisfilid);
	if (type>0) {
		sprintf(tmpstr,"%s.xtra",ws_prisfilid);
	}
	xlsvarighed = var;
/* NYT 140430 */
	if (type>0 && specnr==969) {
		xlsfunk = 2;
		sprintf(tmpstr,"%s.kmpk",ws_prisfilid);
	}
/* NYT 140904 KMPKSPECNR */
	if (type>0 && xlsmainflag>0 && specnr==xlsprismain->kmpkspecnr) {
		xlsfunk = 2;
		sprintf(tmpstr,"%s.kmpk",ws_prisfilid);
	}
/* NYT 141010 PSWEEKENDVARIGHEDSNYD */
/*
	if (type==0 && specnr==801) {
		xlsvarighed = 3;
	}
*/
	if (type==0 && xlsmainflag>0 &&
		xlsvarighed<xlsprismain->varighed_ival[0]) {
		xlsvarighed = xlsprismain->varighed_ival[0];
		xlsweekkorr = 1;
	}

	if (xlsfunk==2) {
		xlsprismatch->specnr = ws_specnr;
		strcpy(xlsprismatch->pakketxt,grp);
                xlsprisflag = xlspris_udpakkmpk(tmpstr,ws_grp,station);
		strcpy(xlsprismatch->pakketxt,"");
	}
/* NYT 140507 BARNESTOLANTALPS */
	if (ws_brandtype==4 && xlsfunk==1 && xlsprismatch->specnr==905) {
		xlsvarighed = 0;
		nyantal = 1;
	}
	if (ws_brandtype==4 && xlsfunk==1 && xlsprismatch->specnr==906) {
		xlsvarighed = 0;
		nyantal = 1;
	}
	if (ws_brandtype==4 && xlsfunk==1 && xlsprismatch->specnr==907) {
		xlsvarighed = 0;
		nyantal = 1;
	}
	if (ws_brandtype==4 && xlsfunk==1 && xlsprismatch->specnr==908) {
		xlsvarighed = 0;
		nyantal = 1;
	}
/* NYT 141114 PSFLYTTEKASSE */
	if (ws_brandtype==4 && xlsfunk==1 && xlsprismatch->specnr==980) {
		xlsvarighed = 0;
		nyantal = 1;
	}

	if (xlsfunk<=1) {
		xlsprisflag = xlspris_udpaksub(tmpstr,grp,xlsvarighed);
	}
	if (logfil) {
		fprintf(logfil,
		"\txlsprisflag=%d (%s) grp=%s xlsvarighed=%ld nyantal=%ld\n",
			xlsprisflag,tmpstr,grp,xlsvarighed,nyantal);
	}
	if (xlsprisflag>0) {
		(void)xlspris_sub_r165((long int)specnr,
			(long int)station,
			grp,
			var);
		retur = 1;
		goto addpl10;
	}

	reclow(r165, R165);
	r165->spec_nr = specnr;
	f165_start(1, ISGTEQ);
	if (f165_ukendt) {
		return(-1);
	}
	while (retur==0) {
		egeread(f165, ISNEXT);
		if (f165_eof) {
			break;
		}
		if (r165->spec_nr != specnr) {
			break;
		}
		if (r165->slet_mark>0) {
			continue;
		}
		if (r165->stat_nr!=0 && r165->stat_nr != station) {
			continue;
		}
/* NYT 130305 */
		if (specnr==980 && station>0 && r165->stat_nr!=station) {
			continue;
		}
		if (strcmp(r165->bil_grp,grp)!=0) {
			continue;
		}
		retur = 1;
	}
/* NYT 141114 TEST */
	if (logfil) {
		fprintf(logfil,"\tF165 %hd-%hd-%s retur=%hd\n",
			r165->spec_nr,
			r165->stat_nr,
			r165->bil_grp,
			retur);
	}
	if (retur<=0) {
		return(retur);
	}
/* NYT 040427 */
	niv_pris = (double)r165->pris;
	niv_cdi = (double)r165->rate_cdw;
	niv_pai = (double)r165->rate_pai;
	niv_km = (double)r165->ekstra_pr_km;
	inclkm = (long int)r165->incl_km;

	niveau = find_f198_niveau(station,ws_systemdato,ws_systemtid);
	if (niveau!=0) {
		niv_pris = (double)r165->pris;
		niv_cdi = (double)r165->rate_cdw;
		niv_pai = (double)r165->rate_pai;
		niv_km = (double)r165->ekstra_pr_km;
		(void)find_f198_nivpriser(niveau,
			station,
			specnr,
			&niv_pris,
			&niv_cdi,
			&niv_pai,
			&niv_km);
		r165->pris = (double)niv_pris;
		r165->rate_cdw = (float)niv_cdi;
		r165->rate_pai = (float)niv_pai;
		r165->ekstra_pr_km = (double)niv_km;
	}
/* TEST */
addpl10:
	if (logfil) {
		fprintf(logfil, "add_prislinie:niveau=%ld\n",
			niveau);
		fprintf(logfil,
"add_prislinie:r165 pris=%.2lf cdi=%.2f pai=%.2f ex.pr.km=%.2lf ikm=%ld\n",
		r165->pris,
		r165->rate_cdw,
		r165->rate_pai,
		r165->ekstra_pr_km,
		r165->incl_km);
		fprintf(logfil,"\tincl_flag-1=%hd\n",r165->incl_flag[1]);
		fprintf(logfil,"\tincl_flag-3=%hd\n",r165->incl_flag[3]);
		fprintf(logfil,"\ttekst_1=<%s>\n",r165->tekst_1);
	}

	wx1 = 0;
	if (aftaleflag>0) {
		wx1 = find_f198_firmaaftale(station,
			specnr,
			grp,
			&niv_pris,
			&niv_cdi,
			&niv_pai,
			&niv_km,
			&inclkm);
	}
	if (aftaleflag>0 && wx1>0) {
		r165->pris = (double)niv_pris;
		r165->rate_cdw = (float)niv_cdi;
		r165->rate_pai = (float)niv_pai;
		r165->ekstra_pr_km = (double)niv_km;
		r165->incl_km = inclkm;
	}
/* TEST */
	sprintf(dum_str, "add_prislinie:aftaleflag=%hd wx1=%hd",
		aftaleflag,wx1);
	logfil_put(dum_str);
	sprintf(dum_str,
"add_prislinie:r165 pris=%.2lf cdi=%.2f pai=%.2f ex.pr.km=%.2lf ikm=%ld",
		r165->pris,
		r165->rate_cdw,
		r165->rate_pai,
		r165->ekstra_pr_km,
		r165->incl_km);
	logfil_put(dum_str);
/* NYT 090325 UDLDKBOOK */
	wx1 = 0;
	if (ws_udldkflag>0 && (specnr==910 || specnr==924)) {
/* RETTET 110107 VINTERUDL
	if (ws_udldkflag>0 && specnr==924) {
*/
		wx1 = find_f198prisjust(specnr,
			grp,
			(short int)0,
			uddato,
			(int)var,
			&niv_pris,
			&nyenhed,
			&nyantal,
			&niv_cdi,
			&niv_pai,
			&nyextkm,
			&inclkm);
	}
	if (ws_udldkflag>0 && wx1>0) {
		r165->pris = (double)niv_pris;
		r165->enhed = nyenhed;
/*
		r165->rate_cdw = (float)niv_cdi;
		r165->rate_pai = (float)niv_pai;
		r165->ekstra_pr_km = (double)niv_km;
		r165->incl_km = inclkm;
*/
	}
/* NYT 140325 DONGASPEDAL */
	gaspedalpris = 0;
	if (type==0 && ws_brandtype==3) {
		funkretur = styr_gaspedal(1,
			station,
			specnr,
			grp,
			uddato,
			ws_systemdato,
			var,
			&gaspedalpris);
	}
	if (logfil) {
		fprintf(logfil,"\tSTYR_GASPEDAL gaspedalpris=%lf\n",
			gaspedalpris);
	}
	if (type==0 && ws_brandtype==3 && funkretur>0) {
		r165->pris += gaspedalpris;
	}
/* TEST */
	sprintf(dum_str, "add_prislinie:f198prisjust wx1=%hd", wx1);
	logfil_put(dum_str);
	sprintf(dum_str,
"add_prislinie:r165 pris=%.2lf cdi=%.2f pai=%.2f ex.pr.km=%.2lf ikm=%ld",
		r165->pris,
		r165->rate_cdw,
		r165->rate_pai,
		r165->ekstra_pr_km,
		r165->incl_km);
	logfil_put(dum_str);

	r159->rate_spec_nr[idx] = r165->spec_nr;
	r159->rate_station[idx] = r165->stat_nr;
	strcpy(r159->rate_gruppe[idx], r165->bil_grp);

	strcpy(r159->rate_tekst[idx], r165->tekst_1);
	r159->rate_pris[idx] = r165->pris;
	r159->rate_incl_km[idx] = r165->incl_km;
	r159->rate_ekstra_km[idx] = r165->ekstra_pr_km;
	r159->rate_enhed[idx] = r165->enhed;
	r159->rate_type[idx] = r165->type;
	r159->rate_cdw[idx] = r165->rate_cdw;
	r159->rate_pai[idx] = r165->rate_pai;
	strcpy(tmpstr, "0000000000");
	tmpstr[10] = '\0';
	for (wx1=0;wx1<=4;wx1++) {
		if (r165->incl_flag[wx1] > 0) {
			tmpstr[wx1] = 48+r165->incl_flag[wx1];
		} else {
			tmpstr[wx1] = '0';
		}
	}
	if (r165->incl_flag[7] > 0) {
		tmpstr[5] = 48+r165->incl_flag[7];
	} else {
		tmpstr[5] = '0';
	}
	if (r165->incl_flag[9] > 0) {
		tmpstr[6] = 48+r165->incl_flag[9];
	} else {
		tmpstr[6] = '0';
	}
	strcpy(r159->rate_incl_felt[idx], tmpstr);
/* NYT 150623 WEBAPI31 */
	if (ecwflag>0 && xlsprisflag>0) {
		(void)xlspris_r165_r159(1,idx);
	}
	if (logfil) {
		fprintf(logfil,"\tr159 rate_incl_felt-%hd=<%s>\n",
			idx,
			r159->rate_incl_felt[idx]);
	}
	if (idx==0) {
		r159->rate_ekstra_km[10] = r159->rate_ekstra_km[0];
		r159->rate_pris[10]     = r159->rate_ekstra_km[0];
		strcpy(r159->rate_incl_felt[10], r159->rate_incl_felt[0]);
		udregn_ratejustering(1,idx);
/* RATEJUSTERING udregn_rate_antal(idx); */
	}
	r159->rate_antal[idx] = (long int)antal;
	if (type==1 && r159->rate_enhed[idx]==201) {
		r159->rate_antal[idx] *= var;
	}
/* NYT 090325 */
	if (ws_udldkflag>0 && type==1 && nyantal>0) {
		r159->rate_antal[idx] = nyantal;
	}
/* UDLDKBOOK SNYD 090325 */
	if (ws_udldkflag>0 && specnr==990 && station!=6) {
		r159->rate_pris[idx] = (double)200;
	}
/* UDLDKBOOK SNYD 100611 */
	if (ws_udldkflag>0 && specnr==990 && station==33) {
		r159->rate_pris[idx] = (double)316;
	}
/* UDLDKBOOK SNYD 090811 */
	if (ws_udldkflag>0 && specnr==990 && station==6) {
		r159->rate_pris[idx] = (double)316;
	}
	if (ws_udldkflag>0 && specnr==ONEWAYSPCNR && var>1) {
		r159->rate_pris[idx] = (double)0;
	}
	if (ws_udldkflag>0 && specnr==905) {
		r159->rate_pris[idx] = (double)125;
	}
	if (ws_udldkflag>0 && specnr==905 && strlen(ws_udldkspectxt)) {
		strcpy(r159->rate_tekst[idx],ws_udldkspectxt);
	}
	if (ws_udldkflag>0 && specnr==996 && r159->rate_antal[idx]>=1) {
		r159->rate_antal[idx] = 1;
	}
/* 090605 FORDELE */
	if (ws_udldkflag>0 && specnr==996) {
		r159->rate_pris[idx] = 0;
	}
/* 100108 FORDELE CODRIVER */
	if (ws_udldkflag>0 && specnr==996 && r159->rate_antal[idx]>=1) {
		strcpy(ws_udldkmedlfor,"UDLDKFORNAVN");
		strcpy(ws_udldkmedleft,"UDLDKEFTNAVN");
	}

	if (ws_udldkflag>0 && specnr==905) {
		r159->rate_pris[idx] = 0;
	}
/* NYT 110107 VINTERUDL */
	if (ws_udldkflag>0 && specnr==910 && var==1) {
		strcpy(r159->rate_tekst[idx], "Vinterdæk 1 dag");
	}
	if (ws_udldkflag>0 && specnr==910 && var>1) {
		sprintf(r159->rate_tekst[idx], "Vinterdæk %ld dage",var);
	}

/* NYT 050113 DON BARNESTOL */
	if (type==1 &&
		r159->rate_spec_nr[idx]==932 &&
		r159->rate_enhed[idx]==0) {
		r159->rate_antal[idx] *= var;
	}
	if (type==1 &&
		r159->rate_spec_nr[idx]==933 &&
		r159->rate_enhed[idx]==0) {
		r159->rate_antal[idx] *= var;
	}
	if (type==1 &&
		r159->rate_spec_nr[idx]==934 &&
		r159->rate_enhed[idx]==0) {
		r159->rate_antal[idx] *= var;
	}
/* NYT 131204 PSEXTRA */
	if (type==1 &&
		r159->rate_spec_nr[idx]==905 &&
		r159->rate_enhed[idx]==0) {
		r159->rate_antal[idx] *= var;
	}
	if (type==1 &&
		r159->rate_spec_nr[idx]==906 &&
		r159->rate_enhed[idx]==0) {
		r159->rate_antal[idx] *= var;
	}
	if (type==1 &&
		r159->rate_spec_nr[idx]==907 &&
		r159->rate_enhed[idx]==0) {
		r159->rate_antal[idx] *= var;
	}

/* NYT 130112 DON2VINTERANH */
	if (logfil) {
		fprintf(logfil,"\tDON2 %hd idx=%hd type=%hd specnr=%hd\n",
			ws_don2flag,
			idx,
			type,
			specnr);
		fprintf(logfil,"\tDON2 rate _spec_nr=%hd\n",
			r159->rate_spec_nr[idx]);
		fprintf(logfil,"\tDON2 rate _enhed=%hd\n",
			r159->rate_enhed[idx]);
	}


/* NYT 131292 GPS */
	if (ws_don2flag>0 && type==1 && specnr==924 && var==1) {
		strcpy(r159->rate_tekst[idx], "GPS 1 dg");
	}
	if (ws_don2flag>0 && type==1 && specnr==924 && var>1) {
		sprintf(r159->rate_tekst[idx], "GPS %ld dg",var);
	}
	if (ws_don2flag>0 && type==1 && specnr==924) {
		wx1 = find_f198prisjust(specnr,
			"GPS",
			(short int)ws_station,
			uddato,
			(int)var,
			&niv_pris,
			&nyenhed,
			&nyantal,
			&niv_cdi,
			&niv_pai,
			&nyextkm,
			&inclkm);
	}
	if (logfil) {
		fprintf(logfil,"\tDON2GPS wx1=%hd niv_pris=%lf\n",
			wx1,
			niv_pris);
		fprintf(logfil,"\tDON2GPS nyenhed=%hd\n",
			nyenhed);
		fprintf(logfil,"\tDON2GPS nyantal=%ld\n",
			nyantal);

		fprintf(logfil,"\tDON2GPS type=%hd\n",
			type);
	}
/* NYT 131209 GPSWEEKEND */
	if (ws_don2flag>0 && type==1 && specnr==924 && wx1>0 &&
		ws_specnr==196 && nyantal==3) {
		niv_pris = 30;
	}
	if (ws_don2flag>0 && type==1 && specnr==924 && wx1>0) {
		r159->rate_antal[idx] = (long int)nyantal;
		r159->rate_pris[idx] = (double)niv_pris;
		r159->rate_enhed[idx] = (short int)nyenhed;
		r159->rate_station[idx] = (short int)ws_station;
/*
		r159->rate_ialt[idx] = r159->rate_pris[idx];
		r159->rate_ialt[idx] *= (double)r159->rate_antal[idx];
*/
	}
	if (ws_don2flag>0 && type==1 && specnr==910 && var==1) {
		strcpy(r159->rate_tekst[idx], "Vinterdæk 1 dg");
	}
	if (ws_don2flag>0 && type==1 && specnr==910 && var>1) {
		sprintf(r159->rate_tekst[idx], "Vinterdæk %ld dg",var);
	}
/* RETTET 140312 VINTERDÆKPRISFEJL
	if (ws_don2flag>0 && type==1 &&
		r159->rate_spec_nr[idx]==910 &&
		(r159->rate_enhed[idx]==0||r159->rate_enhed[idx]==201) &&
		var>1 && var<7) {
		r159->rate_antal[idx] *= var;
	}
*/
	if (ws_don2flag>0 && type==1 &&
		r159->rate_spec_nr[idx]==910 &&
		r159->rate_enhed[idx]==0 &&
		var>1 && var<7) {
		r159->rate_antal[idx] *= var;
	}
	if (ws_don2flag>0 && type==1 &&
		r159->rate_spec_nr[idx]==910 &&
		r159->rate_enhed[idx]==201 &&
		var>1 && var<7) {
		r159->rate_antal[idx] = var;
	}

	if (ws_don2flag>0 && type==1 &&
		r159->rate_spec_nr[idx]==910 &&
		(r159->rate_enhed[idx]==0||r159->rate_enhed[idx]==201) &&
		var>=7 && var<=23) {
		r165->spec_nr = (short int)911;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
		egeread(f165, ISEQUAL);
		if (f165_ok) {
			r165->pris /= 7;
		}
		r159->rate_antal[idx] = var;
		r159->rate_pris[idx] = (double)r165->pris;
	}
	if (ws_don2flag>0 && type==1 &&
		r159->rate_spec_nr[idx]==910 &&
		(r159->rate_enhed[idx]==0||r159->rate_enhed[idx]==201) &&
		var>23) {
		r165->spec_nr = (short int)912;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
		egeread(f165, ISEQUAL);
		if (f165_ok) {
			r165->pris /= 30;
		}
		r159->rate_antal[idx] = var;
		r159->rate_pris[idx] = (double)r165->pris;
	}
	if (ws_don2flag>0 && type==1 && specnr==901 && var==1) {
		strcpy(r159->rate_tekst[idx], "Anh.træk 1 dg");
	}
	if (ws_don2flag>0 && type==1 && specnr==901 && var>1) {
		sprintf(r159->rate_tekst[idx], "Anh.træk %ld dg",var);
	}
/* RETTET 140312 VINTERDÆKPRISFEJL ANHÆNGERTRÆK
	if (ws_don2flag>0 && type==1 &&
		r159->rate_spec_nr[idx]==901 &&
		(r159->rate_enhed[idx]==0||r159->rate_enhed[idx]==201) &&
		var>1 && var<7) {
		r159->rate_antal[idx] *= var;
	}
*/
	if (ws_don2flag>0 && type==1 &&
		r159->rate_spec_nr[idx]==901 &&
		r159->rate_enhed[idx]==0 &&
		var>1 && var<7) {
		r159->rate_antal[idx] *= var;
	}
	if (ws_don2flag>0 && type==1 &&
		r159->rate_spec_nr[idx]==901 &&
		r159->rate_enhed[idx]==201 &&
		var>=1 && var<3) {
		r159->rate_antal[idx] = var;
	}
/* NYT 140313 */
	if (ws_don2flag>0 && type==1 &&
		r159->rate_spec_nr[idx]==901 &&
		r159->rate_enhed[idx]==201 &&
		var>=3 && var<=7) {
		r165->spec_nr = (short int)903;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
		egeread(f165, ISEQUAL);
		if (f165_ok) {
/*
			r165->pris /= 7;
*/
		}
		r159->rate_antal[idx] = 1;
		r159->rate_pris[idx] = (double)r165->pris;
	}
	if (ws_don2flag>0 && type==1 &&
		r159->rate_spec_nr[idx]==901 &&
		r159->rate_enhed[idx]==201 &&
		var>7 && var<=18) {
		r165->spec_nr = (short int)903;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
		egeread(f165, ISEQUAL);
		if (f165_ok) {
			r165->pris /= 7;
		}
		r159->rate_antal[idx] = var;
		r159->rate_pris[idx] = (double)r165->pris;
	}
/*
	if (ws_don2flag>0 && type==1 &&
		r159->rate_spec_nr[idx]==901 &&
		(r159->rate_enhed[idx]==0||r159->rate_enhed[idx]==201) &&
		var>=7 && var<=23) {
		r165->spec_nr = (short int)903;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
		egeread(f165, ISEQUAL);
		if (f165_ok) {
			r165->pris /= 7;
		}
		r159->rate_antal[idx] = var;
		r159->rate_pris[idx] = (double)r165->pris;
	}
*/
	if (ws_don2flag>0 && type==1 &&
		r159->rate_spec_nr[idx]==901 &&
		r159->rate_enhed[idx]==201 &&
		var>18) {
		r165->spec_nr = (short int)904;
		r165->stat_nr = ws_station;
		strcpy(r165->bil_grp,"ALLE");
		egeread(f165, ISEQUAL);
		if (f165_ok) {
/*
			r165->pris /= 30;
*/
		}
		r159->rate_antal[idx] = 1;
		r159->rate_pris[idx] = (double)r165->pris;
	}
/* NYT 150703 ECXLS */
	if (ws_ecwebapiflag>0 && type==0 &&
		ws_brandtype==0 &&
		xlsprisflag>0) {
		r159->rate_antal[idx] = var;
	}

/* NYT 131211 PSSNYDPRIS */
	if (ws_don2flag>0 && type==0 &&
		ws_brandtype==4 &&
		r159->rate_spec_nr[idx]==810) {
		r159->rate_antal[idx] = var;
	}
/* NYT 140218 XLSPRIS */
	if (ws_don2flag>0 && type==0 &&
		ws_brandtype==4 &&
		xlsprisflag>0) {
		r159->rate_antal[idx] = var;
	}
/* NYT 140423 XLSPRODMATCH */
	if (ws_don2flag>0 && type==0 &&
		ws_brandtype==4 &&
		xlsprisflag>0 &&
		r159->rate_enhed[idx]%200==var) {
		r159->rate_antal[idx] = 1;
	}
/* NYT 141010 WEEKENDSNYD */
	if (ws_don2flag>0 && type==0 &&
		ws_brandtype==4 &&
		xlsprisflag>0 &&
		xlsweekkorr>0) {
		r159->rate_antal[idx] = 1;
	}




/* NYT 140507 BARNESTOLANTALPS */
	if (ws_don2flag>0 && type==1 &&
		ws_brandtype==4 &&
		xlsprisflag>0 &&
		r159->rate_enhed[idx]==0) {
		r159->rate_antal[idx] = antal;
	}

	udregn_incl();
	udregn_ekstra();
	opsaet_forsikring(idx);
	if (logfil) {
		fprintf(logfil,"\n");
		fprintf(logfil,"\tDON2 rate _antal=%ld\n",
			r159->rate_antal[idx]);
		fprintf(logfil,"\tDON2 rate _pris=%.2lf\n",
			r159->rate_pris[idx]);
		fprintf(logfil,"\tDON2 rate _ialt=%.2lf\n",
			r159->rate_ialt[idx]);
	}
	return(retur);
}

/* NYT 140325 DONGASPEDAL */
/* ******************************************* */
static int styr_gaspedal(int inpfunk,short inpst,short inpspc,char *inpgrp,long inpuddt,long inpresdt,long inpvar,double * returpris) {
	int retur = 0;
	int fundet = 0;
	short int uddagnr = 0;
	short int ugedagnr = 0;
	long int varighed = 0;
	long int returdato = 0;
	long int chkudfra = 0;
	long int chkudtil = 0;
	char chkkeyalfa[21] = "";
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil,"styr_gaspedal %d %hd %hd %s %ld %ld %ld\n",
			inpfunk,
			inpst,
			inpspc,
			inpgrp,
			inpuddt,
			inpresdt,
			inpvar);
	}
	returdato = m036_funktion(11, inpuddt);
	uddagnr = (short int)(returdato%10);
	if (logfil) {
		fprintf(logfil,"\tuddagnr=%hd\n",uddagnr);
	}
	reclow(r198, R198);
	sprintf(chkkeyalfa,"%3.3hd%3.3hd%s",inpst,inpspc,inpgrp);
	strcpy(r198->keyalfa,chkkeyalfa);
	r198->keynum = 0;
	r198->oplkode = 15608;
	f198_start(1,ISGTEQ);
        while (fundet==0) {
		egeread(f198,ISNEXT);
		if (f198_eof) { break; }
		if (r198->oplkode!=15608) { break; }
		if (strcmp(chkkeyalfa,r198->keyalfa)!=0) { break; }
/* check onoff */
		if (r198->numfelt<=0) { continue; }
/* check res.dato */
                if (inpresdt<r198->fradato) { continue; }
                if (inpresdt>r198->tildato) { continue; }
/* check udl.dato pak felt1 og 2 ud fra alfafelt */
		chkudfra = -1;
		chkudtil = -1;
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&chkudfra);
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&chkudtil);
		}
		if (chkudfra<0) { continue; }
		if (chkudtil<0) { continue; }
/* check ugedagnr */
		ugedagnr = 0;
		(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%d",&ugedagnr);
		}
		if (ugedagnr!=uddagnr) { continue; }
/* check varighed */
		varighed = 0;
		(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&varighed);
		}
		if (varighed!=inpvar) { continue; }
/* udpak pris */
		(void)get_alfa_tgn(r198->alfafelt,4,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%lf",&ege_w_dou1);
		}
		*returpris = ege_w_dou1;
		fundet = 1;
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil,"styr_gaspedal retur=%d\n",retur);
	}
	return(retur);
}

/* ****************************** */
static long int find_f198_niveau(st,dato,tid)
short int st;
long int dato;
long int tid; {
	long int retur = 0;
	long int niveau = 0;
	long int datofra = 0;
	long int datotil = 0;
	long int tidfra = 0;
	long int tidtil = 0;
	char tmpstr[81] = "";

	reclow(r198, R198);
	r198->oplkode = 16609;
	r198->keynum = (double)st;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		return((long int)0);
	}
	while (retur==0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=16609) {
			break;
		}
		if (r198->keynum!=st) {
			break;
		}
		niveau = 0;
		datofra = 0;
		datotil = 0;
		tidfra = 0;
		tidtil = 0;
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &niveau);
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &datofra);
		}
		(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &tidfra);
		}
		(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &datotil);
		}
		(void)get_alfa_tgn(r198->alfafelt,4,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &tidtil);
		}
		if (dato>datotil) {
			continue;
		}
		if (dato<datofra) {
			continue;
		}
		if (tid>tidtil) {
			continue;
		}
		if (tid<tidfra) {
			continue;
		}
		retur = niveau;
	}
	return((long int)retur);
}

/* ********************************************** */
static int find_f198_nivpriser(long niveau,short st,short spec,double * pris,double * cdi,double * pai,double * km) {
	short int retur = 0;
	long int spcst;
	long int inpniveau;
	double inpdoub;
	char tmpstr[81] = "";

	spcst = (long int)spec;
	spcst *= 1000;
	spcst += (long int)st;
	reclow(r198, R198);
	r198->oplkode = 16520;
	r198->keynum = (double)spcst;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		return(0);
	}
	while (retur==0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=16520) {
			break;
		}
		if (r198->keynum!=spcst) {
			break;
		}
		inpniveau = 0;
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &inpniveau);
		}
		if (niveau!=inpniveau) {
			continue;
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%lf", &inpdoub);
			*pris = inpdoub;
		}
		(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%lf", &inpdoub);
			*cdi = inpdoub;
		}
		(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%lf", &inpdoub);
			*pai = inpdoub;
		}
		(void)get_alfa_tgn(r198->alfafelt,4,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%lf", &inpdoub);
			*km = inpdoub;
		}
		retur = 1;
	}
	return(retur);
}

/* ****************************** */
static int find_f198_firmaaftale(short st,short spec,char * grp,double * pris,double * cdi,double * pai,double * km,long int * inclkm) {
	short int retur = 0;
	long int spcst = 0;
	double inpdoub;
	long int inpnum;
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil, "find_f198_firmaaftale:st=%hd\n",
			st);
	}
	reclow(r198, R198);
	r198->oplkode = 16521;
	spcst = (long int)spec;
	spcst *= 1000;
	spcst += (long int)st;
	r198->keynum = (double)spcst;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		return(0);
	}
	while (retur==0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=16521) {
			break;
		}
		if (r198->keynum!=spcst) {
			break;
		}
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		if (strlen(tmpstr) && strcmp(tmpstr,grp)!=0) {
			continue;
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		inpdoub  = 0;
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%lf", &inpdoub);
			*pris = inpdoub;
		}
		(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
		inpdoub  = 0;
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%lf", &inpdoub);
			*cdi = inpdoub;
		}
		(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
		inpdoub  = 0;
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%lf", &inpdoub);
			*pai = inpdoub;
		}
		(void)get_alfa_tgn(r198->alfafelt,4,tmpstr,';');
		inpdoub  = 0;
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%lf", &inpdoub);
			*km = inpdoub;
		}
		(void)get_alfa_tgn(r198->alfafelt,5,tmpstr,';');
		inpnum  = 0;
		if (strlen(tmpstr)) {
			sscanf(tmpstr, "%ld", &inpnum);
			*inclkm = inpnum;
		}
		retur = 1;
	}
	return(retur);
}

/* ********************************************** */
static int check_udvstslip(short stnr,long uddato,long udtid) {
	short int retur = 0;
	short int uddgnr = 0;
	short int dgnr = 0;
	long int returdato = 0;
	long int frakl = 0;
	long int tilkl = 0;
	long int antalmin = 0;
	long int julian;
	long int minudslip;
	long int minuddato;
	long int minudtid;
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil,"check_udvstslip:stnr=%hd,udd=%ld,udt=%ld\n",
			stnr,
			uddato,
			udtid);
	}
	returdato = m036_funktion(11, (long int)uddato);
	uddgnr = (short int)(returdato % 10);
	if (logfil) {
		fprintf(logfil,"check_udvstslip:uddgnr=%hd\n",
			uddgnr);
	}
	reclow(r198,R198);
	r198->oplkode = 16634;
	r198->keynum = stnr;
	f198_start(1, ISGTEQ);
	if (f198_ukendt) {
		return(0);
	}
	while (retur==0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=16634) {
			break;
		}
		if (r198->keynum!=stnr) {
			break;
		}
		if (r198->numfelt<=0) {
			continue;
		}
		dgnr = 0;
		frakl = 0;
		tilkl = 0;
		(void)get_alfa_tgn(r198->alfafelt,0,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%hd",&dgnr);
		}
		if (uddgnr!=dgnr) {
			continue;
		}
		(void)get_alfa_tgn(r198->alfafelt,1,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&frakl);
		}
		if (udtid<frakl) {
			continue;
		}
		(void)get_alfa_tgn(r198->alfafelt,2,tmpstr,';');
		if (strlen(tmpstr)) {
			sscanf(tmpstr,"%ld",&tilkl);
		}
		if (udtid>tilkl) {
			continue;
		}
		minudslip = 0;
		antalmin = 0;
		(void)get_alfa_tgn(r198->alfafelt,3,tmpstr,';');
		if (logfil) {
			fprintf(logfil,"check_udvstslip:tmpstr=%s\n",
				tmpstr);
		}
		if (strlen(tmpstr) && strcmp(tmpstr,"MAN800")==0) {
			antalmin = -1;
		}
		if (strlen(tmpstr) && strcmp(tmpstr,"TIR800")==0) {
			antalmin = -2;
		}
		if (strlen(tmpstr) && strcmp(tmpstr,"ONS800")==0) {
			antalmin = -3;
		}
		if (strlen(tmpstr) && strcmp(tmpstr,"TOR800")==0) {
			antalmin = -4;
		}
		if (strlen(tmpstr) && strcmp(tmpstr,"FRE800")==0) {
			antalmin = -5;
		}
		if (strlen(tmpstr) && strcmp(tmpstr,"LOR800")==0) {
			antalmin = -6;
		}
		if (strlen(tmpstr) && strcmp(tmpstr,"SON800")==0) {
			antalmin = -7;
		}
		if (strlen(tmpstr) && antalmin>=0) {
			sscanf(tmpstr,"%ld",&antalmin);
		}
		if (logfil) {
			fprintf(logfil,"check_udvstslip:antalmin=%ld\n",
				antalmin);
		}
		if (antalmin>=0) {
			minudslip = antalmin;
		}
		if (antalmin==-1) {
			minudslip=retur_slipmin(uddato,udtid,(long)1,(long)800);
		}
		if (antalmin==-2) {
			minudslip=retur_slipmin(uddato,udtid,(long)2,(long)800);
		}
		if (antalmin==-3) {
			minudslip=retur_slipmin(uddato,udtid,(long)3,(long)800);
		}
		if (antalmin==-4) {
			minudslip=retur_slipmin(uddato,udtid,(long)4,(long)800);
		}
		if (antalmin==-5) {
			minudslip=retur_slipmin(uddato,udtid,(long)5,(long)800);
		}
		if (antalmin==-6) {
			minudslip=retur_slipmin(uddato,udtid,(long)6,(long)800);
		}
		if (antalmin==-7) {
			minudslip=retur_slipmin(uddato,udtid,(long)7,(long)800);
		}
		if (logfil) {
			fprintf(logfil,"check_udvstslip:minudslip=%ld\n",
				minudslip);
		}
		if (minudslip>0) {
			julian = m036_funktion(12, ws_systemdato);
			ege_w_int1 = ws_systemtid/100;
			ege_w_int1 += (minudslip/60);

			ege_w_int2 = ws_systemtid%100;
			ege_w_int2 += (minudslip%60);
			if (ege_w_int2>=60) {
				ege_w_int1++;
				ege_w_int2 -= 60;
			}
/* TEST */
			sprintf(dum_str,
			"check_udvstslip:MINUDSLIP-1 julian=%ld timer=%ld min=%ld",
				julian,
				ege_w_int1,
				ege_w_int2);
       		 	logfil_put(dum_str);
			julian += (ege_w_int1/24);
			minuddato = m036_funktion(19, julian);
			minudtid = ege_w_int1%24;
			minudtid *= 100;
			minudtid += ege_w_int2;
/* TEST	 */
			sprintf(dum_str,
			"check_udvstslip:MINUDSLIP-2 minuddato=%ld minudtid=%ld",
				minuddato,
				minudtid);
       		 	logfil_put(dum_str);
		}
		if (minudslip>0 &&
			uddato<minuddato) {
			retur = 1;
		}
		if (minudslip>0 &&
			uddato==minuddato && udtid<minudtid) {
			retur = 1;
		}
		if (retur==1 && antalmin<0) {
			retur += (antalmin * -1);
		}
	}
	if (logfil) {
		fprintf(logfil,"check_udvstslip:retur=%hd\n",
			retur);
	}
	return(retur);
}

/* *********************** */
static int retur_slipmin(long frad,long frat,long tildgnr,long tilt) {
	short int retur = 0;
	long int antmin = 0;
	long int tmpnum = 0;
	long int tmpnum2 = 0;
	long int tmpdato = 0;
	short int wx1 = 0;
	short int nuvdgnr = 0;
	short int fradgnr = 0;

	tmpdato = m036_funktion(11, (long int)frad);
	fradgnr = (short int)(tmpdato % 10);
	nuvdgnr = fradgnr;
	while (wx1<7) {
		if (fradgnr!=tildgnr && nuvdgnr==fradgnr) {
			tmpnum = 1440;
			tmpnum2 = (frat/100);
			tmpnum2 *= 60;
			tmpnum2 += (frat%100);
			antmin += (tmpnum - tmpnum2);
		}
		if (fradgnr!=tildgnr && nuvdgnr==tildgnr) {
			tmpnum = (tilt/100);
			tmpnum *= 60;
			tmpnum += (tilt%100);
			antmin += tmpnum;
		}
		if (nuvdgnr!=fradgnr && nuvdgnr!=tildgnr) {
			antmin += 1440;
		}
		if (fradgnr==tildgnr) {
			tmpnum = (tilt/100);
			tmpnum *= 60;
			tmpnum += (tilt%100);
			tmpnum2 = (frat/100);
			tmpnum2 *= 60;
			tmpnum2 += (frat%100);
			antmin += (tmpnum - tmpnum2);
		}
		if (nuvdgnr==tildgnr) {
			break;
		}
		wx1++;
		nuvdgnr++;
		if (nuvdgnr>7) {
			nuvdgnr = 1;
		}
	}
	if (logfil) {
		fprintf(logfil,"retur_slipmin:antmin=%ld\n",
			antmin);
	}
	return((long)antmin);
}

/* ********************** */
static int retur_minantal(long inptid) {
	int retur = 0;

	retur = (int)(inptid / 100) * 60;
	retur += (int)(inptid % 100);
	return(retur);
}

/* ********************** */
static void slet_reservation(resnr)
long int resnr; {
	long int dato;
	short int retur = 0;

	dato = ege_date();
	reclow(r198, R198);
	f198_start(1, ISGTEQ);
	r198->oplkode = 15903;
	r198->keynum = resnr;
	egeread(f198, ISEQUAL + ISLOCK);
	if (f198_ok) {
		egedelete(f198);
		egerel(f198);
		retur++;
	}
	reclow(r159, R159);
	f159_start(1, ISGTEQ);
	r159->record_x = resnr;
	egeread(f159, ISEQUAL + ISLOCK);
	if (f159_ok) {
		r159->status = 5;
		sprintf(r159->bem[0],
			"%2.2ld-%2.2ld-%4.4ld web annulleret",
			dato % 100,
			(dato % 10000) / 100,
			(dato / 10000));
		egerew(f159);
		egerel(f159);
		retur++;
	}
	alfalow(str);
	pack_init(str);
	if (retur<2) {
		pack_int2((long)0);
	} else {
		pack_int2((long)1);
	}
	pack_exchkend();
	send_linie();
	return;
}

/* ********************** */
static int nyslet_reservation(langstr,kundenr,resnr,sendflag)
char * langstr;
long int kundenr;
long int resnr;
short int sendflag; {
	short int retur = 1;
	short int fundet = 0;
	short int dondafolo = 0;

	if (ws_funktion>300) {
		dondafolo = 1;
	}
	if (logfil) {
		fprintf(logfil,
	"nyslet_reservation:lang=%s,kundenr=%ld,resnr=%ld,sendflag=%hd\n",
			langstr,
			kundenr,
			resnr,
			sendflag);
		fflush(logfil);
	}
	if (resnr>0) {
		reclow(r159, R159);
		f159_start(1, ISGTEQ);
		r159->record_x = resnr;
		egeread(f159, ISEQUAL);
	}
	if (resnr>0 && f159_ok) {
		r159->status = 5;
		sprintf(r159->bem[0],
			"%2.2ld-%2.2ld-%4.4ld web annulleret",
			ws_systemdato % 100,
			(ws_systemdato % 10000) / 100,
			(ws_systemdato / 10000));
		fundet++;
	}
	if (logfil) {
		fprintf(logfil,
			"nyslet_reservation:fundet=%hd\n",
			fundet);
		fflush(logfil);
	}
	if (fundet==1 && r159->lejerkundenr!=kundenr) {
		retur = 0;
	}
	if (fundet==1 && retur==1) {
		ege_w_int1 = m036_funktion(12, ws_systemdato);
		ege_w_int2 = m036_funktion(12, r159->dato_ud);
		if (ege_w_int2-ege_w_int1<2) {
			retur = 0;
		}
	}
	if (fundet==1 && retur==1 && resnr>0) {
		resdatagem(bss->data_sti);
	}
	if (logfil) {
		fprintf(logfil, "nyslet_reservation:retur=%hd\n",
			retur);
		fflush(logfil);
	}
	if (sendflag==1 && resnr>0 && kundenr>0 && retur==1) {
		(void)find_r178(0,10,0,(double)kundenr);
	}
	if (sendflag==1 && resnr>0 && kundenr>0 && retur==1 &&
		strlen(r178->alfa_felt)) {
		(void)send_annullering(resnr,
			ws_langstr,
			r178->alfa_felt);
	}
	if (dondafolo==0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)retur);
		pack_exchkend();
		send_linie();
	}
	return(retur);
}

/* ********************** */
static int cancel_reservation(long resnr,long kundenr,short slet198) {
	short int retur = 1;
	short int fundet = 0;
	short int sendflag = 1;
	long int unixtid1 = 0;
	long int unixtid2 = 0;
	long int antaltimer = 0;
	long int antaltimer2 = 0;
	long int sysamdtm = 0;
	long int udamdtm = 0;
	char tmpstr[81] = "";

	if (logfil) {
		fprintf(logfil,
	"cancel_reservation:resnr=%ld,kundenr=%ld,udldk=%hd,slet198=%hd\n",
			resnr,
			kundenr,
			ws_udldkflag,
			slet198);
		fprintf(logfil,"\tws_systemdato=%ld\n",ws_systemdato);
		fprintf(logfil,"\tws_systemtid=%ld\n",ws_systemtid);
		fflush(logfil);
	}
/* NYT 130614 */
	if (ws_funktion==10) { sendflag = 0; }
	if (ws_funktion==17) { sendflag = 0; }
	if (logfil) {
		fprintf(logfil,"\tsendflag=%hd\n",sendflag);
	}
	if (resnr>0) {
		reclow(r159, R159);
		f159_start(1, ISGTEQ);
		r159->record_x = resnr;
		egeread(f159, ISEQUAL);
	}
	if (logfil) {
		fprintf(logfil,"\tdato_ud=%ld\n",r159->dato_ud);
		fprintf(logfil,"\ttid_ud=%ld\n",r159->tid_ud);
	}
/* NYT 130624 CANCEL48TIMER */
	if (resnr>0 && f159_ok && r159->status==2 && ws_funktion==12) {
		udamdtm = r159->dato_ud;
		udamdtm *= 10000;
		udamdtm += (long int)(r159->tid_ud/100);

		sysamdtm = ws_systemdato;
		sysamdtm *= 10000;
		sysamdtm += (long int)(ws_systemtid/100);
		antaltimer = udvdatofunk(10,udamdtm,sysamdtm);

		m002->klokken = r159->tid_ud;
		m002->klokken *= 100;
                m002->input_dato = r159->dato_ud;
		m002_38;
		unixtid1 = m002->unix_tid;

		m002->klokken = ws_systemtid;
		m002->klokken *= 100;
                m002->input_dato = ws_systemdato;
		m002_38;
		unixtid2 = m002->unix_tid;
		antaltimer2 = unixtid1;
		antaltimer2 -= unixtid2;
		antaltimer2 /= 3600;
	}
	if (logfil) {
		fprintf(logfil,"\tudamdtm=%ld\n",udamdtm);
		fprintf(logfil,"\tsysamdtm=%ld\n",sysamdtm);
		fprintf(logfil,"\tantaltimer=%ld\n",antaltimer);
		fprintf(logfil,"\tunixtid1=%ld\n",unixtid1);
		fprintf(logfil,"\tunixtid2=%ld\n",unixtid2);
		fprintf(logfil,"\tantaltimer2=%ld\n",antaltimer2);
	}
	if (resnr>0 && f159_ok && r159->status==2 && ws_funktion==12 &&
		antaltimer2>0 && antaltimer2<48) {
		ws_don2errno = DON2CNC48T;
		fundet = 0;
		retur = 0;
	}
	if (resnr>0 && f159_ok && kundenr>0 &&
		r159->lejerkundenr!=kundenr) {
		retur = 0;
	}
/* NYT 090331 */
	if (ws_udldkflag>0 && resnr>0 && f159_ok && kundenr<=0 &&
		r159->lejerkundenr>0) {
		retur = 0;
	}
	if (retur==1 && resnr>0 && f159_ok && r159->status==5) {
		ws_don2errno = DON2CNCCNC;
		fundet = 0;
		retur = 0;
	}
	if (retur==1 && resnr>0 && f159_ok && r159->status==7) {
		ws_don2errno = DON2CNCKNV;
		fundet = 0;
		retur = 0;
	}
	if (retur==1 && resnr>0 && f159_ok && r159->status==2 &&
		ws_don2errno<=0) {
		r159->status = 5;
		r159->opdat_dato = ws_systemdato;
/*
		sprintf(r159->bem[0],
			"%2.2ld-%2.2ld-%4.4ld web annulleret",
			ws_systemdato % 100,
			(ws_systemdato % 10000) / 100,
			(ws_systemdato / 10000));
*/
		if (ws_udldkflag>0 && strlen(ws_paratab[0])) {
			ws_paratab[0][30] = '\0';
			strcpy(r159->skade[0],ws_paratab[0]);
		}
		fundet++;
	}
	if (logfil) {
		fprintf(logfil,
			"cancel_reservation:fundet=%hd retur=%hd resnr=%ld\n",
			fundet,
			retur,
			resnr);
		fflush(logfil);
	}
	if (fundet==1 && retur==1 && resnr>0) {
		resdatagem(bss->data_sti);
	}

	if (fundet==0 && retur==0 && resnr>0 && ws_don2errno>0 && sendflag>0) {
		(void)frankly_err(ws_funktion,
                                "fejl",ws_don2errno);
	}
	if (fundet==0 && retur==0 && resnr>0 && ws_don2errno>0) {
		retur = 1;
		goto afslut;
	}
	if (logfil) {
		fprintf(logfil,
		"cancel_reservationHERTILX1:fundet=%hd retur=%hd resnr=%ld\n",
			fundet,
			retur,
			resnr);
		fflush(logfil);
	}
	if (fundet==1 && retur>0 && resnr>0 && slet198) {
		reclow(r198, R198);
		f198_start(1, ISGTEQ);
		r198->oplkode = 15903;
		r198->keynum = resnr;
		egeread(f198, ISEQUAL + ISLOCK);
		if (f198_ok) {
			egedelete(f198);
			egerel(f198);
		}
	}
	if (logfil) {
		fprintf(logfil,
		"cancel_reservationHERTILX2:fundet=%hd retur=%hd resnr=%ld\n",
			fundet,
			retur,
			resnr);
		fflush(logfil);
	}
/* NYT 090430 */
	if (fundet==1 && retur==1 && resnr>0) {
        	reclow(r155, R155);
		f155_start(1,ISGTEQ);
        	reclow(r155, R155);
		r155->funktion = 5;
		strcpy(r155->sign, "web");
		r155->lb_nr = (ULI)time(0);
		r155->dato = ws_systemdato;
		r155->kl_slet = ws_systemtid;
		r155->statnr = bss->id_stat_nr;
		r155->pcnr = 0;
		r155->type = 3;
		r155->statud = r159->station_ud_nr;
		r155->record_x = resnr;
		egewrite(f155);
		if (f155_ukendt) {
			console_err("bss.log f155 ikke gemt");
		}
	}
/* NYT 090902 */
	if (resnr>0) {
		reclow(r145,R145);
		r145->opdfunk = 5;
		r145->rec_x = resnr;
		r145->rec_tp = r159->kontrakttype_kode;
		r145->lbnr = (ULI)time(0);
		r145->kundenr = kundenr;
		r145->dato = ws_systemdato;
		r145->klslet = ws_systemtid;
		r145->statnr = r159->station_ud_nr;
		r145->pcnr = -1;
		r145->status = 1;
		r145->prognr = 7912;
		r145->progfunk = 40;
		r145->dato_ud = r159->dato_ud;
		r145->tid_ud = (short int)r159->tid_ud;
		sprintf(r145->sign,"webfunk%hd",ws_funktion);
		egewrite(f145);
		if (f145_ukendt) {
			console_err("bss.log f145 ikke gemt");
		}
	}
	if (fundet==1 && retur==1 && resnr>0 && ws_udldkflag>0) {
		styr_resprint(r159->station_ud_nr);
	}
	if (retur>0 && sendflag>0) {
/* RETTET 130614
	if (retur>0) {
*/
		alfalow(str);
		pack_init(str);
		pack_int2((long)1);
		sprintf(tmpstr,"%ld cancel ok",r159->record_x);
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
	}
afslut:
	if (logfil) {
		fprintf(logfil, "cancel_reservation:retur=%hd\n",
			retur);
		fflush(logfil);
	}
	return(retur);
}

/* ***************** */
static void send_f159liste(funktion,langstr,kundenr)
short int funktion;
char * langstr;
long int kundenr; {
	short int antal = 0;
	long int tildato;
	long int tiltid;
	char tmpstr[81] = "";
	char chkgrp[21] = "";

/* TEST */
	sprintf(dum_str, "send_f159liste:funktion=%hd,kundenr=%ld",
		funktion,
		kundenr);
	logfil_put(dum_str);
	reclow(r159, R159);
	r159->lejerkundenr = kundenr;
	f159_start(10, ISGTEQ);
	if (f159_ukendt) {
		antal = -1;
	}
	while (antal>=0) {
		egeread(f159, ISNEXT);
		if (f159_eof) {
			break;
		}
		if (r159->lejerkundenr>kundenr) {
			break;
		}
		if (r159->status==5) {
			continue;
		}
		if (r159->station_ud_nr!=56 &&
			r159->station_ud_nr!=57 &&
			r159->station_ud_nr!=58 &&
			r159->station_ud_nr!=66) {
			continue;
		}
		if (funktion==23 && r159->kontrakttype_kode!=3) {
			continue;
		}
		if (funktion==24 && r159->kontrakttype_kode!=1) {
			continue;
		}
		alfalow(str);
		pack_init(str);
		pack_int2((long)r159->record_x);
		pack_alfa(r159->bil_grp);
/* NYT 030117 */
/* RETTET 040514 */
		strcpy(tmpstr, "");
		strcpy(chkgrp, "");
		if (strcmp(r159->bil_grp,"A")>=0 &&
			strcmp(r159->bil_grp,"Z")<=0) {
			strcpy(chkgrp, "A");
                }
		if (strcmp(r159->bil_grp,"0")>=0 &&
			strcmp(r159->bil_grp,"9")<=0) {
			strcpy(chkgrp, "3");
                }
		if (strlen(chkgrp)) {
			(void)f198_tekst(langstr,16526,
				(double)0,chkgrp,0,tmpstr);
		}
		pack_alfa(tmpstr);

		pack_alfa(r159->bil_reg_nr);
		pack_int2((long)r159->dato_ud);
		sprintf(tmpstr,"%2.2ld:%2.2ld",
			r159->tid_ud/100,
			r159->tid_ud%100);
		pack_alfa(tmpstr);
		tildato = r159->dato_ind;
		tiltid = r159->tid_ind;
		if (r159->status==2) {
			tildato = r159->forv_dato_ind;
			tiltid = r159->forv_tid_ind;
		}
		pack_int2((long)tildato);
		sprintf(tmpstr,"%2.2ld:%2.2ld",
			tiltid/100,
			tiltid%100);
		pack_alfa(tmpstr);
/* NYT FELT 040204 */
		pack_int2((long)r159->rate_incl_km[10]);
        	pack_doub(r159->total);
		pack_exchkend();
		send_linie();
		antal++;
	}
	if (antal<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)0);
		pack_exchkend();
		send_linie();
	}
	return;
}

/* ***************** */
static void nysend_f159liste(funktion,langstr,kundenr)
short int funktion;
char * langstr;
long int kundenr; {
	short int dondafolo = 0;
	short int antal = 0;
	short int wx1 = 0;
	short int tillantal = 0;
	short int tillspecnr = 0;
	short int extantal = 0;
	short int extspecnr = 0;
	long int retdato;
	long int tildato;
	long int tiltid;
	long int julian;
	long int varighed;
	char tmpstr[81] = "";
	char chkgrp[21] = "";

	if (ws_funktion>=300) {
		dondafolo = 1;
	}
/* TEST */
	sprintf(dum_str, "nysend_f159liste:funktion=%hd,kundenr=%ld",
		funktion,
		kundenr);
	logfil_put(dum_str);
	reclow(r159, R159);
	r159->lejerkundenr = kundenr;
	f159_start(10, ISGTEQ);
	if (f159_ukendt) {
		antal = -1;
	}
	while (antal>=0) {
		egeread(f159, ISNEXT);
		if (f159_eof) {
			break;
		}
		if (r159->lejerkundenr>kundenr) {
			break;
		}
		if (r159->status==5) {
			continue;
		}
		if (r159->station_ud_nr!=56 &&
			r159->station_ud_nr!=57 &&
			r159->station_ud_nr!=58 &&
			r159->station_ud_nr!=66) {
			continue;
		}
		if (funktion==53 && r159->kontrakttype_kode!=3) {
			continue;
		}
		if (funktion==53 && r159->status==7) {
			continue;
		}
		if (funktion==54 && r159->kontrakttype_kode!=1) {
			continue;
		}
		if (dondafolo==1 && ws_subfunktion==1 &&
			r159->kontrakttype_kode!=3) {
			continue;
		}
		if (dondafolo==1 && ws_subfunktion==1 &&
			r159->status==7) {
			continue;
		}
		if (dondafolo==1 && ws_subfunktion==2 &&
			r159->kontrakttype_kode!=1) {
			continue;
		}

		if (r159->status==2 || r159->status==7) {
			tildato = r159->forv_dato_ind;
			tiltid = r159->forv_tid_ind;
		}
		retdato = 0;
		if (r159->kontrakttype_kode==3) {
			julian = m036_funktion(12, r159->dato_ud);
                	julian -= 2;
			retdato = m036_funktion(19, julian);
		}
		julian = m036_funktion(12, r159->dato_ud);
		varighed = m036_funktion(12, tildato);
		varighed -= julian;

		alfalow(str);
		pack_init(str);

		pack_int2((long)retdato);
		pack_int2((long)r159->station_ud_nr);
		pack_int2((long)r159->record_x);
		strcpy(tmpstr, "");
		strcpy(chkgrp, "");
		if (strcmp(r159->bil_grp,"A")>=0 &&
			strcmp(r159->bil_grp,"Z")<=0) {
			strcpy(chkgrp, "A");
                }
		if (strcmp(r159->bil_grp,"0")>=0 &&
			strcmp(r159->bil_grp,"9")<=0) {
			strcpy(chkgrp, "3");
                }
		pack_alfa(chkgrp);

		if (strlen(chkgrp)) {
			(void)f198_tekst(langstr,16526,
				(double)0,chkgrp,0,tmpstr);
		}
		pack_alfa(tmpstr);

		pack_alfa(r159->bil_reg_nr);
		pack_int2((long)r159->dato_ud);
		sprintf(tmpstr,"%2.2ld:%2.2ld",
			r159->tid_ud/100,
			r159->tid_ud%100);
		pack_alfa(tmpstr);
		tildato = r159->dato_ind;
		tiltid = r159->tid_ind;
		if (r159->status==2 || r159->status==7) {
			tildato = r159->forv_dato_ind;
			tiltid = r159->forv_tid_ind;
		}
		pack_int2((long)tildato);
		sprintf(tmpstr,"%2.2ld:%2.2ld",
			tiltid/100,
			tiltid%100);
		pack_alfa(tmpstr);
/* NYT FELT 040204 */
		pack_int2((long)r159->rate_incl_km[10]);
        	pack_doub(r159->total);
		pack_int2((long)r159->forsikring_pai);
		pack_int2((long)r159->rate_antal[0]);
		pack_int2((long)r159->rate_spec_nr[0]);
		tillantal = 0;
		tillspecnr = 0;
		for (wx1=1;wx1<10;wx1++) {
			if (r159->rate_spec_nr[wx1]==186) {
				tillspecnr = 186;
				tillantal += (short int)r159->rate_antal[wx1];
			}
		}
		pack_int2((long)tillantal);
		pack_int2((long)tillspecnr);
		for (wx1=1;wx1<10;wx1++) {
			extantal = 0;
			extspecnr = 0;
			if (r159->rate_spec_nr[wx1]>0 &&
				r159->rate_spec_nr[wx1]!=186) {
				extantal = (short int)r159->rate_antal[wx1];
				extspecnr = (short int)r159->rate_spec_nr[wx1];
			}
/* NYT 131204 PSEXTRA */
			if (extspecnr==905) {
				extantal /= (short int)varighed;
			}
			if (extspecnr==906) {
				extantal /= (short int)varighed;
			}
			if (extspecnr==907) {
				extantal /= (short int)varighed;
			}
			if (extspecnr==908) {
				extantal /= (short int)varighed;
			}

			if (extspecnr==932) {
				extantal /= (short int)varighed;
			}
			if (extspecnr==933) {
				extantal /= (short int)varighed;
			}
			if (extspecnr==934) {
				extantal /= (short int)varighed;
			}
			if (extspecnr>0) {
				pack_del();
				pack_int2((long)extantal);
				pack_int2((long)extspecnr);
			}
		}
		pack_exchkend();
		send_linie();
/* TEST */
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		antal++;
	}
	if (antal<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)0);
		pack_exchkend();
		send_linie();
	}
/* TEST */
	sprintf(dum_str, "nysend_f159liste:antal=%hd",
		antal);
	logfil_put(dum_str);
	return;
}

/* ***************** */
static void don_f159liste(funktion,langstr,kundenr)
short int funktion;
char * langstr;
long int kundenr; {
	short int dondafolo = 0;
	short int antal = 0;
	short int wx1 = 0;
	short int tillantal = 0;
	short int tillspecnr = 0;
	short int extantal = 0;
	short int extspecnr = 0;
	short int sletflag = 0;
	long int retdato;
	long int tildato;
	long int tiltid;
	long int julian;
	long int varighed;
	char tmpstr[81] = "";
	char chkgrp[21] = "";

	if (ws_funktion>=300) {
		dondafolo = 1;
	}
/* TEST */
	sprintf(dum_str, "don_f159liste:funktion=%hd,kundenr=%ld,dondafolo=%hd",
		funktion,
		kundenr,
		dondafolo);
	logfil_put(dum_str);
	reclow(r159, R159);
	r159->lejerkundenr = kundenr;
	f159_start(10, ISGTEQ);
	if (f159_ukendt) {
		antal = -1;
	}
	while (antal>=0) {
		egeread(f159, ISNEXT);
		if (f159_eof) {
			break;
		}
		if (r159->lejerkundenr>kundenr) {
			break;
		}
		if (r159->status==5) {
			continue;
		}
		if (r159->station_ud_nr!=56 &&
			r159->station_ud_nr!=57 &&
			r159->station_ud_nr!=58 &&
			r159->station_ud_nr!=66) {
			continue;
		}
		if (dondafolo==1 && ws_subfunktion==1 &&
			r159->kontrakttype_kode!=3) {
			continue;
		}
		if (dondafolo==1 && ws_subfunktion==1 &&
			r159->status==7) {
			continue;
		}
		if (dondafolo==1 && ws_subfunktion==2 &&
			r159->kontrakttype_kode!=1) {
			continue;
		}

		if (r159->status==2 || r159->status==7) {
			tildato = r159->forv_dato_ind;
			tiltid = r159->forv_tid_ind;
		}
		sletflag = 0;
		retdato = 0;
		if (r159->kontrakttype_kode==3) {
			julian = m036_funktion(12, r159->dato_ud);
                	julian -= 2;
			retdato = m036_funktion(19, julian);
		}
		if (r159->kontrakttype_kode==3 &&
			retdato>=ws_systemdato) {
			sletflag = 1;
		}

		julian = m036_funktion(12, r159->dato_ud);
		varighed = m036_funktion(12, tildato);
		varighed -= julian;

		alfalow(str);
		pack_init(str);

		pack_int2((long)r159->record_x);
		sprintf(tmpstr,"%s %s",
			r159->lejerfornavn,
			r159->lejerefternavn);
		stednavn_form(tmpstr);
		pack_alfa(tmpstr);

		pack_int2((long)r159->station_ud_nr);
		pack_int2((long)r159->station_ind_nr);

		sprintf(tmpstr,"%8.8ld-%4.4ld",
			r159->dato_ud,
			r159->tid_ud);
		pack_alfa(tmpstr);

		tildato = r159->dato_ind;
		tiltid = r159->tid_ind;
		if (r159->status==2 || r159->status==7) {
			tildato = r159->forv_dato_ind;
			tiltid = r159->forv_tid_ind;
		}
		sprintf(tmpstr,"%8.8ld-%4.4ld",
			tildato,
			tiltid);
		pack_alfa(tmpstr);

		strcpy(tmpstr, "");
		strcpy(chkgrp, "");
		if (strcmp(r159->bil_grp,"A")>=0 &&
			strcmp(r159->bil_grp,"Z")<=0) {
			strcpy(chkgrp, "A");
                }
		if (strcmp(r159->bil_grp,"0")>=0 &&
			strcmp(r159->bil_grp,"9")<=0) {
			strcpy(chkgrp, "3");
                }
/*
		pack_alfa(chkgrp);
*/
		if (strlen(chkgrp)) {
			(void)f198_tekst(langstr,16526,
				(double)0,chkgrp,0,tmpstr);
		}
		stednavn_form(tmpstr);
		pack_alfa(tmpstr);
        	pack_doub(r159->total);
		pack_int2((long)r159->rate_incl_km[10]);
		pack_int2((long)sletflag);
		pack_exchkend();
		send_linie();
/* TEST */
		if (logfil) {
			fprintf(logfil, "SENDT:str=%s", str);
			fflush(logfil);
		}
		antal++;
	}
	if (antal<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)0);
		pack_exchkend();
		send_linie();
	}
/* TEST */
	sprintf(dum_str, "don_f159liste:antal=%hd",
		antal);
	logfil_put(dum_str);
	return;
}

/* *********************************** */
static void opdat_kredit_betaling() {
	short int netkortflag = 0;
	short int dondafolo = 0;
	short int dibsok = 0;

	if (ws_funktion>=300) {
		dondafolo = 1;
	}
	if (ws_funktion>0) {
		dondafolo = 1;
	}

/* NYT 130301 */
	if (logfil) {
		fprintf(logfil, "opdat_kredit_betaling:ws_funktion=%hd\n",
			ws_funktion);
		fprintf(logfil,"\tdondafolo=%hd\n",
			dondafolo);
		fprintf(logfil,"\tws_betalingsflag=%hd\n",
			ws_betalingsflag);
		fprintf(logfil,"\tws_betalingskode=%s+%lf\n",
			ws_betalingskode,
			ws_betalingsbeloeb);
		fprintf(logfil,"\tws_betdepkode=%s+%lf\n",
			ws_betdepkode,
			ws_betdepbeloeb);
		fflush(logfil);
	}
	if (ws_resnr<=0 && dondafolo<=0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)0);
		pack_alfa("BOOKINGNRFEJL");
		pack_exchkend();
		send_linie();
		return;
	}
	if (ws_resnr<=0 && dondafolo>0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)-315);
		web_errormess(0,ws_langstr,"315");
		pack_exchkend();
		send_linie();
		return;
	}

	reclow(r159, R159);
	f159_start(1, ISGTEQ);
	r159->record_x = ws_resnr;
	egeread(f159, ISEQUAL+ISLOCK);
	if (f159_ukendt && dondafolo<=0) {
		egerel(f159);
		alfalow(str);
		pack_init(str);
		pack_int2((long)0);
		pack_alfa("BOOKINGNRFEJL");
		pack_exchkend();
		send_linie();
		return;
	}
	if (f159_ukendt && dondafolo>0) {
		egerel(f159);
		alfalow(str);
		pack_init(str);
		pack_int2((long)-315);
		web_errormess(0,ws_langstr,"315");
		pack_exchkend();
		send_linie();
		return;
	}
	netkortflag = 0;
/* INGEN ÆNDRING I RES.DATA
	sprintf(chkstr, "UdlNetkort%hd=Ja",r159->station_ud_nr);
	strcpy(dum_str,"UNIXBSS");
	if (retur_f198_def(1001,chkstr,dum_str)>0) {
		netkortflag = 1;
	}
*/
/* leje */
	if (ws_betalingsflag==1) {
		r159->fralejer_1 = 0;
		ws_betalingskode[20] = '\0';
		if (netkortflag==1) {
			r159->fralejer_3 = 3;
			sprintf(dum_str,"%.2lf %s %s",
				ws_betalingsbeloeb,
				ws_betalingskode,
				ws_betalingstype);
			egechartest((unsigned char *)dum_str);
			dum_str[30] = '\0';
			strcpy(r159->fralej_3_kontonr, dum_str+15);
			dum_str[15] = '\0';
			strcpy(r159->fralej_3_nr, dum_str);
		} else {
			r159->fralejer_4 = 2;
			strcpy(r159->fralej_4_kode, ws_betalingskode);
			sprintf(r159->fralej_4_opl[0],"%.2lf",
				ws_betalingsbeloeb);
			strcpy(r159->fralej_4_opl[1], ws_betalingstype);
		}
	}
/* depositum */
	if (ws_betalingsflag==2) {
		r159->forudbetaling_1 = 0;
		ws_betalingskode[20] = '\0';
		if (netkortflag==1) {
			r159->forudbetaling_3 = 3;
			sprintf(dum_str,"%.2lf %s %s",
				ws_betalingsbeloeb,
				ws_betalingskode,
				ws_betalingstype);
			egechartest((unsigned char *)dum_str);
			dum_str[30] = '\0';
			strcpy(r159->forud_3_kontonr, dum_str+15);
			dum_str[15] = '\0';
			strcpy(r159->forud_3_nr, dum_str);
		} else {
			r159->forudbetaling_4 = 2;
			strcpy(r159->forud_4_kode, ws_betalingskode);
			sprintf(r159->forud_4_opl[0],"%.2lf",
				ws_betalingsbeloeb);
			strcpy(r159->forud_4_opl[1], ws_betalingstype);
		}
	}
/* NYT 070827 */
/* OBS NETKORT MANGLER */
/* NYT 130301 DIBSSVAR */
	if (ws_betalingsflag==0) {
		dibsok = 1;
	}
	if (logfil) {
		fprintf(logfil,"\tdibsok=%hd\n",dibsok);
	}
	if (dondafolo>0 && dibsok>0) {
/* RETTET 130301
	if (dondafolo>0 && ws_betalingsflag>0) {
*/
		r159->fralejer_1 = 0;
		ws_betalingskode[20] = '\0';
		r159->fralejer_4 = 2;
		strcpy(r159->fralej_4_kode, ws_betalingskode);
		sprintf(r159->fralej_4_opl[0],"%.2lf",
			ws_betalingsbeloeb);
		strcpy(r159->fralej_4_opl[1], ws_betalingstype);

		r159->forudbetaling_1 = 0;
		ws_betdepkode[20] = '\0';
		r159->forudbetaling_4 = 2;
		strcpy(r159->forud_4_kode, ws_betdepkode);
		sprintf(r159->forud_4_opl[0],"%.2lf",
			ws_betdepbeloeb);
		strcpy(r159->forud_4_opl[1], ws_betalingstype);
	}
	egerew(f159);
	egerel(f159);
	if (dondafolo==0) {
		alfalow(str);
		pack_init(str);
		pack_int2((long)1);
		pack_alfa("OK");
		pack_exchkend();
		send_linie();
	}
/* NYT 090924 */
	reclow(r145,R145);
	r145->opdfunk = 101;
	r145->rec_x = r159->record_x;
	r145->rec_tp = r159->kontrakttype_kode;
	r145->lbnr = (ULI)time(0);
	r145->kundenr = r159->lejerkundenr;
	r145->dato = ws_systemdato;
	r145->klslet = ws_systemtid;
	r145->statnr = r159->station_ud_nr;
	r145->pcnr = -1;
	r145->status = 1;
	r145->prognr = 7912;
	r145->progfunk = ws_funktion;
	r145->dato_ud = r159->dato_ud;
	r145->tid_ud = (short int)r159->tid_ud;
	sprintf(dum_str,"%.2lf %s %s",
		ws_betalingsbeloeb,
		ws_betalingskode,
		ws_betalingstype);
	dum_str[10] = '\0';
	strcpy(r145->sign,dum_str);
	egewrite(f145);
	if (logfil) {
		fprintf(logfil,"opdat_kredit_betaling:OK\n");
		fflush(logfil);
	}
	return;
}

/* ******************************************************************** */
/* FRA p7238.c								*/
/* inptype 1=kvittering 2=reminder					*/
static int checksend_sms(int inptype,long inpresnr,char *inptlfnr) {
	int retur = 0;

	int kundeok = 0;
	int testkreds = 0;
	int testoknr = 0;
	int tgnantal = 0;
	int maxtgn = 160;
	long int varighed = 1;
	long int julian = 0;
	long int julian2 = 0;
	long int systemdato = 0;
	long int afhdage = 0;
	char datostr[2][21] = {"",""};
	char tmpstr[81] = "";
	char stationby[41] = "";
	char modtadr[81] = "";
	char navnstr[41] = "DonSms";
	char emnestr[41] = "SmsTest";
	char tlf[41] = "";
	char systemstr[501] = "";

	outfil = (FILE*)0;
	if (ws_testkreds>0) {
                testkreds = 1;
        }
        if (logfil) {
                fprintf(logfil, "checksend_sms:%d %ld %s\n",
			inptype,
			inpresnr,
			inptlfnr);
                fflush(logfil);
        }
	if (inpresnr>0) {
		reclow(r159,R159);
		f159_start(1,ISGTEQ);
		r159->record_x = inpresnr;
		egeread(f159,ISEQUAL);
	}
	kundeok = 0;
	if (kundeok==0 && r159->firmakundenr>0) {
		reclow(r167,R167);
		f167_start(1,ISGTEQ);
		r167->kunde_nr = r159->firmakundenr;
		egeread(f167,ISEQUAL);
	}
	if (kundeok==0 && r159->firmakundenr>0 && f167_ok) {
		kundeok = 1;
	}
	if (kundeok==0 && r159->lejerkundenr>0) {
		reclow(r167,R167);
		f167_start(1,ISGTEQ);
		r167->kunde_nr = r159->lejerkundenr;
		egeread(f167,ISEQUAL);
	}
	if (kundeok==0 && r159->lejerkundenr>0 && f167_ok) {
		kundeok = 1;
	}
	if (kundeok==1 && r167->kunde_nr>0) {
		reclow(r178,R178);
		f178_start(1,ISGTEQ);
		r178->kunde_nr = (double)r167->kunde_nr;
		r178->opl_kode = 66;
		egeread(f178,ISEQUAL);
	}
	if (kundeok==1 && r167->kunde_nr>0 &&
		f178_ok && r178->num_felt>0) {
		kundeok = 2;
	}
	if (kundeok==2 && r167->kunde_nr>0) {
		r178->kunde_nr = (double)r167->kunde_nr;
		r178->opl_kode = 65;
		egeread(f178,ISEQUAL);
	}
	if (kundeok==2 && r167->kunde_nr>0 &&
		f178_ok && strlen(r178->alfa_felt)) {
		kundeok = 3;
		strcpy(tlf,r178->alfa_felt);
	}
        if (logfil) {
                fprintf(logfil, "\tkundeok=%d tlf=<%s>\n",kundeok,tlf);
                fflush(logfil);
        }
/*
	if (strlen(inptlfnr)) {
		strcpy(tlf,inptlfnr);
	}
*/
	(void)slet_blanke((unsigned char *)tlf);
	testoknr = -1;
/* RETTET 130225
	testoknr = 0;
*/
	if (strcmp(tlf,"20417815")==0) {
		testoknr = 1;
	}
	if (strcmp(tlf,"20788781")==0) {
		testoknr = 1;
	}
	if (strcmp(tlf,"40942225")==0) {
		testoknr = 1;
	}
	if (testoknr==0 && strlen(inptlfnr)) {
		strcpy(tlf,inptlfnr);
	}
/*
	if (strlen(ws_testsmsnr)) {
		strcpy(tlf,ws_testsmsnr);
	}
*/
        if (logfil) {
                fprintf(logfil, "\ttlf=%s\n",tlf);
                fflush(logfil);
        }
/* NYT 130225 */
	if (!strlen(tlf)) {
		goto afslut;
	}
	if (strlen(tlf)) {
		sprintf(modtadr,"45%s.BBMF21548PBOD@cpsms.dk",tlf);
		if (testkreds>0) {
			strcpy(emnestr,"TestDon.net");
		} else {
			strcpy(emnestr,"driveon.net");
		}
	}
        if (logfil) {
                fprintf(logfil, "\tmodtadr=%s\n",modtadr);
                fflush(logfil);
        }
	if (!strlen(modtadr)) {
		return(0);
	}
	systemdato = ege_date();
	julian = m036_funktion(12, r159->dato_ud);
	julian2 = m036_funktion(12, systemdato);
	afhdage = julian - julian2;
	if (logfil) {
		fprintf(logfil, "\tafhdage=%ld\n",afhdage);
		fflush(logfil);
	}

	varighed = -1;
	if (r159->dato_ud>0 && r159->forv_dato_ind>0) {
		julian = m036_funktion(12, r159->dato_ud);
		julian2 = m036_funktion(12, r159->forv_dato_ind);
		varighed = julian2 - julian;
	}
	if (varighed==0) {
		varighed = 1;
	}
	if (r159->station_ud_nr==58) {
		strcpy(stationby,"Kgs.Lyngby");
	}
	if (r159->station_ud_nr==66) {
		strcpy(stationby,"København");
	}

	ege_w_int1 = m036_funktion(17, r159->dato_ud);
	egeedit(ege_w_dou1=ege_w_int1,"99.99.9999",datostr[0]);
	ege_w_int1 = (long int)r159->tid_ud;
	egeedit(ege_w_dou1=ege_w_int1, "99.99",datostr[1]);
	sprintf(tmpstr,"/tmp/donsmsmail_%hd.bdy",ege_pid);
	outfil = fopen(tmpstr,"w");
	if (outfil && inptype==0) {
		sprintf(tmpstr,"TEST\n");
		fprintf(outfil,"%s",tmpstr);
		tgnantal += strlen(tmpstr);
		sprintf(tmpstr,"Nr %ld\n",r159->record_x);
		if (r159->record_x==0) {
			sprintf(tmpstr,"Nr ?\n");
		}
		fprintf(outfil,"%s",tmpstr);
		tgnantal += strlen(tmpstr);
	}
	if (outfil && inptype==1) {
		sprintf(tmpstr,"Din booking af ");
		fprintf(outfil,"%s",tmpstr);
		tgnantal += strlen(tmpstr);
		strcpy(tmpstr,"personbil");
		if (r159->bil_grp[0]>=48 && r159->bil_grp[0]<=57) {
			strcpy(tmpstr,"varevogn");
		}
		fprintf(outfil,"%s",tmpstr);
		tgnantal += strlen(tmpstr);
		sprintf(tmpstr
			," hos driveon.net er bekræftet.");
/*
		if (varighed>0) {
			sprintf(tmpstr
			," %ld døgn hos driveon.net bekræftet.",
			varighed);
		} else {
			sprintf(tmpstr
			," ? døgn hos driveon.net bekræftet.");
		}
*/
		fprintf(outfil,"%s",tmpstr);
		tgnantal += strlen(tmpstr);

		sprintf(tmpstr
			," Afh.%s %s kl.%s.",
			stationby,
			datostr[0],
			datostr[1]);
		fprintf(outfil,"%s",tmpstr);
		tgnantal += strlen(tmpstr);
		sprintf(tmpstr
			," Resnr.%ld.",
			r159->record_x);
/*
		sprintf(tmpstr
			," Pris kr.%.2lf nr.%ld.",
			r159->total,
			r159->record_x);
*/
		fprintf(outfil,"%s",tmpstr);
		tgnantal += strlen(tmpstr);
		sprintf(tmpstr
			," SMS kan ikke besv. Tlf.%s.",
			r159->station_ud_tlf);
		fprintf(outfil,"%s",tmpstr);
		tgnantal += strlen(tmpstr);
	}
	if (outfil && inptype==2) {
		sprintf(tmpstr,"Din ");
		fprintf(outfil,"%s",tmpstr);
		tgnantal += strlen(tmpstr);
		strcpy(tmpstr,"personbil");
		if (r159->bil_grp[0]>=48 && r159->bil_grp[0]<=57) {
			strcpy(tmpstr,"varevogn");
		}
		fprintf(outfil,"%s",tmpstr);
		tgnantal += strlen(tmpstr);
		sprintf(tmpstr, " står klar til afhentning ");
		fprintf(outfil,"%s",tmpstr);
		tgnantal += strlen(tmpstr);
		if (afhdage==0) {
			sprintf(tmpstr, " i dag kl.%s.",
				datostr[1]);
		}
		if (afhdage==1) {
			sprintf(tmpstr, " i morgen kl.%s.",
				datostr[1]);
		}
		if (afhdage>1) {
			sprintf(tmpstr, " %s kl.%s.",
				datostr[0],
				datostr[1]);
		}
		fprintf(outfil,"%s",tmpstr);
		tgnantal += strlen(tmpstr);
		sprintf(tmpstr, " Adr: %s,%s %s",
			r159->station_ud_adr,
			r159->station_ud_postkode,
			r159->station_ud_by);
		fprintf(outfil,"%s",tmpstr);
		tgnantal += strlen(tmpstr);
		sprintf(tmpstr, ". Vi ses.");
/*
		sprintf(tmpstr, ". Vi glæder os til at se dig.");
*/
		fprintf(outfil,"%s",tmpstr);
		tgnantal += strlen(tmpstr);
		sprintf(tmpstr, " Resnr.%ld.",r159->record_x);
		fprintf(outfil,"%s",tmpstr);
		tgnantal += strlen(tmpstr);
		sprintf(tmpstr
			," SMS kan ikke besv. Tlf.%s.",
			r159->station_ud_tlf);
		fprintf(outfil,"%s",tmpstr);
		tgnantal += strlen(tmpstr);
	}
	if (logfil) {
		fprintf(logfil,"\ttgnantal=%d\n",tgnantal);
		fflush(logfil);
	}
	while (outfil && tgnantal<=maxtgn) {
		fprintf(outfil," ");
		tgnantal++;
	}
	if (outfil) {
		fclose(outfil);
	}
	outfil = (FILE*)0;
	strcpy(tmpstr,find_mail(ege_user));
	if (strcmp(ege_prognr,"7911")==0) {
		strcpy(tmpstr,"reservations@europcar.dk");
	}
	if (strcmp(ege_prognr,"7912")==0) {
		strcpy(tmpstr,"info@driveon.net");
	}
	if (!strlen(tmpstr)) {
		strcpy(tmpstr,"reservations@europcar.dk");
	}
	if (strcmp(ws_hostnavn,"carla-pg")==0) {
		strcpy(tmpstr,"no-reply@europcar.dk");
	}
	if (logfil) {
		fprintf(logfil,"\ttmpstr(afsender)=%s\n",tmpstr);
	}
	alfalow(systemstr);
        sprintf(systemstr,
"%s/egemail /plainmail:1 /p:%s?%s?%s?%s? /a:%s /emne:%s /navn:%s\0",
                egeenv("EXECPATH"),
                egeenv("KREDS"),
                ege_user,
                modtadr,
                "",
		tmpstr,
                emnestr,
                navnstr);
/*
	if (strlen(ccadr)) {
		sprintf(tmpstr, " /cc:%s\0",ccadr);
		strcat(systemstr,tmpstr);
	}
*/
	sprintf(tmpstr, " /bodyfil:/tmp/donsmsmail_%hd.bdy\0",ege_pid);
	strcat(systemstr,tmpstr);
        if (logfil) {
                fprintf(logfil, "checksend_sms:%s\n", systemstr);
                fflush(logfil);
	}
	sprintf(tmpstr,"driveonsms.log");
	outfil = fopen(tmpstr,"a");
	if (outfil) {
		fprintf(outfil,"%8.8ld_%4.4ld_%10.10ld_%s\n",
			(long int)ege_date(),
			(long int)ege_time()/10000,
			r159->record_x,
			systemstr);
		fclose(outfil);
	}
	outfil = (FILE*)0;

        system(systemstr);
	retur = 1;
	sprintf(tmpstr,"/tmp/donsmsmail_%hd.bdy",ege_pid);
	(void)unlink(tmpstr);
afslut:
        if (logfil) {
                fprintf(logfil, "checksend_sms:retur=%d\n",
			retur);
                fflush(logfil);
        }
	return(retur);
}

/*		*/
/* DATA FUNK 	*/
/*		*/

/* ********************************** */
static int f198_tekst(langstr,kode,keynum,keyalfa,lbnr,returstr)
char * langstr;
long int kode;
double keynum;
char * keyalfa;
long int lbnr;
char * returstr; {
	short int retur = 0;
	short int okflag = 0;
	char transstr[21] = "";

	if (logfil) {
		fprintf(logfil,
	"f198_tekst:langstr=%s,kode=%ld,keynum=%.0lf,keyalfa=%s,lbnr=%ld\n",
		langstr,
		kode,
		keynum,
		keyalfa,
		lbnr);
	}
	sprintf(returstr, "f198_tekst%s-%ld-%.0lf+%s-%ld",
		langstr,kode,keynum,keyalfa,lbnr);
	okflag = find_r198(1,kode,keynum,keyalfa,lbnr);
	if (okflag>0) {
		strcpy(returstr, r198->alfafelt);
		retur = 1;
	}
	if (logfil) {
		fprintf(logfil, "f198_tekst:okflag=%hd\n",
			okflag);
		fprintf(logfil, "f198_tekst:returstr=%s\n",
			returstr);
	}
	if (kode==16501 &&
		strcmp(langstr,"DK")!=0 &&
		strcmp(langstr,"DA")!=0) {
		sprintf(transstr, "%5.5ld%5.5ld",
			kode, (long int)keynum);
		retur = trans_tekst(langstr,0,transstr,returstr);
	}
/* RETTET 040514 */
	if (kode==16526 &&
		strcmp(langstr,"DK")!=0 &&
		strcmp(langstr,"DA")!=0) {
		sprintf(transstr, "%5.5ld%s",
			kode, keyalfa);
		retur = trans_tekst(langstr,0,transstr,returstr);
	}
/* NYT 040422 */
	if (kode==16809 &&
		strcmp(langstr,"DK")!=0 &&
		strcmp(langstr,"DA")!=0) {
		sprintf(transstr, "%5.5ld%s",
			kode, keyalfa);
		retur = trans_tekst(langstr,0,transstr,returstr);
	}
	if (kode==16811 &&
		strcmp(langstr,"DK")!=0 &&
		strcmp(langstr,"DA")!=0) {
		sprintf(transstr, "%5.5ld%s",
			kode, keyalfa);
		retur = trans_tekst(langstr,0,transstr,returstr);
	}
	if (kode==16812 &&
		strcmp(langstr,"DK")!=0 &&
		strcmp(langstr,"DA")!=0) {
		sprintf(transstr, "%5.5ld%s",
			kode, keyalfa);
		retur = trans_tekst(langstr,0,transstr,returstr);
	}
	if (kode==16813 &&
		strcmp(langstr,"DK")!=0 &&
		strcmp(langstr,"DA")!=0) {
		sprintf(transstr, "%5.5ld%s",
			kode, keyalfa);
		retur = trans_tekst(langstr,0,transstr,returstr);
	}
	if (kode==16814 &&
		strcmp(langstr,"DK")!=0 &&
		strcmp(langstr,"DA")!=0) {
		sprintf(transstr, "%5.5ld%s",
			kode, keyalfa);
		retur = trans_tekst(langstr,0,transstr,returstr);
	}
	if (kode==16815 &&
		strcmp(langstr,"DK")!=0 &&
		strcmp(langstr,"DA")!=0) {
		sprintf(transstr, "%5.5ld%s",
			kode, keyalfa);
		retur = trans_tekst(langstr,0,transstr,returstr);
	}

	return(retur);
}

/* ********************************** */
static int trans_tekst(langstr,numkode,alfakode,returstr)
char * langstr;
long int numkode;
char * alfakode;
char * returstr; {
	short int retur = 0;
	short int okflag = 0;
	long int oplkode = 0;
	char keyalfa[21] = "";

	if (logfil) {
		fprintf(logfil,
			"trans_tekst:langstr=%s,numkode=%ld,alfakode=%s\n",
		langstr,
		numkode,
		alfakode);
		fflush(logfil);
	}
	sprintf(returstr, "%s kode=%ld", langstr,numkode);
	if (strcmp(langstr, "DK")==0) {
		oplkode = 2000;
	}
	if (strcmp(langstr, "DA")==0) {
		oplkode = 2000;
	}
	if (strcmp(langstr, "ENG")==0) {
		oplkode = 2001;
	}
	if (strcmp(langstr, "UK")==0) {
		oplkode = 2001;
	}
	if (strcmp(langstr, "EN")==0) {
		oplkode = 2001;
	}
	if (strcmp(langstr, "TY")==0) {
		oplkode = 2002;
	}
	if (oplkode==0) {
		strcat(returstr, " sprog UKENDT");
		return(retur);
	}
	if (numkode>0) {
		sprintf(keyalfa, "%5.5ld", numkode);
	} else {
		strcpy(keyalfa, alfakode);
	}
	if (logfil) {
		fprintf(logfil,
			"trans_tekst:oplkode=%ld,keyalfa=%s\n",
			oplkode,
			keyalfa);
		fflush(logfil);
	}
	okflag = find_r198(1,oplkode,(double)0,keyalfa,0);
	if (logfil) {
		fprintf(logfil,
			"trans_tekst:okflag=%hd\n",
			okflag);
		fflush(logfil);
	}
	if (okflag>0) {
		strcpy(returstr, r198->alfafelt);
		retur = 1;
	}
	if (okflag<=0) {
		sprintf(returstr, "!%ld+%s!", oplkode,keyalfa);
	}
	return(retur);
}

/* ********************************** */
static int trans_tekst_lbnr(langstr,numkode,alfakode,returstr,lbnr)
char * langstr;
long int numkode;
char * alfakode;
char * returstr;
long int lbnr; {
	short int retur = 0;
	short int okflag = 0;
	long int oplkode = 0;
	char keyalfa[21] = "";

	if (logfil) {
		fprintf(logfil,
	"trans_tekst_lbnr:langstr=%s,numkode=%ld,alfakode=%s,lbnr=%ld\n",
		langstr,
		numkode,
		alfakode,
		lbnr);
		fflush(logfil);
	}
	sprintf(returstr, "%s kode=%ld", langstr,numkode);
	if (strcmp(langstr, "DK")==0) {
		oplkode = 2000;
	}
	if (strcmp(langstr, "DA")==0) {
		oplkode = 2000;
	}
	if (strcmp(langstr, "ENG")==0) {
		oplkode = 2001;
	}
	if (strcmp(langstr, "UK")==0) {
		oplkode = 2001;
	}
	if (strcmp(langstr, "EN")==0) {
		oplkode = 2001;
	}
	if (strcmp(langstr, "TY")==0) {
		oplkode = 2002;
	}
	if (oplkode==0) {
		strcat(returstr, " sprog UKENDT");
		return(retur);
	}
	if (numkode>0) {
		sprintf(keyalfa, "%5.5ld", numkode);
	} else {
		strcpy(keyalfa, alfakode);
	}
	if (logfil) {
		fprintf(logfil,
			"trans_tekst_lbnr:oplkode=%ld,keyalfa=%s\n",
			oplkode,
			keyalfa);
		fflush(logfil);
	}
	okflag = find_r198(1,oplkode,(double)0,keyalfa,lbnr);
	if (logfil) {
		fprintf(logfil,
			"trans_tekst_lbnr:okflag=%hd\n",
			okflag);
		fflush(logfil);
	}
	if (okflag>0) {
		strcpy(returstr, r198->alfafelt);
		retur = 1;
	}
	if (okflag<=0) {
		sprintf(returstr, "!%ld+%s!", oplkode,keyalfa);
	}
	return(retur);
}

/* *************************************** */
static int find_r178(initfunk,oplkode,lbnr,kundenr)
short int initfunk;
short int oplkode;
long int lbnr;
double kundenr; {
	short int retur = 1;

	if (initfunk==1) {
		reclow(r178, R178);
		f178_start(1, ISGTEQ);
	}
	r178->kunde_nr = kundenr;
	r178->opl_kode = oplkode;
	r178->lb_nr = lbnr;
	egeread(f178, ISEQUAL);
	if (f178_ukendt) {
		retur = 0;
	}
	return(retur);
}

/* ************************************************* */
static void opdat_r178(oplkode,kundenr)
short int oplkode;
double kundenr; {

	if (logfil) {
		fprintf(logfil,
			"opdat_r178:opl=%hd,kundenr=%.0lf,alfa=%s,num=%lf\n",
			oplkode,
			kundenr,
			r178->alfa_felt,
			r178->num_felt);
		fflush(logfil);
	}
	r178->opl_kode = oplkode;
	r178->kunde_nr = kundenr;
	r178->unix_tid = (ULI) time(0);
	r178->status = 1;
	egewrite(f178);
	if (f178_ukendt) {
		if (logfil) {
			fprintf(logfil,
				"opdat_r178:ukendt\n");
			fflush(logfil);
		}
		reccpy(&q178, r178, R178);
		egeread(f178, ISEQUAL + ISLOCK);
		reccpy(r178, &q178, R178);
		egerew(f178);
		egerel(f178);
	}
	return;
}

/*			*/
/* P8198 TEST		*/
/*			*/

/* ************************************** */
static void p8198_init() {
	char tmpstr[81];

/* overskrift */
	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEON");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("ALFA;0;1;LEFT");
	pack_alfa("vælg");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("KOLTOM;2;11;LEFT");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEOFF");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEON");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("ALFA;0;1;LEFT");
	pack_alfa("funktion:");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("KOLON;2;11;LEFT");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	sprintf(tmpstr, "SELECTON;sysfunk;0;0;0");
	pack_alfa(tmpstr);
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("0");
	pack_alfa("SELECTED");
	pack_alfa("forlad");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("101");
	pack_alfa("");
	pack_alfa("opret");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("102");
	pack_alfa("");
	pack_alfa("ret");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("103");
	pack_alfa("");
	pack_alfa("slet");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("104");
	pack_alfa("");
	pack_alfa("se");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("SELECTOFF");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("KOLOFF");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEOFF");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEON");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("KOLTOM;0;1;LEFT");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("KOLON;1;11;LEFT");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	sprintf(tmpstr, "SUBMIT;fnkaccept;accepter");
	pack_alfa(tmpstr);
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("KOLOFF");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEOFF");
	pack_exchkend();
	send_linie();

	return;
}

/* ************************************** */
static void p8198_funk(funktion)
short int funktion; {
	short int wx1;
	long int oplkode;
	char tmpstr[81];
	FILE * datafil;

	add_funk_linie(funktion);
/* overskrift */
	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEON");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("ALFA;0;1;LEFT");
	pack_alfa("vælg");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("KOLTOM;2;11;LEFT");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEOFF");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEON");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("ALFA;0;1;LEFT");
	pack_alfa("oplkode:");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("KOLON;2;11;LEFT");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	sprintf(tmpstr, "SELECTON;oplkode;0;0;0");
	pack_alfa(tmpstr);
	pack_exchkend();
	send_linie();

	datafil = (FILE*)0;
	sprintf(tmpstr, "%sp8198.opl",ws_kreds);
	datafil = fopen(tmpstr, "r");
	if (!datafil) {
		datafil = (FILE*)0;
	}
	wx1 = 0;
	while (datafil) {
		if (!fgets(tmpstr, 80, datafil)) {
			break;
		}
		if (strlen(tmpstr)) {
			tmpstr[strlen(tmpstr)-1] = '\0';
		}

		if (logfil) {
			fprintf(logfil, "tmpstr=%s\n", tmpstr);
		}
		sscanf(tmpstr, "%ld", &oplkode);
		alfalow(str);
		pack_init(str);
		pack_int2((long)oplkode);
		pack_alfa("");
		pack_alfa(tmpstr+13);
		pack_exchkend();
		send_linie();
	}
	if (datafil) {
		fclose(datafil);
		datafil = (FILE*)0;
	}

	alfalow(str);
	pack_init(str);
	pack_alfa("SELECTOFF");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("KOLOFF");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEOFF");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEON");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("KOLTOM;0;1;LEFT");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("KOLON;2;11;LEFT");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	sprintf(tmpstr, "SUBMIT;mskaccept1%hd;accepter", funktion);
	pack_alfa(tmpstr);
	pack_exchkend();
	send_linie();

        alfalow(str);
        pack_init(str);
        sprintf(tmpstr, "SUBMIT;mskfortryd100;tilbage");
        pack_alfa(tmpstr);
        pack_exchkend();
        send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("KOLOFF");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEOFF");
	pack_exchkend();
	send_linie();

	return;
}

/* ************************************** */
static void p8198_opl(funktion,feltfilsti)
short int funktion;
char * feltfilsti; {
	short int wx1;
	short int feltnr;
	short int feltsize;
	short int feltmax;
	char feltalign[11];
	short int vedlflag=0;
	short int maskeflag=0;
	long int oplkode;
	long int funkretur;
	double keynum;
	char keyalfa[21];
	long int lbnr;
	char oplkode_def[81];
	char tmpstr[81];
	char idstr[81];
	char returstr[81];
	char datafelt[81];
	char ledetext[10][41] = {"","","","","","","","","",""};
	char feltnavn[8][21] =
	{"","key","lbnr","status","fradato","tildato","numfelt","alfafelt"};
	FILE * datafil;

	add_funk_linie(funktion%1000);

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEON");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("ALFA;0;1;LEFT");
	pack_alfa("oplkode:");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("ALFA;2;11;LEFT");
	if (funktion/1000==1) {
		(void)find_feltdata(feltfilsti,"oplkode",tmpstr);
		sscanf(tmpstr, "%ld", &oplkode);
	}
	if (funktion/2000==1) {
		(void)find_feltdata(feltfilsti,"oplmatchid",idstr);
		(void)get_alfa_tgn(idstr,0,keyalfa,';');
		(void)get_alfa_tgn(idstr,1,tmpstr,';');
		sscanf(tmpstr, "%lf", &keynum);
		(void)get_alfa_tgn(idstr,2,tmpstr,';');
		sscanf(tmpstr, "%ld", &oplkode);
		(void)get_alfa_tgn(idstr,3,tmpstr,';');
		sscanf(tmpstr, "%ld", &lbnr);
	}
	(void)find_opldata(oplkode,oplkode_def);
	sprintf(tmpstr, "%ld", oplkode);
	pack_alfa(tmpstr);
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEOFF");
	pack_exchkend();
	send_linie();

	if (funktion/1000==1 && funktion%1000!=101) {
		funkretur = dan_r198_match(funktion,oplkode,oplkode_def);

		alfalow(str);
		pack_init(str);
		pack_alfa("LINIEON");
		pack_exchkend();
		send_linie();

		alfalow(str);
		pack_init(str);
		pack_alfa("KOLTOM;0;1;LEFT");
		pack_exchkend();
		send_linie();

		alfalow(str);
		pack_init(str);
		pack_alfa("KOLON;2;11;LEFT");
		pack_exchkend();
		send_linie();

		if (funkretur<=0) {
        		alfalow(str);
        		pack_init(str);
        		sprintf(tmpstr,"SUBMIT;mskfortryd%hd;tilbage",
				funktion%1000);
        		pack_alfa(tmpstr);
        		pack_exchkend();
        		send_linie();
		} else {
        		alfalow(str);
        		pack_init(str);
        		sprintf(tmpstr,"SUBMIT;mskaccept2%hd;ok",
				funktion%1000);
        		pack_alfa(tmpstr);
        		pack_exchkend();
        		send_linie();

        		alfalow(str);
        		pack_init(str);
        		sprintf(tmpstr,"SUBMIT;mskfortryd%hd;tilbage",
				funktion%1000);
        		pack_alfa(tmpstr);
        		pack_exchkend();
        		send_linie();
		}
		alfalow(str);
		pack_init(str);
		pack_alfa("KOLOFF");
		pack_exchkend();
		send_linie();

		alfalow(str);
		pack_init(str);
		pack_alfa("LINIEOFF");
		pack_exchkend();
		send_linie();

		return;
	}

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEON");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("ALFA;0;11;LEFT");
	pack_alfa(oplkode_def+13);
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEOFF");
	pack_exchkend();
	send_linie();

	if (funktion/1000==2) {
		alfalow(str);
		pack_init(str);
		pack_alfa("LINIEON");
		pack_exchkend();
		send_linie();

		alfalow(str);
		pack_init(str);
		pack_alfa("ALFA;0;1;LEFT");
		pack_alfa("idstr=");
		pack_exchkend();
		send_linie();

		alfalow(str);
		pack_init(str);
		pack_alfa("ALFA;2;11;LEFT");
		pack_alfa(idstr);
		pack_exchkend();
		send_linie();

		alfalow(str);
		pack_init(str);
		pack_alfa("LINIEOFF");
		pack_exchkend();
		send_linie();
	}
	maskeflag = 1;
	if (funktion/1000==2) {
		funkretur = find_r198(1,oplkode,(double)keynum,keyalfa,lbnr);
	}
	if (funktion/1000==2 && funkretur<=0) {
		alfalow(str);
		pack_init(str);
		pack_alfa("LINIEON");
		pack_exchkend();
		send_linie();

		alfalow(str);
		pack_init(str);
		pack_alfa("KOLTOM;0;1;LEFT");
		pack_exchkend();
		send_linie();

		alfalow(str);
		pack_init(str);
		pack_alfa("ALFA;2;11;LEFT");
		pack_alfa("data ikke fundet...");
		pack_exchkend();
		send_linie();

		alfalow(str);
		pack_init(str);
		pack_alfa("LINIEOFF");
		pack_exchkend();
		send_linie();
		maskeflag = 0;
	}

	datafil = (FILE*)0;
	if (maskeflag==1) {
		wx1 = 1;
		strcpy(ledetext[wx1], "n|gle:");
		if (oplkode_def[6] == 'N') {
			strcpy(ledetext[wx1], "n|gle(num):");
		}
		if (oplkode_def[6] == 'A') {
			strcpy(ledetext[wx1], "n|gle(alfa):");
		}
		wx1 = 2;
		strcpy(ledetext[wx1], "lbnr:");
		wx1 = 3;
		strcpy(ledetext[wx1], "status:");
		wx1 = 4;
		strcpy(ledetext[wx1], "dato:");
		wx1 = 5;
		strcpy(ledetext[wx1], "num:");
		wx1 = 6;
		strcpy(ledetext[wx1], "alfa:");

		sprintf(tmpstr, "%sp8198.lede",ws_kreds);
		datafil = fopen(tmpstr, "r");
		if (!datafil) {
			datafil = (FILE*)0;
		}
	}
	while (datafil) {
		if (!fgets(tmpstr, 80, datafil)) {
			break;
		}
		funkretur = 0;
		(void)get_alfa_tgn(tmpstr,0,ledetext[0],';');
		if (strlen(ledetext[0])) {
			sscanf(ledetext[0], "%ld", &funkretur);
		}
		if (funkretur!=oplkode) {
			continue;
		}
		wx1 = 1;
		(void)get_alfa_tgn(tmpstr,wx1,ledetext[wx1],';');
		strcat(ledetext[wx1], ":");
		wx1 = 2;
		(void)get_alfa_tgn(tmpstr,wx1,ledetext[wx1],';');
		strcat(ledetext[wx1], ":");
		wx1 = 3;
		(void)get_alfa_tgn(tmpstr,wx1,ledetext[wx1],';');
		strcat(ledetext[wx1], ":");
		wx1 = 4;
		(void)get_alfa_tgn(tmpstr,wx1,ledetext[wx1],';');
		strcat(ledetext[wx1], ":");

		wx1 = 5;
		strcpy(ledetext[wx1], "&nbsp;");

		wx1 = 6;
		(void)get_alfa_tgn(tmpstr,wx1-1,ledetext[wx1],';');
		strcat(ledetext[wx1], ":");
		wx1 = 7;
		(void)get_alfa_tgn(tmpstr,wx1-1,ledetext[wx1],';');
		strcat(ledetext[wx1], ":");
		break;
	}
	if (datafil) {
		fclose(datafil);
		datafil = (FILE*)0;
	}
	feltnr = 1;
	while (maskeflag==1 && feltnr<8) {
		feltsize = 0;
		feltmax = 0;
		strcpy(feltalign, "");
		vedlflag = 0;
		strcpy(datafelt, "");
		wx1 = 0;
/* key */
		if (feltnr==1 && oplkode_def[6] == 'N') {
			sprintf(datafelt, "%.0lf", r198->keynum);
			wx1++;
		}
		if (feltnr==1 && oplkode_def[6] == 'A') {
			sprintf(datafelt, "%s", r198->keyalfa);
			wx1++;
		}
/* lbnr */
		if (feltnr==2 && oplkode_def[7] == '1') {
			sprintf(datafelt, "%ld", r198->lbnr);
			wx1++;
		}
		if (feltnr>2 &&
			(funktion%1000==101||funktion%1000==102)) {
			vedlflag = 1;
		}
/* status */
		if (feltnr==3 && oplkode_def[10] == '1') {
			sprintf(datafelt, "%hd", r198->status);
			wx1++;
		}
/* fradato */
		if (feltnr==4 && oplkode_def[8] == '1') {
			sprintf(datafelt, "%ld", r198->fradato);
			wx1++;
		}
/* tildato */
		if (feltnr==5 && oplkode_def[9] == '1') {
			sprintf(datafelt, "%ld", r198->tildato);
			wx1++;
		}
/* numfelt */
		if (feltnr==6) {
			feltsize = 10;
			feltmax = 10;
			strcpy(feltalign, "right");
		}
		if (feltnr==6 && oplkode_def[11]=='N') {
			sprintf(datafelt, "%.0lf", r198->numfelt);
			wx1++;
		}
		if (feltnr==6 && oplkode_def[11]=='B') {
			sprintf(datafelt, "%.0lf", r198->numfelt);
			wx1++;
		}
/* alfafelt */
		if (feltnr==7) {
			feltsize = 80;
			feltmax = 80;
		}
		if (feltnr==7 && oplkode_def[11]=='A') {
			sprintf(datafelt, "%s", r198->alfafelt);
			wx1++;
		}
		if (feltnr==7 && oplkode_def[11]=='B') {
			sprintf(datafelt, "%s", r198->alfafelt);
			wx1++;
		}
		if (feltnr==7 && oplkode_def[11]=='T') {
			sprintf(datafelt, "%s", r198->alfafelt);
			wx1++;
		}
		if (wx1==0) {
			feltnr++;
			continue;
		}

		if (!strlen(datafelt) &&
			(funktion%1000==102 || funktion%1000==103)) {
			strcpy(datafelt, "&nbsp;");
		}

		alfalow(str);
		pack_init(str);
		pack_alfa("LINIEON");
		pack_exchkend();
		send_linie();

		alfalow(str);
		pack_init(str);
		pack_alfa("ALFA;0;1;LEFT");
		pack_alfa(ledetext[feltnr]);
		pack_exchkend();
		send_linie();

		alfalow(str);
		pack_init(str);
		if (vedlflag==0) {
			pack_alfa("ALFA;2;11;LEFT");
			pack_alfa(datafelt);
		} else {
			alfalow(str);
			pack_init(str);
			pack_alfa("INPUTTEXT;2;11;LEFT");
			pack_alfa(datafelt);
			pack_alfa(feltnavn[feltnr]);
			pack_int2((long)feltsize);
			pack_int2((long)feltmax);
			pack_alfa(feltalign);
		}
		pack_exchkend();
		send_linie();

		alfalow(str);
		pack_init(str);
		pack_alfa("LINIEOFF");
		pack_exchkend();
		send_linie();

		feltnr++;
	}

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEON");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("KOLTOM;0;1;LEFT");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("KOLON;2;11;LEFT");
	pack_exchkend();
	send_linie();

	if (funktion%1000!=104) {
        	alfalow(str);
	        pack_init(str);
       		sprintf(tmpstr, "SUBMIT;mskaccept3%hd;accepter", funktion%1000);
		pack_alfa(tmpstr);
		pack_exchkend();
		send_linie();
	}

        alfalow(str);
        pack_init(str);
	if (funktion/1000==2) {
        	sprintf(tmpstr, "SUBMIT;mskfortryd1%hd;tilbage", funktion%1000);
	} else {
        	sprintf(tmpstr, "SUBMIT;mskfortryd%hd;tilbage", funktion%1000);
	}
        pack_alfa(tmpstr);
        pack_exchkend();
        send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("KOLOFF");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEOFF");
	pack_exchkend();
	send_linie();

	if (maskeflag) {
		alfalow(str);
		pack_init(str);
		pack_alfa("HIDDEN");
		pack_int2((long)oplkode);
		pack_alfa("oplkode");
		pack_exchkend();
		send_linie();
	}
	if (maskeflag &&
		(funktion%1000==102||funktion%1000==103)) {
		alfalow(str);
		pack_init(str);
		pack_alfa("HIDDEN");
		pack_int2((long)keynum);
		pack_alfa("keynum");
		pack_exchkend();
		send_linie();

		alfalow(str);
		pack_init(str);
		pack_alfa("HIDDEN");
		pack_alfa(keyalfa);
		pack_alfa("keyalfa");
		pack_exchkend();
		send_linie();

		alfalow(str);
		pack_init(str);
		pack_alfa("HIDDEN");
		pack_int2((long)lbnr);
		pack_alfa("lbnr");
		pack_exchkend();
		send_linie();
	}


	return;
}

/* ************************** */
static int find_feltdata(sti,feltnavn,returstr)
char * sti;
char * feltnavn;
char * returstr; {
	short int retur = 0;
	short int linienr = 0;
	char type[21];
	char tmpstr[201];
	FILE * datafil;

	strcpy(returstr, "");
	datafil = (FILE*)0;
	sprintf(tmpstr, "%s.%s", sti, feltnavn);
	datafil = fopen(tmpstr, "r");
	if (!datafil) {
		retur = -1;
	}
	while (retur>=0) {
		if (!fgets(tmpstr, 200, datafil)) {
			break;
		}
		if (linienr==0 && strlen(tmpstr)) {
			tmpstr[strlen(tmpstr)-1] = '\0';
		}
		if (linienr==0) {
			strcpy(type, tmpstr);
		}
		if (linienr>0) {
			strcpy(returstr, tmpstr);
			retur++;
		}
		linienr++;
	}
	if (datafil) {
		fclose(datafil);
		datafil = (FILE*)0;
	}
	return(retur);
}

/* ************************** */
static int find_opldata(oplkode,returstr)
long int oplkode;
char * returstr; {
	short int retur = 0;
	long int chkopl = 0;
	char tmpstr[201];
	FILE * datafil;

	strcpy(returstr, "");
	datafil = (FILE*)0;
	sprintf(tmpstr, "%sp8198.opl",ws_kreds);
	datafil = fopen(tmpstr, "r");
	if (!datafil) {
		datafil = (FILE*)0;
	}
	while (datafil) {
		if (!fgets(tmpstr, 80, datafil)) {
			break;
		}
		if (strlen(tmpstr)) {
			tmpstr[strlen(tmpstr)-1] = '\0';
		}
		sscanf(tmpstr, "%ld", &chkopl);
		if (chkopl != oplkode) {
			continue;
		}
		strcpy(returstr, tmpstr);
		retur = 1;
	}
	if (datafil) {
		fclose(datafil);
		datafil = (FILE*)0;
	}
	return(retur);
}

/* ************ */
static void add_funk_linie(funktion)
short int funktion; {
	char tmpstr[81];

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEON");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("ALFA;0;1;LEFT");
	pack_alfa("funktion:");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("ALFA;2;11;LEFT");
	strcpy(tmpstr, "???");
	if (funktion==101) {
		strcpy(tmpstr, "opret");
	}
	if (funktion==102) {
		strcpy(tmpstr, "ret");
	}
	if (funktion==103) {
		strcpy(tmpstr, "slet");
	}
	if (funktion==104) {
		strcpy(tmpstr, "se");
	}
	pack_alfa(tmpstr);
	pack_exchkend();
	send_linie();
	
	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEOFF");
	pack_exchkend();
	send_linie();

	return;
}

/* *********************************** */
static int dan_r198_match(funktion,oplkode,oplkode_def)
short int funktion;
long int oplkode;
char * oplkode_def; {
	short int antal = 0;
	char keystr[21] = "";
	char tmpstr[101] = "";
	char idstr[101] = "";
	char udstr[101] = "";

	if (logfil) {
		fprintf(logfil,
		"dan_r198_match:funkion=%hd,oplkode=%ld,oplkode_def=%s\n",
			funktion,
			oplkode,
			oplkode_def);
		fflush(logfil);
	}

	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEON");
	pack_exchkend();
	send_linie();

	alfalow(str);
	pack_init(str);
	pack_alfa("ALFA;0;1;LEFT");
	pack_alfa(oplkode_def+13);
	pack_exchkend();
	send_linie();

	reclow(r198, R198);
	r198->oplkode = oplkode;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		antal = -1;
	}
	while (antal>=0) {
		egeread(f198, ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode != oplkode) {
			break;
		}
		strcpy(udstr, "");
		if (antal==0) {
			alfalow(str);
			pack_init(str);
			pack_alfa("KOLON;2;11;LEFT");
			pack_exchkend();
			send_linie();

			alfalow(str);
			pack_init(str);
			sprintf(tmpstr, "SELECTON;oplmatchid;0;0;0");
			pack_alfa(tmpstr);
			pack_exchkend();
			send_linie();
		}
		if (oplkode_def[6]=='N') {
			sprintf(keystr,"%10.0lf",r198->keynum);
		}
		if (oplkode_def[6]=='A') {
			sprintf(keystr,"%-10s", r198->keyalfa);
		}
		if (oplkode_def[7]=='0' && r198->lbnr>0) {
			strcpy(keystr, "");
		}
		sprintf(udstr, "%-10s", keystr);
		if (oplkode_def[7]=='1') {
			sprintf(tmpstr, " %5.0ld",r198->lbnr);
			strcat(udstr, tmpstr);
		}
		if (oplkode_def[11]=='N') {
			sprintf(tmpstr, " %10.0lf",r198->numfelt);
			strcat(udstr, tmpstr);
		}
		if (oplkode_def[11]=='A') {
			r198->alfafelt[59] = '\0';
			sprintf(tmpstr, " %-59s", r198->alfafelt);
			strcat(udstr, tmpstr);
		}
		if (oplkode_def[11]=='B') {
			if (oplkode_def[8]=='1' &&
				oplkode_def[9]=='1') {
				sprintf(tmpstr, " %8ld-%8ld",
					r198->fradato,r198->tildato);
				strcat(udstr, tmpstr);
			}
			if (oplkode_def[10]=='1') {
				sprintf(tmpstr, " %2hd", r198->status);
				strcat(udstr, tmpstr);
			}
			r198->alfafelt[40] = '\0';
			if (strlen(udstr)>25) {
				r198->alfafelt[20] = '\0';
			}
			sprintf(tmpstr, " %9.0lf %s",
				r198->numfelt,
				r198->alfafelt);
			strcat(udstr, tmpstr);
		}
		if (oplkode_def[11]=='T') {
			r198->alfafelt[59] = '\0';
			sprintf(tmpstr, " %-59s", r198->alfafelt);
			strcat(udstr, tmpstr);
		}
		sprintf(idstr, "%s;%.0lf;%ld;%ld",
			r198->keyalfa,
			r198->keynum,
			r198->oplkode,
			r198->lbnr);
		alfalow(str);
		pack_init(str);
		pack_alfa(idstr);
		pack_alfa("");
		pack_alfa(udstr);
		pack_exchkend();
		send_linie();
		antal++;
	}
	if (antal>0) {
		alfalow(str);
		pack_init(str);
		pack_alfa("SELECTOFF");
		pack_exchkend();
		send_linie();

		alfalow(str);
		pack_init(str);
		pack_alfa("KOLOFF");
		pack_exchkend();
		send_linie();
	} else {
		alfalow(str);
		pack_init(str);
		pack_alfa("ALFA;2;11;LEFT");
		pack_alfa("ingen...");
		pack_exchkend();
		send_linie();
	}
	alfalow(str);
	pack_init(str);
	pack_alfa("LINIEOFF");
	pack_exchkend();
	send_linie();

	return(antal);
}

/* ************************************** */
static void p8198_opdater(funktion,feltfilsti)
short int funktion;
char * feltfilsti; {
	short int wx1;
	long int oplkode;
	long int lbnr;
	double keynum;
	char keyalfa[21];

	char returstr[81];

	if (logfil) {
		fprintf(logfil,
		"p8198_opdater:funktion=%hd,feltfilsti=%s\n",
			funktion,
			feltfilsti);
		fflush(logfil);
	}
	(void)find_feltdata(feltfilsti,"oplkode",returstr);
	sscanf(returstr, "%ld", &oplkode);
	(void)find_feltdata(feltfilsti,"lbnr",returstr);
	sscanf(returstr, "%ld", &lbnr);
	(void)find_feltdata(feltfilsti,"keynum",returstr);
	sscanf(returstr, "%lf", &keynum);
	(void)find_feltdata(feltfilsti,"keyalfa",keyalfa);

	if (logfil) {
		fprintf(logfil,
		"p8198_opdater:opl=%ld,keynum=%.0lf,keyalfa=%s,lb=%ld\n",
			oplkode,
			keynum,
			keyalfa,
			lbnr);
		fflush(logfil);
	}
	reclow(r198, R198);
	wx1 = find_feltdata(feltfilsti,"alfafelt",returstr);
	if (wx1>0) {
		strcpy(r198->alfafelt, returstr);
	}
	wx1 = find_feltdata(feltfilsti,"numfelt",returstr);
	if (wx1>0) {
		sscanf(returstr, "%lf", &r198->numfelt);
	}
	(void)opdat_r198(oplkode,(double)keynum,keyalfa,lbnr);
	return;
}

/*				*/
/* EXTRA FUNKTIONER		*/
/*				*/

/* ************************************** */
static void dan_password(anttgn,returstr)
short int anttgn;
char * returstr; {
        short int passidx = 0;
	int tilfnum;

	strcpy(returstr, "");
	ege_w_int1 = (ULI)time(0);
	srand(ege_w_int1%100);
	while (passidx<anttgn) {
		tilfnum = rand();
		tilfnum %= 122;
		if (tilfnum>=48 && tilfnum<58) {
			returstr[passidx]= tilfnum;
			passidx++;
			returstr[passidx]= '\0';
		}
/*
		if (tilfnum>=65 && tilfnum<91) {
			returstr[passidx]= tilfnum;
			passidx++;
			returstr[passidx]= '\0';
		}
		if (tilfnum>=97 && tilfnum<123) {
			returstr[passidx]= tilfnum;
			passidx++;
			returstr[passidx]= '\0';
		}
*/
	}
	return;
}

/* *********************************************** */
static void alfa_password(langstr,password,returstr)
char * langstr;
char * password;
char * returstr; {
	short int idx;
	char tmpstr[21] = "";

	strcpy(returstr,"");
	for (idx=0;idx<strlen(password);idx++) {
		if (idx>0) {
			strcat(returstr, "-");
		}
		if (password[idx]==48 &&
			(strcmp(langstr,"DA")==0 || strcmp(langstr,"DK")==0)) {
			strcat(returstr, "nul");
		}
		if (password[idx]==49 &&
			(strcmp(langstr,"DA")==0 || strcmp(langstr,"DK")==0)) {
			strcat(returstr, "et");
		}
		if (password[idx]==50 &&
			(strcmp(langstr,"DA")==0 || strcmp(langstr,"DK")==0)) {
			strcat(returstr, "to");
		}
		if (password[idx]==51 &&
			(strcmp(langstr,"DA")==0 || strcmp(langstr,"DK")==0)) {
			strcat(returstr, "tre");
		}
		if (password[idx]==52 &&
			(strcmp(langstr,"DA")==0 || strcmp(langstr,"DK")==0)) {
			strcat(returstr, "fire");
		}
		if (password[idx]==53 &&
			(strcmp(langstr,"DA")==0 || strcmp(langstr,"DK")==0)) {
			strcat(returstr, "fem");
		}
		if (password[idx]==54 &&
			(strcmp(langstr,"DA")==0 || strcmp(langstr,"DK")==0)) {
			strcat(returstr, "seks");
		}
		if (password[idx]==55 &&
			(strcmp(langstr,"DA")==0 || strcmp(langstr,"DK")==0)) {
			strcat(returstr, "syv");
		}
		if (password[idx]==56 &&
			(strcmp(langstr,"DA")==0 || strcmp(langstr,"DK")==0)) {
			strcat(returstr, "otte");
		}
		if (password[idx]==57 &&
			(strcmp(langstr,"DA")==0 || strcmp(langstr,"DK")==0)) {
			strcat(returstr, "ni");
		}
/* ENG */
		if (password[idx]==48 &&
			strcmp(langstr,"DA")!=0 && strcmp(langstr,"DK")!=0) {
			strcat(returstr, "null");
		}
		if (password[idx]==49 &&
			strcmp(langstr,"DA")!=0 && strcmp(langstr,"DK")!=0) {
			strcat(returstr, "one");
		}
		if (password[idx]==50 &&
			strcmp(langstr,"DA")!=0 && strcmp(langstr,"DK")!=0) {
			strcat(returstr, "two");
		}
		if (password[idx]==51 &&
			strcmp(langstr,"DA")!=0 && strcmp(langstr,"DK")!=0) {
			strcat(returstr, "three");
		}
		if (password[idx]==52 &&
			strcmp(langstr,"DA")!=0 && strcmp(langstr,"DK")!=0) {
			strcat(returstr, "four");
		}
		if (password[idx]==53 &&
			strcmp(langstr,"DA")!=0 && strcmp(langstr,"DK")!=0) {
			strcat(returstr, "five");
		}
		if (password[idx]==54 &&
			strcmp(langstr,"DA")!=0 && strcmp(langstr,"DK")!=0) {
			strcat(returstr, "six");
		}
		if (password[idx]==55 &&
			strcmp(langstr,"DA")!=0 && strcmp(langstr,"DK")!=0) {
			strcat(returstr, "seven");
		}
		if (password[idx]==56 &&
			strcmp(langstr,"DA")!=0 && strcmp(langstr,"DK")!=0) {
			strcat(returstr, "eight");
		}
		if (password[idx]==57 &&
			strcmp(langstr,"DA")!=0 && strcmp(langstr,"DK")!=0) {
			strcat(returstr, "nine");
		}
		if (password[idx]>57 || password[idx]<48) {
			sprintf(tmpstr, "%c", password[idx]);
			strcat(returstr, tmpstr);
		}
	}
	return;
}

/* ********************* */
static void udregn_cdipai_beloeb(enhed,antal,cdipai,doub_felt)
short int enhed;
short int antal;
double cdipai;
double *doub_felt; {
	short int prantal = 0;

        *doub_felt = 0;
	prantal = enhed % 100;
	if (enhed>100 && enhed<200) {
		prantal = 1;
	}
	if (enhed>300 && enhed<400) {
		prantal *= 7;
		prantal *= antal;
	}
	if (enhed>400 && enhed<500) {
		prantal *= 30;
		prantal *= antal;
	}
	if (enhed==501) {
		prantal *= 3;
		prantal *= antal;
	}
        *doub_felt = cdipai;
	*doub_felt *= (double)prantal;
	return;
}

/* ********************* */
static void udregn_mbidrag_beloeb(short antal,char *inpgrp,double *doubprdag,double *doubmax) {
	double prisdag = 0;
	double prismax = 0;
	short int fundet = 0;
	short int specnr = 944;
	char chkgrp[11] = "";

        *doubprdag = 0;
        *doubmax = 0;
	fundet = 0;
	reclow(r198,R198);
	r198->oplkode = 16568;
	r198->keynum = (double)specnr;
	f198_start(1,ISGTEQ);
	if (f198_ukendt) {
		fundet = -1;
	}
	while (fundet==0) {
		egeread(f198,ISNEXT);
		if (f198_eof) {
			break;
		}
		if (r198->oplkode!=16568) {
			break;
		}
		if (r198->keynum!=specnr) {
			break;
		}
		if (r198->numfelt!=1) {
			continue;
		}
		prisdag = 0;
		prismax = 0;
		(void)get_alfa_tgn(r198->alfafelt,3,chkgrp,59);
		if (strlen(chkgrp)) {
			sscanf(chkgrp,"%lf",&prisdag);
		}
		(void)get_alfa_tgn(r198->alfafelt,4,chkgrp,59);
		if (strlen(chkgrp)) {
			sscanf(chkgrp,"%lf",&prismax);
		}
		(void)get_alfa_tgn(r198->alfafelt,0,chkgrp,59);
		if (strcmp(inpgrp,chkgrp)==0) {
			fundet = 1;
		}
	}
	*doubprdag = prisdag;
	*doubmax = prismax;
	return;
}

/* ********************* */
static int get_alfa_tgn(txt_felt, nr, txt_ptr, tegn)
char * txt_felt;
short int nr;
char * txt_ptr; 
char tegn; {
	register int wx1;
	register int wx2 = 0;
	short int felt_nr = 0;
	short int felt_fundet = 0;

	felt_nr = 0;
	for (wx1=0;(unsigned int)wx1<strlen(txt_felt);wx1++) {
		if (txt_felt[wx1] == tegn) {
			if (felt_fundet == 0) {
				felt_nr++;
				continue;
			} else {
				break;
			}
		}
		if (felt_nr == nr) {
			felt_fundet = 1;
		}
		if (felt_fundet == 1) {
			txt_ptr[wx2] = txt_felt[wx1];
			wx2++;
		}
	}
	txt_ptr[wx2] = '\0';
	egechartest((unsigned char *)txt_ptr);
	return(felt_fundet);
}

/* ************* */
static int bit_check(tal, nr)
short int tal;
short int nr; {
	register int x1, x2;

	x2 = 0;
	for (x1=1;x2<nr;x1+=x1)
		x2++;
	if (tal & (x1))
		return(1);
	else
		return(0);
}

/* ************* */
static int bit_toggle(tal, nr)
short int tal;
short int nr; {
	register int x1, x2;

	x2 = 0;
	for (x1=1;x2<nr;x1+=x1) {
		x2++;
	}
	tal ^= x1;
	return(tal);
}

/* *********************** */
static int slet_blanke(unsigned char * inpstr) {
	short int wx1 = 0;
	short int wx2 = 0;
	unsigned char chkstr[81] = "";

	strcpy(chkstr,inpstr);
	for (wx1=0;wx1<strlen(chkstr);wx1++) {
                if (chkstr[wx1]<=32) {
                        continue;
                }
		inpstr[wx2] = chkstr[wx1];
		wx2++;
		inpstr[wx2] = '\0';
	}
	return(wx2);
}

/* *********************** */
static int check_numtgn(unsigned char * inpstr) {
	int retur = 1;
	short int wx1 = 0;
	short int oktgn = 0;
	unsigned char chkstr[201] = "";

	strcpy(chkstr,inpstr);
	for (wx1=0;wx1<strlen(chkstr);wx1++) {
		if (chkstr[wx1]==32) {
			oktgn = 1;
		}
		if (chkstr[wx1]>=48 && chkstr[wx1]<=57) {
			oktgn = 1;
		}
/* NYT 130205 */
		if (chkstr[wx1]==43) {
			oktgn = 1;
		}
		if (oktgn<=0) {
			retur = 0;
			break;
		}
	}
	return(retur);
}

/* BASE64 egemail.c */

/* base64 encode */
static int base64_encode(ifil, ofil)
char * ifil;
char * ofil; {
	int i, hiteof = FALSE;
        byte igroup[3], ogroup[4];
        int c, n;
	int antal = 0;

	fi = fopen(ifil, "rb");
	if (!fi) {
		return(-1);
	}
	fo = fopen(ofil, "w");
	if (!fo) {
		fclose(fi);
		return(-2);
	}
	while (!hiteof) {
		igroup[0] = igroup[1] = igroup[2] = 0;
		for (n = 0; n < 3; n++) {
			c = inchar();
			if (c == EOF) {
				hiteof = TRUE;
				break;
			}
			igroup[n] = (byte) c;
		}
		if (n > 0) {
		ogroup[0] = dtable[igroup[0] >> 2];
		ogroup[1] = dtable[((igroup[0] & 3) << 4) | (igroup[1] >> 4)];
		ogroup[2] = dtable[((igroup[1] & 0xF) << 2) | (igroup[2] >> 6)];
		ogroup[3] = dtable[igroup[2] & 0x3F];

			if (n < 3) {
				ogroup[3] = '=';
				if (n < 2) {
					ogroup[2] = '=';
				}
			}
			for (i = 0; i < 4; i++) {
				ochar(ogroup[i]);
			}
		}
	}
	if (fputs(eol, fo) == EOF) {
		exit(1);
	}
	if (fi) {
		fclose(fi);
		fi = (FILE*)0;
	}
	if (fo) {
		fclose(fo);
		fo = (FILE*)0;
	}
	return(1);
}

/* ******************************************* */
static void base64_en_init() {
	short int i;

    for (i = 0; i < 9; i++) {
        dtable[i] = 'A' + i;
        dtable[i + 9] = 'J' + i;
        dtable[26 + i] = 'a' + i;
        dtable[26 + i + 9] = 'j' + i;
    }
    for (i = 0; i < 8; i++) { 
        dtable[i + 18] = 'S' + i;
        dtable[26 + i + 18] = 's' + i;
    }
    for (i = 0; i < 10; i++) {
        dtable[52 + i] = '0' + i;
    }
    dtable[62] = '+';
    dtable[63] = '/';
	return;
}


/* base64 decode */
static void base64_decode(ifil, ofil)
char * ifil;
char * ofil; {
    	int i,c;
        byte a[4], b[4], o[3];

	fi = fopen(ifil, "r");
	if (!fi) {
		return;
	}
	fo = fopen(ofil, "wb");
	if (!fo) {
		fclose(fi);
		return;
	}

	while (TRUE) {
		for (i = 0; i < 4; i++) {
			c = insig();
			if (c == EOF) {
				if (errcheck && (i > 0)) {
					fprintf(stderr,
						"Input file incomplete.\n");
					exit(1);
				}
				return;
			}
			if (dtable[c] & 0x80) {
				if (errcheck) {
				fprintf(stderr,
				"Illegal character '%c' in input file.\n", c);
				exit(1);
				}
                /* Ignoring errors: discard invalid character. */
                		i--;
				continue;
			}
			a[i] = (byte) c;
			b[i] = (byte) dtable[c];
		}
		o[0] = (b[0] << 2) | (b[1] >> 4);
		o[1] = (b[1] << 4) | (b[2] >> 2);
		o[2] = (b[2] << 6) | b[3];
		i = a[2] == '=' ? 1 : (a[3] == '=' ? 2 : 3);
		if (fwrite(o, i, 1, fo) == EOF) {
			exit(1);
		}
		if (i < 3) {
			return;
		}
	}
	if (fo) {
		fflush(fo);
		fclose(fo);
		fo = (FILE*)0;
	}
	if (fi) {
		fclose(fi);
		fi = (FILE*)0;
	}
	return;
}

/* ******************************************* */
static void base64_de_init() {
	short int i;

    for (i = 0; i < 255; i++) {
        dtable[i] = 0x80;
    }
    for (i = 'A'; i <= 'I'; i++) {
        dtable[i] = 0 + (i - 'A');
    }
    for (i = 'J'; i <= 'R'; i++) {
        dtable[i] = 9 + (i - 'J');
    }                             
    for (i = 'S'; i <= 'Z'; i++) {
        dtable[i] = 18 + (i - 'S');
    }                             
    for (i = 'a'; i <= 'i'; i++) {
        dtable[i] = 26 + (i - 'a');
    }
    for (i = 'j'; i <= 'r'; i++) {
        dtable[i] = 35 + (i - 'j');
    }
    for (i = 's'; i <= 'z'; i++) {
        dtable[i] = 44 + (i - 's');
    }
    for (i = '0'; i <= '9'; i++) {
        dtable[i] = 52 + (i - '0');
    }
    dtable['+'] = 62;
    dtable['/'] = 63;
    dtable['='] = 0;
	return;
}

static int inbuf(void)
{
    int l;

    if (ateof) {
        return FALSE;
    }
    l = fread(iobuf, 1, MAXINLINE, fi);     /* Read input buffer */
    if (l <= 0) {
        if (ferror(fi)) {
            exit(1);
        }
        ateof = TRUE;
        return FALSE;
    }
    iolen = l;
    iocp = 0;
    return TRUE;
}

static int inchar(void)
{
    if (iocp >= iolen) {
       if (!inbuf()) {
          return EOF;
        }
    }

    return iobuf[iocp++];
}

static int insig(void)
{
    int c;

    while (TRUE) {
        c = inchar();
        if (c == EOF || (c > ' ')) {
            return c;
        }
    }
}

static void ochar(int c)
{
    if (linelength >= LINELEN) {
        if (fputs(eol, fo) == EOF) {
            exit(1);
        }
        linelength = 0;
    }
    if (putc(((byte) c), fo) == EOF) {
        exit(1);
    }
    linelength++;
}

/* Tilføj streng med mellemrum foran */
static char * add_str(char *target, char *src)
{
        sprintf(&target[strlen(target)], " %s", src);
        return target;
}

/* Tilføj nøgle=værdi med mellemrum foran */
static char * add_kw_val(char *kw, char *val, char *target)
{
        sprintf(&target[strlen(target)], " %s=%s", kw, val);
        return target;
}

/* Tilføj streng uden blank */
/* 110127 */
static char * add_str_uden_blank(char *target, char *src)
{
        sprintf(&target[strlen(target)], "%s", src);
        return target;
}

/* NYT 150518 UDVRATE */
/* *************************************************************** */
int hent_spec_nr_data(short inpspecnr,char *grp,short inptype) {
	int retur = 0;

	return(retur);
}

#include "cbtxtknv.h"
#include "40tgnkonv.h"
#include "40flaade.h"
#include "40bss198.h"
#include "40lukaaben.h"
